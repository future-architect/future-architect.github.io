<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>Session Manager と踏み台サーバの共存構成 | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="はじめにこんにちはーTIG DX Unit のゆるふわエンジニアの前原です。 突然ですが、Session Manager 使ってますか？調べるとブログがたくさん掲載されているので使っているところは多いのかな？って思っています。 また、ブログのタイトルを見ると以下のメッセージが多い印象を受けました。  さよなら踏み台サーバ もういらない踏み台サーバ ..etc  なんか、可哀想になってきますね。。と">
<meta property="og:type" content="article">
<meta property="og:title" content="Session Manager と踏み台サーバの共存構成 | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20200423/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="はじめにこんにちはーTIG DX Unit のゆるふわエンジニアの前原です。 突然ですが、Session Manager 使ってますか？調べるとブログがたくさん掲載されているので使っているところは多いのかな？って思っています。 また、ブログのタイトルを見ると以下のメッセージが多い印象を受けました。  さよなら踏み台サーバ もういらない踏み台サーバ ..etc  なんか、可哀想になってきますね。。と">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20200423/photo_20200423_01.jpeg">
<meta property="og:image" content="https://future-architect.github.io/images/20200423/photo_20200423_02.jpeg">
<meta property="article:published_time" content="2020-04-23T01:23:54.000Z">
<meta property="article:modified_time" content="2022-06-09T01:03:49.429Z">
<meta property="article:tag" content="AWS">
<meta property="article:tag" content="Session-Manager">
<meta property="article:tag" content="踏み台">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20200423/photo_20200423_01.jpeg">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/logo.svg" sizes="any" type="image/svg+xml">
  <link rel="mask-icon" href="/logo.svg" sizes="any" color="#0bd">
  <link rel="icon alternate" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20200423/">
  <meta content="AWS,Session-Manager,踏み台" name="keywords">
  <meta content="前原応光" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Infrastructure/">Infrastructureカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">Session Manager と踏み台サーバの共存構成
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/20200423-bastion.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-20200423-bastion" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2020/" class="publish-date"><time datetime="2020-04-23T01:23:54.000Z" itemprop="datePublished">2020.04.23</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E5%89%8D%E5%8E%9F%E5%BF%9C%E5%85%89" title="前原応光さんの記事一覧へ" class="post-author">前原応光</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/AWS/" title="AWSタグの記事へ" class="tag-list-link">AWS</a>
  
    
    <a href="/tags/Session-Manager/" title="Session-Managerタグの記事へ" class="tag-list-link">Session-Manager</a>
  
    
    <a href="/tags/踏み台/" title="踏み台タグの記事へ" class="tag-list-link">踏み台</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちはー<br>TIG DX Unit のゆるふわエンジニアの前原です。</p>
<p>突然ですが、Session Manager 使ってますか？調べるとブログがたくさん掲載されているので使っているところは多いのかな？って思っています。</p>
<p>また、ブログのタイトルを見ると以下のメッセージが多い印象を受けました。</p>
<ul>
<li>さよなら踏み台サーバ</li>
<li>もういらない踏み台サーバ</li>
<li>..etc</li>
</ul>
<p>なんか、可哀想になってきますね。。<br>とはいえ、こういったメッセージが多い理由としては、以下のメリットからだと考えられます。</p>
<ul>
<li>踏み台サーバ不要でAWS リソースに容易にアクセスすることが可能</li>
<li>SSH のキー管理も不要で、IAM User と必要な権限が付与されていればアクセスできる</li>
<li>Security Group を意識しなくていい</li>
<li>操作ログも自動でCloudWatch Logs で取得される</li>
<li>CloudTrail では、セッションを張った時のイベントが取得される</li>
</ul>
<p>仮に踏み台サーバを運用しようとすると上記のことを踏まえて構成、メンテナンスを行う必要があります。<br>これは、Session Manager を利用するのが必然に感じますね。</p>
<p>しかし、運用している踏み台サーバをSession Manager に移行するのは難しいところもあると思います。例えば、踏み台サーバに色々な役割を持たせているケースもあると思います（例えば、プロビジョニング用途など）。踏み台サーバの本来の役割的には、、と思った人もいると思いますが、現実は割とごった煮サーバになっているケースもあります。</p>
<p>そこで、踏み台サーバを生かしつつ、Session Manager を利用できる方法について説明したいと思います。</p>
<h1 id="踏み台サーバとSession-Manager-の共存構成"><a href="#踏み台サーバとSession-Manager-の共存構成" class="headerlink" title="踏み台サーバとSession Manager の共存構成"></a>踏み台サーバとSession Manager の共存構成</h1><p>ここで紹介する構成は、以下です。<br>下記の図に記載されているbastion serverは、踏み台サーバを指しています。</p>
<ul>
<li>Session Manager を通してSSH で踏み台サーバへアクセス</li>
</ul>
<img src="/images/20200423/photo_20200423_01.jpeg" loading="lazy">

<ul>
<li>ポートフォワードでRDS にアクセス</li>
</ul>
<img src="/images/20200423/photo_20200423_02.jpeg" loading="lazy">

<h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><p>サーバ側の準備とクライアント側の準備が必要になります。</p>
<h3 id="サーバ側の準備"><a href="#サーバ側の準備" class="headerlink" title="サーバ側の準備"></a>サーバ側の準備</h3><p>Session Manager のアクセス許可を行うため、対象のEC2（ここでいう踏み台サーバ）に<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/session-manager-getting-started-instance-profile.html">AmazonSSMManagedInstanceCore</a>ポリシを追加します。<br>もし必要なアクションのみを追加したい場合は、以下を追加します。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;ssmmessages:CreateControlChannel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;ssmmessages:CreateDataChannel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;ssmmessages:OpenControlChannel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;ssmmessages:OpenDataChannel&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;logs:CreateLogGroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;logs:CreateLogStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;logs:PutLogEvents&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;s3:GetEncryptionConfiguration&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;kms:Decrypt&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;key-name&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>踏み台サーバのSSM エージェントが<code>2.3.672.0</code>以上である必要があります。<br>もし古い場合は、<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/sysman-manual-agent-install.html">ここのサイト</a>を参考にしてください。<br>バージョンが古いとSession Manager を通してSSH で接続することができません。</p>
<h3 id="クライアント側の準備"><a href="#クライアント側の準備" class="headerlink" title="クライアント側の準備"></a>クライアント側の準備</h3><p>Session Manager plugin をインストールします。<br>前提として、<code>AWS CLI</code> が使用できることと、適切なIAM Policy がアタッチされていることを前提とします。</p>
<h4 id="Mac-インストール方法"><a href="#Mac-インストール方法" class="headerlink" title="Mac インストール方法"></a>Mac インストール方法</h4><p>プラグインをダウンロードします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&quot;https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip&quot;</span> -o <span class="string">&quot;sessionmanager-bundle.zip&quot;</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 4680k  100 4680k    0     0   174k      0  0:00:26  0:00:26 --:--:--  120k</span><br></pre></td></tr></table></figure>

<p>ダウンロードしたファイルを解凍します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ unzip sessionmanager-bundle.zip</span><br><span class="line">Archive:  sessionmanager-bundle.zip</span><br><span class="line">   creating: sessionmanager-bundle/</span><br><span class="line">   creating: sessionmanager-bundle/bin/</span><br><span class="line">  inflating: sessionmanager-bundle/seelog.xml.template</span><br><span class="line">  inflating: sessionmanager-bundle/LICENSE</span><br><span class="line">  inflating: sessionmanager-bundle/VERSION</span><br><span class="line">  inflating: sessionmanager-bundle/install</span><br><span class="line">  inflating: sessionmanager-bundle/bin/session-manager-plugin</span><br></pre></td></tr></table></figure>

<p>プラグインのインストールをします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin</span><br><span class="line">Password:</span><br><span class="line">Creating install directories: /usr/local/sessionmanagerplugin/bin</span><br><span class="line">Creating Symlink from /usr/local/sessionmanagerplugin/bin/session-manager-plugin to /usr/local/bin/session-manager-plugin</span><br><span class="line">Installation successful!</span><br></pre></td></tr></table></figure>

<p>バージョンの確認をします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ session-manager-plugin --version</span><br><span class="line">1.1.54.0</span><br></pre></td></tr></table></figure>

<p>インストールが成功していると以下のメッセージが出力されます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ session-manager-plugin</span><br><span class="line"></span><br><span class="line">The Session Manager plugin was installed successfully. Use the AWS CLI to start a session.</span><br></pre></td></tr></table></figure>

<p>SSH 設定ファイル（~/.ssh/config）に以下を追記します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSH over Session Manager</span></span><br><span class="line">host i-* mi-*</span><br><span class="line">    ProxyCommand sh -c <span class="string">&quot;aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters &#x27;portNumber=%p&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Windows-インストール方法"><a href="#Windows-インストール方法" class="headerlink" title="Windows インストール方法"></a>Windows インストール方法</h4><p>ここでは、Windows にSession Manager Plugin をインストールする方法を記載します。</p>
<ol>
<li>インストーラーを<a target="_blank" rel="noopener" href="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/windows/SessionManagerPluginSetup.exe">ダウンロード</a>する</li>
<li>インストーラーの指示に従う</li>
<li>インストールの確認のため以下のコマンドでバージョンが表示されたら完了</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ session-manager-plugin --version</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>SSH 設定ファイルに以下を追記する<ul>
<li>ファイル: C:\Users\username.ssh\config</li>
</ul>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSH over Session Manager</span></span><br><span class="line">host i-* mi-*</span><br><span class="line">    ProxyCommand C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe <span class="string">&quot;aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters portNumber=%p&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="補足-プロキシ設定"><a href="#補足-プロキシ設定" class="headerlink" title="補足: プロキシ設定"></a>補足: プロキシ設定</h4><ul>
<li>Mac</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> http_proxy=http://&lt;USER_NAMEh&gt;:&lt;PASSWORD&gt;@&lt;PROXY_SERVER&gt;:&lt;PORT&gt;</span><br><span class="line">$ <span class="built_in">export</span> https_proxy=https://&lt;USER_NAMEh&gt;:&lt;PASSWORD&gt;@&lt;PROXY_SERVER&gt;:&lt;PORT&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>Windows</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">set</span> http_proxy=http://&lt;USER_NAMEh&gt;:&lt;PASSWORD&gt;@&lt;PROXY_SERVER&gt;:&lt;PORT&gt;</span><br><span class="line">$ <span class="built_in">set</span> https_proxy=https://&lt;USER_NAMEh&gt;:&lt;PASSWORD&gt;@&lt;PROXY_SERVER&gt;:&lt;PORT&gt;</span><br></pre></td></tr></table></figure>

<h2 id="実際にアクセスしてみる"><a href="#実際にアクセスしてみる" class="headerlink" title="実際にアクセスしてみる"></a>実際にアクセスしてみる</h2><p>今回の二つの構成でのアクセスを行なっていきたいと思います。</p>
<ul>
<li>Session Manager を通してSSH で踏み台サーバへアクセス</li>
<li>ポートフォワードでRDS にアクセス</li>
</ul>
<h3 id="Session-Manager-を通してSSH-で踏み台サーバへアクセス"><a href="#Session-Manager-を通してSSH-で踏み台サーバへアクセス" class="headerlink" title="Session Manager を通してSSH で踏み台サーバへアクセス"></a>Session Manager を通してSSH で踏み台サーバへアクセス</h3><p>まずは、踏み台サーバにSession Manager を通してアクセスしたいと思います。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i &lt;KEY_NAME&gt;.pem &lt;USER_NAME&gt;@&lt;INSTANCE_ID&gt;</span><br></pre></td></tr></table></figure>

<p>通常のssh でアクセスするときと違う点としては、IP アドレスではなく、Instance ID を指定する点です。<br>ポートは、デフォルトの22 を指定するかたちで問題ありません（Security Group のInbound の22 を開ける必要はありません）<br>AWS マネジメントコンソール（HTTPS）へのアクセスが可能であればアクセスできます。</p>
<h3 id="ポートフォワードでRDS-にアクセス"><a href="#ポートフォワードでRDS-にアクセス" class="headerlink" title="ポートフォワードでRDS にアクセス"></a>ポートフォワードでRDS にアクセス</h3><p>ポートフォワードも通常のSSH で行う場合と同一のコマンドで行えます。<br>ここでは、PostgreSQL（5432） にアクセスするケースとします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -NL 15432:&#123;DB_HOST&#125;:5432 -i &lt;KEY_NAME&gt;.pem &lt;USER_NAME&gt;@&lt;INSTANCE_ID&gt;</span><br></pre></td></tr></table></figure>

<h3 id="アクセスできない場合"><a href="#アクセスできない場合" class="headerlink" title="アクセスできない場合"></a>アクセスできない場合</h3><p>踏み台サーバにアクセスできず、以下のエラーが発生する場合は、SSM エージェントのサービス再起動をすると解消される可能性があります。<br>（前提としてポリシ周りの誤りがないこと）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The version of SSM Agent on the instance supports Session Manager, but the instance is not configured for use with AWS Systems Manager. Verify that the IAM instance profile attached to the instance includes the required permissions.</span><br></pre></td></tr></table></figure>

<p>再起動コマンド</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart amazon-ssm-agent</span><br></pre></td></tr></table></figure>

<h2 id="ログについて"><a href="#ログについて" class="headerlink" title="ログについて"></a>ログについて</h2><p>Session Manager を利用することで、CloudWatch Logs で操作ログの取得ができると冒頭で説明しました。<br>ただ、今回のSSH over Session Manager の構成では、CloudWatch Logs でログが出力されません。<br>したがって、Script コマンドで各ユーザの操作ログの取得が必要となります。<br>また、ポートフォワードした時は、Script コマンドにさえ残らないので、注意が必要です（これはSession Manager 云々の話ではないですが）<br>その場合は、CloudTrail のイベント（Session &amp; Terminate）とRDS のAudit ログから証跡を辿る必要があります。</p>
<h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>いかがでしたでしょうか。<br>既存の踏み台サーバを残しつつ、Session Manager を利用する場合のケースについて書きました。<br>踏み台サーバを簡単になくすことが出来ない構成だけど、Session Manager を利用したいという人のお役に立てれば嬉しいです。<br>もし、完全に踏み台サーバを無くしたい場合は、PrivateLink などを利用した構成や、踏み台サーバに持たせている機能の移行などを検討するのも良いと思います。</p>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20200423/&related=twitterapi%2Ctwitter&text=Session%20Manager%20%E3%81%A8%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%85%B1%E5%AD%98%E6%A7%8B%E6%88%90%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">2</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20200423/&t=Session%20Manager%20%E3%81%A8%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%85%B1%E5%AD%98%E6%A7%8B%E6%88%90" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20200423/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">6</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20200423/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">2</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2019.10.09</span><span class="snscount">&#9825;10</span><a href=/articles/20191009/ title="世の中コンテナ化の流れでEC2インスタンスを直接利用する機会が減ってきていますが、まだまだサーバにSSH接続する機会もあるかと思います。今回はSSH相当の処理をよりセキュアに行えるSession Managerについて調査・検証してみました。">AWS Session Managerでセッションを切断されにくくする方法</a></li><li class="related-posts-item"><span>2023.04.05</span><span class="snscount">&#9825;12</span><a href=/articles/20230405a/ title="こんにちは。TIG DX チームのゆるふわエンジニアの前原です。今までは、GitLab でTerraform を利用する機会が多かったのですが、今回は、GitHub Actions を利用することになりました。そこで実施した内容をこの記事に書いていきたいと思います。">Terraform とGitHub Actions</a></li><li class="related-posts-item"><span>2019.08.19</span><span class="snscount">&#9825;24</span><a href=/articles/20190819/ title="前回の環境構築編の続きで実践編です。実際の構築を通して、最近バージョンアップしたTerraform 0.12の構文がこんな感じで変わったよー的な話を伝えていければと思っています。">はじめてのTerraform 0.12 ～実践編～</a></li><li class="related-posts-item"><span>2019.08.16</span><span class="snscount">&#9825;21</span><a href=/articles/20190816/ title="これからTerraformを触っていきたいといった方にもわかるようにまずはTerraformの事始めから説明していきます。">はじめてのTerraform 0.12 ～環境構築～</a></li><li class="related-posts-item"><span>2024.01.19</span><span class="snscount">&#9825;3</span><a href=/articles/20240119a/ title="先日、本番リリースを控えたシステムで OSS ライブラリのインストール起因のエラーが発生しました。実際に起きた事象と、どのように検討して対応したのかを残すべく、ポストモーテムの形式で当記事を書きました。">リリース直前にライブラリのインストールエラーが発生した際にどのように対応したか<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2023.11.14</span><span class="snscount">&#9825;3</span><a href=/articles/20231114a/ title="当チームでは、出力されたエラーや警告ログを適宜Backlogに起票することにより、いち早くエラーの対応ができるようにしております。CloudWatch LogsサブスクリプションフィルターとSQSを用いることにより、CloudWatchの特定のログをトリガーとして監視ジョブを立ち上げる仕様に改修しました。">CloudWatch Logsサブスクリプションフィルター・SQSを用いたログ監視</a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20191009/ title="世の中コンテナ化の流れでEC2インスタンスを直接利用する機会が減ってきていますが、まだまだサーバにSSH接続する機会もあるかと思います。今回はSSH相当の処理をよりセキュアに行えるSession Managerについて調査・検証してみました。">AWS Session Managerでセッションを切断されにくくする方法</a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><span class="toc-text">はじめに</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8Session-Manager-%E3%81%AE%E5%85%B1%E5%AD%98%E6%A7%8B%E6%88%90"><span class="toc-text">踏み台サーバとSession Manager の共存構成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%96%E5%82%99"><span class="toc-text">準備</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%82%B5%E3%83%BC%E3%83%90%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99"><span class="toc-text">サーバ側の準備</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99"><span class="toc-text">クライアント側の準備</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mac-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95"><span class="toc-text">Mac インストール方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows-%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95"><span class="toc-text">Windows インストール方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%9C%E8%B6%B3-%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E8%A8%AD%E5%AE%9A"><span class="toc-text">補足: プロキシ設定</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><span class="toc-text">実際にアクセスしてみる</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-Manager-%E3%82%92%E9%80%9A%E3%81%97%E3%81%A6SSH-%E3%81%A7%E8%B8%8F%E3%81%BF%E5%8F%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%B8%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9"><span class="toc-text">Session Manager を通してSSH で踏み台サーバへアクセス</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AF%E3%83%BC%E3%83%89%E3%81%A7RDS-%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9"><span class="toc-text">ポートフォワードでRDS にアクセス</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><span class="toc-text">アクセスできない場合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%83%AD%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><span class="toc-text">ログについて</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%BE%E3%81%A8%E3%82%81"><span class="toc-text">まとめ</span></a></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (431)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (254)</a></li>
<li class=""><a href="/categories/Culture/">Culture (98)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (61)</a></li>
<li class=""><a href="/categories/IoT/">IoT (35)</a></li>
<li class=""><a href="/categories/DB/">DB (25)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (23)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (21)</a></li>
<li class=""><a href="/categories/Business/">Business (21)</a></li>
<li class=""><a href="/categories/Management/">Management (17)</a></li>
<li class=""><a href="/categories/Security/">Security (15)</a></li>
<li class=""><a href="/categories/VR/">VR (13)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      <li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/38-AIAI-e22h1v0" title="フューチャーがお届けするポッドキャストです。#38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」" target="_blank" rel="noopener"> #38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/37-e227p84" title="フューチャーがお届けするポッドキャストです。#37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）" target="_blank" rel="noopener"> #37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/36-e1rdbcu" title="フューチャーがお届けするポッドキャストです。#36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）" target="_blank" rel="noopener"> #36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）</a></li>
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2023/future" title="フューチャー Advent Calendar 2023 #Qiita" target="_blank" rel="noopener">2023年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2022/future" title="フューチャー Advent Calendar 2022 #Qiita" target="_blank" rel="noopener">2022年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2024 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
