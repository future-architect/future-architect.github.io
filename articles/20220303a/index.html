<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>Pyright を LSP サーバとした自作 LSP クライアント（実装編） | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="はじめにこんにちは、Future でアルバイトをしている空閑と申します。本記事ではタイトルの通り、Pyright を LSP (Language Server Protocol) サーバとした自作クライアントを実装しますが、その前に経緯について説明します。本節では実装については触れません。 アルバイトの前は、Future のインターン Engineer Camp で Python のソースコー">
<meta property="og:type" content="article">
<meta property="og:title" content="Pyright を LSP サーバとした自作 LSP クライアント（実装編） | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20220303a/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="はじめにこんにちは、Future でアルバイトをしている空閑と申します。本記事ではタイトルの通り、Pyright を LSP (Language Server Protocol) サーバとした自作クライアントを実装しますが、その前に経緯について説明します。本節では実装については触れません。 アルバイトの前は、Future のインターン Engineer Camp で Python のソースコー">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20220303a/PyrightLarge.png">
<meta property="article:published_time" content="2022-03-02T15:00:00.000Z">
<meta property="article:modified_time" content="2022-03-02T13:00:18.563Z">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Pyright">
<meta property="article:tag" content="LSP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20220303a/PyrightLarge.png">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20220303a/">
  <meta content="Python,Pyright,LSP" name="keywords">
  <meta content="空閑康太" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programmingカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">Pyright を LSP サーバとした自作 LSP クライアント（実装編）
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/20220303a_Pyright_を_LSP_サーバとした自作_LSP_クライアント（実装編）.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-20220303a_Pyright_を_LSP_サーバとした自作_LSP_クライアント（実装編）" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2022/" class="publish-date"><time datetime="2022-03-02T15:00:00.000Z" itemprop="datePublished">2022.03.03</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E7%A9%BA%E9%96%91%E5%BA%B7%E5%A4%AA" title="空閑康太さんの記事一覧へ" class="post-author">空閑康太</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/Python/" title="Pythonタグの記事へ" class="tag-list-link">Python</a>
  
    
    <a href="/tags/Pyright/" title="Pyrightタグの記事へ" class="tag-list-link">Pyright</a>
  
    
    <a href="/tags/LSP/" title="LSPタグの記事へ" class="tag-list-link">LSP</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <img src="/images/20220303a/PyrightLarge.png" alt="" width="565" height="234">

<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、Future でアルバイトをしている空閑と申します。本記事ではタイトルの通り、Pyright を LSP (Language Server Protocol) サーバとした自作クライアントを実装しますが、その前に経緯について説明します。本節では実装については触れません。</p>
<p>アルバイトの前は、Future のインターン Engineer Camp で Python のソースコード解析に取り組んでいました。そのときの様子は、<a href="/articles/20211019a/">Engineer Camp2021: Python の AST モジュールを使ってクラス構造を可視化する</a> で触れています。当時は Python の AST モジュールを活用する方針で、それ以外は自前で解析を行っていました。アルバイトでも引き続き解析に取り組んでいますが、次第に型推論などの技術が必要になってきており、全てを自前で実装することは困難な状況です。そこで現在は、既存のツールを拡張する方針を取っています。</p>
<p>ツールの候補としては、Mypy および Pyright が挙がりましたが、検討の結果（<a href="/articles/20220301a/">Mypy と Pyright の解析比較</a>）Pyright を拡張することにしています。Pyright は Pylance 上での実行を前提としているため、入力補完などで使う、型チェックにとどまらない情報を取得できることが理由の一つです。また、Pyright には LSP での実装が存在するため、これを利用することで、Pyright 本体の実装に手を加える必要がなく、システムを疎結合に保てます。</p>
<p>問題は、LSP クライアントをエディタ（主に VSCode）以外で実装するサンプルがほとんどないことです。解析ツールはコマンドラインで動作するようにしたいため、エディタ依存の機能は使えません。<a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/specifications/specification-current/">LSP の仕様</a>は公開されているものの、詳細な手順については記載がありません。特に Pyright における初期化の手順は、実際の実装を追う必要があり苦戦しました。次節以降では、初期化の手順を含めた自作 LSP クライアントの実装方法を紹介します。</p>
<h1 id="自作-LSP-クライアントの作成"><a href="#自作-LSP-クライアントの作成" class="headerlink" title="自作 LSP クライアントの作成"></a>自作 LSP クライアントの作成</h1><h2 id="仕様"><a href="#仕様" class="headerlink" title="仕様"></a>仕様</h2><ul>
<li>解析対象：Python</li>
<li>LSP サーバ：Pyright</li>
<li>LSP クライアント：CLI（Node.js, TypeScript）</li>
<li>目標<ul>
<li>サーバ・クライアント間のメッセージ送受信</li>
<li>メッセージによる簡単な解析結果の取得</li>
</ul>
</li>
</ul>
<h2 id="最低限実装が必要なメッセージ"><a href="#最低限実装が必要なメッセージ" class="headerlink" title="最低限実装が必要なメッセージ"></a>最低限実装が必要なメッセージ</h2><ol>
<li><a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/specifications/specification-current/#initialize">Initialize Request</a>：サーバの初期化を要求</li>
<li><a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/specifications/specification-current/#initialized">Initialized Notification</a>：クライアント側の初期化が完了したことを通知</li>
<li><a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/specifications/specification-current/#workspace_didChangeWorkspaceFolders">DidChangeWorkspaceFolders Notification</a>：ワークスペースフォルダの変更を通知</li>
</ol>
<p>詳しくは <a href="/articles/20220302a/">Pyright を LSP サーバとした自作 LSP クライアント（調査編）</a>を参照してください。</p>
<h1 id="実装"><a href="#実装" class="headerlink" title="実装"></a>実装</h1><h2 id="サーバ起動・メッセージ受信"><a href="#サーバ起動・メッセージ受信" class="headerlink" title="サーバ起動・メッセージ受信"></a>サーバ起動・メッセージ受信</h2><p>LSP サーバのパスを指定し、子プロセスで起動します。Pyright のリポジトリをクローンした場合、サーバのパスは <code>pyright/packages/pyright/langserver.index.js</code> です。Pyright は実行時引数で通信方法を指定できます。<code>--node-ipc</code>、<code>--stdio</code>、<code>--socket=&#123;number&#125;</code> から選ぶことができますが、今回は <code>--node-ipc</code> を採用します。</p>
<p>接続を確立するために <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vscode-jsonrpc"><code>vscode-jsonrpc</code></a> の <code>createMessageConnection</code> を使います。<code>vscode-jsonrpc</code> はメッセージプロトコルのライブラリで、今後もたびたび出てきます。<code>setup(connection)</code> ではメッセージハンドラを定義します。最初なのでとりあえず、<code>notification</code> と <code>error</code> メッセージが来た時に内容を出力することにします。</p>
<figure class="highlight typescript"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> child_process <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> rpc <span class="keyword">from</span> <span class="string">&#x27;vscode-jsonrpc/node&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params">connection: rpc.MessageConnection</span>) &#123;</span><br><span class="line">    connection.<span class="title function_">onUnhandledNotification</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;notification&#x27;</span>, e);</span><br><span class="line">    &#125;);</span><br><span class="line">    connection.<span class="title function_">onError</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error&#x27;</span>, e);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modulePath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;/path/to/langserver.index.js&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> childProcess = child_process.<span class="title function_">fork</span>(modulePath, [<span class="string">&#x27;--node-ipc&#x27;</span>]);</span><br><span class="line">    <span class="keyword">const</span> connection = rpc.<span class="title function_">createMessageConnection</span>(</span><br><span class="line">        <span class="keyword">new</span> rpc.<span class="title class_">IPCMessageReader</span>(childProcess),</span><br><span class="line">        <span class="keyword">new</span> rpc.<span class="title class_">IPCMessageWriter</span>(childProcess)</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">setup</span>(connection);</span><br><span class="line">    connection.<span class="title function_">listen</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>

<p>以上のコードを実際に実行すると、サーバが起動したことを通知するメッセージを <code>window/logMessage</code> メソッドで受信できます。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">jsonrpc</span>: <span class="string">&#x27;2.0&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;window/logMessage&#x27;</span>,</span><br><span class="line">    <span class="attr">params</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">message</span>: <span class="string">&#x27;Pyright language server 1.1.182 starting&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Initialize-Request"><a href="#Initialize-Request" class="headerlink" title="Initialize Request"></a>Initialize Request</h2><p>今はまだ起動してメッセージを受信するだけのプログラムなので、今度はメッセージを送信してみます。仕様では最初に Initialize Request を送ることになっているので、これを実装します。サーバにリクエストを送る場合には <code>connection.sendRequest(type, params)</code> を使います。<code>type</code> はメソッドの種類、<code>params</code> はメソッド固有のパラメタになります。これらの型定義は <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vscode-languageserver-protocol"><code>vscode-languageserver-protocol</code></a> にあるので、適当に参照します。</p>
<p><code>InitializeParams</code> にはいくつかのプロパティがありますが、最低限実装すべきは次の 4 つです。</p>
<ol>
<li><code>processId</code>（サーバの親プロセスの ID）</li>
<li><code>rootUri</code>（解析したいワークスペースのルート URI、適当でよいです）</li>
<li><code>capabilities</code>（クライアントが実装している機能、無いので空）</li>
<li><code>workspaceFolders</code>（解析したいワークスペースのフォルダ、とりあえず空）</li>
</ol>
<figure class="highlight ts"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> url <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> lsp <span class="keyword">from</span> <span class="string">&#x27;vscode-languageserver-protocol&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InitializeParams</span> <span class="keyword">implements</span> lsp.<span class="property">InitializeParams</span> &#123;</span><br><span class="line">    <span class="attr">processId</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">rootUri</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">capabilities</span>: lsp.<span class="property">ClientCapabilities</span>;</span><br><span class="line">    <span class="attr">workspaceFolders</span>: lsp.<span class="property">WorkspaceFolder</span>[] | <span class="literal">null</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">processId</span> = process.<span class="property">pid</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rootUri</span> = url.<span class="title function_">pathToFileURL</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./&#x27;</span>)).<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">capabilities</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workspaceFolders</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params">connection: rpc.MessageConnection</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    connection.<span class="title function_">listen</span>();</span><br><span class="line">    <span class="keyword">const</span> initializeResult = <span class="keyword">await</span> connection.<span class="title function_">sendRequest</span>(lsp.<span class="property">InitializeRequest</span>.<span class="property">type</span>, <span class="keyword">new</span> <span class="title class_">InitializeParams</span>());</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;initialize&#x27;</span>, initializeResult);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>

<p>Initialize Request が正しく送れていると、Initialize Result が返ってきます。こちらにも <code>capabilities</code> が含まれていますが、これはサーバ側で実装されている機能の一覧になります。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">capabilities</span>: &#123;</span><br><span class="line">        <span class="attr">textDocumentSync</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">definitionProvider</span>: &#123;…&#125;,</span><br><span class="line">        <span class="attr">declarationProvider</span>: &#123;…&#125;,</span><br><span class="line">        <span class="attr">referencesProvider</span>: &#123;…&#125;,</span><br><span class="line">        …</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Initialized-Notification"><a href="#Initialized-Notification" class="headerlink" title="Initialized Notification"></a>Initialized Notification</h2><p>次は Initialize Result を受けて、クライアント側の初期化が終わったことを通知するために Initialized Notification を送信します。サーバに通知を送る場合には <code>connection.sendNotification(type, params)</code> を使います。<code>InitializedParams</code> は空のオブジェクトなので実装はしないで <code>&#123;&#125;</code> を直接入力することにします。</p>
<figure class="highlight typescript"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InitializeParams</span> <span class="keyword">implements</span> lsp.<span class="property">InitializeParams</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params">connection: rpc.MessageConnection</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> initializeResult = <span class="keyword">await</span> connection.<span class="title function_">sendRequest</span>(lsp.<span class="property">InitializeRequest</span>.<span class="property">type</span>, <span class="keyword">new</span> <span class="title class_">InitializeParams</span>());</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;initialize&#x27;</span>, initializeResult);</span><br><span class="line">    connection.<span class="title function_">sendNotification</span>(lsp.<span class="property">InitializedNotification</span>.<span class="property">type</span>, &#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>

<p>Initialized Notification を送ると、<code>client/registerCapability</code> メソッドのメッセージが送られてきます。これはサーバがクライアントに対して機能追加を要求するメッセージになります。今はまだ、このメソッドに対するハンドラを定義していないので、ハンドラを定義して受信できるようにします。</p>
<figure class="highlight typescript"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InitializeParams</span> <span class="keyword">implements</span> lsp.<span class="property">InitializeParams</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params">connection: rpc.MessageConnection</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    connection.<span class="title function_">onRequest</span>(lsp.<span class="property">RegistrationRequest</span>.<span class="property">type</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;client/registerCapability&#x27;</span>, e);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>

<p>すると、以下のような内容のメッセージを受信したことがわかります。次はこのメソッドを実装します。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;workspace/didChangeWorkspaceFolders&#x27;</span>,</span><br><span class="line">    <span class="attr">registerOptions</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="DidChangeWorkspaceFolders-Notification"><a href="#DidChangeWorkspaceFolders-Notification" class="headerlink" title="DidChangeWorkspaceFolders Notification"></a>DidChangeWorkspaceFolders Notification</h2><p>ワークスペースフォルダを変更するメソッドを実装します。これを実行することで、解析対象のフォルダを変更することができます。<code>InitializeParams</code> 同様に <code>DidChangeWorkspaceFoldersParams</code> を実装します。プロパティは多いですが、単にワークスペースとして認識するフォルダの追加と削除を行っているだけです。また、DidChangeWorkspaceFolders Notification はデフォルトではサーバ側から認識されないため、<code>InitializeParams.capabilities</code> にワークスペース機能があることを記載します。詳細は、<a href="/articles/20220302a/">Pyright を LSP サーバとした自作 LSP クライアント（調査編）</a>で解説しています。</p>
<figure class="highlight ts"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InitializeParams</span> <span class="keyword">implements</span> lsp.<span class="property">InitializeParams</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">capabilities</span> = &#123; <span class="attr">workspace</span>: &#123; <span class="attr">workspaceFolders</span>: <span class="literal">true</span> &#125; &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkspaceFoldersChangeEvent</span> <span class="keyword">implements</span> lsp.<span class="property">WorkspaceFoldersChangeEvent</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> added: lsp.WorkspaceFolder[], <span class="keyword">public</span> removed: lsp.WorkspaceFolder[]</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkspaceFolder</span> <span class="keyword">implements</span> lsp.<span class="property">WorkspaceFolder</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> uri: <span class="built_in">string</span>, <span class="keyword">public</span> name: <span class="built_in">string</span></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DidChangeWorkspaceFoldersParams</span> <span class="keyword">implements</span> lsp.<span class="property">DidChangeWorkspaceFoldersParams</span> &#123;</span><br><span class="line">    <span class="attr">event</span>: <span class="title class_">WorkspaceFoldersChangeEvent</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">added: lsp.WorkspaceFolder[], removed: lsp.WorkspaceFolder[]</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">event</span> = <span class="keyword">new</span> <span class="title class_">WorkspaceFoldersChangeEvent</span>(added, removed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params">connection: rpc.MessageConnection</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    connection.<span class="title function_">onRequest</span>(lsp.<span class="property">RegistrationRequest</span>.<span class="property">type</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;client/registerCapability&#x27;</span>, e);</span><br><span class="line">        connection.<span class="title function_">sendNotification</span>(</span><br><span class="line">            lsp.<span class="property">DidChangeWorkspaceFoldersNotification</span>.<span class="property">type</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DidChangeWorkspaceFoldersParams</span>(</span><br><span class="line">                [<span class="keyword">new</span> <span class="title class_">WorkspaceFolder</span>(url.<span class="title function_">pathToFileURL</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./&#x27;</span>)).<span class="title function_">toString</span>(), <span class="string">&#x27;dev&#x27;</span>)],</span><br><span class="line">                []</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>

<p>実装が上手くいっていれば、DidChangeWorkspaceFolders Notification を送信したタイミングで、<code>window/logMessage</code> メソッドのメッセージが大量に受信できると思います。主に解析対象のファイルや、仮想環境の情報を通知してくれています。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Assuming Python platform Windows</span><br><span class="line">Searching for source files</span><br><span class="line">Auto-excluding \path\to\.venv</span><br><span class="line">Auto-excluding \path\to\myvenv</span><br><span class="line">Found &#123;number&#125; source files</span><br></pre></td></tr></table></figure>

<h2 id="解析メッセージ"><a href="#解析メッセージ" class="headerlink" title="解析メッセージ"></a>解析メッセージ</h2><p>以上で、解析に必要な初期化メッセージをすべて実装したことになり、ここから先は自由にメッセージを送信できます。今回は最近のエディタでよく見かける、<a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/specification#textDocument_hover">Hover Request</a> を送信してみます。<a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/ja/">FastAPI</a> を使用した以下のファイルを対象にします。</p>
<figure class="highlight py"><figcaption><span>main.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/hello&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;hello world!&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>今までと同様に、<code>HoverParams</code> を実装し適切な引数でメッセージを送信します。今回はテストなので、引数は手動で設定します。<code>Position.create(2, 6)</code> は 0-based で行数と文字数を指定しており、3 行目の 7 文字目、<code>FastAPI()</code> にカーソル位置があることを示しています。</p>
<figure class="highlight typescript"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HoverParams</span> <span class="keyword">implements</span> lsp.<span class="property">HoverParams</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> textDocument: lsp.TextDocumentIdentifier, <span class="keyword">public</span> position: lsp.Position</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">connection.<span class="title function_">sendRequest</span>(</span><br><span class="line">    lsp.<span class="property">HoverRequest</span>.<span class="property">type</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HoverParams</span>(</span><br><span class="line">        lsp.<span class="property">TextDocumentIdentifier</span>.<span class="title function_">create</span>(url.<span class="title function_">pathToFileURL</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./main.py&#x27;</span>)).<span class="title function_">toString</span>()),</span><br><span class="line">        lsp.<span class="property">Position</span>.<span class="title function_">create</span>(<span class="number">2</span>, <span class="number">6</span>)</span><br><span class="line">    )</span><br><span class="line">).<span class="title function_">then</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>実行すると以下のようなメッセージが受信でき、カーソルを合わせた時のような情報が得られました。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">contents</span>: &#123;</span><br><span class="line">        <span class="attr">kind</span>: <span class="string">&#x27;plaintext&#x27;</span></span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;(class) FastAPI(*, debug: bool = False, routes: List[BaseRoute] | None = None, title: str = &quot;FastAPI&quot;, description: str = &quot;&quot;, version: str = &quot;0.1.0&quot;, openapi_url: str | None = &quot;/openapi.json&quot;, openapi_tags: List[Dict[str, Any]] | None = None, servers: List[Dict[str, str | Any]] | None = None, dependencies: Sequence[Depends] | None = None, default_response_class: Type[Response] = Default(JSONResponse), docs_url: str | None = &quot;/docs&quot;, redoc_url: str | None = &quot;/redoc&quot;, swagger_ui_oauth2_redirect_u…one = None, on_startup: Sequence[() -&gt; Any] | None = None, on_shutdown: Sequence[() -&gt; Any] | None = None, terms_of_service: str | None = None, contact: Dict[str, str | Any] | None = None, license_info: Dict[str, str | Any] | None = None, openapi_prefix: str = &quot;&quot;, root_path: str = &quot;&quot;, root_path_in_servers: bool = True, responses: Dict[int | str, Dict[str, Any]] | None = None, callbacks: List[BaseRoute] | None = None, deprecated: bool | None = None, include_in_schema: bool = True, **extra: Any)&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">range</span>: &#123;</span><br><span class="line">        <span class="attr">end</span>: &#123;<span class="attr">line</span>: <span class="number">2</span>, <span class="attr">character</span>: <span class="number">13</span>&#125;</span><br><span class="line">        <span class="attr">start</span>: &#123;<span class="attr">line</span>: <span class="number">2</span>, <span class="attr">character</span>: <span class="number">6</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全体の実装"><a href="#全体の実装" class="headerlink" title="全体の実装"></a>全体の実装</h2><details>
  <summary>長いので折り畳み</summary>
  <div>

<figure class="highlight js"><figcaption><span>client.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> child_process <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> url <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> rpc <span class="keyword">from</span> <span class="string">&#x27;vscode-jsonrpc/node&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> lsp <span class="keyword">from</span> <span class="string">&#x27;vscode-languageserver-protocol&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InitializeParams</span> implements lsp.<span class="property">InitializeParams</span> &#123;</span><br><span class="line">    <span class="attr">processId</span>: number;</span><br><span class="line">    <span class="attr">rootUri</span>: string;</span><br><span class="line">    <span class="attr">capabilities</span>: lsp.<span class="property">ClientCapabilities</span>;</span><br><span class="line">    <span class="attr">workspaceFolders</span>: lsp.<span class="property">WorkspaceFolder</span>[] | <span class="literal">null</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">processId</span> = process.<span class="property">pid</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rootUri</span> = url.<span class="title function_">pathToFileURL</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./&#x27;</span>)).<span class="title function_">toString</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">capabilities</span> = &#123; <span class="attr">workspace</span>: &#123; <span class="attr">workspaceFolders</span>: <span class="literal">true</span> &#125; &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workspaceFolders</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkspaceFoldersChangeEvent</span> implements lsp.<span class="property">WorkspaceFoldersChangeEvent</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">public added: lsp.WorkspaceFolder[], public removed: lsp.WorkspaceFolder[]</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkspaceFolder</span> implements lsp.<span class="property">WorkspaceFolder</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">public uri: string, public name: string</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DidChangeWorkspaceFoldersParams</span> implements lsp.<span class="property">DidChangeWorkspaceFoldersParams</span> &#123;</span><br><span class="line">    <span class="attr">event</span>: <span class="title class_">WorkspaceFoldersChangeEvent</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">added: lsp.WorkspaceFolder[], removed: lsp.WorkspaceFolder[]</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">event</span> = <span class="keyword">new</span> <span class="title class_">WorkspaceFoldersChangeEvent</span>(added, removed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HoverParams</span> implements lsp.<span class="property">HoverParams</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">public textDocument: lsp.TextDocumentIdentifier, public position: lsp.Position</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params">connection: rpc.MessageConnection</span>) &#123;</span><br><span class="line">    connection.<span class="title function_">onUnhandledNotification</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;notification&#x27;</span>, e);</span><br><span class="line">    &#125;);</span><br><span class="line">    connection.<span class="title function_">onError</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error&#x27;</span>, e);</span><br><span class="line">    &#125;);</span><br><span class="line">    connection.<span class="title function_">onNotification</span>(lsp.<span class="property">LogMessageNotification</span>.<span class="property">type</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">info</span>(e.<span class="property">message</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    connection.<span class="title function_">onRequest</span>(lsp.<span class="property">RegistrationRequest</span>.<span class="property">type</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;client/registerCapability&#x27;</span>, e);</span><br><span class="line">        connection.<span class="title function_">sendNotification</span>(</span><br><span class="line">            lsp.<span class="property">DidChangeWorkspaceFoldersNotification</span>.<span class="property">type</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DidChangeWorkspaceFoldersParams</span>(</span><br><span class="line">                [<span class="keyword">new</span> <span class="title class_">WorkspaceFolder</span>(url.<span class="title function_">pathToFileURL</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./&#x27;</span>)).<span class="title function_">toString</span>(), <span class="string">&#x27;dev&#x27;</span>)],</span><br><span class="line">                []</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        connection</span><br><span class="line">            .<span class="title function_">sendRequest</span>(</span><br><span class="line">                lsp.<span class="property">HoverRequest</span>.<span class="property">type</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HoverParams</span>(</span><br><span class="line">                    lsp.<span class="property">TextDocumentIdentifier</span>.<span class="title function_">create</span>(url.<span class="title function_">pathToFileURL</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./main.py&#x27;</span>)).<span class="title function_">toString</span>()),</span><br><span class="line">                    lsp.<span class="property">Position</span>.<span class="title function_">create</span>(<span class="number">2</span>, <span class="number">6</span>)</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> modulePath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;./packages/cli-pyright/langserver.index.js&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> childProcess = child_process.<span class="title function_">fork</span>(modulePath, [<span class="string">&#x27;--node-ipc&#x27;</span>]);</span><br><span class="line">    <span class="keyword">const</span> connection = rpc.<span class="title function_">createMessageConnection</span>(</span><br><span class="line">        <span class="keyword">new</span> rpc.<span class="title class_">IPCMessageReader</span>(childProcess),</span><br><span class="line">        <span class="keyword">new</span> rpc.<span class="title class_">IPCMessageWriter</span>(childProcess)</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">setup</span>(connection);</span><br><span class="line">    connection.<span class="title function_">listen</span>();</span><br><span class="line">    <span class="keyword">const</span> initializeResult = <span class="keyword">await</span> connection.<span class="title function_">sendRequest</span>(lsp.<span class="property">InitializeRequest</span>.<span class="property">type</span>, <span class="keyword">new</span> <span class="title class_">InitializeParams</span>());</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;initialize&#x27;</span>, initializeResult);</span><br><span class="line">    connection.<span class="title function_">sendNotification</span>(lsp.<span class="property">InitializedNotification</span>.<span class="property">type</span>, &#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>
</div>
</details>

<h1 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h1><p>今回は、自作の LSP クライアントを実装しました。機能としては不十分ですが、遊ぶ分には楽しめると思います。本来の目的は既存のメッセージを組み合わせての解析なのですが、実際のところかなり面倒です…。LSP が解析目的のプロトコルではないので当然ですが。現在は Pyright 内部をいじることも検討しているので、LSP サーバ側の実装についても今後機会があれば紹介したいと思います。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://microsoft.github.io/language-server-protocol/">https://microsoft.github.io/language-server-protocol/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/visualstudio/extensibility/language-server-protocol?view=vs-2022">https://docs.microsoft.com/en-us/visualstudio/extensibility/language-server-protocol?view=vs-2022</a></li>
<li><a target="_blank" rel="noopener" href="https://qiita.com/atsushieno/items/ce31df9bd88e98eec5c4">https://qiita.com/atsushieno/items/ce31df9bd88e98eec5c4</a></li>
<li><a target="_blank" rel="noopener" href="https://qiita.com/Ladicle/items/e666e3fb9fae9d807969">https://qiita.com/Ladicle/items/e666e3fb9fae9d807969</a></li>
<li><a target="_blank" rel="noopener" href="https://zenn.dev/takl/books/0fe11c6e177223">https://zenn.dev/takl/books/0fe11c6e177223</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tennashi/lsp_spec_ja">https://github.com/tennashi/lsp_spec_ja</a></li>
</ul>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20220303a/&related=twitterapi%2Ctwitter&text=Pyright%20%E3%82%92%20LSP%20%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%81%97%E3%81%9F%E8%87%AA%E4%BD%9C%20LSP%20%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%EF%BC%88%E5%AE%9F%E8%A3%85%E7%B7%A8%EF%BC%89%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">5</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20220303a/&t=Pyright%20%E3%82%92%20LSP%20%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%81%97%E3%81%9F%E8%87%AA%E4%BD%9C%20LSP%20%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%EF%BC%88%E5%AE%9F%E8%A3%85%E7%B7%A8%EF%BC%89" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20220303a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">1</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20220303a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">3</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2022.03.02</span><span class="snscount">&#9825;3</span><a href=/articles/20220302a/ title="Language Server Protocol の理解として、Pyright を LSP サーバとした自作クライアントの作成を行いました。その際、Pyright に解析を行わせるための初期化方法がドキュメントには書かれていなかったので、VSCode 拡張用のクライアントをトレースして調査することにしました"> Pyright を LSP サーバとした自作 LSP クライアント（調査編）</a></li><li class="related-posts-item"><span>2022.03.01</span><span class="snscount">&#9825;22</span><a href=/articles/20220301a/ title="Mypy や Pyright は Python の静的解析ツールとして有名ですが、これら二つに解析情報でどのような違いがあるのかわからなかったので、実験することにしました。Pyright は Mypy に比べて後発のプロジェクトですが、性能面で優れているなどとして徐々に注目を集めています。"> Mypy と Pyright の解析手法と型情報の比較</a></li><li class="related-posts-item"><span>2021.10.19</span><span class="snscount">&#9825;12</span><a href=/articles/20211019a/ title="こんにちは、Future のインターン Engineer Camp に参加した空閑です。今回のインターンではソースコード静的解析システムの開発に取り組みました。そこで本記事では、開発内容の一部である、Python の AST モジュールを使ったクラス構造の可視化について紹介します。Python の環境構築については以下を参考にしました。[サーバーアプリ開発環境"> Engineer Camp2021: Python の AST モジュールを使ってクラス構造を可視化する</a></li><li class="related-posts-item"><span>2022.02.04</span><span class="snscount">&#9825;16</span><a href=/articles/20220204a/ title="AWS Step Functionsの動的並列処理をローカルで実行する方法をハンズオン形式でまとめました。"> Step Functionsの動的並列処理をローカルで実行する</a></li><li class="related-posts-item"><span>2021.10.11</span><span class="snscount">&#9825;10</span><a href=/articles/20211011a/ title="PySparkを使用したGlueジョブ開発のお話をします。ETLツールとして使用されるAWS Glueですが、業務バッチで行うような複雑な処理も実行できます。また、処理はGlueジョブとして、Apache Spark分散・並列処理のジョブフローに簡単に乗せることができます！"> AWS Glueで複雑な処理を開発するときのTips</a></li><li class="related-posts-item"><span>2021.10.08</span><span class="snscount">&#9825;31</span><a href=/articles/20211008a/ title="2021年9月24日にscikit-learn 1.0がリリースされました。私が大学院生のころ、scikit-learnのサンプルを動かすところから機械学習を勉強したので、ついに1.0かとなんだか感慨深い気持ちがありますから、個人的に気になった以下の4つの内容を紹介しようと思います。"> scikit-learn 1.0 リリース！更新内容を一部紹介します。</a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20220302a/ title="Language Server Protocol の理解として、Pyright を LSP サーバとした自作クライアントの作成を行いました。その際、Pyright に解析を行わせるための初期化方法がドキュメントには書かれていなかったので、VSCode 拡張用のクライアントをトレースして調査することにしました"> Pyright を LSP サーバとした自作 LSP クライアント（調査編）</a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><span class="toc-text">はじめに</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E4%BD%9C-LSP-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90"><span class="toc-text">自作 LSP クライアントの作成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%95%E6%A7%98"><span class="toc-text">仕様</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%8E%E9%99%90%E5%AE%9F%E8%A3%85%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8"><span class="toc-text">最低限実装が必要なメッセージ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9F%E8%A3%85"><span class="toc-text">実装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%82%B5%E3%83%BC%E3%83%90%E8%B5%B7%E5%8B%95%E3%83%BB%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E5%8F%97%E4%BF%A1"><span class="toc-text">サーバ起動・メッセージ受信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Initialize-Request"><span class="toc-text">Initialize Request</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Initialized-Notification"><span class="toc-text">Initialized Notification</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DidChangeWorkspaceFolders-Notification"><span class="toc-text">DidChangeWorkspaceFolders Notification</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8"><span class="toc-text">解析メッセージ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E4%BD%93%E3%81%AE%E5%AE%9F%E8%A3%85"><span class="toc-text">全体の実装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%84%9F%E6%83%B3"><span class="toc-text">感想</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (303)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (181)</a></li>
<li class=""><a href="/categories/Culture/">Culture (75)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (42)</a></li>
<li class=""><a href="/categories/IoT/">IoT (29)</a></li>
<li class=""><a href="/categories/DB/">DB (17)</a></li>
<li class=""><a href="/categories/Management/">Management (13)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (12)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>
<li class=""><a href="/categories/VR/">VR (10)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (10)</a></li>
<li class=""><a href="/categories/Business/">Business (8)</a></li>
<li class=""><a href="/categories/Security/">Security (5)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      <li><a href="https://anchor.fm/futuretechcast/episodes/24-TechNightTerraformTerraform---e1jseai" title="フューチャーがお届けするポッドキャストです。#24 【TechNight】Terraformエンジニア棚井さんから学ぶ「Terraform初心者を脱する瞬間」 - 前編" target="_blank" rel="noopener"><span class="newitem">NEW</span> #24 【TechNight】Terraformエンジニア棚井さんから学ぶ「Terraform初心者を脱する瞬間」 - 前編</a></li>
<li><a href="https://anchor.fm/futuretechcast/episodes/23-XIGTIGTIG---e1ivbnn" title="フューチャーがお届けするポッドキャストです。#23 【XIGリーダー】TIGリーダーの柴田健一さんにTIGの生い立ちと大切にしているカルチャーについて聞いてみた - 後編" target="_blank" rel="noopener"> #23 【XIGリーダー】TIGリーダーの柴田健一さんにTIGの生い立ちと大切にしているカルチャーについて聞いてみた - 後編</a></li>
<li><a href="https://anchor.fm/futuretechcast/episodes/22-XIGTIGTIG---e1iap0h" title="フューチャーがお届けするポッドキャストです。#22 【XIGリーダー】TIGリーダーの柴田健一さんにTIGの生い立ちと大切にしているカルチャーについて聞いてみた - 前編" target="_blank" rel="noopener"> #22 【XIGリーダー】TIGリーダーの柴田健一さんにTIGの生い立ちと大切にしているカルチャーについて聞いてみた - 前編</a></li>
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2022 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
