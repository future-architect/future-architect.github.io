<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>フューチャー技術ブログ</title>
  
  <subtitle>Future Tech Blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://future-architect.github.io/"/>
  <updated>2020-09-03T02:28:27.763Z</updated>
  <id>https://future-architect.github.io/</id>
  
  <author>
    <name>Future Architect Consultants</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ANTLRを業務で活用した話</title>
    <link href="https://future-architect.github.io/articles/20200903/"/>
    <id>https://future-architect.github.io/articles/20200903/</id>
    <published>2020-09-02T15:00:00.000Z</published>
    <updated>2020-09-03T02:28:27.763Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、TIG コアテクノロジーユニットの平岡です。</p><p>コアテクノロジーユニットはフューチャーグループ全体のビジネスを支えるコアとなる技術をグループ横断で提供することをミッションにしています。またOSS活動も活発に行っています。コアテクノロジーユニットのメンバーが以前に投稿した記事をいくつか紹介しておきますので、是非そちらもご覧ください。</p><ul><li><a href="https://future-architect.github.io/articles/20190620/">RedmineからGoogle Hangouts Chat へ連携するプラグインを作成しました！</a></li><li><a href="https://future-architect.github.io/articles/20181031/">その問い合わせ、AIが解決します！～Redmineチケットレコメンドシステムのご紹介～</a></li><li><a href="https://future-architect.github.io/articles/20170228/">SQL開発者を幸せにする！？ Sublime Text 3でも使える uroboroSQL Formatter を公開しました</a></li></ul><h1 id="ANTLRとは"><a href="#ANTLRとは" class="headerlink" title="ANTLRとは"></a>ANTLRとは</h1><p>皆さんは<a href="https://www.antlr.org/" target="_blank" rel="noopener">ANTLR</a>をご存知でしょうか？ANTLRとはparser(構文解析器)を生成するためのツール(パーサジェネレータ)で、以下のような特徴があります。</p><ul><li>grammar(解析したいテキストの構造に関するルールを定義したもの)を元に、parserを自動生成できる</li><li>解析対象をparserに渡した後に構成されるAST(抽象構文木)をトラバースすることで、目的に合った解析を行うことができる</li><li>様々なプログラミング言語のgrammarが<a href="https://github.com/antlr/grammars-v4" target="_blank" rel="noopener">公式</a>で整備されている<ul><li>もちろん、自分でgrammarを作ることもできる</li></ul></li><li>ターゲット言語(生成されるparserの実装に使用可能な言語)はJava, JavaScript, Pythonなど主要なものをサポートしている(<a href="https://github.com/antlr/antlr4/blob/master/doc/targets.md" target="_blank" rel="noopener">詳細</a>)<ul><li>Javaで開発をしない人向けに：ただし、ANTLRはJavaで実装されているため、Java以外の言語で実装されたparser生成にもJavaが必要となる(<a href="https://github.com/antlr/antlr4/blob/master/doc/getting-started.md" target="_blank" rel="noopener">Javaコマンドでparser生成したい場合の手順</a>)</li></ul></li></ul><p>このように非常に汎用性の高いツールであり、応用先は多岐にわたるようです。公式サイトによると、Twitterの検索機能にも使われているという記述がありました。</p><p>パーサジェネレータや構文解析に関連した他のトピックもいくつか紹介しておきましょう。</p><ul><li>ANTLR以外のパーサジェネレータの例としては、<a href="https://github.com/javacc/javacc" target="_blank" rel="noopener">JavaCC</a>(Java), <a href="https://github.com/pegjs/pegjs" target="_blank" rel="noopener">PEG.js</a>(JavaScript), <a href="https://www.gnu.org/software/bison/" target="_blank" rel="noopener">Bison</a>(C)などが有名ですが、いずれもターゲット言語=実装言語です。一方で、ANTLRはターゲット言語の種類が多いという特徴を持ちます。</li><li>同じコアテクノロジーユニットのメンバーである<a href="https://github.com/ota-meshi" target="_blank" rel="noopener">太田さん</a>(Vue.jsのコミッターです！)がメンテしている<a href="https://github.com/vuejs/eslint-plugin-vue" target="_blank" rel="noopener">eslint-plugin-vue</a>では、ANTLRは使っていませんがASTに基づいた構文解析を行っています。</li></ul><p>この記事では、まずシンプルな例を通してANTLRの概要を説明します。その後、ANTLRを使って業務で生じた課題を解決した時の話について述べたいと思います。</p><h1 id="ANTLRの概要"><a href="#ANTLRの概要" class="headerlink" title="ANTLRの概要"></a>ANTLRの概要</h1><h2 id="lexerとparser"><a href="#lexerとparser" class="headerlink" title="lexerとparser"></a>lexerとparser</h2><p>ANTLRはgrammarを元にparserを自動生成できることを上で述べましたが、より正確には、解析対象のテキストをparserに渡すために必要なlexer(字句解析器)も生成します。ここでは、<code>123 + 456</code>のような2個の整数を足す式を構文解析する例を通してlexer, parserの役割について説明します。</p><p>まず、解析対象がlexerを経由してparserに渡るイメージを見てみましょう。</p><p><img src="/images/20200903/antlr_flow.png" alt=""></p><p>lexerの役割は、解析対象を読んでトークン(1つの意味を持つ最小単位)の列に分解することです。この例では、2個の整数を足す式<code>123 + 456</code>を3つのトークン<code>123</code>,<code>+</code>,<code>456</code>に分解しています。なお、<code>123 + 456</code>には空白が含まれていますが、grammarを上手く設定すると読み飛ばすことができます(後述)。</p><p>parserの役割は、トークンの列を読んでAST(抽象構文木)を構成することです。listenerやvisitor(後述)を実装してASTをトラバースすることで、目的に合った解析処理を行うことができます。</p><p>lexer, parserを生成するためにgrammarには何を記述すれば良いのでしょうか？<br>基本的には、<code>ルール名:ルール定義;</code>の形式でルールを列挙します。実際に例を見てみましょう。</p><figure class="highlight java"><figcaption><span>SampleLexer.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * lexer用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">lexer grammar SampleLexer;</span><br><span class="line"></span><br><span class="line">NUM</span><br><span class="line">: [<span class="number">0</span>-<span class="number">9</span>]+</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">PLUS</span><br><span class="line">: <span class="string">'+'</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 空白は読み飛ばす</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SPACE</span><br><span class="line">: <span class="string">' '</span> -&gt; skip</span><br><span class="line">;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>SampleParser.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * parser用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser grammar SampleParser;</span><br><span class="line"></span><br><span class="line">options &#123; tokenVocab=SampleLexer; &#125;</span><br><span class="line"></span><br><span class="line">sum</span><br><span class="line">: NUM PLUS NUM</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>VSCodeをお使いの場合は、<a href="https://marketplace.visualstudio.com/items?itemName=mike-lischke.vscode-antlr4" target="_blank" rel="noopener">ANTLR4 grammar syntax support</a>という拡張を導入するとシンタックスハイライトが使えて見やすくなります。また、この拡張はgrammarの構造を可視化する機能も備えており(<a href="https://github.com/mike-lischke/vscode-antlr4/blob/master/doc/grammar-debugging.md#live-graphical-parse-tree" target="_blank" rel="noopener">詳しくはこちら</a>)、非常に便利です。</p><p><img src="/images/20200903/image.png" alt=""></p><p>grammarの説明に戻りましょう。</p><p>lexer用とparser用のgrammarを分割して記載していますが、同一ファイルで記述することもできます。保守性を考慮する場合は、分割するのが良いでしょう。</p><p>lexerとparserのルールを区別するために、lexerの場合はルール名は大文字始まり、parserの場合はルール名は小文字始まりで記述する必要があります。</p><p>lexerのルール定義について見てみましょう。例えば、整数を表すトークンNUMの定義は、<code>[0-9]+</code>ですが、これは数字1個以上からなる文字列を最長一致でマッチさせてNUMというトークンに割り当てることを意味します。</p><p>parserのルール定義について見てみましょう。sumというルールは、<code>NUM</code>,<code>PLUS</code>,<code>NUM</code>という3つのトークンから構成される列(つまり、足し算の式)であるという定義です。sumのようなルール名はASTの節点に対応し、<code>NUM</code>, <code>PLUS</code>, <code>NUM</code>のようなルール定義を構成する要素はルール名に対応する節点の子に対応しています。</p><p>lexer用grammarのSPACEでは、skipコマンドを使うことで空白を読み飛ばしています。skipコマンドを使わないで空白をケアする場合は、parser用grammarのsumの定義が下記のように複雑になってしまいます。このように、lexerの定義次第でparserの定義が複雑になり得るので注意が必要です。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sum</span><br><span class="line">: SPACE* NUM SPACE* PLUS SPACE* NUM</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>grammarの詳細については、<a href="https://github.com/antlr/antlr4/blob/4.6/doc/index.md" target="_blank" rel="noopener">公式ドキュメント</a>を参照して下さい。</p><p>では、上に載せたgrammarを元に、mavenでparserを生成してみましょう。<br><a href="https://www.antlr.org/api/maven-plugin/latest/index.html" target="_blank" rel="noopener">ANTLR v4 Maven plugin</a>のデフォルトの動作の特徴は次の通りです。</p><ul><li><code>src/main/antlr4</code>以下に配置されたgrammarファイル(.g4ファイル)を参照してparser等を生成する</li><li>生成されるparser等のパッケージ構造は、<code>src/main/antlr4</code>から見た相対パスを元に自動で設定される</li></ul><p><code>jp.co.future.antlr.parser</code>パッケージにparser等を格納したい場合は下記のようにgrammarを配置すれば良いです(参照するgrammarや設定したいパッケージ名をpom.xml内で明示的に指定することもできます)。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├─main</span><br><span class="line">│  ├─antlr4</span><br><span class="line">│  │  └─jp</span><br><span class="line">│  │      └─co</span><br><span class="line">│  │          └─future</span><br><span class="line">│  │              └─antlr</span><br><span class="line">│  │                  └─parser</span><br><span class="line">│  │                          SampleLexer.g4</span><br><span class="line">│  │                          SampleParser.g4</span><br><span class="line">│  │</span><br><span class="line">(省略)</span><br></pre></td></tr></table></figure><p>また、pom.xmlに以下のように追記します。</p><figure class="highlight xml"><figcaption><span>pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- (省略) --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.antlr<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>antlr4-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;antlr.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- grammarの配置場所がsrc/main/antlr4/xxx/Grammar.g4の場合、src/main/java/xxx配下にparser等のファイルが生成される) --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- listenerを生成したい場合 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">listener</span>&gt;</span>true<span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- visitorを生成したい場合 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">visitor</span>&gt;</span>true<span class="tag">&lt;/<span class="name">visitor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>antlr-generate<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- mvn antlr4:antlr4 を実行するとparser等が生成される --&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>antlr4<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.antlr<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>antlr4-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;antlr.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用したいANTLRのバージョンを指定 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">antlr.version</span>&gt;</span>4.8-1<span class="tag">&lt;/<span class="name">antlr.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>mvn antlr4:antlr4</code>を実行すると、下記のようにparser等が生成されました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├─main</span><br><span class="line">│  ├─antlr4</span><br><span class="line">│  │  └─jp</span><br><span class="line">│  │      └─co</span><br><span class="line">│  │          └─future</span><br><span class="line">│  │              └─antlr</span><br><span class="line">│  │                  └─parser</span><br><span class="line">│  │                          SampleLexer.g4</span><br><span class="line">│  │                          SampleParser.g4</span><br><span class="line">│  │</span><br><span class="line">│  └─java</span><br><span class="line">│      │  SampleLexer.tokens</span><br><span class="line">│      │  SampleParser.tokens</span><br><span class="line">│      │</span><br><span class="line">│      └─jp</span><br><span class="line">│          └─co</span><br><span class="line">│              └─future</span><br><span class="line">│                  └─antlr</span><br><span class="line">│                      │  App.java</span><br><span class="line">│                      │</span><br><span class="line">│                      └─parser</span><br><span class="line">│                              SampleLexer.interp</span><br><span class="line">│                              SampleLexer.java</span><br><span class="line">│                              SampleParser.interp</span><br><span class="line">│                              SampleParser.java</span><br><span class="line">│                              SampleParserBaseListener.java</span><br><span class="line">│                              SampleParserBaseVisitor.java</span><br><span class="line">│                              SampleParserListener.java</span><br><span class="line">│                              SampleParserVisitor.java</span><br><span class="line">(省略)</span><br></pre></td></tr></table></figure><h2 id="listenerとvisitor"><a href="#listenerとvisitor" class="headerlink" title="listenerとvisitor"></a>listenerとvisitor</h2><p>grammarを元にparserを生成できました。<br>ここからは、parserから得られるASTをトラバース(ASTのノードを深さ優先探索で順番に訪問)し、目的に合った解析を行う方法について見ていきましょう。</p><p>今回は、+の右側の整数を取得したいという目的があるとしましょう(例えば、<code>123 + 456</code>が入力の場合は<code>456</code>を出力)。<br>ASTをトラバースするためには、listenerもしくはvisitorを実装する必要があります。<br>まずは、listenerの実装例を見てみましょう。</p><figure class="highlight java"><figcaption><span>ExtractRhsNumListener.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr.parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtractRhsNumListener</span> <span class="keyword">extends</span> <span class="title">SampleParserBaseListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Integer rhsNum;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exitSum</span><span class="params">(SampleParser.SumContext ctx)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 2つ目のNUM、つまり+の右側の整数をセットする</span></span><br><span class="line">setRhsNum(<span class="keyword">new</span> Integer(ctx.NUM(<span class="number">1</span>).getText()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getRhsNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> rhsNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRhsNum</span><span class="params">(Integer rhsNum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.rhsNum = rhsNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>App.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.ExtractRhsNumListener;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleLexer;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTreeWalker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">extractRhsNumByListener();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * listenerで"123 + 456"の+の右側の整数を抽出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">extractRhsNumByListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 文字列からCharStreamを生成</span></span><br><span class="line">CharStream cs = CharStreams.fromString(<span class="string">"123 + 456"</span>);</span><br><span class="line"><span class="comment">// CharStreamをlexerに渡す</span></span><br><span class="line">SampleLexer lexer = <span class="keyword">new</span> SampleLexer(cs);</span><br><span class="line"><span class="comment">// lexerでトークン列に分解</span></span><br><span class="line">CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);</span><br><span class="line"><span class="comment">// トークン列をparserに渡し、ASTを作る</span></span><br><span class="line">SampleParser parser = <span class="keyword">new</span> SampleParser(tokens);</span><br><span class="line"><span class="comment">// listenerでASTをトラバース</span></span><br><span class="line">ParseTreeWalker walker = ParseTreeWalker.DEFAULT;</span><br><span class="line">ExtractRhsNumListener listener = <span class="keyword">new</span> ExtractRhsNumListener();</span><br><span class="line">walker.walk(listener, parser.sum());</span><br><span class="line">System.out.println(listener.getRhsNum());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">456</span><br></pre></td></tr></table></figure><p>listenerの特徴は以下の通りです。</p><ul><li>ASTの全ノードを訪問する</li><li>ノードに入るタイミング(<code>enterXXX</code>メソッド)・ノードを抜けるタイミング(<code>exitXXX</code>メソッド)に行う処理を目的に合わせてOverrideする</li><li>Overrideするメソッドは返り値を持たないため、欲しい値はフィールドで保持する必要がある</li></ul><p>上の実装例の<code>ExtractRhsNumListener#enterSum</code>は、ASTでsumノードを最初に訪問した時に2番目のNUM(つまり、+の右側の整数)をセットする処理を行っています。<br><code>enterSum</code>ではなく<code>exitSum</code>でOverrideしても同様の実行結果が得られます。</p><p>続いて、visitorの実装例を見てみましょう。</p><figure class="highlight java"><figcaption><span>ExtractRhsNumVisitor.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr.parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtractRhsNumVisitor</span> <span class="keyword">extends</span> <span class="title">SampleParserBaseVisitor</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">visitSum</span><span class="params">(SampleParser.SumContext ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Integer(ctx.NUM(<span class="number">1</span>).getText());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>App.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.ExtractRhsNumVisitor;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleLexer;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTree;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">extractRhsNumByVisitor();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * visitorで"123 + 456"の+の右側の整数を抽出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">extractRhsNumByVisitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 文字列からCharStreamを生成</span></span><br><span class="line">CharStream cs = CharStreams.fromString(<span class="string">"123 + 456"</span>);</span><br><span class="line"><span class="comment">// CharStreamをlexerに渡す</span></span><br><span class="line">SampleLexer lexer = <span class="keyword">new</span> SampleLexer(cs);</span><br><span class="line"><span class="comment">// lexerでトークン列に分解</span></span><br><span class="line">CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);</span><br><span class="line"><span class="comment">// トークン列をparserに渡し、ASTを作る</span></span><br><span class="line">SampleParser parser = <span class="keyword">new</span> SampleParser(tokens);</span><br><span class="line"><span class="comment">// visitorでASTをトラバース</span></span><br><span class="line">ParseTree tree = parser.sum();</span><br><span class="line">System.out.println(<span class="keyword">new</span> ExtractRhsNumVisitor().visit(tree));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">456</span><br></pre></td></tr></table></figure><p>visitorの特徴は以下の通りです。</p><ul><li>ASTの全ノードを訪問するとは限らない</li><li>ノードに入った時(<code>visitXXX</code>メソッド)に行う処理を目的に合わせてOverrideする</li><li>Overrideするメソッドは返り値を持つため、欲しい値をフィールドで保持しなくてよい</li></ul><p>上の実装例の<code>ExtractRhsNumVisitor#visitSum</code>は、ASTでsumノードを最初に訪問した時に2番目のNUM(つまり、+の右側の整数)を返す処理を行っています。</p><p>listenerでは自動的にASTの全ノードを訪問するのに対し、visitorの場合は今いるノードの部分木を訪問したい場合は明示的に実装する必要があるという大きな違いがあります。</p><h1 id="業務で生じた課題"><a href="#業務で生じた課題" class="headerlink" title="業務で生じた課題"></a>業務で生じた課題</h1><p>以降では、業務で生じた課題をANTLRで解決した話について述べたいと思います。課題の概要は以下の通りです。</p><p>以下のような<code>&lt;template&gt;</code>, <code>&lt;script&gt;</code>, <code>&lt;style&gt;</code>ブロックから構成されるvueファイルが与えられます。</p><figure class="highlight html"><figcaption><span>input.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; greeting &#125;&#125; World!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">  data () &#123;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">      greeting: <span class="string">'Hello'</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">p &#123;</span><br><span class="line">    font-size: 2em;</span><br><span class="line">    text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>このとき、以下のように<code>&lt;script&gt;</code>ブロックの中身を抽出する処理をJavaで実装して下さい。</p><figure class="highlight js"><figcaption><span>output.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      greeting: <span class="string">'Hello'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="解決策"><a href="#解決策" class="headerlink" title="解決策"></a>解決策</h1><ul><li>正規表現では難しい<ul><li><code>&lt;script&gt;(.*)&lt;/script&gt;</code>で良さそうに見えるが、以下のようなコメントがある場合に対応できない</li></ul></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;script&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// (省略)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>DOMやNekoHTMLなどのJavaで動作するXML用parserでは正しくparseできない場合があった</li><li>当時はANTLRについて調査するタスクも担当していたため、ANTLRで対応を試みた<ul><li>Vue.js用のgrammarは公式で用意されていなかったが、<code>&lt;script&gt;</code>ブロックの中身を取り出せれば十分なので、grammarを自作することにした </li></ul></li></ul><h1 id="コード"><a href="#コード" class="headerlink" title="コード"></a>コード</h1><details><summary>lexer用grammarを表示</summary><div><figure class="highlight java"><figcaption><span>SimpleVueLexer.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vueファイルから&lt;script&gt;ブロックの中身を抽出するためのlexer用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">lexer grammar SimpleVueLexer;</span><br><span class="line"></span><br><span class="line">HtmlComment</span><br><span class="line">    : <span class="string">'&lt;!--'</span> .*? <span class="string">'--&gt;'</span> -&gt; skip</span><br><span class="line">    ; </span><br><span class="line"></span><br><span class="line">WhiteSpaces</span><br><span class="line">    : [\t\u000B\u000C\u0020\u00A0]+ -&gt; skip</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">LineTerminator</span><br><span class="line">    : [\r\n\u2028\u2029] -&gt; skip</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// このトークンを検出した場合、TEMPLATEモードに遷移する</span></span><br><span class="line">TemplateOpen</span><br><span class="line">    : <span class="string">'&lt;template'</span> .*? <span class="string">'&gt;'</span> -&gt; pushMode(TEMPLATE)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// このトークンを検出した場合、SCRIPTモードに遷移する</span></span><br><span class="line">ScriptOpen</span><br><span class="line">    : <span class="string">'&lt;script'</span> .*? <span class="string">'&gt;'</span> -&gt; pushMode(SCRIPT)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// このトークンを検出した場合、STYLEモードに遷移する</span></span><br><span class="line">StyleOpen</span><br><span class="line">    : <span class="string">'&lt;style'</span> .*? <span class="string">'&gt;'</span> -&gt; pushMode(STYLE)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;template&gt;ブロックの中身を読んでいる時</span></span><br><span class="line">mode TEMPLATE;</span><br><span class="line"></span><br><span class="line">CommentInTemplate</span><br><span class="line">    : <span class="string">'&lt;!--'</span> .*? <span class="string">'--&gt;'</span> -&gt; skip</span><br><span class="line">    ; </span><br><span class="line"></span><br><span class="line">TemplateClose</span><br><span class="line">    : .* <span class="string">'&lt;/template&gt;'</span> -&gt; popMode</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;script&gt;ブロックの中身を読んでいる時</span></span><br><span class="line">mode SCRIPT;</span><br><span class="line"></span><br><span class="line">MultiLineComment</span><br><span class="line">    : <span class="string">'/*'</span> .*? <span class="string">'*/'</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">SingleLineComment</span><br><span class="line">    : <span class="string">'//'</span> ~[\r\n\u2028\u2029]*</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">ScriptClose</span><br><span class="line">    : <span class="string">'&lt;/script&gt;'</span> -&gt; popMode</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//「&lt;/」や「//」や「/*」で始まらない</span></span><br><span class="line">ScriptText</span><br><span class="line">    : (~[&lt;/] | '&lt;' ~'/' | '/' ~[*/])+</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;style&gt;ブロックの中身を読んでいる時</span></span><br><span class="line">mode STYLE;</span><br><span class="line"></span><br><span class="line">CommentInStyle</span><br><span class="line">    : <span class="string">'&lt;!--'</span> .*? <span class="string">'--&gt;'</span> -&gt; skip</span><br><span class="line">    ; </span><br><span class="line"></span><br><span class="line">StyleClose</span><br><span class="line">    : .* <span class="string">'&lt;/style&gt;'</span> -&gt; popMode</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure></div></details><details><summary>parser用grammarを表示</summary><div><figure class="highlight java"><figcaption><span>SimpleVueParser.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vueファイルから&lt;script&gt;ブロックの中身を抽出するためのparser用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser grammar SimpleVueParser;</span><br><span class="line"></span><br><span class="line">options &#123; tokenVocab=SimpleVueLexer; &#125;</span><br><span class="line"></span><br><span class="line">parse</span><br><span class="line">: templateElement? scriptElement styleElement?</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">templateElement</span><br><span class="line">: TemplateOpen TemplateClose</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">scriptElement</span><br><span class="line">: ScriptOpen scriptBody ScriptClose</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 今回取得したい部分</span></span><br><span class="line">scriptBody</span><br><span class="line">: (SingleLineComment</span><br><span class="line">| MultiLineComment</span><br><span class="line">| ScriptText)+</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">styleElement</span><br><span class="line">: StyleOpen StyleClose</span><br><span class="line">;</span><br></pre></td></tr></table></figure></div></details><details><summary>抽出用listenerを表示</summary><div><figure class="highlight java"><figcaption><span>JavaScriptExtractorListener.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr.parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SimpleVueParser.ScriptElementContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTreeWalker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptExtractorListener</span> <span class="keyword">extends</span> <span class="title">SimpleVueParserBaseListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽出した文字列 */</span></span><br><span class="line"><span class="keyword">private</span> String scriptBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽出実行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exec</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">// 指定したファイルからCharStreamを生成</span></span><br><span class="line">CharStream cs = CharStreams.fromPath(Paths.get(filePath));</span><br><span class="line"><span class="comment">// CharStreamをlexerに渡す</span></span><br><span class="line">SimpleVueLexer lexer = <span class="keyword">new</span> SimpleVueLexer(cs);</span><br><span class="line"><span class="comment">// lexerでトークン列に分解</span></span><br><span class="line">CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);</span><br><span class="line"><span class="comment">// トークン列をparserに渡し、ASTを作る</span></span><br><span class="line">SimpleVueParser parser = <span class="keyword">new</span> SimpleVueParser(tokens);</span><br><span class="line"><span class="comment">// ASTをトラバースして文字列を抽出する</span></span><br><span class="line">ParseTreeWalker walker = ParseTreeWalker.DEFAULT;</span><br><span class="line">walker.walk(<span class="keyword">this</span>, parser.parse());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enterScriptElement</span><span class="params">(ScriptElementContext ctx)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 抽出する文字列をセット</span></span><br><span class="line">scriptBody = ctx.scriptBody().getText();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽出した文字列を取得する</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getScriptBody</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> scriptBody;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><p>この記事に掲載したコードをGitHub上でもご確認頂けます。<br><a href="https://github.com/f-t-hiraoka/antlr-sample" target="_blank" rel="noopener">https://github.com/f-t-hiraoka/antlr-sample</a></p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>正規表現や既存のparserでは対応が難しい課題をANTLRを利用して解決しました。文字列の処理で困ったときは、選択肢の1つとして検討してみてはいかがでしょうか。</p><p>コアテクノロジーユニットでは、現在チームメンバーを募集しています。<br>私たちと一緒にテクノロジーで設計、開発、テストの高品質・高生産性を実現する仕組みづくりをしませんか？</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.antlr.org/" target="_blank" rel="noopener">ANTLR公式</a></li><li><a href="https://tomassetti.me/antlr-mega-tutorial/" target="_blank" rel="noopener">The ANTLR Mega Tutorial</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、TIG コアテクノロジーユニットの平岡です。&lt;/p&gt;
&lt;p&gt;コアテクノロジーユニットはフューチャーグループ全体の
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Java" scheme="https://future-architect.github.io/tags/Java/"/>
    
      <category term="Vue.js" scheme="https://future-architect.github.io/tags/Vue-js/"/>
    
      <category term="ANTLR4" scheme="https://future-architect.github.io/tags/ANTLR4/"/>
    
      <category term="構文解析" scheme="https://future-architect.github.io/tags/%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>GCP Professional Cloud Network Engineer に合格しました</title>
    <link href="https://future-architect.github.io/articles/20200902/"/>
    <id>https://future-architect.github.io/articles/20200902/</id>
    <published>2020-09-01T15:00:00.000Z</published>
    <updated>2020-09-02T00:29:58.125Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>今回、GCP の <code>Professional Cloud Network Engineer</code> という資格に合格したので、その際の体験を記載しておきます。</p><img src="/images/20200902/1_zRKo4d8TLjscKiHqgk6u5w.png" class="img-small-size"><p>Cloud Architect の資格の体験記は<a href="https://future-architect.github.io/articles/20190530/">こちら</a></p><h1 id="Professional-Cloud-Network-Engineer-とは？"><a href="#Professional-Cloud-Network-Engineer-とは？" class="headerlink" title="Professional Cloud Network Engineer とは？"></a>Professional Cloud Network Engineer とは？</h1><p>そもそも何の資格なのか、簡単に特性を記載しておきます。<br>公式サイトは<a href="https://cloud.google.com/certification/cloud-network-engineer" target="_blank" rel="noopener">こちら</a>。</p><ul><li>GCP のネットワークの知識を問う資格</li><li>英語のみ</li><li>日本人の取得者は記事の数からそこまで多くないと想定されます。</li></ul><h1 id="筆者の前提知識"><a href="#筆者の前提知識" class="headerlink" title="筆者の前提知識"></a>筆者の前提知識</h1><p>おそらく自分はかなり前提知識がある状態でのスタートでした。簡単に書くと以下です。</p><ul><li>実務経験<ul><li>前職で5年ほど、オンプレのネットワーク構築や技術検証をしていました。<ul><li>パラメータは製品によってまちまちなので、そらでは言えないですが、設計は問題なくこなせるレベル</li></ul></li><li>現職では、GCP上でのアーキテクチャ設計などをネットワークの観点含めて実施しています。</li></ul></li><li>保有資格<ul><li>IPA ネットワークスペシャリスト</li><li>GCP <code>Professional Cloud Architect</code></li><li>AWS <code>Solutions Architect Associate</code></li></ul></li><li>語学<ul><li>海外旅行程度なら困らないくらい。</li></ul></li></ul><h1 id="出た問題"><a href="#出た問題" class="headerlink" title="出た問題"></a>出た問題</h1><p>多かった順に書いていきます。</p><h5 id="オンプレとの接続をどうするのが良いか？"><a href="#オンプレとの接続をどうするのが良いか？" class="headerlink" title="オンプレとの接続をどうするのが良いか？"></a>オンプレとの接続をどうするのが良いか？</h5><ul><li>Interconnect/VPN などの接続方法で適しているのはどれか？</li><li>Routing テーブルの交換<ul><li>特に BGP に対応していない場合ですね。<ul><li>ポリシーベースとルートベースが選択できますが、どういう時にどっちを使うのか？</li></ul></li></ul></li></ul><h5 id="GKE-Native-Cluster-を作る場合"><a href="#GKE-Native-Cluster-を作る場合" class="headerlink" title="GKE Native Cluster を作る場合"></a>GKE Native Cluster を作る場合</h5><ul><li>Native Cluster を作る際の CIDR 設計</li><li>Private Native Cluster の作成方法</li></ul><h5 id="GCP-のサービスをプライベートで接続する際のオプションは？"><a href="#GCP-のサービスをプライベートで接続する際のオプションは？" class="headerlink" title="GCP のサービスをプライベートで接続する際のオプションは？"></a>GCP のサービスをプライベートで接続する際のオプションは？</h5><ul><li>GCP 内の VPC から Bigquery, GCS にプライベートに接続したい場合は、どうすればよいか？<ul><li>要するに<a href="https://cloud.google.com/vpc/docs/configure-private-google-access" target="_blank" rel="noopener">こちら</a></li></ul></li><li>GCP 内の VPC から Cloud SQL にプライベートに接続したい場合は、どうすればよいのか？<ul><li>要するに<a href="https://cloud.google.com/vpc/docs/configure-private-services-access" target="_blank" rel="noopener">こちら</a></li></ul></li><li>オンプレミスのサーバから、BigQuery, GCS にイントラネット経由で通信するためには？<ul><li>要するに<a href="https://cloud.google.com/vpc/docs/configure-private-google-access-hybrid" target="_blank" rel="noopener">こちら</a></li></ul></li><li>これらを押さえておけば、大丈夫でしょう。実際の現場的には、最初の選択肢が主流とは思います。Cloud SQL のプライベート接続は、Firewallを書けないため、逆に脆弱だとすら思います。<ul><li><a href="https://future-architect.github.io/articles/20190820/">こちらの記事</a> の <code>2-2</code> で詳しく触れられています。</li></ul></li></ul><h5 id="セキュリティアプライアンスがある場合のルーティング"><a href="#セキュリティアプライアンスがある場合のルーティング" class="headerlink" title="セキュリティアプライアンスがある場合のルーティング"></a>セキュリティアプライアンスがある場合のルーティング</h5><ul><li>通常はセキュリティアプライアンスに向けて、特定の宛先だけをダイレクトに通信させたい場合はどうするか？</li><li>逆に、通常はDefault Internet Gateway に向けて、特定の通信だけをセキュリティアプライアンスに向けたい場合はどうするか？</li></ul><h5 id="CDN関連"><a href="#CDN関連" class="headerlink" title="CDN関連"></a>CDN関連</h5><ul><li>GCS Bucket を CDN で使いたい場合はどんな設定をすればよいか？</li></ul><h5 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a>Load Balancer</h5><ul><li>予想よりも Network Load Balancer が多かった気がします。<ul><li>インターネット経由で VOIP の通信を行うためには、どれが適切か？<ul><li>基本、音声系は NAT 超えが出来ないので（RTP内にもsrc IP/dst IP情報を持っているから、IP層だけ書き換えると通話が不可能になる）</li></ul></li></ul></li><li>GCEで提供されているサービスをカナリーリリースするためにはどうするか？</li></ul><h5 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h5><ul><li>deny のログを残したい場合はどうするか？</li></ul><h5 id="Cloud-Armor"><a href="#Cloud-Armor" class="headerlink" title="Cloud Armor"></a>Cloud Armor</h5><ul><li>Global LBで展開しているサービスがあり、特定の通信元からだけ入る様にする場合は、どう構成するか？</li></ul><h5 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h5><ul><li>通信が出来なくなった関連のトラシュー問題</li><li>TCP Connection は 3Gbps が上限だが、そこまで出すためにはTCPのフロー制御に関連するパラメータを設定する必要がある。</li></ul><h1 id="何を勉強したか？"><a href="#何を勉強したか？" class="headerlink" title="何を勉強したか？"></a>何を勉強したか？</h1><p>勉強した教材は以下です。</p><ul><li>qwiklabs<ul><li><a href="https://www.qwiklabs.com/quests/46" target="_blank" rel="noopener">https://www.qwiklabs.com/quests/46</a></li></ul></li><li>業務<ul><li>GKE Native Cluster</li><li>VPN 全般</li><li>SharedVPC</li><li>VPC Service Controls + Restricted API</li><li>HTTP(s) LB + (GKE)NEG</li></ul></li><li>模擬試験<ul><li><a href="https://googlecloud.4watcher365.dev/practice-exam/en-professional-cloud-network-engineer-exam-v20200227/" target="_blank" rel="noopener">https://googlecloud.4watcher365.dev/practice-exam/en-professional-cloud-network-engineer-exam-v20200227/</a></li><li><a href="https://www.testpreptraining.com/google-professional-cloud-network-engineer-gcp-free-practice-test" target="_blank" rel="noopener">https://www.testpreptraining.com/google-professional-cloud-network-engineer-gcp-free-practice-test</a></li><li>後は正規の模擬試験のみ</li></ul></li><li>参考にしたサイト<ul><li><a href="https://googlecloud.4watcher365.dev/google-cloud/professional-cloud-network-engineer_info/" target="_blank" rel="noopener">https://googlecloud.4watcher365.dev/google-cloud/professional-cloud-network-engineer_info/</a></li></ul></li></ul><h1 id="どれくらいの期間勉強したか？"><a href="#どれくらいの期間勉強したか？" class="headerlink" title="どれくらいの期間勉強したか？"></a>どれくらいの期間勉強したか？</h1><ul><li>6月<ul><li>6月頭に <code>Professional Cloud Architect</code> に合格</li><li>そのまま、<code>Network Engineer</code> の正規の模擬試験を受ける<ul><li>この段階で 7割程度</li></ul></li><li>6月は Qwiklabs を受講していた<ul><li><a href="https://www.qwiklabs.com/quests/46" target="_blank" rel="noopener">https://www.qwiklabs.com/quests/46</a></li></ul></li></ul></li><li>7月<ul><li>前半は上記の模擬試験を解く。</li><li>後半はさぼる。</li></ul></li><li>8月<ul><li>前半に復習。</li><li>8/19 に合格</li></ul></li></ul><h1 id="体感的な正答率"><a href="#体感的な正答率" class="headerlink" title="体感的な正答率"></a>体感的な正答率</h1><ul><li>おそらく、9割くらいは行けたと思います。<ul><li>確実に合ってると自信があったのが8割。</li><li>2択まで絞れているのが2割。（これも選択した理由を答えられるレベルには自信があります）</li><li>全くわからないのは 0 でした。</li></ul></li><li>個人的には、<code>Cloud Architect</code> の方が難しかったです。体感的な正答率も、<code>Cloud Architect</code> は『8割程度かな』くらいでした。</li></ul><h1 id="その他-1"><a href="#その他-1" class="headerlink" title="その他"></a>その他</h1><ul><li>でも英語は読むのはちょっと大変なので、実は15問/50問くらいのところでもうやめたくなりました。</li><li>時間配分的には、1:20 くらいで全部解いて、30分くらいで全部見直し、10分余る、くらいでした。<ul><li>この所要時間は、<code>Cloud Architect</code> と同じくらいでした。（言語による違いは実際はありませんでした）</li></ul></li></ul><h1 id="合格後の特典"><a href="#合格後の特典" class="headerlink" title="合格後の特典"></a>合格後の特典</h1><p>やはりありました。<code>Cloud Architect</code> とは別なんですね。<br><img src="/images/20200902/2020-08-22_220718.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;今回、GCP の &lt;code&gt;Professional Cloud Network Engineer&lt;/code&gt; という資
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Network" scheme="https://future-architect.github.io/tags/Network/"/>
    
      <category term="GCP" scheme="https://future-architect.github.io/tags/GCP/"/>
    
      <category term="合格記" scheme="https://future-architect.github.io/tags/%E5%90%88%E6%A0%BC%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>Vue.jsで最速に始めるCheetah Grid</title>
    <link href="https://future-architect.github.io/articles/20200901/"/>
    <id>https://future-architect.github.io/articles/20200901/</id>
    <published>2020-08-31T15:00:00.000Z</published>
    <updated>2020-09-02T00:21:38.974Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200901/top.png" class="img-middle-size"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>2019年入社、TIG所属の吉野貴大です。</p><p>今回、記事を投稿することになったキッカケは、フューチャー発のOSSであるCheetah Gridを使用した業務システム開発に携わったことです。</p><p>また、Cheetah Gridの<a href="https://future-architect.github.io/cheetah-grid/documents/">公式ドキュメント</a>は英語のみで、現時点では日本語の解説記事が少ないこともあり、業務システム開発で使いやすいと思われるCheetah Gridの機能を紹介していきます。</p><h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1><p>Cheetah Gridの入門として、業務システム開発で利用する際のCheetah Gridについて、各コンポーネントの概要と簡単な使い方を実装付きで説明します。</p><ul><li>細かいコンポーネントの属性や高度なコンポーネント（c-grid-layout-rowとc-grid-header）については説明しません</li><li>Cheetah GridのAPIにはJavaScript版とVue.js版がありますが、Vue.jsのみについて説明します</li></ul><h1 id="Cheetah-Gridとは"><a href="#Cheetah-Gridとは" class="headerlink" title="Cheetah Gridとは"></a>Cheetah Gridとは</h1><p>Cheetah Gridは、扱うデータ件数が多くても高速にテーブル描画ができるJavaScriptのコンポーネントで、1,000,000件のデータを約0.1秒で描画することができます。対応言語はJavaScriptでVue.jsとしても利用することができます。</p><p><a href="https://future-architect.github.io/cheetah-grid/">デモページ</a>でその表示速度を体験することができます。</p><p>業務システムでCheetah Gridを使用するメリットを紹介します。</p><ol><li>大量データでも高速に描画することができる<ul><li>参考: （<a href="https://qiita.com/ota-meshi/items/a2b68e132fa7c5a32c3d" target="_blank" rel="noopener">【JavaScript】最速のOSS Data Table/Grid/SpreadSheetを探して、</a>）</li></ul></li><li>業務部品がコンポーネント化してあるため、同じような処理が多い業務処理を開発する際に、実装方法を統一することができる<ul><li>次の章で詳しく説明します</li></ul></li></ol><h1 id="Cheetah-Gridのコンポーネントについて"><a href="#Cheetah-Gridのコンポーネントについて" class="headerlink" title="Cheetah Gridのコンポーネントについて"></a>Cheetah Gridのコンポーネントについて</h1><p>Cheetah Gridが提供しているコンポーネントを利用することで、大量のデータの参照、登録、更新、削除の手助けをすることができます。</p><p>既存のグリッドを表現する方法としてHTMLのtableがあります。tableは、グリッドを表現する際に<code>tr</code>タグや<code>th</code>タグ、<code>td</code>タグを使用しなければならず階層が多くなり複雑な構成になってしまいます。また、業務システムで頻繁に要求される行のセルに入力項目を作る部品や、行データの中から1つ選択する部品を表現する際には、どちらも異なる処理なのにもかかわらず<code>input</code>タグを使用して表現します。加えて、<code>input</code>タグには最低限の入力やチェック機能しか備わっていません（他の処理はDOMを使用する）。</p><p>それに比べてCheetah Gridでは、業務システムに要求される部品を1つのコンポーネントで指定することができることで、可読性が良く、また、1つのコンポーネントで多くの属性が備わっているため、様々な処理を行うことができます。</p><p>本記事では、Vue.jsで利用できるCheetah Gridのコンポーネントについて紹介と、実装例を説明します。</p><h2 id="利用可能なVueコンポーネント"><a href="#利用可能なVueコンポーネント" class="headerlink" title="利用可能なVueコンポーネント"></a>利用可能なVueコンポーネント</h2><table><thead><tr><th align="left">コンポーネント名</th><th align="left">概要</th></tr></thead><tbody><tr><td align="left"><a href="#c-grid">c-grid</a></td><td align="left">Gridを定義する</td></tr><tr><td align="left"><a href="#c-grid-column">c-grid-column</a></td><td align="left">カラムの値を表示する</td></tr><tr><td align="left"><a href="#c-grid-column-group">c-grid-column-group</a></td><td align="left">定義したカラムをヘッダーをグループ化する</td></tr><tr><td align="left"><a href="#c-grid-button-column">c-grid-button-column</a></td><td align="left">ボタンを表示する</td></tr><tr><td align="left"><a href="#c-grid-check-column">c-grid-check-column</a></td><td align="left">チェックボックスを表示する</td></tr><tr><td align="left"><a href="#c-grid-input-column">c-grid-input-column</a></td><td align="left">入力項目を表示する</td></tr><tr><td align="left"><a href="#c-grid-menu-column">c-grid-menu-column</a></td><td align="left">プルダウンメニューを表示する</td></tr><tr><td align="left"><a href="#c-grid-link-column">c-grid-link-column</a></td><td align="left">リンクを表示する</td></tr><tr><td align="left"><a href="#c-grid-icon-column">c-grid-icon-column</a></td><td align="left">アイコンを表示する</td></tr><tr><td align="left"><a href="#c-grid-percent-complete-bar-column">c-grid-percent-complete-bar-column</a></td><td align="left">割合を色で表現して表示する</td></tr><tr><td align="left"><a href="#c-grid-radio-column">c-grid-radio-column</a></td><td align="left">ラジオボタンを表示する</td></tr><tr><td align="left">c-grid-layout-row</td><td align="left">複雑なレイアウトを作成する</td></tr><tr><td align="left">c-grid-header</td><td align="left">複雑なヘッダー構成などを作成する時に使用する</td></tr></tbody></table><p>コンポーネントを使用して実際に作成した画面がこちらです。<br><img src="/images/20200901/gamen.gif" alt=""><br>今回作成した一覧のカラム名は、「ID」、「選択」、「削除」、「データ（データ１、データ２）」「種別」、「詳細」、「割合」、「アイコン」としています。</p><h1 id="コード実装例"><a href="#コード実装例" class="headerlink" title="コード実装例"></a>コード実装例</h1><h3 id="開発環境"><a href="#開発環境" class="headerlink" title="開発環境"></a>開発環境</h3><ul><li>Node.js(v14.4.0)</li><li>npm(6.14.5)</li><li>Nuxt.js(v2.13.3)</li><li>Cheetah Grid(0.22.3)</li><li>npmでCheetah Gridを使用するには、下記のコマンドを実行してください。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -S cheetah-grid</span><br></pre></td></tr></table></figure><h3 id="全体のソースコード"><a href="#全体のソースコード" class="headerlink" title="全体のソースコード"></a>全体のソースコード</h3><p>はじめに全体のソースコードを記載します。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"height: 500px; border: solid 1px #ddd; margin: 50px"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">c-grid</span> <span class="attr">:data</span>=<span class="string">"records"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">:frozen-col-count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-column</span> <span class="attr">field</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">width</span>= <span class="string">"50"</span>&gt;</span></span><br><span class="line">          ID</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-radio-column</span> <span class="attr">field</span>=<span class="string">"selected"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">width</span>=<span class="string">"50"</span>&gt;</span></span><br><span class="line">          選択</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-radio-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-button-column</span> <span class="attr">caption</span>=<span class="string">"削除"</span></span></span><br><span class="line"><span class="tag">                              <span class="attr">width</span>=<span class="string">"50"</span></span></span><br><span class="line"><span class="tag">                              @<span class="attr">click</span>=<span class="string">"onDeleted"</span>&gt;</span></span><br><span class="line">          削除</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-button-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-check-column</span> <span class="attr">field</span>=<span class="string">"checked"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">width</span>=<span class="string">"70"</span>&gt;</span></span><br><span class="line">          フラグ</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-check-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-column-group</span> <span class="attr">caption</span>=<span class="string">"データ"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data1"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">width</span>=<span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">            データ1</span><br><span class="line">          <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data2"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">width</span>= <span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">            データ2</span><br><span class="line">          <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-column-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-menu-column</span> <span class="attr">field</span>=<span class="string">"type"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">:options</span>=<span class="string">"[&#123;label: '種別1', value: 1&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                                       &#123;label: '種別2', value: 2&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                                       &#123;label: '種別3', value: 3&#125;]"</span>&gt;</span></span><br><span class="line">                種別</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-menu-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-link-column</span> <span class="attr">href</span>=<span class="string">"link"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">:icon</span>=<span class="string">"getLinkIcon"</span>&gt;</span></span><br><span class="line">                詳細</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-link-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-percent-complete-bar-column</span> <span class="attr">field</span>=<span class="string">"percent"</span></span></span><br><span class="line"><span class="tag">                                            <span class="attr">:max</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">                                            <span class="attr">:min</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                割合</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-percent-complete-bar-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-icon-column</span> <span class="attr">field</span>=<span class="string">"iconNum"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">icon-class-name</span>=<span class="string">"material-icons"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">icon-content</span>=<span class="string">"grade"</span>&gt;</span></span><br><span class="line">                アイコン</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-icon-column</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">c-grid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"grid-sample"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> * <span class="keyword">as</span> cGridAll <span class="keyword">from</span> <span class="string">'vue-cheetah-grid'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">'service'</span>,</span></span><br><span class="line">    components: &#123;</span><br><span class="line">        ...cGridAll</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted() &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.setRecord()</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data () &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line">            records: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        /**</span><br><span class="line">         * 削除ボタン押下イベント</span><br><span class="line">         *</span><br><span class="line">         * @param &#123;object&#125; rec 行データ</span><br><span class="line"><span class="actionscript">         * @<span class="keyword">return</span> &#123;<span class="keyword">void</span>&#125;</span></span><br><span class="line">         **/</span><br><span class="line">        onDeleted(rec) &#123; </span><br><span class="line"><span class="actionscript">            <span class="keyword">const</span> vm = <span class="keyword">this</span></span></span><br><span class="line">            vm.records.splice(vm.records.indexOf(rec), 1);</span><br><span class="line">        &#125;,</span><br><span class="line">        /**</span><br><span class="line">         * 一覧に表示するデータを作成する</span><br><span class="line">         *</span><br><span class="line"><span class="actionscript">         * @<span class="keyword">return</span> &#123;<span class="keyword">void</span>&#125;</span></span><br><span class="line">         **/</span><br><span class="line">        setRecord () &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">const</span> vm = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span></span><br><span class="line">                vm.records.push(&#123;</span><br><span class="line"><span class="actionscript">                    selected: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">                    checked: <span class="literal">false</span>,</span></span><br><span class="line">                    id: i+1,</span><br><span class="line"><span class="javascript">                    data1: <span class="string">`サンプル1-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span></span><br><span class="line"><span class="javascript">                    data2: <span class="string">`サンプル2-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span></span><br><span class="line"><span class="javascript">                    type: <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">3</span>) + <span class="number">1</span>,</span></span><br><span class="line"><span class="actionscript">                    link: <span class="string">"https://future-architect.github.io/cheetah-grid/documents/api/vue/components/CGridLinkColumn.html"</span>,</span></span><br><span class="line">                    iconNum: 1,</span><br><span class="line"><span class="javascript">                    percent: <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">100</span>)</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        /**</span><br><span class="line">         * c-grid-link-columnに表示するアイコンを取得する</span><br><span class="line">         *</span><br><span class="line"><span class="actionscript">         * @<span class="keyword">return</span> &#123;object&#125; アイコン情報</span></span><br><span class="line">         **/</span><br><span class="line">        getLinkIcon () &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">                className: <span class="string">'material-icons'</span>,</span></span><br><span class="line"><span class="actionscript">                content: <span class="string">'input'</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid"><a href="#c-grid" class="headerlink" title="c-grid"></a>c-grid</h3><p>c-gridは、Cheetah Gridを使用するための土台となるコンポーネントです。<br><code>data</code>属性に一覧に表示したいリストデータを指定し、リストの各要素は列に表示するデータを保持するオブジェクトです。<br><code>data</code>属性以外にも<code>frozen-col-count</code>、<code>disabled</code>や<code>readonly</code>など多くの属性があるので、グリッド全体の設定を定義することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid</span> <span class="attr">:data</span>=<span class="string">"records"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:frozen-col-count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ここでCheetah Gridの各Vueコンポーネントを使って列項目を定義する --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid</span>&gt;</span></span><br></pre></td></tr></table></figure><p>一覧に表示するデータは以下のように作成しています。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    records: []</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    setRecords () &#123;</span><br><span class="line">      <span class="keyword">const</span> vm = <span class="keyword">this</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        vm.records.push(&#123;</span><br><span class="line">          selected: <span class="literal">false</span>,</span><br><span class="line">          checked: <span class="literal">false</span>,</span><br><span class="line">          id: i+<span class="number">1</span>,</span><br><span class="line">          data1: <span class="string">`サンプル1-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span><br><span class="line">          data2: <span class="string">`サンプル2-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span><br><span class="line">          type: <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">3</span>) + <span class="number">1</span>,</span><br><span class="line">          link: <span class="string">"https://future-architect.github.io/cheetah-grid/documents/api/vue/components/CGridLinkColumn.html"</span>,</span><br><span class="line">          iconNum: <span class="number">1</span>,</span><br><span class="line">          percent: <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">100</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="c-grid-column"><a href="#c-grid-column" class="headerlink" title="c-grid-column"></a>c-grid-column</h3><p>c-grid-columnは、<code>field</code>属性にデータのプロパティ名を指定することで値を列に表示することができます。<br><code>width</code>属性で横幅の指定ができます。<br>列見出しはタグのテキスト部に書くことで表示できます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-column</span> <span class="attr">field</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">width</span>= <span class="string">"50"</span>&gt;</span></span><br><span class="line">  ID</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-column-group"><a href="#c-grid-column-group" class="headerlink" title="c-grid-column-group"></a>c-grid-column-group</h3><p>c-grid-column-groupは、カラムヘッダをまとめることができます。</p><p>「データ」というカラム内に、「データ１」と「データ２」を多段で表示しています。<code>caption</code>属性で全体のカラム名を決めます、また、今回は、c-grid-input-columnを使用していますが、それ以外のコンポーネントも配置することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-column-group</span> <span class="attr">caption</span>=<span class="string">"データ"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data1"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">width</span>=<span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ1</span><br><span class="line">  <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data2"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">width</span>= <span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ2</span><br><span class="line">  <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-column-group</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-button-column"><a href="#c-grid-button-column" class="headerlink" title="c-grid-button-column"></a>c-grid-button-column</h3><p>c-grid-button-columnは、カラム内にボタンを配置することができます。<br>業務システムでは、ボタンによって処理を制御することが度々ありますが、今回は、c-grid-button-columnを使用して削除ボタンを作成しました。<br><code>@click</code>属性で押下後の処理を定義することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-button-column</span> <span class="attr">caption</span>=<span class="string">"削除"</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">width</span>=<span class="string">"50"</span></span></span><br><span class="line"><span class="tag">                      @<span class="attr">click</span>=<span class="string">"onDeleted"</span>&gt;</span></span><br><span class="line">削除</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-button-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-check-column"><a href="#c-grid-check-column" class="headerlink" title="c-grid-check-column"></a>c-grid-check-column</h3><p>c-grid-check-columnでは、1つのチェックボックスを実現することができます。</p><p><code>field</code>に指定したプロパティにチェック状態に対応した値が設定されます。チェック値は、プロパティの初期値に応じて、設定される値が異なります。（<a href="https://future-architect.github.io/cheetah-grid/documents/api/js/column_actions/CheckEditor.html#data-editing">設定値</a>）。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-check-column</span> <span class="attr">field</span>=<span class="string">"checked"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>=<span class="string">"70"</span>&gt;</span></span><br><span class="line">  フラグ</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-check-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-input-column"><a href="#c-grid-input-column" class="headerlink" title="c-grid-input-column"></a>c-grid-input-column</h3><p>c-grid-input-columnは、「表示」、「入力」のどちらも行うことができます。一覧内のデータを直接入力できることで一覧データの登録や更新を、一括で行う画面の開発ができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data1"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>=<span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ1</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data2"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>= <span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ2</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-menu-column"><a href="#c-grid-menu-column" class="headerlink" title="c-grid-menu-column"></a>c-grid-menu-column</h3><p>c-grid-menu-columnは、<code>options</code>属性に与えられたリストから1つを選択することができます。</p><p>決まったデータ群から選択させたい場合などに使用することができ、設定するデータは<code>options</code>属性にオブジェクトのリストを指定し、<code>label</code>と<code>value</code>で表示させる文字列、データを定義することでプルダウンメニューを表示します。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-menu-column</span> <span class="attr">field</span>=<span class="string">"type"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">:options</span>=<span class="string">"[&#123;label: '種別1', value: 1&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                               &#123;label: '種別2', value: 2&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                               &#123;label: '種別3', value: 3&#125;]"</span>&gt;</span></span><br><span class="line">  種別</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-menu-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-link-column"><a href="#c-grid-link-column" class="headerlink" title="c-grid-link-column"></a>c-grid-link-column</h3><p>c-grid-link-columnは、列の値自体をリンクとすることができます。</p><p>今回は、リンクにアイコンを設定しました。<code>href</code>属性には、遷移先の情報（URL）などを設定したプロパティを指定します。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-link-column</span> <span class="attr">href</span>=<span class="string">"link"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">:icon</span>=<span class="string">"getLinkIcon"</span>&gt;</span></span><br><span class="line">  詳細</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-link-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-icon-column"><a href="#c-grid-icon-column" class="headerlink" title="c-grid-icon-column"></a>c-grid-icon-column</h3><p>c-grid-icon-columnでは、アイコンを表示することができる。</p><p>今回は、<a href="https://material.io/resources/icons/?icon=delete&style=baseline" target="_blank" rel="noopener">material-icons</a>を使用して<code>grade</code>を表示しています。<code>field</code>属性にアイコンの表示数を指定することで複数アイコンを表示することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-icon-column</span> <span class="attr">field</span>=<span class="string">"iconNum"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">icon-class-name</span>=<span class="string">"material-icons"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">icon-content</span>=<span class="string">"grade"</span>&gt;</span></span><br><span class="line">  アイコン</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-icon-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-percent-complete-bar-column"><a href="#c-grid-percent-complete-bar-column" class="headerlink" title="c-grid-percent-complete-bar-column"></a>c-grid-percent-complete-bar-column</h3><p>c-grid-percent-complete-bar-columnでは、割合を表示することができます。<code>field</code>属性に指定した数字が、<code>max</code>属性、<code>min</code>属性間でどのくらいの割合なのかを示すことができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-percent-complete-bar-column</span> <span class="attr">field</span>=<span class="string">"percent"</span></span></span><br><span class="line"><span class="tag">                                    <span class="attr">:max</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">                                    <span class="attr">:min</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">  割合</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-percent-complete-bar-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-radio-column"><a href="#c-grid-radio-column" class="headerlink" title="c-grid-radio-column"></a>c-grid-radio-column</h3><p>c-grid-radio-columnでは、ラジオボタンを表示することができます。一覧データ中から、1つを対象に選ぶ場合などで使用することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-radio-column</span> <span class="attr">field</span>=<span class="string">"selected"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>=<span class="string">"50"</span>&gt;</span></span><br><span class="line">  選択</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-radio-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="実装してみて"><a href="#実装してみて" class="headerlink" title="実装してみて"></a>実装してみて</h1><p>Cheetah Gridで一覧情報の例を実装してみて、あらかじめ処理を行ってくれる属性多く用意されており、HTMLなどと比べて業務システム開発で使用する一覧情報を実装することが容易でした。</p><p>1,000,000件のデータを表示する際にもほぼストレスなく表示することができ、ユーザに対しても満足度が高いものが作成できると考えます。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>今回は、業務で使用したCheetah Gridについて、基本的な内容を説明しました。あらかじめ用意されているコンポーネントの属性を使用して、Web画面で利用するグリッドを表現できます。</p><p>また、本記事で触れてませんが業務で役に立つ機能に「Excel貼り付け」や「一括入力」の機能があります。Excel貼り付けは業務のデータをExcelでまとめていたものをシステムに移行する際に、手入力ではなくコピペで貼り付けることができます。一括入力は大量にあるデータ1つ1つチェックをつけるのではなく、一括でチェックできる機能を実現します。</p><p>今回は、Cheetah Gridが提供している単体コンポーネントの使用方法を説明しましたが、単体で使用するのではなくいくつかのコンポーネントを組み合わせることでより柔軟なグリッドを表示することが可能です。</p><p>ぜひ、皆さん利用してみてください！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200901/top.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="Vue.js" scheme="https://future-architect.github.io/tags/Vue-js/"/>
    
      <category term="CheetahGrid" scheme="https://future-architect.github.io/tags/CheetahGrid/"/>
    
  </entry>
  
  <entry>
    <title>チームで推奨するVSCode拡張機能を共有するtips</title>
    <link href="https://future-architect.github.io/articles/20200828/"/>
    <id>https://future-architect.github.io/articles/20200828/</id>
    <published>2020-08-27T15:00:00.000Z</published>
    <updated>2020-09-01T00:58:54.677Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。<br>TIG DXユニットの市川です。</p><p>プロジェクトにアサインされて、まずやらなければならないのは環境構築だと思います。</p><p>私が新人としてプロジェクトに参画した頃は、リポジトリのクローンからローカルサーバーを起動させるまでの手順は詳細に記載されていたものの、開発で使用するエディタの説明は特になく、VSCodeに各々が好きな拡張機能をインストールしている状態でした。当時開発経験が浅かった私は開発中に必要となる拡張機能を都度入れていたり、作業を効率化できる拡張機能を入れられておらず、非常に困っていました。</p><p>そういった背景もあり、私のプロジェクトではプロジェクトで必要となる・開発を効率的に行うことができる拡張機能を選定し、それらをVSCodeに一括でインストールする環境を整えたことで、プロジェクトに参画をした新人やキャリア入社の方、インターンの方がスムーズにエディタの設定を行うことができました。</p><p>今回は、どのようにプロジェクト推奨の拡張機能を設定するのか、新規参画者がどのように拡張機能を導入するかについてご説明します。</p><h1 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h1><p>まず、どのようにプロジェクト推奨の拡張機能を設定するかについてご説明します。</p><h2 id="vscode-extensions-jsonの作成"><a href="#vscode-extensions-jsonの作成" class="headerlink" title=".vscode/extensions.jsonの作成"></a>.vscode/extensions.jsonの作成</h2><p>まず、VSCodeを起動してインストールを推奨したい拡張機能のページにアクセスします。（今回はESLintを例に説明します。）</p><p><img src="/images/20200828/image.png" alt=""></p><p>そのあと、下記画像のようにコマンドパレットを開き、<code>Extensions: Add to Recommended Extensions (Workspace Folder)</code> を選択します。</p><p><img src="/images/20200828/image_2.png" alt=""></p><p>すると、<code>.vscode/extensions.json</code> が新規作成され、ESLintの拡張機能が<code>recommendations</code> に追加されていることがわかります。<br>また、<code>unwantedRecommendations</code> の項目も作成されてしますが、こちらはプロジェクトで推奨しない拡張機能を指定することが可能です。</p><p><img src="/images/20200828/image_3.png" alt=""></p><p>この手順を繰り返し、プロジェクトに必要な拡張機能を<code>recommendations</code> に追加していきます。</p><h2 id="新規参画者の手順"><a href="#新規参画者の手順" class="headerlink" title="新規参画者の手順"></a>新規参画者の手順</h2><p>次に新規参画者が拡張機能をインストールする手順を記載します。</p><p>VSCode起動後、まず ctrl + O (Macの方は⌘ + O) を押下して、対象のアプリケーションを選択し、ディレクトリを開きます。<br>下記の順で操作することで、推奨する拡張機能の候補が表示されます。</p><p><img src="/images/20200828/recommended.png" alt=""></p><p>下記画像の④のマーククリックし、拡張機能をインストールしてください。<br>もしVSCodeの使用に慣れており、独自で拡張機能を導入している場合は、下記に記載している拡張機能の概要を確認し、必要なものは緑色のinstallをクリックすることで、個別にインストールすることも可能です。</p><img src="/images/20200828/extension_install.png" class="img-middle-size"><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>今回は拡張機能に絞って説明しましたが、VSCodeでは様々な設定をjson形式でチームに共有することが可能です。<br>チームで設定を共有し、開発効率を高めていきましょう！</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://code.visualstudio.com/docs/editor/extension-gallery#_workspace-recommended-extensions" target="_blank" rel="noopener">Extension Marketplace - Workspace recommended extensions</a></li><li><a href="https://future-architect.github.io/articles/20200707/">VSCode の Go extension でよく利用するコマンド 7選</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。&lt;br&gt;TIG DXユニットの市川です。&lt;/p&gt;
&lt;p&gt;プロジェクトにアサインされて、まずやらなければならないのは環境構築だと思います。&lt;/p&gt;
&lt;p&gt;私が新人としてプロジェクトに参画した頃は、リポジトリのクローンからローカルサーバーを起動させるまでの手順は詳細
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="VSCode" scheme="https://future-architect.github.io/tags/VSCode/"/>
    
      <category term="チーム開発" scheme="https://future-architect.github.io/tags/%E3%83%81%E3%83%BC%E3%83%A0%E9%96%8B%E7%99%BA/"/>
    
  </entry>
  
  <entry>
    <title>Airflow の SLA設定方法</title>
    <link href="https://future-architect.github.io/articles/20200827/"/>
    <id>https://future-architect.github.io/articles/20200827/</id>
    <published>2020-08-26T15:00:00.000Z</published>
    <updated>2020-08-27T01:14:14.203Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200827/feature-image.png" class="img-middle-size"><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>TIG DXチームの多賀です。Airflowの SLA 設定方法を紹介します。</p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>sla_miss_callback 関数は以下の引数が必要</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla_alert</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    dag: DAG,</span></span></span><br><span class="line"><span class="function"><span class="params">    task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    slas: List[SlaMiss],</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_tis: List[TaskInstance]</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br></pre></td></tr></table></figure><h2 id="SLA設定"><a href="#SLA設定" class="headerlink" title="SLA設定"></a>SLA設定</h2><p>SLA とは Service Level Agreement の略で、サービス提供者が保証する品質を明示する際に利用されます。当 Airflow の SLA は、各 Task が指定の時間内に終わることを保証する形で定義されます。</p><p>そのため、Airflow は 各 Task に対して SLA 値(時間) を設定できます。</p><p><a href="https://airflow.apache.org/docs/stable/concepts.html#slas" target="_blank" rel="noopener">Concepts-SLAs</a></p><p>SLA 値は以下のように Task に対して定義します。10秒以上 Task が実行されると SLA 違反となります。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t1 = PythonOperator(</span><br><span class="line">    task_id=<span class="string">'sla_test'</span>,</span><br><span class="line">    python_callable=example_call,</span><br><span class="line">    sla=timedelta(seconds=<span class="number">10</span>), <span class="comment"># SLA 設定</span></span><br><span class="line">    dag=dag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>SLA 違反をした Task が発生した場合、以下2パターンで通知をすることができます</p><ul><li>Email</li><li>sla_miss_callback (Function) の任意実装</li></ul><p>注意点として、SLA 違反のチェックタイミングは、対象タスクの実行完了後ではなく、対象タスクの次のタスクの実行前(別 run_id の可能性もあり) になります。</p><p>Task 実行時に、過去の SLA 違反の一覧 (sla_miss テーブル) を取得して通知する仕組みになっています。</p><p>また、Task が実行されているいないに関わらず、 start_time と schedule_interval と 現在時刻から 実行されているべき Task を洗い出してエラー通知します。過去分の再実行等を実施すると、現在時刻まで実行されているべき Task まとめて SLA 違反が出たりします。</p><h3 id="Email-設定方法"><a href="#Email-設定方法" class="headerlink" title="Email 設定方法"></a>Email 設定方法</h3><p>ドキュメントと実装を読む限り、Operator の引数に渡す必要がありそうでした。<br>email が設定されていない場合は、エラーになることなく Task の実行が完了します。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t1 = PythonOperator(</span><br><span class="line">    task_id=<span class="string">'sla_test'</span>,</span><br><span class="line">    python_callable=example_call,</span><br><span class="line">    sla=timedelta(seconds=<span class="number">10</span>),</span><br><span class="line">    email=<span class="string">"xxx.yyy@example.com"</span>,</span><br><span class="line">    dag=dag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="sla-miss-callback-設定方法"><a href="#sla-miss-callback-設定方法" class="headerlink" title="sla_miss_callback 設定方法"></a>sla_miss_callback 設定方法</h3><p>ドキュメント上は、関数を設定と記載されてますが、以下のように設定しても動きません。</p><p><a href="https://airflow.readthedocs.io/en/1.10.11/_api/airflow/models/dag/index.html#airflow.models.dag.DAG" target="_blank" rel="noopener">https://airflow.readthedocs.io/en/1.10.11/_api/airflow/models/dag/index.html#airflow.models.dag.DAG</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla_alert</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># alert 設定</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_call</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># task 処理</span></span><br><span class="line"></span><br><span class="line">dag = DAG(</span><br><span class="line">    dag_id,</span><br><span class="line">    start_date=datetime(<span class="number">2020</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">0</span>),</span><br><span class="line">    schedule_interval=timedelta(days=<span class="number">1</span>),</span><br><span class="line">    sla_miss_callback=sla_alert,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">t1 = PythonOperator(</span><br><span class="line">    task_id=<span class="string">'sla_test'</span>,</span><br><span class="line">    python_callable=example_call,</span><br><span class="line">    sla=timedelta(seconds=<span class="number">10</span>),</span><br><span class="line">    dag=dag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Scheduelr のログを見ると以下がはかれています。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[2020-08-11 18:27:00,766] &#123;&#123;scheduler_job.py:541&#125;&#125; ERROR - Could not call sla_miss_callback <span class="keyword">for</span> DAG example_sla</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/Users/xxx/.venv/lib/python3.7/site-packages/airflow/jobs/scheduler_job.py"</span>, line 537, <span class="keyword">in</span> manage_slas</span><br><span class="line">    blocking_tis)</span><br><span class="line">TypeError: sla_alert() takes 0 positional arguments but 5 were given</span><br></pre></td></tr></table></figure><h4 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h4><p>ソースコードを grep してみると 以下の実装を見つけました。<br>引数が必要みたいですね。</p><p><a href="https://github.com/apache/airflow/blob/master/airflow/jobs/scheduler_job.py#L455" target="_blank" rel="noopener">https://github.com/apache/airflow/blob/master/airflow/jobs/scheduler_job.py#L455</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># schduler_job.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> dag.sla_miss_callback:</span><br><span class="line">    <span class="comment"># Execute the alert callback</span></span><br><span class="line">    self.log.info(<span class="string">' --------------&gt; ABOUT TO CALL SLA MISS CALL BACK '</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dag.sla_miss_callback(dag, task_list, blocking_task_list, slas,</span><br><span class="line">                                blocking_tis)</span><br><span class="line">        notification_sent = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception:  <span class="comment"># pylint: disable=broad-except</span></span><br><span class="line">        self.log.exception(<span class="string">"Could not call sla_miss_callback for DAG %s"</span>,</span><br><span class="line">                            dag.dag_id)</span><br></pre></td></tr></table></figure><p>DAG の設定を修正してみると、無事に動きました。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla_alert</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    dag: DAG,</span></span></span><br><span class="line"><span class="function"><span class="params">    task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    slas: List[SlaMiss],</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_tis: List[TaskInstance]</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    dag_id = dag.dag_id</span><br><span class="line">    task_id = slas[<span class="number">0</span>].task_id</span><br><span class="line">    execution_date = <span class="string">"&#123;&#125;"</span>.format(slas[<span class="number">0</span>].execution_date) <span class="comment"># UtcDateTime 型のため</span></span><br></pre></td></tr></table></figure><h4 id="sla-miss-callback-の引数"><a href="#sla-miss-callback-の引数" class="headerlink" title="sla_miss_callback の引数"></a>sla_miss_callback の引数</h4><table><thead><tr><th align="left">引数</th><th align="left">型</th><th align="left">値</th></tr></thead><tbody><tr><td align="left">dag</td><td align="left">airflow.DAG</td><td align="left">DAG オブジェクト dag.dag_id で ID取得可能</td></tr><tr><td align="left">task_list</td><td align="left">str</td><td align="left">過去のSLA エラーの Task の List <br> 以下フォーマットの文字列リスト <br> <code>${task_id} on ${execution_date}</code></td></tr><tr><td align="left">blocking_task_list</td><td align="left">str</td><td align="left">過去の失敗した Task の List <br> 以下フォーマットの文字列リスト <br> <code>${task_id} on ${execution_date}</code></td></tr><tr><td align="left">slas</td><td align="left">List[airflow.models.SlaMiss]</td><td align="left">過去のSLA エラーオブジェクトの List</td></tr><tr><td align="left">blocking_tis</td><td align="left">List[airflow.models.TaskInstance]</td><td align="left">失敗した TaskInstance の List</td></tr></tbody></table><p>SlaMiss<br><a href="https://airflow.apache.org/docs/stable/_api/airflow/models/slamiss/index.html" target="_blank" rel="noopener">https://airflow.apache.org/docs/stable/_api/airflow/models/slamiss/index.html</a></p><p>TaskInstance<br><a href="https://airflow.apache.org/docs/stable/_api/airflow/models/taskinstance/index.html" target="_blank" rel="noopener">https://airflow.apache.org/docs/stable/_api/airflow/models/taskinstance/index.html</a></p><h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>ドキュメントに記載してほしいところでしたが、見つけられなかったため別途整理しました。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200827/feature-image.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;h2 id=&quot;概要&quot;&gt;&lt;a href=&quot;#概要&quot; class=&quot;headerlink&quot; title=&quot;概要&quot;&gt;&lt;/a&gt;概要&lt;/h2&gt;&lt;
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Python" scheme="https://future-architect.github.io/tags/Python/"/>
    
      <category term="Airflow" scheme="https://future-architect.github.io/tags/Airflow/"/>
    
  </entry>
  
  <entry>
    <title>go-swaggerでhello world</title>
    <link href="https://future-architect.github.io/articles/20200824/"/>
    <id>https://future-architect.github.io/articles/20200824/</id>
    <published>2020-08-23T15:00:00.000Z</published>
    <updated>2020-08-24T00:19:19.445Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200824/top.png" class="img-small-size"><p>The Gopher character is based on the Go mascot designed by <a href="http://reneefrench.blogspot.com/" target="_blank" rel="noopener">Renée French</a>.</p><p>TIG DXチームの伊藤真彦です。<br>今回はgo-swaggerの具体的な実装方法を紹介します。</p><h1 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h1><ul><li>はじめに</li><li>go-swaggerのインストール</li><li>swagger.yamlを準備する</li><li>ソースコードをビルドする</li><li>試しにサーバーを立ち上げてみる</li><li>ハンドラを実装する</li><li>ついにhello world完了</li></ul><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>最近の私のメイン業務は<a href="https://github.com/go-swagger/go-swagger" target="_blank" rel="noopener">go-swagger</a>を用いたAPI開発です。<br>go-swaggerはOpenAPI(Swagger) からGoのコードを生成するライブラリです。<br>フューチャーでは複数案件での採用実績があり、この技術ブログでも<a href="https://future-architect.github.io/tags/go-swagger/">様々な記事</a>が書かれています。</p><p>しかし、技術選定としての参考情報やtips集はあるものの、どのように実装していけばAPIが動くのかを理解するドキュメントは少なく、いざ実装となると学習コストがかかってしまいます。<br>そこで、今回はストーリーベースでの実装手順を説明します。</p><h1 id="go-swaggerのインストール"><a href="#go-swaggerのインストール" class="headerlink" title="go-swaggerのインストール"></a>go-swaggerのインストール</h1><p>go-swaggerは開発環境にインストールして使用します。<br>下記コマンドでインストールできます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/go-swagger/go-swagger/cmd/swagger</span><br></pre></td></tr></table></figure><p>その他にも様々なインストール方法があります。</p><ul><li>brew、apt、wget等のコマンドを経由してインストール</li><li>ソースコード、バイナリファイルのダウンロード</li><li>go installコマンドを経由したインストール</li><li>dockerコンテナとしての実行</li></ul><p>Dockerコンテナ以外は概ね開発環境のOSによる入手経路の違い程度の認識で差し支えないと思います。詳しくは<a href="https://goswagger.io/install.html" target="_blank" rel="noopener">Installing</a>を確認してください。</p><p><a href="https://github.com/go-swagger/go-swagger/releases/tag/v0.25.0" target="_blank" rel="noopener">リリースページ</a>からお使いのOSに応じた実行ファイルをダウンロードしてインストールすることも可能です。</p><p>アプリケーションをコンテナイメージの上で実行する場合、公式のコンテナイメージを<a href="https://matsuand.github.io/docs.docker.jp.onthefly/develop/develop-images/multistage-build/" target="_blank" rel="noopener">マルチステージビルド</a>に用いる事も可能ですね、夢が広がります。<br>方法は様々ですが、インストール後にswaggerコマンドが利用可能になります。(コンテナ形式での導入を除く)</p><h1 id="swagger-yamlを準備する"><a href="#swagger-yamlを準備する" class="headerlink" title="swagger.yamlを準備する"></a>swagger.yamlを準備する</h1><p>OpenAPIの仕様に従ってアプリケーションが生成される以上、まずはAPIの仕様を定義するファイルが無いと始まりません。<br>まずは<code>swagger.yaml</code>を作成します。</p><p><code>swagger.yaml</code>の書き方は<a href="https://swagger.io/specification/" target="_blank" rel="noopener">OpenAPI Specification</a>などに記載があります。<br><a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a>もあわせてお読みください。<br><code>swagger.yaml</code>の書き方についての詳細な説明は今回は省略します。</p><p>hello worldのためのサンプルとなる<code>swagger.yaml</code>はgo-swaggerのリポジトリに用意されています。<br><a href="https://github.com/go-swagger/go-swagger/blob/master/examples/tutorials/custom-server/swagger/swagger.yml" target="_blank" rel="noopener">tutorials/custom-server</a>を例に説明します。</p><figure class="highlight yaml"><figcaption><span>swagger.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">swagger:</span> <span class="string">'2.0'</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Greeting</span> <span class="string">Server</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/hello:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">produces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">text/plain</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">name</span></span><br><span class="line">          <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">defaults</span> <span class="string">to</span> <span class="string">World</span> <span class="string">if</span> <span class="string">not</span> <span class="string">given</span></span><br><span class="line">      <span class="attr">operationId:</span> <span class="string">getGreeting</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">200:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">returns</span> <span class="string">a</span> <span class="string">greeting</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">contains</span> <span class="string">the</span> <span class="string">actual</span> <span class="string">greeting</span> <span class="string">as</span> <span class="string">plain</span> <span class="string">text</span></span><br></pre></td></tr></table></figure><p>サンプルの中では特にシンプルな構成です。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/hello:</span></span><br><span class="line">    <span class="attr">get:</span></span><br></pre></td></tr></table></figure><p>上記部分に記載の通り、<code>{host-name}/hello</code>にGETでアクセスする場合のリクエストパラメータ、レスポンスが定義されています。<br>レスポンスのフォーマットは<code>text/plain</code>。<br>URLのクエリパラメータに<code>name</code>を持たせることができる。<br>成功した場合のHTTPレスポンスステータスは<code>200 OK</code>。<br>レスポンスのbodyに単一の文字列が返ってくる。<br>…という事が<code>swagger.yaml</code>の内容から推測できます。</p><p>作成したファイルはOpenAPI Previewで確認することが可能です。<a href="https://chrome.google.com/webstore/detail/openapi-preview/ijjbiodnicjakhbfkffnlbekpgnmmggo?hl=en-GB" target="_blank" rel="noopener">Chorome拡張</a>、<a href="https://marketplace.visualstudio.com/items?itemName=zoellner.openapi-preview" target="_blank" rel="noopener">vscode向けのプラグイン</a>などで利用可能です。<a href="https://editor.swagger.io/" target="_blank" rel="noopener">editor.swagger.io</a>のようなウェブサイトとしても公開されています。<br><a href="https://github.com/xavierchow/vim-swagger-preview" target="_blank" rel="noopener">vimプラグイン</a>もありますね…素晴らしい。</p><p><img src="/images/20200824/open_api_preview.jpg" alt=""></p><p>この<code>swagger.yaml</code>を元に実際にソースコードをビルドしてみましょう。</p><h1 id="ソースコードをビルドする"><a href="#ソースコードをビルドする" class="headerlink" title="ソースコードをビルドする"></a>ソースコードをビルドする</h1><p>ディレクトリの構成は自由ですが、私のチームでは自動生成されたコードは<code>server/gen</code>に配置される構成をとっています。<br>下記のような構成でserver/genまでディレクトリを作成します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├──swagger</span><br><span class="line">| └─swagger.yaml</span><br><span class="line">└──server</span><br><span class="line">  └─gen</span><br></pre></td></tr></table></figure><p>serverディレクトリに移動し、下記コマンドでソースコードをビルドします。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swagger generate server -a factory -A factory -t gen f ./swagger/swagger.yaml</span><br></pre></td></tr></table></figure><p>オプションの詳細については<a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選</a>のTips2をご覧ください。</p><p>今回は<code>--exclude-main</code>を使用せずに<code>main.go</code>も生成してもらいます。コマンドの実行に成功すると、<code>server/gen</code>配下に各種ファイルが生成されます。</p><h1 id="試しにサーバーを立ち上げてみる"><a href="#試しにサーバーを立ち上げてみる" class="headerlink" title="試しにサーバーを立ち上げてみる"></a>試しにサーバーを立ち上げてみる</h1><p>main.goを実行することでサーバーが起動します。</p><p><code>server</code>ディレクトリ上で下記コマンドを実行します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run gen/cmd/factory-server/main.go --host 0.0.0.0 --port 3000</span><br></pre></td></tr></table></figure><p>コマンド実行後にブラウザで<code>localhost:3000/hello</code>にアクセスしてみましょう。</p><p><img src="/images/20200824/init.jpg" alt=""></p><p>エラーが出ます、hello worldまではあと一歩ですが、まだやることがあります。</p><h1 id="ハンドラを実装する"><a href="#ハンドラを実装する" class="headerlink" title="ハンドラを実装する"></a>ハンドラを実装する</h1><p>自動生成したコードだけではAPIサーバは完成しません。</p><p>なぜならAPIが表示したいデータをどこから用意し、どのような形式でレスポンスに返すかは<code>swagger.yaml</code>への記載だけではカバーしきれないからです。例えばリクエストを元にデータベースから情報を取得、返却するAPIを構築するとします。</p><p>データベース層はRDSでしょうか、NoSQLでしょうか、クラウド上のマネージドDBでしょうか、はたまたオンプレミスでしょうか。取りうる可能性は無限大です。そのためデータベースへのアクセスやレスポンスデータの加工は自前で実装する必要があるわけですね。</p><p>今回は下記のようなファイルを用意します。</p><figure class="highlight go"><figcaption><span>server/get_greeting_handler.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/go-openapi/runtime/middleware"</span></span><br><span class="line"><span class="string">"github.com/example-xxxxx/myapp-name/server/gen/restapi/factory"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetGreeting</span><span class="params">(p factory.GetGreetingParams)</span> <span class="title">middleware</span>.<span class="title">Responder</span></span> &#123;</span><br><span class="line">payload := *p.Name</span><br><span class="line"><span class="keyword">return</span> factory.NewGetGreetingOK().WithPayload(payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>※importするパスはご自身のgithubリポジトリになります。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├──swagger</span><br><span class="line">| └─swagger.yaml</span><br><span class="line">└──server</span><br><span class="line">  ├─gen</span><br><span class="line">  └─get_greeting_handler.go</span><br></pre></td></tr></table></figure><p>今回は上記のようなディレクトリ構成で配置しました。</p><p><code>GetGreetingParams</code>、<code>NewGetGreetingOK()</code>などが自動生成された関数、及び構造体です。<code>GetGreetingParams</code>はリクエストパラメータであり、<code>p.Name</code>でクエリパラメータの内容が取得できます。生成されたコードのお作法に則りハンドラを実装します。今回は受け取ったクエリパラメータをそのままレスポンスとして返してみます。このファイルの変数<code>payload</code>を任意の文字列にすると実際にレスポンスが変化します。</p><p>ファイルの用意ができたら実装したハンドラ関数をアプリケーションが実行するように設定します。実は自動生成したファイルの中には、手動での変更を認めないものと、認めるものが存在します。<code>server\gen\restapi\configure_factory.go</code>が手動での変更を許可するファイルです。書き換えても良いファイルは先頭行に<code>// This file is safe to edit. Once it exists it will not be overwritten</code>とコメントされています。</p><p>さてこのファイルの下記の部分を見てみましょう。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> api.GetGreetingHandler == <span class="literal">nil</span> &#123;</span><br><span class="line">        api.GetGreetingHandler = factory.GetGreetingHandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(params factory.GetGreetingParams)</span> <span class="title">middleware</span>.<span class="title">Responder</span></span> &#123;</span><br><span class="line">            <span class="keyword">return</span> middleware.NotImplemented(<span class="string">"operation factory.GetGreeting has not yet been implemented"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>api.GetGreetingHandlerがnilのままでは<code>not yet been implemented</code>と出力する設定になっています。<br>改めて先ほどのエラーを見てみましょう、細かい表示はともかく同じような内容のメッセージが出力されています。<br><img src="/images/20200824/init_2.jpg" alt=""></p><p>この部分を書き換えるか、ここより先に評価される行で下記のようにapi.GetGreetingHandlerを定義しましょう。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api.GetGreetingHandler = factory.GetGreetingHandlerFunc(server.GetGreeting)</span><br></pre></td></tr></table></figure><p><code>configure_factory.go</code>のimport文の更新も必要です。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"crypto/tls"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/go-openapi/errors"</span></span><br><span class="line"><span class="string">"github.com/go-openapi/runtime"</span></span><br><span class="line"></span><br><span class="line">+ <span class="string">"github.com/example-xxxxx/myapp-name/server"</span></span><br><span class="line"><span class="string">"github.com/example-xxxxx/myapp-name/server/gen/restapi/factory"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ここまで書けたら今度こそサーバーを起動して動かしてみましょう。</p><h1 id="ついにhello-world完了"><a href="#ついにhello-world完了" class="headerlink" title="ついにhello world完了"></a>ついにhello world完了</h1><p>先ほど書いた内容と同じ手順でサーバーを立ち上げます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run gen&#x2F;cmd&#x2F;factory-server&#x2F;main.go --host 0.0.0.0 --port 3000</span><br></pre></td></tr></table></figure><p>ブラウザで<code>localhost:3000/hello?name=hello-go-swagger</code>にアクセスします。<br><img src="/images/20200824/hello_go_swagger.jpg" alt=""></p><p>期待したレスポンスが返ってきました。ちなみに記事の通りの<code>get_greeting_handler.go</code>では、nameが与えられていない場合のエラーハンドリングが実装されていないため、<code>?name=hello-go-swagger</code>をURLに含めないと500番台のエラーすら返せずに処理に失敗してしまいます。</p><p>実際には400番、500番のエラーも<code>swagger.yaml</code>に定義し、どのような場合にどのエラーを返すかをハンドラに実装していく必要があります。(どの程度不正なリクエストを許容するのかといった柔軟性も、ハンドラで要件に合わせ実装していく形になります。)</p><p>今回はhello world編ということでここまでになります、是非皆さんも実際に試してみてください。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><ul><li><a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選</a></li><li><a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a></li><li><a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた</a></li><li><a href="https://future-architect.github.io/articles/20191008/">本当に使ってよかったOpenAPI (Swagger) ツール</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200824/top.png&quot; class=&quot;img-small-size&quot;&gt;

&lt;p&gt;The Gopher character is based on the Go mascot designed by &lt;a href=&quot;http://r
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="go-swagger" scheme="https://future-architect.github.io/tags/go-swagger/"/>
    
  </entry>
  
  <entry>
    <title>エンジニアが最低限理解しておくべきOSSライセンスの基礎知識</title>
    <link href="https://future-architect.github.io/articles/20200821/"/>
    <id>https://future-architect.github.io/articles/20200821/</id>
    <published>2020-08-20T15:00:00.000Z</published>
    <updated>2020-08-21T05:09:09.636Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200821/top.jpg"><p><a href="https://pixabay.com/ja/users/Catkin-127770/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1728448" target="_blank" rel="noopener">Catkin</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1728448" target="_blank" rel="noopener">Pixabay</a>からの画像</p><p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>15本目の記事です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>システム開発にてオープンソースのライブラリやフレームワークを利用することは、もはや当たり前となっています。<br>みなさんはOSSのライセンスについてどの程度理解していますでしょうか。<br>OSSだから無条件に利用可能だと思っていませんか？<br>本記事では、OSSのライセンスについて最低限エンジニアとして理解しておくべき内容を整理します。</p><p>なお、筆者は法学の専門家ではないことを事前にご了承ください。<br>本記事の内容は筆者個人の調査によるものであり、正確であるよう可能な限り努力しておりますが、間違いが含まれている可能性があります。あくまで参考資料としてご活用いただければ幸いです。</p><h2 id="前提として"><a href="#前提として" class="headerlink" title="前提として"></a>前提として</h2><h3 id="OSSとは"><a href="#OSSとは" class="headerlink" title="OSSとは"></a>OSSとは</h3><p>オープンソースソフトウェア（OSS）とは、利用者の目的を問わずソースコードを使用、調査、再利用、修正、拡張、再配布が可能なソフトウェアの総称となります。</p><p>オープンソースの定義については、<a href="https://opensource.org/" target="_blank" rel="noopener">Open Source Initiative（OSI）</a>と呼ばれるオープンソースを促進することを目的とした組織によって<a href="https://opensource.org/osd-annotated" target="_blank" rel="noopener">OSD（Open Source Defition）</a>という形でまとめられています。<br>現在はこのOSDが「オープンソースの定義」としてデファクトスタンダードになっています。</p><h3 id="OSSライセンスとは"><a href="#OSSライセンスとは" class="headerlink" title="OSSライセンスとは"></a>OSSライセンスとは</h3><p>OSSライセンスとは、OSSの使用許諾条件のことであり、著作権に基づいてOSSの利用条件を定義するものとなります。逆に言えばOSSとは、OSSライセンスを遵守することを条件に使用が許諾されていると言うことができます。</p><p>OSSライセンスは、先に述べたOSSの定義に基づく限り、著作権者が独自に定めることができる（と筆者は認識しています）ものですが、OSIによって承認された代表的なライセンスが下記に一覧化されています。<br><a href="https://opensource.org/licenses/alphabetical" target="_blank" rel="noopener">https://opensource.org/licenses/alphabetical</a></p><p>実際にGitHubなどを覗いてみても、OSIによって承認されたライセンスで公開されているOSSがほとんどであることが確認できるでしょう。</p><h2 id="OSSライセンスを理解する上でのポイント"><a href="#OSSライセンスを理解する上でのポイント" class="headerlink" title="OSSライセンスを理解する上でのポイント"></a>OSSライセンスを理解する上でのポイント</h2><p>OSSライセンスの種類は数多くありますが、各ライセンスを理解する上での重要なポイントとして下記の3点を取りあげます。</p><h3 id="無保証"><a href="#無保証" class="headerlink" title="無保証"></a>無保証</h3><p>主要なOSSライセンスは「著作権者は、対象ソフトウェアの動作を保証せず、発生した結果について一切の責任を負わない」とする免責条項を持っています。<br>つまり、著作者は、そのソフトウェアについて、予期した動作をする/しないの保証をせず、また、その動作の結果何らかの損害をもたらしたとしても、それを保障しないと定めています。</p><h3 id="著作権表示"><a href="#著作権表示" class="headerlink" title="著作権表示"></a>著作権表示</h3><p>もう1つ主要なライセンスに共通する特徴として、派生ソフトウェアを頒布する際は、利用元OSSの「著作権」「ライセンス文」「免責事項」などを表示しなければならない点が挙げられます。<br>具体的に「何を」「どこに」「どのように」表示するかは<strong>各ライセンスによって異なる可能性がある</strong>ので、詳細は個別のライセンスを丁寧に確認する必要があります。</p><p>例えば <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT License</a> では下記の記述によって「著作権表示」および「ライセンス文」を、「ソフトウェアのすべての複製または重要な部分に記載する」よう定められています。</p><blockquote><p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p></blockquote><p>また、著作権やライセンスをどこに記載するかに関しては派生ソフトウェアの頒布形式によって解釈が異なる模様です。<br>参考: <a href="https://opensource.stackexchange.com/questions/4058/what-is-the-point-of-including-the-mit-copyright-text-if-you-use-someones-code" target="_blank" rel="noopener">https://opensource.stackexchange.com/questions/4058/what-is-the-point-of-including-the-mit-copyright-text-if-you-use-someones-code</a></p><ul><li><p><strong>ソースコード形式で頒布する場合</strong><br>利用元のソースコード中に「著作権」及び「ライセンス文」が含まれているため、意図的にこれらを除去するなどしなければ、特に何もする必要はない、と解釈できます。<br>実際にOSSとして公開されている一般的なソースコードを見ても、これらについて特別に個別のファイルなどで明記していないものを見かけることは少なくありません。</p></li><li><p><strong>バイナリ形式で頒布する場合</strong><br>バイナリを配布する場合はコンパイル時にライセンス文が消えてしまうため、バイナリとは別にライセンス表示用のファイルなどにまとめて記載し、頒布先に提供する必要があります。</p></li></ul><p>正直筆者としては、この辺りの正確な解釈に自信がない（原文からは判断できない）のですが、要は派生ソフトウェアの利用者が派生ソフトウェア内で利用しているOSSのライセンスを知ることができないケースはNGとみて間違い無いでしょう。</p><h4 id="補足-誰に対して表示するか"><a href="#補足-誰に対して表示するか" class="headerlink" title="補足: 誰に対して表示するか"></a>補足: 誰に対して表示するか</h4><p>著作権やライセンス文を「誰に」対して表示するかですが、これは派生ソフトウェアの頒布先となります。<br>例えば、あるアプリケーションがWEB APIを提供する場合などは、アプリケーション自体はエンドユーザに頒布されておらず、あくまでネットワークを介してアプリケーションの機能を利用しているだけ、と解釈できるので、このエンドユーザに対して著作権表示を行う必要がないケースがほとんどです。<br>※ 後述するAGPLライセンスのような<strong>ネットワーク経由の利用に対しても強い制限を持つライセンスなどは例外</strong>です。</p><p>A社がB社に、toC向けのWEBアプリケーションの開発を依頼した、というケースでは、どうなるでしょうか。<br>この場合は下記のような整理になります。</p><ul><li>B社はA社に対してアプリケーション自体を頒布しているため、B社はA社に対してアプリケーション内で利用しているOSSの著作権表示を行う義務が発生します。</li><li>A社はエンドユーザに対してアプリケーションの機能のみを提供しているため、エンドユーザ向けに著作権表示を行う必要はありません。</li></ul><p>エンドユーザに対してネットワークを介した機能提供ではなく、アプリケーション自体を頒布するケース（SPAやiOS, Androidアプリなど）では、エンドユーザに対して著作権表示を行う義務があります。<br>スマホアプリ等では、アプリ内から著作権表示を確認できるものがほとんどでしょう。</p><h3 id="コピーレフトと非コピーレフト"><a href="#コピーレフトと非コピーレフト" class="headerlink" title="コピーレフトと非コピーレフト"></a>コピーレフトと非コピーレフト</h3><p>OSSライセンスを理解するにあたってコピーレフトの理解は非常に重要です。<br>コピーレフトとは「著作物の自由な利用・改変・再配布を認め、また、そこから派生した著作物についてこれらの行為を制限してはならない」という考え方です。<br>詰まるところ<strong>「あるOSSから派生ソフトウェアを作成して配布するときに元のOSSと同じ条件でソースコードを公開しなさい」</strong>ということです。<br>なお、このコピーレフトの考え方ですが、OSSを個人で利用する場合や自社内のみで利用する場合は当てはまりません。</p><p>OSSライセンスは、<strong>OSSの利用形態</strong>と<strong>ライセンスの伝搬性の範囲</strong>に応じて下記のとおり分類することができます。</p><p><img src="/images/20200821/%E5%9B%B31.png" alt=""></p><h4 id="利用形態"><a href="#利用形態" class="headerlink" title="利用形態"></a>利用形態</h4><p>まずはOSSの利用形態について説明しましょう。</p><h5 id="ソースコードの再利用"><a href="#ソースコードの再利用" class="headerlink" title="ソースコードの再利用"></a>ソースコードの再利用</h5><p>OSSのソースコードを直接改変したり、コードを追加したりする利用形態となります。</p><h5 id="ライブラリとしての利用"><a href="#ライブラリとしての利用" class="headerlink" title="ライブラリとしての利用"></a>ライブラリとしての利用</h5><p>OSSのソースコード自体には手を加えずライブラリとして利用する形態となります。<br>ライブラリのリンク方法は「静的リンク」と呼ばれる方法と「動的リンク」と呼ばれる方法があります。</p><ul><li><p><strong>静的リンク</strong><br>実行可能形式のバイナリを作成する際に、ライブラリを含む必要なコードの実態を全てリンクしてモジュールに含める方式</p></li><li><p><strong>動的リンク</strong><br>実行可能形式のバイナリにライブラリの実体を含めず、プログラムの実行開始時にローダによってリンクする方式</p></li></ul><h5 id="ネットワーク経由での利用"><a href="#ネットワーク経由での利用" class="headerlink" title="ネットワーク経由での利用"></a>ネットワーク経由での利用</h5><p>OSSを利用して、ネットワークサービスを提供する形態となります。<br>例えばWeb APIを提供する場合などがこれにあたります。</p><h4 id="ライセンスの分類"><a href="#ライセンスの分類" class="headerlink" title="ライセンスの分類"></a>ライセンスの分類</h4><p>さてOSSの利用形態が理解できたところで、次にライセンスの分類について見ていきましょう。<br>OSSライセンスは「コピーレフト型」「準コピーレフト型」「非コピーレフト型」のいずれかに分類することができます。</p><h5 id="コピーレフト型"><a href="#コピーレフト型" class="headerlink" title="コピーレフト型"></a>コピーレフト型</h5><p>元となるOSSのソースコードを再利用またはライブラリとして利用した際に、元のOSSと同じ条件で配布する必要があるものをコピーレフト型のライセンスといいます。</p><p>主要なところではGPLライセンス（<a href="https://opensource.org/licenses/GPL-2.0" target="_blank" rel="noopener">GPL-2.0</a>, <a href="https://opensource.org/licenses/GPL-3.0" target="_blank" rel="noopener">GPL-3.0</a>）がこれに該当します。<br>GPLでライセンスされたOSSを組み込む場合、それがライブラリとしての利用であったとしても、派生したソフトウェアはGPLライセンスで公開しなければならないということです。（その特性からGPL汚染と言われたりもします。）</p><p>ただし、GPLライセンスのOSSを利用して、WEB APIなどのネットワークサービスを提供する場合はこの限りではありません（ソースコードの公開などのコピーレフトは発生しません）。<br>ネットワーク経由でサービスを利用するエンドユーザは、ソースコードへアクセスする権利を持つ利用者には該当しないからです。</p><p>一方でコピーレフト型のライセンスの中で最も強い伝播性を持つ<a href="https://opensource.org/licenses/AGPL-3.0" target="_blank" rel="noopener">AGPL（Affero General Public License）</a>と呼ばれるものもあります。これはネットワークサービスを提供する場合にもコピーレフトが必要とされるライセンスとなります。</p><h5 id="準コピーレフト型"><a href="#準コピーレフト型" class="headerlink" title="準コピーレフト型"></a>準コピーレフト型</h5><p>OSSのソースコードを再利用した場合のみ、元のOSSと同じ条件で配布する必要があり、ライブラリとしての利用やネットワーク経由での利用はコピーレフトの対象とならないものを準コピーレフト型のライセンスといいます。</p><p>主要なところではLGPLライセンス（<a href="https://opensource.org/licenses/LGPL-2.1" target="_blank" rel="noopener">LGPL-2.1</a>, <a href="https://opensource.org/licenses/LGPL-3.0" target="_blank" rel="noopener">LGPL-3.0</a>）がこれに該当します。<br>LGPLライセンスはライブラリを静的リンクするか、動的リンクするかに応じて、異なる要求がある点が注意です。<br>※いずれにしても派生ソフトウェアをLGPLライセンスで公開する必要はありません。</p><p>下記を参考にすると次のように解釈できます。<br><a href="https://www.gnu.org/licenses/gpl-faq.html#LGPLStaticVsDynamic" target="_blank" rel="noopener">https://www.gnu.org/licenses/gpl-faq.html#LGPLStaticVsDynamic</a></p><ul><li><p><strong>静的リンクする場合</strong><br>リバースエンジニアリングを禁止せず、アプリケーションのオブジェクトコードまたはソースコードの提供が必要となります。</p></li><li><p><strong>動的リンクする場合</strong><br>特に制約はありません。</p></li><li><p><strong>静的、動的にかかわらずアプリケーションと一緒にライブラリを配布する場合</strong><br>ライブラリのソースを配布またはリンクなどを公開する必要があります。</p></li></ul><p>ところで、この静的リンクと動的リンクは具体的にどのように判断すれば良いのでしょうか。<br>CやC++のような明確なリンク作業を必要とするコンパイル言語を対象とする場合はあまり判断に困らない気がしますが、Javaのようなリンクという明確な作業を必要としない言語や、はたまたPythonのようなインタプリタ言語におけるライブラリの利用はどうなるのでしょうか。</p><p>Javaについては公式のQ&amp;Aにて説明があるとおり、ライブラリの利用は「静的リンク」と解釈される模様です。<br><a href="https://www.gnu.org/licenses/lgpl-java.ja.html" target="_blank" rel="noopener">https://www.gnu.org/licenses/lgpl-java.ja.html</a></p><p>他の言語について正確なところは筆者も判断できません（し明文化もされていないと思われます）が、<br>import文などを利用してソース内にてライブラリを参照する記述を行っている場合は、静的リンクと解釈しておいた方が良さそうです。</p><h5 id="非コピーレフト型"><a href="#非コピーレフト型" class="headerlink" title="非コピーレフト型"></a>非コピーレフト型</h5><p>OSSを利用をした際に、元のOSSと同じ条件で配布する必要がないものです。<br>MIT License や Apache License 2.0, BSDライセンス（<a href="https://opensource.org/licenses/BSD-2-Clause" target="_blank" rel="noopener">BSD 2-clause License</a>, <a href="https://opensource.org/licenses/BSD-3-Clause" target="_blank" rel="noopener">BSD 3-clause License</a>）などがこれに該当します。</p><h2 id="主要なライセンス"><a href="#主要なライセンス" class="headerlink" title="主要なライセンス"></a>主要なライセンス</h2><p>上記を踏まえつつ、我々が普段目にすることの多い主要なライセンスについて一覧化してみます。</p><p>とある調査によると、近年は非コピーレフト型のライセンスが多く好まれる傾向があり、<br>その中でも MIT License や Apache License 2.0 が上位にきていることがわかります。<br><a href="https://resources.whitesourcesoftware.com/blog-whitesource/top-open-source-licenses-trends-and-predictions" target="_blank" rel="noopener">https://resources.whitesourcesoftware.com/blog-whitesource/top-open-source-licenses-trends-and-predictions</a></p><table><thead><tr><th align="left">ライセンス名</th><th align="center">商用利用</th><th align="center">著作者による保証</th><th align="center">著作権・ライセンス表示</th><th align="center">類型</th></tr></thead><tbody><tr><td align="left"><a href="https://choosealicense.com/licenses/mit/" target="_blank" rel="noopener">MIT License</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="">Apache License 2.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/bsd-3-clause/" target="_blank" rel="noopener">BSD 3-Clause License</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/bsd-2-clause/" target="_blank" rel="noopener">BSD 2-Clause License</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/lgpl-2.1/" target="_blank" rel="noopener">LGPL 2.1</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">準コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/lgpl-3.0/" target="_blank" rel="noopener">LGPL 3.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">準コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/gpl-2.0/" target="_blank" rel="noopener">GPL-2.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/gpl-3.0/" target="_blank" rel="noopener">GPL-3.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/agpl-3.0/" target="_blank" rel="noopener">AGPL-3.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">コピーレフト</td></tr></tbody></table><p>上記の表では一見同じに見えても細かい条件が異なりますので、必ず利用の際には詳細な確認をしてください。<br>GitHubが公開しているライセンスのガイドラインは、各ライセンスで何が認められていて何が制限されているかが非常にわかりやすく整理されているのでお勧めです。<br><a href="https://choosealicense.com/appendix/" target="_blank" rel="noopener">https://choosealicense.com/appendix/</a><br>表のリンク先もこのGitHub社のページへリンクするようにしています。</p><h2 id="ライセンス違反とならないために"><a href="#ライセンス違反とならないために" class="headerlink" title="ライセンス違反とならないために"></a>ライセンス違反とならないために</h2><p>ここまでOSSライセンスの基礎についてご説明しましたが、いかがでしょうか。<br>最後にライセンス違反とならないための心得を記載して本記事を終わりにしたいと思います。</p><h4 id="OSSライセンスをきちんと自分の目で読み理解する"><a href="#OSSライセンスをきちんと自分の目で読み理解する" class="headerlink" title="OSSライセンスをきちんと自分の目で読み理解する"></a>OSSライセンスをきちんと自分の目で読み理解する</h4><p>OSSライセンスの基礎を理解することはもちろんですが、実際に自分の目できちんとライセンス文自体を読んでみることが重要です。ブログを読んで、この記事に書かれていたから大丈夫と鵜呑みにするのは大変危険です。<br>原文を読むのはハードルが高いという方は、<a href="https://opensource.jp/osg/aboutus.html" target="_blank" rel="noopener">オープンソースグループ・ジャパン</a>などが公開している日本語訳と照らしながら読んでみるといいかもしれません。<br><a href="https://osdn.net/projects/opensource/wiki/licenses" target="_blank" rel="noopener">https://osdn.net/projects/opensource/wiki/licenses</a></p><p>またGNUライセンスについては、Q&amp;Aが公開されていたりするので、こういったものも参考になるでしょう。<br><a href="https://www.gnu.org/licenses/gpl-faq.html.en" target="_blank" rel="noopener">https://www.gnu.org/licenses/gpl-faq.html.en</a><br>（日本語訳は<a href="https://www.gnu.org/licenses/gpl-faq.ja.html" target="_blank" rel="noopener">こちら</a>）</p><h4 id="法務部門や弁護士など専門家のレビューを受ける"><a href="#法務部門や弁護士など専門家のレビューを受ける" class="headerlink" title="法務部門や弁護士など専門家のレビューを受ける"></a>法務部門や弁護士など専門家のレビューを受ける</h4><p>エンジニア個人のレベルで、ライセンスに違反していないかどうかを完全に判断することはまず不可能です。<br>必ず専門家に依頼して確認を実施するようにしましょう。</p><h4 id="補足-ツールを利用してOSSのライセンスを一覧化する"><a href="#補足-ツールを利用してOSSのライセンスを一覧化する" class="headerlink" title="補足: ツールを利用してOSSのライセンスを一覧化する"></a>補足: ツールを利用してOSSのライセンスを一覧化する</h4><p>GitHub謹製の licensed を利用することで、インストールしたOSSライブラリのライセンスを一覧化することができます。本ツールをCIに組み込むことで、ライブラリが追加される度にライセンスを一覧化し、チェックするという運用が実現できそうですね。<br><a href="https://github.com/github/licensed" target="_blank" rel="noopener">https://github.com/github/licensed</a></p><p>デフォルトでは下記のライブラリ管理ツールがサポートされています。</p><ul><li>Bower</li><li>Bundler</li><li>Cabal</li><li>Composer</li><li>Git Submodules (git_submodule)</li><li>Go</li><li>Go Dep (dep)</li><li>Gradle</li><li>Manifest lists (manifests)</li><li>Mix</li><li>NPM</li><li>NuGet</li><li>Pip</li><li>Pipenv</li><li>Yarn</li></ul><p>本ツールのREADMEに免責事項として記載されているとおり、これは完全なライセンスのチェックを保証ツールではないので、あくまで人間のレビューの補助ツールとして利用することをお勧めします。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><p>オープンソースライセンスの基礎と実務<br><a href="https://www.slideshare.net/YutakaKachi/ss-118947772" target="_blank" rel="noopener">https://www.slideshare.net/YutakaKachi/ss-118947772</a></p></li><li><p>OSSのライセンスを理解する（「使用」と「利用」の違い、知っていますか？）<br><a href="https://qiita.com/bremen/items/c5aa9446e73aa4bc1de0" target="_blank" rel="noopener">https://qiita.com/bremen/items/c5aa9446e73aa4bc1de0</a></p></li><li><p>OSSライブラリのライセンスをチェックしてくれるGitHub製ツール「licensed」<br><a href="https://matsnow.hatenablog.com/entry/library/licensed" target="_blank" rel="noopener">https://matsnow.hatenablog.com/entry/library/licensed</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200821/top.jpg&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/Catkin-127770/?utm_source=link-attribution&amp;amp;utm_medium=ref
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="OSS" scheme="https://future-architect.github.io/tags/OSS/"/>
    
      <category term="license" scheme="https://future-architect.github.io/tags/license/"/>
    
  </entry>
  
  <entry>
    <title>Pythonによるパッケージ開発</title>
    <link href="https://future-architect.github.io/articles/20200820/"/>
    <id>https://future-architect.github.io/articles/20200820/</id>
    <published>2020-08-19T15:00:00.000Z</published>
    <updated>2020-08-20T00:46:37.086Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIG/DXチームの栗田です。<a href="https://future-architect.github.io/articles/20200726/">夏休み自由研究連載</a>14日目の記事です。<br>最近業務ではGoを書くことが増えてきましたが、私は以前Pythonをよく書いていました。<br>今回はPythonの開発をスムーズに行っていく方法について記載します。</p><h1 id="この文章の目的"><a href="#この文章の目的" class="headerlink" title="この文章の目的"></a>この文章の目的</h1><p>機械学習やDeep Learnigに後押しされ、今やPythonは非常に人気の言語です。初学者でも扱いやすく、学生の方も数値計算や競技プログラミングあるいは研究で利用しています。</p><p>一方で触りやすいがために「Pythonは書ける」のと「Pythonで何かを開発できる」には、意外なギャップが生まれることがあります。</p><p>ここではそういった「Pythonは書けるし実際書いているけど独学だったしアプリは作ったことがない」ような人をターゲットとして、初学者向けに紹介されるようなツールをどのように組み合わせていくかを記載します。</p><h1 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h1><ul><li><code>venv</code> で開発環境を整える</li><li><code>pytest</code> を書く</li><li><code>tox</code> に <code>pytest</code> を取り込む</li><li>さらに <code>black</code> や <code>flake8</code> や <code>mypy</code> を組み込んでいく</li></ul><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><ul><li><code>mypackage</code> というパッケージを作ることとします</li></ul><h1 id="開発環境について-venv"><a href="#開発環境について-venv" class="headerlink" title="開発環境について:venv"></a>開発環境について:venv</h1><h2 id="仮想環境"><a href="#仮想環境" class="headerlink" title="仮想環境"></a>仮想環境</h2><p>Pythonは必要なパッケージを適宜 <code>pip</code> で導入可能なのが便利ですが、そのままインストールするとシステムにそのまま入っていきます。</p><p>個人で作業するのであればそれでも問題ないかもしれませんが、複数のバージョン固定が入るようなプロダクトを開発したり、あるいはOSSなどのようにチームで開発したりする場合は、開発対象ごとにパッケージを管理することが望ましいです。</p><p>そのために使われるのが仮想環境であり、Python2.x系のときは <code>virtualenv</code> という機能がありました。この <code>virtualenv</code> がPython3.3から標準機能として取り込まれたのが、<code>venv</code> です。</p><blockquote><p>virtualenv is a tool to create isolated Python environments. Since Python 3.3, a subset of it has been integrated into the standard library under the venv module.</p></blockquote><p><a href="https://virtualenv.pypa.io/en/latest/" target="_blank" rel="noopener">Virtualenv - virtualenv documentation</a></p><p>Python標準機能のツールになったので、 <code>venv</code> はPython自体のversion管理はできません<br>また、Python3.3, 3.4系では仮想環境の作成に <code>pyvenv</code> というツールの仕様が推奨されていましたが、Python3.6系からは非推奨です。<br>Python3.5系から <code>venv</code> が推奨とされています。</p><h2 id="venvの使い方"><a href="#venvの使い方" class="headerlink" title="venvの使い方"></a>venvの使い方</h2><p>以下の形で仮想環境を用意します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/work/dir/path/mypackage</span><br><span class="line">$ python -m venv .venv</span><br><span class="line">$ <span class="built_in">source</span> .venv/bin/activate</span><br><span class="line">(.venv) $</span><br></pre></td></tr></table></figure><p>この仮想環境から抜けるには、以下のようにします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ deactivate</span><br><span class="line">$</span><br></pre></td></tr></table></figure><h2 id="仮想環境へのパッケージインストール"><a href="#仮想環境へのパッケージインストール" class="headerlink" title="仮想環境へのパッケージインストール"></a>仮想環境へのパッケージインストール</h2><p>先に用意した仮想環境は限りなくバニラな状態で、activate前にインストールしたパッケージは何も入っていません。</p><p>そのため、開発に必要なパッケージを改めてインストールする必要があります。例えばパッケージを作るためにsetup.pyを用意すれば、<code>$ python setup.py install</code> 実行時に作ったパッケージ自身とそれに依存するパッケージをインストールすることができます。</p><p>しかし、このコマンドでは開発中のパッケージを他のpythonパッケージのパスに移動するような操作になり、開発中のパッケージを含めて逐一 <code>$ python setup.py install</code> するのは面倒です。</p><p>できれば、作業中のディレクトリを直接参照したいです。そのため取られる手法の一つとして、以下のようなやり方があります。</p><ol><li>依存パッケージは別ファイルに切り出して管理（ <code>requirements.txt</code> などがそれに該当）</li><li>開発対象のパス自体を参照して仮想環境で <code>import</code> できるようにする</li></ol><p><code>requirements.txt</code> には依存関係にあるパッケージのバージョンまで記載することができます。<br>このファイルと <code>pip</code> の <code>-e</code> オプションを利用して、上記の2つを満たします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ pip install -e . -r requirements.txt</span><br></pre></td></tr></table></figure><p>この手法を取ることで、複数人における開発で同じ環境を共有することができます。</p><h1 id="Pythonによるテスト-pytest"><a href="#Pythonによるテスト-pytest" class="headerlink" title="Pythonによるテスト:pytest"></a>Pythonによるテスト:pytest</h1><h2 id="テストツール比較"><a href="#テストツール比較" class="headerlink" title="テストツール比較"></a>テストツール比較</h2><p>Python用のテストツールは複数あります。</p><table><thead><tr><th align="left">ツール名</th><th align="left">説明</th></tr></thead><tbody><tr><td align="left">unittest</td><td align="left">Pythonの標準ライブラリに含まれるテストモジュール。</td></tr><tr><td align="left">doctest</td><td align="left">ドキュメンテーション中のインタラクティブなPythonセッションに見えるテキストを検索し、それが正しいかどうかを確認するモジュール。</td></tr><tr><td align="left">nose</td><td align="left">unittestを拡張して実行できるツール。カバレッジなども取得できる。</td></tr><tr><td align="left">pytest</td><td align="left">テストフレームワーク。unittestの形で記述されたコードも実行でき、拡張性が高かったりテスト結果がわかりやすかったりする。たまに見受けられる <code>py.test</code> は古いコマンド。</td></tr><tr><td align="left">tox</td><td align="left">テスト環境の管理を自動化し、複数のインタプリタに対してテストするためのツール。コードチェックツールやフォーマットツールを組み合わせることができる。</td></tr></tbody></table><p><code>unittest</code> や <code>nose</code> で書いたテストがそのまま実行できることもあり、 <code>pytest</code> が利用されるケースが多いと思います。</p><p>例えば最近のツールでの採用例としては、AWS Glueのテストも <code>pytest</code> で行えます。</p><p>今回は、これに <code>flake8</code> や <code>black</code> を組み合わせた形で、 <code>tox</code> からコールします。有名な<a href="https://github.com/pallets/flask" target="_blank" rel="noopener">flask</a>や<a href="https://github.com/sphinx-doc/sphinx" target="_blank" rel="noopener">sphinx</a>でも、このような構成となっています。今回はこの構成を実際に構築していきます。</p><h2 id="pytest環境の構築"><a href="#pytest環境の構築" class="headerlink" title="pytest環境の構築"></a>pytest環境の構築</h2><p><code>pytest</code> の実行には、<a href="https://docs.pytest.org/en/latest/goodpractices.html" target="_blank" rel="noopener">強く推奨されるディレクトリ構造</a>があり、このディレクトリ構造であれば <code>pip</code> パッケージの開発をすすめることができます。<br>今回はその形式に則ります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── requirements.txt</span><br><span class="line">├── setup.cfg</span><br><span class="line">├── setup.py</span><br><span class="line">├── venv</span><br><span class="line">├── src</span><br><span class="line">│   └── mypackage</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       └── mypackage.py</span><br><span class="line">└── tests</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    └── test_mypackage.py</span><br></pre></td></tr></table></figure><p>ルートディレクトリの直下に <code>src</code> </p><p>テストコードについては、<code>test_</code>のプレフィックスを付けて、<code>tests</code>ディレクトリ以下に設置します。パスの通りにファイルを作ったら、次のような中身にします。</p><figure class="highlight python"><figcaption><span>mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.pi</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(mypackage_func())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight python"><figcaption><span>test_mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mypackage.mypackage <span class="keyword">import</span> mypackage_func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"&#123;:.2f&#125;"</span>.format(mypackage_func()) == <span class="string">"3.14"</span>, <span class="string">"小数点以下2桁までを比較"</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">not</span> mypackage_func() == <span class="number">3</span>, <span class="string">"円周率は3ではない"</span></span><br></pre></td></tr></table></figure><p>これで <code>pytest</code> コマンドを実行すると、結果を確認することができます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ pytest</span><br><span class="line">====================================== <span class="built_in">test</span> session starts ======================================</span><br><span class="line">platform linux -- Python 3.7.8, pytest-6.0.1, py-1.9.0, pluggy-0.13.1</span><br><span class="line">rootdir: /home/kurita/mypackage</span><br><span class="line">collected 1 item                                                                                </span><br><span class="line"></span><br><span class="line">tests/test_mypackage.py .                                                                 [100%]</span><br><span class="line"></span><br><span class="line">======================================= 1 passed <span class="keyword">in</span> 0.12s =======================================</span><br></pre></td></tr></table></figure><p><code>pytest</code> の場合 <code>assert</code> が基本的な使い方になりますが、もちろん他の方法もできます。<br>例えば、例外検証する場合は、次のようになります。</p><figure class="highlight python"><figcaption><span>test_mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mypackage.mypackage <span class="keyword">import</span> mypackage_func</span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="string">"&#123;:.2f&#125;"</span>.format(mypackage_func()) == <span class="string">"3.14"</span>, <span class="string">"小数点以下2桁までを比較"</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">not</span> mypackage_func() == <span class="number">3</span>, <span class="string">"円周率は3ではない"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_zero_division</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> pytest.raises(ZeroDivisionError):</span><br><span class="line">        <span class="keyword">assert</span> <span class="number">0</span> == mypackage_func() / <span class="number">0</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ pytest -rsfp</span><br><span class="line">====================================== <span class="built_in">test</span> session starts ======================================</span><br><span class="line">platform linux -- Python 3.7.8, pytest-6.0.1, py-1.9.0, pluggy-0.13.1</span><br><span class="line">rootdir: /home/kurita/mypackage</span><br><span class="line">collected 2 items                                                                               </span><br><span class="line"></span><br><span class="line">tests/test_mypackage.py ..                                                                [100%]</span><br><span class="line"></span><br><span class="line">==================================== short <span class="built_in">test</span> summary info ====================================</span><br><span class="line">PASSED tests/test_mypackage.py::test_mypackage_func</span><br><span class="line">PASSED tests/test_mypackage.py::test_zero_division</span><br><span class="line">======================================= 2 passed <span class="keyword">in</span> 0.12s =======================================</span><br></pre></td></tr></table></figure><p>試しに、 <code>pytest</code> 実行時にオプションを付けてみました。失敗した内容を良く確認したり、カバレッジを確認したりできます。</p><p>他にも <code>pytest</code> には様々なプラグインが存在しています。</p><p><code>$ pip search pytest</code> を実行すれば、たくさんのプラグインがあることがわかります。</p><p><code>pytest</code> の細かい使い方については<a href="https://docs.pytest.org/en/stable/" target="_blank" rel="noopener">公式のドキュメント</a>を読んでも良いですし、例えば<a href="https://www.m3tech.blog/entry/pytest-summary" target="_blank" rel="noopener">エムスリーのテックブログ</a>に記載されています。</p><h1 id="テスト環境自体の整理：tox"><a href="#テスト環境自体の整理：tox" class="headerlink" title="テスト環境自体の整理：tox"></a>テスト環境自体の整理：tox</h1><p>自分で使用するために開発しているのだと <code>pytest</code> で十分に思うかもしれませんが、Pythonの場合サポート中の言語が複数バージョン存在します。</p><p>パッケージとして提供するのであれば、複数のバージョンのPythonでテストしておきたいですが、そんなときに使えるのが<a href="https://tox.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">tox</a>です。</p><p><code>tox</code> は設定ファイルに記載した内容をもとに別々の <code>virtualenv</code> 環境を構築し、各環境の中でテストを実行して表示するツールです。<code>tox</code> の設定ファイルとしては <code>tox.ini</code> というファイルを記載します。</p><p>簡単な例としては、次のように書きます。</p><figure class="highlight ini"><figcaption><span>tox.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tox]</span></span><br><span class="line"><span class="comment"># envlist: テスト環境の一覧。ここで記載した環境が構築されます。</span></span><br><span class="line"><span class="comment"># py37: インストールされている python3.7 コマンドを探し、 Python3.7 の virtualenv を作成します</span></span><br><span class="line"><span class="attr">envlist</span> = py37</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [testenv]: テスト環境の設定。</span></span><br><span class="line"><span class="section">[testenv]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 環境にインストールするライブラリを指定します</span></span><br><span class="line"><span class="comment"># ここで渡したものが直接pipに渡されるため、requirements.txtの指定ができます</span></span><br><span class="line"><span class="comment"># `-r` と `requirements.txt` の間にスペースを入れるとエラーになります</span></span><br><span class="line"><span class="attr">deps</span> = -rrequirements.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行するコマンド: pytest</span></span><br><span class="line"><span class="attr">commands</span> = pytest -rsfp</span><br></pre></td></tr></table></figure><figure class="highlight bash"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ tox</span><br><span class="line">GLOB sdist-make: /home/kurita/mypackage/setup.py</span><br><span class="line">py37 inst-nodeps: /home/kurita/mypackage/.tox/.tmp/package/1/mypackage-0.0.1.zip</span><br><span class="line">py37 installed: appdirs==1.4.4,attrs==19.3.0,bleach==3.1.5,certifi==2020.6.20,cffi==1.14.1,chardet==3.0.4,colorama==0.4.3,cryptography==3.0,distlib==0.3.1,docutils==0.16,filelock==3.0.12,idna==2.10,importlib-metadata==1.7.0,iniconfig==1.0.1,jeepney==0.4.3,keyring==21.3.0,more-itertools==8.4.0,mypackage @ file:///home/hikaru/hikaru/program/mypackage/.tox/.tmp/package/1/mypackage-0.0.1.zip,mypy==0.782,mypy-extensions==0.4.3,numpy==1.19.1,packaging==20.4,pkginfo==1.5.0.1,pluggy==0.13.1,py==1.9.0,pycparser==2.20,Pygments==2.6.1,pyparsing==2.4.7,pytest==6.0.1,readme-renderer==26.0,requests==2.24.0,requests-toolbelt==0.9.1,rfc3986==1.4.0,SecretStorage==3.1.2,six==1.15.0,toml==0.10.1,tox==3.19.0,tqdm==4.48.2,twine==3.2.0,typed-ast==1.4.1,typing-extensions==3.7.4.2,urllib3==1.25.10,virtualenv==20.0.30,webencodings==0.5.1,zipp==3.1.0</span><br><span class="line">py37 run-test-pre: PYTHONHASHSEED=<span class="string">'468102422'</span></span><br><span class="line">py37 run-test: commands[0] | pytest -rsfp</span><br><span class="line">============================================= <span class="built_in">test</span> session starts =============================================</span><br><span class="line">platform linux -- Python 3.7.8, pytest-6.0.1, py-1.9.0, pluggy-0.13.1</span><br><span class="line">cachedir: .tox/py37/.pytest_cache</span><br><span class="line">rootdir: /home/kurita/mypackage</span><br><span class="line">collected 2 items                                                                                             </span><br><span class="line"></span><br><span class="line">tests/test_mypackage.py ..                                                                              [100%]</span><br><span class="line"></span><br><span class="line">=========================================== short <span class="built_in">test</span> summary info ===========================================</span><br><span class="line">PASSED tests/test_mypackage.py::test_mypackage_func</span><br><span class="line">PASSED tests/test_mypackage.py::test_zero_division</span><br><span class="line">============================================== 2 passed <span class="keyword">in</span> 0.12s ==============================================</span><br><span class="line">___________________________________________________ summary ___________________________________________________</span><br><span class="line">  py37: commands succeeded</span><br><span class="line">  congratulations :)</span><br></pre></td></tr></table></figure><p><code>envlist</code> に他のPythonのバージョン、例えば <code>py38</code> を追加すると、python3.8でのテストも一緒に実行されます。</p><h1 id="コードフォーマッター-black"><a href="#コードフォーマッター-black" class="headerlink" title="コードフォーマッター:black"></a>コードフォーマッター:black</h1><p>コードレビューの際に「このコードはこうあるべき」というのが気になることがありますが、そんなときに役立つのがコードフォーマッターです。いわずもがな、フォーマットされたコードは読みやすく、またおかしなことをしている部分を見つけやすくなります。</p><p>Pythonにもいくつかのコードフォーマッターがあり、古いものだと <code>autopep8</code>、go言語の <code>gofmt</code> を参考にgoogleが作った <code>yapf</code> などがありますが、ここでは<a href="https://github.com/psf/black" target="_blank" rel="noopener">black</a>というツールを紹介します。Pythonには<a href="https://pep8-ja.readthedocs.io/ja/latest/" target="_blank" rel="noopener">PEP8</a>というPythonのコーディング規約があり、これに従うことが基本となります。</p><p><code>black</code> も基本このPEP8に準拠する形ですが、その上で <code>black</code> で定義された形にファイルフォーマットされる、いわばより制約の強いPEP8のような振る舞いをします。<code>black</code> のさらなる特徴としては、上述の2つのツールに比べて自由度が少ないことです。</p><p>ユーザーの設定の余地が少ないことから開発者の好みによったフォーマットが起きづらく、見た目が揃いやすいです。PyConJPなど各種イベントの入門者用の発表でも、利用を推奨されているツールです。</p><h2 id="blackの実行"><a href="#blackの実行" class="headerlink" title="blackの実行"></a>blackの実行</h2><p><code>pip</code> で簡単にインストールできますので、試してみます。<br><code>black</code> コマンドだけだと対象ファイルにフォーマットをかけて書き直しますが、<code>--check</code> オプションを付けることで、フォーマットがかかる対象を確認できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ pip install black</span><br><span class="line">(.venv) $ $ black . --check</span><br><span class="line">All <span class="keyword">done</span>! ✨ 🍰 ✨</span><br><span class="line">5 files would be left unchanged.</span><br></pre></td></tr></table></figure><p>特段エラーが無いことがわかりました。</p><p>余談ですが、 <code>black</code> の数少ない設定として、除外ファイルの設定ができます。デフォルトでも、よくあるファイルについてはexcludeされています。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ black --<span class="built_in">help</span></span><br><span class="line">...中略...</span><br><span class="line">  --exclude TEXT                  A regular expression that matches files and</span><br><span class="line">                                  directories that should be excluded on</span><br><span class="line">                                  recursive searches.  An empty value means no</span><br><span class="line">                                  paths are excluded. Use forward slashes <span class="keyword">for</span></span><br><span class="line">                                  directories on all platforms (Windows, too).</span><br><span class="line">                                  Exclusions are calculated first, inclusions</span><br><span class="line">                                  later.  [default: /(\.eggs|\.git|\.hg|\.mypy</span><br><span class="line">                                  _cache|\.nox|\.tox|\.venv|\.svn|_build|buck-</span><br><span class="line">                                  out|build|dist)/]</span><br><span class="line">...以下略...</span><br></pre></td></tr></table></figure><p>ヘルプにかかれているように、 <code>.tox</code> や <code>.venv</code> 以下のファイルについては、最初から <code>black</code> の対象外にされています。</p><p>試しにその中のファイルに対して <code>black</code> をかけて見えると、reformatがかかることがわかります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ black .venv/bin/rst2odt.py --check</span><br><span class="line">would reformat .venv/bin/rst2odt.py</span><br><span class="line">Oh no! 💥 💔 💥</span><br><span class="line">1 file would be reformatted.</span><br></pre></td></tr></table></figure><p><code>.tox</code> や <code>.venv</code> ともに <code>.gitignore</code> に記載されるような対象ですので、 <code>black</code> で管理する必要もないでしょう。<br>ちなみに開発環境によって他の除外ファイルを設定したい場合、オプションとして渡すこともできますが、 <code>pyproject.toml</code> ファイルに記載することで、まとめて外すこともできます。</p><h2 id="toxへの取り込み"><a href="#toxへの取り込み" class="headerlink" title="toxへの取り込み"></a>toxへの取り込み</h2><p><code>black</code> によってコードチェックができるようになりましたので、これをtoxにも組み込みます。</p><p>といっても、 <code>tox.ini</code> を次のようにするだけです。これで、 <code>tox</code> コマンド実行時に <code>black</code> をかけることができます。</p><figure class="highlight ini"><figcaption><span>tox.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tox]</span></span><br><span class="line"><span class="comment"># envlist: テスト環境の一覧。ここで記載した環境が構築されます。</span></span><br><span class="line"><span class="comment"># py37: インストールされている python3.7 コマンドを探し、 Python3.7 の virtualenv を作成します</span></span><br><span class="line"><span class="attr">envlist</span> = py37, black</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [testenv]: テスト環境の設定。</span></span><br><span class="line"><span class="section">[testenv]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 環境にインストールするライブラリを指定します</span></span><br><span class="line"><span class="comment"># ここで渡したものが直接pipに渡されるため、requirements.txtの指定ができます</span></span><br><span class="line"><span class="comment"># `-r` と `requirements.txt` の間にスペースを入れるとエラーになります</span></span><br><span class="line"><span class="attr">deps</span> = -rrequirements.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行するコマンド: pytest</span></span><br><span class="line"><span class="attr">commands</span> = pytest -rsfp</span><br><span class="line"></span><br><span class="line"><span class="comment"># black用のテスト環境。指定がなければtestenv環境が優先されます。</span></span><br><span class="line"><span class="section">[testenv:black]</span></span><br><span class="line"><span class="attr">basepython</span> = python3.<span class="number">7</span></span><br><span class="line"><span class="attr">deps</span> = black</span><br><span class="line"><span class="attr">commands</span> = black . --check</span><br></pre></td></tr></table></figure><p>depsについては <code>-rrequirements.txt</code> で指定してもいいですが、他のパッケージを毎回インストールするのは時間がかかるので省いて、必要最小限にしています。</p><h1 id="文法チェックツール-flake8"><a href="#文法チェックツール-flake8" class="headerlink" title="文法チェックツール:flake8"></a>文法チェックツール:flake8</h1><p><code>flake8</code> は静的文法チェックツールで、これもPEP8に従う形でコードをチェックし、バグになりやすいソースコードを探します。</p><h2 id="flake8の実行"><a href="#flake8の実行" class="headerlink" title="flake8の実行"></a>flake8の実行</h2><p>これも <code>pip</code> でインストールできます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ pip install flake8</span><br><span class="line">(.venv) $ flake8 src/</span><br><span class="line">src/mypackage/mypackage.py:7:1: E302 expected 2 blank lines, found 1</span><br></pre></td></tr></table></figure><p>なにか見つかりましたが、これは <code>関数の前には2行のblank lineが必要なのに1行しかないよ</code> というエラーです。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.pi</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(mypackage_func())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>確かに、 <code>def main():</code> の前に1行しかblank lineがありません。<br>なので、1行加えてみます。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.pi</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(mypackage_func())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ flake8 src/</span><br><span class="line">(.venv) $</span><br></pre></td></tr></table></figure><p>先程のE302の表示が消えました。</p><h2 id="flake8のtoxへの組み込み"><a href="#flake8のtoxへの組み込み" class="headerlink" title="flake8のtoxへの組み込み"></a>flake8のtoxへの組み込み</h2><p><code>flake8</code> も <code>tox</code> に組み込んで、自動化しましょう。<br>これも <code>tox.ini</code> の中に記載します。</p><figure class="highlight ini"><figcaption><span>tox.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tox]</span></span><br><span class="line"><span class="comment"># envlist: テスト環境の一覧。ここで記載した環境が構築されます。</span></span><br><span class="line"><span class="comment"># py37: インストールされている python3.7 コマンドを探し、 Python3.7 の virtualenv を作成します</span></span><br><span class="line"><span class="attr">envlist</span> = py37, black, flake8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [testenv]: テスト環境の設定。</span></span><br><span class="line"><span class="section">[testenv]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 環境にインストールするライブラリを指定します</span></span><br><span class="line"><span class="comment"># ここで渡したものが直接pipに渡されるため、requirements.txtの指定ができます</span></span><br><span class="line"><span class="comment"># `-r` と `requirements.txt` の間にスペースを入れるとエラーになります</span></span><br><span class="line"><span class="attr">deps</span> = -rrequirements.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行するコマンド: pytest</span></span><br><span class="line"><span class="attr">commands</span> = pytest -rsfp</span><br><span class="line"></span><br><span class="line"><span class="comment"># black用のテスト環境。指定がなければtestenv環境が優先されます。</span></span><br><span class="line"><span class="section">[testenv:black]</span></span><br><span class="line"><span class="attr">basepython</span> = python3.<span class="number">7</span></span><br><span class="line"><span class="attr">deps</span> = black</span><br><span class="line"><span class="attr">commands</span> = black . --check</span><br><span class="line"></span><br><span class="line"><span class="section">[testenv:flake8]</span></span><br><span class="line"><span class="attr">deps</span> = flake8</span><br><span class="line"><span class="attr">commands</span> = flake8 .</span><br><span class="line"></span><br><span class="line"><span class="section">[flake8]</span></span><br><span class="line"><span class="attr">max-line-length</span> = <span class="number">88</span></span><br><span class="line"><span class="attr">ignore</span> = E203, W503, W504</span><br><span class="line"><span class="attr">exclude</span> = .git, __pychache__, build, dist, .tox, .venv</span><br></pre></td></tr></table></figure><p>先に <code>black</code> を導入していますが、 <code>flake8</code> と <code>black</code> は併用可能です。ただし、一部非互換の部分があるので、2箇所修正を入れています。</p><p>一つは <code>max-line-length</code> ですが、こちらは <code>black</code> 側でデフォルトで88文字なので、それに合わせます。もしもblack側で変更を入れている場合は、それに合わせる形で修正します。もう一つが、E203, W503, W504です。こちらも <code>black</code> 側で許容されてしまうので、ignoreにします。</p><p>最後に、開発用のファイルまでチェック対象にすると大変なので、それらのファイルをexcludeします。デフォルトで <code>.git</code> などが含まれていますが、 <code>.tox</code> や <code>.venv</code> が含まれていないので、ここで明示的に設定します。なお、 <code>build</code> や <code>dist</code> は <code>setup.py</code> を使うときに将来的に必要になることを見越して入れています。</p><h1 id="静的解析ツール-mypy"><a href="#静的解析ツール-mypy" class="headerlink" title="静的解析ツール:mypy"></a>静的解析ツール:mypy</h1><p>Python3.5から型ヒントがサポートされるようになりましたが、これはPythonに変数の型チェックをもたらしました。</p><p>コードを見ただけでその変数にどのようなクラスや型の値が入っているかわかるようになりましたが、あくまでヒントであって実行時には役には立ちません。この型を静的にチェックするツールが、<a href="https://mypy.readthedocs.io/en/stable/index.html" target="_blank" rel="noopener">mypy</a>です。</p><h2 id="mypyの実行"><a href="#mypyの実行" class="headerlink" title="mypyの実行"></a>mypyの実行</h2><p><code>pip</code> でインストールして試してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ pip install mypy</span><br></pre></td></tr></table></figure><p>mypyの使い方は、引数の右側に <code>: 型名</code> と、関数やメソッドの右側に <code>-&gt; 型名</code> とつけることによって行います。<br>試しに、 これまで作っていた <code>src/mypackage/mypackage.py</code> にmypyをかけてみます。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.pi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(mypackage_func())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ mypy  src/mypackage/mypackage.py </span><br><span class="line">src/mypackage/mypackage.py:1: error: Skipping analyzing <span class="string">'numpy'</span>: found module but no <span class="built_in">type</span> hints or library stubs</span><br><span class="line">src/mypackage/mypackage.py:1: note: See https://mypy.readthedocs.io/en/latest/running_mypy.html<span class="comment">#missing-imports</span></span><br><span class="line">Found 1 error <span class="keyword">in</span> 1 file (checked 1 <span class="built_in">source</span> file)</span><br></pre></td></tr></table></figure><p><code>numpy</code> がなにか引っかかりました。<br>これは、 <code>mypy</code> がサードパーティモジュールについてはStubファイルという型ヒント用のファイルを読み込んでチェックをかけるのですが、現在の環境にはそれがないため怒られています。<br>Stubファイルを作ることもできますが、よくやる手法としてはサードパーティモジュールの型ヒントを無視することをします。<br>これには、 <code>mypy</code> の設定ファイルである <code>mypy.ini</code> というファイルを編集します。</p><figure class="highlight ini"><figcaption><span>mypy.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mypy]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mypy-numpy]</span></span><br><span class="line"><span class="attr">ignore_missing_imports</span> = <span class="literal">True</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ mypy src/mypackage/mypackage.py </span><br><span class="line">Success: no issues found <span class="keyword">in</span> 1 <span class="built_in">source</span> file</span><br></pre></td></tr></table></figure><p>これで <code>numpy</code> の型ヒントは無視されました。<br>続いて、 <code>src/mypackage/mypackage.py</code> に対して型ヒントを付与します。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.pi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypy_func</span><span class="params">(x: int)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    print(<span class="string">"This is mypy test: x = &#123;&#125;"</span>.format(x))</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(mypackage_func())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>このファイルに <code>mypy</code> をかけても、特にエラーはでません。<br>続いて、わざとエラーを出させてみます。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...前略...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypy_func</span><span class="params">(x: int)</span> -&gt; str:</span> <span class="comment"># リターンをNone-&gt;strに変えた</span></span><br><span class="line">    print(<span class="string">"This is mypy test: x = &#123;&#125;"</span>.format(x))</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">...以下略...</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mypy src/mypackage/mypackage.py </span><br><span class="line">src/mypackage/mypackage.py:10: error: Return value expected</span><br><span class="line">Found 1 error <span class="keyword">in</span> 1 file (checked 1 <span class="built_in">source</span> file)</span><br></pre></td></tr></table></figure><p>確かにエラーが出ました。<br>さらに、 <code>mypackage_func()</code> の方もエラーを出させてみます。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...前略...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.pi</span><br><span class="line">...以下略...</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mypy src/mypackage/mypackage.py </span><br><span class="line">src/mypackage/mypackage.py:10: error: Return value expected</span><br><span class="line">Found 1 error <span class="keyword">in</span> 1 file (checked 1 <span class="built_in">source</span> file)</span><br></pre></td></tr></table></figure><p><code>np.pi</code> は <code>float</code> なので明らかに間違っていますが、 <code>mypy</code> でエラーが出ていません。<br>今回 <code>numpy</code> はignoreにする対象としていますので、今回のチェック外となっています。<br>こちらですが、明示的に型指定すると、 <code>mypy</code> でエラーを検知できます。</p><figure class="highlight python"><figcaption><span>src/mypackage/mypackage.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...前略...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mypackage_func</span><span class="params">()</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">return</span> float(np.pi) <span class="comment"># floatで明示的にキャストした</span></span><br><span class="line">...以下略...</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ mypy src/mypackage/mypackage.py </span><br><span class="line">src/mypackage/mypackage.py:5: error: No <span class="built_in">return</span> value expected</span><br><span class="line">src/mypackage/mypackage.py:10: error: Return value expected</span><br><span class="line">Found 2 errors <span class="keyword">in</span> 1 file (checked 1 <span class="built_in">source</span> file)</span><br></pre></td></tr></table></figure><h2 id="toxへのmypyの組み込み"><a href="#toxへのmypyの組み込み" class="headerlink" title="toxへのmypyの組み込み"></a>toxへのmypyの組み込み</h2><p>最後に、　<code>mypy</code> も <code>tox.ini</code> に追加します。</p><figure class="highlight ini"><figcaption><span>tox.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tox]</span></span><br><span class="line"><span class="comment"># envlist: テスト環境の一覧。ここで記載した環境が構築されます。</span></span><br><span class="line"><span class="comment"># py37: インストールされている python3.7 コマンドを探し、 Python3.7 の virtualenv を作成します</span></span><br><span class="line"><span class="attr">envlist</span> = py37, black, flake8, mypy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [testenv]: テスト環境の設定。</span></span><br><span class="line"><span class="section">[testenv]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 環境にインストールするライブラリを指定します</span></span><br><span class="line"><span class="comment"># ここで渡したものが直接pipに渡されるため、requirements.txtの指定ができます</span></span><br><span class="line"><span class="comment"># `-r` と `requirements.txt` の間にスペースを入れるとエラーになります</span></span><br><span class="line"><span class="attr">deps</span> = -rrequirements.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行するコマンド: pytest</span></span><br><span class="line"><span class="attr">commands</span> = pytest -rsfp</span><br><span class="line"></span><br><span class="line"><span class="comment"># black用のテスト環境。指定がなければtestenv環境が優先されます。</span></span><br><span class="line"><span class="section">[testenv:black]</span></span><br><span class="line"><span class="attr">basepython</span> = python3.<span class="number">7</span></span><br><span class="line"><span class="attr">deps</span> = black</span><br><span class="line"><span class="attr">commands</span> = black . --check</span><br><span class="line"></span><br><span class="line"><span class="section">[testenv:flake8]</span></span><br><span class="line"><span class="attr">deps</span> = flake8</span><br><span class="line"><span class="attr">commands</span> = flake8 .</span><br><span class="line"></span><br><span class="line"><span class="section">[flake8]</span></span><br><span class="line"><span class="attr">max-line-length</span> = <span class="number">88</span></span><br><span class="line"><span class="attr">ignore</span> = E203, W503, W504</span><br><span class="line"><span class="attr">exclude</span> = .git, __pychache__, build, dist, .tox, .venv</span><br><span class="line"></span><br><span class="line"><span class="section">[testenv:mypy]</span></span><br><span class="line"><span class="attr">deps</span> = mypy</span><br><span class="line"><span class="attr">commands</span> = mypy src</span><br></pre></td></tr></table></figure><p>無事すべてのテストをパスしました。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(.venv) $ tox</span><br><span class="line">...中略...</span><br><span class="line">_______________________________ summary ________________________________</span><br><span class="line">  py37: commands succeeded</span><br><span class="line">  black: commands succeeded</span><br><span class="line">  flake8: commands succeeded</span><br><span class="line">  mypy: commands succeeded</span><br><span class="line">  congratulations :)</span><br></pre></td></tr></table></figure><h1 id="補足：VSCodeにおけるblackとflake8とmypyを取り込む"><a href="#補足：VSCodeにおけるblackとflake8とmypyを取り込む" class="headerlink" title="補足：VSCodeにおけるblackとflake8とmypyを取り込む"></a>補足：VSCodeにおけるblackとflake8とmypyを取り込む</h1><p>今回紹介したツールは都度かければきれいなコードが書けますが、逐次手動で実行するのは面倒です。<br>テスト実行時に気づけるといっても、できればコーディング中に自動整形してほしいし、適宜指摘してほしいので、そのための設定を行います。</p><h2 id="Python用Extensionの導入"><a href="#Python用Extensionの導入" class="headerlink" title="Python用Extensionの導入"></a>Python用Extensionの導入</h2><p>あまり言うまでもないかもしれませんが、 <code>Python ms-python.python</code> を導入し、有効化します。</p><p><img src="/images/20200820/image.png" alt=""></p><h2 id="setting-jsonの記述"><a href="#setting-jsonの記述" class="headerlink" title="setting.jsonの記述"></a>setting.jsonの記述</h2><p>File-&gt;Preference-&gt;Settingsと開きます。</p><p><img src="/images/20200820/%E7%84%A1%E9%A1%8C.png" alt=""></p><p>Workspaceを選択し、 <code>settings.json</code> を開きます。</p><p><img src="/images/20200820/%E7%84%A1%E9%A1%8C2.png" alt=""></p><p>次のような感じで記載します。</p><figure class="highlight json"><figcaption><span>settings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// pythonの環境設定</span></span><br><span class="line">    <span class="attr">"python.pythonPath"</span>: <span class="string">".venv/bin/python"</span>,</span><br><span class="line">    <span class="attr">"python.venvPath"</span>: <span class="string">".venv"</span>,</span><br><span class="line">    <span class="comment">// Linterの設定</span></span><br><span class="line">    <span class="attr">"python.linting.pylintEnabled"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"python.linting.flake8Enabled"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"python.linting.mypyEnabled"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"python.linting.lintOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"python.linting.flake8Args"</span>: [</span><br><span class="line">      <span class="string">"--max-line-length"</span>,</span><br><span class="line">      <span class="string">"88"</span>,</span><br><span class="line">      <span class="string">"--ignore=E203,W503,W504"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// Formatterの設定</span></span><br><span class="line">    <span class="attr">"python.formatting.provider"</span>: <span class="string">"black"</span>,</span><br><span class="line">    <span class="attr">"editor.formatOnSave"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"editor.formatOnPaste"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>あとは、VSCodeをReload（再起動）してください。<br>これで、開発中に <code>black</code>, <code>flake8</code>, <code>mypy</code> が動作します。</p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>ここまで作成したコードについては、<a href="https://github.com/montblanc18/mypackage" target="_blank" rel="noopener">こちら</a>で公開していますので、必要に応じてご覧ください。</p><p>自作したパッケージをPyPIに登録することをしようとすると、 <code>setup.py</code> で固めて <code>twine</code> でアップロードして、などの工程が発生しますが、それらのやり方はインターネット上でいろいろな方が行われているため、ここでは割愛します。</p><p>また、これでテスト環境が整いましたので、例えばCircleCIなどに乗せて自動テストできるようにすることもできます。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは。TIG/DXチームの栗田です。&lt;a href=&quot;https://future-architect.github.
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Python" scheme="https://future-architect.github.io/tags/Python/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="pytest" scheme="https://future-architect.github.io/tags/pytest/"/>
    
      <category term="tox" scheme="https://future-architect.github.io/tags/tox/"/>
    
      <category term="pip" scheme="https://future-architect.github.io/tags/pip/"/>
    
  </entry>
  
  <entry>
    <title>Firebaseでお手軽！データ管理画面をつくる</title>
    <link href="https://future-architect.github.io/articles/20200819/"/>
    <id>https://future-architect.github.io/articles/20200819/</id>
    <published>2020-08-18T15:00:00.000Z</published>
    <updated>2020-08-19T00:56:59.058Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは！2017年9月入社の柏木です。<a href="https://future-architect.github.io/articles/20200726/">夏休み自由研究連載</a>13日目の記事です！🏖️</p><p>昨日は<a href="https://future-architect.github.io/articles/20200818/">【入門】私を苦しめたDynamoDB</a>という読み応えたっぷりの記事でした。<br>今回は、Firebaseを使って画面を開発してみようと思います。</p><h1 id="本記事のゴール"><a href="#本記事のゴール" class="headerlink" title="本記事のゴール"></a>本記事のゴール</h1><p>下記を最短経路で作ってみます。<br>システムアドミンの人が使うようなマスタデータ管理画面を想定して、限られたユーザーにアクセスを制限すべく、認証機能も入れました。</p><ul><li>Typescript×Reactのアプリを立ち上げる</li><li>Firebaseのデータベース（Firestore）にデータを用意する</li><li>Firebase Hostingを用いてデプロイする</li><li>Firestoreに格納されているデータを画面に表示する</li><li>Firebase Authenticationで認証する</li></ul><h1 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h1><ul><li>macOS Catalina (v10.15.6)</li><li>Node.js (v14.8.0)</li></ul><h1 id="実践"><a href="#実践" class="headerlink" title="実践"></a>実践</h1><h3 id="Typescript×Reactのアプリを立ち上げる"><a href="#Typescript×Reactのアプリを立ち上げる" class="headerlink" title="Typescript×Reactのアプリを立ち上げる"></a>Typescript×Reactのアプリを立ち上げる</h3><p>環境構築の手間を劇的に削減できる<code>creat-react-app</code>を利用します。今回はtypescriptで実装したいので、オプションをつけてインストールしました。<code>npm start</code>で画面が立ち上がります。</p><figure class="highlight plain"><figcaption><span>~</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npx create-react-app summer-vacation --typescript</span><br><span class="line">$ cd summer-vacation</span><br><span class="line">$ npm start</span><br></pre></td></tr></table></figure><p><img src="/images/20200819/image.png" alt=""></p><h3 id="Firebaseのデータベース（Firestore）にデータを用意する"><a href="#Firebaseのデータベース（Firestore）にデータを用意する" class="headerlink" title="Firebaseのデータベース（Firestore）にデータを用意する"></a>Firebaseのデータベース（Firestore）にデータを用意する</h3><p>続いてデータを作成します。<br>まず、Firebase上に自身のプロジェクトを作成します。Googleのアカウントがあれば、誰でもFirebaseを始めることができます。<a href="https://console.firebase.google.com/u/0/?hl=ja" target="_blank" rel="noopener">Firebaseコンソール</a>にアクセスし、「プロジェクトを追加」から指示に沿って設定を行うと、プロジェクトの作成完了です。</p><p>次に、画面に表示したいデータを作成します。<br>FirebaseにはFirestoreとRealtime Database、２つのデータベース機能が用意されています。違いは<a href="https://techblog.kayac.com/rtdb-vs-firestore" target="_blank" rel="noopener">こちらの記事</a>にわかりやすく書いてありました。今回は簡易なデータ構造なのでどちらでも問題ないですが、名前がかっこいいので前者を用います。</p><p>ブラウザ上でぽこぽこデータを投入し、準備完了です！<br><img src="/images/20200819/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-18_23.31.40.png" alt=""></p><h3 id="Firebase-Hostingを用いてデプロイする"><a href="#Firebase-Hostingを用いてデプロイする" class="headerlink" title="Firebase Hostingを用いてデプロイする"></a>Firebase Hostingを用いてデプロイする</h3><p>ホスティングが簡単にできると話題のFirebase Hostingを用いて、下記手順でアプリのデプロイを行います。</p><h4 id="1-Firebaseに自分のアプリを登録する"><a href="#1-Firebaseに自分のアプリを登録する" class="headerlink" title="1. Firebaseに自分のアプリを登録する"></a>1. Firebaseに自分のアプリを登録する</h4><p>まずは、Firebaseからアプリが利用するプロジェクトの情報を取得できるようにします。<br>歯車アイコンから設定画面に遷移し、「アプリを追加」の作業を行います。今回はweb画面なので、プラットフォームにwebを選択し、summer-vacationのアプリ名で追加します。設定が完了するとこのように、アプリで使用するconfig情報が取得できるようになりました！<br><img src="/images/20200819/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-18_23.29.57.png" alt=""></p><h4 id="2-アプリにFirebaseの設定を組み込む"><a href="#2-アプリにFirebaseの設定を組み込む" class="headerlink" title="2. アプリにFirebaseの設定を組み込む"></a>2. アプリにFirebaseの設定を組み込む</h4><p>2で取得した情報を作成したReactのアプリに紐付けます。ただこの情報は公開したくないので、環境変数として渡すようにします。<br>create-react-appにはdotenvの機能も組み込まれているので、<code>.env</code>ファイルをレポジトリ直下に作成し、先ほどの情報を環境変数として定義します。create-react-appのルールで、変数のプレフィックスに<code>REACT_APP_</code>を使用しないと認識してくれないので注意が必要です。設定を行った後は、<code>npm start</code> を再実行し、コンパイルし直します。</p><p>続いて、firebaseのライブラリをインストールします。</p><figure class="highlight plain"><figcaption><span>~/summer-vacation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install firebase --save</span><br></pre></td></tr></table></figure><p>最後にFirebaseとの紐付けを行います。ここで設定した環境変数を埋め込みます。</p><figure class="highlight js"><figcaption><span>firebase/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> firebase <span class="keyword">from</span> <span class="string">'firebase'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> env = process.env;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> firebaseConfig = &#123;</span><br><span class="line">    apiKey: env.REACT_APP_API_KEY,</span><br><span class="line">    authDomain: env.REACT_APP_AUTH_DOMAIN,</span><br><span class="line">    databaseURL: env.REACT_APP_DATABASE_URL,</span><br><span class="line">    projectId: env.REACT_APP_PROJECT_ID,</span><br><span class="line">    storageBucket: env.REACT_APP_STORAGE_BUCKET,</span><br><span class="line">    messagingSenderId: env.REACT_APP_MESSAGING_SENDER_ID,</span><br><span class="line">    appId: env.REACT_APP_APP_ID,</span><br><span class="line">    measurementId: env.REACT_APP_MEASUREMENT_ID,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Firebaseを紐付け、初期化</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> firebaseApp = firebase.initializeApp(firebaseConfig);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Firestoreのインスタンス作成</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> firebaseStore = firebaseApp.firestore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> firebase;</span><br></pre></td></tr></table></figure><h4 id="3-デプロイコマンドを実行できるようにする"><a href="#3-デプロイコマンドを実行できるようにする" class="headerlink" title="3. デプロイコマンドを実行できるようにする"></a>3. デプロイコマンドを実行できるようにする</h4><p>最後に、ローカル環境からデプロイできるようにします。<br><a href="https://firebase.google.com/docs/cli?hl=ja#mac-linux-npm" target="_blank" rel="noopener">公式ドキュメント</a>の手順に沿ってfirebaseコマンドラインツールをローカル環境にインストールします。<br>ログインし、自身のGoogleアカウントと紐づけてプロジェクト一覧を確認すると、先ほど作成したプロジェクトが表示されました！</p><figure class="highlight plain"><figcaption><span>~/summer-vacation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g firebase-tools</span><br><span class="line">$ firebase login</span><br><span class="line">$ firebase projects:list</span><br><span class="line">✔ Preparing the list of your Firebase projects</span><br><span class="line">┌──────────────────────┬───────────────────────┬────────────────┬──────────────────────┐</span><br><span class="line">│ Project Display Name │ Project ID            │ Project Number │ Resource Location ID │</span><br><span class="line">├──────────────────────┼───────────────────────┼────────────────┼──────────────────────┤</span><br><span class="line">│ summer-vacation      │ summer-vacation-xxxxx │ xxxxxxxxxxxx   │ asia-northeast1      │</span><br><span class="line">└──────────────────────┴───────────────────────┴────────────────┴──────────────────────┘</span><br></pre></td></tr></table></figure><p>firebaseコマンドで初期化のコマンドを実行すると対話式で諸々の設定を行えます。</p><figure class="highlight plain"><figcaption><span>~/summer-vacation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ firebase init</span><br><span class="line">...</span><br><span class="line">✔  Firebase initialization complete!</span><br></pre></td></tr></table></figure><p>今回カスタマイズしたのは下記項目です。<br>ビルド実行時にreact-scriptsコマンドがモジュールを出力するのが<code>build</code>ディレクトリなので、public directoryは<code>build</code>配下を指定します。</p><ul><li>summer-vactionのプロジェクトを利用</li><li>Hostingのサービス、Cloud Firestoreを利用</li><li>public directoryに <code>build</code>を指定</li><li>SPAとして利用</li></ul><p>この状態でビルドし、デプロイします。<br>コマンドに表示されたURLにアクセスすると、画面が表示されました！</p><figure class="highlight plain"><figcaption><span>~/summer-vacation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ npm run build</span><br><span class="line">$ firebase deploy</span><br><span class="line">...</span><br><span class="line">✔  Deploy complete!</span><br><span class="line">Hosting URL: https:&#x2F;&#x2F;example.web.app</span><br></pre></td></tr></table></figure><p><img src="/images/20200819/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-18_23.19.09.png" alt=""></p><h3 id="Firestoreに格納されているデータを画面に表示する"><a href="#Firestoreに格納されているデータを画面に表示する" class="headerlink" title="Firestoreに格納されているデータを画面に表示する"></a>Firestoreに格納されているデータを画面に表示する</h3><p>いよいよFirestoreにアクセスしてみましょう！<br>先ほどインストールしたfirebaseのライブラリを使用して、Firestoreに格納したユーザーの名称を表示します。<br>React Hooksの<code>useEffect</code>を使って、初期描画後にデータ取得するメソッドを実行します。</p><figure class="highlight ts"><figcaption><span>App.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">const</span> [loading, setLoading] = useState(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> [users, setUsers] = useState&lt;firebase.firestore.DocumentData[]&gt;([]);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> searchUsers = <span class="keyword">async</span>() =&gt; &#123;</span><br><span class="line">      <span class="comment">// Firestoreのコレクションを指定してデータ取得。今回は全量を検索</span></span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> fireStore.collection(<span class="string">'users'</span>).get();</span><br><span class="line">      <span class="keyword">if</span> (res.empty) <span class="keyword">return</span> [];</span><br><span class="line">      <span class="keyword">const</span> userList: firebase.firestore.DocumentData[] = [];</span><br><span class="line">      <span class="comment">// DocumentData型にはmapメソッドが定義されていないため、forEachのループでデータを加工</span></span><br><span class="line">      res.forEach(<span class="function"><span class="params">doc</span> =&gt;</span> &#123;</span><br><span class="line">          userList.push(doc.data());</span><br><span class="line">      &#125;)</span><br><span class="line">      setUsers(userList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    searchUsers();</span><br><span class="line">    setLoading(<span class="literal">false</span>);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><p>なんとライブラリ組み込みのメソッドを使用するだけで、簡単にFirestoreとの疎通、データ取得が実現できてしまいました。とってもお手軽ですね！</p><p><img src="/images/20200819/image_2.png" alt=""></p><h3 id="Firebase-Authenticationで認証する"><a href="#Firebase-Authenticationで認証する" class="headerlink" title="Firebase Authenticationで認証する"></a>Firebase Authenticationで認証する</h3><p>最後に、自身以外のアクセスをコントロールする仕組みも追加しておきます。<br>Firebaseの認証機能を簡単にクライアントに実装できる<code>react-firebaseui</code>を利用します。</p><h3 id="1-Firebase-Authenticationで認証方法を登録する"><a href="#1-Firebase-Authenticationで認証方法を登録する" class="headerlink" title="1. Firebase Authenticationで認証方法を登録する"></a>1. Firebase Authenticationで認証方法を登録する</h3><p>コンソールの設定画面から、「ログイン方法を設定」します。<br><img src="/images/20200819/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-18_23.20.20.png" alt=""></p><p>私はGoogleアカウントの認証を使用することにしました。<br><img src="/images/20200819/image_3.png" alt=""></p><h3 id="２-アクセスを制御する仕組みを実装する"><a href="#２-アクセスを制御する仕組みを実装する" class="headerlink" title="２. アクセスを制御する仕組みを実装する"></a>２. アクセスを制御する仕組みを実装する</h3><p>最初に、ホワイトリストとなるメールアドレスを環境変数に追加します。</p><figure class="highlight plain"><figcaption><span>.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REACT_APP_VALID_MAIL_ADDRESSES&#x3D;firebaseapp@example.com</span><br></pre></td></tr></table></figure><p>次に画面にログイン機能を実装します。認証画面を用意してくれるライブラリを使い、手間を省きます。</p><figure class="highlight plain"><figcaption><span>~/summer-vacation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save react-firebaseui</span><br></pre></td></tr></table></figure><p>先ほどと同じApp.tsxに実装を組み込みます。</p><figure class="highlight ts"><figcaption><span>App.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [myAccount, setMyAccount] = useState&lt;firebase.User&gt;();</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> searchUsers = <span class="keyword">async</span>() =&gt; &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    firebase.auth().onAuthStateChanged(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">      setLoading(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (!user) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">if</span> (user.email !== process.env.REACT_APP_VALID_MAIL_ADDRESSES) <span class="keyword">return</span>;</span><br><span class="line">      setMyAccount(user);</span><br><span class="line">      searchUsers();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><p><code>npm start</code> で起動すると、アカウント認証画面が表示されました！<br><img src="/images/20200819/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-18_23.22.08.png" alt=""></p><p>これで、Googleアカウントのメールアドレスが<code>.env</code>に定義したものと異なる場合、アクセスを弾くことができます。</p><p>コードの全量はこちらです。</p><figure class="highlight ts"><figcaption><span>App.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./App.css'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// firebase functions</span></span><br><span class="line"><span class="keyword">import</span> firebase <span class="keyword">from</span> <span class="string">'firebase'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;fireStore&#125; <span class="keyword">from</span> <span class="string">'./firebase/index'</span></span><br><span class="line"><span class="keyword">import</span> StyledFirebaseAuth <span class="keyword">from</span> <span class="string">'react-firebaseui/StyledFirebaseAuth'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = useState(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> [users, setUsers] = useState&lt;firebase.firestore.DocumentData[]&gt;([]);</span><br><span class="line">  <span class="keyword">const</span> [myAccount, setMyAccount] = useState&lt;firebase.User&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> uiConfig = &#123;</span><br><span class="line">    signInFlow: <span class="string">'popup'</span>,</span><br><span class="line">    signInSuccessUrl: <span class="string">'/'</span>,</span><br><span class="line">    signInOptions: [</span><br><span class="line">        firebase.auth.GoogleAuthProvider.PROVIDER_ID,</span><br><span class="line">    ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> searchUsers = <span class="keyword">async</span>() =&gt; &#123;</span><br><span class="line">      <span class="comment">// Firestoreのコレクションを指定してデータ取得</span></span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> fireStore.collection(<span class="string">'users'</span>).get();</span><br><span class="line">      <span class="keyword">if</span> (res.empty) <span class="keyword">return</span> [];</span><br><span class="line">      <span class="keyword">const</span> userList: firebase.firestore.DocumentData[] = [];</span><br><span class="line">      <span class="comment">// DocumentData型にはmapメソッドが定義されていないため、forEachのループでデータを加工</span></span><br><span class="line">      res.forEach(<span class="function"><span class="params">doc</span> =&gt;</span> &#123;</span><br><span class="line">          userList.push(doc.data());</span><br><span class="line">      &#125;)</span><br><span class="line">      setUsers(userList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    firebase.auth().onAuthStateChanged(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">      setLoading(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (!user) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">if</span> (user.email !== process.env.REACT_APP_VALID_MAIL_ADDRESSES) <span class="keyword">return</span>;</span><br><span class="line">      setMyAccount(user);</span><br><span class="line">      searchUsers();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;header className=<span class="string">"App-header"</span>&gt;</span><br><span class="line">        &#123;loading ? (</span><br><span class="line">                  &lt;p&gt;</span><br><span class="line">                  LOADING.....</span><br><span class="line">                &lt;<span class="regexp">/p&gt; </span></span><br><span class="line"><span class="regexp">        ) : !myAccount ? (</span></span><br><span class="line"><span class="regexp">          &lt;p&gt;</span></span><br><span class="line"><span class="regexp">            ログインが必要です</span></span><br><span class="line"><span class="regexp">          &lt;StyledFirebaseAuth uiConfig=&#123;uiConfig&#125; firebaseAuth=&#123;firebase.auth()&#125; /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        ) : </span></span><br><span class="line"><span class="regexp">          users.map((user, index) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">            return &lt;p key=&#123;index&#125;&gt; &#123;user.name&#125;&lt;/</span>p&gt;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;<span class="regexp">/header&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>認証機能を含めた画面の開発がいとも簡単にできてしまいました。（環境構築のコマンドは確認含めたったの11行！）<br>Firebaseは本当に偉大でした。<br>アプリ作るってなんだか大変そう…と思ってる方の印象が少しでも変われば幸いです。<br>使いこなせばもっといろんなことができそうなので、引き続き触ってみたいと思います！<br>以上です。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://firebase.google.com/docs/web/setup#node.js-%E3%82%A2%E3%83%97%E3%83%AA" target="_blank" rel="noopener">https://firebase.google.com/docs/web/setup#node.js-%E3%82%A2%E3%83%97%E3%83%AA</a></li><li><a href="https://qiita.com/kazushikawamura/items/58ea222b3cc289882d79" target="_blank" rel="noopener">https://qiita.com/kazushikawamura/items/58ea222b3cc289882d79</a></li><li><a href="https://qiita.com/cola119/items/99350f2c34c51378777e" target="_blank" rel="noopener">https://qiita.com/cola119/items/99350f2c34c51378777e</a></li><li><a href="https://dev.to/adriantwarog/deno-react-using-create-react-app-with-deno-5fpj" target="_blank" rel="noopener">https://dev.to/adriantwarog/deno-react-using-create-react-app-with-deno-5fpj</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは！2017年9月入社の柏木です。&lt;a href=&quot;https://future-architect.github.
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="TypeScript" scheme="https://future-architect.github.io/tags/TypeScript/"/>
    
      <category term="Frontend" scheme="https://future-architect.github.io/tags/Frontend/"/>
    
      <category term="React" scheme="https://future-architect.github.io/tags/React/"/>
    
      <category term="Firebase" scheme="https://future-architect.github.io/tags/Firebase/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
  </entry>
  
  <entry>
    <title>【入門】私を苦しめたDynamoDB</title>
    <link href="https://future-architect.github.io/articles/20200818/"/>
    <id>https://future-architect.github.io/articles/20200818/</id>
    <published>2020-08-17T15:00:00.000Z</published>
    <updated>2020-08-18T13:11:29.700Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200818/top.png" class="img-middle-size"><p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>12本目の記事です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして。TIG DXユニットの富山です。2020年4月新卒入社です。</p><p>夏休み自由研究連載の11本目の記事で公開された<a href="https://future-architect.github.io/articles/20200817/">Slack×GASの日報テンプレBOTを実務に導入してみた</a>の執筆者である仁木さんと同期です。</p><p>私が参画しているプロジェクトでは、データベースにDynamoDBを採用しています。私は、RDBMSしか使用した経験がなかったので、NoSQLであるDynamoDBの理解にとても苦しみました。そこで今回の夏休み自由研究では理解した内容をまとめてみたいと思います！</p><h1 id="つまったポイントサマリ―"><a href="#つまったポイントサマリ―" class="headerlink" title="つまったポイントサマリ―"></a>つまったポイントサマリ―</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- DB &#x3D; RDBMSという固定概念を取り除くこと</span><br><span class="line">- KVS(NoSQL)の概念の理解</span><br><span class="line">- CRUD操作（特にR）</span><br></pre></td></tr></table></figure><p>これらが理解できるような記事を目指します。</p><h1 id="DynamoDBとは"><a href="#DynamoDBとは" class="headerlink" title="DynamoDBとは"></a>DynamoDBとは</h1><p><a href="https://aws.amazon.com/jp/dynamodb/" target="_blank" rel="noopener">公式ドキュメント</a>によると、</p><blockquote><p>Amazon DynamoDB は、規模に関係なく数ミリ秒台のパフォーマンスを実現する、key-value およびドキュメントデータベースです。完全マネージド型マルチリージョン、マルチマスターで耐久性があるデータベースで、セキュリティ、バックアップおよび復元と、インターネット規模のアプリケーション用のメモリ内キャッシュが組み込まれています。DynamoDB は、1 日に 10 兆件以上のリクエストを処理することができ、毎秒 2,000 万件を超えるリクエストをサポートします。</p></blockquote><p>とのことです。とりあえずすごいと言うことはわかりました。<br>ざっくりと、AWSが提供するkey-value型のハイパフォーマンスNoSQLフルマネージドサービスです。</p><h1 id="NoSQLとは"><a href="#NoSQLとは" class="headerlink" title="NoSQLとは"></a>NoSQLとは</h1><p>そもそもNoSQLとは何者でしょうか。次世代的な響きがしてカッコいいですよね。<br>わたしはDynamoDBを触り始める以前、Yes/NoのNoSQLだと思っていましたが、 <code>Not Only SQL</code> の略称です。NoSQLについてWikipediaから冒頭の説明文を引用してみましょう。</p><blockquote><p>NoSQL（一般に “Not only SQL” と解釈される）とは、関係データベース管理システム (RDBMS) 以外のデータベース管理システムを指すおおまかな分類語である。関係データベースを杓子定規に適用してきた長い歴史を打破し、それ以外の構造のデータベースの利用・発展を促進させようとする運動の標語としての意味合いを持つ。</p></blockquote><p>つまり、RDBMS以外のDBシステムを指す大まかな定義の単語のようです。<br>一口にNoSQLといってもデータ形式の格納方式の違いで様々なタイプのNoSQLが存在します。大きくは下記3つに分類されます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. KVS (Key-Value-Store)</span><br><span class="line">2. ドキュメントDB</span><br><span class="line">3. グラフDB</span><br></pre></td></tr></table></figure><p>DynamoDBは<code>KVS</code>のNoSQLに該当します。</p><h1 id="RDBMSとの志向の違い"><a href="#RDBMSとの志向の違い" class="headerlink" title="RDBMSとの志向の違い"></a>RDBMSとの志向の違い</h1><p>RDBMSとNoSQLは異なる志向を持ちます。RDBMSはACID（Atomicity、Consistency、Isolation、Durability）という特性で語られます。ざっくりと、トランザクションにおいて持つべき4つの特性（原子性/一貫性/独立性/永続性）を表現したものです。</p><p>それに対して、NoSQLはBASE（Basically Available、Soft-State、Eventual Consistency）特性という特徴で語られます。<br>ざっくりと、<strong>「基本的には常に利用可能で、常に整合性を保っている必要はなく、一時的に一貫性のない状態を許容して、結果的には整合性が取れている状態に至る」</strong> というものです。ACIDとは対照的に、可用性や性能を重視した分散システムの特性です。</p><p>ということは、「DynamoDBでトランザクション制御はできないの？」とお考えの方もいらっしゃると思います。後述します。</p><p>余談ですが、ACID(酸）に対して、BASE(塩基）とはめちゃくちゃイケてるネーミングですね。</p><h1 id="DynamoDBの特徴"><a href="#DynamoDBの特徴" class="headerlink" title="DynamoDBの特徴"></a>DynamoDBの特徴</h1><h3 id="高可用性"><a href="#高可用性" class="headerlink" title="高可用性"></a>高可用性</h3><p>DynamoDBでは高可用性を重視しています。具体的には3つのAZ(Availability Zone)でレプリケーションを持っています。そのためAZに問題が起きても、他のAZが機能するため耐久性・信頼性が担保されています。</p><h3 id="フルマネージド"><a href="#フルマネージド" class="headerlink" title="フルマネージド"></a>フルマネージド</h3><p>データ容量の増加に応じたディスクやノードの増設作業をはじめ、メンテナンスが不要です。テーブルを自動的にスケールアップ/ダウンして容量を調整し、パフォーマンスを維持してくれます。</p><h3 id="SQLクエリを直接はサポートしていない"><a href="#SQLクエリを直接はサポートしていない" class="headerlink" title="SQLクエリを直接はサポートしていない"></a>SQLクエリを直接はサポートしていない</h3><p>NoSQLとだけあってSQLを直接サポートされていません。そのためテーブルの結合も行えません。（<a href="https://qiita.com/hieki/items/8899378dd76f97697100" target="_blank" rel="noopener">DQLなど、SQLライクに書けるラッパー</a>は存在します。）<br>シンプルなCRUDに対しては非常に有効ですが、複雑なものが不得意なのかもしれません。</p><h1 id="DynamoDBを触る上で抑えておくべきポイント"><a href="#DynamoDBを触る上で抑えておくべきポイント" class="headerlink" title="DynamoDBを触る上で抑えておくべきポイント"></a>DynamoDBを触る上で抑えておくべきポイント</h1><p>下記のテーブル構造を例に説明していきます。ペットショップのペット管理用DBです。（笑）<br><img src="/images/20200818/Screen_Shot_2020-08-17_at_0.30.30.png" alt=""></p><h2 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h2><p>DynamoDBには、いくつかの独自概念が登場します。<br>イメージ的に、RDBMSの既存概念と似ているものがあるので表にしてみました。</p><table><thead><tr><th>DynamoDB</th><th>RDBMS</th></tr></thead><tbody><tr><td>Table</td><td>Table</td></tr><tr><td>Item</td><td>Row</td></tr><tr><td>Attributes</td><td>Column</td></tr><tr><td>Partition Key</td><td>Primary Key</td></tr><tr><td>Sort Key</td><td>指定する場合はPrimary Keyを構成する一部になる</td></tr></tbody></table><p>今回の例だと、このようになります。<br><img src="/images/20200818/Screen_Shot_2020-08-17_at_1.45.33.png" alt=""><br>ポイントとして、Itemは正規化の必要が無い点です。つまり異なるItemで同名のAttributeを持つ必要はありません。また、 <code>detail</code> のようにAttributeにネストしたデータ構造を持たせることも可能です。</p><p>Table、Item、Attributeに関してはある程度理解が出来ると思います。</p><h3 id="パーティションキーとソートキー"><a href="#パーティションキーとソートキー" class="headerlink" title="パーティションキーとソートキー"></a>パーティションキーとソートキー</h3><p>DynamoDBを触る上で絶対に抑えて置かなければならない概念に、パーティションキー（別称：ハッシュキー）とソートキー（別称：レンジキー）が挙げられます。<br>パーティションーキー、もしくはパーティションキーとソートキーによってユニークなItemを表現します。<br>DynamoDBでは、Itemを内部的にパーティションごとに分散して保持しています。パーティションキーは内部的にハッシュ関数が実行され、ハッシュ文字列が生成されます。生成されたハッシュ文字列をもとに、Itemの格納場所が決まります。そのためパーティションキーは必須です。<br>ソートキーでは範囲指定やソートが可能です。（ <code>shop_id</code> をソートキーにするべきかは見逃してください）そのため、ソートキー以外のAttributeでのOrder byは不可能です。ソートキーの設定は必須ではありません。</p><h3 id="Secondary-Index"><a href="#Secondary-Index" class="headerlink" title="Secondary Index"></a>Secondary Index</h3><p>先程パーティションキーとソートキーについて説明をしましたが、Secondary Indexはプライマリキー以外の属性を使用する際に登場する概念です。<br>Secondary Indexには、<code>LSI</code>と<code>GSI</code>という2つの概念が存在します。</p><h4 id="LSI"><a href="#LSI" class="headerlink" title="LSI"></a>LSI</h4><p><code>Local Secondary Index</code> の頭文字を取っています。LSIは、ソートキー以外での絞り込みを行うキーを設定できるものです。<br>例でいうと、<code>birth</code> をLSIに設定した場合、 <code>pet_id</code> + <code>birth</code> のような検索ができるようになります。<br>注意点として、LSIは既存のテーブルに追加・削除はできません。テーブル作成時に定義するようにしましょう。</p><h4 id="GSI"><a href="#GSI" class="headerlink" title="GSI"></a>GSI</h4><p><code>Grobal Secondary Index</code> の頭文字を取っています。GSIは、パーティションキーを別途設定できるものです。<br>例でいうと、<code>kind</code>でdogのItemを取得したい際に、 <code>kind</code>をGSIに設定することで検索が容易にできるようになります。<br>LSIと異なり、既存のテーブルに追加・削除できます。<br>しかし、GSIを1つ定義すると、テーブルが1つ増えるのと同等のコスト増しになります。</p><h2 id="DynamoDBでトランザクション制御は可能なのか"><a href="#DynamoDBでトランザクション制御は可能なのか" class="headerlink" title="DynamoDBでトランザクション制御は可能なのか"></a>DynamoDBでトランザクション制御は可能なのか</h2><p>可能です。詳細については<a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/transaction-apis.html" target="_blank" rel="noopener">公式Docs</a>をご参照ください。<br>単一のAWSアカウントおよび領域内の複数のテーブルにわたって、ACIDを提供しています。<br>ここではDynamoDBにおけるトランザクション制御の特徴を挙げます。</p><h4 id="DynamoDBにおけるトランザクション制御についての特徴"><a href="#DynamoDBにおけるトランザクション制御についての特徴" class="headerlink" title="DynamoDBにおけるトランザクション制御についての特徴"></a>DynamoDBにおけるトランザクション制御についての特徴</h4><ul><li>複数テーブルに対して制御できる</li><li>トランザクションに含められるのは25件まで(記事執筆時点(2020/08/17))</li><li>テーブルのロックはされない<ul><li>もし、トランザクション中に他操作が入った場合、トランザクションは中止されて例外が返ってきます。</li></ul></li><li>同一Itemに対して操作はできない</li><li>全ての商用リージョンで利用可能</li></ul><h2 id="プログラムからどのように触るのか"><a href="#プログラムからどのように触るのか" class="headerlink" title="プログラムからどのように触るのか"></a>プログラムからどのように触るのか</h2><p><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/CodeSamples.html" target="_blank" rel="noopener">aws-sdk</a>が公開されています。主要なサーバサイドの言語はサポートされているのではないでしょうか。</p><p>FutureのDXユニットではGoを積極的に使う文化があります。私もGopherの仲間入りを果たしました。<br>もちろん<a href="https://aws.amazon.com/jp/sdk-for-go/" target="_blank" rel="noopener">Goのsdk</a>も公開されています。また、ラッパーされたライブラリもいくつかあります。<br>詳しくは私の先輩方の最高に分かりやすい記事をご覧いただければと思います。CRUD操作のサンプルコードが書かれており、大変参考になります。<br><a href="https://future-architect.github.io/articles/20200225/">DynamoDB×Go連載#1 GoでDynamoDBでおなじみのguregu/dynamoを利用する</a><br><a href="https://future-architect.github.io/articles/20200227/">DynamoDB×Go連載#2 AWS SDKによるDynamoDBの基本操作</a></p><h2 id="よく触るItem操作まとめ"><a href="#よく触るItem操作まとめ" class="headerlink" title="よく触るItem操作まとめ"></a>よく触るItem操作まとめ</h2><p>私的によく触るItemの操作APIをまとめます。<br>様々な操作APIが存在するので、どのAPIを使用すると何が出来るのかを把握するのに苦戦しました。</p><h4 id="読み込み"><a href="#読み込み" class="headerlink" title="読み込み"></a>読み込み</h4><table><thead><tr><th>API</th><th>できること</th></tr></thead><tbody><tr><td>GetItem</td><td>ユニークキーを指定してデータが１つ取得</td></tr><tr><td>TransactGetItems</td><td>トランザクションにて最大25件取得</td></tr><tr><td>BatchGetItem</td><td>最大100アイテム (ただし、16MBを超えないアイテム数) を並列で取得</td></tr><tr><td>Query</td><td>特定のパーティションキーがあるすべての項目を取得</td></tr><tr><td>Scan</td><td>すべての項目(1度の操作で最大1MB。それを超えたらLastEvaluatedKeyを指定して再読み取りが必要)のデータを取得。（<a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/Scan.html" target="_blank" rel="noopener">filter式あり</a>）</td></tr></tbody></table><h4 id="書き込み"><a href="#書き込み" class="headerlink" title="書き込み"></a>書き込み</h4><table><thead><tr><th>API</th><th>できること</th></tr></thead><tbody><tr><td>PutItem</td><td>Itemの登録</td></tr><tr><td>Update</td><td>Itemの更新</td></tr><tr><td>TransactWriteItems</td><td>トランザクションにてCreate, Update, Delete制御</td></tr><tr><td>BatchWriteItem</td><td>最大25件のバッチ処理(入力/削除)。(最大1MB)</td></tr><tr><td>Delete</td><td>Itemの削除</td></tr></tbody></table><h2 id="DynamoDBを触るうえでの注意点"><a href="#DynamoDBを触るうえでの注意点" class="headerlink" title="DynamoDBを触るうえでの注意点"></a>DynamoDBを触るうえでの注意点</h2><p>最後に、実際に触ってみて「独特だなぁ」と感じた部分について記載します。</p><ul><li>パーティションキーやソートキーに空文字は入れられない</li><li>タイムスタンプの概念が存在しないので、文字列での登録が必要（日付型自体はサポートされています。ソートキーとして定義した場合、日付のソート等は可能です。詳しいデータ型に関しては<a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html" target="_blank" rel="noopener">こちら</a>をご参照ください。）</li><li>テーブルの結合ができない</li><li>基本的にAPI経由で触る</li><li>AWSのクレデンシャル情報で認証</li></ul><h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>今回は自由研究ということで、DynamoDB未経験だった私が詰まったポイントを踏まえ入門編としてまとめてみました。<br>個人的な感想として、DynamoDBはキー設計がとても重要だと感じました。今後、もっと踏み込んだ記事も執筆していけたらと思います！</p><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="https://aws.amazon.com/jp/dynamodb/" target="_blank" rel="noopener">AWS DynamoDB公式Docs</a><br><a href="https://www.youtube.com/watch?v=16RYHfe89WY" target="_blank" rel="noopener">Amazon DynamoDB Deep Dive | AWS Summit Tokyo 2019</a><br><a href="https://www.slideshare.net/AmazonWebServicesJapan/20150805-aws-blackbeltdynamodb?next_slideshow=1" target="_blank" rel="noopener">AWS Black Belt Tech シリーズ 2015 - Amazon DynamoDB</a><br><a href="https://masawan-guitar.hatenablog.com/entry/2016/08/14/163447" target="_blank" rel="noopener">「RDBMS」と「NoSQL」の比較</a><br><a href="https://ja.wikipedia.org/wiki/NoSQL" target="_blank" rel="noopener">NoSQL wikipedia</a><br><a href="https://dev.classmethod.jp/articles/amazon-dynamodb-comparison-with-rds/" target="_blank" rel="noopener">コンセプトから学ぶAmazon DynamoDB【Amazon RDSとの比較篇】</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200818/top.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチャー夏休み自由
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="AWS" scheme="https://future-architect.github.io/tags/AWS/"/>
    
      <category term="DataModel" scheme="https://future-architect.github.io/tags/DataModel/"/>
    
      <category term="DynamoDB" scheme="https://future-architect.github.io/tags/DynamoDB/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
  </entry>
  
  <entry>
    <title>Slack×GASの日報テンプレBOTを実務に導入してみた</title>
    <link href="https://future-architect.github.io/articles/20200817/"/>
    <id>https://future-architect.github.io/articles/20200817/</id>
    <published>2020-08-16T15:00:00.000Z</published>
    <updated>2020-08-17T01:53:06.435Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>11本目の記事です</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIGメディアユニットの仁木です。Slackに投稿するための日報をBOT化・自動化したので自由研究企画に混ぜてもらい記事にすることにしました。毎日共通で書かなければいけないタイトルなどの固定項目やスケジュールの記載を自動化することで、作成時間を短縮し、重要な部分に時間を割けるようになりました。<br><img src="/images/20200817/%E3%81%AF%E3%81%97%E3%82%99%E3%82%81_%E3%82%A2%E3%83%BC%E3%83%88%E3%83%9B%E3%82%99%E3%83%BC%E3%83%88%E3%82%99_1.png" alt=""></p><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>Googleスプレットシート及びGoogleカレンダーの情報を利用して、日報として整形するスクリプトをスプレットシートのスクリプト機能を利用して書いた後、SlackのIncoming WebhookのURLにリクエストを送信します。<br><img src="/images/20200817/%E6%A6%82%E8%A6%81_%E3%82%A2%E3%83%BC%E3%83%88%E3%83%9B%E3%82%99%E3%83%BC%E3%83%88%E3%82%99_1.png" alt=""></p><h1 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h1><p>今回利用するサービスについて説明します。</p><h2 id="Slackのアプリ-「Incoming-Webhook」"><a href="#Slackのアプリ-「Incoming-Webhook」" class="headerlink" title="Slackのアプリ　「Incoming Webhook」"></a>Slackのアプリ　「Incoming Webhook」</h2><p>SlackのIncoming Webhookというアプリを利用しました。<br><img src="/images/20200817/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-14_12.43.50.png" alt=""><br>どのチャンネルやダイレクトメールにBOTを利用するかを決定すると、Webhook URLが発行されるので、このURLに対してPOSTリクエストを送ります。URLが発行されるページに例が詳しく載っているので何かしらの形でPOSTリクエストを送ったことがある人なら簡単に使えると思います！</p><h2 id="Googleスプレットシート"><a href="#Googleスプレットシート" class="headerlink" title="Googleスプレットシート"></a>Googleスプレットシート</h2><p>スプシと略して呼んでいたら上司が「スプシって略すのか..」と関心していました。Googleアカウントがあれば誰でも無料で使える表計算シートです。今回はスクリプトエディタ機能でスプレットシートに書いた情報を利用してSlackのWebhookURLへPOSTリクエストを送ります。<br><img src="/images/20200817/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-14_12.59.15.png" alt=""></p><h2 id="Google-Apps-Script-（GAS）"><a href="#Google-Apps-Script-（GAS）" class="headerlink" title="Google Apps Script （GAS）"></a>Google Apps Script （GAS）</h2><p>Googleスプレットシートのスクリプトエディタ機能を利用して、スクリプトを書いていきます。書いたスクリプトはボタンひとつで簡単に実行でき、さらにトリガーで実行時間を指定する機能も備わっており、設定するだけで決まった時間にPOSTリクエストが実行できます。<br><img src="/images/20200817/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-14_13.59.09.png" alt=""></p><h1 id="スクリプトの作成"><a href="#スクリプトの作成" class="headerlink" title="スクリプトの作成"></a>スクリプトの作成</h1><p>今回は特に、固定項目追加・スケジュールの追加について解説します。細かく見ると休日判定もしていますが、シンプルにまとめているページが他にいくつかあったので、今回は省略しています。</p><h2 id="固定項目の自動追加"><a href="#固定項目の自動追加" class="headerlink" title="固定項目の自動追加"></a>固定項目の自動追加</h2><p>まずは、Googleスプレットシートにタイトルなど毎日の日報で固定化されている情報をあらかじめ記載しておき、その情報を使ってテンプレを作成していきます。ここまででも、項目を打ち込むルーティーンをなくすことができ、作成時間を多少減らすことができそうです。作成したスプレットシートとコードを以下に記載します。<br><img src="/images/20200817/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-14_17.25.02.png" alt=""><br>スプレットシートの情報をスクリプトで抽出します。（全体のコードは後述）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// スプレットシートを取得</span></span><br><span class="line"><span class="keyword">let</span> sheet = SpreadsheetApp.getActiveSheet();</span><br><span class="line"><span class="keyword">let</span> message = <span class="string">"日報 \n"</span>;</span><br><span class="line"><span class="comment">// ２行目から順番に行ごとのデータを取得し、messageに追加していく</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">2</span>; i&lt;= sheet.getLastRow(); i++) &#123;</span><br><span class="line">  <span class="keyword">let</span> subtitle = sheet.getRange(i, <span class="number">1</span>).getValue(); </span><br><span class="line">  <span class="keyword">let</span> defmessage = sheet.getRange(i, <span class="number">2</span>).getValue(); </span><br><span class="line">  <span class="keyword">let</span> option = sheet.getRange(i, <span class="number">3</span>).getValue();</span><br><span class="line">  <span class="comment">// １列目の項目名をmessageに追加</span></span><br><span class="line">  message += <span class="string">"■"</span>+subtitle+<span class="string">"\n"</span>;</span><br><span class="line">  <span class="comment">// 2列目にデフォルト値が設定されている場合、messageにデフォルト値を追加</span></span><br><span class="line">  <span class="keyword">if</span>(defmessage!==<span class="string">""</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> msgs = defmessage.split(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">let</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> msg <span class="keyword">of</span> msgs) &#123;</span><br><span class="line">      <span class="keyword">if</span>(cnt===<span class="number">0</span>) message += INDENT+msg+<span class="string">"\n"</span>;</span><br><span class="line">      <span class="keyword">else</span> message += SECOND_INDENT+msg+<span class="string">"\n"</span>;</span><br><span class="line">      cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 3列目に関数名が設定されている場合、関数を実行</span></span><br><span class="line">  <span class="keyword">if</span>(option!==<span class="string">""</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(option===OPTION_GET_TODAY_CAL) message += addTodayCal();</span><br><span class="line">    <span class="keyword">else</span> message += addTomorrowCal();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="スケジュールの自動追加"><a href="#スケジュールの自動追加" class="headerlink" title="スケジュールの自動追加"></a>スケジュールの自動追加</h2><p>さらに作成時間を減らしたいので、今日明日のスケジュールをカレンダーから抽出して固定項目の中を埋めていきます。以下の関数を利用してスケジュールを取得します。予定のステータスを確認して、自分が主宰の予定及び、参加・未定と回答した予定のみを取得しています。（全体のコードは後述）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 必要なカレンダーID</span></span><br><span class="line"><span class="comment">// 日本の祝日カレンダーID</span></span><br><span class="line"><span class="keyword">const</span> JAP_HOLIDAY_CAL_ID = <span class="string">'ja.japanese#holiday@group.v.calendar.google.com'</span>;</span><br><span class="line"><span class="comment">// 自分のカレンダーID</span></span><br><span class="line"><span class="keyword">const</span> MY_CAL_ID = <span class="string">'piyopiyoPPP@example.com'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作成した関数</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 今日の予定(参加・主催・未定のみ表示)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>予定の文字列 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTodayCal</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> todayCal = CalendarApp.getCalendarById(MY_CAL_ID);</span><br><span class="line">  <span class="keyword">let</span> today = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">const</span> events = todayCal.getEventsForDay(today);</span><br><span class="line">  <span class="keyword">let</span> message = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> event <span class="keyword">of</span> events) &#123;</span><br><span class="line">    <span class="comment">// 自分が参加する予定のみを取得する</span></span><br><span class="line">    <span class="keyword">if</span>(event.getMyStatus()===<span class="string">"YES"</span> ||event.getMyStatus()===<span class="string">"OWNER"</span> || event.getMyStatus()===<span class="string">"MAYBE"</span>) &#123;</span><br><span class="line">      message += INDENT+event.getTitle()+<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 明日の予定(参加・主催・未定のみ表示)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>予定の文字列 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTomorrowCal</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> tomorrowCal = CalendarApp.getCalendarById(MY_CAL_ID);</span><br><span class="line">  <span class="keyword">let</span> tomorrow = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  tomorrow.setDate(tomorrow.getDate()+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> events = tomorrowCal.getEventsForDay(tomorrow);</span><br><span class="line">  <span class="keyword">let</span> message = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> event <span class="keyword">of</span> events) &#123;</span><br><span class="line">    <span class="comment">// 自分が参加する予定のみを取得する</span></span><br><span class="line">    <span class="keyword">if</span>(event.getMyStatus()===<span class="string">"YES"</span> ||event.getMyStatus()===<span class="string">"OWNER"</span> || event.getMyStatus()===<span class="string">"MAYBE"</span>) &#123;</span><br><span class="line">      message += INDENT+event.getTitle()+<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="BOT化"><a href="#BOT化" class="headerlink" title="BOT化"></a>BOT化</h1><p><img src="/images/20200817/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-14_17.42.42.png" alt=""></p><h1 id="コード"><a href="#コード" class="headerlink" title="コード"></a>コード</h1><p>全体のコードです。スプレットシートを作った後、ツールからスクリプトエディタを開いてコードをコピーし、【STEP 1】,【STEP 2】を設定すると動くようにしています。気になった方はぜひ動かしてみてください！</p><details><summary>コードを見る</summary><div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日報をSlackに送信する</span></span><br><span class="line"><span class="comment"> * 時計マークから、トリガーをセットして使用する</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//【STEP 1】 自分のWEBHOOKを設定</span></span><br><span class="line"><span class="keyword">const</span> SLACK_WEBHOOK = <span class="string">'https://piyopiyo'</span>;</span><br><span class="line"><span class="comment">// 日本の祝日カレンダーID</span></span><br><span class="line"><span class="keyword">const</span> JAP_HOLIDAY_CAL_ID = <span class="string">'ja.japanese#holiday@group.v.calendar.google.com'</span>;</span><br><span class="line"><span class="comment">//【STEP 2】 自分のカレンダーIDに変更</span></span><br><span class="line"><span class="keyword">const</span> MY_CAL_ID = <span class="string">'piyopiyoPPP@example.com'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> OPTION_GET_TODAY_CAL = <span class="string">'get_today_cal'</span>;</span><br><span class="line"><span class="keyword">const</span> OPTION_GET_TOMORROW_CAL = <span class="string">'get_tomorrow_cal'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> INDENT = <span class="string">'    ・'</span>;</span><br><span class="line"><span class="keyword">const</span> SECOND_INDENT = <span class="string">'      '</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日報テンプレをSlackに送信</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createNippo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> today = <span class="keyword">new</span> <span class="built_in">Date</span>();  </span><br><span class="line">  <span class="keyword">if</span>(isHoliday(today)) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> url = SLACK_WEBHOOK;</span><br><span class="line">  <span class="comment">// スプレットシートを取得</span></span><br><span class="line">  <span class="keyword">let</span> sheet = SpreadsheetApp.getActiveSheet();</span><br><span class="line">  <span class="keyword">let</span> message = <span class="string">"日報 \n"</span>;</span><br><span class="line">  <span class="comment">// ２行目から順番に行ごとのデータを取得し、messageに追加していく</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">2</span>; i&lt;= sheet.getLastRow(); i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> subtitle = sheet.getRange(i, <span class="number">1</span>).getValue(); </span><br><span class="line">    <span class="keyword">let</span> defmessage = sheet.getRange(i, <span class="number">2</span>).getValue(); </span><br><span class="line">    <span class="keyword">let</span> option = sheet.getRange(i, <span class="number">3</span>).getValue();</span><br><span class="line">    <span class="comment">// １列目の項目名をmessageに追加</span></span><br><span class="line">    message += <span class="string">"■"</span>+subtitle+<span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment">// 2列目にデフォルト値が設定されている場合、messageにデフォルト値を追加</span></span><br><span class="line">    <span class="keyword">if</span>(defmessage!==<span class="string">""</span>)&#123;</span><br><span class="line">      <span class="keyword">let</span> msgs = defmessage.split(<span class="string">"\n"</span>);</span><br><span class="line">      <span class="keyword">let</span> cnt = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">const</span> msg <span class="keyword">of</span> msgs) &#123;</span><br><span class="line">        <span class="keyword">if</span>(cnt===<span class="number">0</span>) message += INDENT+msg+<span class="string">"\n"</span>;</span><br><span class="line">        <span class="keyword">else</span> message += SECOND_INDENT+msg+<span class="string">"\n"</span>;</span><br><span class="line">        cnt++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3列目に関数名が設定されている場合、関数を実行</span></span><br><span class="line">    <span class="keyword">if</span>(option!==<span class="string">""</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(option===OPTION_GET_TODAY_CAL) message += addTodayCal();</span><br><span class="line">      <span class="keyword">else</span> message += addTomorrowCal();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//logを出したい時に利用</span></span><br><span class="line">  Logger.log(message);</span><br><span class="line">  <span class="keyword">let</span> options = createOptions(today, message);</span><br><span class="line">  UrlFetchApp.fetch(url,options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 土日祝日判定</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;date&#125;</span> </span>日付オブジェクト</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;bool&#125;</span> </span>休日かどうか</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isHoliday</span>(<span class="params">date</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 土日</span></span><br><span class="line">  <span class="keyword">if</span>(date.getDay()===<span class="number">0</span> || date.getDay()===<span class="number">6</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 祝日</span></span><br><span class="line">  <span class="keyword">let</span> holidayCal = CalendarApp.getCalendarById(JAP_HOLIDAY_CAL_ID);</span><br><span class="line">  <span class="keyword">return</span> (holidayCal.getEventsForDay(date).length&gt;<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Slackへ送るペイロード作成</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;date&#125;</span> </span>日付オブジェクト</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>Slackに送る本文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;bool&#125;</span> </span>休日かどうか</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createOptions</span>(<span class="params">date, message</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> date_format = <span class="string">'yyyy/MM/dd'</span></span><br><span class="line">  <span class="keyword">let</span> fdate = Utilities.formatDate(date, <span class="string">'Asia/Tokyo'</span>, date_format);</span><br><span class="line">  <span class="keyword">let</span> json_data =&#123;<span class="string">"username"</span>:<span class="string">"日報"</span>+fdate,</span><br><span class="line">    <span class="string">"text"</span>: message,</span><br><span class="line">    <span class="string">"icon_emoji"</span>: <span class="string">":slack:"</span>&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> payload = <span class="built_in">JSON</span>.stringify(json_data);</span><br><span class="line">  <span class="keyword">let</span> options = &#123;</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">    <span class="string">"contentType"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : payload</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 今日の予定(参加・主催・未定のみ表示)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>予定の文字列 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTodayCal</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> todayCal = CalendarApp.getCalendarById(MY_CAL_ID);</span><br><span class="line">  <span class="keyword">let</span> today = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">const</span> events = todayCal.getEventsForDay(today);</span><br><span class="line">  <span class="keyword">let</span> message = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> event <span class="keyword">of</span> events) &#123;</span><br><span class="line">    <span class="comment">// 自分が参加する予定のみを取得する</span></span><br><span class="line">    <span class="keyword">if</span>(event.getMyStatus()===<span class="string">"YES"</span> ||event.getMyStatus()===<span class="string">"OWNER"</span> || event.getMyStatus()===<span class="string">"MAYBE"</span>) &#123;</span><br><span class="line">      message += INDENT+event.getTitle()+<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 明日の予定(参加・主催・未定のみ表示)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>予定の文字列 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTomorrowCal</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> tomorrowCal = CalendarApp.getCalendarById(MY_CAL_ID);</span><br><span class="line">  <span class="keyword">let</span> tomorrow = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  tomorrow.setDate(tomorrow.getDate()+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> events = tomorrowCal.getEventsForDay(tomorrow);</span><br><span class="line">  <span class="keyword">let</span> message = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> event <span class="keyword">of</span> events) &#123;</span><br><span class="line">    <span class="comment">// 自分が参加する予定のみを取得する</span></span><br><span class="line">    <span class="keyword">if</span>(event.getMyStatus()===<span class="string">"YES"</span> ||event.getMyStatus()===<span class="string">"OWNER"</span> || event.getMyStatus()===<span class="string">"MAYBE"</span>) &#123;</span><br><span class="line">      message += INDENT+event.getTitle()+<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Slack×GASを利用した日報テンプレートBOTを作成しました。日々のタスクの自動化・整理の参考になれば嬉しいです。</p><p>余談ですが、Slackは投稿するときにアイコンがスタンプから選べるのが可愛いです。Google ChatのBOTを作った時は、アイコン画像のurlを作るのに苦労したので気軽に可愛いアイコンが付けられるのはそれだけでテンションが上がりました！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチャー夏休み自由研究連載&lt;/a&gt;11本目の記事です&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;hea
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="Slack" scheme="https://future-architect.github.io/tags/Slack/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="BOT" scheme="https://future-architect.github.io/tags/BOT/"/>
    
      <category term="GAS" scheme="https://future-architect.github.io/tags/GAS/"/>
    
  </entry>
  
  <entry>
    <title>ぼくのなつやすみ5 -Knativeを知ろう-</title>
    <link href="https://future-architect.github.io/articles/20200814/"/>
    <id>https://future-architect.github.io/articles/20200814/</id>
    <published>2020-08-13T15:00:00.000Z</published>
    <updated>2020-08-18T07:24:55.100Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、TIG所属の<a href="https://twitter.com/famipapamart" target="_blank" rel="noopener">村田</a>です。</p><p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>10本目の記事です。今回は夏休みの自由研究企画ということで、Cloud RunのベースであるKnativeを触ってみたいと思います！</p><h1 id="実際に触ってみる"><a href="#実際に触ってみる" class="headerlink" title="実際に触ってみる"></a>実際に触ってみる</h1><h2 id="今回利用した各コンポーネントのバージョン"><a href="#今回利用した各コンポーネントのバージョン" class="headerlink" title="今回利用した各コンポーネントのバージョン"></a>今回利用した各コンポーネントのバージョン</h2><p>利用したコンポーネントとバージョンは以下です。記事投稿時点（2020.08.14）での最新バージョンを利用しています。</p><table><thead><tr><th align="left">コンポーネント</th><th align="left">バージョン</th></tr></thead><tbody><tr><td align="left">Kubernetes (GKE)</td><td align="left">1.17.8-gke.17</td></tr><tr><td align="left">Knative (Serving)</td><td align="left">v0.16.0</td></tr><tr><td align="left">kn</td><td align="left">v0.16.0</td></tr><tr><td align="left">Istio</td><td align="left">v1.6.8</td></tr></tbody></table><h2 id="Kubernetes-Clusterの構築"><a href="#Kubernetes-Clusterの構築" class="headerlink" title="Kubernetes Clusterの構築"></a>Kubernetes Clusterの構築</h2><p>今回はKnativeが主役なのでクラスタはGKEを使ってさくっと構築してしまいます。</p><p>なるべく最新に近いバージョンを使いたいのでRelease ChannelをRapid Channelに設定。<br><img src="/images/20200814/image.png" class="img-middle-size" style="border:solid 1px #000000"></p><p>課金を抑えるためにPreemptibleインスタンスに設定。<br><img src="/images/20200814/image_2.png" class="img-middle-size" style="border:solid 1px #000000"></p><p>Istioは自前インストールしたいので <code>Enable Istio</code> のオプションにはチェックを入れないように。<br><img src="/images/20200814/image_3.png" class="img-middle-size" style="border:solid 1px #000000"></p><p>上記以外の設定はデフォルトのままでクラスタを構築します。（名称は <code>my-summer</code> としました）<br>また、以降の手順にて <code>kubectl</code> コマンドを使うため、手元の端末で設定しておきます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcloud container clusters get-credentials my-summer --zone &lt;YOUR_ZONE&gt; --project &lt;YOUR_PROJECT_ID&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Knativeのインストール"><a href="#Knativeのインストール" class="headerlink" title="Knativeのインストール"></a>Knativeのインストール</h2><p>次にKnativeのインストールを進めます。</p><blockquote><p>Knative v0.16.0 requires a Kubernetes cluster v1.16 or newer</p></blockquote><p><a href="https://knative.dev/docs/install/any-kubernetes-cluster/" target="_blank" rel="noopener">https://knative.dev/docs/install/any-kubernetes-cluster/</a><br>とありますが、今回利用するGKEバージョンは <code>1.17.8-gke.17</code> なので問題なさそうです。</p><p>以下のコマンドでCRDとcore-componentをインストールします。個々のコンポーネントがどのような役割をしているかまでは追えてないですが、Autoscalingなどベースとなる挙動を支えるコンポーネント群がインストールされます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply --filename https://github.com/knative/serving/releases/download/v0.16.0/serving-crds.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply --filename https://github.com/knative/serving/releases/download/v0.16.0/serving-core.yaml</span></span><br></pre></td></tr></table></figure><h2 id="Istioのインストール"><a href="#Istioのインストール" class="headerlink" title="Istioのインストール"></a>Istioのインストール</h2><p>次にネットワークレイヤの設定をします。筆者はてっきりIstioが必須かと思ってのですが、執筆時点で <code>Ambassador</code> <code>Contour</code> <code>Gloo</code> <code>Kong</code> <code>Kourier</code> も選択肢にありました。</p><p>筆者はIstioが好きなので今回はIstioを選びました。記事投稿時点(2020.08.14)での最新バージョンである <code>1.6.8</code> をダウンロードします。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L https://istio.io/downloadIstio | sh -</span><br><span class="line">Downloading istio-1.6.8 from https://github.com/istio/istio/releases/download/1.6.8/istio-1.6.8-osx.tar.gz ...</span><br><span class="line">Istio 1.6.8 Download Complete!</span><br><span class="line"></span><br><span class="line">Istio has been successfully downloaded into the istio-1.6.8 folder on your system.</span><br><span class="line"></span><br><span class="line">Next Steps:</span><br><span class="line">See https://istio.io/docs/setup/kubernetes/install/ to add Istio to your Kubernetes cluster.</span><br><span class="line"></span><br><span class="line">To configure the istioctl client tool <span class="keyword">for</span> your workstation,</span><br><span class="line">add the /Users/y-murata/Downloads/istio-1.6.8/bin directory to your environment path variable with:</span><br><span class="line">         <span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PATH</span>:/Users/xxx/istio-1.6.8/bin"</span></span><br><span class="line"></span><br><span class="line">Begin the Istio pre-installation verification check by running:</span><br><span class="line">         istioctl verify-install </span><br><span class="line"></span><br><span class="line">Need more information? Visit https://istio.io/docs/setup/kubernetes/install/</span><br></pre></td></tr></table></figure><p>実行バイナリにPATHを通しておきます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> istio-1.6.8</span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PWD</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><p>Istioをインストールします。インストール先は <code>~/.kube/config</code> で <code>current-context</code> に設定されているクラスタです。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ istioctl install</span><br></pre></td></tr></table></figure><p>ちゃんとIstioのインストールができてそうですね。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod --all-namespaces</span><br><span class="line">NAMESPACE         NAME                                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">istio-system      istio-ingressgateway-6c77d7f498-62dr9                      1/1     Running   0          91s</span><br><span class="line">istio-system      istiod-58f84ffddc-c7mmf                                    1/1     Running   0          110s</span><br><span class="line">istio-system      prometheus-5db67458fb-m8qq6                                2/2     Running   0          90s</span><br><span class="line">knative-serving   activator-76984478f7-9h48r                                 1/1     Running   0          47h</span><br><span class="line">knative-serving   autoscaler-598d974c99-hsblm                                1/1     Running   0          41h</span><br><span class="line">knative-serving   controller-9b998cd47-fx8bk                                 1/1     Running   0          47h</span><br><span class="line">knative-serving   webhook-658874f97-wcr5k                                    1/1     Running   0          41h</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Knativeの設定"><a href="#Knativeの設定" class="headerlink" title="Knativeの設定"></a>Knativeの設定</h2><p>さて、次にKnative Istio Controllerをインストールします。これによりKnativeとIstioが連携可能になります。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply --filename https://github.com/knative/net-istio/releases/download/v0.16.0/release.yaml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/knative-serving-istio created</span><br><span class="line">gateway.networking.istio.io/knative-ingress-gateway created</span><br><span class="line">gateway.networking.istio.io/cluster-local-gateway created</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.io/webhook.istio.networking.internal.knative.dev created</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/config.webhook.istio.networking.internal.knative.dev created</span><br><span class="line">secret/istio-webhook-certs created</span><br><span class="line">configmap/config-istio created</span><br><span class="line">deployment.apps/networking-istio created</span><br><span class="line">deployment.apps/istio-webhook created</span><br><span class="line">service/istio-webhook created</span><br></pre></td></tr></table></figure><p>次にDNSの設定をします。本来はしっかりとDNSの設定をするのですが、今回は<a href="http://xip.io/" target="_blank" rel="noopener">xip.io</a>を使用して名前解決を行います。以下のKubernetes Jobで <code>xip.io</code> がDNSのsuffixとして利用されるように設定されます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply --filename https://github.com/knative/serving/releases/download/v0.16.0/serving-default-domain.yaml</span><br></pre></td></tr></table></figure><p>少しだけxip.ioについて補足しておくと、例えば <code>10.0.0.1.xip.io</code> というドメインは <code>10.0.0.1</code> と名前解決されることになります。今回はこの仕組みを利用します。</p><p>ここまででServing Componentのインストールは完了です。</p><h2 id="Knative-Servingの動作確認"><a href="#Knative-Servingの動作確認" class="headerlink" title="Knative Servingの動作確認"></a>Knative Servingの動作確認</h2><p>Go製のサンプルアプリがGCRから取得可能なので動作を確認してみます。アプリはKnative CLIの <code>kn</code> から行うのが一番簡単とのことで、筆者のMac端末へはHomebrew経由でインストールしました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew tap knative/client</span><br><span class="line">$ brew install kn</span><br></pre></td></tr></table></figure><p>アプリをデプロイします。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kn service create helloworld-go --image gcr.io/knative-samples/helloworld-go --env TARGET=<span class="string">"Go Sample v1"</span></span><br></pre></td></tr></table></figure><p>しっかりPodがデプロイされていることを確認できました！</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po</span><br><span class="line">NAME                                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld-go-txzsq-1-deployment-758cc788c-46nqt   2/2     Running   0          48s</span><br></pre></td></tr></table></figure><p>立ち上がったアプリへリクエストをなげてみます。まずはエンドポイントの確認から実施するのですが、確認は <code>kn</code> 経由と <code>kubectl</code> 経由の2種類の方法があるようです。</p><p><code>kn</code> 経由の場合は以下。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kn service describe helloworld-go</span><br><span class="line"></span><br><span class="line">Name:       helloworld-go</span><br><span class="line">Namespace:  default</span><br><span class="line">Age:        4m</span><br><span class="line">URL:        http://helloworld-go.default.xx.xx.xx.xx.xip.io</span><br><span class="line"></span><br><span class="line">Revisions:  </span><br><span class="line">  100%  @latest (helloworld-go-txzsq-1) [1] (4m)</span><br><span class="line">        Image:  gcr.io/knative-samples/helloworld-go (pinned to 5ea96b)</span><br><span class="line"></span><br><span class="line">Conditions:  </span><br><span class="line">  OK TYPE                   AGE REASON</span><br><span class="line">  ++ Ready                   3m </span><br><span class="line">  ++ ConfigurationsReady     3m </span><br><span class="line">  ++ RoutesReady             3m</span><br></pre></td></tr></table></figure><p><code>kubectl</code> の場合は以下。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ksvc helloworld-go</span><br><span class="line">NAME            URL                                                LATESTCREATED           LATESTREADY             READY   REASON</span><br><span class="line">helloworld-go   http://helloworld-go.default.xx.xx.xx.xx.xip.io   helloworld-go-txzsq-1   helloworld-go-txzsq-1   True</span><br></pre></td></tr></table></figure><p>当然ですが <code>kn</code> 経由のほうがアプリのリビジョンなど参照可能な情報がたくさんあります。これによってエンドポイントが分かりました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://helloworld-go.default.xx.xx.xx.xx.xip.io</span><br></pre></td></tr></table></figure><p>リクエストを投げてみます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://helloworld-go.default.xx.xx.xx.xx.xip.io</span><br><span class="line">Hello Go Sample v1!</span><br></pre></td></tr></table></figure><p>このサンプルアプリは <code>TARGET</code> という環境変数に渡した値を利用して <code>Hello World: ${TARGET}!</code> と返してくるらしいので、期待通りに動作していることが確認できました。</p><p>また、ちゃんとscale-to-zeroの挙動も確認できました。リクエストが途切れてから90秒ほどでPodがTerminatingの状態になり、最終的にPodがKillされることを確認できました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po</span><br><span class="line">NAME                                               READY   STATUS        RESTARTS   AGE</span><br><span class="line">helloworld-go-txzsq-1-deployment-758cc788c-8b89j   2/2     Terminating   0          94s</span><br><span class="line"></span><br><span class="line">$ kubectl get po</span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br></pre></td></tr></table></figure><p>もう一度リクエストを投げてみると、レスポンスに少し時間がかかっていた（体感ですが2秒ほど）のでPod起動のリードタイムがかかっていると考えられます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://helloworld-go.default.xx.xx.xx.xx.xip.io</span><br><span class="line">Hello Go Sample v1!</span><br><span class="line"></span><br><span class="line">$ kubectl get po</span><br><span class="line">NAME                                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld-go-txzsq-1-deployment-758cc788c-ndrdq   1/2     Running   0          6s</span><br></pre></td></tr></table></figure><p>ちなみにPodのREADYは <code>1/2</code> の状態でもレスポンスを返しているみたいだったのでPodの中身をもう少し見てみます。（リクエストから90秒以内に確認コマンドを打つ必要があるので注意してください）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod helloworld-go-txzsq-1-deployment-758cc788c-lg8w4</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                                               Message</span><br><span class="line">  ----    ------     ----  ----                                               -------</span><br><span class="line">  Normal  Scheduled  17s   default-scheduler                                  Successfully assigned default&#x2F;helloworld-go-txzsq-1-deployment-758cc788c-lg8w4 to gke-my-summer-default-pool-e721bfa1-gpd8</span><br><span class="line">  Normal  Pulled     16s   kubelet, gke-my-summer-default-pool-e721bfa1-gpd8  Container image &quot;gcr.io&#x2F;knative-samples&#x2F;helloworld-go@sha256:5ea96ba4b872685ff4ddb5cd8d1a97ec18c18fae79ee8df0d29f446c5efe5f50&quot; already present on machine</span><br><span class="line">  Normal  Created    16s   kubelet, gke-my-summer-default-pool-e721bfa1-gpd8  Created container user-container</span><br><span class="line">  Normal  Started    16s   kubelet, gke-my-summer-default-pool-e721bfa1-gpd8  Started container user-container</span><br><span class="line">  Normal  Pulled     16s   kubelet, gke-my-summer-default-pool-e721bfa1-gpd8  Container image &quot;gcr.io&#x2F;knative-releases&#x2F;knative.dev&#x2F;serving&#x2F;cmd&#x2F;queue@sha256:ab38418f2e13dfc21d48c64af0589f4eae5c40fc34a5e02f48b24b7156391d22&quot; already present on machine</span><br><span class="line">  Normal  Created    16s   kubelet, gke-my-summer-default-pool-e721bfa1-gpd8  Created container queue-proxy</span><br><span class="line">  Normal  Started    15s   kubelet, gke-my-summer-default-pool-e721bfa1-gpd8  Started container queue-proxy</span><br></pre></td></tr></table></figure><p>Pod内には <code>user-container</code> と <code>queue-proxy</code> の2つのContainerが起動しますが、 <code>user-container</code> が起動した時点でレスポンスの返却はできてるみたいですね。</p><p>調べてみたところ <code>queue-proxy</code> は <code>user-container</code> のサイドカーコンテナとしてデプロイされるもので、プロキシとしてアプリケーションへのトラフィック量を監視する役割を担うようです。</p><blockquote><p>The queue-proxy’s main purpose is to measure and limit concurrency to the user’s application.</p></blockquote><p><a href="https://github.com/knative/serving/blob/d7bea3390c9fca2713c05b3bbd83690d430c7cfc/docs/scaling/SYSTEM.md" target="_blank" rel="noopener">https://github.com/knative/serving/blob/d7bea3390c9fca2713c05b3bbd83690d430c7cfc/docs/scaling/SYSTEM.md</a></p><p><code>queue-proxy</code> の情報は <code>autoscaler</code> というコンポーネントが収集し、Podのスケールサイズ決定に利用されています。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get service -n knative-serving</span></span><br><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                           AGE</span><br><span class="line">activator-service        ClusterIP   10.20.8.213    &lt;none&gt;        9090/TCP,8008/TCP,80/TCP,81/TCP   4d6h</span><br><span class="line">autoscaler               ClusterIP   10.20.14.196   &lt;none&gt;        9090/TCP,8008/TCP,8080/TCP        4d6h</span><br><span class="line">controller               ClusterIP   10.20.10.247   &lt;none&gt;        9090/TCP,8008/TCP                 4d6h</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>今回はKnativeに触ってみましたが、「Cloud RunはKnativeベースである」というふわっとした理解だった部分について、より具体的なイメージが湧きました。「Cloud RunはきっとKnativeをいい感じにラップしてるんだろうな」と思っていましたが、触ってみた感じだとあまりラップ層は分厚くなく割と素に近い状態で使われているのではと感じました。</p><p>また、個人的に一番学びだったのは「KnativeにとってIstioは必須ではない」という部分です。勝手にKnativeはIstioベースのサービスメッシュ機構に依存するものだと思っていたのですがそれは違いました。</p><p>最近はクラウドベンダーからマネージドサービスとして提供されるOSSも多いですが、あえて自前での構築を試してみると意外な発見があって面白いですね！！</p><p>さて、次回のエントリーは新人の仁木さんが担当されます！仁木さんは研修中に競プロのバーチャルコンテストを企画しちゃったスーパーな新人さんです。ぜひご期待ください！</p><p><a href="https://note.future.co.jp/n/nda51c959f75a" target="_blank" rel="noopener">入社１か月の新人が競技プログラミングのバーチャルコンテストを企画するまで</a></p><p>また、本記事で触れたCloud Run・Istioについては以下のような記事もあがっているので読んでみてください。</p><ul><li><a href="https://future-architect.github.io/articles/20200207/">GCP連載#3 Goでサーバーレスな管理画面アプリを作る</a></li><li><a href="https://future-architect.github.io/articles/20200206/">GCP連載#2 Istio on GKEではじめるサービスメッシュ</a></li><li><a href="https://future-architect.github.io/articles/20190909/">Let’s Try GCP #1 ～Cloud Run Buttonを使った楽々コンテナデプロイをやってみた～</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、TIG所属の&lt;a href=&quot;https://twitter.com/famipapamart&quot; target=
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="GCP" scheme="https://future-architect.github.io/tags/GCP/"/>
    
      <category term="Kubernetes" scheme="https://future-architect.github.io/tags/Kubernetes/"/>
    
      <category term="Istio" scheme="https://future-architect.github.io/tags/Istio/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="Knative" scheme="https://future-architect.github.io/tags/Knative/"/>
    
  </entry>
  
  <entry>
    <title>GCPのRegion間レイテンシからサービスのRegion集約を考察する</title>
    <link href="https://future-architect.github.io/articles/20200813/"/>
    <id>https://future-architect.github.io/articles/20200813/</id>
    <published>2020-08-12T15:00:00.000Z</published>
    <updated>2020-08-18T07:24:55.099Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>の9回目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、TIG DXユニットの西田と申します。</p><p>業務では <code>GCP</code> のインフラの設計/構築/運用を担当しております。私は前職でネットワーク領域のキャリアが長かった事もあり、現職では <code>GCP</code> の中でも特にネットワークに関する部分を見ています。今回の自由研究もそれに関連する考察をしていきます。</p><h1 id="記事について"><a href="#記事について" class="headerlink" title="記事について"></a>記事について</h1><p>クラウド上で、ワールドワイドのサービスを作るとき、<strong>『どれくらいの密度でどの Region にサーバを立てればよいのか？』</strong>って、悩みませんか？インターネット向けのWebサービスだったら <code>CDN</code> で対処すれば基本的にはOKですが、イントラネットだけからアクセスさせたい社内サービス、Backend 系のサービス、Webサービスではないアプリケーションなどはインスタンスを用意する必要が出てきますよね。<br>選択肢としては以下です。</p><ul><li>全リージョンにサーバを構築する<ul><li>日本の場合、東京、大阪にそれぞれ構築する</li></ul></li><li>近傍の国を1つのリージョンにまとめる<ul><li>日本の場合、東京だけに集約する</li></ul></li></ul><p>今回は、自由研究という事で、日頃業務で使っている <code>GCP</code> を題材にして、ネットワークの観点から考察してみようと思います。先に申し上げておきますと、一観点からの考察なので、実際のサービスが提供しているSLAにマッチするかどうかは別問題なので、そこはご容赦ください🙇‍♂️</p><h1 id="自由研究で考察する観点"><a href="#自由研究で考察する観点" class="headerlink" title="自由研究で考察する観点"></a>自由研究で考察する観点</h1><p>ネットワークの観点と言っても、いくつかありますよね。</p><ul><li>スループット：<code>〇Gbps</code> などの帯域の話。『ギガがなくなった』とかのギガとは少し違います。</li><li>レイテンシ：パケットの往復の時間</li><li>ジッター：上記の時間の揺らぎ。早いときと遅いときのばらつき度合い</li></ul><p>今回は、この中でレイテンシだけに注目して考察します。<br>（データ量がそこそこあるサービスの場合はスループットも気にするべきですが、本記事ではレイテンシのみに注目）</p><h1 id="GCP-のリージョンとは？"><a href="#GCP-のリージョンとは？" class="headerlink" title="GCP のリージョンとは？"></a>GCP のリージョンとは？</h1><p>こちらに世界地図とネットワークケーブルの概要が掲載されております。<br><a href="https://cloud.google.com/about/locations?hl=ja#network" target="_blank" rel="noopener">https://cloud.google.com/about/locations?hl=ja#network</a><br>この線を通ってパケットがやり取りされるわけですが、近いところは早く応答が返ってくるし、遠いところは応答が遅いという事です。<br>では、サービス目線で言うと、どれくらい集約できるんでしょうかね？</p><h1 id="集約する基準"><a href="#集約する基準" class="headerlink" title="集約する基準"></a>集約する基準</h1><p>まず、集約する基準を決めておきます。<br>かなり感覚論ですし、サービスの種類や作りにも当然依存しますが、大体私の経験上はこれくらいです。</p><table><thead><tr><th align="left">レイテンシ</th><th align="left">日常使用で同程度なモノ</th><th align="left">体感</th></tr></thead><tbody><tr><td align="left">20ms 以下</td><td align="left">固定の光回線</td><td align="left">とても速い。さくさく</td></tr><tr><td align="left">60ms 以下</td><td align="left">スマホ4Gくらい</td><td align="left">まぁこれくらいは我慢出来る</td></tr><tr><td align="left">それ以上</td><td align="left">4Gで遅い時/3G利用など</td><td align="left">これは遅い…使いたくない</td></tr></tbody></table><p>なので、<strong><code>60ms</code> までは集約可能</strong>と判断する事にします。<br>※重ねてになりますが、提供するサービスの種類/作りにこの基準は大きく依存します。音声系・映像系だと遅いと致命的な影響を受けますが、ファイルサーバの様なサービスだともう少し基準を下げられる、などはあり得ます。</p><h1 id="GCP-の全-Region-間のレイテンシを計測する"><a href="#GCP-の全-Region-間のレイテンシを計測する" class="headerlink" title="GCP の全 Region 間のレイテンシを計測する"></a>GCP の全 Region 間のレイテンシを計測する</h1><h3 id="計測対象"><a href="#計測対象" class="headerlink" title="計測対象"></a>計測対象</h3><p>こちらの <a href="https://cloud.google.com/compute/docs/regions-zones?hl=ja" target="_blank" rel="noopener">Compute Engine リージョンとゾーン</a> に記載の全Region を対象にします。<br>※すいません、ムンバイだけ、QuotaがデフォルトでCPUS:0となっており、上げるリクエストを出したんですが、拒否されてしまいました。その関係で、ムンバイだけ計測が出来ませんでした🙇‍♂️<br><img src="/images/20200813/2020-08-02_233921.png" alt=""></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul><li>フルメッシュで計測</li><li>Ping を 100ms 毎に 100 回打って、その返答の平均値</li></ul><p>※インスタンス構築のための <code>Terraform</code> コード、計測のためのスクリプトはAppendixに載せておきます。<br>　スクリプトは並列処理をするべきでした。そこはちょっと作り足りない感があります。</p><h3 id="計測結果"><a href="#計測結果" class="headerlink" title="計測結果"></a>計測結果</h3><p>計測結果は以下です。</p><ul><li>青：20ms。サクサク</li><li>黄：60ms。ギリギリ我慢できるレベル</li><li>赤：それ以上。これはサービスとしてはよろしくない<br><img src="/images/20200813/2020-08-02_231622.jpg" alt=""></li></ul><h1 id="考察"><a href="#考察" class="headerlink" title="考察"></a>考察</h1><p>考察に当たっては、少しを前提を置きます。</p><ul><li>対象となる企業は、グローバル展開している日本企業（<code>Japanese Multinational Corporations</code>）であり、Japan に Global Headquarters(<code>GHQ</code>) が存在する。<ul><li>人数的には、Japan が最も従業員/顧客が多い。</li></ul></li><li>各国の支社/支部がイントラネットを通じて社内向けのサービスにアクセスする。</li></ul><p>割と現実的な前提ですよね。その前提を元に、考えると、以下の様になります。</p><ul><li>東京：日本/韓国/台湾/香港を集約（台湾/香港は、香港に別だしでも良い秒数）<ul><li>GHQがあるので、まずはココを起点に考えます。</li></ul></li><li>シンガポール：東南アジア地域をカバー</li><li>オーストラリア：オセアニア地域。シンガポールまで結構遠いんですね。</li><li>ドイツ：ヨーロッパ地域。（北欧だけは別だしでも良い秒数）</li><li>米国アイオワ：北アメリカ地域。（東西で分けても良い秒数）</li><li>ブラジル</li></ul><p>まぁ、なんていうか。。。『まぁそうだよね』感のある考察になりますね。。。<br>実際、これくらいをベースにリージョンを集約している事が多いんじゃないかと思います。そこに対して、レイテンシという観点での一つの裏付けにはなったかなと思います。</p><h1 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h1><p>今回は『自由研究』という事で、日頃使っているツールに関して、少し深掘ってみました。<br>他にもルーティングに関する考察や、Peering, HA VPN の使い分けに関する考察も自分の中ではあるので、どこかで深堀りしていければと思います。</p><h1 id="ついでに-GCPのスループットについて"><a href="#ついでに-GCPのスループットについて" class="headerlink" title="ついでに(GCPのスループットについて)"></a>ついでに(GCPのスループットについて)</h1><p>理論値というか、UDPベースではこの様になります。</p><ul><li>インスタンス間のスループットは、<code>2Gbps/CPU</code> となる。上限は 8CPU の <code>16Gbps</code><ul><li>n1-standard-1 : <code>2 Gbps</code></li><li>n1-standard-4 : <code>8 Gbps</code></li><li>n1-standard-8 : <code>16 Gbps</code>（以降、CPUを増やしてもスループットは増えない）</li></ul></li></ul><p>※TCP ベースだと、TCPのフロー制御の関係で上記ほどの数値を出すためにはOSのパラメータの調整が必要になります。</p><h1 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h1><h2 id="Terraform-コード"><a href="#Terraform-コード" class="headerlink" title="Terraform コード"></a>Terraform コード</h2><figure class="highlight sh"><figcaption><span>gce.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_instance"</span> <span class="string">"GCE_instances"</span> &#123;</span><br><span class="line">  count        = length(local.gce_instances_list)</span><br><span class="line">  name         = local.gce_instances_list[count.index].name</span><br><span class="line">  machine_type = <span class="string">"f1-micro"</span></span><br><span class="line">  zone         = local.gce_instances_list[count.index].zone</span><br><span class="line">  project      = local.project.id</span><br><span class="line"></span><br><span class="line">  boot_disk &#123;</span><br><span class="line">    auto_delete = <span class="literal">false</span></span><br><span class="line">    <span class="built_in">source</span>      = google_compute_disk.GCE_disks[count.index].self_link</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  network_interface &#123;</span><br><span class="line">    network = google_compute_network.test_network.name</span><br><span class="line">    access_config &#123;</span><br><span class="line">      // Ephemeral IP</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  service_account &#123;</span><br><span class="line">    email  = google_service_account.nw_tester.email</span><br><span class="line">    scopes = [<span class="string">"cloud-platform"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  metadata = &#123;</span><br><span class="line">    <span class="built_in">enable</span>-oslogin = <span class="string">"true"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_disk"</span> <span class="string">"GCE_disks"</span> &#123;</span><br><span class="line">  count   = length(local.gce_instances_list)</span><br><span class="line">  name    = <span class="string">"<span class="variable">$&#123;local.gce_instances_list[count.index].name&#125;</span>-disk"</span></span><br><span class="line">  project = local.project.id</span><br><span class="line">  zone    = local.gce_instances_list[count.index].zone</span><br><span class="line">  <span class="built_in">type</span>    = <span class="string">"pd-standard"</span></span><br><span class="line">  size    = 20</span><br><span class="line">  image   = <span class="string">"centos-cloud/centos-8"</span></span><br><span class="line"></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    ignore_changes = [labels]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>network.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_network"</span> <span class="string">"test_network"</span> &#123;</span><br><span class="line">  project                 = local.project.id</span><br><span class="line">  name                    = <span class="string">"test-network"</span></span><br><span class="line">  auto_create_subnetworks = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_firewall"</span> <span class="string">"ingress_test_network_iap"</span> &#123;</span><br><span class="line">  project = local.project.id</span><br><span class="line">  name    = <span class="string">"ingress-test-network-iap"</span></span><br><span class="line">  network = google_compute_network.test_network.self_link</span><br><span class="line"></span><br><span class="line">  direction = <span class="string">"INGRESS"</span></span><br><span class="line">  priority  = 1000</span><br><span class="line"></span><br><span class="line">  allow &#123;</span><br><span class="line">    protocol = <span class="string">"tcp"</span></span><br><span class="line">    ports    = [<span class="string">"22"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  source_ranges = [<span class="string">"35.235.240.0/20"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_firewall"</span> <span class="string">"ingress_test_network_internal"</span> &#123;</span><br><span class="line">  project = local.project.id</span><br><span class="line">  name    = <span class="string">"ingress-test-network-internal"</span></span><br><span class="line">  network = google_compute_network.test_network.self_link</span><br><span class="line"></span><br><span class="line">  direction = <span class="string">"INGRESS"</span></span><br><span class="line">  priority  = 1000</span><br><span class="line"></span><br><span class="line">  allow &#123;</span><br><span class="line">    protocol = <span class="string">"all"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  source_ranges = [<span class="string">"10.0.0.0/8"</span>, <span class="string">"172.16.0.0/12"</span>, <span class="string">"192.168.0.0/16"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>service_account.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_service_account"</span> <span class="string">"nw_tester"</span> &#123;</span><br><span class="line">  project      = local.project.id</span><br><span class="line">  account_id   = <span class="string">"nw-tester"</span></span><br><span class="line">  display_name = <span class="string">"nw-tester"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_project_iam_member"</span> <span class="string">"nw_tester"</span> &#123;</span><br><span class="line">  project = local.project.id</span><br><span class="line">  member  = <span class="string">"serviceAccount:<span class="variable">$&#123;google_service_account.nw_tester.email&#125;</span>"</span></span><br><span class="line">  role    = <span class="string">"roles/compute.viewer"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>veriable.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  project = &#123;</span><br><span class="line">    id = <span class="string">"project_id"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // GCE Instances</span><br><span class="line">  gce_instance_name = <span class="string">"instance-test-nsd"</span></span><br><span class="line">  gce_instances_list = [</span><br><span class="line">    &#123; region = <span class="string">"asia-northeast1"</span>, zone = <span class="string">"asia-northeast1-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-northeast1-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-northeast1"</span>, zone = <span class="string">"asia-northeast1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-northeast1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-northeast1"</span>, zone = <span class="string">"asia-northeast1-c"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-northeast1-c"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-northeast2"</span>, zone = <span class="string">"asia-northeast2-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-northeast2-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-northeast3"</span>, zone = <span class="string">"asia-northeast3-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-northeast3-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-east1"</span>, zone = <span class="string">"asia-east1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-east1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-east2"</span>, zone = <span class="string">"asia-east2-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-east2-a"</span> &#125;,</span><br><span class="line">//    &#123; region = <span class="string">"asia-south1"</span>, zone = <span class="string">"asia-south1-c"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-south1-c"</span> &#125;, </span><br><span class="line">    &#123; region = <span class="string">"asia-southeast1"</span>, zone = <span class="string">"asia-southeast1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-southeast1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"asia-southeast2"</span>, zone = <span class="string">"asia-southeast2-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-asia-southeast2-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"australia-southeast1"</span>, zone = <span class="string">"australia-southeast1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-australia-southeast1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"europe-north1"</span>, zone = <span class="string">"europe-north1-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-europe-north1-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"europe-west1"</span>, zone = <span class="string">"europe-west1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-europe-west1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"europe-west2"</span>, zone = <span class="string">"europe-west2-c"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-europe-west2-c"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"europe-west3"</span>, zone = <span class="string">"europe-west3-c"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-europe-west3-c"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"europe-west4"</span>, zone = <span class="string">"europe-west4-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-europe-west4-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"europe-west6"</span>, zone = <span class="string">"europe-west6-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-europe-west6-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"northamerica-northeast1"</span>, zone = <span class="string">"northamerica-northeast1-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-northamerica-northeast1-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"southamerica-east1"</span>, zone = <span class="string">"southamerica-east1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-southamerica-east1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-central1"</span>, zone = <span class="string">"us-central1-c"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-central1-c"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-east1"</span>, zone = <span class="string">"us-east1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-east1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-east4"</span>, zone = <span class="string">"us-east4-c"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-east4-c"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-west1"</span>, zone = <span class="string">"us-west1-b"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-west1-b"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-west2"</span>, zone = <span class="string">"us-west2-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-west2-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-west3"</span>, zone = <span class="string">"us-west3-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-west3-a"</span> &#125;,</span><br><span class="line">    &#123; region = <span class="string">"us-west4"</span>, zone = <span class="string">"us-west4-a"</span>, name = <span class="string">"<span class="variable">$&#123;local.gce_instance_name&#125;</span>-us-west4-a"</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>versions.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_version = <span class="string">"&gt;= 0.12"</span></span><br><span class="line">&#125;</span><br><span class="line">provider <span class="string">"google"</span> &#123;</span><br><span class="line">  version = <span class="string">"~&gt; 3.30.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="各種script"><a href="#各種script" class="headerlink" title="各種script"></a>各種script</h2><figure class="highlight sh"><figcaption><span>ping-all-instances-in-VPC.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">project_name=<span class="string">""</span></span><br><span class="line">vpc_name=<span class="string">"test-network"</span></span><br><span class="line">ping_count=100</span><br><span class="line">src_host=`hostname`</span><br><span class="line">src_zone=`gcloud compute instances list --filter <span class="string">"NAME=<span class="variable">$&#123;src_host&#125;</span>"</span> --format=<span class="string">"csv(ZONE)"</span> | sed <span class="string">'1d'</span>`</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;src_host&#125;</span> at `date +<span class="string">"%Y-%m-%d %H:%M:%S.%3N"</span>`</span><br><span class="line"></span><br><span class="line">gce_list=`gcloud compute instances list --filter <span class="string">"networkInterfaces[].network:<span class="variable">$&#123;vpc_name&#125;</span>"</span> --format=<span class="string">"csv(NAME,ZONE,INTERNAL_IP)"</span> | sed <span class="string">'1d'</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> gce <span class="keyword">in</span> <span class="variable">$&#123;gce_list&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  dst_host=`<span class="built_in">echo</span> <span class="variable">$&#123;gce&#125;</span> | cut -d <span class="string">','</span> -f 1` </span><br><span class="line">  dst_zone=`<span class="built_in">echo</span> <span class="variable">$&#123;gce&#125;</span> | cut -d <span class="string">','</span> -f 2`</span><br><span class="line">  dest_ip=`<span class="built_in">echo</span> <span class="variable">$&#123;gce&#125;</span> | cut -d <span class="string">','</span> -f 3`</span><br><span class="line">  rs_ping=`sudo ping -i0.1 <span class="variable">$&#123;dest_ip&#125;</span> -c <span class="variable">$&#123;ping_count&#125;</span> -q`</span><br><span class="line">  avg=`<span class="built_in">echo</span> <span class="variable">$&#123;rs_ping&#125;</span> | sed -r <span class="string">'s/.*rtt min\/avg\/max\/mdev = (.+?)\/(.+?)\/(.+?)\/(.+?)$/\2/'</span>`</span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$&#123;src_host&#125;</span>,<span class="variable">$&#123;src_zone&#125;</span>,<span class="variable">$&#123;dst_host&#125;</span>,<span class="variable">$&#123;dst_zone&#125;</span>,<span class="variable">$&#123;dest_ip&#125;</span>,<span class="variable">$&#123;avg&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>sh-exec.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Started at `date +<span class="string">"%Y-%m-%d %H:%M:%S.%3N"</span>`</span><br><span class="line"></span><br><span class="line">project_name=<span class="string">""</span></span><br><span class="line">vpc_name=<span class="string">"test-network"</span></span><br><span class="line">shell_file=<span class="string">"ping-all-instances-in-VPC.sh"</span></span><br><span class="line"></span><br><span class="line">format=<span class="string">"csv(NAME,ZONE,INTERNAL_IP)"</span></span><br><span class="line">gce_list=`gcloud compute instances list --filter <span class="string">"networkInterfaces[].network:<span class="variable">$&#123;vpc_name&#125;</span>"</span> --format=<span class="string">"csv(NAME,ZONE)"</span> | sed <span class="string">'1d'</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> gce <span class="keyword">in</span> <span class="variable">$&#123;gce_list&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  host=`<span class="built_in">echo</span> <span class="variable">$&#123;gce&#125;</span> | cut -d <span class="string">','</span> -f 1` </span><br><span class="line">  zone=`<span class="built_in">echo</span> <span class="variable">$&#123;gce&#125;</span> | cut -d <span class="string">','</span> -f 2`</span><br><span class="line"></span><br><span class="line">  gcloud compute scp <span class="variable">$&#123;shell_file&#125;</span> <span class="variable">$&#123;host&#125;</span>:~/<span class="variable">$&#123;shell_file&#125;</span> --zone <span class="variable">$&#123;zone&#125;</span> --tunnel-through-iap</span><br><span class="line">  <span class="built_in">wait</span></span><br><span class="line">  gcloud compute ssh <span class="variable">$&#123;host&#125;</span> --<span class="built_in">command</span>=<span class="string">"sh ~/<span class="variable">$&#123;shell_file&#125;</span>"</span> --zone <span class="variable">$&#123;zone&#125;</span> --tunnel-through-iap</span><br><span class="line">  <span class="built_in">wait</span></span><br><span class="line">  gcloud compute ssh <span class="variable">$&#123;host&#125;</span> --<span class="built_in">command</span>=<span class="string">"rm ~/<span class="variable">$&#123;shell_file&#125;</span>"</span> --zone <span class="variable">$&#123;zone&#125;</span> --tunnel-through-iap</span><br><span class="line">  <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> Finished at `date +<span class="string">"%Y-%m-%d %H:%M:%S.%3N"</span>`</span><br></pre></td></tr></table></figure><h1 id="使い方"><a href="#使い方" class="headerlink" title="使い方"></a>使い方</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh sh-exec.sh</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチャー夏休み自由研究連載&lt;/a&gt;の9回目です。&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;heade
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Network" scheme="https://future-architect.github.io/tags/Network/"/>
    
      <category term="GCP" scheme="https://future-architect.github.io/tags/GCP/"/>
    
      <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
  </entry>
  
  <entry>
    <title>Marpで会社のスライドテンプレを作ってみる</title>
    <link href="https://future-architect.github.io/articles/20200812/"/>
    <id>https://future-architect.github.io/articles/20200812/</id>
    <published>2020-08-11T15:00:00.000Z</published>
    <updated>2020-08-13T03:47:35.687Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/20200812/marp.png" alt=""></p><p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>の8回目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。加藤周平です。</p><p>みなさん、Marpはご存じでしょうか？</p><p>Marpとは、Markdown記述形式でスライドを作成するができるツールです。VSCodeにインストールすることで、VSCode上でスライドの作成を行うことができるようになります。まさにあったらいいなが具現化したようなツールです。もちろん、Marpから作成されたスライドはパワポでの再編集も可能で、骨子づくりはMarp、仕上げはパワポ、なんて合わせ技も行えます。</p><p>今回はそんな<a href="https://marp.app/" target="_blank" rel="noopener">Marp</a>を業務でも平常利用できる状態に持っていくべく、スライドのテンプレートの仕込みをやってみたいと思います。</p><p>※基本的なMarpの理解や利用方法は以下の記事を参考にしました。<br><a href="https://qiita.com/tomo_makes/items/aafae4021986553ae1d8" target="_blank" rel="noopener">【VS Code + Marp】Markdownから爆速・自由自在なデザインで、プレゼンスライドを作る</a></p><h2 id="目指すところ"><a href="#目指すところ" class="headerlink" title="目指すところ"></a>目指すところ</h2><p>こんなのをMarp上でも再現できないか、というのを試してみます。<br>※実際にフューチャーで利用されているスライドとは異なります。</p><p><img src="/images/20200812/template.png" alt=""></p><h2 id="MarpをVSCodeにインストール"><a href="#MarpをVSCodeにインストール" class="headerlink" title="MarpをVSCodeにインストール"></a>MarpをVSCodeにインストール</h2><p>VSCodeを開いて拡張機能から「Marp for VSCode」をインストールします。<br><img src="/images/20200812/vscode.png" alt=""></p><h2 id="themeの作成"><a href="#themeの作成" class="headerlink" title="themeの作成"></a>themeの作成</h2><h3 id="CSSファイルの作成"><a href="#CSSファイルの作成" class="headerlink" title="CSSファイルの作成"></a>CSSファイルの作成</h3><p>今回は「future.css」をローカルのデスクトップ上に作成しました。</p><h3 id="パスを通す"><a href="#パスを通す" class="headerlink" title="パスを通す"></a>パスを通す</h3><p><code>Ctrl + ,</code>で設定を開き、<code>Markdown: Styles</code>に作成したCSSファイルのパスを記載します。<br><img src="/images/20200812/path.png" alt=""></p><p>続いて<code>Markdown&gt; Marp:Themes</code>にCSSのファイル名を記載します。<br><img src="/images/20200812/add_css_file.png" alt=""></p><p><code>template.md</code>の<code>front-matter</code>に以下を記載します。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">marp:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">future</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><p>これでCSSファイルとの紐づけが完了です。</p><h3 id="テンプレ作り"><a href="#テンプレ作り" class="headerlink" title="テンプレ作り"></a>テンプレ作り</h3><p>あとはひたすらCSSを書いていくだけです。<br>結果はこうなりました。</p><p><img src="/images/20200812/image.png" alt=""></p><p>う～ん。。。ぽい、けど遠い。。</p><p>コードはこんな感じです。</p><p><code>template.md</code>は以下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">marp:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">future</span></span><br><span class="line"><span class="attr">header:</span> <span class="string">future</span></span><br><span class="line"><span class="attr">footer:</span> <span class="string">Footer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># こんな感じになりました</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><p><code>future.css</code>は以下</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @theme future */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@import</span> <span class="string">'default'</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">section</span> &#123;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">1920px</span>;</span><br><span class="line"><span class="attribute">height</span>: <span class="number">1080px</span>;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">40px</span>;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">40px</span>;</span><br><span class="line"><span class="attribute">background-image</span>: <span class="built_in">url</span>(./logo.png);</span><br><span class="line"><span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line"><span class="attribute">background-position</span>: right top;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">header</span> &#123;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">1px</span>;</span><br><span class="line"><span class="attribute">color</span>: palevioletred;</span><br><span class="line"><span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(to right, palevioletred, white);</span><br><span class="line"><span class="attribute">top</span>: <span class="number">120px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">footer</span> &#123;</span><br><span class="line"><span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line"><span class="attribute">background-color</span>: silver;</span><br><span class="line"><span class="attribute">color</span>: black;</span><br><span class="line"><span class="attribute">text-align</span>: left;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line"><span class="attribute">font-style</span>: oblique;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">h1</span> &#123;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">90px</span>;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#09c</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="もやっとしたこと-次回への知見"><a href="#もやっとしたこと-次回への知見" class="headerlink" title="もやっとしたこと/次回への知見"></a>もやっとしたこと/次回への知見</h3><ul><li>headerは文字列不要だったのですが、mdの<code>front-matter</code>にて空文字でheaderを宣言することができず、しかたなく<code>future</code>文字列を記載＆backgroundの色に合わせて隠しています</li><li>footerやheaderクラスを複数宣言する方法が分からず、フッターのページ番号の実装までできませんでした（本当はfooterを複数重ねて表現したかった）</li><li>今回はCSSの方で<code>@import default</code>を宣言し、Marpから提供されているスライドのテンプレの上にFutureスライドのテンプレを作っていく、というような作業を行いました。実際にテンプレを作成＆社内配布することを考えた時にはimportせずに1から作っていく方が綺麗かなと思いました</li></ul><h3 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h3><p>大した量を書いてませんがCSSを触るのは新人研修ぶりだったので勉強になりました。</p><p>Markdownで記載したものがすぐスライドに反映される挙動は軽快で、操作していてかなり気持ちが良かったです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/20200812/marp.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチャー夏休み自由研究連載&lt;/a&gt;の8
      
    
    </summary>
    
    
      <category term="Design" scheme="https://future-architect.github.io/categories/Design/"/>
    
    
      <category term="VSCode" scheme="https://future-architect.github.io/tags/VSCode/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="Marp" scheme="https://future-architect.github.io/tags/Marp/"/>
    
      <category term="CSS" scheme="https://future-architect.github.io/tags/CSS/"/>
    
  </entry>
  
  <entry>
    <title>ダイエット食のブレイクスルー！低温調理器を自作して鶏むね肉を美味しく食べる</title>
    <link href="https://future-architect.github.io/articles/20200811/"/>
    <id>https://future-architect.github.io/articles/20200811/</id>
    <published>2020-08-10T15:00:00.000Z</published>
    <updated>2020-08-28T00:52:51.616Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休みの自由研究連載</a>の7回目です。</p><p>こんにちは。筒井です。</p><p>「コロナ太り」という単語をよく目にする今日この頃ですが、皆さんのお腹の具合はいかがでしょうか。</p><p>これからダイエットに取り組もうという方は、おそらく鶏むね肉さんのお世話になるかと思います。鶏むね肉は高たんぱく質で、皮を剥いでしまえば脂質も低い食材です。しかし、調理方法に一工夫加えないとぱさついた食感になってしまうデメリットがありました。</p><p>しかしここ数年、低温調理、あるいはSous videと呼ばれる調理法が登場し、鶏むね肉がとても美味しく食べられるようになりました。</p><p>市場にはAnovaやBONIQといった専用の製品がありますが、せっかくなので自作することにしました。</p><h2 id="設計と部品選定"><a href="#設計と部品選定" class="headerlink" title="設計と部品選定"></a>設計と部品選定</h2><p>低温調理に必要な機能はシンプルで、40℃～70℃程度の水温をキープするだけです。</p><p>システム全体の構成は以下のようになります。目標温度と測定した水温の差がゼロになるようにヒータの出力を制御します。</p><p><img src="/images/20200811/block_diagram.png" alt=""></p><p>まずヒータには、熱帯魚の水槽用のものを使用しました。温度計は自分でこしらえるので、サーモスタット付きのものは使えません。<br><a href="https://www.yodobashi.com/product/100000001003655227/" target="_blank" rel="noopener">https://www.yodobashi.com/product/100000001003655227/</a><br>（買ったのが結構前なので、販売終了してしまっています。すみません。）</p><p>次に温度計ですが、DS18B20という温度センサを防水加工したものを使用しました。<br><a href="https://www.aliexpress.com/item/32862371307.html" target="_blank" rel="noopener">https://www.aliexpress.com/item/32862371307.html</a></p><p>コントローラにはESP32を使用しました。ゆくゆくはスマホから操作を行うことを見越しての選定です。<br><a href="http://akizukidenshi.com/catalog/g/gM-11819/" target="_blank" rel="noopener">http://akizukidenshi.com/catalog/g/gM-11819/</a> </p><p>コントローラからヒータを制御するには、AC100Vをオン/オフする必要があります。これにはソリッドステートリレーを使用しました。<br><a href="http://akizukidenshi.com/catalog/g/gK-00203/" target="_blank" rel="noopener">http://akizukidenshi.com/catalog/g/gK-00203/</a></p><h2 id="制作"><a href="#制作" class="headerlink" title="制作"></a>制作</h2><p>これらを組み立てたのが以下の写真です。ケースはダイソーで購入した容器です。</p><p><img src="/images/20200811/overview.jpg" alt=""></p><p>SSRは基板付きのキットを購入しましたが、かさばるのでユニバーサル基板に実装してしまいました。実装時の注意点として、絶縁のためにAC100Vの配線はユニバーサル基板上で1コマずつ空けて配線し、ランドを削り取っておくのが良いでしょう。</p><p>また設計のところでは解説しませんでしたが、温度を表示するためのディスプレイを追加しています。</p><p>ざっくりとした接続図は以下のようになります。</p><p><img src="/images/20200811/schematics.png" alt=""></p><p>さらにポンプという新キャラが出てきましたが、これは水を撹拌するためのものです。<br><a href="https://www.amazon.co.jp/dp/B07D29YT2C/" target="_blank" rel="noopener">https://www.amazon.co.jp/dp/B07D29YT2C/</a></p><p>最初は自然対流のみで水温が均一になるかと思ったのですが、思いの外鍋の中で温度差が生じてしまったためポンプを追加しました。</p><h2 id="ソフトウェアの実装"><a href="#ソフトウェアの実装" class="headerlink" title="ソフトウェアの実装"></a>ソフトウェアの実装</h2><p>実装したソフトウェアの一部を抜粋します。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">control</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// DS18B20から温度を取得する</span></span><br><span class="line">  <span class="keyword">uint32_t</span> convTime = ds18b20.requestTemperature();</span><br><span class="line">  <span class="built_in">delay</span>(convTime);</span><br><span class="line">  <span class="keyword">float</span> temperature;</span><br><span class="line">  <span class="keyword">if</span> (ds18b20.getTemperatureC(&amp;temperature) != OK)</span><br><span class="line">  &#123;</span><br><span class="line">    log_e(<span class="string">"Failed to measure temperature."</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  log_i(<span class="string">"Temp = %.4f deg-C"</span>, temperature, temperature);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ディスプレイに温度を表示する</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line">  <span class="built_in">sprintf</span>(buf, <span class="string">"%2.1f %lcC"</span>, temperature, <span class="number">0xb0</span>);</span><br><span class="line">  displayTask.displayMessage(buf);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ヒーター制御</span></span><br><span class="line">  <span class="keyword">if</span> (temperature &lt; (target_temp - <span class="number">1</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    acSwitch.turnOn();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (temperature &gt; (target_temp + <span class="number">1</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    acSwitch.turnOff();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ヒーターの制御は、ヒステリシスを持たせたオンオフ制御としています。例えば目標温度を60度とした場合、測定した水温が61度を上回ったときにヒーターをオフに、59度を下回ったときにオンにします。</p><h2 id="調理"><a href="#調理" class="headerlink" title="調理"></a>調理</h2><p><img src="/images/20200811/cooking.jpg" alt=""></p><p>調理中の様子です。乱雑なキッチンですみません。</p><p>バケツに10Lほどの水を張り、そこにジップロックにいれた鶏むね肉と、ヒータ、温度計、ポンプを放り込みます。</p><p>今は10Lのバケツに8Lほどの水で使用していますが、温度を保つ分には200Wのヒータで十分です。しかし、20度ほどの水を60度まで温めるのは不可能と思ったほうがいいかもしれません。我が家は幸い給湯器から60度のお湯が出せるので、それを使用しています。</p><h2 id="実食"><a href="#実食" class="headerlink" title="実食"></a>実食</h2><p>お待ちかねの実食です！</p><p><img src="/images/20200811/chicken.jpg" alt=""></p><p>鶏むね肉の下ごしらえは何もしませんでしたが、とってもやわらかーく仕上がっています。加熱は62度で1時間行い、引き上げ後にジップロック内に軽く塩をして、10分ほど休ませました。</p><p>ソースはねぎ塩にんにくだれです。長ねぎとにんにくをみじん切りにして、ごま油と塩で和えただけの簡単たれですが、病みつきになる美味しさです。にんにくパワーで夏を乗り切りましょう。</p><p>鶏むね肉を丸々1枚（約300g）使ったのでかなりの食べごたえです。それなのに、これ全部食べてもおよそ400kcal！ダイエットにピッタリの高たんぱく食です。<br>（鶏むね肉の皮は剥ぎ取っています。余った皮はまとめて冷凍しておいて、ある程度溜まったら鶏油を作るのがおすすめです。）</p><p><img src="/images/20200811/pork.jpg" alt=""></p><p>こちらは同様に豚バラ肉を65度で3時間加熱したものです。</p><p>脂身がほとんど溶け出しておらず、非常に罪深い食感です。こちらは八角を効かせた東坡肉風のソースに、白髪ねぎと辛子を添えて頂きました。</p><p>脂質が多いのでダイエットには向いていませんが、とても美味しかったです。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>自作の低温調理器で、鶏むね肉をとても美味しく食べられました。ダイエット食のブレイクスルーです。</p><p>課題としては、ヒータ出力の200Wが少し力不足なこと、ケーブルの取り回しが煩雑なことがあります。調理に支障はありませんが、使い勝手があまり良くありません。</p><p>今回の製作にかかった費用は以下の通りです。</p><table><thead><tr><th>品目</th><th>金額</th></tr></thead><tbody><tr><td>ヒータ</td><td>\2,200</td></tr><tr><td>温度計</td><td>\150</td></tr><tr><td>ポンプ</td><td>\1,100</td></tr><tr><td>ESP32</td><td>\1,500</td></tr><tr><td>ソリッドステートリレー</td><td>\250</td></tr><tr><td>その他配線材、ケースなど</td><td>\1,000</td></tr></tbody></table><p>合計で<strong>6,200円</strong>でした。</p><p>一方市販品を調べてみると、アイリスオーヤマの低温調理器が1万円を切る価格で売られていました。<br><a href="https://www.amazon.co.jp/dp/B07Z5482Y6" target="_blank" rel="noopener">https://www.amazon.co.jp/dp/B07Z5482Y6</a></p><p>賢明な皆様は、市販品を買ったほうが良いと思います。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチャー夏休みの自由研究連載&lt;/a&gt;の7回目です。&lt;/p&gt;
&lt;p&gt;こんにちは。筒井です。&lt;/p&gt;
&lt;p&gt;「コロナ太り」という単語をよく目にする
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="電子工作" scheme="https://future-architect.github.io/tags/%E9%9B%BB%E5%AD%90%E5%B7%A5%E4%BD%9C/"/>
    
      <category term="Future電子工作部" scheme="https://future-architect.github.io/tags/Future%E9%9B%BB%E5%AD%90%E5%B7%A5%E4%BD%9C%E9%83%A8/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="ESP32" scheme="https://future-architect.github.io/tags/ESP32/"/>
    
      <category term="料理" scheme="https://future-architect.github.io/tags/%E6%96%99%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>自動売買ツールを自作してみよう</title>
    <link href="https://future-architect.github.io/articles/20200810/"/>
    <id>https://future-architect.github.io/articles/20200810/</id>
    <published>2020-08-09T15:00:00.000Z</published>
    <updated>2020-08-11T07:14:43.627Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休みの自由研究連載</a>の6回目です。</p><h2 id="自己紹介"><a href="#自己紹介" class="headerlink" title="自己紹介"></a>自己紹介</h2><ul><li>所属：テクノロジーイノベーショングループ</li><li>社会人歴： 5年目のITコンサルタント</li><li>好きな言語：Python、Go</li><li>苦手な言語：日本語</li><li>趣味：<ul><li>特定な問題を解くため、技術要素を組み合わせて応用すること<ul><li>例えば、ボードゲームやルービックキューブのようなパズルをモデリングしてプログラミングで解くこと</li></ul></li><li>時間かかる定形作業を自動化すること</li></ul></li></ul><p>夏自由の研究では、<strong>大人たちが大好きな刺激的な「おカネ」の話</strong>をしようと思います。個人プロジェクトとして、IT技術、数学と金融の知識を融合し、FX<a href="https://ja.wikipedia.org/wiki/%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%83%BC%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3" target="_blank" rel="noopener">バイナリオプション</a>の自動売買ツールを作ります。</p><p><strong>🚧どんなに技術を使っても、ハイリスクであることは相変わらず、損する可能性も十分にあります。本記事への利用についてご注意ください🚧</strong></p><p>本文にもFXバイナリオプションのルールを簡単に説明しますが、どうしてもやってみないとイメージつかない方は、<a href="https://fx-navi.tokyo/category/bo" target="_blank" rel="noopener">こちらの記事</a> も参考ください。証券会社が提供している無料のデモ取引をやってみるのもオススメです。</p><h2 id="自動売買ツールを自作する経緯"><a href="#自動売買ツールを自作する経緯" class="headerlink" title="自動売買ツールを自作する経緯"></a>自動売買ツールを自作する経緯</h2><h3 id="趣味優先"><a href="#趣味優先" class="headerlink" title="趣味優先"></a>趣味優先</h3><p>私はデータを操ることが大好きです。自然からのデータも人間活動におけるデータも収集&amp;分析し、知られていない隠れた知識を解明することが、何よりも楽しいことだと思います。</p><p>学生時代から少しずつ株や投信やFXを試してきましたが、あまり良い資産運用の成績にならず、自分には才能も金運も無いことを自覚しました。時間とお金の無駄にならないように資金管理や投資を自動化し、時間のコストの削減と成績向上に繋げたら良いなと思い始めました。</p><h3 id="失敗談"><a href="#失敗談" class="headerlink" title="失敗談"></a>失敗談</h3><p>今年5月頃、私はFXバイナリオプションをトレードした実履歴です。入金した<strong>15万円</strong>は、1週間でほぼ全損し大失敗でした。<br><img src="/images/20200810/chart.png" alt=""></p><p>後から振り返ると、様々な誤りや感情的な動きを発見しました。</p><p>例えば、22日14:00の操作は、画面上の「買」と「売」ボタンを間違えて逆操作してしまいました。この1ポチったミスだけで、3万円以上の損失が1秒以内に発生。投資は本当に色々な意味のハイリスクですね。</p><p>ちなみに、FXバイナリオプションは判定時刻（普通は数時間以内）のFX通貨ペアの値段は、あるターゲット値段以上になるか、以下になるかを当ててみるゲームです。もちろん、当たりなら賞金が出て、はずれなら当初の参加費を没収されます。</p><p><strong>FXバイナリオプションのルール</strong>を簡単に説明すると、</p><ul><li>1枚の「HIGH」チケットを買うと、特定な時刻にターゲットFX通貨ペア（例えばUSD/JPY）が、もし約束の値段以上なら1000円もらえる、もし逆な場合は0円をもらえ、チケットの購入料を全額損する</li><li>同じように、1枚の「LOW」チケットを買うと、特定な時刻にターゲットFX通貨ペアが、もし特定な値段よりより低いなら1000円もらえる、もし逆な場合は0円をもらえ、チケットの購入料を全額損する</li><li>判定時間までにいつでもチケットを買えますが、それに必要な料金（数円〜1000円）が、ターゲット通貨ペアの値動きなどに影響され、時間と共に変動していく</li></ul><p>上の表に結果欄にある「SETTLED」は、予測があっていた意味で、チケット枚数かける1000円のペイアウトがもらえます。「OUT_THE_MONEY」は、予測が外れ、チケット購入料を全損。値動きの途中で、損切りや利確でも行えます「SELL_BACK」。</p><p>売買の間にFXのスプレッドスプレッドのような値段差は手数料として代価になります。</p><p>上の1週間のトレードに対して、初期損益はゼロからスタートとすると、損益の変化は以下のようなグラフになります。<br><img src="/images/20200810/manual_oper.png" alt=""></p><p>前半、5万円弱儲かる時期もありますが、後半は調子に乗って大額の取引を始め、一気に転落。2、3回ぐらい反発がありましたが裏返すことは無理でした。</p><h3 id="人間性の弱点"><a href="#人間性の弱点" class="headerlink" title="人間性の弱点"></a>人間性の弱点</h3><p>客観的に反省したら、これはまさに人間性の弱点を映っている鏡ではないでしょうか。</p><ul><li>人間は感情に左右される、非理性的な行動を取ること多々でしょう<ul><li>利益を得られる状況では、安定を求めてリスクを回避する。少しだけ評価益になった時、すぐに利確で逃げてしまう</li><li>損失を被る状況では、リスクを負ってでも損失を回避し、その結果、逆に損失拡大してしまう</li><li>よって、いつも益が小さく、損が大きい、それを繰り返している</li></ul></li><li>人間は反応が遅くて冷静に計算したら時間がかかる。少し躊躇したら、利益のチャンスや損切りのタイミングなどすぐに見逃してしまう</li><li>人間はどんなに慎重に操作しても、疲れや不注意でミスで誤操作を避けるのはがどうしても難しいでしょう</li></ul><p><strong>こんな弱い人間、武器を何も持っていないままで戦場に立つのは、勇気ではない、ただの犠牲です！</strong></p><p>武器となる機械で実現した自動売買を使うメリットが明らかですね。</p><ul><li>機械が休まずに、僕が寝ている間でも働いてくれる</li><li>機械が理性的で、我々人間のように感情的に左右されることがない</li><li>同時に複数のパラメータやデータを見ることができ、短時間に反応できる</li></ul><h2 id="チャンスは本当にあるのか"><a href="#チャンスは本当にあるのか" class="headerlink" title="チャンスは本当にあるのか"></a>チャンスは本当にあるのか</h2><h3 id="大数の法則"><a href="#大数の法則" class="headerlink" title="大数の法則"></a>大数の法則</h3><p><strong>機械を使って代行トレードすれば、勝つでしょうと思ったら？ちょっと待ってと！</strong></p><p>敵は人間性だけではないのです。儲けるかどうかは期待値や確率の問題です。カジノでギャンブルのゲームたちは、勝つ確率が明確に計算されて、リターン対リスクの期待値がそもそもマイナスですね。</p><p>「マーチンゲール」という負けたら倍に賭ける方法、「パーレー法」という勝ったら倍に賭ける方法などなど、いろいろストラテジーが存在しますが、みんなカジノに負けてしまいます。</p><p>そもそも期待値がマイナスの不利な儲けは、個別に勝つ確率が確かに0ではないが、ただし長期的に繰り返すほど勝てる希望がなくなります。最終的に大数の法則につかまるわけです。</p><p>売買のスプレッドが存在する時点で、期待値が不利なわけです。言い換えると、ランダムにトレードするなら、売り手と買う手がバランス良い場合、証券会社はカジノの親のように安定な収入が入ってくるわけです。</p><p>敵は数学ですので、武器も数学にあります。</p><p>チケットの値段は判定時刻になるまでずっと変化しているので、勝つ確率とペーアウトの比率も常に変動しているんです。例えば、勝率は90%の標的は、チケット値段が950円、勝つ可能性が高いけれど、勝ったらただプラス50円益、万が一負けたら、マイナス950円損です。実は利益の期待値がマイナスなので、不利な取引です。また、仮に勝率は25%、チケット値段が200円の場合、4分の3の可能性でその200円を損しますが、勝ったら800円を得ます。それは有利なトレードです。チャンスがあれば繰り返し続けるべきです。</p><p>いつも各チケットの予想勝率と今の値段が有利か不利かをリアタイムで計算して、有利の場合しかトレードしないことは、勝ちパターンですね。</p><p>問題の根本は、やっているゲームに（例えばバイナリオプション）、スプレッドに勝てる有利なトレードのチャンスが本当にありますか、それとも、ギャンブルのように、いつもマイナス期待値の罠っだらけですか。</p><p>検証してみないとわからないですね。</p><h3 id="予め習った有用な概念"><a href="#予め習った有用な概念" class="headerlink" title="予め習った有用な概念"></a>予め習った有用な概念</h3><ul><li>分散の長期記憶性に基づいた予測の<a href="https://ja.wikipedia.org/wiki/ARCH%E3%83%A2%E3%83%87%E3%83%AB#GARCH(p,q)%E3%83%A2%E3%83%87%E3%83%AB" target="_blank" rel="noopener">GARCH</a><br>モデルを使って判定時の値段帯に落ちる確率を計算する<ul><li>金融時系列データに対して、値動きの方向より、値動きの分散（ボラティリティ）の予測の精度が高いらしい</li><li>Pythonはさすがデータサイエンティストの大好物、GARCH及び拡張モデルの実装ライブラリまで提供している → <a href="https://pypi.org/project/arch/" target="_blank" rel="noopener">arch</a></li></ul></li><li><a href="https://en.wikipedia.org/wiki/Kelly_criterion" target="_blank" rel="noopener">ケリー基準</a>を使ってトレードは有利なのか不利なのか、有利ならトレードの量を何割にするかを決める<ul><li><code>kelly = win_rate - (1-win_rate) * premium / (1-premium)</code></li><li><code>kelly</code>値は、1回のトレードで手元にある投資用の総資金の割合の基準。それは、損失のリスクを考えた上で、論理上資金を一番効率的に増やす投資の比率である</li><li><code>kelly</code>値は<code>win_rate</code>(勝つ確率)と<code>premium</code>（チケットの料金は950円、ペーアウトは1000円の場合は<code>premium = 950/1000 = 0.95</code>）によって計算された</li><li><code>win_rate</code>&lt;=<code>premium</code>の場合、<code>kelly</code>&lt;=0、それは不利な取引を意味して、手を出さないほうが良い</li><li><code>win_rate</code>が1ではない時、オールインしてはいけない。それは論理上全損のリスクを避けられて、いつまでも裏返す可能性を放棄しない</li></ul></li></ul><p>改めて、その悔しい1週間の手動の取引を振り返って見たらどうかと思い、取引発生時点<strong>以前</strong>の値動き情報をGARCHモデルに投入し、判定時の勝つ確率(<code>win rate</code>)を評価し、理性的な投資比率(<code>kelly</code>)を出してみました。</p><img src="/images/20200810/kelly.png" class="img-middle-size"><p>どうやら汗が出るほどびっくりしました。手動で取引したのは、半分以上が不利な(kelly&lt;0)取引だったことが分かりました。そして、有利な取引に対しても、もっと「正確な」比率で資金を出せば、もっと良い結果になったはずです。悔しくてたまりません。</p><h2 id="自動売買ツールを自作する流れ"><a href="#自動売買ツールを自作する流れ" class="headerlink" title="自動売買ツールを自作する流れ"></a>自動売買ツールを自作する流れ</h2><h3 id="市販より自作"><a href="#市販より自作" class="headerlink" title="市販より自作"></a>市販より自作</h3><p>「自動売買」をグーグルで検索したら、つないで出てくるキーワードは、「比較」、「おすすめ」とかはもちろん出てきますが、なんと「詐欺」、「稼げない」のも出るので、危ない感を楽しめるリスク屋さん向けの雰囲気が湧いています。</p><p>私も市販の自動売買をあまり信用しない派です。なぜなら、みんなが掘りに行く金鉱には、もう金が無いと思うからです。売買シグナルやインジケータは最初はよく効くかもしれませんが、広く知られたら、真似られて利益も山分けになって利益が小さくなるのです。</p><p>自作の良い点をあげます。</p><ul><li>手数料がかからないので、手数料が利益に勝てない心配なし</li><li>中身がすべて把握できて安心</li><li>自作なのでカストマイズしやすく、随時に進化できる</li></ul><h3 id="ターゲットをバイナリオプションに設定"><a href="#ターゲットをバイナリオプションに設定" class="headerlink" title="ターゲットをバイナリオプションに設定"></a>ターゲットをバイナリオプションに設定</h3><p>主流のFXや株の戦場を避けて、ちょっと亜流系のバイナリオプションを対象にしています。<br>理由は下記のようにリストアップします。</p><ul><li>売買や勝負のルールは簡単</li><li>ルールによって、バイナリオプションはハイリスクだが、利益と損失の限界が取引の前にも読める</li><li>ターゲットはFXデータなので、公開性がある</li><li>比較的に値動きの方向より、値動きの分散（ボラティリティ）の予測の精度が高いらしく、バイナリオプションは、値動きの分散の大小の予測でトレード可能（後述のストラドル法）</li><li>リスクとリターンの最大値が操作する前にも読める。比較的に単純なルールなので、自動化しやすいところがある</li><li>自動売買に委ねるが、高頻度の売買操作が不要（1シリアルは例えば2時間で1回の操作のみ）のため、不正操作の理由でアカウントがフリーズされるリスクが減った（ただしゼロリスクではない）</li></ul><h3 id="具体的に実践した流れはこんな感じ"><a href="#具体的に実践した流れはこんな感じ" class="headerlink" title="具体的に実践した流れはこんな感じ"></a>具体的に実践した流れはこんな感じ</h3><ul><li>アカウント開き、やり方やルールを慣れていく（2、3年前から）<br>↓</li><li>データ収集を自動化（今年4~5月から、コロナのGWの暇つぶしでスタート）<br>↓</li><li>画面上の手動操作の代わりに、売買操作の機械化、自動化（5~6月）<br>↓</li><li>予測モデルを導入し、直近の歴史データを使ってシミュレーションを実施（←直近まで）<br>↓</li><li>パラメータ調整しつつ、実運用を試みる（←今ここ）<br>↓</li><li>経済指標などの外部要素の影響を分析し、もう一層モデルの予測精度を向上（将来プラン）</li></ul><p>この自動売買システムが本当に儲けられるか？実績はどうだったの？を報告したかったんですが、まだそのステップに進行していなくて、ちょっと残念です。今回はシミュレーション結果だけ出します。<br>本運用開始してから継続的に報告しようと思います。</p><h3 id="システムの構成はこんな感じ"><a href="#システムの構成はこんな感じ" class="headerlink" title="システムの構成はこんな感じ"></a>システムの構成はこんな感じ</h3><p><img src="/images/20200810/constructure.png" alt=""></p><h4 id="①ポーリングクライアント"><a href="#①ポーリングクライアント" class="headerlink" title="①ポーリングクライアント"></a>①ポーリングクライアント</h4><p>PythonのrequestパッケージのSessionを使って、ログイン後のクッキー情報を保持しながら継続的にAPIを本物クライアントの発信頻度でデータをポーリングするクライアントです。将来的にデータを分析にするため、Elasticsearchを使って溜め込んでいます。</p><p>Kibanaですぐに可視化できるのが便利ですね。</p><p><img src="/images/20200810/polling_client.png" alt=""></p><h4 id="②取引に関するAPIクライアント"><a href="#②取引に関するAPIクライアント" class="headerlink" title="②取引に関するAPIクライアント"></a>②取引に関するAPIクライアント</h4><p>取引命令を出すコンポーネントです。ポーリングのクライアントとほぼ同じ作りですが、管理上の利便さと開発時の誤操作を防ぐため、別コンポネントに分けています。</p><h4 id="③予測モデル"><a href="#③予測モデル" class="headerlink" title="③予測モデル"></a>③予測モデル</h4><p>前述のGARCHライブラリを使って、2〜4時間の履歴データを使って、近い将来の確率をイメージとして、このような情報を出す感じです。</p><p>「次の判定時刻20:20に、USD/JPYはターゲット値段106.6より高い確率は32%、106.6以下の確率は68%」</p><h4 id="④意思決定"><a href="#④意思決定" class="headerlink" title="④意思決定"></a>④意思決定</h4><p>1ターンの中に、資金数や保有できるチケット数の数の上限がありますので、kelly値がプラスになったらすぐに動作するのではなく、全体的なベストを求めたいのです。</p><p>早い段階に決断したら、後からもっと良いチャンスを失うかもしれませんが、ずっと躊躇して決めないままで、過去に戻れないし、最良の停止タイミングを探す<a href="https://ja.wikipedia.org/wiki/%E7%A7%98%E6%9B%B8%E5%95%8F%E9%A1%8C" target="_blank" rel="noopener">秘書問題</a>が参考になるかと思います。<br>そして、いろんなストラテジーやパラメータをシミュレーションして継続的に調整するのです。</p><h4 id="⑤シミュレーション"><a href="#⑤シミュレーション" class="headerlink" title="⑤シミュレーション"></a>⑤シミュレーション</h4><p>Elasticsearchに溜めた過去データは学習の材料になって、どういうストラテジーやパラメータを適用したら儲かるか、そして、過学習にならないように、今回使っているデータだけにフィットするじゃなくて、モデルのパラメータをなるべく減らします。</p><p>GARCHモデルの<a href="https://ja.wikipedia.org/wiki/%E3%83%99%E3%82%A4%E3%82%BA%E6%83%85%E5%A0%B1%E9%87%8F%E8%A6%8F%E6%BA%96" target="_blank" rel="noopener">ベイズ情報量規準 BIC</a>（モデルのパラメータの数が多いほどモデル精度の評価に罰を与える評価基準）を参考しながら、一定の水準以下のものだけ採用する形になります。</p><p>以下はいい加減なパラメータを使ったシミュレーションです。初期10000円の資本金とその後の変化の結果です。</p><p>6月1ヶ月間の実データを使っています。私手動で1週間全損より、1ヶ月間でほぼ全損でしたね。</p><p><img src="/images/20200810/simulation1.png" alt=""></p><p>パラメータを適度に調整して、少し改善された例ですが、まだ右肩下がりのトレンドですね。</p><p><img src="/images/20200810/simulation2.png" alt=""></p><p>以下は、<em>ストラドル戦略</em>と普通の売買のミックスを使ったシミュレーションの資本金の変化の結果です。<br>月末に月初の2.5倍になりました。</p><p><img src="/images/20200810/simulation3.png" alt=""></p><p><em>ストラドル戦略</em>とは、前述の値動きの方向を予測しなくて、値動きの変動（分散やボラティリティ）の量を予測できたら儲かる方法です。</p><h3 id="【補足】ストラドル戦略"><a href="#【補足】ストラドル戦略" class="headerlink" title="【補足】ストラドル戦略"></a>【補足】ストラドル戦略</h3><p>オプション取引の戦略の一つです。</p><p>例えば、<code>USD/JPY 108.7 HIGH</code>と<code>USD/JPY 108.6 LOW</code>の同枚数を購入し、相場が108.6〜108.7の範囲で動くと損失、相場がその範囲外に大きく動いた場合は利益です。</p><p>このストラテジーは、ある程度リスクのヘッジが可能です。もっと大きい意味は、予測モデルを使って、値段の動き方向の精度とは関係なく、値段の分散（ボラティリティ）の予測は、ある程度の精度が出るなら問題ありません。</p><h2 id="注意書き"><a href="#注意書き" class="headerlink" title="注意書き"></a>注意書き</h2><p>バイナリオプションは1アカウントつき買えるロット数は上限がある（ギャンブルとかも一緒）、複利として回せません。つまり、他の金融投資みたいに、儲かったお金を用いて、比率的に拡大していくことは不可能なので、長期的な運用には向いていません。一定規模の資金になったら、配当のように徐々に出金していくのが賢明的ですね。</p><p><strong>どんなに技術を使っても、ハイリスクであることは相変わらず、損する可能性も十分にあります。</strong></p><p>その理由は以下です。</p><ul><li>予測モデルのインプットがあくまで過去のデータだけ、未来に対する予測の精度が有限である</li><li>有利なトレードでも、個別に損することが十分ありうる。続けてやらないと、大数の法則の威力が発揮できない</li></ul><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><ul><li>今回自動売買ツールを自作する理由<ul><li>トレーディングは人間性違反で、私もそれに才能がない</li><li>信用しない市販系ツールにお金をかけたくない</li><li>IT技術なら持っており、数学・金融の知識なら勉強できる</li><li>本当に行けるかどうかを探求したい好奇心駆使、何よりも趣味が大事</li></ul></li><li>今回自動売買ツールを必要な知識、技術<ul><li>FXバイナリオプションの概念とルール</li><li>GARCHモデル：分散の長期記憶性に基づいた予測のGARCHモデル</li><li>ベイズ情報量規準：過剰適合を防止のため、モデルの精度をあげる同時にパラメータの数を最小化する用の指標</li><li>Kelly基準：勝率とペーアウトが分かれば、取引が有利か不利かを判別でき、有利な取引に対して何割を賭けたほうが効率的なのが分かる</li><li>ストラドル戦略：値動きの方向の予測を諦め、分散の予測で儲かる手法（経済指標などの開示前に使うのが有効かもしれない　←将来にこの要素を自動取引に取り込むと思います）</li><li>自動化データ収集、変形、分析に必要なIT技術</li><li>丁寧なパラメータ調整、長く続く忍耐</li></ul></li><li>今回自動売買ツールを作った結果<ul><li>手動トレーディングはダメダメでしたが、自動化によって、リターンの期待値がマイナスの不利なトレードを避けられた</li><li>ストラドル戦略などリスクヘッジの手法を併用して、いい結果を得られるシミュレーションをした</li><li>システムの改善をしつつあるが、手動トレードをやめて、完全に自動化するのはこれから。</li></ul></li></ul><p>寝ている間もチャリンチャリンが聞こえるかもしれません。（笑）</p><p><img src="/images/20200810/image.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチャー夏休みの自由研究連載&lt;/a&gt;の6回目です。&lt;/p&gt;
&lt;h2 id=&quot;自己紹介&quot;&gt;&lt;a href=&quot;#自己紹介&quot; class=&quot;head
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Elastic-Stack" scheme="https://future-architect.github.io/tags/Elastic-Stack/"/>
    
      <category term="Kibana" scheme="https://future-architect.github.io/tags/Kibana/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="FinTech" scheme="https://future-architect.github.io/tags/FinTech/"/>
    
      <category term="ElasticSearch" scheme="https://future-architect.github.io/tags/ElasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>API Meetup Online #3で限定公開URL（Capability URLs）について話をしてきました。</title>
    <link href="https://future-architect.github.io/articles/20200809/"/>
    <id>https://future-architect.github.io/articles/20200809/</id>
    <published>2020-08-08T15:00:00.000Z</published>
    <updated>2020-08-11T15:23:23.762Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200809/93281_normal.png" class="img-middle-size"><p><a href="https://api-meetup.doorkeeper.jp/events/109648" target="_blank" rel="noopener">API Meetup Online #3</a>での登壇をお誘いをいただいたので、以前から調査していたものの、発表の機会のなかった限定公開URLについて調べていた内容を発表しました。</p><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vRLdRFqBXd35VgVUCvrXsn3kN4rUu7HDzIoy0Kibs_ThTD3mnWpagkGkpNY1a7J8uWijf0lX8SdRBo3/embed?start=false&loop=false&delayms=3000" frameborder="0"  width="100%" height="569px" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><p>Real World HTTPの第3版が出るとしたら（具体的な計画とかはないですが）入れるかも、なネタでした。どちらかというとコンシューマー向けな機能な気がしますが、hipchatは以前、共有したファイルがこのCapability URLsだったという噂も聞きますし、サービスによってはエンプラでも使っているものもあるかもしれません。自分で実装するにしても、利用する側だったりといろんな立場でこの機能に関わる場合に、その安全性を評価する物差しは持っておきたいな、ということで調べました。</p><p>セキュリティ的には、「特定の誰かのファイルを見つける」でも、「誰でもいいからコンテンツを見つける」でも、かなり見つけるのは難しいんじゃないか、というのが所感です。ただ、「誰がいつアクセスしたのか」という証跡が必要な場合には合わないかもね、というのもありますし、ユーザー情報などをやりとりしないで「知っている」という条件だけで他のシステムとの連携が簡単に行えたりもするので、使えるかどうかはシステムごとの要件次第ですね。その要件と照らし合わせて使えるかどうか判断するためにもまとまった資料として価値があるんじゃないかと思います。</p><p>当日質問された、キーの衝突に関してですが、生成したキーはDBに登録しておく必要があります。これは本番のコンテンツを参照するのにも必要ですし、誰が生成したものか、リソースオーナーとの紐付けのためにも必要です。あとからオーナーが共有を解除したりとかもありますからね。そのため、DBに保存しておいて、それとの重複チェックは可能です。参考のGo実装を貼っておきます。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">"io"</span></span><br><span class="line">   <span class="string">"crypto/rand"</span></span><br><span class="line">   <span class="string">"encoding/base64"</span></span><br><span class="line">   <span class="string">"image"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//本当はDBとかを使う</span></span><br><span class="line"><span class="keyword">var</span> existingImages := <span class="keyword">map</span>[<span class="keyword">string</span>]image.Image</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genPublicKey</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    baseCode := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">30</span>)</span><br><span class="line">    <span class="comment">// 重複した公開URLを生成しないように、ループしてぶつからないキーが確実に生成されるようにする</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        io.ReadFull(rand, baseCode)</span><br><span class="line">        publicKey := base64.StdEncoding.EncodeToString(baseCode)</span><br><span class="line">        <span class="keyword">if</span> _, ok := existingImages[publicKey]; !ok &#123;</span><br><span class="line">            <span class="keyword">return</span> publicKey;        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerImage</span><span class="params">(img image.Image)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    key := genPublicKey()</span><br><span class="line">    existingImages[key] = img</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://example.com/images/"</span> + key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>このサンプルは雑にbase64にしていますが、記号が入らないエンコードとしてbase62があります。UUID v4なんだけどbase64でなるべく文字列長を短くするGoライブラリも昔作ってみました。このあたり、どれだけ短くするか、利便性とセキュリティや空間の広さをどうするかはエンジニアリング的にチャレンジが楽しい分野かと思います。どういったID生成ロジックを使ってはいけないか、とかも資料では触れています。</p><p><a href="https://github.com/shibukawa/uuid62" target="_blank" rel="noopener">https://github.com/shibukawa/uuid62</a></p><p>他には、Google CloudのAI系のAPIの発表がありました。仕事や趣味で使うチャンスもあるので知らない内容はなかったのですが、「アンパンマン」を含む音声をリアルタイムにテキスト化し、さらに英語翻訳するというクラウドエースの藏持さんの発表のデモは面白かったです。ウェザーニューズ（ズは濁点）の井原さんの発表も、データ量とかもろもろでその分野での圧倒的な感じがあって良かったです。チャンスがあれば使ってみたい。</p><p>API Meetupの運営のみなさま、発表の機会をいただきありがとうございました。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200809/93281_normal.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://api-meetup.doorkeeper.jp/events/109648&quot; target=&quot;_
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="登壇資料" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E8%B3%87%E6%96%99/"/>
    
      <category term="Web" scheme="https://future-architect.github.io/tags/Web/"/>
    
      <category term="HTTP" scheme="https://future-architect.github.io/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>GoとSuffixArray</title>
    <link href="https://future-architect.github.io/articles/20200807/"/>
    <id>https://future-architect.github.io/articles/20200807/</id>
    <published>2020-08-06T15:00:00.000Z</published>
    <updated>2020-08-11T02:24:20.940Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200807/suffixarray.png" class="img-small-size"><p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休みの自由研究連載</a>の5回目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIG の辻です。</p><p>Go は標準ライブラリが充実しているとよく言われます。標準ライブラリだけで、HTTP サーバを作れたり、暗号化処理や、JSON や CSV といったデータ形式を扱うことができます。<code>go list std | grep -v vendor | wc -l</code> としてパッケージ数を見てみると、約 200 ものパッケージが存在することがわかります。本記事では、その多くの Go の標準ライブラリの中でも、個人的に面白いなと思ったライブラリを紹介したいと思います。<a href="https://golang.org/pkg/index/suffixarray/" target="_blank" rel="noopener">suffixarray</a> パッケージです。</p><p><code>suffixarray</code> パッケージは Suffix Array を扱うライブラリです。<code>suffixarray</code> パッケージの魅力を感じるには、まず Suffix Array とは何か？を知る必要があるでしょう。</p><h2 id="Suffix-Arrayとは"><a href="#Suffix-Arrayとは" class="headerlink" title="Suffix Arrayとは"></a>Suffix Arrayとは</h2><p>Suffix Array はデータ構造の 1 つです。1990 年に Udi Manber, Gene Myers によって考案されました。Suffix Array を用いると、検索したい任意の文字列から、漏れなく高速に文字列を検索できます。全文検索やデータ圧縮といった応用があります。</p><p>Suffix Array は文字列のすべての suffix を辞書順でソートし、それぞれの suffix の元の文字列における開始位置を保持する配列です。長さが n である文字列 T の suffix とは 1 ≦ i ≦ n なる i について T の i 文字目から n 文字目までの部分文字列のことを指します。具体的に <code>banana</code> という文字列で考えてみます。<code>banana</code> のおける suffix は以下の 6 つです。</p><ul><li>banana</li><li>anana</li><li>nana</li><li>ana</li><li>na</li><li>a</li></ul><p>各 suffix の開始位置をあわせて記載すると以下のようになります。</p><table><thead><tr><th align="left">開始位置</th><th>suffix</th></tr></thead><tbody><tr><td align="left">1</td><td>banana</td></tr><tr><td align="left">2</td><td>anana</td></tr><tr><td align="left">3</td><td>nana</td></tr><tr><td align="left">4</td><td>ana</td></tr><tr><td align="left">5</td><td>na</td></tr><tr><td align="left">6</td><td>a</td></tr></tbody></table><p>これらの suffix を辞書順でソートすると以下のようになります。</p><table><thead><tr><th align="left">開始位置</th><th>suffix</th></tr></thead><tbody><tr><td align="left">6</td><td>a</td></tr><tr><td align="left">4</td><td>ana</td></tr><tr><td align="left">2</td><td>anana</td></tr><tr><td align="left">1</td><td>banana</td></tr><tr><td align="left">5</td><td>na</td></tr><tr><td align="left">3</td><td>nana</td></tr></tbody></table><p>よって、<code>banana</code> の文字列における Suffix Array とは [6, 4, 2, 1, 5, 3] という配列になります。suffix の開始位置があれば元の suffix を構成することができ、開始位置から n 文字目までの部分文字列になります。<code>banana</code> における suffix の開始位置が 3 であれば元の suffix は 3 文字目から 6 文字目までの部分文字列であるため、<code>nana</code> という suffix であることがわかります。</p><h3 id="文字列のパターンマッチング"><a href="#文字列のパターンマッチング" class="headerlink" title="文字列のパターンマッチング"></a>文字列のパターンマッチング</h3><p>Suffix Array がどのようなデータ構造であるか分かりました。次に Suffix Array を用いて、文字列をパターンマッチングすることを考えてみます。<code>banana</code> という文字列から <code>an</code> という文字列をパターンマッチングすることを考えてみます。b<font color="Red">an</font><font color="Blue">an</font>a ですから、赤文字である 2 文字目から 3 文字目の <code>an</code> と、青文字である 4 文字目から 5 文字目の <code>an</code> の 2 箇所でマッチします。文字列 T の任意の部分文字列は、その出現位置を開始位置とする T の suffix の prefix です。つまり <code>an</code> であれば suffix <code>ana</code> の prefix である <code>an</code> と suffix  <code>anana</code> の prefix である <code>an</code> です。このように文字列 P を prefix としてもつような、T の suffix を探索することによって、文字列のパターンマッチングができます。Suffix Array は文字列の suffix が辞書順でソートされた suffix の開始位置を保持しているため、二分探索を用いて、高速にパターンマッチングできます。</p><p><code>banana</code> の Suffix Array が求められているとして、Go で探索する実装例を示します。実装上の Suffix Array は 0-indexed とします。</p><ul><li>Suffix Array を二分探索して、一致するすべての suffix を検索する実装例</li></ul><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"sort"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := <span class="string">"banana"</span></span><br><span class="line">p := <span class="string">"an"</span> <span class="comment">// マッチングしたい文字列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// banana の Suffix Array (0-indexed)</span></span><br><span class="line">sa := []<span class="keyword">int</span>&#123;<span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// strings.Compare の戻り値が 0 よりも大きいうちの最小の index を探索</span></span><br><span class="line">left := sort.Search(<span class="built_in">len</span>(sa), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> strings.Compare(t[sa[i]:min(sa[i]+<span class="built_in">len</span>(p), <span class="built_in">len</span>(t))], p) &gt;= <span class="number">0</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// strings.Compare の戻り値が 1 である最小の index を探索</span></span><br><span class="line">right := sort.Search(<span class="built_in">len</span>(sa), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> strings.Compare(t[sa[i]:min(sa[i]+<span class="built_in">len</span>(p), <span class="built_in">len</span>(t))], p) == <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := left; i &lt; right; i++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">"suffix: %s, match: %s\n"</span>, t[sa[i]:], t[sa[i]:sa[i]+<span class="built_in">len</span>(p)])</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">min</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> a &lt; b &#123;</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>出力結果</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">suffix: ana, match: an</span><br><span class="line">suffix: anana, match: an</span><br></pre></td></tr></table></figure><p><a href="https://play.golang.org/p/JFNugaoB26N" target="_blank" rel="noopener">https://play.golang.org/p/JFNugaoB26N</a></p><p>このパターンマッチングは元の文字列 T の長さを $n$ として、マッチングしたい文字列 P の長さを $m$ とすると $O(m \log n)$ 時間でマッチングできます。Go の <a href="https://golang.org/pkg/sort/#Search" target="_blank" rel="noopener">sort.Search</a> 関数はソートされた配列やスライスに対して条件を満たす最小の index を二分探索することができます。上記の実装では、suffix における prefix の先頭 <code>len(p)</code> 文字目までの部分文字列とマッチングしたい文字列 <code>p</code> を <a href="https://golang.org/pkg/strings/#Compare" target="_blank" rel="noopener">strings.Compare</a> で比較し、結果が 0 以上と 1 となる最小の index <sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>を探索しています。Suffix Array に対して二分探索を行うことによって、パターンマッチングするときは、元の文字列の長さに対して、対数時間でおさえることができます。</p><h2 id="Suffix-Array-の構築"><a href="#Suffix-Array-の構築" class="headerlink" title="Suffix Array の構築"></a>Suffix Array の構築</h2><p>Suffix Array を構築することを考えてみます。ナイーブに考えると、長さ $O(n)$ の文字列 $n$ つをソートすることになります。クイックソートの 1 回あたりの平均計算量 $O(n \log n)$ とあわせて $O(n^2 \log n)$ 時間になります。いかにして効率よく Suffix Array を構築できるかどうかがアルゴリズムのポイントになります。</p><ul><li>ナイーブにソートして構築する実装例</li></ul><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"sort"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">text := <span class="string">"banana"</span></span><br><span class="line"></span><br><span class="line">d := <span class="built_in">make</span>([]data, <span class="number">0</span>, <span class="built_in">len</span>(text))</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(text); i++ &#123;</span><br><span class="line">d = <span class="built_in">append</span>(d, data&#123;</span><br><span class="line">Index:  i,</span><br><span class="line">Suffix: text[i:],</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sort.Slice(d, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">ret := strings.Compare(d[i].Suffix, d[j].Suffix)</span><br><span class="line"><span class="keyword">if</span> ret &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> d &#123;</span><br><span class="line">fmt.Printf(<span class="string">"index: %d, suffix: %s\n"</span>, v.Index, v.Suffix)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;</span><br><span class="line">Index  <span class="keyword">int</span></span><br><span class="line">Suffix <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>出力結果</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">index: 5, suffix: a</span><br><span class="line">index: 3, suffix: ana</span><br><span class="line">index: 1, suffix: anana</span><br><span class="line">index: 0, suffix: banana</span><br><span class="line">index: 4, suffix: na</span><br><span class="line">index: 2, suffix: nana</span><br></pre></td></tr></table></figure><p><a href="https://play.golang.org/p/J97GtkfWBZp" target="_blank" rel="noopener">https://play.golang.org/p/J97GtkfWBZp</a></p><p>しかし、構築に $O(n^2 \log n)$ 時間かかるのでは、例えば 10 万文字程度の文字列の Suffix Array を構築するのにとても時間がかかるため、実用的ではありません。</p><ul><li>ManberとMyersのアルゴリズム</li></ul><p>そこで次は Manber と Myers によって示されたアルゴリズムを用いて構築することを考えてみます。基本的な着想はダブリングによるものです。つまり n 文字をソートするときに、まず 1 文字の部分文字列のみをソート、続いて 1 文字の部分文字列でソートした結果を用いて 2 文字の部分文字列をソート、、、と 2k 文字の部分文字列をソートするのに、k 文字の部分文字列でソートした結果を用います。詳しくは蟻本 <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> を参照ください。蟻本が手もとにない場合は <a href="https://www.geeksforgeeks.org/suffix-array-set-2-a-nlognlogn-algorithm/" target="_blank" rel="noopener">Suffix Array | Set 2 (nLogn Algorithm)</a> などのページでアルゴリズムを確認ください。本記事では Go による実装のみを示します。ダブリングにより比較回数は $O(\log n)$ 回で 1 回あたりのソートの平均計算量が $O(n \log n)$ ですから、全体では $O(n (\log n)^2)$ 時間のアルゴリズムです。</p><ul><li>蟻本ベースの Go による Suffix Array を構築する実装</li></ul><figure class="highlight go"><figcaption><span>suffixarray.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> suffixarray</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"sort"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> suffixArray <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// length of input string</span></span><br><span class="line">N <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// input text (ASCII only)</span></span><br><span class="line">Text <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Suffix Array</span></span><br><span class="line">Index []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="keyword">string</span>)</span> *<span class="title">suffixArray</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> k <span class="keyword">int</span></span><br><span class="line">n := <span class="built_in">len</span>(text)</span><br><span class="line">rank := <span class="built_in">make</span>([]<span class="keyword">int</span>, n+<span class="number">1</span>)</span><br><span class="line">sa := <span class="built_in">make</span>([]<span class="keyword">int</span>, n+<span class="number">1</span>)</span><br><span class="line">tmp := <span class="built_in">make</span>([]<span class="keyword">int</span>, n+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= n; i++ &#123;</span><br><span class="line">sa[i] = i</span><br><span class="line"><span class="keyword">if</span> i &lt; n &#123;</span><br><span class="line">rank[i] = <span class="keyword">int</span>(text[i])</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">rank[i] = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cmp := <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> rank[sa[i]] != rank[sa[j]] &#123;</span><br><span class="line"><span class="keyword">return</span> rank[sa[i]] &lt; rank[sa[j]]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ri, rj := <span class="number">-1</span>, <span class="number">-1</span></span><br><span class="line"><span class="keyword">if</span> sa[i]+k &lt;= n &#123;</span><br><span class="line">ri = rank[sa[i]+k]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> sa[j]+k &lt;= n &#123;</span><br><span class="line">rj = rank[sa[j]+k]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ri &lt; rj</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// k 文字についてソートされているところから、2k 文字をソートする</span></span><br><span class="line"><span class="keyword">for</span> k = <span class="number">1</span>; k &lt;= n; k *= <span class="number">2</span> &#123;</span><br><span class="line">sort.Slice(sa, cmp)</span><br><span class="line">tmp[sa[<span class="number">0</span>]] = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= n; i++ &#123;</span><br><span class="line">tmp[sa[i]] = tmp[sa[i<span class="number">-1</span>]]</span><br><span class="line"><span class="keyword">if</span> cmp(i<span class="number">-1</span>, i) &#123;</span><br><span class="line">tmp[sa[i]]++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= n; i++ &#123;</span><br><span class="line">rank[i] = tmp[i]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;suffixArray&#123;</span><br><span class="line">N:     n,</span><br><span class="line">Text:  text,</span><br><span class="line">Index: sa,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>banana</code> の文字列で試しにテストしてみましょう。</p><figure class="highlight go"><figcaption><span>suffixarray_test.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> suffixarray</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"testing"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/google/go-cmp/cmp"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNew</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">text <span class="keyword">string</span></span><br><span class="line">want *suffixArray</span><br><span class="line">&#125;&#123;</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">"normal"</span>,</span><br><span class="line">text: <span class="string">"banana"</span>,</span><br><span class="line">want: &amp;suffixArray&#123;</span><br><span class="line">N:     <span class="number">6</span>,</span><br><span class="line">Text:  <span class="string">"banana"</span>,</span><br><span class="line">Index: []<span class="keyword">int</span>&#123;<span class="number">6</span> <span class="comment">/* contain empty string */</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">2</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">got := New(tt.text)</span><br><span class="line"><span class="keyword">if</span> diff := cmp.Diff(got, tt.want); diff != <span class="string">""</span> &#123;</span><br><span class="line">t.Errorf(<span class="string">"New() differs: (-got +want)\n%s"</span>, diff)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>テスト結果</li></ul><p>テストが Pass することを確認できました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=== RUN   TestNew</span><br><span class="line">=== RUN   TestNew/normal</span><br><span class="line">--- PASS: TestNew (0.00s)</span><br><span class="line">    --- PASS: TestNew/normal (0.00s)</span><br><span class="line">PASS</span><br></pre></td></tr></table></figure><p>また Go で実装したライブラリは、国内のオンラインジャッジシステムの 1 つである <a href="http://judge.u-aizu.ac.jp/onlinejudge/" target="_blank" rel="noopener">Aizu Online Judge</a> の <a href="http://judge.u-aizu.ac.jp/onlinejudge/description.jsp?id=ALDS1_14_D" target="_blank" rel="noopener">Multiple String Matching</a> という問題を用いて検証しました。<del><a href="https://judgedat.u-aizu.ac.jp/testcases/ALDS1_14_D/17/in" target="_blank" rel="noopener">05_maximum_00.in</a> (1 MB程度あるので注意)のテストケースでタイムリミット超過(TLE)していましたが…</del></p><h3 id="suffixarray-パッケージによる-Suffix-Array-の構築"><a href="#suffixarray-パッケージによる-Suffix-Array-の構築" class="headerlink" title="suffixarray パッケージによる Suffix Array の構築"></a><code>suffixarray</code> パッケージによる Suffix Array の構築</h3><p>さて、メインである本家の <code>suffixarray</code> パッケージを見てみましょう。Suffix Array の構築は <a href="https://golang.org/pkg/index/suffixarray/#New" target="_blank" rel="noopener">New</a> 関数を用いることができます。</p><p><code>New</code> 関数で Suffix Array を構築し、<a href="https://golang.org/pkg/index/suffixarray/#Index.Lookup" target="_blank" rel="noopener">Lookup</a> メソッドや <a href="https://golang.org/pkg/index/suffixarray/#Index.FindAllIndex" target="_blank" rel="noopener">FindAllIndex</a> メソッドなどを用いて Suffix Array から文字列のマッチングができます。<code>banana</code> の例であれば、以下のように結果を得ることができます。</p><figure class="highlight go"><figcaption><span>main_test.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"index/suffixarray"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Example</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := <span class="string">"banana"</span></span><br><span class="line">p := <span class="string">"an"</span> <span class="comment">// マッチングしたい文字列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Suffix Array の構築</span></span><br><span class="line">sa := suffixarray.New([]<span class="keyword">byte</span>(t))</span><br><span class="line"></span><br><span class="line"><span class="comment">// -1 でマッチングするすべての位置を取得。取得する index の順番はランダム</span></span><br><span class="line">indexes := sa.Lookup([]<span class="keyword">byte</span>(p), <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> indexes &#123;</span><br><span class="line">fmt.Printf(<span class="string">"suffix: %s, match: %s\n"</span>, t[i:], t[i:i+<span class="built_in">len</span>(p)])</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Unordered Output:</span></span><br><span class="line"><span class="comment">// suffix: ana, match: an</span></span><br><span class="line"><span class="comment">// suffix: anana, match: an</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ベンチマーク"><a href="#ベンチマーク" class="headerlink" title="ベンチマーク"></a>ベンチマーク</h3><p><code>suffixarray</code> パッケージの使い方が分かったところで蟻本ベースの  Manber と Myers のアルゴリズムを用いて Suffix Array を構築する実装と、標準ライブラリを用いて構築する 2 つの方法でベンチマークを取得してみましょう。(なおベンチマークの結果はローカルの環境に依存します)</p><p>Suffix Array を構築する対象のデータは <a href="http://judge.u-aizu.ac.jp/onlinejudge/description.jsp?id=ALDS1_14_D" target="_blank" rel="noopener">Multiple String Matching</a> における <a href="https://judgedat.u-aizu.ac.jp/testcases/ALDS1_14_D/17/in" target="_blank" rel="noopener">05_maximum_00.in</a> のデータを用いました。100万文字あります。input データを読み込む時間はベンチマークからは除きます。</p><ul><li>ベンチマークテスト</li></ul><figure class="highlight go"><figcaption><span>suffixarray_test.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkLookupAll_my</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">data, err := ioutil.ReadFile(<span class="string">"testdata/05_maximum_01.in.data"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">b.Fatalf(<span class="string">"read test data: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">b.ResetTimer()</span><br><span class="line"></span><br><span class="line">New(<span class="keyword">string</span>(data))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkLookupAll_std</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">data, err := ioutil.ReadFile(<span class="string">"testdata/05_maximum_01.in.data"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">b.Fatalf(<span class="string">"read test data: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">b.ResetTimer()</span><br><span class="line"></span><br><span class="line">suffixarray.New(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ベンチマーク結果</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">test</span> -bench . -benchtime=1000000000x</span><br><span class="line">goos: windows</span><br><span class="line">goarch: amd64</span><br><span class="line">pkg: github.com/d-tsuji/go-sandbox</span><br><span class="line">BenchmarkLookupAll_my-8         1000000000               4.54 ns/op</span><br><span class="line">BenchmarkLookupAll_std-8        1000000000               0.0510 ns/op</span><br><span class="line">PASS</span><br><span class="line">ok      github.com/d-tsuji/go-sandbox      9.362s</span><br></pre></td></tr></table></figure><p>ローカル環境でのベンチマークテストの結果によると、標準ライブラリは、私が実装した Manber と Myers のアルゴリズムに比べて、約 100 倍程度高速であることが分かります。</p><p>実は標準ライブラリの Suffix Array の構築アルゴリズムは SAIS<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> という Ge Nong、Sen Zhang、Wai Hong Chen によって提案された高速なアルゴリズムを用いています。SAIS の計算量は $O(n)$ です。さらにいくつかのチューニングを施しており、詳しくは <a href="https://golang.org/src/index/suffixarray/sais.go" target="_blank" rel="noopener">index/suffixarray/sais.go</a> のドキュメントを確認ください。</p><p>ベンチマークでは約 100 倍程度の処理時間の違いがありましたが、上記の Manber と Myers のアルゴリズムの計算量が $O(n (\log n)^2)$ で SAIS の計算量が $O(n)$ ですから、100 倍程度の差は自然です。SAIS を実装している Go の標準ライブラリが優秀であることが分かります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>Go の標準ライブラリで私が面白いと思った <code>suffixarray</code> パッケージを紹介しました。<code>suffixarray</code> パッケージの構築アルゴリズムの計算量は $O(n)$ で非常に高速です。その他に Manber と Myers による計算量 $O(n (\log n)^2)$ の構築アルゴリズムを用いた Go による実装を紹介しました。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>岡野原大輔 (2012) 『高速文字列解析の世界』岩波書店</li></ul><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">秋葉拓哉、岩田陽一、北川宜稔 (2012) 『プログラミングコンテストチャレンジブック [第2版]』 マイナビ出版</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;">Two Efficient Algorithms for Linear Time Suffix Array Construction (https://ieeexplore.ieee.org/document/5582081)</span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;">文字 a と b を <code>strings.Compare(a, b)</code> で辞書順で比較したときに a &lt; b であれば -1、a = b であれば 0、a &gt; b であれば +1 で返り値として取得できます。返り値が 0 以上の index を探索しているため a ≧ b である最小の index が取得できます。</span><a href="#fnref:3" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200807/suffixarray.png&quot; class=&quot;img-small-size&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200726/&quot;&gt;フューチ
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="データ構造" scheme="https://future-architect.github.io/tags/%E3%83%87%E3%83%BC%E3%82%BF%E6%A7%8B%E9%80%A0/"/>
    
  </entry>
  
  <entry>
    <title>初めてのOSSコミュニティ活動〜ドキュメント翻訳やってみた。カンファレンススタッフもやってみた。〜</title>
    <link href="https://future-architect.github.io/articles/20200806/"/>
    <id>https://future-architect.github.io/articles/20200806/</id>
    <published>2020-08-05T15:00:00.000Z</published>
    <updated>2020-08-11T07:12:34.958Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>本記事は<a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休みの自由研究連載</a>の4回目です。</p><p>2017年新卒入社の永井です。小売流通系のPJに所属しており、前回はVue.jsに関する記事を書きました。</p><ul><li>前回書いた記事<a href="https://future-architect.github.io/articles/20200428/">「Vue.jsのslotの機能を初心者にわかるように解説してみた」</a></li></ul><p>2020年はコロナ禍ということもあり、夏休みを取っても予定がないという人も多いのではないでしょうか。そんな時間があるときには、普段仕事や趣味でお世話になっているOSSやOSSコミュニティへの貢献をするといった過ごし方はいかがでしょうか。</p><p>でもいざGitHubを開いて、イシューを覗いてみると、どうも自分には出来なさそうな難しいものばかりに見えてなかなかハードル高いですよね。今回は「初めてのOSSコミュニティ活動」として、ハードルの低いOSS貢献を下記２つ紹介したいと思います。</p><ol><li>ドキュメント翻訳</li><li>カンファレンスのスタッフ</li></ol><h1 id="1-ドキュメントの翻訳"><a href="#1-ドキュメントの翻訳" class="headerlink" title="1. ドキュメントの翻訳"></a>1. ドキュメントの翻訳</h1><p>ドキュメントの翻訳は、<a href="https://www.transifex.com/" target="_blank" rel="noopener">transifex</a>というドキュメント翻訳プラットフォームを利用するのがハードルの低い方法です。このプラットフォームには多くのオープンソースが参加しており、自分の興味のあるものに参加することができます。下記の参考ページをもとに登録してみてください。</p><p>参考：transifexを翻訳に利用しているDjangoの翻訳プロジェクトの説明<br><a href="https://djangoproject.jp/howtojoin-transifex/" target="_blank" rel="noopener">https://djangoproject.jp/howtojoin-transifex/</a></p><h2 id="実際にやってみた"><a href="#実際にやってみた" class="headerlink" title="実際にやってみた"></a>実際にやってみた</h2><p>私は日本で生まれ育った日本語ネイティブで英語は中学1年生から学校で習ったという一般的な日本人ですので、英語から日本語への翻訳にチャレンジしてみます。（大学の第二外国語のドイツ語はさっぱり忘れました。）</p><p>transifexでは下記のように各英文ごとに対応する日本語を翻訳することになります。<br>（英単語帳のように対訳を当てていくようなイメージです。）</p><img src="/images/20200806/スクリーンショット 2020-08-05 20.48.15.png"><p>なので、無理のない範囲で少しずつ行うことができます。１文だけでもOKです。簡単ですね。</p><h1 id="2-カンファレンスのスタッフ活動"><a href="#2-カンファレンスのスタッフ活動" class="headerlink" title="2.カンファレンスのスタッフ活動"></a>2.カンファレンスのスタッフ活動</h1><p>昨年<a href="https://pycon.jp/2019/" target="_blank" rel="noopener">PyConJP2019</a>の当日スタッフとして活動しました。</p><ul><li>PyConJP2019に登壇された栗田さんの記事は<a href="https://future-architect.github.io/articles/20200422/">こちら</a><br>（余談に「他のフューチャーの社員も参加しており、最初の画像はスタッフをされていた方から頂戴しました」とありますが、「スタッフをされていた方」が私です。）</li></ul><h2 id="きっかけ"><a href="#きっかけ" class="headerlink" title="きっかけ"></a>きっかけ</h2><p>昨年PyConJP2019のコアスタッフをしていた友人に誘われて、当日スタッフとして活動しました。Pythonは独学で勉強したくらいだったのですが、「カンファレンスのスタッフって、なんだか楽しそうだなー」という気軽な気持ちで参加しました。</p><h2 id="当日スタッフの仕事内容"><a href="#当日スタッフの仕事内容" class="headerlink" title="当日スタッフの仕事内容"></a>当日スタッフの仕事内容</h2><h3 id="担当した仕事"><a href="#担当した仕事" class="headerlink" title="担当した仕事"></a>担当した仕事</h3><ul><li>前日設営</li><li>当日運営のサポート<ul><li>参加者の受付・ノベルティグッズやTシャツの配布</li><li>参加者をセッションの会場を誘導</li><li>道案内（セッションの会場やお手洗いなど）</li><li>セッションの中継機材の操作</li></ul></li><li>Partyへの参加（これはコアスタッフも含めて実費）</li><li>片付け</li></ul><h3 id="担当しなかった仕事"><a href="#担当しなかった仕事" class="headerlink" title="担当しなかった仕事"></a>担当しなかった仕事</h3><ul><li>セッションの司会</li><li>託児室の案内</li></ul><h2 id="得られたもの"><a href="#得られたもの" class="headerlink" title="得られたもの"></a>得られたもの</h2><p>スタッフの仕事や仕事の合間のコミュニケーションを通じてPythonを愛する多くの人と知り合うことが出来ました。それも国際カンファレンスなので、多様な顔ぶれ・・・！<br>特に<a href="https://www.amazon.co.jp/dp/4822292274" target="_blank" rel="noopener">『独学プログラマー』</a>の著者コーリー・アルソフさん（KeyNote登壇者）とお話できたことは光栄でした。</p><p>翻訳者の清水川さんと一緒にサインもいただいちゃいました。<br><img src="/images/20200806/IMG_20200805_203949.jpg" alt=""></p><p>ちなみに自己紹介する際に、「Futureで働いています」というと、多くの方が「澁川さんの会社」って反応されていたのが印象的でした。</p><p>*ほんのたまに「tsukammoさんの会社」と反応する競プロerもいました。</p><h2 id="当日スタッフやりましょう！・・・と言いたいところですが"><a href="#当日スタッフやりましょう！・・・と言いたいところですが" class="headerlink" title="当日スタッフやりましょう！・・・と言いたいところですが"></a>当日スタッフやりましょう！<del>・・・と言いたいところですが</del></h2><p><del>今年はコロナ禍でオンライン開催となるため、PyConJP2020では当日スタッフは募集してなさそうです。</del></p><p><del>来年以降当日スタッフ、もしくはコアスタッフにチャレンジしてみてはいかがでしょうか。</del></p><p><strong>(2020/08/08 追記)</strong> 8/28-30に行われるPyConJP2020当日スタッフ絶賛募集中だそうです。<br>是非<a href="https://pyconjp.blogspot.com/2020/08/support-staff.html" target="_blank" rel="noopener">こちら</a>からご登録ください。<strong>私も申し込みました。</strong></p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>今回OSSへの貢献、コミュニティ活動なんて私には無理なんじゃないかと思っている人にもハードル低めな２つを紹介しました。是非皆さんも取り組んでみてください。</p><h1 id="余談：もっとハードルの低いものはないの？"><a href="#余談：もっとハードルの低いものはないの？" class="headerlink" title="余談：もっとハードルの低いものはないの？"></a>余談：もっとハードルの低いものはないの？</h1><p><a href="https://jp.vuejs.org/support-vuejs/" target="_blank" rel="noopener">Vue.js公式の支援のページ</a>には以下のような記載があります。</p><blockquote><p>もしあなたが個人の開発者で、Vue を使って生産性を楽しんでいるのなら、寄付をご検討ください。例えば、時々私にコーヒーをおごる、とか。:)</p></blockquote><p>というわけで、お近くのOSS開発者・貢献者・コミッターにコーヒーを奢ってみてはいかがでしょうか。ちなみにFutureにはVulsの発明者やVue.jsのコアメンバー他、OSSの貢献者がたくさん所属しています。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;本記事は&lt;a href=&quot;https://future-architect.github.io/articles/20200
      
    
    </summary>
    
    
      <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
      <category term="Python" scheme="https://future-architect.github.io/tags/Python/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="OSS" scheme="https://future-architect.github.io/tags/OSS/"/>
    
  </entry>
  
  <entry>
    <title>Terraformで楽をしたい</title>
    <link href="https://future-architect.github.io/articles/20200805/"/>
    <id>https://future-architect.github.io/articles/20200805/</id>
    <published>2020-08-04T15:00:00.000Z</published>
    <updated>2020-08-05T14:17:55.873Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/20200805/%E3%81%B2%E3%81%BE%E3%82%8F%E3%82%8A.jpg" alt=""></p><p>本記事は<a href="/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/">夏休み自由研究記事</a>の第3弾です。</p><p>こんにちは。TIG/DX所属のインフラエンジニア兼カメラマンの<a href="https://twitter.com/kaedemalu" target="_blank" rel="noopener">伊藤太斉</a>です。今回のアイキャッチは私が昨年撮ったひまわり畑にしました。</p><h2 id="ツールをまとめたい"><a href="#ツールをまとめたい" class="headerlink" title="ツールをまとめたい"></a>ツールをまとめたい</h2><p>Infrastructure as Code(IaC)という考え方に属するツールはたくさんあります。例えばサーバーのミドルウェアを設定するためにAnsible、インスタンスのゴールデンイメージを作っておくならPacker、コンテナオーケストレーションならKubernetesと言った感じで、どんどん追えないくらいに増えています。我々エンジニアとしては、新しいツールを使うことが楽しくてしょうがない人も多いかと思います。かくいう私もその一人です。しかし、新しくインフラを始める人にとってもツールの多い時代ですし、少ない学習コスト(人によっては負担)でキャッチアップやインフラのリリースができることに越したことはありません。</p><p>この記事では、Terraformの数多くの機能を使って他のIaCツールと可能な限り代用したり、Terraformの世界でリソース作成を完結させるために使い方を改めて突き詰めた内容になります。私の記事なので、使うクラウドは例にもれずGCPを利用します。</p><h2 id="PackerじゃなくてTerraform"><a href="#PackerじゃなくてTerraform" class="headerlink" title="PackerじゃなくてTerraform"></a>PackerじゃなくてTerraform</h2><p>Packerは、Linuxなど各種OSなどに必要なパッケージをインストールしたあと、インスタンス自体は削除され、ゴールデンイメージを残します。このイメージをベースとして、設定済みのインスタンスを展開することができます。ミドルウェアの設定という意味ではAnsibleと似ていますが、Ansibleは設定したインスタンスはそのまま生きています。</p><h3 id="remote-execを利用する"><a href="#remote-execを利用する" class="headerlink" title="remote-execを利用する"></a><code>remote-exec</code>を利用する</h3><p>TerraformにはProvisionerというものがありますが、<code>remote-exec</code>はそのうちの一つです。<code>remote</code>なので、実行場所は構築しているインスタンスになります。ディレクトリ構成は以下を考えます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hoge-project</span><br><span class="line"> |- compute_instance.tf</span><br><span class="line"> |- sshkey</span><br><span class="line">     |- id_rsa</span><br><span class="line">     |- id_rsa.pub</span><br></pre></td></tr></table></figure><p>インスタンスをコードしている<code>compute_instance.tf</code>、あとは埋める鍵を置いています。<code>compute_instance.tf</code>の中身は以下になります。</p><figure class="highlight sh"><figcaption><span>compute_instance.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_instance"</span> <span class="string">"instance"</span> &#123;</span><br><span class="line">  name         = <span class="string">"sample-instance"</span></span><br><span class="line">  machine_type = <span class="string">"n1-standard-1"</span></span><br><span class="line">  zone         = <span class="string">"asia-northeast1-a"</span></span><br><span class="line">  tags         = []</span><br><span class="line"></span><br><span class="line">  boot_disk &#123;</span><br><span class="line">    initialize_params &#123;</span><br><span class="line">      image = <span class="string">"debian-cloud/debian-9"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  network_interface &#123;</span><br><span class="line">    network = <span class="string">"default"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner <span class="string">"remote-exec"</span> &#123;</span><br><span class="line">    connection = &#123;</span><br><span class="line">      <span class="built_in">type</span>        = <span class="string">"ssh"</span></span><br><span class="line">      user        = <span class="string">"provisoner"</span></span><br><span class="line">      private_key = file(<span class="string">"./sshkey/id_rsa.pub"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    inline = [</span><br><span class="line">      <span class="string">"sudo apt-get install nginx"</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここではインスタンスを立てて、nginxを入れるところまでをゴールとするコードにしました。通常であれば、Terraformでインスタンスを立てて、その後、gcloudコマンドなりで作成したインスタンスにsshしてミドルウェアをインストールするはずですが、それを<code>remote-exec</code>で置き換えています。</p><h3 id="メリット・デメリット"><a href="#メリット・デメリット" class="headerlink" title="メリット・デメリット"></a>メリット・デメリット</h3><ul><li>メリット<ul><li>PackerでbuildしてからイメージをTerraformで再度指定しなくても良い</li><li>Terraformのコマンド、世界で完結する</li></ul></li><li>デメリット<ul><li>ゴールデンイメージを利用するインスタンスが多い場合はコードが汚くなる</li></ul></li></ul><p>Packerを代用しようとする場合は、踏み台や、特定のサーバー種に向けてであれば効果的かと思いますが、利用するインスタンスが多くなった場合にはわずかながらコードが読みにくくなる可能性もあるので、そのときはPackerの導入を考えないといけないのかもしれません。</p><h2 id="Ansibleコマンドを実行したくない"><a href="#Ansibleコマンドを実行したくない" class="headerlink" title="Ansibleコマンドを実行したくない"></a>Ansibleコマンドを実行したくない</h2><p>インフラの管理方法として、Terraform + Ansibleは王道すぎるくらい王道なやり方だと思っていますし、コード管理している方はだいたいその2つをメインとして利用しているのではないでしょうか？なので、手順としては</p><ul><li>Terraformでリソースを作成</li><li>Ansibleでミドルウェアの設定を行う</li></ul><p>で行うと思います。なので、各々コマンドを実行しますが、個人的には2回コマンドを実行したくない、できれば1発で出来上がって欲しいという気持ちがずっとありました。その気持ち、ここで昇華させます。</p><h3 id="local-execを利用する"><a href="#local-execを利用する" class="headerlink" title="local-execを利用する"></a><code>local-exec</code>を利用する</h3><p>先ほどはProvisionerで<code>remote-exec</code>を利用しましたが、今回は<code>local-exec</code>を使います。実行場所が<code>local</code>、つまりTerraformの実行端末上で行うコマンドです。Ansibleは実行するときは各インスタンス上ではなく、ローカルや踏み台サーバーから実行するかと思いますので、<code>local-exec</code>を今回は使います。（構築したサーバー上でlocalhostでAnsibleは実行できますがお掃除も大変ですね…。）<br>今回はケースとして、以下をディレクトリ構成で考えます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hoge-project</span><br><span class="line"> |- compute_instance.tf</span><br><span class="line"> |- ansible</span><br><span class="line">     |- ansible.cfg</span><br><span class="line">     |- inventory</span><br><span class="line">     |- nginx.yaml</span><br><span class="line">     |- sshkey</span><br><span class="line">         |- id_rsa</span><br><span class="line">         |- id_rsa.pub</span><br><span class="line">     |- roles</span><br><span class="line">         |- nginx</span><br><span class="line">             |- tasks</span><br><span class="line">                 |- main.yaml</span><br></pre></td></tr></table></figure><p>このディレクトリ構成もおそらくTerraform + Ansibleの組み合わせの時にはオーソドックスではないでしょうか？ここで、<code>compute_instance.tf</code>は</p><figure class="highlight sh"><figcaption><span>compute_instance.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_instance"</span> <span class="string">"instance"</span> &#123;</span><br><span class="line">  name         = <span class="string">"sample-instance"</span></span><br><span class="line">  machine_type = <span class="string">"n1-standard-1"</span></span><br><span class="line">  zone         = <span class="string">"asia-northeast1-a"</span></span><br><span class="line">  tags         = []</span><br><span class="line"></span><br><span class="line">  boot_disk &#123;</span><br><span class="line">    initialize_params &#123;</span><br><span class="line">      image = <span class="string">"debian-cloud/debian-9"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  network_interface &#123;</span><br><span class="line">    network = <span class="string">"default"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  metadata = &#123;</span><br><span class="line">    ssh-keys = <span class="string">"ansible:<span class="variable">$&#123;file("./ansible/sshkey/id_rsa.pub")&#125;</span>"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  service_account &#123;</span><br><span class="line">    scopes = [<span class="string">"cloud-platform"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner <span class="string">"local-exec"</span> &#123;</span><br><span class="line">    working_dir = <span class="string">"./ansible/"</span></span><br><span class="line">    <span class="built_in">command</span>     = <span class="string">"ansible-playbook -i inventory nginx.yaml"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>と書きました。<code>metadata</code>でインスタンスに埋め込む公開鍵を設定しています。そして最終段にある</p><figure class="highlight sh"><figcaption><span>tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">provisioner <span class="string">"local-exec"</span> &#123;</span><br><span class="line">  working_dir = <span class="string">"./ansible/"</span></span><br><span class="line">  <span class="built_in">command</span>     = <span class="string">"ansible-playbook -i inventory nginx.yaml"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>が今回のミソの部分です。ローカルで動かすディレクトリの指定と、そのディレクトリで実行するコマンドを書いています。コマンド自体は人が実行するものと基本的に同じにすればあとはAnsibleの世界なので、taskが終わるのを待ちましょう。</p><h3 id="メリット・デメリット-1"><a href="#メリット・デメリット-1" class="headerlink" title="メリット・デメリット"></a>メリット・デメリット</h3><p>今回、Ansibleの実行をTerraformにもたせましたが、こちらもメリット、デメリットどちらもあるかと思います。</p><ul><li>メリット<ul><li>コマンド実行回数が減る（手順が減る）</li><li>Ansibleが異常終了した場合は<code>taint</code>フラグが付くので、コードに書かれていることはしっかり実行される</li></ul></li><li>デメリット<ul><li>Ansibleの世界とTerraformの世界の境界がなくなるのでそれぞれの責任を分けにくくなる</li></ul></li></ul><p>メリットは実行回数が減ることはもちろんですが、<code>taint</code>フラグをつけてくれることが嬉しいところではないでしょうか？<code>taint</code>フラグは、「Terraformのリソースとしては作成が済んでいるが、リソースが指定通りにできなかった」時につくので、Ansibleの世界で失敗してもTerraformの失敗になります。<br>一方デメリット自体は、私自身は大きくないと思いますが、それぞれにもたせる役割、責任をはっきり分けておきたい場合にはデメリットかなと思います（見た目の問題ではありますが）。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事では出来るだけTerraformでまかなってみましたが、とはいえ私自身AnsibleやPackerなどももちろん使います。また、使い方もチームそれぞれなのでこのやり方が100%フィットするとことはないと思っています。ただ、Terraformの世界を広げることで、管理コストや実装コストが下がることがわかりました。IaCの背景は手順書を極力減らしたり、インフラにもCI/CDを取り入れる余地をもたせることだと思うので、こういった取り組みは必要かなと思います。ここでいう、「楽をしたい」はどちらかというと人為的なミスを減らす、というところに落ち着きます。</p><p>これからさらに夏休み記事は出てきますので、今後の記事もぜひ読んでください！</p><h2 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h2><ul><li><a href="/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/">夏休み連載</a></li><li><a href="/tags/Terraform/">Terraform</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/20200805/%E3%81%B2%E3%81%BE%E3%82%8F%E3%82%8A.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;本記事は&lt;a href=&quot;/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="GCP" scheme="https://future-architect.github.io/tags/GCP/"/>
    
      <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
  </entry>
  
</feed>
