<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>フューチャー技術ブログ</title>
  
  <subtitle>Future Tech Blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://future-architect.github.io/"/>
  <updated>2020-07-03T02:07:32.889Z</updated>
  <id>https://future-architect.github.io/</id>
  
  <author>
    <name>Future Architect Consultants</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>スケーラブルデータベース ～クラウドにおける後悔しないデータベース選定～</title>
    <link href="https://future-architect.github.io/articles/20200703/"/>
    <id>https://future-architect.github.io/articles/20200703/</id>
    <published>2020-07-03T01:34:11.000Z</published>
    <updated>2020-07-03T02:07:32.889Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>エンタープライズでのミッションクリティカル領域においてもクラウド利用が普通になってきています。</p><p>その過程において今までできないことを指向する試みも行われてきています。その代表的なものがクラウドの備えるリソースの高い拡張性と弾力性を利用したシステム展開です。例えば「より多くのデータを扱う」「同業他社に向けたサービス展開をする（マルチテナンシー）」といったものがあります。その際のアーキテクチャ選定では将来の利用を想定した選択を行う必要がありますが、データベースのスケールというのは非常に難しく簡単ではありません。</p><p>各種の要件に応じてデータベースを選定するということは多く行われていますが、その中で一番考え方が難しい<strong>スケーラビリティにどう立ち向かうか</strong>について記載していきます。データベースについては全ての要件を満たせる「万能」なアーキテクチャが存在しないのが実情です。そのためスケーラビリティを確保するための工夫とアーキテクチャを決定するロジックが必要となります。</p><p>大事なのは、データベースのアーキテクチャだけではなく、データ特性（データモデル）の2つの目線で考えるということです。どちらかだけに偏ると、システム要件は実現できたとしてもTCOの増大を招くことになりその選択を後悔することになります。</p><h1 id="データベースとしてのスケーラビリティ"><a href="#データベースとしてのスケーラビリティ" class="headerlink" title="データベースとしてのスケーラビリティ"></a>データベースとしてのスケーラビリティ</h1><p>データ―ベースに求められる要件は当然利用方法により異なりますが、大きく分けて２種類ありそれぞれ重視されるポイントが異なります。</p><table><thead><tr><th align="left">#</th><th align="left">用途</th><th align="left">特徴</th><th align="left">重視されるポイント</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">トランザクション型</td><td align="left">オペレーション用途に利用されてデータの記録と作成が行われる</td><td align="left">応答性能(レスポンス）重視</td></tr><tr><td align="left">2</td><td align="left">アナリティック型</td><td align="left">データ分析用途に利用されてデータの参照に利用される</td><td align="left">単位時間処理(スループット)重視</td></tr></tbody></table><p>この2つのタイプは重視されるポイントが異なることからスケーラビリティの確保の考え方が異なっています。</p><p>(2)アナリティック型についてはスケーラビリティの考え方は非常にシンプルで、「分散処理をする」という一択です。すなわちデータを細かい単位に分割してそれぞれの分割単位で処理を並列に実行するという考え方です。その実現にはRDBをベースとしたものとHDFS(Hadoop)をベースとしたものがあり、クラウドサービスで考えたときには代表的なものとして以下があげられます。</p><table><thead><tr><th align="left">#</th><th align="left">クラウドサービス</th><th align="left">RDB型プロダクト</th><th align="left">HDFS型プロダクト</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">AWS</td><td align="left">Redshift</td><td align="left">Amazon EMR</td></tr><tr><td align="left">2</td><td align="left">Azure</td><td align="left">SQL Datawarehouse</td><td align="left">HDInsight</td></tr><tr><td align="left">3</td><td align="left">GCP</td><td align="left">BigQuery</td><td align="left">Google Cloud Dataproc</td></tr><tr><td align="left">4</td><td align="left">AWS/Azure/GCP</td><td align="left">Snowflake</td><td align="left">-</td></tr></tbody></table><p>こちらについてもテーマとしては面白いのですが、スケーラビリティという点では大きな違いはないため、別の機会に譲ります。</p><p>今回のテーマとしたいのが「トランザクション型データベース」におけるスケーラビリティです。<br>これについて検討する上で、「トランザクションとは」という点の正しい理解が必要となります。</p><h1 id="トランザクションとスケーラビリティ"><a href="#トランザクションとスケーラビリティ" class="headerlink" title="トランザクションとスケーラビリティ"></a>トランザクションとスケーラビリティ</h1><p>トランザクション(transaction)は文字通り「trans + action」であり、複数のデータの読み書きを論理的な単位でまとめるて扱うことがその定義となります。ここであらためてトランザクションを扱うシステムのもつ概念(ACID特性)について記載します。</p><table><thead><tr><th align="left">ACID</th><th align="left">説明</th><th align="left">実現するための機能</th></tr></thead><tbody><tr><td align="left">Atomicity 原子性</td><td align="left">トランザクションは完全に実行されるか、実行されないかのどちらかであること</td><td align="left">コミット機能</td></tr><tr><td align="left">Consistency 一貫性</td><td align="left">あらかじめ定められた整合性を満たすことを保証すること</td><td align="left">アプリケーションで実現</td></tr><tr><td align="left">Isolation 独立性</td><td align="left">トランザクションを同時に実行しても他のトランザクションには影響を受けない（受けないことを保証する）こと</td><td align="left">排他制御/トランザクション分離レベル</td></tr><tr><td align="left">Durability 耐久性</td><td align="left">トランザクションの結果は永続化されること</td><td align="left">トランザクションログ</td></tr></tbody></table><p>一貫性(Consisteny)は、データが矛盾なく記録されていることを意味しますので「データベース」として実現するものではなく、「データベースを利用するシステム」により実現することとなります。つまりアプリケーションにて実現するものとなります。</p><p>独立性(Isolation)は非常に重要な概念ではあるのですが、一般的には以下のように考えられています。</p><ul><li>どのレベルで実現するかというものを<a href="https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E9%9B%A2%E3%83%AC%E3%83%99%E3%83%AB" target="_blank" rel="noopener">トランザクション分離レベル</a>として4段階で定義されており、独立性と性能とトレードオフになることからシステム要件に合わせて使い分けることをおこなう。</li><li>広く使われる分離レベル（Read committed)は、低い独立性レベルであり、ファントムリード・非再現リードというデータ一矛盾が発生する可能性があるが性能面の影響は比較的少なく、アプリケーションの実装手段の工夫により回避することや許容可能である。</li><li>実装手段の工夫とは、トランザクションでの排他ロックの利用、更新する際に他トランザクションでの更新があったかの値チェック(compare and set操作、楽観的ロックとも言う)などがある。</li></ul><p>このことから、データベースのスケーラビリティを考えるうえでの本質的な要素は原子性(Atomicity)と耐久性(Durability)であると言えます。（あくまでもスケーラビリティを考えるうえでの話です！）さらに、原子性と耐久性は「トランザクションログ」により確保されるのが一般的です。</p><p>正しく理解するために<a href="https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%AD%E3%82%B0" target="_blank" rel="noopener">トランザクションログ</a>の説明をwikiより転記すると以下です。</p><blockquote><p>計算機科学のデータベースの分野において、トランザクションログ（英: transaction log）（または データベースログ, バイナリログ とも呼ばれる）とは、クラッシュやハードウェア故障があったとしてもデータベース管理システムのACID特性を保障するための操作履歴を指す。ログは電源が途絶えてもデータを保持できる補助記憶装置上のファイルに出力される場合が多い。</p><p>データベースが起動後に、整合性の無い状態であるか、正常に終了されていないことを検知すると、<br>データベース管理システムはトランザクションログを読み取り、以下の操作を行う。どちらも原子性と永続性を保障するために必要である。</p><p>完了していない または ロールバックされたトランザクションが行った操作を取り消す。<br>コミットしているが、データベースには反映されていない操作を再実行する。</p></blockquote><p>トランザクションログとは、耐久性を確保するための仕組みだがデータベースに障害が発生した場合には原子性の確保するために利用されるものであることになります。データベースは正常時には揮発性メモリ（キャシュ）内で行われるが、操作履歴となるトラクションログが必ず不揮発性領域に（通常はファイル）保存されることになります。裏を返すとトランザクションログが作成されないとデータの更新はできないことになります。</p><p>そのため、トランザクションログの保存がデータベースのスケーラビリティを決定する決定的な要素となります。</p><p>トランザクションログは製品ごとに名称は異なりますが概念としては同一のものとなります。</p><table><thead><tr><th align="left">タイプ</th><th align="left">プロダクト</th><th align="left">ログ名称</th></tr></thead><tbody><tr><td align="left">RDB</td><td align="left">Oracle</td><td align="left">REDOログ</td></tr><tr><td align="left">RDB</td><td align="left">PostgreSQL</td><td align="left">WALログ</td></tr><tr><td align="left">RDB</td><td align="left">MySQL</td><td align="left">Binログ</td></tr><tr><td align="left">RDB</td><td align="left">SQL Server</td><td align="left">トランザクションログ</td></tr><tr><td align="left">KVS</td><td align="left">Cassandra</td><td align="left">コミットログ</td></tr><tr><td align="left">KVS</td><td align="left">HBase</td><td align="left">WALログ</td></tr><tr><td align="left">KVS</td><td align="left">クラウドサービスKVS(Dynamo DB@AWS/Cosmos DB@Azure/Big table@GCP)</td><td align="left">？</td></tr></tbody></table><p>クラウドサービスKVSについては明確な説明がないため？としています。Dynamo DBではかつてはトランザクションのサポートはされておらず、「データの更新は一つのキー単位に限定したうえで、レプリケーションとクオラムの概念により耐久性を保証するが、すべてのレプリカにデータが必ず保存されるとは限らない」という結果整合性が提供されていました。（参考：<a href="https://gist.github.com/matope/2657692" target="_blank" rel="noopener">Dynamo: Amazonの高可用性Key-value Store[和訳]</a>）つまり複数データの原子性(Atomicity)は提供されてません（クライアント側で対応（冪等性実装）を行う必要がある）。そのためトランザクションログという概念もなかったはずです。</p><p>2019年にトランザクションサポートが提供されました。（参考：<a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/transaction-apis.html" target="_blank" rel="noopener">Amazon DynamoDB トランザクション: 仕組み</a>）これは非常にインパクトのある機能向上でした。この機能の利用にあたってはトランザクションログの概念が組み込まれたと推測されますが、トランザクションログの実装がパフォーマンスに与える影響を極小化するために最大25項目以内であるという制約が設定されています。トランザクションログがスケーラビリティ決定する要素であることには変わりありません。</p><h1 id="トランザクション型データベースのアーキテクチャ"><a href="#トランザクション型データベースのアーキテクチャ" class="headerlink" title="トランザクション型データベースのアーキテクチャ"></a>トランザクション型データベースのアーキテクチャ</h1><p>ここでエンタープライズ用途という条件における、クラウド環境でのトランザクション型データベースアーキテクチャとスケーラブル構成について一度整理しておきます。網羅感は乏しくいろいろ指摘を受けそうですが「実質的」な意味ではこの選択肢に限定されるはずです。</p><table><thead><tr><th align="left">#</th><th align="left">データ構造</th><th align="left">スケーラブル構成</th><th align="left">クラウドサービス</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Key-Value型</td><td align="left">可能</td><td align="left">DynamoDB(AWS), CosmosDB(Azure), BigTable/Cloud Spanner(GCP)</td></tr><tr><td align="left">2</td><td align="left">Relational型</td><td align="left">制限的で可能</td><td align="left">Relational Database Service(AWS/Azure/GCP/Oracle Cloud)</td></tr><tr><td align="left">3</td><td align="left">Relational型</td><td align="left">可能</td><td align="left">Oracle-RAC (Oracle Cloud)</td></tr></tbody></table><p>今回のテーマのスケーラブルデータベースですが、冒頭「全ての要件を満たせる「万能」なアーキテクチャが存在しない」ということを書きましたが、Oracle RACは例外といってもいいかもしれません。しかしながら、</p><ul><li>コスト削減圧力は依然として高く、ソフトウェアのライセンス費用はできるだけ抑えたい。</li><li>機能的に不足している部分はアプリケーションの工夫で対応するほうがリーズナブル。</li><li>クラウド環境を固定化するのは避けたい（いざとなれば他へ移すことも容易であるという選択をしたい）</li></ul><p>ということもあり、今回は(1)(2)に特化して議論を進めます。</p><p>今回の内容はあくまでも「手段」の話をしています。決して「目的」としてはいけないというのは言うまでもありません。</p><h2 id="Key-Value型とRelational型の選択"><a href="#Key-Value型とRelational型の選択" class="headerlink" title="Key Value型とRelational型の選択"></a>Key Value型とRelational型の選択</h2><p>このテーマは深みのあるテーマではあるのですが、「できる・できない」という技術や手法ではなく、扱うデータモデル（データ種）のデータ管理面で考察してみます。</p><p>「データモデル」とは物理的なテーブルではなく、情報のまとまり（エンティティ）を抽出したもので以下の原則に従います。</p><ul><li>データの整合性を保つために正規化（通常は第三正規化）設計を行うのが原則です</li><li>物理設計（いわゆるテーブル設計）に落とし込む際に、あえてそれを崩す非正規化の手法を行う場合があります</li></ul><p>次の表の中で非正規化とあるのは、あえて正規化を崩していることを意味していますので、データの整合性を保つための施策を実装時におこなう必要があることを意味しています。なおこの表はパフォーマンスという点の評価はしていません。</p><img src="/images/20200703/photo_20200703_01.png"><p>ここで言えるのは、<strong>Key-Value型は扱うデータモデルを選び、実装面の工夫が必要であるのに対して、Relational型はデータモデルとしての制約はない</strong>ということです。このことから以下のことが言えます。</p><p>(1) この表でFitするデータ種を主体に扱う場合にKey-Value型を選択する。<br>(2) エンタープライズ領域では、データ種や業務オペレーションは多種多様なことから一般的にはRelational型が選ばれることが多い。<br>(3) 特にスケーラビリティが求められる場合に、Relational型を基本としたうえで何らかの施策が必要。</p><p>ここで、(1)の選択はデータベースの特徴を踏まえて選択することから容易です。難しいのは(2)と(3)の判断となります。(2)で実装するのであればシンプルでもあり実装コストも非常に読みやすいのですが、(3)を選択した場合には実装コストにも大きく影響します。すなわち実現しようとしているシステムにおいて(2)でどこまでの範囲を実現できるのかがポイントになるのです。さらに、(2)では実現できない場合に(3)の選択をとる必要があるがどのようなアーキテクチャにすればよいのか。</p><h2 id="データモデルの観点からシステムの特徴をつかむ"><a href="#データモデルの観点からシステムの特徴をつかむ" class="headerlink" title="データモデルの観点からシステムの特徴をつかむ"></a>データモデルの観点からシステムの特徴をつかむ</h2><p>まず自分たちが取り組もうとしているシステムについての特徴をつかむ必要があります。今行わなくてはいけないのはデータベースのスケーラビリティの判断ですが、やみくもに性能指標値(TPS:秒間トランザクション数、QPS:秒間クエリー実行件数）を求めるのではなく、データモデルを中心として考える必要があります。</p><p>下の図では「小売業での在庫管理」を示す例となります（まったくの架空のデータです）。ECも展開していることからEC受注処理も入っています。主なオペレーションがどのエンティティにアクセスするのかのCRUD情報を示しています。アーキテクチャを検討する際に具体的なアプリケーションの設計は完了していないのが普通ですが、その企業の業務規模は見えているのが普通ですがからこの程度の情報は収集することは可能でしょう。</p><p>もちろんシステムにはこのほかにも多様な業務処理が存在し、エンティティも無数に存在しますが、主要なエンティティという視点で見渡すと意外にシンプルな形になります。データを中心に業務が動いているということを改めて感じるはずです。</p><img src="/images/20200703/photo_20200703_02.png"><img src="/images/20200703/photo_20200703_03.png"><p>この例では次のことが言えます。</p><ul><li>参照は主に在庫データについて行われており、約200QPSである。</li><li>更新は主に在庫データについて行われており、約100TPSである。</li></ul><p>経験上、この例のように「在庫エンティティ」といった<strong>高頻度に更新されるリソース系エンティティが存在する場合、データベースのスケーラビリティに悩むことが多い</strong>と感じます。</p><p>次に、データ参照とデータ更新についてそれぞれ確認していきます。</p><h2 id="データ参照のスケーラビリティ"><a href="#データ参照のスケーラビリティ" class="headerlink" title="データ参照のスケーラビリティ"></a>データ参照のスケーラビリティ</h2><p>これについては従来から対応方法は明確にあります。DBのレプリケーション技術を用いて別のインスタンスからデータを参照するという方法でMySQLやPostgreSQLでサポートされています。クラウドベンダの提供するRelational Database Serviceでは比較的容易に実現可能です。</p><ol><li>MySQLによReadonly用レプリケーション構成例<br><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-solutions-scaleout.html" target="_blank" rel="noopener">Using Replication for Scale-Out</a><img src="/images/20200703/photo_20200703_04.png"></li></ol><p>2.Amazon AuroraでのReadonly用レプリケーション構成例<br><a href="https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/Aurora.Overview.html" target="_blank" rel="noopener">Amazon Aurora DB クラスター</a><br><img src="/images/20200703/photo_20200703_05.png"></p><p>ここで紹介したように、<strong>データ参照(ReadOnly)についてのスケーラビリティという点については解決策があり、アーキテクチャとしての課題はないと考えてもよいでしょう。</strong>もちろん実装にあたっては十分な検討が必要です。</p><h2 id="データ更新のスケーラビリティの判断"><a href="#データ更新のスケーラビリティの判断" class="headerlink" title="データ更新のスケーラビリティの判断"></a>データ更新のスケーラビリティの判断</h2><p>ここが本記事の一番のポイントになるところです。レプリケーションによりデータ参照のスケーラビリティの確保は可能ですが、あくまでもデータ更新可能なデータベースインスタンスは一つです。そのため、そもそもそのデータベースでどのぐらいのトランザクション処理が可能なのかを把握しないことには次の検討ができません。</p><p>これについてはやってみるしかない。という答えになってしまうのですが、それでは、何をやれば把握できるのでしょうか。</p><p>これまでに、<strong>トランザクションログの保存がデータベースのスケーラビリティを決定する決定的な要素となる</strong>ということをすでに述べています。そうであるのであればこのトランザクションログに依存する性能が何によって決定するのかということを考えると決定できます。すなわち以下となります。</p><ul><li>トランザクションログの書き込まれるタイミングはcommitタイミングである。</li><li>ランザクションログの 書き込まれる量は更新データのサイズに依存する。</li></ul><p>これを先ほどの在庫管理システムに当てはめて考えてると以下のようになります。</p><img src="/images/20200703/photo_20200703_06.png"><p>約100TPS発生して、データ更新(insert/update)が約1500レコード発生しています。</p><p>このほか多数の業務が実施されているわけですし厳密に求めることは意味がありません。あくまでも傾向分析をしたいのでこの程度の情報で十分です。</p><p>この要件を実現できるかを実際にサンプルプログラムを作成して試してみます。その際に１レコード当たりのレコードサイズも重要な要素となるためこの値は現実的な数値で代表させるのが良いでしょう。また、updateとinsertではトランザクションログの発生量も変化するためにより負荷の高まるupdateに統一して試してもよいでしょう。このあたりは柔軟に考えればよいでしょう。ここでは100TPS発生してその際に15レコード更新されると仮定してみます。</p><p>得られたテスト結果が以下です。「records」はトランザクションあたりの更新レコード数を示します。（このテスト結果はテストシナリオにおけるあくまでもサンプルです）</p><img src="/images/20200703/photo_20200703_07.png"><img src="/images/20200703/photo_20200703_08.png"><p>この結果から、AWS Aurora (PostgreSQL)で今回の要件を実現する場合には、r4.8xlargeを利用した場合において実現性はありそうということが推測できます。</p><p>ただ、テストは単純化していますので実際のアプリケーション実装時の余裕率や将来のビジネスの伸びを考えるとやや心もとない感じがします。またさらに上のインスタンスクラスのr4.16xlargeでテストすることでTPSは向上する可能性はありますが、コストも２倍となることから費用面から積極的に選択することが難しそうです。</p><p>そのためこのような要件がある場合は、１つのデータベースインスタンスでの実現はリスクがあると判断し、よりスケールするための施策を模索することに舵を切ることことになります。反対にこの調査を行った結果、十分に余裕があるということであればスケーラビリティは十分確保されているということが言い切れます。</p><h2 id="Relational型データベースのスケーラブル構成"><a href="#Relational型データベースのスケーラブル構成" class="headerlink" title="Relational型データベースのスケーラブル構成"></a>Relational型データベースのスケーラブル構成</h2><p>一つのデータベースで扱うトランザクションに限界があるということですから、データベースを増やせばよいということになります。すなわちスケーラブルな構成とは扱うデータを分割して管理することになります。</p><p>その方法は以下の３つです。<br>(1)業務分割パターン<br>(2)論理分割パターン<br>(3)データ分割パターン</p><img src="/images/20200703/photo_20200703_09.png"><p>どのパターンを選択すべきかは、要件によって変わるため答えは一つではありません。</p><p>経験上ですが、</p><ul><li>エンティティをまたがるオペレーションが多く実装が</li><li>業務的はある一定の論理単位（例えば店舗）で行われることが多い</li></ul><p>という観点で(2)を選択する場面が多いような気がします。<br>また、業務規模が大きくエンティティも複雑で、保守性をより強固に持ちたい場合には、マイクロサービス指向に合致している(1)が選択されるでしょう。</p><h2 id="Relational型データベースのデータ保持"><a href="#Relational型データベースのデータ保持" class="headerlink" title="Relational型データベースのデータ保持"></a>Relational型データベースのデータ保持</h2><p>スケーラブルな構成とするためには実際のデータをどのように保持するのかについても検討する必要があります。データ保持形態によってスケーラビリティに制約が出ると本末転倒となるのでここまでの検討は事前に行う必要があります。</p><p>先ほどの例の「論理分割パターン」において、店舗(=店コード)で分割した場合を考えます。同一データベースにある各店舗のデータをどのようにテーブル保持するのかがポイントです。</p><p>この部分の検討は、データベースソフトウェアに深く依存することになりますので、事前の調査はしておく必要があります。以下の図はPostgreSQLをベースとした検討例です。</p><img src="/images/20200703/photo_20200703_10.png"><p>PostgreSQLのパーティションの特性についてここで詳細は記載しませんが制約事項について理解する必要があります。理屈上は正しいが、実装してみると正しくスケールしないということもあるため確認したほうが良いでしょう。以下に参考リンクを載せておきます。</p><ul><li><a href="https://future-architect.github.io/articles/20181019/">PostgreSQLパーティションプルーニングの動作を確認する</a></li><li><a href="http://www.intellilink.co.jp/article/column/oss-postgres11_02.html" target="_blank" rel="noopener">PostgreSQL11でのテーブル・パーティショニング機能の改善</a></li><li><a href="https://www.2ndquadrant.com/en/blog/postgresql-12-partitioning/" target="_blank" rel="noopener">PostgreSQL 12: Partitioning is now faster</a></li></ul><p>(3)のスキーマ分割はデータの論理分割パターンにおける究極の形です。テーブル管理が手間が非常となりますが、わかりやすさと運用での安定性から意外と悪くない方法だと考えています。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>だいぶ長くなりましたので、最後にこれまに検討してきた内容をまとめてみます。</p><ul><li>データベースのスケーラビリティにはトランザクションログが決定的な影響を与えることについて解説しました。</li><li>実現にあたって、Key-Value型とRelational型の選択の考え方について解説をしています。実際の場面としてRelational型を基本として検討することが多いが、実現にあたっては通常の方法でできるのか、特別な施策が必要なのかという範囲の見極めについて議論しました</li><li>スケーラビリティの検討にあたっては、まずはデータモデルという視点で検討を行い、スケーラブル構成をとるべき判断ポイントについての例をあげました。</li><li>Relational型のデータベースの構成例とテーブル実装方法について検討しました。</li></ul><p>ここまでの流れを一通り理解することにより<strong>「何となく決める」ではなく「根拠をもって決める」ということが可能になるはずです。</strong>後悔しない（←これ大事です。つまり無理をした実装はTOCの増大を招くことになります）スケーラブルデータベース構成を自信をもって決定することができるでしょう。</p><p>今回はトランザクション型データベースということで触れなかったアナリティック型データベースについての考察はいずれまた記載してみます。</p><p>おわり。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事:"></a>関連記事:</h1><ul><li><a href="https://future-architect.github.io/articles/20161031/">SQL実行時のブルームフィルタ(Bloom Filter)アルゴリズム</a></li><li><a href="https://future-architect.github.io/articles/20190718/">― 脱RDB脳 ― Cassandraのデータモデルについて考えてみる</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;エンタープライズでのミッションクリティカル領域においてもクラウド利用が普通になってきています。&lt;/p&gt;
&lt;p&gt;その過程におい
      
    
    </summary>
    
    
      <category term="DB" scheme="https://future-architect.github.io/categories/DB/"/>
    
    
      <category term="DB" scheme="https://future-architect.github.io/tags/DB/"/>
    
      <category term="RDB" scheme="https://future-architect.github.io/tags/RDB/"/>
    
      <category term="KVS" scheme="https://future-architect.github.io/tags/KVS/"/>
    
  </entry>
  
  <entry>
    <title>Auth0の設定をバージョン管理し、Auth0 Deploy CLIを利用してデプロイ環境を整える</title>
    <link href="https://future-architect.github.io/articles/20200702/"/>
    <id>https://future-architect.github.io/articles/20200702/</id>
    <published>2020-07-02T00:48:34.000Z</published>
    <updated>2020-07-02T01:48:17.202Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、TIG/DXユニットの市川です。</p><p>私が所属しているプロジェクトでは認証認可基盤としてAuth0を使用しています。検証段階や初期構築段階では各種設定をダッシュボードから操作することが多いと思いますが、実際に本番運用を行っていると、Auth0の設定やRulesのスクリプトをGit管理し、変更履歴を追えるようにしたいというケースが出てくるかと思います。</p><p>今回は、Auth0から提供されている<a href="https://auth0.com/docs/extensions/deploy-cli" target="_blank" rel="noopener">Auth0 Deploy CLI</a>という拡張機能を利用して、Auth0テナントの設定をエクスポートする方法と私のプロジェクトで実際に行っているAuth0テナントへのデプロイの方法をお伝えします。</p><p>最終的なイメージは下記の通りです。</p><img src="/images/20200702/photo_20200702_01.png"><h1 id="1-実行環境"><a href="#1-実行環境" class="headerlink" title="1. 実行環境"></a>1. 実行環境</h1><p>今回の記事の作成で使用した実行環境は以下の通りです。</p><p><a href="https://www.npmjs.com/package/npm" target="_blank" rel="noopener">npm</a>：6.14.5<br><a href="https://www.npmjs.com/package/auth0-deploy-cli" target="_blank" rel="noopener">auth0-deploy-cli</a>：5.0.0</p><h1 id="2-Auth0-Deploy-CLIとは"><a href="#2-Auth0-Deploy-CLIとは" class="headerlink" title="2. Auth0 Deploy CLIとは"></a>2. Auth0 Deploy CLIとは</h1><p>Auth0 Deploy CLIとはAuth0で提供されている拡張機能です。<br>これを利用するとAuth0テナントの設定情報をエクスポートできることに加え、テナントの設定情報を記載したファイルを、各Auth0テナントへ反映できます。<br>よって、この拡張機能をCI/CDに組み込み、そこからデプロイを行うことも可能です。</p><h1 id="3-既存環境のエクスポート"><a href="#3-既存環境のエクスポート" class="headerlink" title="3. 既存環境のエクスポート"></a>3. 既存環境のエクスポート</h1><p>では早速既存環境のエクスポートから行っていきます。</p><h2 id="3-1-Auth0-Deploy-CLIで使用するアプリケーションを各テナントに作成する"><a href="#3-1-Auth0-Deploy-CLIで使用するアプリケーションを各テナントに作成する" class="headerlink" title="3-1. Auth0 Deploy CLIで使用するアプリケーションを各テナントに作成する"></a>3-1. Auth0 Deploy CLIで使用するアプリケーションを各テナントに作成する</h2><p>Auth0テナントにAuth0 Deploy CLIで使用するアプリケーションを作成します。<br>（各環境ごとにAuth0テナントを作成している場合は、それぞれのテナントごとにApplicationを作成する必要があります）</p><p>Application Type はM2M(Machine to Machine Applications)を指定します。</p><img src="/images/20200702/photo_20200702_02.png"><p>使用するAPIはAuth0 Management APIを選択し、auth0-deploy-cliを使用するに当たり必要となるSCOPEを設定します。</p><p>必要となるSCOPEは下記をご確認ください。</p><p><a href="https://auth0.com/docs/extensions/deploy-cli/guides/create-deploy-cli-application-manually#required-scopes" target="_blank" rel="noopener">Required Scopes - Create and Configure the Deploy CLI Application Manually</a></p><p>SCOPE設定後、ポップアップ下部のAUTHORIZEを押下します。</p><img src="/images/20200702/photo_20200702_03.png"><h2 id="3-2-ローカル環境にAuth0-Deploy-CLIの拡張機能をインストールする。"><a href="#3-2-ローカル環境にAuth0-Deploy-CLIの拡張機能をインストールする。" class="headerlink" title="3-2. ローカル環境にAuth0 Deploy CLIの拡張機能をインストールする。"></a>3-2. ローカル環境にAuth0 Deploy CLIの拡張機能をインストールする。</h2><p>npmを使用して、auth0-deploy-cliをローカル環境にインストールします。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -g auth0-deploy-cli</span><br></pre></td></tr></table></figure><h2 id="3-3-エクスポート先のディレクトリの作成"><a href="#3-3-エクスポート先のディレクトリの作成" class="headerlink" title="3-3. エクスポート先のディレクトリの作成"></a>3-3. エクスポート先のディレクトリの作成</h2><p>まずエクスポートする設定の置き場所となる任意のディレクトリを作成します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir auth0-deploy</span><br><span class="line">$ <span class="built_in">cd</span> auth0-deploy</span><br></pre></td></tr></table></figure><h2 id="3-4-設定ファイルのconfig-jsonを作成"><a href="#3-4-設定ファイルのconfig-jsonを作成" class="headerlink" title="3-4 設定ファイルのconfig.jsonを作成"></a>3-4 設定ファイルのconfig.jsonを作成</h2><p>次にエクスポートを行う際に使用するconfig.jsonを作成します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ touch config.json</span><br></pre></td></tr></table></figure><p>作成したconfig.jsonに、先程作成したアプリケーションのdomainやclient id、client secrtetの情報を下記のフォーマットで記載します。</p><figure class="highlight json"><figcaption><span>auth0-deploy/config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"AUTH0_DOMAIN"</span>: <span class="string">"YOUR_DOMAIN"</span>,</span><br><span class="line">  <span class="attr">"AUTH0_CLIENT_ID"</span>: <span class="string">"YOUR_CLIENT_ID"</span>,</span><br><span class="line">  <span class="attr">"AUTH0_CLIENT_SECRET"</span>: <span class="string">"YOUR_CLIENT_SECRET"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client id等の情報はAuth0のダッシュボードから確認することができます。</p><img src="/images/20200702/photo_20200702_04.png"><h2 id="3-5-exportコマンドでエクスポートする"><a href="#3-5-exportコマンドでエクスポートする" class="headerlink" title="3-5. exportコマンドでエクスポートする"></a>3-5. exportコマンドでエクスポートする</h2><p>これでテナントの設定をエクスポートする準備が整いました。<br>下記コマンドを実行して、Auth0テナントの設定をエクスポートします。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ a0deploy <span class="built_in">export</span> -c config.json -f yaml -o ./</span><br></pre></td></tr></table></figure><p>-cはconfigファイル、-fはフォーマット、-oはエクスポート先のディレクトリを指定します。<br>プロキシ経由の場合はプロキシのオプション（-p）を設定します。</p><p>詳細は<a href="https://auth0.com/docs/extensions/deploy-cli/references/deploy-cli-options#options" target="_blank" rel="noopener">こちら</a>をご確認ください。</p><p>コマンドを実行し、ログの最後に<code>Export Successful</code>が出力されれば、エクスポートは成功です。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ 20XX-YY-ZZ:ZZ:SS.SSSZ - info: Loading Auth0 Tenant Data</span><br><span class="line">$ 20XX-YY-ZZ:ZZ:SS.SSSZ - info: Retrieving rules data from Auth0</span><br><span class="line">...</span><br><span class="line">$ 20XX-YY-ZZ:ZZ:SS.SSSZ - info: Exporting guardianFactorTemplates</span><br><span class="line">$ 20XX-YY-ZZ:ZZ:SS.SSSZ - info: Exporting roles</span><br><span class="line">$ 20XX-YY-ZZ:ZZ:SS.SSSZ - info: Writing tenant.yaml</span><br><span class="line">$ 20XX-YY-ZZ:ZZ:SS.SSSZ - info: Export Successful</span><br></pre></td></tr></table></figure><h2 id="3-6-ディレクトリ構成"><a href="#3-6-ディレクトリ構成" class="headerlink" title="3-6. ディレクトリ構成"></a>3-6. ディレクトリ構成</h2><p>各環境が設定している内容により異なることはありますが、私が使用しているテナントは下記のようなディレクトリ構成となりました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">|   <span class="comment"># 新規登録時やアカウントブロック時に送信されるemailテンプレート</span></span><br><span class="line">├── emailTemplates</span><br><span class="line">│   ├── blocked_account.html</span><br><span class="line">│   ├── reset_email.html</span><br><span class="line">│   └── verify_email.html</span><br><span class="line">|</span><br><span class="line">|   <span class="comment"># Universal Loginで使用するログイン画面やパスワード再発行ページ</span></span><br><span class="line">├── pages　　　　　　　　　　　　</span><br><span class="line">|   ├── error_page.html</span><br><span class="line">|   ├── login.html</span><br><span class="line">|   └── password_reset.html</span><br><span class="line">|</span><br><span class="line">|   <span class="comment"># テナントにされている各Rulesのスクリプト</span></span><br><span class="line">├── rules</span><br><span class="line">|   ├── hoge.js</span><br><span class="line">|   └── fuga.js</span><br><span class="line">|</span><br><span class="line">|   <span class="comment"># テナントの設定が記載されているyamlファイル</span></span><br><span class="line">└── tenant.yaml</span><br></pre></td></tr></table></figure><h2 id="3-7-各環境ごとのデプロイに対応したディレクトリ構成に変更する"><a href="#3-7-各環境ごとのデプロイに対応したディレクトリ構成に変更する" class="headerlink" title="3-7. 各環境ごとのデプロイに対応したディレクトリ構成に変更する"></a>3-7. 各環境ごとのデプロイに対応したディレクトリ構成に変更する</h2><p>私が所属しているプロジェクトでは3つの環境を使用しているため、Auth0テナントも3つ使用しています。<br>各環境ごとに設定内容が同一ではない項目もあるため、テナントの設定が記載されているyamlファイルを環境ごとに作成しています。<br>よって下記のようなディレクトリ構成となります。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">|   <span class="comment"># 新規登録時やアカウントブロック時に送信されるemailテンプレート</span></span><br><span class="line">├── emailTemplates</span><br><span class="line">│   ├── blocked_account.html</span><br><span class="line">│   ├── reset_email.html</span><br><span class="line">│   └── verify_email.html</span><br><span class="line">|</span><br><span class="line">|   <span class="comment"># Universal Loginで使用するログイン画面やパスワード再発行ページ</span></span><br><span class="line">├── pages　　　　　　　　　　　　</span><br><span class="line">|   ├── error_page.html</span><br><span class="line">|   ├── login.html</span><br><span class="line">|   └── password_reset.html</span><br><span class="line">|</span><br><span class="line">|   <span class="comment"># テナントにされている各Rulesのスクリプト</span></span><br><span class="line">├── rules</span><br><span class="line">|   ├── hoge.js</span><br><span class="line">|   └── fuga.js</span><br><span class="line">|</span><br><span class="line">|   テナントの設定が記載されているyamlファイル</span><br><span class="line">└── tenant-dev.yaml</span><br><span class="line">└── tenant-stg.yaml</span><br><span class="line">└── tenant-prd.yaml</span><br></pre></td></tr></table></figure><h1 id="4-環境ごとに差異がある値を環境変数に定義する"><a href="#4-環境ごとに差異がある値を環境変数に定義する" class="headerlink" title="4. 環境ごとに差異がある値を環境変数に定義する"></a>4. 環境ごとに差異がある値を環境変数に定義する</h1><p>テナントの設定をエクスポートした時点ではドメイン等、環境によって変えたい変数がハードコーディングされている状態になっています。<br>もしrulesやemailTemplate配下のファイルで環境ごとにセットしたい値が異なる場合は、環境変数を用いて正しい値がセットされるようにします。</p><p>Auth0 Deploy CLIでは、デプロイ時に指定するconfigファイルに<code>AUTH0_KEYWORD_REPLACE_MAPPINGS</code> を指定して環境変数のセットを行うと、configファイルから値を読み取って環境変数がセットされます。</p><figure class="highlight json"><figcaption><span>auth0-deploy/config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"AUTH0_DOMAIN"</span>: <span class="string">"YOUR_DOMAIN"</span>,</span><br><span class="line">  <span class="attr">"AUTH0_CLIENT_ID"</span>: <span class="string">"YOUR_CLIENT_ID"</span>,</span><br><span class="line">  <span class="attr">"AUTH0_CLIENT_SECRET"</span>: <span class="string">"YOUR_CLIENT_SECRET"</span>,</span><br><span class="line">   <span class="attr">"AUTH0_KEYWORD_REPLACE_MAPPINGS"</span>: &#123;</span><br><span class="line">        <span class="attr">"DOMAIN"</span>: <span class="string">"https://www.example.com"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下記に例を記載します。</p><p>login.htmlが下記の様になっていた場合、</p><figure class="highlight html"><figcaption><span>auth0-source/pages/login.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"##DOMAIN##/sample"</span>&gt;</span>サンプルリンク<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>デプロイ時にはconfig.jsonファイルから環境変数が適用され、環境ごとに値を変えることができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://www.example.com/sample"</span>&gt;</span>サンプルリンク<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="5-デプロイ環境の整備"><a href="#5-デプロイ環境の整備" class="headerlink" title="5. デプロイ環境の整備"></a>5. デプロイ環境の整備</h1><p>私のプロジェクトではソースコードの管理をGitlabで行っており、上記作業完了後、リモートリポジトリにpushします。</p><p>その後、Gitlab CI/CDを起動して上記テナントのディレクトリをS3へアップロードしたことをトリガーにCodePipelineが起動し、CodeBuild上でAuth0テナントのデプロイを行っています。</p><p>実際に使用しているbuildspec.ymlは下記の通りです。<br>client idやclient secretを指定するconfigファイルはAWSのParameter Storeから読みとった値をCodeBuild上でセットしています。</p><figure class="highlight yml"><figcaption><span>buildspec.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">phases:</span></span><br><span class="line">  <span class="attr">pre_build:</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">npm</span> <span class="string">i</span> <span class="string">-g</span> <span class="string">auth0-deploy-cli@5.0.0</span></span><br><span class="line">  <span class="attr">post_build:</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">echo</span> <span class="string">creating</span> <span class="string">config</span> <span class="string">file</span> <span class="string">started</span></span><br><span class="line">      <span class="comment"># ↓リポジトリ上ではclient id等をハードコーディングしたconfig.jsonファイルは保持せず、config.jsonのテンプレートファイルのみ保持し、Parameter Storeの値をもとにファイルを新規作成しています。</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">envsubst</span> <span class="string">&lt;</span> <span class="string">config-template.json</span> <span class="string">&gt;</span> <span class="string">config.json</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">echo</span> <span class="string">finished</span> <span class="string">creating</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cat</span> <span class="string">config.json</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">echo</span> <span class="string">auth0-deploy-cli</span> <span class="string">version</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">a0deploy</span> <span class="string">--version</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">echo</span> <span class="string">Auth0</span> <span class="string">Deploy</span> <span class="string">started</span></span><br><span class="line">      <span class="comment"># ↓ENVは環境変数から読み取っています</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">a0deploy</span> <span class="string">import</span> <span class="string">-c</span> <span class="string">config.json</span> <span class="string">-i</span> <span class="string">tenant-$&#123;ENV&#125;.yaml</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">echo</span> <span class="string">Auth0</span> <span class="string">Deploy</span> <span class="string">completed</span></span><br></pre></td></tr></table></figure><p>これでデプロイ環境を整備することができました。</p><p>基本的には初期構築時のExportファイルを正として管理を行っていますが、Auth0上で大きな設定変更が生じた際は念の為テナント設定のExportを行い、正管理ファイルに誤りがないかどうか、必要に応じて確認を行っています。</p><h1 id="6-最後に"><a href="#6-最後に" class="headerlink" title="6. 最後に"></a>6. 最後に</h1><p>Auth0 Deploy CLIを利用して既存テナントの設定をエクスポートするところから、実際にCI/CDに組み込んでデプロイを行う部分までをご紹介してきました。<br>ただ、Auth0の設定管理は今回扱ったAuth0 Deploy CLIだけでなく、Teraformで管理することも可能です。（<a href="https://www.terraform.io/docs/providers/auth0/index.html）" target="_blank" rel="noopener">https://www.terraform.io/docs/providers/auth0/index.html）</a></p><p>そのため、自身が所属しているプロジェクトの状況に応じて適切なものを選択・利用していくのが良いかと思います。</p><h1 id="7-関連リンク"><a href="#7-関連リンク" class="headerlink" title="7. 関連リンク"></a>7. 関連リンク</h1><p><a href="https://www.npmjs.com/package/auth0-deploy-cli" target="_blank" rel="noopener">Auth0 Deploy CLI Tool</a><br><a href="https://future-architect.github.io/articles/20200122/">Auth0 導入編</a><br><a href="https://future-architect.github.io/articles/20200123/">Auth0 EmailまたはSMSを使ったパスワードレス認証を設定する</a><br><a href="https://future-architect.github.io/articles/20200128/">Auth0のRulesを使って認証認可を自在にカスタマイズする</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、TIG/DXユニットの市川です。&lt;/p&gt;
&lt;p&gt;私が所属しているプロジェクトでは認証認可基盤としてAuth0を使
      
    
    </summary>
    
    
      <category term="CI/CD" scheme="https://future-architect.github.io/categories/CI-CD/"/>
    
    
      <category term="AWS" scheme="https://future-architect.github.io/tags/AWS/"/>
    
      <category term="Auth0" scheme="https://future-architect.github.io/tags/Auth0/"/>
    
      <category term="GitLab" scheme="https://future-architect.github.io/tags/GitLab/"/>
    
  </entry>
  
  <entry>
    <title>Go の Open API 3.0 のジェネレータ oapi-codegen を試してみた</title>
    <link href="https://future-architect.github.io/articles/20200701/"/>
    <id>https://future-architect.github.io/articles/20200701/</id>
    <published>2020-07-01T00:40:40.000Z</published>
    <updated>2020-07-01T00:54:13.470Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200701/top.png" class="img-middle-size"><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>TIG DXチーム所属の多賀です。最近はフロントのコードを書いたりすることも増えましたが、引き続き Go も触っています。<br>Go で OpenAPI(Swagger) からコード生成する際には、 go-swagger をよく利用しています。<br>go-swagger については他記事でもまとめられています。</p><ul><li><a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選</a></li><li><a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた</a></li></ul><p>ただ、 go-swagger は Swagger 2.0 にのみ対応しており、OpenAPI 3.0 系が使えない問題がありました。最新に追従していく上でも Open API 3.0 系に寄せていきたいと考えていたので、なにか使えるツールはないか探したところ、以下を見つけました。</p><p><a href="https://github.com/deepmap/oapi-codegen" target="_blank" rel="noopener">https://github.com/deepmap/oapi-codegen</a></p><p>使えるかどうか実際に動かして試してみます。</p><p>ざっと見た感じは、以下の模様です。</p><ul><li>Open API 3.0 の定義から Go のソースコードを生成できる</li><li>echo, chi の形式でServerソースが出力できる</li><li>Go の interface で Open API の仕様が定義され interfaceを満たすように実装していく</li></ul><h2 id="調査"><a href="#調査" class="headerlink" title="調査"></a>調査</h2><p>実際に OpenAPI 定義からコードを出力してみます。</p><p>ライブラリ側で OpenAPI定義のサンプルが用意されていたためそのまま利用してみます。<br><a href="https://github.com/deepmap/oapi-codegen/blob/master/examples/petstore-expanded/petstore-expanded.yaml" target="_blank" rel="noopener">https://github.com/deepmap/oapi-codegen/blob/master/examples/petstore-expanded/petstore-expanded.yaml</a></p><p>ざっくり以下のAPI が定義されています。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;pets</span><br><span class="line">POST &#x2F;pets</span><br><span class="line">GET &#x2F;pets&#x2F;&#123;id&#125;</span><br><span class="line">DELETE &#x2F;pets&#x2F;&#123;id&#125;</span><br></pre></td></tr></table></figure><p>上記を <code>openapi.yml</code> としてダウンロードしました。</p><p>とりあえず、コード生成を実行してみます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンドインストール</span></span><br><span class="line">go get github.com/deepmap/oapi-codegen/cmd/oapi-codegen@v1.3.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go コード生成</span></span><br><span class="line">oapi-codegen openapi.yml &gt; openapi.gen.go</span><br></pre></td></tr></table></figure><p>こちらで Goのコードが1ファイルに生成されました。<br>生成項目としては以下4点です。</p><ul><li>型定義</li><li>http client</li><li>http server</li><li>OpenAPI spec</li></ul><p>実際に利用する際は、必要な分だけ生成・管理したいかなと思います。<br>生成コードとはいえ、1ファイルにまとまっていると少々読みづらかったりもします。<br>コマンドのパラメータで制御できるようでしたので、それぞれ別にコード生成し中身を確認していきます。<br>(生成コードは長くなるため一部抜粋しています。)</p><h4 id="型定義"><a href="#型定義" class="headerlink" title="型定義"></a>型定義</h4><ul><li>OpenAPI の <code>components</code> から struct を生成</li><li>リクエスト Bodyの定義も同様に生成</li></ul><p><code>コマンド</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oapi-codegen -generate <span class="string">"types"</span> -package openapi openapi.yml &gt; ./openapi/types.gen.go</span><br></pre></td></tr></table></figure><p><code>生成コード</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewPet defines model for NewPet.</span></span><br><span class="line"><span class="keyword">type</span> NewPet <span class="keyword">struct</span> &#123;</span><br><span class="line">Age  *<span class="keyword">int</span>    <span class="string">`json:"age,omitempty"`</span></span><br><span class="line">Kind *<span class="keyword">string</span> <span class="string">`json:"kind,omitempty"`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Name of the pet</span></span><br><span class="line">Name <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Type of the pet</span></span><br><span class="line">Tag *<span class="keyword">string</span> <span class="string">`json:"tag,omitempty"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="http-client"><a href="#http-client" class="headerlink" title="http client"></a>http client</h4><ul><li>API仕様が interface として出力</li><li>2種類の interface が定義<ul><li>ClientInterface<ul><li>API実行の結果 http.Response が返却される</li></ul></li><li>ClientWithResponsesInterface<ul><li>API実行の結果の Response Body を parse して struct へ詰めてくれる<ul><li>Body を []byte 形式で保持するためメモリ効率はいまいち</li></ul></li></ul></li></ul></li><li>上記 interface を実装した struct も合わせて生成済<ul><li>生成された Client を利用するだけで良い</li></ul></li></ul><p><code>コマンド</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oapi-codegen -generate <span class="string">"client"</span> -package openapi openapi.yml &gt; ./openapi/client.gen.go</span><br></pre></td></tr></table></figure><p><code>生成コード</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The interface specification for the client above.</span></span><br><span class="line"><span class="keyword">type</span> ClientInterface <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// FindPets request</span></span><br><span class="line">FindPets(ctx context.Context, params *FindPetsParams) (*http.Response, error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddPet request  with any body</span></span><br><span class="line">AddPetWithBody(ctx context.Context, contentType <span class="keyword">string</span>, body io.Reader) (*http.Response, error)</span><br><span class="line"></span><br><span class="line">AddPet(ctx context.Context, body AddPetJSONRequestBody) (*http.Response, error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeletePet request</span></span><br><span class="line">DeletePet(ctx context.Context, id <span class="keyword">int64</span>) (*http.Response, error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// FindPetById request</span></span><br><span class="line">FindPetById(ctx context.Context, id <span class="keyword">int64</span>) (*http.Response, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client which conforms to the OpenAPI3 specification for this service.</span></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// The endpoint of the server conforming to this interface, with scheme,</span></span><br><span class="line"><span class="comment">// https://api.deepmap.com for example.</span></span><br><span class="line">Server <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Doer for performing requests, typically a *http.Client with any</span></span><br><span class="line"><span class="comment">// customized settings, such as certificate chains.</span></span><br><span class="line">Client HttpRequestDoer</span><br><span class="line"></span><br><span class="line"><span class="comment">// A callback for modifying requests which are generated before sending over</span></span><br><span class="line"><span class="comment">// the network.</span></span><br><span class="line">RequestEditor RequestEditorFn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span> <span class="title">FindPets</span><span class="params">(ctx context.Context, params *FindPetsParams)</span> <span class="params">(*http.Response, error)</span></span> &#123;</span><br><span class="line">req, err := NewFindPetsRequest(c.Server, params)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">req = req.WithContext(ctx)</span><br><span class="line"><span class="keyword">if</span> c.RequestEditor != <span class="literal">nil</span> &#123;</span><br><span class="line">err = c.RequestEditor(ctx, req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> c.Client.Do(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用コード</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c := openapi.NewClient(<span class="string">"http://localhost:8888"</span>)</span><br><span class="line">params := openapi.FindPetsParams&#123;Tags: []<span class="keyword">string</span>&#123;<span class="string">"dog"</span>&#125;&#125;</span><br><span class="line"><span class="comment">// http.Response として返却</span></span><br><span class="line">res, err := c.FindPets(context.Background(),  params)</span><br></pre></td></tr></table></figure><h4 id="http-server"><a href="#http-server" class="headerlink" title="http server"></a>http server</h4><ul><li>API仕様が interface として定義</li><li>interface を実装する形で Server側のコードを実装していく</li></ul><p><code>コマンド</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oapi-codegen -generate <span class="string">"server"</span> -package openapi openapi.yml &gt; ./openapi/server.gen.go</span><br></pre></td></tr></table></figure><p><code>生成コード</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServerInterface represents all server handlers.</span></span><br><span class="line"><span class="keyword">type</span> ServerInterface <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Returns all pets</span></span><br><span class="line"><span class="comment">// (GET /pets)</span></span><br><span class="line">FindPets(ctx echo.Context, params FindPetsParams) error</span><br><span class="line"><span class="comment">// Creates a new pet</span></span><br><span class="line"><span class="comment">// (POST /pets)</span></span><br><span class="line">AddPet(ctx echo.Context) error</span><br><span class="line"><span class="comment">// Deletes a pet by ID</span></span><br><span class="line"><span class="comment">// (DELETE /pets/&#123;id&#125;)</span></span><br><span class="line">DeletePet(ctx echo.Context, id <span class="keyword">int64</span>) error</span><br><span class="line"><span class="comment">// Returns a pet by ID</span></span><br><span class="line"><span class="comment">// (GET /pets/&#123;id&#125;)</span></span><br><span class="line">FindPetById(ctx echo.Context, id <span class="keyword">int64</span>) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServerInterfaceWrapper converts echo contexts to parameters.</span></span><br><span class="line"><span class="keyword">type</span> ServerInterfaceWrapper <span class="keyword">struct</span> &#123;</span><br><span class="line">Handler ServerInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FindPets converts echo context to params.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *ServerInterfaceWrapper)</span> <span class="title">FindPets</span><span class="params">(ctx echo.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parameter object where we will unmarshal all parameters from the context</span></span><br><span class="line"><span class="keyword">var</span> params FindPetsParams</span><br><span class="line"><span class="comment">// ------------- Required query parameter "tags" -------------</span></span><br><span class="line"></span><br><span class="line">err = runtime.BindQueryParameter(<span class="string">"form"</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="string">"tags"</span>, ctx.QueryParams(), &amp;params.Tags)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> echo.NewHTTPError(http.StatusBadRequest, fmt.Sprintf(<span class="string">"Invalid format for parameter tags: %s"</span>, err))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------- Optional query parameter "limit" -------------</span></span><br><span class="line"></span><br><span class="line">err = runtime.BindQueryParameter(<span class="string">"form"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="string">"limit"</span>, ctx.QueryParams(), &amp;params.Limit)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> echo.NewHTTPError(http.StatusBadRequest, fmt.Sprintf(<span class="string">"Invalid format for parameter limit: %s"</span>, err))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Invoke the callback with all the unmarshalled arguments</span></span><br><span class="line">err = w.Handler.FindPets(ctx, params)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>利用コード</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServerInterface を実装するような struct を定義</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> petHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(si petHandler)</span> <span class="title">FindPets</span><span class="params">(ctx echo.Context, params FindPetsParams)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// GET /pets の処理記載</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(si petHandler)</span> <span class="title">AddPet</span><span class="params">(ctx echo.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">b := NewPet&#123;&#125;</span><br><span class="line"><span class="comment">// リクエスト Body は echo の APIを利用</span></span><br><span class="line">ctx.Bind(&amp;b)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /pets の処理記載</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(si petHandler)</span> <span class="title">DeletePet</span><span class="params">(ctx echo.Context, id <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// DELETE /pets/&#123;id&#125; の処理記載</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(si petHandler)</span> <span class="title">FindPetById</span><span class="params">(ctx echo.Context, id <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// GET /pets/&#123;id&#125; の処理記載</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">e := echo.New()</span><br><span class="line">handler := petHandler&#123;&#125;</span><br><span class="line"><span class="comment">// 定義した struct を登録</span></span><br><span class="line">openapi.RegisterHandlers(e, handler)</span><br><span class="line">e.Logger.Fatal(e.Start(fmt.Sprintf(<span class="string">"0.0.0.0:%d"</span>, *port)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/go-chi/chi" target="_blank" rel="noopener">chi</a> 形式でも出力できます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># server (chi)</span></span><br><span class="line">oapi-codegen -generate <span class="string">"chi-server"</span> openapi.yml &gt; openapi_chi_server.gen.go</span><br></pre></td></tr></table></figure><h4 id="OpenAPI-spec"><a href="#OpenAPI-spec" class="headerlink" title="OpenAPI spec"></a>OpenAPI spec</h4><ul><li>base64形式で <code>openapi.yaml</code> を保持</li></ul><p><code>コマンド</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oapi-codegen -generate <span class="string">"spec"</span> -package openapi openapi.yml &gt; ./openapi/spec.gen.go</span><br></pre></td></tr></table></figure><p><code>生成コード</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Base64 encoded, gzipped, json marshaled Swagger object</span></span><br><span class="line"><span class="keyword">var</span> swaggerSpec = []<span class="keyword">string</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="string">"H4sIAAAAAAAC/+RWTW/jNhD9K8S0R1XSJosedGp2nQIGiiRotqfAB0YcyWzFj5CjOEKg/16QlJ3Y0iZY"</span>,</span><br><span class="line"><span class="string">"tCha9GST4pBv3nsz5DPURlmjUZOH6hl8vUXF499L54wLf6wzFh1JjNO1ERh+BfraSUvSaKjSYha/ZdAY"</span>,</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="レビュー"><a href="#レビュー" class="headerlink" title="レビュー"></a>レビュー</h2><p>良さそうな点と気になる点をまとめました。</p><h3 id="良さそうなところ"><a href="#良さそうなところ" class="headerlink" title="良さそうなところ"></a>良さそうなところ</h3><ul><li>生成コードが薄めで良い<ul><li>go-swagger は生成コードが重厚かつintefaceで分離されて実装が追いづらい点が気になっていた</li><li>echo/chi の APIが直接触れる</li></ul></li><li>echoやchi などの選択も結構好み</li><li>tag指定して出力すると依存のある定義のみが出力される<ul><li><code>oapi-codegen -include-tags pet -generate &quot;server&quot; openapi.yml</code></li></ul></li><li>クエリパラメータが struct へ Bindされる</li><li>パラメータのバリデーションに対応<ul><li>デフォルトだとリクエストボディはバリデーションされない (読まれないため)</li><li>Echo だと middleware をいれれば Body のバリデーションエラーも見れる<ul><li><code>middleware.OapiRequestValidator(swagger)</code></li><li>OpenAPI の spec が必要</li></ul></li></ul></li></ul><h3 id="気になるところ"><a href="#気になるところ" class="headerlink" title="気になるところ"></a>気になるところ</h3><ul><li>拡張タグは動かなそう<ul><li><code>x-XXX</code> 系は動作しない</li></ul></li><li>生成 struct の型定義に違和感<ul><li>required が 基本型 で optional が pointer 型</li><li>Go のコードでよく見る定義と逆なので注意が必要</li></ul></li><li><strong>レスポンス定義は Bind されない</strong><ul><li>実装者がレスポンスの struct を間違えないようにする必要がある</li><li>(個人的には一番いまいちかなと感じた点です。生成コード上仕方なさそうでしたが..)</li></ul></li><li>1 interface で Open API の定義が出力される<ul><li>include-tags を利用してタグ別に出力はうまく動作しない<ul><li>Server interface の実装が1つでないといけないため (echo/chiに登録できない)</li></ul></li><li>特定の tag のみ実装するケースでの利用可能</li></ul></li><li>同一 package に押し込める必要あり<ul><li>server, client コードは types に依存している</li></ul></li><li>echo と chi だと若干 echo 側のほうがリクエストの Bind が良い<ul><li>echo だと生成 Handler の引数にリクエストパラメータの struct が定義される</li><li>chi だと context から取得する必要あり<ul><li>生成コードで ctx から取り出すヘルパー関数あり</li></ul></li></ul></li></ul><h3 id="利用するとしたら"><a href="#利用するとしたら" class="headerlink" title="利用するとしたら..?"></a>利用するとしたら..?</h3><ul><li>echoでの出力を選択<ul><li>リクエストパラメータのバインドがしっかりされるため</li><li>middleware 利用だがリクエストボディのバリデーションチェックもできて良い</li></ul></li><li>出力は同一パッケージでファイルを分けて管理<ul><li>サーバー<ul><li>server, types, spec</li></ul></li><li>クライアント<ul><li>client, types</li></ul></li></ul></li><li>生成コード用の パッケージ (ディレクトリ) を切る<ul><li>各生成コードに依存があるため</li></ul></li><li>各API のレスポンス定義の命名を統一する<ul><li>レスポンス Body の Bindがされないため</li><li><code>${operationId}Res</code> or <code>${operationId}Response</code></li></ul></li></ul><h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>ざっとコード生成を試して、コード側の確認をしてみました。<br>結構利用できそうだなというのが全体的な感想で、OpenAPI3.0系の制約がある場合は、oapi-codegen を実際に利用してみたいです。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><ul><li><a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a></li><li><a href="https://future-architect.github.io/articles/20191008/">本当に使ってよかったOpenAPI (Swagger) ツール</a></li><li><a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた</a></li><li><a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200701/top.png&quot; class=&quot;img-middle-size&quot;&gt;


&lt;h2 id=&quot;概要&quot;&gt;&lt;a href=&quot;#概要&quot; class=&quot;headerlink&quot; title=&quot;概要&quot;&gt;&lt;/a&gt;概要&lt;/h2&gt;&lt;p&gt;TIG DXチ
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="Swagger" scheme="https://future-architect.github.io/tags/Swagger/"/>
    
      <category term="OpenAPI" scheme="https://future-architect.github.io/tags/OpenAPI/"/>
    
  </entry>
  
  <entry>
    <title>go-swaggerを用いたWebアプリケーション開発Tips19選</title>
    <link href="https://future-architect.github.io/articles/20200630/"/>
    <id>https://future-architect.github.io/articles/20200630/</id>
    <published>2020-06-30T01:06:15.000Z</published>
    <updated>2020-06-30T03:21:10.237Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIG DXユニット<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>の真野です。echo → 生net/http → gorilla/mux → go-swagger, gqlgenの経歴でGoのHTTP APIを実装してきました。本記事では最近業務でヘビーユーズしているgo-swaggerについての開発Tipsをまとめました。</p><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>フューチャーではGoを採用する案件が増えて来ており、その際に<a href="https://github.com/go-swagger/go-swagger" target="_blank" rel="noopener">go-swagger</a> というツールを利用することが多いです。<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> 理由はWebAPIのスキーマを駆動に開発することに慣れているという開発文化（DBレイヤのERDやデータフローを駆動に開発することは今も多い）や、リリース後の保守や将来のマイグレーションを考慮しなるべく特定のDSLに依存したくないというポリシーを強く持つこと、開発前にある程度固く機能数を洗い出して工数見積もりや開発スケジュールに活かしたいといった大人な事情など、色々相性が良いからだと思います。</p><h1 id="Swaggerとは"><a href="#Swaggerとは" class="headerlink" title="Swaggerとは"></a>Swaggerとは</h1><p><a href="https://swagger.io/" target="_blank" rel="noopener">https://swagger.io/</a></p><blockquote><p>Swaggerは、OpenAPI仕様（以下OAS）と言われる、REST APIを定義するための標準仕様にもとづいて構築された一連のオープンソースツールです。REST APIの設計、構築、文書化、および使用に役立つ機能を提供します。</p></blockquote><p>YAML(JSON）でWebAPIの定義を記載することで、ドキュメンテーション・Client/Serverのコード生成・モックサービスの生成など多くのメリットを享受できます。またエコシステムも多数作られ、あるDSLに則ることでコードからSwaggerファイルを生成するなど、リバース系の生成手段も出てきています。</p><h1 id="Swaggerを記述する流れ"><a href="#Swaggerを記述する流れ" class="headerlink" title="Swaggerを記述する流れ"></a>Swaggerを記述する流れ</h1><p>Swagger(OpenAPI)のYAML定義は生で書くと大変なので、武田さんの<a href="https://future-architect.github.io/articles/20191008/">本当に使ってよかったOpenAPI (Swagger) ツール</a> 記事で紹介されたツールを利用してYAMLファイルを作成し、それをインプットにサーバサイドのコードを自動生成しています。中にはそれらの文明を捨て生身のYAML職人になった猛者もいます。続いて後述するgo-swaggerでサーバサイドやクライアントサイドのコードを生成・実装・テストし、その中で足りない点を設計にフィードバック（つまりYAMLを修正）し、さらにコードを再生成するといったサイクルを取ることが一般的だと思います。</p><p>実際に生成したSwaggerに対する規約は、亀井さんの<a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a>の記事を見ると、どういうところに注意すべきか分かって良いと思います。</p><h1 id="go-swaggerはWebアプリケーションフレームワーク"><a href="#go-swaggerはWebアプリケーションフレームワーク" class="headerlink" title="go-swaggerはWebアプリケーションフレームワーク"></a>go-swaggerはWebアプリケーションフレームワーク</h1><p><a href="https://github.com/go-swagger/go-swagger" target="_blank" rel="noopener">go-swagger</a>とは、Swaggerファイルを入力にGoのコードを生成することができるツールです。生成されるコードは、go-openapi で管理されているモジュールが利用されています。go-swaggerそのものの技術選定については、多賀さんの<a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた</a> 記事にも記載があります。</p><p>go-swaggerがWAF(Webアプリケーションフレームワーク）というのは直感では理解しにくいですが、go-swaggerで生成したサーバサイドのコードは、実質的にechoやginのように多くの機能を持ちます。 例えば、<strong>URLのルーティング</strong>、<strong>入力Validation</strong>、<strong>クエリパラメータ</strong>、フォーム、リクエストヘッダ、リクエストボディなどの <strong>入力modelへのバインディング</strong>、<strong>HTTPレスポンスコード別のmodelの作成</strong>や、<strong>Middlewareの設定専用の関数</strong>など多くをサポートしていますし、<strong>固有のビジネスロジックを書くルール</strong>もgo-swaggerの生成したコードによって決められています。</p><h1 id="フロントエンド側の生成は？"><a href="#フロントエンド側の生成は？" class="headerlink" title="フロントエンド側の生成は？"></a>フロントエンド側の生成は？</h1><p>TypeScriptのフロントエンド側の生成は<a href="https://openapi-generator.tech/docs/generators/" target="_blank" rel="noopener">openapi-generator</a>を当社では採用することが多いです。あくまでサーバサイドの生成にgo-swaggerを用いています。go-swaggerもクライアントコードは生成でき、こちらはあるWebAPIロジック中で、別のWebAPIを呼び出す時に利用したりもします。（下図のイメージ）</p><img src="/images/20200630/photo_20200630_01.png"><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>そんなgo-swaggerを用いてWebAPIサーバを開発し、いくつかのシステムをリリースしてきました。そこで得たTipsを紹介していきます。比較的サーバサイドの話が多いですが、一部クライアントサイドの話しもあります。（前述したあるWebAPIサーバから、別のOpenAPIで定義されているWebAPIを呼び出すことも合ったので）</p><h2 id="1-インストールバージョンをチームで固定しよう"><a href="#1-インストールバージョンをチームで固定しよう" class="headerlink" title="1. インストールバージョンをチームで固定しよう"></a>1. インストールバージョンをチームで固定しよう</h2><p><a href="https://goswagger.io/install.html" target="_blank" rel="noopener">インストール手順</a>は様々ですが、コードを自動生成する関係上、バージョンは必ず揃えた方が良いです。もしチーム内に複数バージョンが混在してしまうと、自動生成するたびに不要なコード差分が発生して履歴が汚れてしまいます。</p><p>もし、コードからビルドするのであれば、下記のように<code>@v0.23.0</code> のように固定することがオススメです。</p><figure class="highlight bash"><figcaption><span>インストール手順</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/go-swagger/go-swagger/cmd/swagger@v0.23.0</span><br></pre></td></tr></table></figure><p>特に理由がなければ最新のバージョンを利用するのが良いと思います。2020/05/19時点では<a href="https://github.com/go-swagger/go-swagger/releases" target="_blank" rel="noopener">リリースノート</a>を見る限り数ヶ月ごとにリリースされているように活発に開発が続いているので、適時バージョンも上げていきたいですね。</p><h2 id="2-swagger-genrate-server-コマンドの推奨オプション"><a href="#2-swagger-genrate-server-コマンドの推奨オプション" class="headerlink" title="2. swagger genrate server コマンドの推奨オプション"></a>2. swagger genrate server コマンドの推奨オプション</h2><p>オプションは<a href="https://goswagger.io/generate/server.html" target="_blank" rel="noopener">公式ドキュメント</a>に記載されています。次のオプションは設定したほうが良いかなと思います。</p><ul><li><code>--strict-additional-properties</code> リクエストボディなどで指定外のフィールドを指定した場合にエラーになる</li><li><code>-a</code>, <code>--api-package</code> パッケージがoperationsではなく任意のパッケージ名になる。短くしたい時にオススメ</li><li><code>-A</code>, <code>--name</code>  Swagger定義の <code>info.title</code> に大文字が入るとアンスコ繋がりにされちゃうの回避できる</li><li><code>--exclude-main</code> main.goのファイルを生成するのを除外してくれる</li><li><code>-t</code>,<code>--target</code> 出力先のパッケージを指定。3にもあるが、<code>gen</code> にすることが経験上多い</li></ul><p>まとめると、例えばルート管理（RouteManagement）のAPIであれば、以下のようなコマンドにすることが多いです。</p><figure class="highlight bash"><figcaption><span>生成コマンド例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swagger generate server -a routemanagement -A routemanagement \</span><br><span class="line">  --exclude-main --strict-additional-properties -t gen f ./swagger/swagger.yaml</span><br></pre></td></tr></table></figure><p>立ち上がり初期は、<code>-a</code>や<code>-A</code>の値を変えながらしっくり来るのを探すことがオススメです。</p><h2 id="3-パッケージ構造"><a href="#3-パッケージ構造" class="headerlink" title="3. パッケージ構造"></a>3. パッケージ構造</h2><p>先ほど、出力先ディレクトリを <code>gen</code> に指定しましたが、<a href="ttps://goswagger.io/tutorial/custom-server.html">公式ドキュメントにもgenで生成する例</a>が書いてありました。最初は <code>generated</code> にしようか迷いましたが、短いですし <code>gen</code> に合わせることをおすすめします。</p><p>genの意味が何か？というのは新規参画者が全員抱く疑問だと思うので、READMEの上の方にディレクトリ構成を書くようにしています。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── docs                  <span class="comment"># 設計ドキュメント</span></span><br><span class="line">├── swagger               <span class="comment"># Swagger管理</span></span><br><span class="line">|    └── swagger.yml      <span class="comment"># WebAPI定義</span></span><br><span class="line">├── server                <span class="comment"># WebAPI本体のコード</span></span><br><span class="line">|    ├── cmd              <span class="comment"># 実行ファイルのエンドポイント</span></span><br><span class="line">|    ├── gen              <span class="comment"># go-swaggerで自動生成コードの出力先(⚠️configure_xx.go以外は編集しない⚠️)</span></span><br><span class="line">|    └── testdata         <span class="comment"># ユニットテストデータ</span></span><br><span class="line">|</span><br><span class="line">└── migrationtool         <span class="comment"># データ移行ツール</span></span><br><span class="line">     └── ...</span><br></pre></td></tr></table></figure><p>例がモノリポで作っているイメージなので、適時書き換えて参考にしていただければです。</p><h2 id="4-起動時オプションの-hostには注意"><a href="#4-起動時オプションの-hostには注意" class="headerlink" title="4. 起動時オプションの --hostには注意"></a>4. 起動時オプションの <code>--host</code>には注意</h2><p>go-swaggerで生成した<a href="https://goswagger.io/tutorial/todo-list.html" target="_blank" rel="noopener">サーバ起動時オプション</a>がいくつか存在します。その中で必須なのは、<code>--host</code>と <code>--port</code> だと思います。<code>--host</code> を指定した場合はデフォルト<code>localhost</code>、つまり <code>127.0.0.1</code>になります。そうすると、ローカル開発では良いですが、他のサーバからアクセスできなくなります。ネットワークインターフェースを個別に指定したいケースは別ですが、基本的には <code>--host 0.0.0.0</code> を指定すると良いでしょう。</p><p>また、ポート番号は未指定だと毎回ランダムな数値を選択します。固定したほうが何かと都合が良いと思うのでアプリごとに利用するポートを決定しましょう。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./exmample-server --host 0.0.0.0 --port 3000</span><br></pre></td></tr></table></figure><p><code>--host</code>は<code>$HOST</code>、<code>--port</code>は<code>$PORT</code>という環境変数でも利用できるので、コンテナ化するときなどはこちらを利用するのも良いと思います。特に<a href="https://cloud.google.com/run/docs/reference/container-contract" target="_blank" rel="noopener">GCPのCloudRunは$PORTで待ち受けるのが必須</a>なので、この場合はGCP側にポート設定は任せましょう。</p><h2 id="5-OpenAPIのバージョンを見間違えないように注意"><a href="#5-OpenAPIのバージョンを見間違えないように注意" class="headerlink" title="5. OpenAPIのバージョンを見間違えないように注意"></a>5. OpenAPIのバージョンを見間違えないように注意</h2><p>go-swaggerが対応しているのは <code>OAS2</code> であるので注意です。最新は <code>OAS3</code> ですが、その記法は利用できないことがあります。特にググった時に出てくる公式ドキュメントが <code>OAS2</code>であることをよく確認しましょう</p><p>大事なポイントなのでちゃんとテストします。次の画像↓はOAS2かOAS3のどちらでしょうか？</p><img src="/images/20200630/photo_20200630_02.png"><p>..はい、<code>OAS2</code> と書かれているのでOKです。このドキュメントはgo-swaggerで利用できます。</p><p>では、次の画像↓はどちらでしょうか？</p><img src="/images/20200630/photo_20200630_03.png"><p>..はい、<code>OAS3</code> と書かれていますね。というわけで、このドキュメントはgo-swaggerでは利用できない可能性が高いので、参考にするのはほどほどにしましょう。</p><p>個人的には <code>OAS2</code> の仕様については下記が最もまとまっていて簡潔なのでオススメです。ググるのではなくまずこの仕様書を見ましょう。</p><p><a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md" target="_blank" rel="noopener">https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md</a></p><h2 id="6-go-swaggerで対応しているOpenAPIの規約とは"><a href="#6-go-swaggerで対応しているOpenAPIの規約とは" class="headerlink" title="6. go-swaggerで対応しているOpenAPIの規約とは"></a>6. go-swaggerで対応しているOpenAPIの規約とは</h2><p>5で説明したとおり、OpenAPIの3系と2系（Swagger）でGoogle検索しにくいのが実情だと思います。さらにその中でgo-swaggerがその記法に対応しているかどうか迷う場面が出てくると思います。</p><p>対応状況については下記に記載があります。</p><p><a href="https://github.com/go-swagger/go-swagger/blob/master/docs/use/spec/params.md" target="_blank" rel="noopener">https://github.com/go-swagger/go-swagger/blob/master/docs/use/spec/params.md</a></p><p>主要どころは網羅できているとお気づきになると思います。実際、経験上はほとんどが問題なく利用できてきました。もし、上手く動かない場合は、設定ミスや仕様の勘違い、あるいはコードの再生成をし忘れているといった可能性が高いです。</p><h2 id="7-Swaggerのモデルの必須属性を外すとGoのコードがポインタじゃなくなり便利だが落とし穴がある"><a href="#7-Swaggerのモデルの必須属性を外すとGoのコードがポインタじゃなくなり便利だが落とし穴がある" class="headerlink" title="7. Swaggerのモデルの必須属性を外すとGoのコードがポインタじゃなくなり便利だが落とし穴がある"></a>7. Swaggerのモデルの必須属性を外すとGoのコードがポインタじゃなくなり便利だが落とし穴がある</h2><p>Goの辛いところかも知れませんが、nullかどうかを判定するためにGoではしばしばstringやint64のフィールドが、必須設定されるとポインタ型になります。これを <code>swag.String()/swag.StringValue()</code> や <code>swag.Int64()/swag.Int64Value()</code> で変換するのが厄介なので、特にレスポンスに関してはチェックもしないし必須属性を外そうかという判断になりがちだと思います。</p><p>この時に厄介なのが、必須属性<strong>ではない</strong> フィールドには、JSONの <code>omitempty</code> タグが付与されることです。これによって、int64やboolの型がついているフィールドが、<code>0</code>値や<code>false</code> の場合にレスポンスのJSONフィールドから除外されてしまいます。意味は分かるけど意図はそういうことじゃないんだよなーって思う人も多いのでは無いでしょうか？これを回避するためには、 go-swaggerの拡張記法である、 <code>x-omitempty: false</code> を設定する必要があります。</p><p>..なんというか、色々歪みが大きい気がするので、必ずレスポンスに含まれる項目であれば素直に必須だという宣言に、Swagger上はしておく方が良いかも知れません。このあたりはチーム全体の判断になると思います。</p><h2 id="8-数値始まりのフィールド名にNrというプレフィックスが付与される"><a href="#8-数値始まりのフィールド名にNrというプレフィックスが付与される" class="headerlink" title="8. 数値始まりのフィールド名にNrというプレフィックスが付与される"></a>8. 数値始まりのフィールド名にNrというプレフィックスが付与される</h2><p>数値始まりのフィールド <code>0x9101</code> といったフィールドを、go-swaggerで生成すると、 <code>Nr0x9101</code> と言った具合に<code>Nr</code>といったプレフィックスが付与されます。ドキュメントには見当たりませんでしたが、コードでは<a href="https://github.com/go-swagger/go-swagger/blob/b6f0abd35e2a0d1415e1b4776e35e33808d2ce62/generator/template_repo.go#L551" target="_blank" rel="noopener">この辺</a> に実装されていました。おそらく数値を表すNumberのドイツ語読み？でしょうか。これはGoのフィールド名が数字始まりを許可しないため、仕方ない挙動だとは思いますが、<code>Nr</code>は辞めたいと思われる方も多いのではないでしょうか？</p><p>これを回避すると前には、<code>x-go-name</code> という拡張記法を用います。コレを用いると、 <code>x-go-name: d0x9101</code> といった形でカスタムな名称にできます。まぁAPIの定義と、内部で用いるフィールド名が異なると脳内変換が大変なので、この場合は状況が許すのであればAPI定義側も <code>d0x9101</code> などと変更したほうが良い判断に思われます。</p><p><code>x-go-name</code> ですが、おそらくは、<code>company_cd</code>や<code>user_id</code>といったsnake_caseでAPIを定義した場合、go-swaggerのデフォルトの挙動は <code>companyCd</code>、<code>userId</code>といった具合に、Goの慣習と合わないことへの対応に使うことが本来は多いと思います。このあたりに用いるのであれば本来の意図したオプションだと思います。</p><h2 id="9-go-swaggerの拡張記法"><a href="#9-go-swaggerの拡張記法" class="headerlink" title="9. go-swaggerの拡張記法"></a>9. go-swaggerの拡張記法</h2><p>7,8と関連しますが、<code>x-omitempty</code>や<code>x-go-name</code>以外にも、go-swagger独自の拡張パラメータが存在します。</p><p>どういったパラメータが利用できるかは、コードを見ると分かりやすいです。<br><a href="https://github.com/go-swagger/go-swagger/blob/master/generator/types.go#L45" target="_blank" rel="noopener">https://github.com/go-swagger/go-swagger/blob/master/generator/types.go#L45</a></p><p>この中でも、比較的よく使いそうなのは <code>x-go-type</code>や<code>x-order</code>でしょうか？ <code>x-go-type</code> は自分でtype aliasした型を指定することが出来ます。 <code>x-order</code>は、go-swaggerはデフォルトの挙動では、Swaggerに記載した順番にStructのフィールドを生成してくれません。それが視認性など場合によっては困ると言った場合に、順序を指定することも出来ます。あまり乱用すると、扱いにくいSwaggerファイルになりかねないので、トレードオフを考えながら指定していくと良いかなと思います。</p><h2 id="10-DateTimeを活用しよう"><a href="#10-DateTimeを活用しよう" class="headerlink" title="10. DateTimeを活用しよう"></a>10. DateTimeを活用しよう</h2><p><code>type=string</code>を指定した時に、<code>format</code>には、<code>date</code>, <code>date-time</code> などが<a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#data-types" target="_blank" rel="noopener">指定できます</a>。 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">event_time:</span><br><span class="line">  type: string</span><br><span class="line">  format: date-time</span><br></pre></td></tr></table></figure><p>こうすると、go-swaggerでは <code>github.com/go-openapi/strfmt</code> の <code>strfmt.DateTiime</code> 型でStructが生成されます。</p><figure class="highlight go"><figcaption><span>date-time指定時の生成例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ExampleParams <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP Request Object</span></span><br><span class="line">HTTPRequest *http.Request <span class="string">`json:"-"`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Required: true</span></span><br><span class="line"><span class="comment">  In: query</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EventTime strfmt.DateTime</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>date-time</code>を指定すると、<code>full-date - RFC3339</code>の形式での入力をパースすることが出来ます。コードでは<a href="https://github.com/go-openapi/strfmt/blob/master/time.go#L78" target="_blank" rel="noopener">この辺</a>です。中身を見ると、複数のフォーマットに対応してくれおり、どれかに一致すればOKという仕様です。このあたりの受け入れる日付フォーマットを一々取り決めるのは厄介ですが、標準ライブラリレベルで規定してくれるているため、楽ができます。</p><figure class="highlight go"><figcaption><span>full-dateを指定したときにパースする</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// RFC3339Millis represents a ISO8601 format to millis instead of to nanos</span></span><br><span class="line">RFC3339Millis = <span class="string">"2006-01-02T15:04:05.000Z07:00"</span></span><br><span class="line"><span class="comment">// RFC3339Micro represents a ISO8601 format to micro instead of to nano</span></span><br><span class="line">RFC3339Micro = <span class="string">"2006-01-02T15:04:05.000000Z07:00"</span></span><br><span class="line"><span class="comment">// ISO8601LocalTime represents a ISO8601 format to ISO8601 in local time (no timezone)</span></span><br><span class="line">ISO8601LocalTime = <span class="string">"2006-01-02T15:04:05"</span></span><br><span class="line"><span class="comment">// ISO8601TimeWithReducedPrecision represents a ISO8601 format with reduced precision (dropped secs)</span></span><br><span class="line">ISO8601TimeWithReducedPrecision = <span class="string">"2006-01-02T15:04Z"</span></span><br><span class="line"><span class="comment">// ISO8601TimeWithReducedPrecision represents a ISO8601 format with reduced precision and no timezone (dropped seconds + no timezone)</span></span><br><span class="line">ISO8601TimeWithReducedPrecisionLocaltime = <span class="string">"2006-01-02T15:04"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">dateTimeFormats = []<span class="keyword">string</span>&#123;RFC3339Micro, RFC3339Millis, time.RFC3339, time.RFC3339Nano, </span><br><span class="line">ISO8601LocalTime, ISO8601TimeWithReducedPrecision, ISO8601TimeWithReducedPrecisionLocaltime</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>また、レスポンスのモデル側のフィールドに<code>date-time</code>を指定したときは、デフォルトでは上記 <code>RFC3339Millis</code> のフォーマットが利用されます。もし、これを変更したい場合は、strfmtパッケージのMarshalFormatフィールドを書き換えればOKです（グローバルに書き換わります）。</p><figure class="highlight go"><figcaption><span>レスポンスの日付フォーマットを変更したい場合（ミリ秒を外したい!といった場合）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strfmt.MarshalFormat = time.RFC3339</span><br></pre></td></tr></table></figure><p><code>strfmt.DateTime</code> ですが、初見だと色々と扱いにくいと思います。なぜなら<code>swag.DateTime</code>とか<code>swag.DateTimeValue</code>とかが無いからです。理由は<a href="https://github.com/go-swagger/go-swagger/issues/734" target="_blank" rel="noopener">もともとOpenAPI側のライブラリだからです</a>。</p><p>変換の仕方をざっとまとめます。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"time"</span></span><br><span class="line"><span class="string">"github.com/go-openapi/strfmt"</span></span><br><span class="line"><span class="string">"github.com/go-openapi/strfmt/conv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// *strfmt.DateTime → strfmt.DateTime</span></span><br><span class="line">dateTimePointer := conv.DateTimeValue(p.Body.DateTime)</span><br><span class="line"></span><br><span class="line"><span class="comment">// strfmt.DateTime → *strfmt.DateTime</span></span><br><span class="line">dateTime := conv.DateTime(p.Body.DateTimePointer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// strfmt.DateTime → time.Time</span></span><br><span class="line">timeTime := time.Time(dateTime)</span><br><span class="line"></span><br><span class="line"><span class="comment">// time.Time → strfmt.DateTime</span></span><br><span class="line">dateTime := strfmt.DateTime(timeNow())</span><br><span class="line"></span><br><span class="line"><span class="comment">// string → strfmt.DateTime</span></span><br><span class="line">dateTime := strfmt.ParseDateTime(<span class="string">"2020-05-20T15:04:05Z07:00"</span>)</span><br></pre></td></tr></table></figure><p>time.Timeへの変換さえ慣れれば、自前で日付パースを行うコードを減らせ見通しが良くなると思います。ぜひ、日付周りのデータを受け付ける場合は活用下さい。</p><h2 id="11-アクセスログ"><a href="#11-アクセスログ" class="headerlink" title="11. アクセスログ"></a>11. アクセスログ</h2><p>Go系のWAF全般に言えることかも知れませんが、go-swaggerも標準ではアクセスログなどが一切出力されず、自前でMiddlewareを仕込む必要があります。</p><p>設定する場所は、 <code>restapi/configure_{project name}.go</code> にある、2つの関数のどちらかに設定します。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupMiddlewares</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupGlobalMiddleware</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setupMiddlewares</code> はプログラム上で指定したルートに対するMiddlewareで、<code>setupGlobalMiddleware</code>は<code>/swagger.json</code>のエントリーポイントにも着火するミドルウェアです。</p><p>アクセスログの実装方法は色々ですが、私は以下のようなAccessLogの関数を実装することが多いです。</p><figure class="highlight go"><figcaption><span>アクセスログ実装</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mymiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/labstack/gommon/log"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> captureResponseWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">http.ResponseWriter</span><br><span class="line">statusCode <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCaptureResponseWriter</span><span class="params">(w http.ResponseWriter)</span> *<span class="title">captureResponseWriter</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;captureResponseWriter&#123;w, http.StatusOK&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lrw *captureResponseWriter)</span> <span class="title">WriteHeader</span><span class="params">(code <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">lrw.statusCode = code</span><br><span class="line">lrw.ResponseWriter.WriteHeader(code)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AccessLog</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">start := time.Now()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> r.URL.Path != <span class="string">"/health"</span> &amp;&amp; r.URL.Path != <span class="string">"/health/"</span> &#123;</span><br><span class="line"><span class="comment">// ヘルスチェックは毎秒出力されログを汚すので出力させない</span></span><br><span class="line">log.Infof(<span class="string">"[ACCESS] START %v %v\n"</span>, r.Method, r.URL)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lrw := NewCaptureResponseWriter(w)</span><br><span class="line">next.ServeHTTP(lrw, r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> r.URL.Path != <span class="string">"/v1/health"</span> &amp;&amp; r.URL.Path != <span class="string">"/v1/health/"</span> &#123;</span><br><span class="line">elapsed := time.Since(start)</span><br><span class="line"></span><br><span class="line">code := lrw.statusCode</span><br><span class="line"><span class="keyword">if</span> code &gt;= <span class="number">500</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">"[ACCESS] END %v %v %v %v\n"</span>, r.Method, code, r.URL, elapsed)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> code &gt;= <span class="number">400</span> &#123;</span><br><span class="line">log.Warnf(<span class="string">"[ACCESS] END %v %v %v %v\n"</span>, r.Method, code, r.URL, elapsed)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Infof(<span class="string">"[ACCESS] END %v %v %v %v\n"</span>, r.Method, code, r.URL, elapsed)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これを、先ほどの<code>setupGlobalMiddleware</code>関数に設定します。</p><figure class="highlight go"><figcaption><span>ミドルウェアの設定</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupGlobalMiddleware</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> mymiddleware.AccessLog(handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これで、go-swaggerへのリクエストに対してロギングを行うことができました。開発や利用状況の調査などに役立て下さい。</p><h2 id="12-panicしたときの防御"><a href="#12-panicしたときの防御" class="headerlink" title="12. panicしたときの防御"></a>12. panicしたときの防御</h2><p>これも11に関連した話ですが、go-swaggerのロジックでpanicが発生するとレスポンスを何も返さないため不便です（どこかのレイヤーでGateway Timeoutなどが発生します）。この場合は、panicをキャプチャするmiddlewareを設定し、500エラーを返すなどをしたほうが良いでしょう。</p><p>公式ドキュメントにも<a href="https://github.com/go-swagger/go-swagger/blob/master/docs/use/middleware.md#add-logging-and-panic-handling" target="_blank" rel="noopener">実装例</a>が記載されています。<a href="https://github.com/dre1080/recover" target="_blank" rel="noopener">dre1080/recover</a>を利用しても良いと思いますし、私はもう少し自由度を高めたかったので<a href="https://medium.com/@masnun/panic-recovery-middleware-for-go-http-handlers-51147c941f9" target="_blank" rel="noopener">こちらの実装</a>を参考にして、カスタムミドルウェアをつくることもあります。</p><figure class="highlight go"><figcaption><span>panic救済用のミドルウェア実装例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mymiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/labstack/gommon/log"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Recovery</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">"panic catch: %v"</span>, err)</span><br><span class="line"></span><br><span class="line">resp, _ := json.Marshal(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"error"</span>: fmt.Sprintf(<span class="string">"Internal Server Error: %v"</span>, err),</span><br><span class="line"><span class="string">"code"</span>:  <span class="string">"000500"</span>, <span class="comment">// 予期せぬエラー</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">_, _ = w.Write(resp)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">next.ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これを11のアクセスログと合わせて設定します。</p><figure class="highlight go"><figcaption><span>ミドルウェアの設定</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupGlobalMiddleware</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> mymiddleware.Recovery(mymiddleware.AccessLog(handler))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これで、panicが発生しても仕様通りに何かしらレスポンスすることができました。</p><h2 id="13-Middleware"><a href="#13-Middleware" class="headerlink" title="13. Middleware"></a>13. Middleware</h2><p>現実には、10, 11以外にも多くのMiddlewareを実装する必要が出てくると思います。多いのは、CORS、GZIPでしょう。BodyLimitやRateLimitなどは、LANを飛び出してWebAPIを実装すると必要性が出てくると思います。どういったMiddlewareが必要になってくるかは、<a href="https://echo.labstack.com/middleware" target="_blank" rel="noopener">echoのMiddlewareページ</a>を見て、どういった観点がありそうか確認してみるのも良いかも知れません。</p><p><strong>CORS</strong>に関しては、<a href="https://github.com/go-swagger/go-swagger/blob/master/docs/faq/faq_documenting.md#how-to-use-swagger-ui-cors" target="_blank" rel="noopener">公式のFAQ</a> があります。</p><figure class="highlight go"><figcaption><span>FAQに載っている実装例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/rs/cors"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupGlobalMiddleware</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">    handleCORS := cors.Default().Handler</span><br><span class="line">    <span class="keyword">return</span> handleCORS(handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大体が、<code>cors.Default()</code> の設定で大丈夫だと思いますが、<code>Access-Control-Allow-Headers</code> のリクエストヘッダに対してはデフォルトで許可していないので、要件によっては追加でオプションを追加します。</p><figure class="highlight go"><figcaption><span>リクエストヘッダも全OKにする例（個別に指定するのがベストだとは思います）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myCORS := cors.New(cors.Options&#123;</span><br><span class="line">AllowedHeaders: []<span class="keyword">string</span>&#123;<span class="string">"*"</span>&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>GZIP</strong>は<a href="https://github.com/nytimes/gziphandler/blob/master/README.md" target="_blank" rel="noopener">こちらのライブラリ</a>を利用すると良いかと思います。こちらは最後の設定例でまとめて説明します。</p><p><strong>BodyLimit</strong>はこちらの<a href="https://stackoverflow.com/questions/52879193/how-to-determine-if-ive-reached-the-size-limit-via-gos-http.maxbytesreader" target="_blank" rel="noopener">StackOverflowの記事</a>を参考に実装しました。やりたいことは、指定されたサイズ以上のリクエストボディを許可せず、サーバ側に負荷をかけないようにしたいことです。</p><figure class="highlight go"><figcaption><span>BodyLimitの実装例（2MB制限）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MaxBodyByteSize = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span> <span class="comment">// 2MB</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BodyLimit</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">r.Body = http.MaxBytesReader(w, r.Body, MaxBodyByteSize)</span><br><span class="line">next.ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>RateLimit</strong>は<a href="https://github.com/go-swagger/go-swagger/blob/master/docs/use/middleware.md#add-logging-and-panic-handling" target="_blank" rel="noopener">さきほどの公式ドキュメント</a> にも記載があります。WAFなどを導入していれば不要かもしれないですが、負荷試験時にベンチマークツールの誤作動でDynamoDBなど回数課金なサービスで費用がかさんだ悪夢から、防御的に設定することにしています。</p><figure class="highlight go"><figcaption><span>RateLimitの設定例（秒間10回まで）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupMiddlewares</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">  limiter := tollbooth.NewLimiter(<span class="number">10</span>, time.Second)</span><br><span class="line">  limiter.IPLookups = []<span class="keyword">string</span>&#123;<span class="string">"RemoteAddr"</span>, <span class="string">"X-Forwarded-For"</span>, <span class="string">"X-Real-IP"</span>&#125;</span><br><span class="line">  <span class="keyword">return</span> tollbooth.LimitFuncHandler(handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これらを合わせると以下のようになります。</p><figure class="highlight go"><figcaption><span>各種Middlewareの実装例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupGlobalMiddleware</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="comment">// CORS</span></span><br><span class="line">myCORS := cors.New(cors.Options&#123;</span><br><span class="line">AllowedHeaders: []<span class="keyword">string</span>&#123;<span class="string">"*"</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// RateLimit</span></span><br><span class="line">limiter := tollbooth.NewLimiter(<span class="number">10</span>, time.Second)</span><br><span class="line">limiter.IPLookups = []<span class="keyword">string</span>&#123;<span class="string">"RemoteAddr"</span>, <span class="string">"X-Forwarded-For"</span>, <span class="string">"X-Real-IP"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> mymiddleware.Recovery(myCORS.Handler(mymiddleware.AccessLog(</span><br><span class="line">gziphandler.GzipHandler(tollbooth.LimitFuncHandler(</span><br><span class="line">mymiddleware.BodyLimit(handler))))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>デコレートの階層が深すぎてよくわからなくなってきましたが、浅い方から順番に動くので、アクセスログはCORSの前に出したいとかがあれば順序を動かしてみてください。</p><h2 id="14-エラーハンドリング"><a href="#14-エラーハンドリング" class="headerlink" title="14. エラーハンドリング"></a>14. エラーハンドリング</h2><p>go-swaggerの入力Validationでエラーが発生したときは、デフォルトでは <code>422 Unprocessable Entity</code> が発生します。422のままで良いよという方はこのままでも良いですが、<code>400 Bad Request</code>で統一したい場合もあるでしょう。理由は、悪さをしようとするユーザーのリクエストがあるという性悪説にたって、不正パラメーターの詳細なエラー情報は悪いクライアントに不要な情報を与えるものとなりかねないので、雑に400を返すといった考えもあると思うからです。</p><p>単純にエラー時のステータスコードを変えたいだけなら、<a href="https://github.com/go-swagger/go-swagger/issues/1820" target="_blank" rel="noopener">ここに書いてあるように</a>簡単に実施できます。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/go-openapi/errors"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureAPI</span><span class="params">(api *myapp.MyApplicationAPI)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">errors.DefaultHTTPCode = http.StatusBadRequest </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これで入力されたパラメータがSwaggerで定義したスキーマと異なる場合は、<code>400 Bad Request</code> を返すことができました。</p><p>一方で、エラー時のレスポンスボディは <code>{&quot;code&quot;:400, &quot;mesasge&quot;: &quot;xxx&quot;}</code> といった形式になります。<a href="https://github.com/go-openapi/errors/blob/master/api.go#L84" target="_blank" rel="noopener">実装はこのあたり</a>になります。もし、レスポンスボディのレイアウトを変更したいときは、自分でカスタムのerrorHandlerを設定することもできます。</p><figure class="highlight go"><figcaption><span>go-swaggerでのハンドリングのカスタマイズ</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureAPI</span><span class="params">(api *myapp.MyApplicationAPI)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">errors.DefaultHTTPCode = http.StatusBadRequest</span><br><span class="line">api.ServeError = myerrors.MyServeError <span class="comment">// 拡張部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>myerrors.MyServeErrorの実装ですが、デフォルトである <code>github.com/go-openapi/errors</code>の <code>errors.ServeError</code>の実装を参考にしながら、一部を改修するといった形になります。<a href="https://github.com/go-swagger/go-swagger/issues/1041#issuecomment-301393502" target="_blank" rel="noopener">このIssue</a>で話題になっています。例えば、<code>code</code>というフィールドを削除したいよって場合は、<code>errors.ServeError</code>の<code>errorAsJSON</code>関数を書き換えて対応します。</p><figure class="highlight go"><figcaption><span>codeフィールドを削除した実装例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errorAsJSON</span><span class="params">(err Error)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">b, _ := json.Marshal(<span class="keyword">struct</span> &#123;</span><br><span class="line">Message <span class="keyword">string</span> <span class="string">`json:"message"`</span></span><br><span class="line">&#125;&#123;err.Error()&#125;)</span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記で、色々go-swaggerのフレームワーク側が対応してしてくれているエラーハンドリングも自由自在になりました。あまりカスタマイズすると、本家バージョンアップの追随が大変なので、なるべくgo-swagger標準の形式に則ってWebAPI設計することがおすすめですが、いざという時の逃げ道として認識してもらえると幸いです。</p><h2 id="15-Defaultステータスコードの勧め"><a href="#15-Defaultステータスコードの勧め" class="headerlink" title="15. Defaultステータスコードの勧め"></a>15. Defaultステータスコードの勧め</h2><p><code>OAS2</code> のSwagger定義に、<a href="https://swagger.io/docs/specification/2-0/describing-responses/#Default" target="_blank" rel="noopener">Defaultレスポンス</a>という設定が出来ます。</p><p>下記のように、200以外は全て同じErrorモデルを利用するというのであれば定義の簡略として便利だと思います。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">responses:</span></span><br><span class="line">    <span class="attr">200:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Success</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="string">$ref:</span> <span class="string">'#/definitions/User'</span></span><br><span class="line">    <span class="comment"># Definition of all error statuses</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Unexpected</span> <span class="string">error</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="string">$ref:</span> <span class="string">'#/definitions/Error'</span></span><br></pre></td></tr></table></figure><p>これが特に効果を発揮するのは、<strong>クライアントコードを生成した時</strong>です。理由は、サーバサイドが行儀よくWebAPI定義通りのレスポンスコードを返してくれればよいのですが、実装によって予期せぬレスポンスコードを帰す場合（例えば先ほどの422の話）には、クライアントコードはそれを上手く扱えません。他にも自動生成部分ではなく開発者が個別実装する部分で、間違った自動生成コードを利用した場合にも発生します。</p><p>例えば、もしdefalutが存在しない場合は、下記のようにクライアント側でエラーをログ出力しても、<code>{resp:0xc0005325a0}</code> のようなポインタ情報しか出力されないです。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">params := user.NewGetUserParamsWithContext(ctx).WithUserID(userID)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := api.user.GetUserContract(params); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">"getUserContract: %s"</span>, err.Error()) <span class="comment">//=&gt;  getUserContract: &#123;resp:0xc0005325a0&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これは、ステータスコード別にバインドするStructを自動生成する関係上、想定外のステータスコードの場合に動かしようが無いからだともいます。<a href="https://github.com/go-swagger/go-swagger/issues/1470" target="_blank" rel="noopener">このあたりのIsseuにも似たような議論</a>がありました。これを避けるためには、横断的にエラー時のModelを共通化しておき、全てのエンドポイントごとにDefaultステータスコードを設定しておくことがオススメです。</p><h2 id="16-NewXxxの関数を利用する"><a href="#16-NewXxxの関数を利用する" class="headerlink" title="16. NewXxxの関数を利用する"></a>16. NewXxxの関数を利用する</h2><p>15でもちょっと実装が出ましたが、go-swaggerで生成したクライアントコードを利用して、サーバにリクエストする場合について注意があります。リクエストパラメータの生成には、 <code>NewXxx</code>を利用してStructを作らないと、timeout=0になって、<code>context deadline exceeded</code> エラーとなり上手く動作しません。<a href="https://github.com/go-swagger/go-swagger/issues/919#" target="_blank" rel="noopener">このあたりのIssue</a>でも話題にしています。</p><p>NewXxxの関数を用いるときは、<code>WithContext</code>付きの方を利用すると便利です。さらにチェーンスタイルでパラメータも設定できます。必須属性については <code>swag.String</code> などで *string 型への変換が必要です。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">params := user.NewPostUserParamsWithContext(ctx).</span><br><span class="line">WithHTTPClient(hc).</span><br><span class="line">WithUserID(userID).</span><br><span class="line">WithBody(&amp;models.PostUser&#123;</span><br><span class="line">Name:          swag.String(<span class="string">"未来太郎"</span>),</span><br><span class="line">MemberType:    swag.String(<span class="string">"一般会員"</span>),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="17-クライアントコードでホスト名やBASE-PATHを書き換えたい"><a href="#17-クライアントコードでホスト名やBASE-PATHを書き換えたい" class="headerlink" title="17. クライアントコードでホスト名やBASE_PATHを書き換えたい"></a>17. クライアントコードでホスト名やBASE_PATHを書き換えたい</h2><p>Swaggerに記載するホスト名と開発中のホスト名は異なるため、書き換えが必要です。また、URLの基底となるパスですが、 <code>/v1</code> などを設定することが一般的だと思います。一方で、ロードバランサやAPIゲートウェイの仕様のため、本番環境では別の基底パスを追加したいときがあると思います。そうすると、ローカルで利用したいURLと差異がでるため、差異を吸収する設定が必要です。</p><p><code>gen/{project name}_client.go</code> にあるクライアントの <code>HTTPClientWithConfig</code> を書き換えます。</p><figure class="highlight go"><figcaption><span>ホスト名やBASE_PATHの書き換え</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/nichigas/&#123;project name&#125;/gen/client"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">api = client.NewHTTPClientWithConfig(<span class="literal">nil</span>, &amp;client.TransportConfig&#123;</span><br><span class="line">Host:     os.Getenv(<span class="string">"API_HOST"</span>), </span><br><span class="line">BasePath: os.Getenv(<span class="string">"BASE_PATH"</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := api.user.GetUserContract(user.NewGetUserParamsWithContext(ctx).WithUserID(userID)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">"getUserContract: %s"</span>, err.Error()) <span class="comment">//=&gt;  getUserContract: &#123;resp:0xc0005325a0&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>もし、Swaggerの設定そのままのホスト名やBASE_PATHを利用するのであれば、Defaultクライアントを利用もできます。</p><figure class="highlight go"><figcaption><span>デフォルト設定のままの場合</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> _, err := client.Default.user.GetUserContract(user.NewGetUserParamsWithContext(ctx).WithUserID(userID)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorf(<span class="string">"getUserContract: %s"</span>, err.Error()) <span class="comment">//=&gt;  getUserContract: &#123;resp:0xc0005325a0&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>この辺りの作り込みは上手く環境変数など外部プロパティで切り替えられるようにしておきたいですね。</p><h2 id="18-単体テストの話"><a href="#18-単体テストの話" class="headerlink" title="18. 単体テストの話"></a>18. 単体テストの話</h2><p>go-swaggerのサーバサイドの単体テストは、Goの関数呼び出しと同様に実現できます。レスポンスに関しては <code>httptest.NewRecorder()</code> を利用するとヘッダ・ボディなど全て取得できます。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"net/http/httptest"</span></span><br><span class="line"><span class="string">"strconv"</span></span><br><span class="line"><span class="string">"testing"</span></span><br><span class="line"><span class="string">"github.com/Cside/jsondiff"</span></span><br><span class="line"><span class="string">"github.com/&lt;your repo&gt;/&lt;project name&gt;/server/gen/models"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetUser</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">params := installation.NewAttachParams()</span><br><span class="line">params.HTTPRequest = httptest.NewRequest(<span class="string">"GET"</span>, <span class="string">"http://example.com"</span>, <span class="literal">nil</span>)</span><br><span class="line">params.UserID= <span class="string">"0001"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 🔎🔎Test Func🔎🔎</span></span><br><span class="line">resp := GetUser(params)</span><br><span class="line"></span><br><span class="line">w := httptest.NewRecorder()</span><br><span class="line">resp.WriteResponse(w, runtime.JSONProducer())</span><br><span class="line"></span><br><span class="line">want := <span class="keyword">struct</span> &#123;</span><br><span class="line">status  <span class="keyword">int</span></span><br><span class="line">body    <span class="keyword">string</span></span><br><span class="line">&#125; &#123;</span><br><span class="line">status: <span class="number">200</span>,</span><br><span class="line">body: <span class="string">`&#123;"id":"0001", "name":"未来太郎"&#125;`</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> strconv.Itoa(w.Result().StatusCode) != want.status &#123;</span><br><span class="line">t.Errorf(<span class="string">"status want %v got %v"</span>, want.status, w.Result().StatusCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> diff := jsondiff.Diff(want.body, w.Body.Bytes()); diff != <span class="string">""</span> &#123;</span><br><span class="line">t.Errorf(<span class="string">"case %v body diff:\n%s"</span>, c.name, diff)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>レスポンスボディのチェックは、jsondiffというパッケージを利用していますが、他にも色々な方法があると思いますので、要件に合わせて書き換えて下さい。他のGoのテストの考え方と特に変わらないのは嬉しいですね。</p><h2 id="19-Lambdaで動かしたい"><a href="#19-Lambdaで動かしたい" class="headerlink" title="19. Lambdaで動かしたい"></a>19. Lambdaで動かしたい</h2><p>go-swaggerのサーバですが、<a href="https://github.com/go-swagger/go-swagger/issues/962#issuecomment-478382896" target="_blank" rel="noopener">実はAWS Lambdaでも動かせます</a>。<code>httpadapter</code> というパッケージを利用することで、API Gatewayの<code>events.APIGatewayProxyRequest</code> といったイベントを、go-swaggerのリクエストである <code>*http.Request</code> に変換してくれます。コードは下記のようなイメージです。</p><figure class="highlight go"><figcaption><span>API-Gateway+Lambdaで動かす場合</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/aws/aws-lambda-go/events"</span></span><br><span class="line"><span class="string">"github.com/aws/aws-lambda-go/lambda"</span></span><br><span class="line"><span class="string">"github.com/awslabs/aws-lambda-go-api-proxy/httpadapter"</span></span><br><span class="line"><span class="string">"github.com/go-openapi/loads"</span></span><br><span class="line"><span class="string">"github.com/&lt;your repo&gt;/&lt;project name&gt;/server/gen/restapi"</span></span><br><span class="line"><span class="string">"github.com/&lt;your repo&gt;/&lt;project name&gt;/server/gen/restapi/&lt;your app&gt;"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> httpAdapter *httpadapter.HandlerAdapter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">swaggerSpec, err := loads.Embedded(restapi.SwaggerJSON, restapi.FlatSwaggerJSON)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">api := myApp.NewMyApplicationAPI(swaggerSpec)</span><br><span class="line">server := restapi.NewServer(api)</span><br><span class="line">server.ConfigureAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment">// see https://github.com/go-swagger/go-swagger/issues/962#issuecomment-478382896</span></span><br><span class="line">httpAdapter = httpadapter.New(server.GetHandler())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler handles API requests</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handler</span><span class="params">(req events.APIGatewayProxyRequest)</span> <span class="params">(events.APIGatewayProxyResponse, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> httpAdapter.Proxy(req)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">lambda.Start(Handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>起動速度がちょっと気になる..という方もいらっしゃるかと思いますが、とあるシステムの本番環境で、ほぼほぼ上記のコードを動かしていますが、気持ち10-20msくらいかかっているかも？といったレベルです。init関数で初期化した部分を、毎回のリクエストのたびに使いまわしているからだと思います。そこまでレイテンシを求められないシステムであれば、go-swaggerもドンドンLambdaに載せちゃって良いのでは？と私は考えています。</p><p>他のServlerless相当でgo-swaggerで動かしたい場合も、このコードを参考にサーバレス関数のイベントを、<code>*http.Request</code> に変換すれば動かすことができそうです。夢が広がりますね！</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>最初は3,4つのTipsをまとめて終わりにしようかと思いましたが、書いていると非常に長くなってしまいました。go-swaggerは良いプロダクトだと思うのですが、定義情報からコードを自動生成する関係上、どこまで何ができるのかイメージがつきにくかったり、そもそもOpenAPI（Swagger）の知識も必要のため敷居が高かったりと、最初はハマる箇所が多いからかも知れません。（さらにはサーバサイドとクライアントサイドの2種類のコードも生成できるためネタが増える..）</p><p>上手く使えば、WebAPI定義と実装が完全に一致する（定義からコードを生成しているため）で強力なツールだと思いますしオススメです。すでに使っている方にも今回のTipsを活用していただければ幸いです。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><ul><li><a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a></li><li><a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた</a></li><li><a href="https://future-architect.github.io/articles/20191008/">本当に使ってよかったOpenAPI (Swagger) ツール</a><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">TIG(Technology Innovation Group)というフューチャーグループのIT技術を良い感じに推進する部署と、その中にあるDXユニットという、デジタルトランスフォーメーションに関わる仕事を主に推進していくチームのことです。</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;">もちろん、echo派や生net/http派やその他の勢力もいます</span><a href="#fnref:2" rev="footnote"> ↩</a></li></ol></div></div></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;TIG DXユニット&lt;sup id=&quot;fnref:1&quot;&gt;&lt;a href=&quot;#fn:1&quot; rel=&quot;footnote&quot;&gt;1&lt;/
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="Swagger" scheme="https://future-architect.github.io/tags/Swagger/"/>
    
      <category term="OpenAPI" scheme="https://future-architect.github.io/tags/OpenAPI/"/>
    
  </entry>
  
  <entry>
    <title>Terraform Associate合格記</title>
    <link href="https://future-architect.github.io/articles/20200629/"/>
    <id>https://future-architect.github.io/articles/20200629/</id>
    <published>2020-06-29T01:03:42.000Z</published>
    <updated>2020-06-30T01:13:25.778Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIG/DXユニットの<a href="https://twitter.com/kaedemalu" target="_blank" rel="noopener">伊藤</a>です。今回は、5/24に受験したHashiCorpから出た資格の1つである、Terraform Associateを受験したときの記事になります。結果としては無事に合格したので、受験前、そして受験当日のことを今回取り扱おうと思います。私はTerraform以外にも準備が必要だったので、この記事がこれから受験する人の一助となれば幸いです。<br><img src="/images/20200629/1.png" class="img-small-size"></p><h1 id="本人のスペック"><a href="#本人のスペック" class="headerlink" title="本人のスペック"></a>本人のスペック</h1><p>まず、はじめに受験者の私についてです。（読み飛ばしていただいて良いです）</p><ul><li>Terraform歴: 9ヶ月</li><li>他の資格: <ul><li>AWS Solution Architect Associate</li><li>Google Cloud Certified: Professional Cloud Architect</li></ul></li><li><strong>英語</strong><ul><li>そこそこ読めるけど、話す経験はほとんどない（海外経験なし）</li></ul></li></ul><p>私はフューチャーに入社して以来GCP+Terraformというコンビでインフラの作成および管理を行っていました。途中で、Google CloudのProfessional Cloud Architectを取得して、今回が2個目の資格チャレンジになります。後述しますが試験の言語が英語なので、私にとってはある意味１番のネックでした。そのため、英語の大事さを痛感した試験にもなっています。</p><h1 id="HashiCorp-Certified-Terraform-Associate-とは"><a href="#HashiCorp-Certified-Terraform-Associate-とは" class="headerlink" title="HashiCorp Certified: Terraform Associate とは"></a>HashiCorp Certified: Terraform Associate とは</h1><p>そもそもこの試験の内容についてざっくり中身を出しておきます。</p><table><thead><tr><th></th><th>内容</th></tr></thead><tbody><tr><td>言語</td><td>英語</td></tr><tr><td>受験方法</td><td>オンライン</td></tr><tr><td>試験費用</td><td>$70.50 USD</td></tr><tr><td>試験時間</td><td>１時間</td></tr><tr><td>有効期間</td><td>2年間</td></tr></tbody></table><p>受験方法は自宅からオンラインで受けられます。AWSやGCPの試験を受けたことがある方は、受験会場で画面に向かって受ける試験を自宅で行うものと考えてもらえれば良いです。試験内容は、IaCの一般的な知識から始まり、Terraformで使えるFunctionとかコマンドの挙動など概要から実践的な部分まで広く出題されます。HashiCorpから事前に<a href="https://learn.hashicorp.com/terraform/certification/terraform-associate-sample-questions" target="_blank" rel="noopener">サンプル問題</a>が提供されているので、出題形式を押さえるという意味で見ておくことをお勧めします。</p><h1 id="試験対策"><a href="#試験対策" class="headerlink" title="試験対策"></a>試験対策</h1><p>私が試験を受けるまでに行った対策と言えるものは以下になります。</p><ul><li><a href="https://learn.hashicorp.com/terraform/certification/terraform-associate-review" target="_blank" rel="noopener">Exam Review - Terraform Associate Certification</a></li><li><a href="https://www.udemy.com/course/terraform-associate-practice-exam/" target="_blank" rel="noopener">HashiCorp Certified: Terraform Associate Practice Exam</a></li></ul><p>試験ガイドはこれからTerraformの全容を知りたい人向けの<a href="https://learn.hashicorp.com/terraform/certification/terraform-associate-study-guide" target="_blank" rel="noopener">Study Guide</a>と、そこそこTerraformに親しみのある人向けのExam Reviewと2種類あります。私はそれなりに使ってきたぞと、自負していたので、Exam Reviewから入りました。ドキュメントの内容は試験項目別になっているので、自分が弱いと思ったところを重点的に読んだり、Function周りがまだ使い慣れていないものもあったので、<code>terraform console</code>などで一通り実行して色々試してみました。<br>また、Udemyの試験問題は、知識の抜け漏れがないか確かめるために買いましたが、これは結構役に立つ内容でした。1回解いて、答えを見て腹落ちするまでドキュメントなども見ながら理解を深めることをひたすら行いました。ついでに英語で読む癖をつけられたのもよかったことかなと思います。<br>また、TerraformとVaultとの関わりも深くまでは調べなくても、組み合わせ方は知っておいた方が良さそうでした。</p><h1 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h1><p>試験を受けるまでの流れをここでは説明していきます。少し面倒でした。</p><h2 id="申し込み"><a href="#申し込み" class="headerlink" title="申し込み"></a>申し込み</h2><p><a href="https://www.hashicorp.com/certification/terraform-associate/" target="_blank" rel="noopener">試験概要</a>のページから申し込みます。試験自体はQuestionmarkというところが代理で行うようです。順を追っていくことで、アカウントの登録や試験ができるようになっています。試験の購入については現段階では</p><ul><li>Terraform Associate</li><li>Vault Associate</li></ul><p>の2つが購入可能です。Terraform Associateの試験を購入して、決済まで完了すると、試験時間の設定ができます。ここで結構不安だったのが、受験時の時間です。試験の選択時間はプロフィールで設定できる居住地やタイムゾーンに依存するので、試験時間を選択する前にプロフィールを確認してJSTにしておきましょう。試験官がアメリカのため、日本だと大体21時以降や、6~10時などが受験可能時間として出てきます。私は午前10時からの枠を選択しました。</p><h2 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h2><p>パソコン自体は順当にMacやWindowsなら受験が可能で、Webカメラやマイクがきちんと使えることを事前に確認しておくとよいでしょう。ノートPCの人はデュアルディスプレイには出来ないので、ノートPC1台と本人確認に必要なパスポートを残して机のものをすべておろしておくくらいが精神衛生上でも良いかなと思います。部屋の中はそこまで見せる必要はありませんが、他の人が絶対に入らない環境が求められますので、家族などには事前に受けることを周知しておきましょう。</p><h1 id="当日"><a href="#当日" class="headerlink" title="当日"></a>当日</h1><p>当日は試験時間の15分くらい前から試験を申し込んだページで試験の準備を進められます。ここからはリスニングとスピーキングを求められるので、私は受ける前になかなか頭を使ってしまいました。順当に試験の事前準備出来ているか（パスポートでの本人確認や机のものの整理具合)かどうかを聞かれるので、言われるがまま(あまり聞き取れてはいないのですが)進めると、試験を開始できます。<br>試験時間は1時間ですが、私はほとんど見直す時間がありませんでした。とりあえず、分かる問題はどんどん答えていって、あとで分からない問題に時間を使う方針で進みました。英語読むことに対して、今までで一番集中力を使った気がします。<br>試験を終えるとすぐに結果発表があり、そのあとはアンケートに答えます。これも終えると、試験官より声かけられて一連の流れが終わりになります。</p><h1 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h1><p>無事合格しました。スコアを見ると他の合格体験記と見比べて割とギリギリだったようです。今までAWSやらGCPやら受けてきましたが、また違った緊張感でした。試験終了直後は受かったというメールのみ来て、10日くらいあけるとデジタルバッジが来ます。やはり、何かしら形になるのは嬉しいですね。<br>合格してから数日でデジタルバッジが取得できるので、より実感が湧きます。素直に嬉しかったです。<br><img src="/images/20200629/photo_20200629_01.png" class="img-middle-size" style="border:solid 1px #000000"></p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>試験が出されてから1ヶ月で受けましたが、とりあえず合格してよかったなという気持ちが大きく、ホッとしています。また、初の英語での受験でしたが、なんとか終えられて、個人的には結構自信がつきました。Terraformは私が触っていてとても好きなものの一つなので、勉強しながら好きなものの知識を深められることが嬉しかったです。とはいえ知識も経験もまだまだなので、これからも新しいことに挑戦しつつ、出来ることの裾野を広げられたらなと思います。<br>あと、英語は本当に大事であると感じたので、英語もやろうと思いました。<br>先日、<a href="/articles/20200624/">Terraformの入門記事</a>も書きましたので、これからTerraform Associateを受験しようという方は参考にしてみてください。</p><h2 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h2><ul><li><a href="/tags/Terraform/">技術ブログ Terraform一覧</a></li></ul><h2 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h2><ul><li><a href="/articles/20190530/">【合格記】GCP Professional Cloud Architect認定資格を振り返る</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは。TIG/DXユニットの&lt;a href=&quot;https://twitter.com/kaedemalu&quot; targe
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
      <category term="合格記" scheme="https://future-architect.github.io/tags/%E5%90%88%E6%A0%BC%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>MLflowで実験管理入門</title>
    <link href="https://future-architect.github.io/articles/20200626/"/>
    <id>https://future-architect.github.io/articles/20200626/</id>
    <published>2020-06-26T01:08:23.000Z</published>
    <updated>2020-06-26T02:25:36.211Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>こんにちは、Strategic AI Group(SAIG)の山野です。</p><p>今回は、<strong>機械学習の実験管理</strong>をテーマにMLflowについて紹介します。</p><h2 id="1-実験管理の必要性"><a href="#1-実験管理の必要性" class="headerlink" title="1. 実験管理の必要性"></a>1. 実験管理の必要性</h2><p>モデル開発では、様々な条件で大量の実験を時には複数人で回していくことがありますが、徐々に管理し切れなくなり、後から（必要に迫られて）<strong>もう一度その実験を再現しようと思ってもできなくて困る</strong>、ということがあります。</p><p>つまり、実験が終わって数ヶ月後に「あの実験てどういう条件で実施してどういう結果出たんだっけ？+再現できる？」と聞かれても困らない状態を作れれば良いです。PoCが終わってプロダクション化のフェーズで、PoCの実験について確認されるケースが意外とあったりします。</p><p>管理すべき情報は、前処理・学習・評価それぞれで以下があります。</p><ul><li><strong>前処理</strong><ul><li>元データ &lt;-&gt; 前処理コード &lt;-&gt; 加工済データ</li></ul></li><li><strong>学習</strong><ul><li>加工済みデータ（学習用） &lt;-&gt; 学習コード、ハイパーパラメータ &lt;-&gt; モデル</li></ul></li><li><strong>評価</strong><ul><li>加工済みデータ（評価用） &lt;-&gt; 評価コード &lt;-&gt; モデル &lt;-&gt; 評価結果（サマリ表、画像出力結果など）</li></ul></li></ul><h2 id="2-MLflowとは"><a href="#2-MLflowとは" class="headerlink" title="2. MLflowとは"></a>2. MLflowとは</h2><p><a href="https://mlflow.org/" target="_blank" rel="noopener">MLflow</a> は、<strong>実験、再現性、デプロイメント、セントラルモデルレジストリ</strong>など、MLライフサイクルを管理するためのオープンソースのプラットフォームです。MLflowは現在、4つのコンポーネントを提供しています。</p><ol><li>MLflow Tracking</li><li>MLflow Projects</li><li>MLflow Models</li><li>Model Registry</li></ol><p>今回は、実験管理を効率化してくれる1の<strong>MLflow Tracking</strong>についてと、それをどう使っているかを記載します。</p><h2 id="3-MLflowを使った理由"><a href="#3-MLflowを使った理由" class="headerlink" title="3. MLflowを使った理由"></a>3. MLflowを使った理由</h2><ul><li>実験管理をライトに始めることができる<ul><li>MLflow本体には様々な機能があるが、目的に応じてライトに始めることができます。（「5. MLflowのシンプルな使い方」参照）</li></ul></li><li>リッチなUIで実験結果を確認することができる</li><li>OSSであり、自分でサーバを立てることができる<ul><li>他のツールでは、サービスとして提供されており、サーバ管理不要だがアカウント登録やデータ送信の必要がある場合があります</li></ul></li><li>実験管理ツールとして広く使われている<ul><li>GitHubスター数6.8k（2020.6.25時点）</li></ul></li></ul><h2 id="4-MLflowのアーキテクチャ"><a href="#4-MLflowのアーキテクチャ" class="headerlink" title="4. MLflowのアーキテクチャ"></a>4. MLflowのアーキテクチャ</h2><p><a href="https://blog.hoxo-m.com/entry/mlflow_store" target="_blank" rel="noopener">MLflowのデータストアを覗いてみる</a>に分かりやすく詳しく記載されています。</p><ul><li>Run<ul><li>一回の試行（実験、学習、前処理、etc）</li></ul></li><li>Experiment<ul><li>Runを束ねるグループ</li><li>格納先は、ローカルファイル or HTTPリモートサーバ or DB</li></ul></li><li>Artifact<ul><li>Runで得られた出力や中間生成物の保管先</li><li>格納先は、ローカルファイル or S3</li></ul></li></ul><img src="/images/20200626/1.png"><img src="/images/20200626/2.png"><h2 id="5-MLflowのシンプルな使い方"><a href="#5-MLflowのシンプルな使い方" class="headerlink" title="5. MLflowのシンプルな使い方"></a>5. MLflowのシンプルな使い方</h2><p>pipでインストールしたら、あとはlogger感覚で記録したい値を設定するだけです。<br>※MLflow Tracking Serverを別途立てず、ローカルに保存・確認する場合。</p><h3 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h3><p>pipを用いてmlflowをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install mlflow</span><br></pre></td></tr></table></figure><h3 id="実装例"><a href="#実装例" class="headerlink" title="実装例"></a>実装例</h3><ul><li>start_run<ul><li>runIDを発行する</li></ul></li><li>log_param<ul><li>パラメータを記録する</li></ul></li><li>log_metric<ul><li>メトリックを記録する（ステップごとに）</li></ul></li><li>log_artifact<ul><li>生成物を記録する</li><li>UIからディレクトリ・ファイルの中身を確認できる</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line">mlflow.start_run()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log a parameter (key-value pair)</span></span><br><span class="line">mlflow.log_param(<span class="string">"param1"</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log a metric; metrics can be updated throughout the run</span></span><br><span class="line">mlflow.log_metric(<span class="string">"foo"</span>, <span class="number">2</span>, step=<span class="number">1</span>)</span><br><span class="line">mlflow.log_metric(<span class="string">"foo"</span>, <span class="number">4</span>, step=<span class="number">2</span>)</span><br><span class="line">mlflow.log_metric(<span class="string">"foo"</span>, <span class="number">6</span>, step=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log an artifact (output file)</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"output.txt"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">"Hello world!"</span>)</span><br><span class="line">mlflow.log_artifact(<span class="string">"output.txt"</span>)</span><br><span class="line"></span><br><span class="line">mlflow.end_run()</span><br></pre></td></tr></table></figure><ul><li>-&gt; UIで実験結果を確認することができる。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mlflow ui</span><br><span class="line"><span class="comment"># -&gt; http://localhost:5000</span></span><br></pre></td></tr></table></figure><img src="/images/20200626/3.png" style="border:solid 1px #000000"><img src="/images/20200626/4.png" style="border:solid 1px #000000"><h2 id="6-MLflowの実践的な使い方"><a href="#6-MLflowの実践的な使い方" class="headerlink" title="6. MLflowの実践的な使い方"></a>6. MLflowの実践的な使い方</h2><p>MLflowを実際に使うときによくやること。</p><h3 id="6-1-MLflow-Tracking-Serverを実験サーバと別で立てる"><a href="#6-1-MLflow-Tracking-Serverを実験サーバと別で立てる" class="headerlink" title="6-1. MLflow Tracking Serverを実験サーバと別で立てる"></a>6-1. MLflow Tracking Serverを実験サーバと別で立てる</h3><p>Experimentの格納方式にHTTPサーバー(MLflow Tracking Server)を指定します。</p><h4 id="設定内容（Server側）"><a href="#設定内容（Server側）" class="headerlink" title="設定内容（Server側）"></a>設定内容（Server側）</h4><p>pipを利用してインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install mlflow</span><br></pre></td></tr></table></figure><p>MLflow Tracking Server起動します。</p><ul><li>UIのデフォルトポートは5000</li><li>backend-store-uri: 連携されてきたデータの格納先</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt</span><br><span class="line">$ mkdir mlflow</span><br><span class="line">$ <span class="built_in">cd</span> mlflow</span><br><span class="line">$ mlflow server --backend-store-uri ./mlruns --host 0.0.0.0 &amp;</span><br></pre></td></tr></table></figure><h4 id="設定内容（Client側）"><a href="#設定内容（Client側）" class="headerlink" title="設定内容（Client側）"></a>設定内容（Client側）</h4><p>環境変数exportします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> MLFLOW_TRACKING_URI=http://&lt;MLflow Server IP&gt;:5000</span><br></pre></td></tr></table></figure><h3 id="6-2-アウトプットの保存先として、S3と連携する"><a href="#6-2-アウトプットの保存先として、S3と連携する" class="headerlink" title="6-2. アウトプットの保存先として、S3と連携する"></a>6-2. アウトプットの保存先として、S3と連携する</h3><h4 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h4><ul><li>Artifactの格納方式にS3を指定する</li><li>Artifactのファイルサイズが大きい場合、S3に格納するとよい</li><li>S3に格納しても、Artifacts Viewerで中身を確認することは可能</li><li>別途、Server側・Clinet側の双方でS3アクセス用のIAMを設定しておく必要あり</li></ul><h4 id="設定内容"><a href="#設定内容" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>boto3をServer側・Clinet側の双方でインストールしておきます</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install boto3</span><br></pre></td></tr></table></figure><ul><li>experimentsを作成時に格納先を指定します</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mlflow experiments create -n experiment_a -l s3://&lt;my-bucket&gt;/mlruns/experiment_a</span><br></pre></td></tr></table></figure><ul><li>-&gt; run時にexperimentsを指定する。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlflow.start_run(experiment_id=<span class="string">'1'</span>)</span><br></pre></td></tr></table></figure><h3 id="6-3-log-artifactを非同期に実行する"><a href="#6-3-log-artifactを非同期に実行する" class="headerlink" title="6-3. log_artifactを非同期に実行する"></a>6-3. log_artifactを非同期に実行する</h3><p>Artifactのファイルサイズが大きい場合、非同期で実行させます。</p><h4 id="設定内容-1"><a href="#設定内容-1" class="headerlink" title="設定内容"></a>設定内容</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mlflow_log_artifact_async</span><span class="params">(artifact, run_id)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">_log_artifact</span><span class="params">(artifact, run_id)</span>:</span></span><br><span class="line">        mlflow.start_run(run_id=run_id)</span><br><span class="line">        mlflow.log_artifact(artifact)</span><br><span class="line">        mlflow.end_run()</span><br><span class="line"></span><br><span class="line">    asyncio.ensure_future(_log_artifact(artifact, run_id))</span><br><span class="line">    <span class="keyword">return</span> artifact, run_id</span><br><span class="line"></span><br><span class="line">run_info = mlflow.start_run(experiment_id=<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"output.txt"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">"Hello world!"</span>)</span><br><span class="line"></span><br><span class="line">run_id = run_info.info.run_id</span><br><span class="line">result = mlflow_log_artifact_async(<span class="string">"output.txt"</span>, run_id)</span><br><span class="line">mlflow.end_run()</span><br></pre></td></tr></table></figure><h3 id="6-4-実験の再現に必要な項目を連携する"><a href="#6-4-実験の再現に必要な項目を連携する" class="headerlink" title="6-4. 実験の再現に必要な項目を連携する"></a>6-4. 実験の再現に必要な項目を連携する</h3><p>実験の再現に必要な項目を、実験ごとに予め定義しておきます。</p><h4 id="設定内容-2"><a href="#設定内容-2" class="headerlink" title="設定内容"></a>設定内容</h4><table><thead><tr><th>連携する項目</th><th>連携に使うメソッド</th></tr></thead><tbody><tr><td>実行時刻</td><td>run発行時に自動で連携される</td></tr><tr><td>実行ファイル名</td><td>mlflow.set_tag(‘mlflow.source.name’, filename)</td></tr><tr><td>実行ファイルcommitID</td><td>mlflow.set_tag(‘mlflow.source.git.commit’, commit_id)</td></tr><tr><td>実験の説明</td><td>mlflow.set_tag(‘mlflow.note.content’, DISCRIPTION)</td></tr><tr><td>Inputデータ</td><td>mlflow.log_param(“INPUT_DATA_PATH_S3”, INPUT_DATA_PATH_S3)</td></tr><tr><td>Outputデータ</td><td>mlflow.log_param(“OUTPUT_DATA_PATH_S3”, OUTPUT_DATA_PATH_S3)</td></tr><tr><td>パラメータ</td><td>mlflow.log_param(“IMAGE_SIZE”, IMAGE_SIZE)</td></tr><tr><td>メトリック</td><td>mlflow.log_metric(“foo”, 2, step=1)</td></tr><tr><td>実行結果HTML</td><td>mlflow.log_artifact(output_reports_file_path_local)</td></tr><tr><td>※スクリプトファイルの場合は、「実行ファイル名」「実行ファイルcommitID」は自動で連携される。</td><td></td></tr></tbody></table><h3 id="6-5-すでにExcelにて実験結果を管理している場合は、移行（インポート）する"><a href="#6-5-すでにExcelにて実験結果を管理している場合は、移行（インポート）する" class="headerlink" title="6-5. すでにExcelにて実験結果を管理している場合は、移行（インポート）する"></a>6-5. すでにExcelにて実験結果を管理している場合は、移行（インポート）する</h3><p>Excelですでにまとめている内容を、MLflowに移行（インポート）します。</p><h4 id="設定内容-3"><a href="#設定内容-3" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>元ファイル例<ul><li>二行目にタイプ（parameter/metric/tag）を追記しておく。</li></ul></li></ul><img src="/images/20200626/5.png"><p>移行スクリプト例を載せます。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"></span><br><span class="line"><span class="comment"># csv読み込み</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.read_csv(<span class="string">'./experiment_list.csv'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># csvデータをMLflowへインポート</span></span><br><span class="line"><span class="keyword">for</span> row_index, row <span class="keyword">in</span> df.iterrows():</span><br><span class="line">    <span class="comment"># 1行ずつ処理</span></span><br><span class="line">    <span class="comment"># 1行目はタイプを書いているので、スキップ</span></span><br><span class="line">    <span class="keyword">if</span> row_index &gt;= <span class="number">1</span>:</span><br><span class="line">        run_info = mlflow.start_run(experiment_id=<span class="string">'1'</span>)</span><br><span class="line">        <span class="comment"># 1行の中の1列ずつMlflowに連携</span></span><br><span class="line">        <span class="keyword">for</span> column_index <span class="keyword">in</span> range(len(row)):</span><br><span class="line">            <span class="keyword">if</span> df.iat[<span class="number">0</span>, column_index] == <span class="string">'parameter'</span>:</span><br><span class="line">                mlflow.log_param(df.columns[column_index], row[column_index])</span><br><span class="line">            <span class="keyword">elif</span> df.iat[<span class="number">0</span>, column_index] == <span class="string">'metric'</span>:</span><br><span class="line">                mlflow.log_metric(df.columns[column_index], float(row[column_index]))</span><br><span class="line">            <span class="keyword">elif</span> df.iat[<span class="number">0</span>, column_index] == <span class="string">'tag'</span>:</span><br><span class="line">                mlflow.set_tag(df.columns[column_index], row[column_index])</span><br><span class="line">        mlflow.end_run()</span><br></pre></td></tr></table></figure><h4 id="実行結果"><a href="#実行結果" class="headerlink" title="実行結果"></a>実行結果</h4><img src="/images/20200626/6.png"><h3 id="6-6-過去の特定の試行結果（run）と比較する"><a href="#6-6-過去の特定の試行結果（run）と比較する" class="headerlink" title="6-6. 過去の特定の試行結果（run）と比較する"></a>6-6. 過去の特定の試行結果（run）と比較する</h3><p>過去の特定の試行結果(ベースラインとしたい結果など)と比較します。ベースラインとしたい試行にtagを打っておきます。</p><p>設定内容です。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 今回の試行でのacc</span></span><br><span class="line">acc = <span class="number">0.15</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 過去の試行でのaccを取得</span></span><br><span class="line"><span class="comment"># 下記では、タグでnum_traialに1を指定しておいた試行から取得</span></span><br><span class="line">num_trial_target = <span class="string">'1'</span></span><br><span class="line">run_result = mlflow.search_runs(experiment_ids=<span class="number">1</span>)</span><br><span class="line">acc_target = float(run_result[run_result[<span class="string">'tags.num_traial'</span>] == num_trial_target][<span class="string">"metrics.acc"</span>])</span><br><span class="line"><span class="comment"># acc_target: 0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 過去の試行との比較</span></span><br><span class="line">rate_improve = acc  / acc_target</span><br></pre></td></tr></table></figure><h3 id="6-7-実験結果をチャットに通知する"><a href="#6-7-実験結果をチャットに通知する" class="headerlink" title="6-7. 実験結果をチャットに通知する"></a>6-7. 実験結果をチャットに通知する</h3><p>runが完了したタイミングで、実験結果をチャットに通知させます。</p><p>設定内容です。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start mlflow run</span></span><br><span class="line">run_info = mlflow.start_run(experiment_id=&lt;experiment_id&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># （省略）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get mlflow run result for notify</span></span><br><span class="line">run_result_dict = mlflow.get_run(run_info.info.run_id).to_dictionary()</span><br><span class="line">run_result_str = json.dumps(run_result_dict, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># notify chats</span></span><br><span class="line">WEBHOOK_URI = <span class="string">'&lt;WEBHOOK_URI&gt;'</span></span><br><span class="line"></span><br><span class="line">response = requests.post(</span><br><span class="line">    WEBHOOK_URI,</span><br><span class="line">    json=&#123;<span class="string">"text"</span>: run_result_str&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># end mlflow run</span></span><br><span class="line">mlflow.end_run()</span><br></pre></td></tr></table></figure><h2 id="7-他の実験管理ツール"><a href="#7-他の実験管理ツール" class="headerlink" title="7. 他の実験管理ツール"></a>7. 他の実験管理ツール</h2><ul><li><a href="https://github.com/allegroai/trains" target="_blank" rel="noopener">Trains</a><ul><li>“Auto-Magical Experiment Manager &amp; Version Control for AI”</li></ul></li><li><a href="https://www.wandb.com" target="_blank" rel="noopener">Weights and Biases</a><ul><li>“Developer tools for machine learning”</li></ul></li><li><a href="https://www.comet.ml/site/" target="_blank" rel="noopener">comet</a><ul><li>“Comet provides a self-hosted and cloud-based meta machine learning platform allowing data scientists and teams to track, compare, explain and optimize experiments and models.”</li></ul></li><li><a href="https://neptune.ai" target="_blank" rel="noopener">neptune</a><ul><li>“The most lightweight experiment management tool that fits any workflow”</li></ul></li><li><a href="https://github.com/ex4sperans/mag" target="_blank" rel="noopener">mag</a><ul><li>“mag is a very simple but useful library with primary goal to remove the need of custom experiment tracking approaches most people typically use. The focus is on reproducibility and removing boilerplate code.”</li></ul></li></ul><h2 id="8-参考"><a href="#8-参考" class="headerlink" title="8. 参考"></a>8. 参考</h2><ul><li><a href="https://mlflow.org" target="_blank" rel="noopener">MLflow</a></li><li><a href="https://docs.databricks.com/applications/mlflow/tracking.html" target="_blank" rel="noopener">Databricks Documentation-MLflow</a></li><li><a href="https://blog.hoxo-m.com/entry/mlflow_store" target="_blank" rel="noopener">MLflowのデータストアを覗いてみる</a></li><li><a href="https://towardsdatascience.com/5-tips-for-mlflow-experiment-tracking-c70ae117b03f" target="_blank" rel="noopener">5 Tips for MLflow Experiment Tracking</a></li></ul><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は、実験管理ツールとして、MLflowをご紹介させていただきました。<br>実験管理以外にも、学習基盤・パイプラインツール・CI/CDなどなども知見が貯まりつつあるので、また別の機会にご紹介できればと思います。</p><p>本記事は同じチームの真鍋さんにレビューしていただきました。真鍋さん、ありがとうございました！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;こんにちは、Strategic AI Group(SAIG)の山野です。&lt;/p&gt;
&lt;p&gt;今回は、&lt;strong&gt;機械学習の実
      
    
    </summary>
    
    
      <category term="DataScience" scheme="https://future-architect.github.io/categories/DataScience/"/>
    
    
      <category term="Python" scheme="https://future-architect.github.io/tags/Python/"/>
    
      <category term="MachineLearning" scheme="https://future-architect.github.io/tags/MachineLearning/"/>
    
      <category term="MLOps" scheme="https://future-architect.github.io/tags/MLOps/"/>
    
      <category term="MLflow" scheme="https://future-architect.github.io/tags/MLflow/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #19 Chromeの拡張機能作ってみた！</title>
    <link href="https://future-architect.github.io/articles/20200625/"/>
    <id>https://future-architect.github.io/articles/20200625/</id>
    <published>2020-06-25T01:34:33.000Z</published>
    <updated>2020-06-29T01:49:20.030Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200625/top.png" class="img-small-size"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>フューチャーに入社して約半年が経ちました。CSIGの谷田です。</p><p>現在業務では直接開発をする機会はないのですが、業務の合間を縫って日々プログラミングを勉強中です。そんな中、お世話になっている先輩から手始めに、Google Chromeの拡張機能の作成方法を教えて頂いたので、拡張機能の作成方法入門を書いていこうと思います。</p><p>作成方法自体はとっても簡単なので、ぜひ皆様もやってみてください！</p><h1 id="拡張機能とは"><a href="#拡張機能とは" class="headerlink" title="拡張機能とは"></a>拡張機能とは</h1><p>Webページの閲覧や情報の検索に使用するブラウザに、自身で選んだ機能を追加することで、日常業務や作業を効率化して、便利にしてくれるものです。</p><p>皆さんもお気に入りのものを追加して日々の業務で使用されているのではないでしょうか？拡張機能はChrome以外のブラウザ（IE、Firefox等）でも存在し、アドオンとかextensionという言い方もしますよね。</p><p>この拡張機能、Google Storeから好きなものを追加できますが、自分で作成することもできるのです。</p><ul><li>What are extensions?: <a href="https://developer.chrome.com/extensions" target="_blank" rel="noopener">https://developer.chrome.com/extensions</a></li><li>拡張機能とは何か？: <a href="https://developer.mozilla.org/ja/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions" target="_blank" rel="noopener">https://developer.mozilla.org/ja/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions</a></li></ul><h1 id="用意する物"><a href="#用意する物" class="headerlink" title="用意する物"></a>用意する物</h1><p>以下のファイルは、manifest.jsonファイルへのパスの記載が楽なので同一フォルダに入れます（今回は/desktop/Myextension）。manifest.jsonとは、拡張機能の仕様を書くファイルのことです。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">desktop</span><br><span class="line">   └ Myextension</span><br><span class="line">       ├ manifest.json      <span class="comment"># 拡張機能の仕様を記載するファイル</span></span><br><span class="line">       ├ calendar.png       <span class="comment"># アイコン</span></span><br><span class="line">       ├ calendar.html      <span class="comment"># 表示したい画面、今回はカレンダー</span></span><br><span class="line">       ├ calendar.css       <span class="comment"># 表示したい画面、今回はカレンダー</span></span><br><span class="line">       └ calendar.js        <span class="comment"># 表示したい画面、今回はカレンダー</span></span><br></pre></td></tr></table></figure><p>表示させるカレンダーは至って普通のもの。こちらのサイトを参考に作成しました。</p><ul><li><a href="https://qiita.com/kan_dai/items/b1850750b883f83b9bee" target="_blank" rel="noopener">JavaScriptでカレンダーを自作したら勉強になった</a></li></ul><p>縦の軸と横の軸を考えて、毎月曜日や日にちが変わる状況で、土日祝日も反映させるにはどうすればいいか..？など頭を使いますが、for文とif文の練習になりますよ！</p><p>JavaScriptの基本から勉強するには、MDNのこちらのサイトがおすすめです。</p><ul><li><a href="https://developer.mozilla.org/ja/docs/Learn/JavaScript/Building_blocks/conditionals" target="_blank" rel="noopener">https://developer.mozilla.org/ja/docs/Learn/JavaScript/Building_blocks/conditionals</a></li></ul><p>以上！！</p><h2 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a>manifest.json</h2><p>さて、ここで肝となるのがmanifest.jsonファイルですが、さっそくこちらの中身を見ていきましょう。</p><figure class="highlight json"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"calendar"</span>,</span><br><span class="line">  <span class="attr">"description"</span> : <span class="string">"calendar"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">  <span class="attr">"manifest_version"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"browser_action"</span>: &#123;</span><br><span class="line">    <span class="attr">"default_icon"</span>: &#123;</span><br><span class="line">      <span class="attr">"16"</span>: <span class="string">"calendar.png"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"default_popup"</span>: <span class="string">"calendar.html"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下、今回記載した項目と簡単な説明です。</p><h3 id="name（必須）"><a href="#name（必須）" class="headerlink" title="name（必須）"></a>name（必須）</h3><p>拡張機能の名前を書きます。<br>ブラウザに追加した際に、拡張機能の管理画面にも名前として表示されます。</p><h3 id="discription（推奨）"><a href="#discription（推奨）" class="headerlink" title="discription（推奨）"></a>discription（推奨）</h3><p>必要に応じて拡張機能の説明を記載します。<br>なくても動作しますが、あったほうが分かりやすいです。</p><h3 id="version（必須）"><a href="#version（必須）" class="headerlink" title="version（必須）"></a>version（必須）</h3><p>拡張機能自体のバージョンを記載します。<br>最初なので1.0を記載しておきます。</p><h3 id="manifest-version（必須）"><a href="#manifest-version（必須）" class="headerlink" title="manifest_version（必須）"></a>manifest_version（必須）</h3><p>拡張機能で使用される manifest.json のバージョンを指定します。<br>現在のバージョンは2なので2を記載します。</p><h3 id="browser-action"><a href="#browser-action" class="headerlink" title="browser_action"></a>browser_action</h3><p>ツールバーに拡張機能を追加します。</p><h4 id="default-icon（推奨）"><a href="#default-icon（推奨）" class="headerlink" title="- default_icon（推奨）"></a>- default_icon（推奨）</h4><p>拡張機能を有効化した際に、ブラウザのツールバーに表示するアイコンを指定できます。16は、16px×16pxの大きさという意味です。</p><h4 id="default-popup"><a href="#default-popup" class="headerlink" title="- default_popup"></a>- default_popup</h4><p>アイコンをクリックすると、指定したファイルがポップアップとして表示されます。</p><h3 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h3><p>今回は、記載するのは上記だけです。</p><p>その他の項目の意味や詳細は、manifest.jsonの公式リファレンスも参考にしてみてください。</p><ul><li><a href="https://developer.chrome.com/extensions/manifest" target="_blank" rel="noopener">https://developer.chrome.com/extensions/manifest</a></li></ul><p>MDNにも詳しく載っています。</p><ul><li><a href="https://developer.mozilla.org/ja/docs/Mozilla/Add-ons/WebExtensions/manifest.json" target="_blank" rel="noopener">https://developer.mozilla.org/ja/docs/Mozilla/Add-ons/WebExtensions/manifest.json</a></li></ul><h2 id="Chrome拡張機能に追加"><a href="#Chrome拡張機能に追加" class="headerlink" title="Chrome拡張機能に追加"></a>Chrome拡張機能に追加</h2><p>ここまでできたら、実際に自分のChromeの拡張機能に追加していきます。<br>「右上のその他のアイコンを右クリック→その他のツール→拡張機能」を選択もしくは、URLバーに「chrome://extensions」と入力して拡張機能の管理画面を表示したら、右上のデベロッパーモードをオンにして、</p><img src="/images/20200625/photo_20200625_01.png" style="border:solid 1px #000000"><p>左上に出現する「パッケージ化されていない拡張機能を読み込む」を選択します。<br>ここで、作成した拡張機能が入っているフォルダ（今回は/desktop/Myextension）を選択すると追加できます。</p><p>ツールバーに”default_icon”で指定したカレンダーアイコンが表示され、クリックするとポップアップとしてカレンダーが表示されます。</p><p>注意点としては、拡張機能を編集したらその都度読み込みし直すことです。</p><img src="/images/20200625/photo_20200625_02.png" class="img-middle-size" style="border:solid 1px #000000"><p>ちなみに、以下のkuma.html、kuma.pngを同一フォルダに配置し、”default_popup”をkuma.htmlに変更すると、こうなります。</p><figure class="highlight html"><figcaption><span>kuma.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"kuma.png"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/images/20200625/kuma.png" class="img-middle-size" style="border:solid 1px #000000"><h2 id="jQueryを用いた拡張"><a href="#jQueryを用いた拡張" class="headerlink" title="jQueryを用いた拡張"></a>jQueryを用いた拡張</h2><p>次に、jQueryを使用して、指定した画面にカレンダーをが表示されるようにしてみました。<br><a href="https://jquery.com/" target="_blank" rel="noopener">https://jquery.com/</a><br>からjQueryをインストールし、同一フォルダにjquery.jsとして保存して、manifest.jsonを以下の様に記載します。</p><figure class="highlight json"><figcaption><span>manifest.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"calendar"</span>,</span><br><span class="line">  <span class="attr">"description"</span> : <span class="string">"calendar"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">  <span class="attr">"manifest_version"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"browser_action"</span>: &#123;</span><br><span class="line">    <span class="attr">"default_icon"</span>: &#123;</span><br><span class="line">      <span class="attr">"16"</span>: <span class="string">"calendar.png"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"content_scripts"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"matches"</span>:[</span><br><span class="line">        <span class="string">"https://www.google.com/"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"css"</span>:[<span class="string">"calendar.css"</span>],</span><br><span class="line">      <span class="attr">"js"</span>:[<span class="string">"jquery.js"</span>,<span class="string">"calendar.js"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="content-scripts"><a href="#content-scripts" class="headerlink" title="content_scripts"></a>content_scripts</h3><p>配列で記載し、特定のウェブページのコンテキストで実行される拡張機能の一部を指定します。</p><h4 id="matches"><a href="#matches" class="headerlink" title="- matches"></a>- matches</h4><p>動作対象のURLを記載します。<br>今回は<a href="https://www.google.com/" target="_blank" rel="noopener">https://www.google.com/</a><br>を開いたときに画面にカレンダーを表示する仕様です。<br>カレンダーを表示したいサイトのURLを記載します。</p><h4 id="css"><a href="#css" class="headerlink" title="- css"></a>- css</h4><p>動作させるcssファイルを記載します。</p><h4 id="js"><a href="#js" class="headerlink" title="- js"></a>- js</h4><p>動作させるjsファイルを記載します。ここにjquery.jsも記載します。</p><p><code>www.google.com</code> には、searchformというidのdivがあります。<br>calendar.jsに以下を追記し、<a href="https://www.google.com/" target="_blank" rel="noopener">https://www.google.com/</a> を開いたときに、<code>www.google.com</code>のsearchformというidを持ったdivにcalendarというidを持ったdivが追加され、calendar.jsに記載されているカレンダーが表示されるようにします。</p><p>jQueryのappendメソッドは、要素を追加できるメソッドで、HTMLを直接指定することができます。</p><figure class="highlight js"><figcaption><span>calendar.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#searchform'</span>).append(<span class="string">`&lt;div id="calendar"&gt;&lt;/div&gt;`</span>)</span><br></pre></td></tr></table></figure><p>フォルダの中身は以下となります。上記により、calendar.htmlは不要となります。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Myextension</span><br><span class="line">  ├ manifest.json <span class="comment"># 拡張機能の仕様を記載するファイル</span></span><br><span class="line">  ├ calendar.png  <span class="comment"># アイコン</span></span><br><span class="line">  ├ calendar.css  <span class="comment"># 表示したい画面、今回はカレンダー</span></span><br><span class="line">  ├ calendar.js   <span class="comment"># 表示したい画面、今回はカレンダー</span></span><br><span class="line">  └ jquery.js     <span class="comment"># wwww.google.comにdivを追加するために使用</span></span><br></pre></td></tr></table></figure><p>拡張機能を読み込み直し、”matches”で指定した<a href="https://www.google.com/" target="_blank" rel="noopener">https://www.google.com/</a> を開くと、カレンダーを表示することができました。<br><img src="/images/20200625/photo_20200625_03.png" class="img-middle-size" style="border:solid 1px #000000"></p><p>今回は以上です。いかがでしたでしょうか？</p><p>この基本を元に、他の動きも組み合わせて現在使用しているアプリのAPIと連携したりすると、便利な拡張機能が作成できるかもしれませんね！</p><p>何か便利な機能を思いついたときに、ぜひ”無いものは作って”みてください！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200625/top.png&quot; class=&quot;img-small-size&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;フ
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="JSON" scheme="https://future-architect.github.io/tags/JSON/"/>
    
      <category term="ChromeExtension" scheme="https://future-architect.github.io/tags/ChromeExtension/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #18 Terraform 101</title>
    <link href="https://future-architect.github.io/articles/20200624/"/>
    <id>https://future-architect.github.io/articles/20200624/</id>
    <published>2020-06-24T02:44:35.000Z</published>
    <updated>2020-06-29T01:49:18.332Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200624/photo_20200624_01.png" class="img-middle-size"><p>こんにちは。TIG/DXユニットの伊藤です。本記事は<a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>の第18弾になります。</p><p>今回はタイトルの通り、Terraformの入門記事です。Infrastructure as Code(IaC)のツールとしてはAWSからはCloudFormation、GCPからはDeployment Managerが出ています。Terraformは単一ツールで複数クラウドのリソースをコードで管理することができる、ということが大きなメリットであることは世に出ている他の記事でも言われています。</p><p>本記事では以前私がこの入門記事連載で上げた「<a href="https://future-architect.github.io/articles/20200602/">春の入門祭り 🌸 #02 Google Cloud Platform 101</a>」の内容を扱います。なので、今回はGCP+Terraformの組み合わせでリソースを実際にコード化するところが基本編、Terraform Cloudの導入をを応用編として書いていきます。長くなるかもですが、お付き合いください。</p><h1 id="Terraformについて"><a href="#Terraformについて" class="headerlink" title="Terraformについて"></a>Terraformについて</h1><p>はじめはTerraformの簡単な説明をしていきます。Terraformは、HashiCorp社が開発したInfrastructure as Code(IaC)のためのツールになります。<br>コード化していく中で以下の働きを理解しながら進めるとどんな風にTerraformが動いているかわかると思います。</p><ul><li>resource<ul><li>人が実際にリソースを作成する際に書くコード。作成後もコードを差分を適用することができる。</li></ul></li><li>tfstate<ul><li>実在するリソースの「あるべき状態」を定義しているファイル。コードの変更を適用するとtfstateもコードに即した状態になる。</li></ul></li><li>provider<ul><li>各クラウドのAPIをTerraformが実行するために必要なプラグイン。コードで定義して作成する時に必要。</li></ul></li></ul><h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><p>Terraformを実行できる準備をしましょう。今回の記事の作成に当たっての実行環境は以下です。</p><ul><li>MacBook 16inch(2019)</li><li>OS: Catalina</li><li>Terraform version: 0.12.24</li><li>Editor: VS Code</li></ul><p>Terraformのインストールは、Macの方であれば、Homebrew経由でできます。なので、以下のコマンドで簡単に手に入ります。便利。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> brew install terraform</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> terraform version <span class="comment"># Terraformのバージョン確認</span></span></span><br></pre></td></tr></table></figure><p>次にサービスアカウントと、キーを発行します。サービスアカウントキーは昨今<a href="https://note.com/munmun1234/n/n7515fef76041" target="_blank" rel="noopener">こんな記事</a>も出ていますので、気をつけましょう。<br>サービスアカウントの作成は、GCPのコンソール画面のハンバーガーメニューより、[IAMと管理]&gt;[サービスアカウント]からできます。何回か入力と次に進むを繰り返しますが、以下のように入力してください。</p><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>サービスアカウント名</td><td>terraform</td></tr><tr><td>ロール</td><td>編集者(editor)</td></tr><tr><td>サービスアカウント管理ロール</td><td>自分の登録メールアドレス</td></tr></tbody></table><p>作成できたらこのサービスアカウントの詳細に行き、[鍵の追加]を行ってください。jsonかP12かを選択できますが、今回はjsonを選択します。自動でダウンロードされるので、今回はこのキー名を<code>credentials.json</code>と名前を変更して今回使用するTerraformのディレクトリに配置しておきましょう。<br>コード側でも一つ準備しておきます。<code>provider</code>と呼ばれる各クラウドのAPIをTerraformが叩くためのバイナリを指定します。以下のコードをTerraformを実行するディレクトリに準備してください。</p><figure class="highlight sh"><figcaption><span>provider.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">provider <span class="string">"google"</span> &#123;</span><br><span class="line">  project = <span class="string">"xxxxxxxxxx"</span> <span class="comment"># リソースを作成したいプロジェクトID</span></span><br><span class="line">  credentials = file(<span class="string">"credentials.json"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>コードとサービスアカウントキーが準備できたら、以下のコマンドで、Terraformの準備をします。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> terraform init</span></span><br><span class="line"></span><br><span class="line">Initializing the backend...</span><br><span class="line"></span><br><span class="line">Initializing provider plugins...</span><br><span class="line">- Checking for available provider plugins...</span><br><span class="line">- Downloading plugin for provider "google" (hashicorp/google) 3.26.0...</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">If you ever set or change modules or backend configuration for Terraform,</span><br><span class="line">rerun this command to reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you to do so if necessary.</span><br></pre></td></tr></table></figure><p>この<code>init</code>コマンドを実行することで<code>.terraform</code>ディレクトリが生成されています。このディレクトリ内に、定義されている<code>provider</code>やあとで出てくる<code>backend</code>など、Terraformのリソースではなく設定に関わる部分を初期化してくれます。なので、複数人でGit管理している時にも通常は<code>.terraform</code>ディレクトリは管理に入れないようにしましょう。<br>さて、これでリソースを作成する準備ができたので、いよいよTerraformを書いていきましょう！！</p><h1 id="基本編"><a href="#基本編" class="headerlink" title="基本編"></a>基本編</h1><p>入門記事からの再掲になりますが、以下の構成を基本編で行っていきます。手で組んでみてからの方が実際にTerraformが便利ということに気がつけるかもしれません。<br><img src="/images/20200624/photo_20200624_02.png"><br>まずは大枠のVPCやサブネットを作成してからGCEやNATなどを立てていきましょう。</p><h2 id="ネットワーク構築"><a href="#ネットワーク構築" class="headerlink" title="ネットワーク構築"></a>ネットワーク構築</h2><p>はじめにネットワークを構築しましょう。ここでは<a href="https://www.terraform.io/docs/providers/google/r/compute_network.html" target="_blank" rel="noopener">VPC</a>と<a href="https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html" target="_blank" rel="noopener">サブネット</a>を構築します。Terraformはコード化する時にはドキュメント必須なので、是非公式のドキュメントも読んでみてください。ネットワークについては、以下のコードにしました。<code>auto_create_subnetworks = false</code>としているのは不必要なサブネット作成を抑えるためです。</p><figure class="highlight sh"><figcaption><span>compute_network.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_network"</span> <span class="string">"sample_network"</span> &#123;</span><br><span class="line">  name = <span class="string">"sample-network"</span></span><br><span class="line">  auto_create_subnetworks = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これでVPC部分のコードを適用してみましょう。ここでは以下のコマンドを使ってみましょう。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> terraform fmt <span class="comment"># コードの整形をしてくれる</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> terraform validate <span class="comment"># コードのシンタックスや必要なリソースの確認</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> terraform plan <span class="comment"># コードのドライランを行う</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> terraform apply <span class="comment"># コードを適用してリソースを作成する</span></span></span><br></pre></td></tr></table></figure><p>これらコマンドを是非使ってみてください。上で示した<code>network.tf</code>はコードの形が崩れていますが、<code>fmt</code>コマンドで整形されることがわかるかと思います。<code>apply</code>コマンドを実行すると以下が出力され、<code>yes</code>の入力を求められます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">  #</span><span class="bash"> google_compute_network.sample_network will be created</span></span><br><span class="line">  + resource "google_compute_network" "sample_network" &#123;</span><br><span class="line">      + auto_create_subnetworks         = false</span><br><span class="line">      + delete_default_routes_on_create = false</span><br><span class="line">      + gateway_ipv4                    = (known after apply)</span><br><span class="line">      + id                              = (known after apply)</span><br><span class="line">      + ipv4_range                      = (known after apply)</span><br><span class="line">      + name                            = "sample-network"</span><br><span class="line">      + project                         = (known after apply)</span><br><span class="line">      + routing_mode                    = (known after apply)</span><br><span class="line">      + self_link                       = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure><p>もしかしたらApplyが「APIを有効化していないのでできない」と出る方もいるかと思いますが、その時はGUIで該当のAPIを有効化してください。<a href="https://cloud.google.com/endpoints/docs/frameworks/enable-api" target="_blank" rel="noopener">APIの有効化はこちら</a>を参照してくださいApplyが完了したらGUIで確認してみてください。ここではネットワークだけできていると思います。<br>次にサブネットを作成しましょう。</p><figure class="highlight sh"><figcaption><span>compute_subnetwork.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_subnetwork"</span> <span class="string">"pub_subnetwork"</span> &#123;</span><br><span class="line">  name          = <span class="string">"sample-subnet-pub"</span></span><br><span class="line">  ip_cidr_range = <span class="string">"192.168.1.0/24"</span></span><br><span class="line">  region        = <span class="string">"asia-northeast1"</span></span><br><span class="line">  network       = <span class="string">"sample-network"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_subnetwork"</span> <span class="string">"prv_subnetwork"</span> &#123;</span><br><span class="line">  <span class="comment"># 実際に書いてみましょう</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここでは<code>sample-network</code>に作ることを指定して書いています。オプションとして他にも様々書けるので、必要に応じて追記することができます。また、今回はサブネットを2つ作成しますが、1つは作成ぜひ実際に書いてみてください。答えは<a href="https://github.com/kaedemalu/terraform_101_handon/blob/master/compute_subnetwork.tf" target="_blank" rel="noopener">こちら</a>にあります。コードの準備が終わったらApplyコマンドを叩いてリソースを作成してください。</p><h2 id="ファイアウォールの作成"><a href="#ファイアウォールの作成" class="headerlink" title="ファイアウォールの作成"></a>ファイアウォールの作成</h2><p>次にインスタンスを不正なアクセスから保護するためのファイアウォールを作成します。インスタンスなどの作成よりもこういったルール周りの方がTerraformが役立つ場面でもあります。GCPの入門記事では2つ作成したので、今回も2つ作成できるようにします。コードは以下になります。</p><figure class="highlight sh"><figcaption><span>compute_firewall.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_firewall"</span> <span class="string">"bastion"</span> &#123;</span><br><span class="line">  name    = <span class="string">"bastion"</span></span><br><span class="line">  network = <span class="string">"sample-network"</span></span><br><span class="line"></span><br><span class="line">  allow &#123;</span><br><span class="line">    protocol = <span class="string">"tcp"</span></span><br><span class="line">    ports    = [<span class="string">"22"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  source_ranges = [<span class="string">"0.0.0.0/0"</span>]</span><br><span class="line">  target_tags = [<span class="string">"bastion"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_firewall"</span> <span class="string">"from_bastion"</span> &#123;</span><br><span class="line">  name    = <span class="string">"from-bastion"</span></span><br><span class="line">  network = <span class="string">"sample-network"</span></span><br><span class="line"></span><br><span class="line">  allow &#123;</span><br><span class="line">    protocol = <span class="string">"tcp"</span></span><br><span class="line">    ports    = [<span class="string">"22"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  source_tags = [<span class="string">"bastion"</span>]</span><br><span class="line">  target_tags = [<span class="string">"from-bastion"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_firewall"</span> <span class="string">"sample_network_allow_http"</span> &#123;</span><br><span class="line">  name    = <span class="string">"sample-network-allow-http"</span></span><br><span class="line">  network = <span class="string">"sample-network"</span></span><br><span class="line"></span><br><span class="line">  allow &#123;</span><br><span class="line">    protocol = <span class="string">"tcp"</span></span><br><span class="line">    ports    = [<span class="string">"80"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  source_ranges = [<span class="string">"0.0.0.0/0"</span>]</span><br><span class="line">  target_tags = [<span class="string">"http-server"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sshできるようにするファイアウォールルールは上の2つ、下の<code>sample-network-allow-http</code>は、GUIであれば自動生成されますが、Terraformだとできないので、今回はコード化してApplyします。</p><h2 id="インスタンスの作成"><a href="#インスタンスの作成" class="headerlink" title="インスタンスの作成"></a>インスタンスの作成</h2><p>はじめに踏み台インスタンスから作成していきます。踏み台は、外部IPがついている必要があるので、以下の形で書きます。</p><figure class="highlight sh"><figcaption><span>compute_instance.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_instance"</span> <span class="string">"bastion"</span> &#123;</span><br><span class="line">  name         = <span class="string">"bastion"</span></span><br><span class="line">  machine_type = <span class="string">"n1-standard-1"</span></span><br><span class="line">  zone         = <span class="string">"asia-northeast1-a"</span></span><br><span class="line">  tags = [<span class="string">"bastion"</span>]</span><br><span class="line"></span><br><span class="line">  boot_disk &#123;</span><br><span class="line">    initialize_params &#123;</span><br><span class="line">      image = <span class="string">"debian-cloud/debian-10"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  network_interface &#123;</span><br><span class="line">    subnetwork = <span class="string">"sample-subnet-pub"</span></span><br><span class="line"></span><br><span class="line">    access_config &#123;</span><br><span class="line">      nat_ip = google_compute_address.bastion_external.address</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  service_account &#123;</span><br><span class="line">    scopes = [<span class="string">"cloud-platform"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_address"</span> <span class="string">"bastion_external"</span> &#123;</span><br><span class="line">  name         = <span class="string">"bastion-external"</span></span><br><span class="line">  address_type = <span class="string">"EXTERNAL"</span></span><br><span class="line">  region       = <span class="string">"asia-northeast1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上のコードでは、インスタンス作成を行う<code>google_compute_instance</code>と、外部IPコードで決めて設定している<code>google_compute_address</code>を記載しています。webインスタンスについては実際に書いてみましょう。外部IPは必要ないので、<code>google_compute_instance</code>だけあれば作成することができます。答えの例は<a href="https://github.com/kaedemalu/terraform_101_handon/blob/master/compute_instance.tf" target="_blank" rel="noopener">こちら</a>になります。</p><h3 id="リソースに依存関係をつける"><a href="#リソースに依存関係をつける" class="headerlink" title="リソースに依存関係をつける"></a>リソースに依存関係をつける</h3><p>今回、GCEの作成にあたり、<code>access_config</code>ブロックの中に<code>nat_ip = google_compute_address.bastion_external.address</code>という書き方をしました。この書き方には主に2つ目的があり、</p><ul><li>他で作成したリソース値を利用する書き方<ul><li>今回は該当するリソースのアドレスを引用する書き方になっている</li></ul></li><li>リソースの依存関係をつけてくれる<ul><li>今回は<code>google_compute_address.bastion_external</code>が作成されないとインスタンスが作成されない</li></ul></li></ul><p>そのため、これまで出てきたリソースだと、VPC→サブネットorファイアウォールの作成順序が好ましいので、サブネットを例にすると、</p><figure class="highlight sh"><figcaption><span>compute_subnetwork.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_subnetwork"</span> <span class="string">"pub_subnetwork"</span> &#123;</span><br><span class="line">  name          = <span class="string">"sample-subnet-pub"</span></span><br><span class="line">  ip_cidr_range = <span class="string">"192.168.1.0/24"</span></span><br><span class="line">  region        = <span class="string">"asia-northeast1"</span></span><br><span class="line">  network       = google_compute_network.sample_network.id <span class="comment"># ここを書き換え</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_subnetwork"</span> <span class="string">"prv_subnetwork"</span> &#123;</span><br><span class="line">  <span class="comment"># 実際に書いてみましょう</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>と書くことができます。他にも修正できる部分があるので直してみましょう。<br>webインスタンスについては実際に書いてみましょう。外部IPは必要ないので、<code>google_compute_instance</code>だけあれば作成することができます。答えの例は<a href="https://github.com/kaedemalu/terraform_101_handon/blob/master/compute_instance.tf" target="_blank" rel="noopener">こちら</a>になります。</p><h2 id="ロードバランサの作成"><a href="#ロードバランサの作成" class="headerlink" title="ロードバランサの作成"></a>ロードバランサの作成</h2><p>ユーザーからのリクエストを受けるロードバランサを作成しましょう。GUIでも設定が細かいロードバランサですが、Terraformにしておくとコードで設定が見えるので、あとで見返すのにもおすすめな部分です。</p><figure class="highlight sh"><figcaption><span>http_lb.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_global_address"</span> <span class="string">"web_lb"</span> &#123;</span><br><span class="line">  name = <span class="string">"web-lb"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_health_check"</span> <span class="string">"web_health"</span> &#123;</span><br><span class="line">  name = <span class="string">"web-health"</span></span><br><span class="line">  timeout_sec        = 1</span><br><span class="line">  check_interval_sec = 1</span><br><span class="line">  tcp_health_check &#123;</span><br><span class="line">    port = <span class="string">"80"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_backend_service"</span> <span class="string">"web_backend"</span> &#123;</span><br><span class="line">  name        = <span class="string">"web-backend"</span></span><br><span class="line">  port_name   = <span class="string">"http"</span></span><br><span class="line">  protocol    = <span class="string">"HTTP"</span></span><br><span class="line">  timeout_sec = 3000</span><br><span class="line"></span><br><span class="line">  backend &#123;</span><br><span class="line">    group = google_compute_instance_group.web_instance_group.self_link</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  health_checks = [google_compute_health_check.web_health.self_link]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_url_map"</span> <span class="string">"web_lb"</span> &#123;</span><br><span class="line">  name        = <span class="string">"web-lb"</span></span><br><span class="line">  default_service = google_compute_backend_service.web_backend.self_link</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_target_http_proxy"</span> <span class="string">"http_proxy"</span> &#123;</span><br><span class="line">  name             = <span class="string">"http-proxy"</span></span><br><span class="line">  url_map          = google_compute_url_map.web_lb.self_link</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_global_forwarding_rule"</span> <span class="string">"forwarding_rule"</span> &#123;</span><br><span class="line">  name       = <span class="string">"forwarding-rule"</span></span><br><span class="line">  target     = google_compute_target_http_proxy.http_proxy.self_link</span><br><span class="line">  port_range = <span class="string">"80"</span></span><br><span class="line">  ip_address = google_compute_global_address.web_lb.address</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"google_compute_instance_group"</span> <span class="string">"web_instance_group"</span> &#123;</span><br><span class="line">  name        = <span class="string">"web-instance-group"</span></span><br><span class="line"></span><br><span class="line">  instances = [google_compute_instance.web_instance.self_link]</span><br><span class="line"></span><br><span class="line">  zone = <span class="string">"asia-northeast3-a"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ロードバランサを1つ作るために様々なリソースを作成しなければいけませんが、上のコードではLBを作る部分、最後にはインスタンスグループを作るリソースを書いています。</p><h2 id="Cloud-NAT-Routerの作成"><a href="#Cloud-NAT-Routerの作成" class="headerlink" title="Cloud NAT, Routerの作成"></a>Cloud NAT, Routerの作成</h2><p>WebサーバーのパッケージをアップデートさせるためにはNATから外に出られるようにする必要があります。ここではCloud NATとCloud Routerを作成します。またまた、コードは以下です。</p><figure class="highlight sh"><figcaption><span>compute_router.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_router"</span> <span class="string">"seoul_router"</span> &#123;</span><br><span class="line">  name    = <span class="string">"seoul-router"</span></span><br><span class="line">  region  = <span class="string">"asia-northeast3"</span></span><br><span class="line">  network = google_compute_network.sample_network.id</span><br><span class="line"></span><br><span class="line">  bgp &#123;</span><br><span class="line">    asn = 64514</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>compute_router_nat.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"google_compute_router_nat"</span> <span class="string">"seoul_nat"</span> &#123;</span><br><span class="line">  name                               = <span class="string">"seoul-nat"</span></span><br><span class="line">  router                             = google_compute_router.seoul_router.name</span><br><span class="line">  region                             = google_compute_router.seoul_router.region</span><br><span class="line">  nat_ip_allocate_option             = <span class="string">"AUTO_ONLY"</span></span><br><span class="line">  source_subnetwork_ip_ranges_to_nat = <span class="string">"ALL_SUBNETWORKS_ALL_IP_RANGES"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここまで設定できたら、<a href="https://future-architect.github.io/articles/20200602/">春の入門祭り 🌸 #02 Google Cloud Platform 101</a>の「6.ミドルウェアの設定」を行って、nginxの画面がブラウザから見ることができれば基本編の完了です！</p><h1 id="応用編"><a href="#応用編" class="headerlink" title="応用編"></a>応用編</h1><p>応用編としてTeraform Cloudの導入を行ってみましょう。Terraform Cloudが導入できると、TerraformのCI/CDができるようになるので、グッと開発スピードが上がります！</p><h2 id="Terraform-Cloudについて"><a href="#Terraform-Cloudについて" class="headerlink" title="Terraform Cloudについて"></a>Terraform Cloudについて</h2><p>Terraform CloudはHashiCorp社が提供するTerraformのCI/CD基盤になります。プランは様々あり、有料版にあげることでPolicy as Code(PaC)を実現できる<a href="https://www.terraform.io/docs/cloud/sentinel/index.html" target="_blank" rel="noopener">Sentinel</a>を導入できたりと、インフラのデプロイ速度をあげる以外にも、Terraformの実行環境の統一や実行ログ、インフラの状態など秩序を守るためにも非常に大きなメリットをもたらします。</p><h2 id="変数の設定"><a href="#変数の設定" class="headerlink" title="変数の設定"></a>変数の設定</h2><p>Terraform Cloudに本格的に移行する前に、変数の切り出しを行いましょう。特に今回は、サービスアカウントキーなどケアが必要な部分を<code>secret.tfvars</code>に切り出します。</p><figure class="highlight sh"><figcaption><span>variable.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">variable <span class="string">"PROJECT_ID"</span> &#123;&#125;</span><br><span class="line">variable <span class="string">"PROJECT_NAME"</span> &#123;&#125;</span><br><span class="line">variable <span class="string">"GOOGLE_CREDENTIALS"</span> &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>secret.tfvars</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PROJECT_ID         = <span class="string">"xxxxxxxx"</span> <span class="comment"># プロジェクトIDを入れる</span></span><br><span class="line">PROJECT_NAME       = <span class="string">"xxxxxxxx"</span> <span class="comment"># プロジェクト名を入れる</span></span><br><span class="line">GOOGLE_CREDENTIALS = <span class="string">"credentials.json"</span></span><br></pre></td></tr></table></figure><p>切り出した上を元にさらに<code>provider.tf</code>も書き換えましょう。</p><figure class="highlight sh"><figcaption><span>provider.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">provider <span class="string">"google"</span> &#123;</span><br><span class="line">  project     = var.PROJECT_ID</span><br><span class="line">  credentials = var.GOOGLE_CREDENTIALS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Terraform-Cloudの設定"><a href="#Terraform-Cloudの設定" class="headerlink" title="Terraform Cloudの設定"></a>Terraform Cloudの設定</h2><p>Terraform Cloudへの登録自体は<a href="">こちら</a>から行うことができるので、手順に沿って登録しましょう。</p><h3 id="Workspaceの作成"><a href="#Workspaceの作成" class="headerlink" title="Workspaceの作成"></a>Workspaceの作成</h3><p>登録が完了したら、Terraform Cloudにリポジトリの登録を行いましょう。サインアップ終わったあとはきっとこんな感じでできたてホヤホヤだと思います。</p><img src="/images/20200624/tf_cloud1.png" style="border:solid 1px #000000"><p>右にある[New workspace]から新しいWorkspaceを作成しましょう。<br>はじめにGitリポジトリを指定します。今回はGithubを使用するのでGithubを選択して次に進みます。<br><img src="/images/20200624/tf_cloud2.png" style="border:solid 1px #000000"></p><p>[Choose a repository]の項目では今回使うリポジトリを選択します。選択が終わると[Configure settings]に進むので、Workspaceの名前を変えられます。ここではとくに問題がないので、そのまま(リポジトリの名前のまま)で進みます。</p><h3 id="変数の設定-1"><a href="#変数の設定-1" class="headerlink" title="変数の設定"></a>変数の設定</h3><p>Workspaceの作成が完了すると、そのまま変数の設定に進むことができます。なので[Configure variables]に進みましょう。設定するのは「Terraform Variables」の方になります。今回は以下のように<code>PROJECT_ID</code>、<code>PROJECT_NAME</code>、<code>GOOGLE_CREDENTIALS</code>の3つを設定しました。<code>GOOGLE_CREDENTIALS</code>については鍵なので、sensitiveにチェックを入れると見えなくなります。</p><img src="/images/20200624/photo_20200624_03.png" style="border:solid 1px #000000"><p>これで一通りの設定ができたので実際にQueueを走らせてみましょう。</p><h2 id="Queueの実行"><a href="#Queueの実行" class="headerlink" title="Queueの実行"></a>Queueの実行</h2><p>画面の右上に[Queue plan]の項目があるので実行してみましょう。入力項目が現れますが、特に何も入れずに実行できます。実行してみると以下の様にPlanの結果が返ってきます。<br><img src="/images/20200624/tf_cloud3.png" style="border:solid 1px #000000"></p><p><code>11 to add</code>になっていますが、これはローカルのStateファイルをみていないために起こります。この後で、Stateの移行を行います。</p><h2 id="Tokenを取得する"><a href="#Tokenを取得する" class="headerlink" title="Tokenを取得する"></a>Tokenを取得する</h2><p>Terraform Cloud上のStateを見れるように前の作業として、ローカルから認証できる必要があります。そのために必要なTokenを取得するために以下の2パターンで取得します.</p><h3 id="コマンドを使う"><a href="#コマンドを使う" class="headerlink" title="コマンドを使う"></a>コマンドを使う</h3><p>コマンドを使ってTokenを取得できます。しかし、バージョンが<strong>v0.12.21</strong>以降でしか使えないので、これより前のバージョンを使用している方はGUIを使ったパターンで取得してください。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> terraform login</span></span><br><span class="line">Terraform will request an API token for app.terraform.io using your browser.</span><br><span class="line"></span><br><span class="line">If login is successful, Terraform will store the token in plain text in</span><br><span class="line">the following file for use by subsequent commands:</span><br><span class="line">    /Users/itota/.terraform.d/credentials.tfrc.json</span><br><span class="line"></span><br><span class="line">Do you want to proceed? (y/n) y # ここでyを入力する</span><br><span class="line">Terraform must now open a web browser to the tokens page for app.terraform.io.</span><br><span class="line"></span><br><span class="line">If a browser does not open this automatically, open the following URL to proceed:</span><br><span class="line">    https://app.terraform.io/app/settings/tokens?source=terraform-login</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Generate a token using your browser, and copy-paste it into this prompt.</span><br><span class="line"></span><br><span class="line">Terraform will store the token in plain text in the following file</span><br><span class="line">for use by subsequent commands:</span><br><span class="line">    /Users/itota/.terraform.d/credentials.tfrc.json</span><br><span class="line"></span><br><span class="line">Token for app.terraform.io: # ブラウザで表示されるTokenを入力する</span><br><span class="line"></span><br><span class="line">Retrieved token for user xxxxxxxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Success! Terraform has obtained and saved an API token.</span><br><span class="line"></span><br><span class="line">The new API token will be used for any future Terraform command that must make</span><br><span class="line">authenticated requests to app.terraform.io.</span><br></pre></td></tr></table></figure><p>このように出力されるので、2箇所入力が済めばこちらのコマンドは完了となるので次に進みましょう。</p><h3 id="GUIから取得する"><a href="#GUIから取得する" class="headerlink" title="GUIから取得する"></a>GUIから取得する</h3><p>こちらではGUIからTokenwo取得する方法を説明します。以下の画像について順を追って説明します。<br><img src="/images/20200624/photo_20200624_04.png" style="border:solid 1px #000000"></p><ul><li>① [Ortanization Setting]に遷移する</li><li>② [API Token]をクリック</li><li>③ [Create an authentication token]をクリックする<ul><li>Token名を入力するとTokenが払い出される。</li></ul></li></ul><p>あとは以下のファイルを作成すればTokenの取得作業は完了です。</p><figure class="highlight sh"><figcaption><span>~/.terraformrc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">credentials <span class="string">"app.terraform.io"</span> &#123;</span><br><span class="line">  token = <span class="string">"xxxxxxxxxxxxx"</span> <span class="comment"># Tokenを入力</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="backendの設定を有効化する"><a href="#backendの設定を有効化する" class="headerlink" title="backendの設定を有効化する"></a>backendの設定を有効化する</h2><p><code>backend.tf</code>を以下に書き換えて、stateを見に行く場所をGCSからTerraform Cloudに変えます。</p><figure class="highlight sh"><figcaption><span>backend.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  backend <span class="string">"remote"</span> &#123;</span><br><span class="line">    hostname = <span class="string">"app.terraform.io"</span></span><br><span class="line">    organization = <span class="string">"kaedemalu"</span> <span class="comment"># 現在のOrganizantion Name</span></span><br><span class="line"> </span><br><span class="line">    workspaces &#123;</span><br><span class="line">      name = <span class="string">"terraform_101"</span> <span class="comment"># 使っているWorkspaceの名前</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これで再び<code>terraform init</code>コマンドを実行しましょう。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> terraform init</span></span><br><span class="line">Initializing the backend...</span><br><span class="line">Acquiring state lock. This may take a few moments...</span><br><span class="line">Do you want to copy existing state to the new backend?</span><br><span class="line">  Pre-existing state was found while migrating the previous "local" backend to the</span><br><span class="line">  newly configured "remote" backend. No existing state was found in the newly</span><br><span class="line">  configured "remote" backend. Do you want to copy this state to the new "remote"</span><br><span class="line">  backend? Enter "yes" to copy and "no" to start with an empty state.</span><br><span class="line"></span><br><span class="line">  Enter a value: yes # ここでyesと入力する</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Successfully configured the backend "remote"! Terraform will automatically</span><br><span class="line">use this backend unless the backend configuration changes.</span><br><span class="line"></span><br><span class="line">Initializing provider plugins...</span><br><span class="line"></span><br><span class="line">The following providers do not have any version constraints in configuration,</span><br><span class="line">so the latest version was installed.</span><br><span class="line"></span><br><span class="line">To prevent automatic upgrades to new major versions that may contain breaking</span><br><span class="line">changes, it is recommended to add version = "..." constraints to the</span><br><span class="line">corresponding provider blocks in configuration, with the constraint strings</span><br><span class="line">suggested below.</span><br><span class="line"></span><br><span class="line">* provider.google: version = "~&gt; 3.26"</span><br><span class="line"></span><br><span class="line">Terraform has been successfully initialized!</span><br><span class="line"></span><br><span class="line">You may now begin working with Terraform. Try running "terraform plan" to see</span><br><span class="line">any changes that are required for your infrastructure. All Terraform commands</span><br><span class="line">should now work.</span><br><span class="line"></span><br><span class="line">If you ever set or change modules or backend configuration for Terraform,</span><br><span class="line">rerun this command to reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you to do so if necessary.</span><br></pre></td></tr></table></figure><p>これでローカルからTerraform Cloudにstateがコピーされたので、Queue Runの情報を確認してみましょう。Planの自動実行結果は以下になります。<br><img src="/images/20200624/tf_cloud4.png"  style="border:solid 1px #000000"></p><p>ローカルで全てApplyが済んでいるので差分がない状態になります！ちなみにこの状態になってからローカルでapplyコマンドを実行すると、</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> terraform apply</span></span><br><span class="line"></span><br><span class="line">Error: Apply not allowed for workspaces with a VCS connection</span><br><span class="line"></span><br><span class="line">A workspace that is connected to a VCS requires the VCS-driven workflow to</span><br><span class="line">ensure that the VCS remains the single source of truth.</span><br></pre></td></tr></table></figure><p>と返されて実行できなくなっています。これでTerraform CloudからのみコードのApplyができるようになっているので、実行環境の統制ができるようになります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回はTerraform 101ということでTerraformをつかってリソース構築を行いました。今回は取り扱いませんでしたが、コードの管理を環境ごと変えずに利用できるWorkspaceやTemplateとして使えるModuleなどもあります（参考記事は<a href="https://future-architect.github.io/articles/20190903/">こちら</a>。また、今回扱ったTerraformのバージョンは0.12ですが、<a href="https://future-architect.github.io/articles/20190816/">環境構築編</a>や<a href="https://future-architect.github.io/articles/20190819/">実践編</a>もありますのでそちらもぜひ読んでみてください。<br>Terraformを使うことで俗にいう手順書を無くして、インフラをコードで管理することで冪等性を保つことができます。うっかり手順を飛ばして、どこでミスを起こしたか調べることにもかなりの労力と時間を使うと思うので、是非Terraformを日々の(インフラの)お供に取り入れてみてはいかがでしょうか？</p><p>今回使用しているコードは以下のGithubに上がっているので、ぜひ参照してください。<br><a href="https://github.com/kaedemalu/terraform_101_handon" target="_blank" rel="noopener">https://github.com/kaedemalu/terraform_101_handon</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200624/photo_20200624_01.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;p&gt;こんにちは。TIG/DXユニットの伊藤です。本記事は&lt;a href=&quot;https://future-architect.g
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Ansible" scheme="https://future-architect.github.io/tags/Ansible/"/>
    
      <category term="GCP" scheme="https://future-architect.github.io/tags/GCP/"/>
    
      <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #17 Elasticsearch入門</title>
    <link href="https://future-architect.github.io/articles/20200623/"/>
    <id>https://future-architect.github.io/articles/20200623/</id>
    <published>2020-06-23T01:14:50.000Z</published>
    <updated>2020-06-29T01:49:16.378Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200623/top.png"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIGメディアユニットの町田です。2020年4月にフューチャーに転職してきました。<br>当社を選んだきっかけの一つとしてこのTechブログの存在があったので、このように投稿できることをうれしく思います！</p><p>本日の<a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>🌸 #17は、全文検索エンジンとして高い人気を誇る「Elasticsearch」についての入門記事です。</p><img src="/images/20200623/photo_20200623_01.png" class="img-middle-size"><p>Elasticsearchとは何か、どういうメリットがあるのかということから、ローカル環境へのインストールと簡単な活用事例を見ていきたいと思います。</p><p>※本記事の環境はWindows 10 Pro 64ビットとなります。</p><h2 id="Elasticsearchとは何か"><a href="#Elasticsearchとは何か" class="headerlink" title="Elasticsearchとは何か"></a>Elasticsearchとは何か</h2><p>Elasticsearchは「全文検索システム」を提供するソフトウェアです。</p><p>全文検索とは検索手法の一つで、文字列をキーにして複数の文書データをまたがって検索し、目的のデータを探し出す機能のことを指します。ECサイトやコンテンツマネジメントシステムなどで利用されているいわゆる検索エンジンと呼ばれるものは、裏の仕組みとして全文検索システムが動いているものが多いようです。元々はShay Banon氏（現Elastic社CEO）が妻の料理レシピの情報を検索するためのアプリケーションとして開発されたのがElasticsearchの起源だそうです。</p><p>それが今では世界中で利用される検索エンジンとなっている訳ですから、ソフトウェア開発の可能性は無限大ですね！</p><h2 id="どうやって入手するか"><a href="#どうやって入手するか" class="headerlink" title="どうやって入手するか"></a>どうやって入手するか</h2><p>ElasticsearchはElastic社からオープンソースで公開されており、誰でもインストールして無料で利用することが可能です。</p><p>また、Amazon Web Service(AWS)上においても「Amazon Elasticsearch Service」としてマネージドサービス(※)として提供されています。<br>※インフラ設定やバージョン管理などは不要になりますが、利用データ量などによって料金がかかります。</p><p>本記事ではオープンソースのソフトウェアをローカルPCにインストールしていきます。</p><h2 id="Elasticsearchのどういうところが便利か"><a href="#Elasticsearchのどういうところが便利か" class="headerlink" title="Elasticsearchのどういうところが便利か"></a>Elasticsearchのどういうところが便利か</h2><p>Elasticsearchのメリットとして、以下が挙げられます。</p><ul><li>索引型検索を採用しているため、大量データに対して高速検索が可能</li><li>標準で分散配置型の構成をとり、高速化と高可用性を実現</li><li>JSONフォーマットで非定型データを投入可能</li><li>REST APIによるシンプルなアクセスが可能</li><li>関連ツールを利用して分析・可視化</li></ul><p>当社の実績においても、大量の顧客データ検索し数秒で結果を返す要件のプロダクトにて実際に採用されています。</p><p>前置きが長くなりましたが、実際にインストールをして試していきましょう！</p><h1 id="Elasticsearchのインストール"><a href="#Elasticsearchのインストール" class="headerlink" title="Elasticsearchのインストール"></a>Elasticsearchのインストール</h1><p><a href="https://www.elastic.co/jp/downloads/elasticsearch" target="_blank" rel="noopener">公式ページ</a>からzipファイルをダウンロードします。（執筆時のバージョンは7.7.1です）<br><img src="/images/20200623/photo_20200623_02.jpeg"></p><p>ダウンロードしたzipを解凍すると以下のような構成になっています。<br><img src="/images/20200623/photo_20200623_03.jpeg" class="img-middle-size"></p><p>ここで <code>bin/elasticsearch.bat</code> を実行するとコマンドプロンプトが立ち上がり、Elasticsearchが起動状態になります。</p><p>動作確認として、別のコマンドプロンプトを立ち上げ <code>curl http://localhost:9200/</code> と叩いてみましょう。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl http://localhost:9200/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"XXXXXXXX"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"XXXXXXXXXXXXXXXXXXXXXX"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.7.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"zip"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"xxxxxxxxxxxxxxxxxxxxxxx"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2020-05-28T16:30:01.040088Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.5.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記のようにレスポンスがあれば準備OKです。簡単ですね！！</p><p>停止する場合は、起動時に現れたコマンドプロンプトで <code>Ctrl+c</code> で停止してください。</p><p>ちなみに、ポートはデフォルトで <code>9200</code> となっています。<br>もし変更したい場合は <code>config/elasticsearch.yml</code> の <code>#http.port: 9200</code> のコメントアウトを外して別のポートを指定することも可能です。（再度起動すると反映されます。）</p><h2 id="日本語解析への対応"><a href="#日本語解析への対応" class="headerlink" title="日本語解析への対応"></a>日本語解析への対応</h2><p>標準ではElasticsearchは日本語の形態素解析（後述します）に対応しておりませんが、オープンソースの<strong>kuromoji</strong>というソフトウェアを対応させることで、日本語の解析が可能となります。<br><code>bin/elasticsearch-pulgin.bat</code> から追加インストールすることができます。コマンドプロンプトで以下のコマンドを実行しましょう。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [zip解凍したフォルダ\bin] にて実行</span></span><br><span class="line">&gt; elasticsearch-plugin.bat install analysis-kuromoji</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果</span></span><br><span class="line">-&gt; Installing analysis-kuromoji</span><br><span class="line">-&gt; Downloading analysis-kuromoji from elastic</span><br><span class="line">[=================================================] 100%??</span><br><span class="line">-&gt; Installed analysis-kuromoji</span><br></pre></td></tr></table></figure><p>インストール後はElasticsearchを再起動します。</p><p>また、ご利用の環境によってはコマンドプロンプトの文字コードによって日本語表示が文字化けることがあります。<br><code>chcp 65001</code>と実行すると文字コードがUTF-8になります。</p><h2 id="Elasticsearchの用語について"><a href="#Elasticsearchの用語について" class="headerlink" title="Elasticsearchの用語について"></a>Elasticsearchの用語について</h2><p>ここでElasticsearchで知っておくべき用語と概念を示しておきます。<br>Elasticsearchは様々なデータを格納するにあたり、MySQLなどのRDBMSで言うところのデータベースやテーブルに相当する概念が存在します。<br>RDBに慣れている方も多いかと思いますので、比較する形で示したいと思います。<br>※厳密に言うと異なる概念ですが、イメージしやすいかと思います。</p><table><thead><tr><th align="left">Elasticsearch用語</th><th align="left">説明</th><th align="left">RDBMSで言うところの…</th></tr></thead><tbody><tr><td align="left">インデックス</td><td align="left">ドキュメントを格納する場所</td><td align="left">データベース</td></tr><tr><td align="left">ドキュメントタイプ・マッピング</td><td align="left">ドキュメントの構成やフィールド型などの定義</td><td align="left">テーブル</td></tr><tr><td align="left">ドキュメント</td><td align="left">格納される１つの文章の単位</td><td align="left">レコード</td></tr><tr><td align="left">フィールド</td><td align="left">ドキュメント内のKeyとValueの組み合わせ</td><td align="left">カラム</td></tr></tbody></table><p>これらを踏まえ、実際にElasticsearchを動かしていってみましょう！</p><h1 id="インデックスとドキュメントの登録"><a href="#インデックスとドキュメントの登録" class="headerlink" title="インデックスとドキュメントの登録"></a>インデックスとドキュメントの登録</h1><p>ここからは実際にElasticsearchにドキュメントを登録したり検索したりしてみます。</p><p>Elasticsearchは、REST APIによるHTTPリクエストでシンプルに操作できるというメリットがありますので、<br>curlコマンドを使ってバシバシ叩いてみましょう。</p><p>まずはインデックスとドキュメントを作成してみます。<br>ドキュメントは、JSON形式で登録することとなります。<br>事前準備として、登録するドキュメントの内容を<code>my_document_1.json</code>というファイルに作成しておきます。</p><figure class="highlight json"><figcaption><span>my_document_1.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user_name"</span>: <span class="string">"Future 太郎"</span>,</span><br><span class="line">    <span class="attr">"date"</span>: <span class="string">"2020-06-23T10:09:01"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"春の入門祭り　Elasticsearch入門"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>登録のHTTPリクエストは以下の形式で行います。</p><blockquote><ul><li>メソッド： POST</li><li>URL： <a href="http://localhost:9200/my_index/my_type/?pretty" target="_blank" rel="noopener">http://localhost:9200/my_index/my_type/?pretty</a><ul><li>localhost:9200/<strong>{インデックス名を指定}</strong>/<strong>{ドキュメントタイプ名を指定}</strong>/<br>⇒インデックスとドキュメントタイプが存在しない場合は、自動的に作成される</li><li>?prettyを付与するとJSONが整形された形で返却される</li></ul></li><li>ヘッダ： “Content-Type”:”application/json”</li><li>ボディ： my_document_1.json</li></ul></blockquote><p>それでは、実際にコマンドを叩いてみます。</p><figure class="highlight sh"><figcaption><span>インデックスとドキュメントを作成</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl -X POST <span class="string">"http://localhost:9200/my_index/my_type/?pretty"</span> -H <span class="string">"Content-Type"</span>:<span class="string">"application/json"</span> -d @my_document_1.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"my_index"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"my_type"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"D4DCxnIB33lDYAWdACgJ"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 1,</span><br><span class="line">  <span class="string">"result"</span> : <span class="string">"created"</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 2,</span><br><span class="line">    <span class="string">"successful"</span> : 1,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"_seq_no"</span> : 0,</span><br><span class="line">  <span class="string">"_primary_term"</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>インデックス、ドキュメントタイプの作成、ドキュメントの登録がこれだけで完了しました！</p><p>登録された内容を確認してみましょう。<br>ドキュメントを指定して参照するには、<code>～/{インデックス名}/{ドキュメントタイプ名}/{ドキュメントid}</code>と指定してリクエストします。<br>ドキュメントidとは、先ほどのレスポンスの <strong>“_id”</strong> です</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl -X GET <span class="string">"http://localhost:9200/my_index/my_type/D4DCxnIB33lDYAWdACgJ?pretty"</span> -H <span class="string">"Content-Type"</span>:<span class="string">"application/json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span> : <span class="string">"my_index"</span>,</span><br><span class="line">  <span class="string">"_type"</span> : <span class="string">"my_type"</span>,</span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"D4DCxnIB33lDYAWdACgJ"</span>,</span><br><span class="line">  <span class="string">"_version"</span> : 1,</span><br><span class="line">  <span class="string">"_seq_no"</span> : 0,</span><br><span class="line">  <span class="string">"_primary_term"</span> : 1,</span><br><span class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"_source"</span> : &#123;</span><br><span class="line">    <span class="string">"user_name"</span> : <span class="string">"Future 太郎"</span>,</span><br><span class="line">    <span class="string">"date"</span> : <span class="string">"2020-06-23T10:09:01"</span>,</span><br><span class="line">    <span class="string">"message"</span> : <span class="string">"春の入門祭り　Elasticsearch入門"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>しっかり登録されていますね！</p><h1 id="ドキュメントの検索"><a href="#ドキュメントの検索" class="headerlink" title="ドキュメントの検索"></a>ドキュメントの検索</h1><p>続いて、Elasticsearchのコア機能となる検索機能を試してみましょう。</p><p>検索する条件もJSONに記載します。messageが<strong>「春祭り」</strong>という条件で検索をかけてみましょう。<br>まずは以下のファイルを作成してください。</p><figure class="highlight json"><figcaption><span>my_query_1.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"春祭り"</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>検索は<code>～/{インデックス名}/{ドキュメントタイプ名}/_search</code>という形式でリクエストします。<br>検索条件として、先ほどの<code>my_query_1.json</code> を指定します。</p><figure class="highlight sh"><figcaption><span>「春祭り」で検索</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl -X GET <span class="string">"http://localhost:9200/my_index/my_type/_search?pretty"</span> -H <span class="string">"Content-Type"</span>:<span class="string">"application/json"</span> -d @my_query_1.json</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : &#123;</span><br><span class="line">      <span class="attr">"value"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span> : <span class="string">"eq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">3.8015757</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"my_index"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"my_type"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"D4DCxnIB33lDYAWdACgJ"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">3.8015757</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"user_name"</span> : <span class="string">"Future 太郎"</span>,</span><br><span class="line">          <span class="attr">"date"</span> : <span class="string">"2020-06-23T10:09:01"</span>,</span><br><span class="line">          <span class="attr">"message"</span> : <span class="string">"春の入門祭り　Elasticsearch入門"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>いろいろな要素が返却されていますが、着目したいのは<strong>「春祭り」</strong>という条件で検索したにも関わらず、<strong>「春の入門祭り」</strong>を含むドキュメントが結果として取得できた点です。</p><p>これはElasticsearchが備えるAnalyzerという機能によって、格納している文章を単語単位で分割して保持しているため、このような検索が実現されます。<br>特に日本語を単語単位で分割することを形態素解析と呼びます。<br>※日本語を形態素解析するためには、先ほど追加インストールしたkuromojiが必要です。</p><p>ここで、先ほど登録していたmessageの内容である「春の入門祭り　Elasticsearch入門」という日本語がどのように形態素解析されるのか確かめてみましょう。</p><p>リクエストのため以下のファイルを作成します。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;kuromoji&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;春の入門祭り　Elasticsearch入門&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>そして以下の通りリクエストしてみます。</p><figure class="highlight sh"><figcaption><span>「春の入門祭り　Elasticsearch入門」の解析結果を調べる</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl -X POST <span class="string">"http://localhost:9200/my_index/_analyze?pretty"</span> -H <span class="string">"Content-Type"</span>:<span class="string">"application/json"</span> -d @my_analyze_1.json</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"春"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"word"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"入門"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"word"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"祭り"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">6</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"word"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">20</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"word"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">4</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"入門"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">20</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">22</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"word"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>このように「春の入門祭り　Elasticsearch入門」という文章は、<strong>「春」</strong> <strong>「入門」</strong> <strong>「祭り」</strong> <strong>「Elasticsearch」</strong> <strong>「入門」</strong>という形で解析され分割されることがわかります。</p><p>形態素解析された単語たちは、自身のドキュメントidと紐づく形の構成で保持されており、ドキュメントへのインデックスとなります。このような構成を特に「転置インデックス」と呼びます。</p><p>検索時には、クエリ文字列に対しても形態素解析を行いその結果（今回は<strong>「春」</strong> <strong>「祭り」</strong>）を条件に検索をかけ、Hitしたドキュメントが返却されるという仕組みです。（索引型検索）</p><p>Elasticsearchではこの索引型検索方式を採用することで、大量データの中からでも高速に対象のドキュメントを探し出すことが可能となっています。</p><p>もう少し検索についてみていきます。<br>先ほどと同じ手順で新たにドキュメントを追加してください。</p><figure class="highlight json"><figcaption><span>my_document_2.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user_name"</span>: <span class="string">"Future 次郎"</span>,</span><br><span class="line">    <span class="attr">"date"</span>: <span class="string">"2020-06-23T11:09:01"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"夏は辛い物を食べて発汗！"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>そして以下の条件で検索をかけてみます。</p><figure class="highlight json"><figcaption><span>my_query_2.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"おいしい食べ物"</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>「おいしい食べ物」で検索</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl -X GET <span class="string">"http://localhost:9200/my_index/my_type/_search?pretty"</span> -H <span class="string">"Content-Type"</span>:<span class="string">"application/json"</span> -d @my_query_2.json</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">7</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : &#123;</span><br><span class="line">      <span class="attr">"value"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span> : <span class="string">"eq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">3.3295276</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"my_index"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"my_type"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"kzUPynIBNYoM10duZYBa"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">3.3295276</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"user_name"</span> : <span class="string">"Future 次郎"</span>,</span><br><span class="line">          <span class="attr">"date"</span> : <span class="string">"2020-06-23T11:09:01"</span>,</span><br><span class="line">          <span class="attr">"message"</span> : <span class="string">"夏は辛い物を食べて発汗！"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>検索条件は「食べ物」ですが、「食べる」を含むドキュメントが結果として取得されました。<br>こちらも同様にAnalyzerが<strong>「表記のゆれ」</strong>を検知して、「食べる」や「食べた」を<strong>「食べ」</strong>に変換して検索しています。</p><p>RDBMSでは「～と一致する」や「～を含む」などといったカッチリした条件指定となりますが、Elasticsearchでは文章を解析したりゆれを考慮して結果を返してくれるのです。<br>全文検索エンジン便利！！</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>本記事ではドキュメントの登録や検索などのほんの（本当に！）一部しか紹介していませんが、より高度な条件の検索をかけたり、登録ドキュメントの分析を行う様々な種類があります。<br>また、周辺ツールとしてデータをグラフィカルに表示する<strong>「Kibana」</strong>や、ログを自動的にElasticsearchに送り込む<strong>「Logstash」</strong>などがあります。</p><p>本記事にてElasticsearchの基本に触れたのちは、当ブログの過去記事に高度な利用法も紹介されていますので、是非挑戦してみてください！</p><ul><li><a href="https://future-architect.github.io/articles/20160920/">マネージャーがうれしいRedmineデータのグラフ表示方法を公開します！！</a></li><li><a href="https://future-architect.github.io/articles/20170510/">マネージャーがうれしいRedmineデータのダッシュボード表示方法を公開します！！</a></li><li><a href="https://future-architect.github.io/articles/20170119/">マネージャーがうれしいRedmineデータのEVM表示方法を公開します！！</a></li></ul><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul><li><a href="https://www.amazon.co.jp/Elasticsearch%E5%AE%9F%E8%B7%B5%E3%82%AC%E3%82%A4%E3%83%89-impress-top-gear-%E6%83%A3%E9%81%93/dp/4295003913/ref=asc_df_4295003913/?tag=jpgo-22&linkCode=df0&hvadid=295706574430&hvpos=&hvnetw=g&hvrand=18123178779117293225&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1009309&hvtargid=pla-525424503079&psc=1&th=1&psc=1" target="_blank" rel="noopener">Elasticsearch実践ガイド</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200623/top.png&quot;&gt;


&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは。TIGメディアユニットの町田です。
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Elastic-Stack" scheme="https://future-architect.github.io/tags/Elastic-Stack/"/>
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
      <category term="Elasticsearch" scheme="https://future-architect.github.io/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り 🌸 #16 「その仕事、Slackで。」してみた事例を紹介</title>
    <link href="https://future-architect.github.io/articles/20200622/"/>
    <id>https://future-architect.github.io/articles/20200622/</id>
    <published>2020-06-22T04:08:22.000Z</published>
    <updated>2020-06-29T01:49:15.004Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIG メディアユニットの久保です。</p><p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り🌸</a> #16　業務効率化・コミュニケーションツールSlack入門です。</p><img src="/images/20200622/1.png"><p>コロナ影響により業界各社がテレワーク中心の業務体制を準備する中、コミュニケーションツールの需要が一気に高まってきました。</p><p>この環境の中、各社がこぞって求めているのは、テレワーク上でもオフラインと同じように密なコミュニケーションを取れる手段です。新型コロナが流行してから、約２週間で大手コミュニケーションツール<a href="https://slack.com/intl/ja-jp/" target="_blank" rel="noopener">Slack</a>の同時接続数が250万人超となったニュースが、記憶に新しいですね。</p><p>そんな中、フューチャーは密なコミュニケーションを取るという目的に留まらず、Slackの拡張機能を使った業務の効率化を図っています。今年から配属される新人向けに日々の業務効率化・タスク管理の一つの手段を紹介できればと思います。</p><p>本記事では、私のチームが普段使用しているSlackの<strong>拡張機能</strong>を説明します。具体的な設定方法などは詳しく書いてある記事がたくさんあるのでググってみてください。</p><h1 id="普段使用しているSlackの拡張機能（ワークフロービルダー編）"><a href="#普段使用しているSlackの拡張機能（ワークフロービルダー編）" class="headerlink" title="普段使用しているSlackの拡張機能（ワークフロービルダー編）"></a>普段使用しているSlackの拡張機能（ワークフロービルダー編）</h1><p>私のチームではSlackの拡張機能であるワークフロービルダー（以降、WF）やAppsを使って、既存業務の効率化を図っています。<br>拡張機能の具体的な定義や作成方法は公式HPを参照してみてください。</p><ul><li>WF<ul><li>Slack内のアクション（メッセージやスタンプ）から後続のイベントを発生させる機能</li><li>公式URL：<a href="https://slack.com/intl/ja-jp/features/workflow-automation" target="_blank" rel="noopener">https://slack.com/intl/ja-jp/features/workflow-automation</a></li></ul></li></ul><h2 id="①スタンプを押すだけでタスクのTODOリスト化"><a href="#①スタンプを押すだけでタスクのTODOリスト化" class="headerlink" title="①スタンプを押すだけでタスクのTODOリスト化"></a>①スタンプを押すだけでタスクのTODOリスト化</h2><p>Slack上で発覚したタスクに対し、スタンプ（絵文字）をつけることでメンバーのTODOに追加しています。<br>具体的な例で説明すると以下のシーン。</p><img src="/images/20200622/2.png"><p>上記の例では、他メンバーからタスクを強制的に追加された！！のような表現になっていますが、普段は自分のタスク管理のために、やりとりで発覚したタスクを自身でスタンプを押してTODO化しています。</p><p>このように、スタンプ→TODOメッセージ化することで、ダイレクトメッセージ（Slackbot）上にTODOが一覧化されるため、タスクの漏れを防止すること・一覧上で視認することができます。今までは日々の会話から発覚したタスクに対して、わざわざ個人のメモ帳に張り付ける等していたタスクのリスト化が、WFを使うとスタンプを押すだけで管理することができます。</p><h2 id="②勤怠連絡のフォーマット化"><a href="#②勤怠連絡のフォーマット化" class="headerlink" title="②勤怠連絡のフォーマット化"></a>②勤怠連絡のフォーマット化</h2><p>テレワークが主軸となる中、各メンバーの勤務状況を共有するためにWFを使って、勤務状況共有の簡易化を図っています。</p><img src="/images/20200622/3.png"><p>予めWFでフォーマットを作成することで、勤怠連絡用のチャンネルからショートカット（青い稲妻マーク）によりWFを呼び出すことができます。このWF一つでは大きなコスト削減にはなりませんが、こういった日々の小さなタスクを定型化・自動化することで、本来やりたい業務に時間を費やすことができます。</p><h2 id="③新規メンバーアサイン時のガイドライン自動共有化"><a href="#③新規メンバーアサイン時のガイドライン自動共有化" class="headerlink" title="③新規メンバーアサイン時のガイドライン自動共有化"></a>③新規メンバーアサイン時のガイドライン自動共有化</h2><p>プロジェクトにメンバーが新規参画した際に行うプロジェクトルールやキャッチアップ資料の共有・ガイドを、WFで自動化しています。具体的には、特定のチャンネルに新しくメンバーを追加することをトリガーに、各種キャッチアップ資料が格納されたパスを自動で通知する仕組みを適用しています。</p><p>私たちのチームでは新規メンバー参画時に以下をWFで共有しています。</p><ul><li>Wiki</li><li>キャッチアップ資料のファイルパス</li><li>注意事項などチャンネルでピン留めされているスレッドのパス</li></ul><p>上記のように、参画時のガイドを自動化することで説明時間の削減を行っています。また、メンバーの新規参画～説明は頻繁に起こることではないため、定型化しておくことで共有しなければいけない情報の共有漏れなども防ぐことができています。</p><h1 id="普段使用しているSlackの拡張機能（Apps編）"><a href="#普段使用しているSlackの拡張機能（Apps編）" class="headerlink" title="普段使用しているSlackの拡張機能（Apps編）"></a>普段使用しているSlackの拡張機能（Apps編）</h1><p>Slack Appsには、様々なAppsが提供されています。</p><p>例えば、「<a href="https://slack.com/apps/A6L22LZNH-aws-chatbot" target="_blank" rel="noopener">AWSチャットボット</a>」を使えばAWS上のリソースをわざわざマネジメントコンソールにアクセスしなくてもSlack上で監視および操作することができます。</p><p>私たちのチームでは、業務形態に合わせてチーム固有のappを作成しています。具体的にはSlack Apps作成用の部品である「<a href="https://slack.com/intl/ja-jp/help/articles/115005265063-Slack-%E3%81%A7%E3%81%AE-Incoming-Webhook-%E3%81%AE%E5%88%A9%E7%94%A8" target="_blank" rel="noopener">Incoming Webhooks</a>」を利用して、外部サービスがイベントを発火する際に、Slackに対して通知連携をすることで、「〇〇が発生したらSlackにもメッセージが投稿される」仕組みを実現しています。</p><ul><li>Apps<ul><li>外部アクションを起点にSlack内部に後続のイベントを発生させる機能</li><li>公式URL：<a href="https://slack.com/intl/ja-jp/apps" target="_blank" rel="noopener">https://slack.com/intl/ja-jp/apps</a></li></ul></li></ul><h2 id="GitLabのCommit-MergeRequestを通知"><a href="#GitLabのCommit-MergeRequestを通知" class="headerlink" title="GitLabのCommit/MergeRequestを通知"></a>GitLabのCommit/MergeRequestを通知</h2><p>GitLabからCommit/MergeRequestの通知をSlackに連携することができます。</p><p>具体的な操作手順は少し古いですが<a href="https://qiita.com/M4e/items/c26d938e73830b0ba6b9" target="_blank" rel="noopener">まとめてくれている記事</a>があるので、参考にしてみてください。<br>要約すると以下の手順で設定していきます。</p><ol><li><a href="https://api.slack.com/" target="_blank" rel="noopener">Slackアプリを作成</a></li><li>Slackアプリの「Incoming Webhooks」を設定し、「WebhooksURL」を発行。</li><li>GitLabのsettings/Integrationsから2で発行した「WebhooksURL」を設定。</li></ol><p>上記の設定を行うことにより、ソースレビューの状況やMasterブランチのcommitをSlackで通知を受けることができます。レビュアーにMergeRequestしたけど気づいてもらえない等のタイムラグをSlack自動通知で認知してもらうことができます。開発経験が乏しいアサイン当初などはソースレビューをお願いする機会が頻繁にあると思うので、この機能があると先輩社員に自動で通知がいくのでありがい機能となるはずです。</p><h1 id="【番外編】GoogleAppsScriptでZabbix→GmailのメッセージをSlackに通知"><a href="#【番外編】GoogleAppsScriptでZabbix→GmailのメッセージをSlackに通知" class="headerlink" title="【番外編】GoogleAppsScriptでZabbix→GmailのメッセージをSlackに通知"></a>【番外編】GoogleAppsScriptでZabbix→GmailのメッセージをSlackに通知</h1><p>Zabbixの通知をGmail経由（GoogleAppsScript）でSlackにも投稿しています。</p><p>GASを挟んでいるため本記事では番外編としていますが、障害周りの通知もSlackへ連携しリアルタイムで認知できる仕組みを作っています。<br><a href="https://qiita.com/Quikky/items/9de56c049304885a4f4f" target="_blank" rel="noopener">こちらの記事</a>が参考になりました。</p><p>本記事を作成する際に改めてSlack Appを調べていいるとZabbixから直接Slackに連携することもできるようなので、次々に新しい方法が出ているなと感じました。</p><h1 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h1><p>働く環境や利用するツールが変わることで、業務方法やタスク管理方法が着々と変わっていきます。今まで自身の中で最適解であった方法よりもさらに良い方法が生まれてきている環境です。</p><p>勤続年数が多い先輩社員はそれぞれ自身の業務効率化・タスク管理がある程度確立しているなか、今年からアサインされる新人のみなさんはぜひ積極的に新しい技術・新しいサービスを取り入れて、先輩社員に「そんなサービスあるんだ！？」とあっと驚かしてみてはいかがでしょうか。自動化って便利だしかっこいいですよね。</p><p>その１ステップ目として、Slackの拡張機能は早いものなら5分で作れるものもあるので、手を出してみるにはおすすめの手段（の一つ）です。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは。TIG メディアユニットの久保です。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://future-archit
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
      <category term="Slack" scheme="https://future-architect.github.io/tags/Slack/"/>
    
      <category term="ChatOps" scheme="https://future-architect.github.io/tags/ChatOps/"/>
    
  </entry>
  
  <entry>
    <title>webpack入門</title>
    <link href="https://future-architect.github.io/articles/20200619/"/>
    <id>https://future-architect.github.io/articles/20200619/</id>
    <published>2020-06-19T01:19:09.000Z</published>
    <updated>2020-06-29T01:49:13.133Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200619/top.png"><p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>15 日目です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p><strong>想定読者はプログラミング初心者/フロントエンド未経験者です。</strong></p><p>TIG メディアユニットの二瓶賢です。<br>入門祭りということで、今回はフロントエンドの入門記事を書きました。</p><p>JavaScriptでの開発は実行結果が視覚的&amp;ツール周りが充実しているのでプログラミング覚えたての人も楽しみながら進められると思います。一方、開発環境周りは充実しすぎているがゆえ難しいと思ったので記事にしました。</p><p>webpackがどんなものか理解し、実際にwebpackを使えるようになることをゴールとしています。</p><h2 id="webpack-について"><a href="#webpack-について" class="headerlink" title="webpack について"></a>webpack について</h2><p><a href="https://webpack.js.org/" target="_blank" rel="noopener">webpack</a>とはフロントエンドのモジュールバンドラーツールです。  簡単に言うと、部品(モジュール)単位で開発した複数のJSを1つのJSにまとめる(バンドル)ツールです。(実は、JSだけでなくCSS, 画像ファイルについてもバンドルできます)</p><p>webpackを使うと、以下の利点があります。</p><ol><li>ファイルがまとめられる=通信の回数をまとめられるのでHTTP リクエストの回数が減り、パフォーマンス向上に繋がる</li><li>ファイルを部品単位で作れるので、管理がしやすくなる</li></ol><p>1.の具体例を出します。</p><p>例えば、1 ページで複数のJSをモジュール単位で開発していたとします。webpackを使わない場合HTMLは以下のようになります。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/button.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/form.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/toggle.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>webpackを使う場合は以下のようになります。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"dist/main.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>複数のJSファイルを<code>dist/main.js</code>にバンドルすることができます。そのため、開発者はファイルを部品単位で開発し、まとめ方をwebpackで指定してあげるだけで良くなります。</p><h2 id="webpack-導入手順"><a href="#webpack-導入手順" class="headerlink" title="webpack 導入手順"></a>webpack 導入手順</h2><p>webpackは<a href="https://nodejs.org/ja/" target="_blank" rel="noopener">Node.js</a> (JavaScriptの実行環境) 上で動きます。<br>※ここではNode.js についての詳細な説明は割愛します。</p><p>次に、<a href="https://docs.npmjs.com/about-npm/" target="_blank" rel="noopener">npm</a>を使ってwebpackをインストールします。</p><p>npmについても詳細は割愛します。端的に記載するとnpm(Node Packaging Manager)はNode.jsのパッケージ管理ツールです。JavaScriptのパッケージ(フレームワーク/ライブラリ/ツール)のインストールや、バージョン管理が可能です。</p><p>npmでの開発を初めるためのコマンドを実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$npm</span> init -y</span><br></pre></td></tr></table></figure><p>下記のコマンドでwebpackをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$npm</span> isntall -D webpack webpack-cli</span><br></pre></td></tr></table></figure><p>これでwebpackを使う準備は完了です。</p><h2 id="実際に-webpack-を使ってみよう"><a href="#実際に-webpack-を使ってみよう" class="headerlink" title="実際に webpack を使ってみよう"></a>実際に webpack を使ってみよう</h2><p>実際にwebpackを体験してみましょう。JSファイルをバンドルし、バンドル後のJSファイルをHTML上から読み込みます。</p><p>まず、ディレクトリ <code>dist/</code>, <code>js/</code>を作成しておきます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── dist/</span><br><span class="line">├── index.html</span><br><span class="line">├── js/</span><br><span class="line">├── package-lock.json</span><br><span class="line">├── package.json</span><br><span class="line">└── node_modules/</span><br></pre></td></tr></table></figure><p>さらに、JSファイルを2つ作成します。</p><p>まず、<code>js/hoge.js</code>を作成します。<code>alert()</code>でメッセージを表示する機能を持つ部品(モジュール)として作成します。</p><figure class="highlight js"><figcaption><span>hoge.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">alertMessage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"from hoge.js"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>続いて、<code>js/entry.js</code>を作成します。<br>このファイルはモジュールを使う側のJSファイルです。</p><figure class="highlight js"><figcaption><span>entry.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; alertMessage &#125; <span class="keyword">from</span> <span class="string">"./hoge"</span></span><br><span class="line"></span><br><span class="line">alertMessage()</span><br></pre></td></tr></table></figure><p>さて、この2つのJSファイルをバンドリングするためwebpackを使います。<br><code>./webpack.config.js</code>を作成します。</p><figure class="highlight js"><figcaption><span>webpack.config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: <span class="string">'./js/entry.js'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>これはwebpackの設定ファイルです。</p><p>上記では設定は2つ指定しています。<code>mode</code>では、開発モードでビルドすることを指定しています。<code>mode</code>は<code>development</code>(開発モード),<code>production</code>(製品モード),<code>none</code>(指定なし)の3つあります。<code>entry</code>では、エントリーポイント(一番初めの他モジュールの呼び出し元ファイル)を<code>./js/entry.js</code>に指定しています。</p><p>さて、webpackの設定は終わったので実際にwebpackを実行してみましょう。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./node_modules/.bin/webpack</span><br></pre></td></tr></table></figure><p>結果は以下のように出るかと思います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Hash: acbec46c248d0da2e3fb</span><br><span class="line">Version: webpack 4.43.0</span><br><span class="line">Time: 117ms</span><br><span class="line">Built at: 06/17/2020 10:08:18 PM</span><br><span class="line">  Asset      Size  Chunks             Chunk Names</span><br><span class="line">main.js  4.54 KiB    main  [emitted]  main</span><br><span class="line">Entrypoint main = main.js</span><br><span class="line">[./js/entry.js] 53 bytes &#123;main&#125; [built]</span><br><span class="line">[./js/hoge.js] 63 bytes &#123;main&#125; [built]</span><br></pre></td></tr></table></figure><p>さて、ここで<code>dist/</code>の中身を観てみましょう。<br><code>dist/main.js</code>が作成されているはずです。</p><p><code>dist/main.js</code>はビルド済ですが、一旦中身を見てみると</p><figure class="highlight js"><figcaption><span>dist/main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">var</span> t=&#123;&#125;;<span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params">n</span>)</span>&#123;<span class="keyword">if</span>(t[n])<span class="keyword">return</span> t[n].exports;<span class="keyword">var</span> o=t[n]=&#123;<span class="attr">i</span>:n,<span class="attr">l</span>:!<span class="number">1</span>,<span class="attr">exports</span>:&#123;&#125;&#125;;<span class="keyword">return</span> e[n].call(o.exports,o,o.exports,r),o.l=!<span class="number">0</span>,o.exports&#125;r.m=e,r.c=t,r.d=<span class="function"><span class="keyword">function</span>(<span class="params">e,t,n</span>)</span>&#123;r.o(e,t)||<span class="built_in">Object</span>.defineProperty(e,t,&#123;<span class="attr">enumerable</span>:!<span class="number">0</span>,<span class="attr">get</span>:n&#125;)&#125;,r.r=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="string">"undefined"</span>!=<span class="keyword">typeof</span> <span class="built_in">Symbol</span>&amp;&amp;<span class="built_in">Symbol</span>.toStringTag&amp;&amp;<span class="built_in">Object</span>.defineProperty(e,<span class="built_in">Symbol</span>.toStringTag,&#123;<span class="attr">value</span>:<span class="string">"Module"</span>&#125;),<span class="built_in">Object</span>.defineProperty(e,<span class="string">"__esModule"</span>,&#123;<span class="attr">value</span>:!<span class="number">0</span>&#125;)&#125;,r.t=<span class="function"><span class="keyword">function</span>(<span class="params">e,t</span>)</span>&#123;<span class="keyword">if</span>(<span class="number">1</span>&amp;t&amp;&amp;(e=r(e)),<span class="number">8</span>&amp;t)<span class="keyword">return</span> e;<span class="keyword">if</span>(<span class="number">4</span>&amp;t&amp;&amp;<span class="string">"object"</span>==<span class="keyword">typeof</span> e&amp;&amp;e&amp;&amp;e.__esModule)<span class="keyword">return</span> e;<span class="keyword">var</span> n=<span class="built_in">Object</span>.create(<span class="literal">null</span>);<span class="keyword">if</span>(r.r(n),<span class="built_in">Object</span>.defineProperty(n,<span class="string">"default"</span>,&#123;<span class="attr">enumerable</span>:!<span class="number">0</span>,<span class="attr">value</span>:e&#125;),<span class="number">2</span>&amp;t&amp;&amp;<span class="string">"string"</span>!=<span class="keyword">typeof</span> e)<span class="keyword">for</span>(<span class="keyword">var</span> o <span class="keyword">in</span> e)r.d(n,o,<span class="function"><span class="keyword">function</span>(<span class="params">t</span>)</span>&#123;<span class="keyword">return</span> e[t]&#125;.bind(<span class="literal">null</span>,o));<span class="keyword">return</span> n&#125;,r.n=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">var</span> t=e&amp;&amp;e.__esModule?<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> e.default&#125;:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> e&#125;;<span class="keyword">return</span> r.d(t,<span class="string">"a"</span>,t),t&#125;,r.o=<span class="function"><span class="keyword">function</span>(<span class="params">e,t</span>)</span>&#123;<span class="keyword">return</span> <span class="built_in">Object</span>.prototype.hasOwnProperty.call(e,t)&#125;,r.p=<span class="string">""</span>,r(r.s=<span class="number">0</span>)&#125;([<span class="function"><span class="keyword">function</span>(<span class="params">e,t,r</span>)</span>&#123;<span class="string">"use strict"</span>;r.r(t),alert(<span class="string">"from hoge.js"</span>)&#125;]);</span><br></pre></td></tr></table></figure><p>と、綺麗なコードが生成されているかと思います。<br>これがバンドル後のJSファイルです。<br>もう何が書いてあるのかわかりません。<br>正しく意図したとおり動くのか、実際に実行してみましょう。</p><p><code>./index.html</code>を作成します。</p><figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"dist/main.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>実際にこれをブラウザで開いてみましょう。<br>開くと、意図したとおり以下のようなメッセージが出ます。(画像はChromeで開いた場合)<br><img src="/images/20200619/photo_20200619_01.png"></p><p>最後に、webpackのコマンドオプションを一つ紹介します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./node_modules/.bin/webpack --watch</span><br></pre></td></tr></table></figure><p>これを指定するとJSファイルの変更を監視し、変更を検知すると自動でwebpackが走ります。<br>試しに、監視状態のまま<code>js/hoge.js</code>で表示するメッセージを変更してみましょう。</p><figure class="highlight js"><figcaption><span>hoge.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">alertMessage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"****from hoge.js****"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>その後、もう一度<code>./index.html</code>をブラウザで開いてみましょう。メッセージが変更されていることが確認できるかと思います。</p><p>これで、逐次webpackを実行する手間もなくなりました。</p><hr><p>今回は<code>webpack.config.js</code>については必要最低限の設定しかしませんでしたが実際はたくさん設定することになります。<br>例えば、利用するプラグインの設定をします。<br>webpackではプラグインは豊富に用意されています。<br>ここでは、一例をご紹介します。</p><ul><li>バンドル時に不要なスペースやコメント等を削除し軽量化するプラグイン：<a href="https://webpack.js.org/plugins/uglifyjs-webpack-plugin/" target="_blank" rel="noopener">UglifyjsWebpackPlugin</a></li><li>HTMLの生成までするプラグイン：<a href="https://webpack.js.org/plugins/html-webpack-plugin/" target="_blank" rel="noopener">HtmlWebpackPlugin</a></li><li><code>--watch</code>オプションで特定のファイルの監視を無視させるプラグイン：<a href="https://webpack.js.org/plugins/watch-ignore-plugin/" target="_blank" rel="noopener">WatchIgnorePlugin</a></li></ul><p>たくさん設定が増え複雑化するため、実際の開発では共通設定/開発環境設定/本番環境設定としてそれぞれ<code>webpack.common.js</code>, <code>webpack.dev.js</code>, <code>webpack.prod.js</code>と分けて設定を記載していきます。<br><a href="https://webpack.js.org/guides/production/#setup" target="_blank" rel="noopener">公式ドキュメントの例</a></p><p>また、<code>./node_modules/.bin/webpack</code>はnpm-scriptsに登録するとよりよいです。<br><code>./package.json</code>にて、scriptsに<code>&quot;コマンド名&quot;:&quot;タスク&quot;</code>を登録すると、以下のように実行できます。<br>例：</p><figure class="highlight"><figcaption><span>./package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "build": "webpack",</span><br><span class="line">    "watch": "webpack --watch"</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>npm-script実行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$npm</span> run build</span><br></pre></td></tr></table></figure><p>上記のコマンドは<code>$./node_modules/.bin/webpack</code>と実行内容は同じですが、こちらの方が簡潔かと思います。<br><code>watch</code>に関しても同様です。<br>npm-scriptsを上手く設定することで、複雑なタスクも簡潔に実行できるようになります(これはwebpackに限りません)。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>webpackの機能をすべて紹介することはできませんでしたが、webpackがどのような目的のツールなのかを知っていただき実際にwebpackを体験していただけたなら幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200619/top.png&quot;&gt;


&lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;15 日目です。&lt;/p&gt;
&lt;h2 id=&quot;はじめ
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="Frontend" scheme="https://future-architect.github.io/tags/Frontend/"/>
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
      <category term="Node.js" scheme="https://future-architect.github.io/tags/Node-js/"/>
    
      <category term="webpack" scheme="https://future-architect.github.io/tags/webpack/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り 🌸 #14 暗号通信入門 </title>
    <link href="https://future-architect.github.io/articles/20200618/"/>
    <id>https://future-architect.github.io/articles/20200618/</id>
    <published>2020-06-18T00:33:37.000Z</published>
    <updated>2020-06-29T01:49:26.898Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIG メディアチームの竹中です。</p><p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り🌸</a> #14　暗号通信入門です。</p><p>新型コロナ肺炎の感染拡大に伴い、多くの方がインターネット通販をいつも以上に利用したのでは無いでしょうか？その際、クレジットカード番号など漏洩したら困る個人情報が多く含まれますので、どのような通信が行われているか分からないと気が気ではありませんね。もちろんやり取りには暗号通信が利用されています。</p><p>私自身、「仕組みは知っているけど検証はしたことがなかったな」と思い、HTTP通信とHTTPS通信の通信内容を確認しつつ、暗号通信入門記事としていきます。本記事では、入門記事として簡単な解説と検証内容を記載し、詳細な仕組みなど後記する参考文献などで調べて頂くことを想定しています。</p><p>では、早速見ていきましょう。</p><h1 id="HTTP通信？HTTPS通信？"><a href="#HTTP通信？HTTPS通信？" class="headerlink" title="HTTP通信？HTTPS通信？"></a>HTTP通信？HTTPS通信？</h1><p>インターネット通販などでブラウザを使う際、ブラウザとWebサーバーで主に行われている通信です。<br>通信内容を暗号化せずに通信（＝HTTP通信）すると無関係な人も通信内容を読み取れるため、通信内容を暗号化して、通信先にのみ通信内容を正しく読み取れるように（＝HTTPS通信）しようというものです。</p><img src="/images/20200618/photo_20200618_01.png" style="border:solid 1px #000000"><h1 id="暗号化していないHTTP通信"><a href="#暗号化していないHTTP通信" class="headerlink" title="暗号化していないHTTP通信"></a>暗号化していないHTTP通信</h1><p>HTTP通信ではどのように通信内容が見えるのでしょうか。早速検証してみましょう。</p><h2 id="HTTP通信をするサーバを用意"><a href="#HTTP通信をするサーバを用意" class="headerlink" title="HTTP通信をするサーバを用意"></a>HTTP通信をするサーバを用意</h2><p>Node.jsをインストールして、以下のファイルを用意します。</p><figure class="highlight js"><figcaption><span>server-http.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">var</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> html = <span class="built_in">require</span>(<span class="string">'fs'</span>).readFileSync(<span class="string">'form.html'</span>);</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// サーバー起動</span></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.method === <span class="string">'GET'</span>) &#123;</span><br><span class="line">         <span class="comment">// 初期表示ではformを返す</span></span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;)</span><br><span class="line">        res.end(html);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(req.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">         <span class="comment">// formからの入力値を解釈して返却</span></span><br><span class="line">        <span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;)</span><br><span class="line">        req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;data += chunk&#125;)</span><br><span class="line">            .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                res.end(<span class="string">`form: <span class="subst">$&#123;data&#125;</span> `</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).listen(port)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Server is running : http://localhost:<span class="subst">$&#123;port&#125;</span>/`</span>);</span><br></pre></td></tr></table></figure><figure class="highlight html"><figcaption><span>from.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    Name:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Credit No:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"creditNo"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>HTTP通信を行うサーバを起動します。<br><code>node .\server-http.js start</code></p><p>ブラウザで<code>http://localhost:8080/</code>を開くと下記のようなフォームが表示されます。<br><img src="/images/20200618/photo_20200618_02.png" class="img-middle-size"></p><h2 id="通信内容を確認"><a href="#通信内容を確認" class="headerlink" title="通信内容を確認"></a>通信内容を確認</h2><p>今回はWiresharkでパケット取得してみます。</p><p>Wiresharkはネットワーク・アナライザ・ソフトウェアで、指定したネットワークインターフェイス上を通過するネットワークパケットをキャプチャすることができます。要するに、ブラウザからWebサーバへ送られるネットワーク通信の内容を監視することができます。</p><p>こちらを使って、ブラウザから送られるHTTP通信・HTTP通信の内容を見ていきます。</p><p>インストールや使い方については『<a href="https://beginners-network.com/wireshark.html" target="_blank" rel="noopener">Wiresharkの使い方 - ネットワーク入門サイト</a>』を参考にしてください。</p><p>Wiresharkでキャプチャ取得を開始し、「http」でフィルターします。ブラウザから<code>http://localhost:8000/</code>のフォームを開き、『送信』（HTTPリクエスト）します。</p><img src="/images/20200618/photo_20200618_03.png" class="img-middle-size"><p>サーバ側では問題なくリクエスト情報を取得できていますね。<br><img src="/images/20200618/photo_20200618_04.png" class="img-middle-size"></p><p>Wiresharkで送信内容見てみると、NameもcreditNoもそのまま送られています。</p><img src="/images/20200618/photo_20200618_05.png" style="border:solid 1px #000000"><p>HTTP通信で情報を送ってしまった場合、 <strong><em>通信内容から容易に情報が読み取れてしまう</em></strong> 、ということですね。</p><h1 id="暗号化したHTTPS通信"><a href="#暗号化したHTTPS通信" class="headerlink" title="暗号化したHTTPS通信"></a>暗号化したHTTPS通信</h1><p>HTTP通信では、「通信内容から容易に情報が読み取れてしまう」ことが分かりました。</p><p>次にHTTPS通信の内容を見て、HTTPS通信では本当に情報が読み取れないのかを確認していきます。</p><p>しかし、暗号通信を行うためには、暗号化するための情報や複合化するための情報が分からないと通信のやり取りができません。そのためHTTPS通信の際には、実際に送信したい内容を送る前に暗号通信準備を行っています。暗号通信準備については、『<a href="https://www.infraexpert.com/study/security28.html" target="_blank" rel="noopener">SSL/TLSネゴシエーション - ネットワークエンジニアとして</a>』を参照ください。</p><h2 id="暗号化のための証明書、秘密鍵を用意"><a href="#暗号化のための証明書、秘密鍵を用意" class="headerlink" title="暗号化のための証明書、秘密鍵を用意"></a>暗号化のための証明書、秘密鍵を用意</h2><p>HTTPS通信を行う際のSSL/TLSネゴシエーションに必須となる、サーバの証明書・秘密鍵を用意します。</p><p>執筆時はWindows、かつ認証Proxy環境の環境で検証を行っています。今回はchocolateyをインストール後、mkcertのインストールして、mkcertでサーバーの証明書・秘密鍵を作成を行います。mkcertはローカルで信頼された証明書を発行するためのソフトウェア、chocolateyはWindows用のパッケージ管理ソフトウェアで、今回はmkcertをインストールするために使用します。</p><p>まずは下記等を参考として、chocolateyのインストールをしてください。</p><ul><li><a href="https://qiita.com/Koutaru/items/41a87ea4004fa685de55" target="_blank" rel="noopener">Windows環境にchocolateyをインストールし、使う</a></li><li><a href="https://qiita.com/geotrader/items/33b5db1832bb42979ba9" target="_blank" rel="noopener">認証プロキシ環境下でのchocolateyインストール</a></li></ul><p>次にmkcertのインストールして、サーバの証明書・秘密鍵を作成を行います。コマンドプロンプトを管理者権限で起動し、下記を実行してください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkcertをインストール</span></span><br><span class="line"><span class="variable">$cinst</span> -y mkcert</span><br><span class="line"></span><br><span class="line"><span class="comment"># ローカル環境に認証局を作成</span></span><br><span class="line"><span class="variable">$mkcert</span> -install</span><br><span class="line"></span><br><span class="line"><span class="comment"># localhostの証明書、秘密鍵を作成</span></span><br><span class="line"><span class="comment"># ※カレントディレクトリに「localhost+2.pem」「localhost+2-key.pem」が生成される</span></span><br><span class="line"><span class="variable">$mkcert</span> localhost 127.0.0.1 ::1</span><br></pre></td></tr></table></figure><h2 id="HTTPS通信をするサーバを用意"><a href="#HTTPS通信をするサーバを用意" class="headerlink" title="HTTPS通信をするサーバを用意"></a>HTTPS通信をするサーバを用意</h2><p>以下のファイルを用意します。</p><figure class="highlight js"><figcaption><span>server-http.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"><span class="keyword">const</span> fs    = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> html = fs.readFileSync(<span class="string">'form.html'</span>);</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8443</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123; </span><br><span class="line">    key: fs.readFileSync(<span class="string">'localhost+2-key.pem'</span>),</span><br><span class="line">    cert: fs.readFileSync(<span class="string">'localhost+2.pem'</span>)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// サーバー起動</span></span><br><span class="line">https.createServer(options, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.method === <span class="string">'GET'</span>) &#123;</span><br><span class="line">        <span class="comment">// 初期表示ではformを返す</span></span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;)</span><br><span class="line">        res.end(html);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(req.method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">        <span class="comment">// formからの入力値を解釈して返却</span></span><br><span class="line">        <span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;)</span><br><span class="line">        req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;data += chunk&#125;)</span><br><span class="line">            .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                res.end(<span class="string">`form: <span class="subst">$&#123;data&#125;</span> `</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).listen(port);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Server is running : https://localhost:<span class="subst">$&#123;port&#125;</span>/`</span>);</span><br></pre></td></tr></table></figure><figure class="highlight html"><figcaption><span>from.html　※HTTPサーバで用意したものと同じです。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    Name:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    Credit No:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"creditNo"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>用意したファイルは『暗号化のための鍵情報などを用意』で作成したファイルと同じ場所に配置します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">folder/</span><br><span class="line">　├ form.html</span><br><span class="line">　├ localhost+2-key.pem</span><br><span class="line">　├ localhost+2.pem</span><br><span class="line">　└ server-https.js</span><br></pre></td></tr></table></figure><p>HTTPS通信を行うサーバを起動します。<br><code>node .\server-https.js start</code></p><p>ブラウザで<code>https://localhost:8443/</code>を開きます。</p><h2 id="WireSharckで通信内容を確認"><a href="#WireSharckで通信内容を確認" class="headerlink" title="WireSharckで通信内容を確認"></a>WireSharckで通信内容を確認</h2><p>Wiresharkでパケット取得してみます。</p><p>キャプチャ取得を開始し、「ipv6.src == ::1」でフィルターします。<br>フォームからHTTPリクエストします。<br><img src="/images/20200618/photo_20200618_06.png" class="img-middle-size"></p><p>サーバ側では問題なくリクエスト情報を取得できていますね。<br><img src="/images/20200618/photo_20200618_07.png" class="img-middle-size"></p><p>しかし、Wiresharkで通信内容見てみると、HTTP通信の時と違ってNameもcreditNoも見つかりません。それどころか、HTTP通信のときにあったGETやPOSTというやり取りすら見つけることができません。</p><img src="/images/20200618/photo_20200618_08.png" style="border:solid 1px #000000"><p>このようにHTTPS通信の内容は、暗号化されているため、サーバが保持している秘密鍵がないと暗号化前の通信内容が分からない状態になっています。</p><h1 id="HTTPS通信の内容を復号化して平文を確認"><a href="#HTTPS通信の内容を復号化して平文を確認" class="headerlink" title="HTTPS通信の内容を復号化して平文を確認"></a>HTTPS通信の内容を復号化して平文を確認</h1><p>暗号化されている？見逃しているだけでHTTPS通信でも平文が送られてるのでは？と考える方もいるかもしれません。</p><p>次に、Wiresharkでキャプチャしている通信内容を復号して平文を確認してみましょう。復号方法は『<a href="https://www7390uo.sakura.ne.jp/wordpress/archives/709" target="_blank" rel="noopener">HTTPSによる暗号化された通信のやり取りをWiresharkで復号して内容を読み取る</a>』を参考にしてください。</p><p>筆者検証時はWireshark設定項目から「Protocols &gt; SSL」がなくなっていたため、「Protocols &gt; TLS」に同様の設定をして検証しています。参考先に記載がありますが「鍵情報が漏洩するとHTTPS通信内容が復号できる」ということですので、鍵情報の取扱にはご注意ください。</p><p>Wiresharkの設定後、再度HTTPS通信を行います。先ほどまでApplication Dataと表記されていた箇所が復号され、平文が確認できます。<br><img src="/images/20200618/photo_20200618_09.png" style="border:solid 1px #000000"></p><p>キャプションを比較してみると、確かに設定を入れる前のWiresharkではApplication Dataと表記されていたところが、復号化されて平文になって確認できていることが分かります。<br><img src="/images/20200618/photo_20200618_10.png" style="border:solid 1px #000000"></p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>今回はHTTP通信とHTTPS通信について、検証・確認しました。</p><p>昨今、インターネットの普及に伴い、企業では勿論ですが、プライベートで利用するインターネット通販でも個人情報を入力する機会は多くあるため、一人一人が当たり前にセキュリティ対策を知り、考えなければいけないものになってきています。</p><p>本記事は触れていませんが、HTTPS通信を行う際にその通信先を証明してくれる『信用できる第三者（証明局）』を何をもって信用するか、といった問題など、懸念を上げれば限がないぐらいセキュリティ対策は考えることが多いです。しかし、企業も個人も身を守るために避けては通れないことの一つがセキュリティ対策です。</p><p>HTTP通信に関しては、Chromeで2019年末から2020年第1四半期にわたってHTTPS/HTTP混在ページにおけるHTTPをデフォルトでブロックの対象としていくことが宣言されるなど、各サイトでHTTPSへの対応が必須となってきています。</p><p>フリーで自動化されたオープンな認証局として、『<a href="https://letsencrypt.org/ja/" target="_blank" rel="noopener">Let’s Encrypt</a>』というサービスもあります。ISRGが公共の利益のために運営・提供しているサービスで、2016年4月12日 に正式サービスが開始して以降、毎日多くの証明書を発行しており、HTTPSへの対応もあまりコストかからずできるようになっています。</p><p>本記事は、前記の通り詳しい仕組みの解説記事とはなっておりません。最後に参考文献について記載しますので、皆さんの興味・関心に応じて別途調べてください。</p><p>普段何気なく使っている、身近な暗号通信に興味を持ってもらうきっかけになれば、幸いです！</p><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul><li><a href="https://www.amazon.co.jp/%E6%9A%97%E5%8F%B7%E6%8A%80%E8%A1%93%E5%85%A5%E9%96%80-%E7%AC%AC3%E7%89%88-%E7%B5%90%E5%9F%8E-%E6%B5%A9/dp/4797382228" target="_blank" rel="noopener">暗号技術入門</a><ul><li>「対称暗号」「公開鍵暗号」「デジタル署名」「PKI」「PGP」「SSL/TLS」など、<br>暗号技術の基礎を、たくさんの図とやさしい文章で解説しています。</li></ul></li><li><a href="https://www.lambdanote.com/products/tls" target="_blank" rel="noopener">プロフェッショナルSSL/TLS</a><ul><li>いまやインターネットにおける暗号化通信に不可欠となったセキュリティプロトコルであるTLS（SSL）の全体像を体系的かつ具体的に語った、‟Bulletproof SSL and TLS”（Ivan Ristić 著）の全訳</li></ul></li><li><a href="https://www.oreilly.co.jp/books/9784873119038/" target="_blank" rel="noopener">Real World HTTP</a><ul><li>HTTPが進化する道筋をたどりながら、ブラウザが内部で行っていること、サーバーとのやりとりの内容などについて、プロトコルの実例や実際の使用例などを交えながら紹介！！</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは。TIG メディアチームの竹中です。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://future-archite
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="暗号" scheme="https://future-architect.github.io/tags/%E6%9A%97%E5%8F%B7/"/>
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
      <category term="Wireshark" scheme="https://future-architect.github.io/tags/Wireshark/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り 🌸 #13 Swift Compositional Layouts入門：複雑なCollectionViewをシンプルに実装する</title>
    <link href="https://future-architect.github.io/articles/20200617/"/>
    <id>https://future-architect.github.io/articles/20200617/</id>
    <published>2020-06-17T01:20:21.000Z</published>
    <updated>2020-06-29T01:49:24.183Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>の第13弾です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIG メディアユニットの福谷（ふくや）です。</p><p>お仕事では主にサーバーサイド領域で開発していますが、趣味でiOSアプリを開発しており、春の入門祭りの社内アナウンスがあったので書いてみようと思います。</p><p>iOSアプリで記事や写真などを一覧表示させたい場合、必ずと言っていいほどCollectionView（あるいはTableView）が採用されると思います。</p><p>iPhoneが発売された当初のデザインは、縦にコンテンツが並ぶだけのレイアウトでしたが、昨今はコンテンツの一覧性・視認性をより高めるために、縦にも横にもスクロールできるCollectionViewが一般的になってきています。<br><img src="/images/20200617/1.png" class="img-small-size"></p><h1 id="Compositional-Layouts"><a href="#Compositional-Layouts" class="headerlink" title="Compositional Layouts"></a>Compositional Layouts</h1><p>そこでCompositional Layoutsの登場です。</p><p>Compositional LayoutsはWWDC2019に発表された複雑なレイアウトをシンプルに実装するための考え方です。CollectionViewにおいては<code>UICollectionViewCompositionalLayout</code>クラス<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup>を利用します。</p><p>Compositional Layoutsの詳しい解説はWWDC2019の動画<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>を見るか、それを元に解説した記事<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>もあるのでそちらを参照してください。また公式サンプルコード<sup id="fnref:7"><a href="#fn:7" rel="footnote">7</a></sup>もかなり参考になるためおすすめです。</p><p>※公式ではiOS13でサポートされていますが、iOS13以前でも利用可能にするためのライブラリ<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>がでています。</p><h1 id="アプリを作る"><a href="#アプリを作る" class="headerlink" title="アプリを作る"></a>アプリを作る</h1><p>以下のようなFuture Tech Blogリーダーを作ってみようと思います。</p><p>ソース全量は<a href="https://github.com/popai306/FutureTechBlogReader" target="_blank" rel="noopener">こちら</a>。<br>※以降の解説はCompositional Layoutsの実装部分に焦点を当てて解説していきます。</p><img src="/images/20200617/photo_20200617_01.gif" class="img-middle-size" style="border:solid 1px #000000"><h3 id="item・group・sectionの構成を決める"><a href="#item・group・sectionの構成を決める" class="headerlink" title="item・group・sectionの構成を決める"></a>item・group・sectionの構成を決める</h3><p>Compositional Layoutは item・group・section、そしてsectionを内包するlayoutにより構成されます。<br><img src="/images/20200617/2.png" class="img-middle-size"></p><p>今回作るアプリのUIを例に、item・group・sectionをどう構成するかについて示したのが下記の画像です。<br><img src="/images/20200617/3.png" class="img-middle-size" style="border:solid 1px #000000"></p><p>それではLayoutを書いていきましょう。</p><h3 id="Compositional-Layoutで実装する"><a href="#Compositional-Layoutで実装する" class="headerlink" title="Compositional Layoutで実装する"></a>Compositional Layoutで実装する</h3><p>まず大枠のSectionから書いていきます。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createLayout</span><span class="params">()</span></span> -&gt; <span class="type">UICollectionViewLayout</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> sectionProvider = &#123; (sectionIndex: <span class="type">Int</span>,</span><br><span class="line">        layoutEnvironment: <span class="type">NSCollectionLayoutEnvironment</span>) -&gt; <span class="type">NSCollectionLayoutSection?</span> <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> section = <span class="type">NSCollectionLayoutSection</span>(group: group)</span><br><span class="line">        section.orthogonalScrollingBehavior = sectionKind.scrollingBehavior()</span><br><span class="line"></span><br><span class="line">        <span class="comment">//①</span></span><br><span class="line">        section.interGroupSpacing = <span class="number">10</span></span><br><span class="line">        <span class="comment">//②</span></span><br><span class="line">        section.contentInsets = <span class="type">NSDirectionalEdgeInsets</span>(top: <span class="number">0</span>, leading: <span class="number">15</span>, bottom: <span class="number">0</span>, trailing: <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// section headerの定義</span></span><br><span class="line">        <span class="keyword">let</span> sectionHeaderSize = <span class="type">NSCollectionLayoutSize</span>(widthDimension: .fractionalWidth(<span class="number">1.0</span>),</span><br><span class="line">                                                       heightDimension: .estimated(<span class="number">44</span>))</span><br><span class="line">        <span class="keyword">let</span> sectionHeader = <span class="type">NSCollectionLayoutBoundarySupplementaryItem</span>(layoutSize: sectionHeaderSize, elementKind: <span class="string">"header"</span>, alignment: .top)</span><br><span class="line">        section.boundarySupplementaryItems = [sectionHeader]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> section</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> config = <span class="type">UICollectionViewCompositionalLayoutConfiguration</span>()</span><br><span class="line">    <span class="comment">//③</span></span><br><span class="line">    config.interSectionSpacing = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> layout = <span class="type">UICollectionViewCompositionalLayout</span>(sectionProvider: sectionProvider, configuration: config)</span><br><span class="line">    <span class="keyword">return</span> layout</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sectionheaderSize</code>の<code>widthDimension</code>に引数として渡している<code>fractionalWidth(1.0)</code>は、sectionの横幅と同じ比率でheaderの横幅を定義することを意味します。<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup></p><p>また、<code>heightDimension</code>に引数として渡している<code>estimated(44)</code>は、44で高さを指定するものの最終的なレイアウトはレンダリング時に決定します（＝「弱い定義」と勝手に呼んでいます）。<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup></p><br>ソースコード中の余白定義①②③はそれぞれUI上の下記のポイントに対応しています。<img src="/images/20200617/4.png" class="img-middle-size" style="border:solid 1px #000000"><p>続いてitem・groupのレイアウトを定義していきます。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createLayout</span><span class="params">()</span></span> -&gt; <span class="type">UICollectionViewLayout</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> sectionProvider = &#123; (sectionIndex: <span class="type">Int</span>,</span><br><span class="line">        layoutEnvironment: <span class="type">NSCollectionLayoutEnvironment</span>) -&gt; <span class="type">NSCollectionLayoutSection?</span> <span class="keyword">in</span></span><br><span class="line">        <span class="comment">// セクションのenum</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> sectionKind = <span class="type">SectionLayoutKind</span>(rawValue: sectionIndex) <span class="keyword">else</span> &#123; <span class="built_in">fatalError</span>(<span class="string">"unknown section kind"</span>) &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// itemの定義</span></span><br><span class="line">        <span class="keyword">let</span> itemSize = <span class="type">NSCollectionLayoutSize</span>(widthDimension: .fractionalWidth(<span class="number">1.0</span>),</span><br><span class="line">                                              heightDimension: .fractionalHeight(<span class="number">1.0</span>))</span><br><span class="line">        <span class="keyword">let</span> item = <span class="type">NSCollectionLayoutItem</span>(layoutSize: itemSize)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// groupの定義    </span></span><br><span class="line">        <span class="keyword">let</span> groupWidth = layoutEnvironment.container.effectiveContentSize.width - <span class="number">15</span> * <span class="number">2</span> - <span class="number">5</span></span><br><span class="line">        <span class="keyword">let</span> groupSize = <span class="type">NSCollectionLayoutSize</span>(widthDimension: .absolute(groupWidth),</span><br><span class="line">                                               heightDimension: .absolute(<span class="number">150</span>))</span><br><span class="line">        <span class="keyword">let</span> group: <span class="type">NSCollectionLayoutGroup</span></span><br><span class="line">        <span class="keyword">if</span> sectionKind == .recommend &#123;</span><br><span class="line">            group = <span class="type">NSCollectionLayoutGroup</span>.horizontal(layoutSize: groupSize, subitem: item, <span class="built_in">count</span>: <span class="number">2</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            group = <span class="type">NSCollectionLayoutGroup</span>.vertical(layoutSize: groupSize, subitem: item, <span class="built_in">count</span>: <span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        group.interItemSpacing = <span class="type">NSCollectionLayoutSpacing</span>.fixed(<span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sectionの定義</span></span><br><span class="line">        <span class="keyword">let</span> section = <span class="type">NSCollectionLayoutSection</span>(group: group)</span><br><span class="line">        section.orthogonalScrollingBehavior = sectionKind.scrollingBehavior()</span><br><span class="line">        section.interGroupSpacing = <span class="number">10</span></span><br><span class="line">        section.contentInsets = <span class="type">NSDirectionalEdgeInsets</span>(top: <span class="number">0</span>, leading: <span class="number">15</span>, bottom: <span class="number">0</span>, trailing: <span class="number">15</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> sectionHeaderSize = <span class="type">NSCollectionLayoutSize</span>(widthDimension: .fractionalWidth(<span class="number">1.0</span>),</span><br><span class="line">                                                       heightDimension: .estimated(<span class="number">44</span>))</span><br><span class="line">        <span class="keyword">let</span> sectionHeader = <span class="type">NSCollectionLayoutBoundarySupplementaryItem</span>(layoutSize: sectionHeaderSize, elementKind: <span class="string">"header"</span>, alignment: .top)</span><br><span class="line">        section.boundarySupplementaryItems = [sectionHeader]</span><br><span class="line">        <span class="keyword">return</span> section</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> config = <span class="type">UICollectionViewCompositionalLayoutConfiguration</span>()</span><br><span class="line">    config.interSectionSpacing = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> layout = <span class="type">UICollectionViewCompositionalLayout</span>(sectionProvider: sectionProvider, configuration: config)</span><br><span class="line">    <span class="keyword">return</span> layout</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SectionLayoutKind"><a href="#SectionLayoutKind" class="headerlink" title="SectionLayoutKind"></a>SectionLayoutKind</h4><p><code>SectionLayoutKind</code>はアプリ中の<code>おすすめ</code>や<code>春の入門祭り</code>などのセクションをenumで定義したもので、<br>下記の通り定義しています。</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">SectionLayoutKind</span>: <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> recommend, springEntry, goTips, serverless</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scrollingBehavior</span><span class="params">()</span></span> -&gt; <span class="type">UICollectionLayoutSectionOrthogonalScrollingBehavior</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .recommend:</span><br><span class="line">            <span class="keyword">return</span> .continuous</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> .groupPaging</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>もし固定的にセクションを管理するならenumで定義しておくのが良いと思います。</p><p>一方でenumで定義するとenum内でセクションごとのレイアウト情報をいろいろ管理したくなりますが、<code>createLayout()</code>内にもレイアウト定義をしているので、見通しを良くするためにも最低限のレイアウト情報のみenum内で定義すべきだと思います。（この場合水平スクロールの挙動）</p><h4 id="groupのレイアウト定義"><a href="#groupのレイアウト定義" class="headerlink" title="groupのレイアウト定義"></a>groupのレイアウト定義</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> group: <span class="type">NSCollectionLayoutGroup</span></span><br><span class="line"><span class="keyword">if</span> sectionKind == .recommend &#123;</span><br><span class="line">    <span class="comment">// ①おすすめセクションのgroup定義</span></span><br><span class="line">    group = <span class="type">NSCollectionLayoutGroup</span>.horizontal(layoutSize: groupSize, subitem: item, <span class="built_in">count</span>: <span class="number">2</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ②おすすめセクション以外ののgroup定義</span></span><br><span class="line">    group = <span class="type">NSCollectionLayoutGroup</span>.vertical(layoutSize: groupSize, subitem: item, <span class="built_in">count</span>: <span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// item間の空白の定義</span></span><br><span class="line">group.interItemSpacing = <span class="type">NSCollectionLayoutSpacing</span>.fixed(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>②おすすめセクション以外ののgroup定義</p><p><code>NSCollectionLayoutGroup.vertical(layoutSize: groupSize, subitem: item, count: 2)</code><br><code>vertical</code>で<code>count</code>を”２”にすることによって垂直にitemを２つスタックしています。</p><p>①おすすめセクションのgroup定義</p><p>おすすめの記事は画像を大きくして目立たせたいので水平にitemを２つスタックしています。<br><code>NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitem: item, count: 2)</code></p><h4 id="groupSizeの定義"><a href="#groupSizeの定義" class="headerlink" title="groupSizeの定義"></a>groupSizeの定義</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> groupWidth = layoutEnvironment.container.effectiveContentSize.width - <span class="number">15</span> * <span class="number">2</span></span><br><span class="line"><span class="keyword">let</span> groupSize = <span class="type">NSCollectionLayoutSize</span>(widthDimension: .absolute(groupWidth), heightDimension: .absolute(<span class="number">150</span>))</span><br></pre></td></tr></table></figure><p><code>layoutEnvironment.container.effectiveContentSize</code>はcollectionViewの描画領域を意味しています。今回は対応していませんが、例えばスマホの向きによってアプリのレイアウトを変えたい場合はこの値を使って分岐処理を書けば対応できます。</p><h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>以上が今回のアプリのレイアウト部分に関する解説になります。コメントを除いて38行で書けました。</p><p>同じレイアウトをUICollectionViewLayoutのカスタムクラスで実現しようとしたらかなりの行数・難易度になるのではないでしょうか。item・group・sectionの理解さえすれば私のような初学者でも簡易かつシンプルに実装できるので、今後のiOSアプリ開発でどんどん採用されていくのではと思います。</p><p>その際の参考になれば幸いです！</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;"><a href="https://github.com/kishikawakatsumi/IBPCollectionViewCompositionalLayout" target="_blank" rel="noopener">https://github.com/kishikawakatsumi/IBPCollectionViewCompositionalLayout</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;"><a href="https://developer.apple.com/videos/play/wwdc2019/215/" target="_blank" rel="noopener">https://developer.apple.com/videos/play/wwdc2019/215/</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;"><a href="https://qiita.com/shiz/items/a6032543a237bf2e1d19#%E8%83%8C%E6%99%AF%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E6%99%82%E4%BB%A3%E3%81%AE%E5%A4%89%E5%8C%96" target="_blank" rel="noopener">https://qiita.com/shiz/items/a6032543a237bf2e1d19#%E8%83%8C%E6%99%AF%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E6%99%82%E4%BB%A3%E3%81%AE%E5%A4%89%E5%8C%96</a></span><a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">4.</span><span style="display: inline-block; vertical-align: top;"><a href="https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199059-fractionalwidth" target="_blank" rel="noopener">https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199059-fractionalwidth</a></span><a href="#fnref:4" rev="footnote"> ↩</a></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">5.</span><span style="display: inline-block; vertical-align: top;"><a href="https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199057-estimated" target="_blank" rel="noopener">https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199057-estimated</a></span><a href="#fnref:5" rev="footnote"> ↩</a></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">6.</span><span style="display: inline-block; vertical-align: top;"><a href="https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout" target="_blank" rel="noopener">https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout</a></span><a href="#fnref:6" rev="footnote"> ↩</a></li><li id="fn:7"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">7.</span><span style="display: inline-block; vertical-align: top;"><a href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/using_collection_view_compositional_layouts_and_diffable_data_sources" target="_blank" rel="noopener">https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/using_collection_view_compositional_layouts_and_diffable_data_sources</a></span><a href="#fnref:7" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;の第13弾です。&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; t
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="アプリ" scheme="https://future-architect.github.io/tags/%E3%82%A2%E3%83%97%E3%83%AA/"/>
    
      <category term="Swift" scheme="https://future-architect.github.io/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り 🌸#12 レシートで学ぶデータモデリング入門</title>
    <link href="https://future-architect.github.io/articles/20200616/"/>
    <id>https://future-architect.github.io/articles/20200616/</id>
    <published>2020-06-16T01:22:22.000Z</published>
    <updated>2020-06-29T01:49:21.699Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>の第12弾です。</p><h1 id="自己紹介"><a href="#自己紹介" class="headerlink" title="自己紹介"></a>自己紹介</h1><p>こんにちは、TIGメディアユニットチームの川島です。</p><p>私は新卒でフューチャーに入社後、基幹系システム刷新PJのDBAからキャリアをスタートしました。その後、小売業の店舗システム刷新PJなど複数のPJで企画フェーズから導入フェーズまで幅広く経験し、現在は、人材サービス企業のクライアントの全社データ活用PJでコンサルティング業務を主として担当しています。</p><p>RDBMSについては論理から物理まで一通り経験していて、データに関わるところは強みがあると思っています。</p><h1 id="記事の背景"><a href="#記事の背景" class="headerlink" title="記事の背景"></a>記事の背景</h1><p>DB設計のデータモデリング入門として、コンビニのレシートを使ったDB設計をやっていきます。</p><p>DB設計はよく物理と論理の両面があると言われますが、今回は論理設計について扱います。</p><p>論理設計の基本はモデリングの技法にあります。モデリングは、設計する人以外必要ないのでは？と思われがちですが、ソフトウェア開発する上でも、または上流フェーズでシステムやサービスの提案をしていく上でも重要なスキルになります。なぜなら、モデリングはその名の通り現実を抽象化して、扱いやすい形式に起こして、他者に伝達する手法だからです。これはITエンジニアやITコンサルタント（ITプロフェッショナル）のコミュニケーションスキルの基本ともいえる部分でもあります。ただし、モデリングというととっつきづらく難しい要素もあるので、特別な道具立てもなく、身近なモノからできる例としてレシートを題材にDB設計することをやっていきたいと思います。具体的に、実務で使える内容ではないですが、ITプロフェッショナルとしての力を鍛える「素振り」と思って、取り組んでいただければ幸いです。</p><p>よりよいテーブルの設計については、今回の入門記事シリーズでも取り扱っています。ぜひそちらも合わせて勉強してみてください。<br><a href="https://future-architect.github.io/articles/20200605/">春の入門祭り 🌸 #05　データベース　テーブル設計入門</a></p><h1 id="記事の対象読者"><a href="#記事の対象読者" class="headerlink" title="記事の対象読者"></a>記事の対象読者</h1><p>対象は、新人エンジニア・ITコンサルタントを想定しています。</p><h1 id="題材"><a href="#題材" class="headerlink" title="題材"></a>題材</h1><p>今回の題材は、某コンビニエンスストアのレシートを使います。</p><p>毎日のように、みなさんが見ているものだと思いますが、このような身近なものにもIT技術が使われており、当然データを格納するDBがあります。DB設計のトレーニングとして身近な帳票（レシートや請求書など、データの印刷されたもの）から、それらを支えるインフラ技術や、プログラムソースコード、DBの設計などを想像することは良い手段です。</p><h2 id="レシート"><a href="#レシート" class="headerlink" title="レシート"></a>レシート</h2><img src="/images/20200616/1.jpg" class="img-middle-size"><h2 id="イベント（出来事）を見つける"><a href="#イベント（出来事）を見つける" class="headerlink" title="イベント（出来事）を見つける"></a>イベント（出来事）を見つける</h2><p>まずは、このレシートが表す主要な「出来事」を見出しましょう。難しく考えず、この紙が表現している行為は何かを考えてみましょう。</p><p>大きく領収書と書かれていますね。</p><p>そうすると、「領収」とか「購入」とかが思い浮かびますが、システムの所有者はコンビニエンスストア側であるので、主語はお店の側とします。すると販売とか売上になりますが、今回は売上にしましょう。</p><img src="/images/20200616/2.png" class="img-small-size"><p>イベント系データは、トランザクションと言われることもあります。企業のビジネスはこのようなトランザクションの連なりと積み重ねで成り立っています。人間の体でいうと、血液のようなものです。</p><h2 id="リソース（資源）を見つける"><a href="#リソース（資源）を見つける" class="headerlink" title="リソース（資源）を見つける"></a>リソース（資源）を見つける</h2><p>次に、売上をあげるにあたって、「誰に」「何を」という部分がないと売上という行為は完結しません。</p><p>6W2Hでもれなくダブりなくデータの種類を書き出してみましょう。（5W1HにWhom、How Muchを加えた6W2Hを使うとよりもれなくダブりなく物事をとらえることができるのでおすすめです）</p><ul><li>Who（誰が）・・販売店、責任者</li><li>When・・販売日時</li><li>What（何を）・・商品</li><li>Whom（誰に）・・会員（顧客）</li><li>Where（どこで）・・レジ</li><li>Why（なぜ）・・とくになし</li><li>How（どのように）・・決済手段</li><li>How Much（いくらで）・・商品価格、消費税、還元ポイント</li></ul><p>全部扱うのは大変なので、 <strong>今回は一部の商品と顧客と価格、消費税について扱います</strong>。他のリソースについてもみなさんもぜひ考えてみてください。</p><p>価格と消費税（率）は商品の一部といえるので、リソースとしてはいったん商品と顧客を書き出します。</p><img src="/images/20200616/3.png" class="img-middle-size"><p>リソース系データは、マスタと言われることもあります。トランザクションが血液なら、マスタは企業のビジネスの骨格をなす部分です。<br>骨格のつくりがおかしいと人間がうまく背が伸びなくなるように、企業のビジネスの成長のボトルネックにもなりかねない部分なのでこの設計は非常に重要です。</p><h2 id="項目を入れる"><a href="#項目を入れる" class="headerlink" title="項目を入れる"></a>項目を入れる</h2><p>データの箱を用意したら、次は項目を入れていきましょう。</p><p>顧客には、コンビニエンスストアからセール情報などを郵送することを想定して、氏名と住所を入れます。<br>商品には、商品名と価格、税率を入れます。売上には、販売数を入れます。商品と顧客も入れるべきですが、のちのち入れていきます。</p><img src="/images/20200616/4.png" class="img-middle-size"><p>税金についてはよくみると、10%対象と8％対象のものがあります。軽減税率制度ですね。</p><p>食料品は8%、それ以外は10%対象になっています。商品マスタ上で、分類があると考えます。消費税は数年後には変わっていくものなので、商品マスタにもっていると変更するのが大変です。なので、税対象カテゴリという新しいテーブルを追加して管理することにしましょう。</p><p>※実用的には、有効期間を設定してある日を過ぎたときから税率が変わるようにすることがあります。ちょうどよい参考文献があるので、末尾に記載します。</p><img src="/images/20200616/5.png"><h2 id="リレーションシップを設定する"><a href="#リレーションシップを設定する" class="headerlink" title="リレーションシップを設定する"></a>リレーションシップを設定する</h2><p>次にテーブル同士の関係性を設定していきます（リレーション）。</p><p>関係性を設定するまえに、各テーブルのデータを一意に表すPK（主キー）を設定します。<br>PKとして空欄にしていた部分に、IDを設定します。</p><p>この主キーに特定の項目を設定し意味をもたせると、その意味が変わったときに他のテーブルとのリレーションが変わってしまいます。そのため、機械的に○○IDもしくは○○コードなどと設定するのが妥当です。具体的には、商品マスタにおいて、商品名はそのデータを一意に表すと自然に考えられます（ナチュラルキー）が、あえて代理のキー（サロゲートキー）を設定して、意味に依存しない形にします。</p><img src="/images/20200616/6.png"><p>そして、各テーブルを関連付ける、FK（外部キー）を設定することでリレーションシップはいったん完成です。<br><img src="/images/20200616/7.png"></p><h2 id="点検する"><a href="#点検する" class="headerlink" title="点検する"></a>点検する</h2><p>作成したモデルが現実をきちんと表現しているか点検をしましょう。出来上がったテーブルとリレーション（ERD)を見て、最初のレシートに立ち戻ってみましょう。</p><p>すると、このERDでは1つの売上で1種類の商品、1人の顧客しか扱えないことがわかります。1売上1顧客は良いとして、1売上で複数の商品があるのは自然なので、修正して売上テーブルを分割することを考えます。<br>売上明細というテーブルを作成します。</p><img src="/images/20200616/8.png"><p>（注）FKが一部間違っていたので修正しました 6/16</p><p>今回は省きますが、加えて以下もやってみると理解が深まるでしょう。</p><ul><li>DDL（CREATE TABLE）を書いてテーブルをRDB（PostgreSQL,MySQL,Oracleなど）上に作成してみる</li><li>テーブルに実データを入れてみる（事前にExcelなどで表を書いてみるのをおすすめします）</li><li>SQLを書いて実行してみる</li></ul><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>データモデルのポイントは以下のとおりです。</p><ul><li>イベントを見つける</li><li>リソースを見つける（6W2Hでもれなくダブりなく）</li><li>項目を入れる</li><li>リレーションシップを設定する</li><li>点検する（モデルが現実を表現しているか）</li></ul><p>今回はITプロフェッショナルとしての「素振りの仕方」をご紹介しました。<br>日頃、目にするデータから設計をする練習をして、本番の仕事のため（試合）に備えましょう。</p><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://www.amazon.co.jp/dp/4798110663" target="_blank" rel="noopener">楽々ERDレッスン (CodeZine BOOKS) (株)スターロジック 羽生 章洋 著</a><br>レシート（帳票）からERDをつくるというアイデアはここからもらっています。DB設計の基本が書かれている良書です。</p><p><a href="https://sikushima.hatenablog.com/entry/2020/06/09/113306" target="_blank" rel="noopener">SQLで消費税の計算</a><br>マスタへの有効期間の設定・SQLの書き方など、実用的な内容が詳細に書かれています。もう一歩踏み込みたい人は読んでみてください。</p><p><a href="https://www.amazon.co.jp/dp/B07TPYY3K1" target="_blank" rel="noopener">業務システムのための上流工程入門 渡辺幸三 著</a><br>DB設計はお客さんとあるべきシステムのイメージの合意をとりながら進めていくものです。データ指向設計の手法が、ロールプレイング形式で具体的に書かれています。上流工程に興味のある人は読んでみてください。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;の第12弾です。&lt;/p&gt;
&lt;h1 id=&quot;自己紹介&quot;&gt;&lt;a href=&quot;#自己紹介&quot; class=&quot;headerlink&quot; t
      
    
    </summary>
    
    
      <category term="DB" scheme="https://future-architect.github.io/categories/DB/"/>
    
    
      <category term="DB" scheme="https://future-architect.github.io/tags/DB/"/>
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
      <category term="DataModel" scheme="https://future-architect.github.io/tags/DataModel/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #11 Kaggle入門</title>
    <link href="https://future-architect.github.io/articles/20200615/"/>
    <id>https://future-architect.github.io/articles/20200615/</id>
    <published>2020-06-15T01:48:52.000Z</published>
    <updated>2020-06-23T06:04:21.221Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>の第11弾です</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIGの伊藤真彦です、<a href="https://future-architect.github.io/articles/20200612/">第10弾</a>に続いての投稿です。</p><p>フューチャーではAI教育・認定のオリジナルプログラム<a href="https://prtimes.jp/main/html/rd/p/000000363.000004374.html" target="_blank" rel="noopener">Future AI Certification</a>が実施されています。私も入社早々に本プログラムでGoogle Colaboratoryを用いてノートブック形式でのドキュメントを作成、実行する形での学習しました。入社以前からAI関連の技術に興味を持っており、AWSの機械学習認定資格に合格するなど勉強していたので、とても嬉しかったです。</p><p>このFuture AI Certificationプログラムで学習した勢いで、この度<a href="https://www.kaggle.com/" target="_blank" rel="noopener">Kaggle</a>にチャレンジしてみました。</p><h2 id="この記事の内容"><a href="#この記事の内容" class="headerlink" title="この記事の内容"></a>この記事の内容</h2><p>実際にKaggleに挑戦する上で自分が知りたかったこと、やってみたことを書いていきます。</p><h2 id="kaggleとは"><a href="#kaggleとは" class="headerlink" title="kaggleとは"></a>kaggleとは</h2><img src="/images/20200615/photo_20200615_01.png"><blockquote><p>Kaggleは企業や研究者がデータを投稿し、世界中の統計家やデータ分析家がその最適モデルを競い合う、予測モデリング及び分析手法関連プラットフォーム及びその運営会社である。<br>– <a href="https://ja.wikipedia.org/wiki/Kaggle" target="_blank" rel="noopener">wikipedia</a>より</p></blockquote><p>Kaggleは機械学習のモデルを作成・共有し、その機械学習モデルの精度を競い合うプラットフォームです。環境構築不要で機械学習を学習できるだけでなく、賞金付きのコンペティションで上級者が鎬を削り合うような場所でもあります。</p><p>まずは<a href="https://www.kaggle.com/account/login" target="_blank" rel="noopener">アカウント登録</a>が第一歩です。</p><h2 id="タイタニック問題に挑む"><a href="#タイタニック問題に挑む" class="headerlink" title="タイタニック問題に挑む"></a>タイタニック問題に挑む</h2><img src="/images/20200615/2.jpg"><p>アカウントを登録したら次に何をするか？</p><p>いきなり賞金つきコンペティションに突撃する事も可能ですが、初心者向けの学習用コンテンツがあるので、まずそれに参加して流れを掴んでいきます。</p><p>定番の問題として「タイタニック問題」と呼ばれている問題があります。「タイタニック」とは1912年に沈没した豪華客船のタイタニック号のことです。映画にもなったのでご存じですよね、と言いたいところですが映画の初公開は１９９７年、そろそろ映画を見た事がない人が入社しても不思議ではないですね。</p><p>タイタニックと機械学習のどこに接点があるかと言うと、Kaggleではタイタニック号の乗客の年齢、性別、客室番号などの各種データと、生存、死亡のデータがcsvファイルにまとめられています。このcsvから学習して、各種データから乗客の生存・死亡を推論する機械学習モデルを作成する事が初心者向けの課題として用意されています。</p><p>アカウントを登録したら、タイタニック問題に挑戦するのが定番の流れです。</p><h2 id="実際の作業"><a href="#実際の作業" class="headerlink" title="実際の作業"></a>実際の作業</h2><p>コンペティションに参加登録をしたら、実際に機械学習モデルを作成していきます。</p><p>とはいえ機械学習のことはよくわからないし、何をどうしたら課題を達成できるのか…と、初心者の方は思うのではないでしょうか。</p><p>Kaggleでは他の参加者のノートブック形式での成果物が公開されているので、極論公開されているコードを写していくだけで課題の提出が可能です。</p><img src="/images/20200615/3.jpg" style="border:solid 1px #000000"><p>最初は写経のような形で公開されているソースコードを読み解いていくと良いと思います。</p><h2 id="学習のために"><a href="#学習のために" class="headerlink" title="学習のために"></a>学習のために</h2><p>機械学習のモデル作成では、以下の流れでソースコードを記述していきます。(csvデータを読み込んで推論を行う、いわゆるテーブルコンペと呼ばれる形式の話で、例えば画像を取り扱うような問題では違った流れになります)</p><ol><li>csvデータを読み込む</li><li>データの欠損値を補完する、機械学習モデルが読み込める形にデータを変換する。</li><li>整理したデータで機械学習モデルを学習させる。</li><li>作成したモデルでテストデータを推論、提出用のデータを生成、保存する</li></ol><p>公開されているソースコードは、ランキングの上位に食い込むためにさまざまな工夫が行われています。また、データエンジニアリングの内容や根拠を説明するためにデータをグラフとして表現するコードも各々のスタイルで記載されています。いきなりこれら工夫満載の成果物を見ても理解が難しいと思います。</p><p>私は「<a href="https://www.kspub.co.jp/book/detail/5190067.html" target="_blank" rel="noopener">PythonではじめるKaggleスタートブック</a>」という書籍を購入しました。</p><p>この記事の結論はオススメ書籍の紹介になります。この本ではタイタニック問題を回答できるようになることが目的の一つとなっており、実際にタイタニック問題に対して提出可能なソースコードが、最低限の素朴な実装の段階から、精度を上げていくための工夫まで、Python初心者レベルの人でもわかるよう一行ずつ丁寧に説明されています。</p><p>この本のおかげで学習がかなり楽になりました。こういう知識はやはり書籍の形式で体系的に学ぶのが楽ですね。あとKaggleは基本的に英語なので…ただでさえ難しいものを英語で学習するのは辛いものがあります。日本語で学べる教材という意味でも良かったです。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><ol><li>まずはアカウントを登録しよう</li><li>タイタニック問題にチャレンジ</li><li>公開されているコードから学んでいこう</li><li>効率よく学ぶためには本を買うのがおススメ</li></ol><p>といったお話でした。</p><p>きちんと理解しようとすると一問に費やす時間が数日単位でかかり、結構大変なのですが、Kaggleを通して機械学習の流れが具体的にわかるようになってきました。</p><p>Kaggleは無料でできるので、ぜひ挑戦してみてください。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;の第11弾です&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
      <category term="DataScience" scheme="https://future-architect.github.io/categories/DataScience/"/>
    
    
      <category term="競技プログラミング" scheme="https://future-architect.github.io/tags/%E7%AB%B6%E6%8A%80%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/"/>
    
      <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
      <category term="Kaggle" scheme="https://future-architect.github.io/tags/Kaggle/"/>
    
  </entry>
  
  <entry>
    <title>フューチャーの新人研修後の配属先にかける新人の思いを歌ってみた</title>
    <link href="https://future-architect.github.io/articles/20200613/"/>
    <id>https://future-architect.github.io/articles/20200613/</id>
    <published>2020-06-13T05:20:17.000Z</published>
    <updated>2020-06-24T06:49:14.969Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200613/top.png" class="img-middle-size"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、フューチャー株式会社の井上拓です。</p><p>Strategic AI Groupというチームで、AIをはじめとするテクノロジーを核としながら、時にお客様と、時に自社主体で、新しいビジネスをデザインする活動に取り組んでいます。</p><p>６月、関東も梅雨入りし、IT企業各社で研修修了した新人たちが現場に配属される時期ではないでしょうか。私の所属するフューチャー株式会社でも修了・配属に向けたお知らせがあり、フレッシュなパワーへの期待に胸を寄せています。</p><p>フューチャーの新人研修は<a href="https://note.future.co.jp/n/nc3982a6a127f" target="_blank" rel="noopener">未来報で公開</a>されているように、<strong>人間嫌い</strong>の現場のITコンサルタントが研修リーダーになったり、実力次第で早期卒業ができたり、2020年はフルリモートだったりと、毎回の試行錯誤と改善を繰り返して行われています。</p><p>特徴的なのは、<strong>年に複数回の入社タイミング</strong> があることでしょうか。春入社に比べて夏・秋入社は個性（クセ）が強いという非科学的な迷信が社内にあったりします。<strong>不思議</strong> ですね。</p><h1 id="“配属”というドラマ"><a href="#“配属”というドラマ" class="headerlink" title="“配属”というドラマ"></a>“配属”というドラマ</h1><p>新人研修で特にドラマが生まれる出来事は <strong>配属（プロジェクトアサイン）</strong> でしょう。</p><p>新人にとっても一番気になる配属先。フューチャーには様々な部署やプロジェクトがあります。大規模/小規模、ビジネス寄り/テクノロジー寄り、といったとても白黒ハッキリした情報をもとに、どこどこのチームに行きたいと新人自ら希望をあげ、配属候補先のリーダが受け入れを検討したりします。先輩社員からすると、配属先はあくまでスタート位置に過ぎず、そこからいくらでも志向・関心は変化するし、成長すると考えています。しかし、新人さんからすると死活問題。中にはダイレクトに配属先のリーダーにアポイントメントを取ってヒューマンハックする技巧派な方もいます。</p><p>つい先日、配属を控えた <strong>とある新人エンジニアの強い思い</strong> に心を動かされ、私が新人だった10年以上前のことを振り返り、<strong>配属にかける思いをオリジナルソングにしてみました</strong> 。すべてのIT企業で、どこか共感できるポイントがあるのではないかと考え、こちらで公開させていただくことにしました。</p><p>いつか新人だった、エンジニアの皆さんに聞いていただければ幸いです。</p><h1 id="「配属前夜」-歌"><a href="#「配属前夜」-歌" class="headerlink" title="「配属前夜」- 歌"></a>「配属前夜」- 歌</h1><iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/839551090&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe><div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;"><a href="https://soundcloud.com/nukkq649asbw" title="拓" target="_blank" style="color: #cccccc; text-decoration: none;">拓</a> · <a href="https://soundcloud.com/nukkq649asbw/bpcyfoujejjf" title="配属前夜" target="_blank" style="color: #cccccc; text-decoration: none;">配属前夜</a></div><p><a href="https://soundcloud.com/nukkq649asbw/bpcyfoujejjf" target="_blank" rel="noopener">配属前夜</a> ※SoundCloudリンク</p><h1 id="「配属前夜」-歌詞"><a href="#「配属前夜」-歌詞" class="headerlink" title="「配属前夜」- 歌詞"></a>「配属前夜」- 歌詞</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">二者択一が僕らの全部だった</span><br><span class="line">大規模か小規模か 業務か技術か</span><br><span class="line">こだわり屋の同期は 右左 白黒はっきりしてた</span><br><span class="line">「市場価値がすべてだ」と</span><br><span class="line"></span><br><span class="line">新人研修が終わり</span><br><span class="line">配属先が伝えられる</span><br><span class="line">どこに選ばれるかで</span><br><span class="line">人生決まると本気で信じてた</span><br><span class="line"></span><br><span class="line">配属前夜にメモった</span><br><span class="line">「やりたくないな」リストは</span><br><span class="line">その後マルがついていくたびに</span><br><span class="line">できることが増えてった</span><br><span class="line"></span><br><span class="line">配属前夜によぎった</span><br><span class="line">「いきたくない」ポジションで</span><br><span class="line">出会った人たちに いまも</span><br><span class="line">助けられてここにいる</span><br><span class="line"></span><br><span class="line">目新しさばかり求める</span><br><span class="line">未熟さに気づかされたのは</span><br><span class="line">この手で書いたソースコードが</span><br><span class="line">社会を支え始めた瞬間だった</span><br><span class="line"></span><br><span class="line">配属前夜にメモった</span><br><span class="line">「必須技術！」のリストは</span><br><span class="line">一年も立たないうちに</span><br><span class="line">時代遅れになってた</span><br><span class="line"></span><br><span class="line">配属前夜にもらった</span><br><span class="line">「役に立つコマンド」は</span><br><span class="line">一年も立たないうちに</span><br><span class="line">そらで打つようになってた</span><br><span class="line"></span><br><span class="line">配属前夜に感じた</span><br><span class="line">開発の面白さは</span><br><span class="line">散々な目にあった今でも</span><br><span class="line">やっぱり感じてる</span><br><span class="line"></span><br><span class="line">配属前夜に誓った</span><br><span class="line">「なしとげたいこと」はまだ</span><br><span class="line">10年たったいまでも</span><br><span class="line">変わらないでここにある</span><br></pre></td></tr></table></figure><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>どこに配属されたとしても、テクノロジーを楽しむことで必ず成長して、やりたいことができるようになる。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200613/top.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;
      
    
    </summary>
    
    
      <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
      <category term="応援歌" scheme="https://future-architect.github.io/tags/%E5%BF%9C%E6%8F%B4%E6%AD%8C/"/>
    
      <category term="新人研修" scheme="https://future-architect.github.io/tags/%E6%96%B0%E4%BA%BA%E7%A0%94%E4%BF%AE/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #10 denoに触れてみよう</title>
    <link href="https://future-architect.github.io/articles/20200612/"/>
    <id>https://future-architect.github.io/articles/20200612/</id>
    <published>2020-06-12T03:06:07.000Z</published>
    <updated>2020-06-29T01:49:45.903Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>🌸の第10弾です</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>6月よりTIGに入社した伊藤真彦です。入社時点ですでに春の入門祭りは始まっていたのですが、この度飛び入り参加で技術ブログを書かせていただける運びとなりました。</p><p>さて、初投稿として選んだテーマはdenoです。deno1.0のリリースからしばらくたちましたが、転職の合間に触って遊ぶことができましたので、体験記として紹介させていただきます。</p><h2 id="この記事の内容"><a href="#この記事の内容" class="headerlink" title="この記事の内容"></a>この記事の内容</h2><p>ただdenoをインストールして、hello worldのサンプルを動かすだけでは今から掲載するものとしては面白みに欠けるので、</p><p><strong>1. docker上にインストールする</strong><br><strong>2. HTMLファイルを読みこんでレンダリングする</strong></p><p>をゴールとします。</p><h2 id="ファイルを用意しよう"><a href="#ファイルを用意しよう" class="headerlink" title="ファイルを用意しよう"></a>ファイルを用意しよう</h2><p>今回必要なファイルは4種類です。</p><ol><li><strong>Dockerfile</strong></li><li><strong>docker-compose.yml</strong></li><li><strong>main.ts</strong></li><li><strong>hello.html</strong></li></ol><p>手始めに<code>Dockerfile</code>と<code>docker-compose.yml</code>を用意します、ubuntuに突っ込む形をとりました。<br>コンテナ向きなミニマムなOSにしても良かったかもしれないです。<br>deno公式dockerイメージを作ろうぜ、みたいなissueを見た覚えがあるので、<code>FROM deno</code>とか1行書けば終わる日が来ることに期待します。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="comment"># deno導入シェルの実行&amp;必要なライブラリをインストール、インストール完了後に削除</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get -qq update &amp;&amp; apt-get -qq -y install curl zip unzip \</span></span><br><span class="line"><span class="bash">  &amp;&amp; curl -fsSL https://deno.land/x/install/install.sh | sh \</span></span><br><span class="line"><span class="bash">  &amp;&amp; apt-get remove curl zip unzip</span></span><br><span class="line"><span class="comment"># pathを通す</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'export DENO_INSTALL="/root/.deno"'</span> &gt;&gt; ~/.bash_profile</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'export PATH="$DENO_INSTALL/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">vendor:</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">bash</span> <span class="string">-c</span> <span class="string">"source ~/.bash_profile &amp;&amp; deno run --allow-net --allow-read app/main.ts"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8000:8000"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/app</span></span><br></pre></td></tr></table></figure><p>執筆時点ではdenoは公式に記載の方法でインストールした後に手動でパスを通す必要があるので、その辺の作業をコンテナのビルド&amp;起動時に行うのがミソです。<br>単にインストールを行うシェルを実行しただけではパスが通らずdenoコマンドが使えるようになりませんので注意。<br>(docker-composeの環境変数に書いてみるとかいろいろ試しつつ、うまく動くものをフィーリングで書いています、もう少しスマートな方法があるかもしれません)</p><p>denoコマンドのオプションはそれぞれ以下の意味です。<br><code>--allow-net:</code> サーバーとして動かす上で通信を許可するオプション<br><code>--allow-read:</code> HTMLファイルをdenoに探してもらう権限を与えるオプション</p><p>続いてサーバーを立ち上げるメインのTypeScriptと読みこみを行うHTMLを作成します。<br>メインのスクリプトはjsにちょっと型定義を付け足しただけの素朴なTypeScriptです。<br>ちなみにフューチャーには<a href="https://future-architect.github.io/typescript-guide/">TypeScriptに関する公式ガイド</a>があります、ぜひ確認してみてください。</p><p>今回はstdライブラリの<code>readFileStr</code>でHTMLファイルを読んでみました。<br>正直この方法が正解か、他に方法があるのか自信がありませんが、そのうちフロントエンドライブラリが導入されて根本から使い方が変わっていくと思います、自由にやっていきましょう。</p><figure class="highlight ts"><figcaption><span>main.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; serve &#125; <span class="keyword">from</span> <span class="string">"https://deno.land/std@0.50.0/http/server.ts"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; readFileStr &#125; <span class="keyword">from</span> <span class="string">'https://deno.land/std@0.53.0/fs/read_file_str.ts'</span>;</span><br><span class="line"><span class="keyword">const</span> s: <span class="built_in">any</span> = serve(&#123; port: <span class="number">8000</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> template: <span class="built_in">string</span> = <span class="keyword">await</span> readFileStr(<span class="string">"app/html/hello.html"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"server starting on http://localhost:8000/\nCtrl-C to shutdown container"</span>);</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">const</span> req of s) &#123;</span><br><span class="line">  req.respond(&#123; body: template &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HTMLもとてもシンプルですが、style要素が正常に動くかを見てみたかったので文字色を赤くしてみます。</p><figure class="highlight html"><figcaption><span>hello.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"message"</span>&gt;</span>Hello Deno with Html<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.message</span>&#123;</span></span><br><span class="line">    color: red;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上記4つのファイルを下記の構成で配置します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HelloDeno(好きなフォルダ名)</span><br><span class="line">├ app</span><br><span class="line">│ ├ html</span><br><span class="line">│ │ └ hello.html</span><br><span class="line">│ └ main.ts</span><br><span class="line">├ Dockerfile</span><br><span class="line">└ docker-compose.yml</span><br></pre></td></tr></table></figure><p>HTMLはpublic配下に置くべし、という意見もあるかもしれません。<br>今回は前職でお世話になったRuby On Railsの設計思想を引きずっており、MVCに属するものはapp配下に設置しました。<br>気が向いたらhtmlディレクトリの配下に複数のファイルを配置して拡張していくつもりで、このような構成になっています。<br><code>main.tsの</code>HTML読み込み処理のパスを書き換えるだけで自由な構成にできるので、お好きなようにカスタマイズしてみてください。</p><h2 id="起動"><a href="#起動" class="headerlink" title="起動"></a>起動</h2><p>必要なファイルを準備できたら <code>docker-compose up</code> で起動します<br><img src="/images/20200612/photo_20200612_01.png"></p><p>ライブラリのダウンロード、コンパイルを経てサーバーが立ち上がります。<br><code>console.log(&quot;server starting on http://localhost:8000/\nCtrl-C to shutdown container&quot;);</code><br>で書いた内容がコンパイルが完了し、動いたタイミングで吐き出されています。<br>書かなくても動きますが、何かログ出力しておいた方が正常に動いているのか判定しやすいです。</p><p>無事に起動出来たらブラウザで<code>localhost:8000</code>にアクセスしましょう。<br>HTMLの内容が正常に表示されました!</p><img src="/images/20200612/photo_20200612_02.png"  style="border:solid 1px #000000" ><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>現状テンプレやお作法がそれほど世の中に出回っていないので、<a href="https://deno.land/" target="_blank" rel="noopener">deno公式</a>から使えそうなAPIやライブラリを探索しながら模索してみました。</p><p>HTMLファイルを取得して表示させることすら手探りな感じが黎明期を感じさせます。もう少し情報を漁ってベストな方法を探したり、フレームワークが誕生or参入してきたらこの記事に書いている手法は無意味になりそうですが、取り敢えず触ってみましたよ、以上、というお話なのでその辺はご容赦ください。</p><p>今後の発展が楽しみですね。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><ul><li><a href="/articles/20200512/">日本製HeadlessCMSのmicroCMSを触ってみた</a></li><li><a href="/articles/20200511/">PJでUIデザインにAtomic Designを導入したらどうだったのか</a></li><li><a href="/articles/20200501/">TypeScriptでReactをやるときは、小さいアプリでもReduxを最初から使ってもいいかもねというお話</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;🌸の第10弾です&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="Frontend" scheme="https://future-architect.github.io/tags/Frontend/"/>
    
      <category term="deno" scheme="https://future-architect.github.io/tags/deno/"/>
    
      <category term="Node.js" scheme="https://future-architect.github.io/tags/Node-js/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #9 Grep, Git grepの便利オプション</title>
    <link href="https://future-architect.github.io/articles/20200611/"/>
    <id>https://future-architect.github.io/articles/20200611/</id>
    <published>2020-06-11T00:53:08.000Z</published>
    <updated>2020-06-29T01:49:43.463Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200611/top.png"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、TIGメディアユニット岸本卓也です。普段の業務ではアプリ領域を担当しており、JavaやJSと戯れつつ日々を過ごしています。</p><p>私は最近プロジェクトが変わり、キャッチアップを進めています。その中でソースコードを検索するために、IDEの検索機能以外に <code>grep</code> や <code>git grep</code> を使いました。そこでよく使った・または便利だったオプションを紹介します。</p><p>なお、Windowsでは初期状態ではgrepコマンドがありませんが、インストールする方法はいくつかあります。gitを使うためにインストールするGit for WindowsのGit Bashでもgrepコマンドが使えますので、Windowsユーザーの方はお試しください。</p><h1 id="grepの基本"><a href="#grepの基本" class="headerlink" title="grepの基本"></a>grepの基本</h1><p>grepは指定された検索パターンに一致する部分を検索するコマンドラインプログラムです。次の形式で実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド実行形式</span></span><br><span class="line">grep [オプション...] [検索パターン] [検索対象のファイル...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: sample.txtファイルの中からFutureという文字列を含む行を検索する。</span></span><br><span class="line">grep <span class="string">'Future'</span> sample.txt</span><br></pre></td></tr></table></figure><p>このように検索パターン (≒検索したい文字列) と検索対象のファイルを指定して実行すると、検索パターンにマッチする行がコンソールに出力されます。</p><p>検索対象のファイルが複数ある場合は、次のようにファイルを列挙します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 複数のファイルを対象に検索する。</span></span><br><span class="line">grep <span class="string">'Future'</span> sample.txt sample2.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: ワイルドカードで複数ファイルを指定する。</span></span><br><span class="line">grep <span class="string">'Future'</span> *</span><br></pre></td></tr></table></figure><h1 id="検索パターン"><a href="#検索パターン" class="headerlink" title="検索パターン"></a>検索パターン</h1><p>grepの検索パターンには正規表現を使うことができ、正規表現を使うことで非常に強力な検索ができます。正規表現は検索パターンを表現する特殊な文字列で、ワイルドカードのようなものです。</p><p>正規表現には普通の文字とメタ文字 (=特別な意味を持つ文字) があるので、ここではメタ文字の内よく使うものを紹介します。よく使う順に記載します。</p><ul><li>任意の1文字: <code>.</code> (ドット)</li><li>量指定子: その直前の文字が何回繰り返すかを指定します。<ul><li>0回以上: <code>*</code></li><li>1回以上: <code>+</code></li><li>0回または1回: <code>?</code></li><li>n回: <code>{n}</code></li></ul></li><li>アンカー: 行頭または行末にマッチします。<ul><li>行頭: <code>^</code></li><li>行末: <code>$</code></li></ul></li><li>エスケープ: <code>\</code> メタ文字を普通の文字として指定したい場合にメタ文字の直前に指定します。</li><li>ブラケット式: <code>[]</code> []で囲んだ中に指定した文字のいずれか1文字を表します。文字を列挙する以外に <code>-</code> (ハイフン) を使った範囲指定も可能です。</li><li>部分式 (グループ)、後方参照<ul><li>部分式 (グループ): <code>()</code> 正規表現の一部を <code>(</code> と <code>)</code> で囲むと部分式 (グループ) を定義できます。</li><li>後方参照: <code>\n</code> (grepの場合、nは1～9までの数字) <code>n</code> 番目の部分式にマッチした文字列と同じ文字列にマッチします。</li></ul></li><li>単語の境界: 単語の境界にマッチします。<ul><li>単語の境界: <code>\b</code></li><li>単語の始まり: <code>\&lt;</code></li><li>単語の終わり: <code>\&gt;</code></li></ul></li></ul><p>これらのメタ文字のいくつかを使った正規表現の例は次のとおりです。</p><ul><li><code>Hack.+Future</code>: <code>Hack</code> という文字列に続いて任意の文字が1個以上あり、それに続いて <code>Future</code> という文字列がある部分にマッチします。例えば <code>Hack to the Future</code> にマッチします。</li><li><code>BT{2}F</code>: <code>BTTF</code> という文字列にマッチします。</li><li><code>Future$</code>: 行末の <code>Future</code> という文字列にマッチします。</li><li><code>[0-9]{4}</code>: 任意の数字が4個続く部分にマッチします。例えば <code>1989</code> にマッチします。</li><li><code>Dr\. [a-zA-Z]+</code>: <code>Dr.</code> という文字列に続いてアルファベットが1文字以上続く部分にマッチします。例えば <code>Dr. Emmett</code> にマッチします。</li><li><code>(\&lt;[bB]uffalo\&gt; ?){8}</code>: <code>buffalo</code> という単語が8回続く文字列にマッチします。例えば <code>Buffalo buffalo Buffalo buffalo buffalo buffalo Buffalo buffalo</code> にマッチします。</li></ul><p>正規表現はgrepに限らずエディタやプログラミング言語など様々な場所で使うことができますが、正規表現の細かな仕様は実装によって結構異なります。したがって、正規表現の詳細は各実装のドキュメントを参照する必要があります。</p><ul><li>Grepの正規表現: <a href="https://www.gnu.org/software/grep/manual/grep.html#Regular-Expressions" target="_blank" rel="noopener">GNU grep manual: 3 Regular Expressions</a><br>Grepの基本正規表現 (BRE)、拡張正規表現 (ERE) はこちらが参考になります。</li><li>Perlの正規表現: <a href="http://perldoc.jp/docs/perl/5.18.1/perlre.pod" target="_blank" rel="noopener">perlre - Perl の正規表現 - perldoc.jp</a><br>grepは <code>-P</code> オプションでPerl互換正規表現 (PCRE) を使うことができますが、その詳細は上記には記載されていません。PCREはこちらが参考になります。</li><li>Javaの正規表現: <a href="https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/util/regex/Pattern.html" target="_blank" rel="noopener">Pattern (Java SE 11 &amp; JDK 11 )</a><br>grepとは関係ありませんが、正規表現のバリエーションの一例です。</li><li>Vimの正規表現: <a href="https://vim-jp.org/vimdoc-ja/pattern.html#pattern-overview" target="_blank" rel="noopener">pattern - Vim日本語ドキュメント</a><br>grepとは関係ありませんが、正規表現のバリエーションの一例です。</li></ul><h1 id="よく使うオプション"><a href="#よく使うオプション" class="headerlink" title="よく使うオプション"></a>よく使うオプション</h1><p>grepには様々なオプションがあり、オプションを指定することで検索動作を変えることができます。ここではそのオプションの内よく使うものを紹介します。よく使う順に記載します。</p><h2 id="大文字-小文字の違いを無視-i"><a href="#大文字-小文字の違いを無視-i" class="headerlink" title="大文字/小文字の違いを無視: -i"></a>大文字/小文字の違いを無視: <code>-i</code></h2><p>grepはデフォルトでは大文字/小文字も含めて厳密に一致する文字を検索するため、検索パターン <code>future</code> は文字列 <code>Future</code> にマッチしません。 <code>-i</code> を指定すると大文字/小文字の違いを無視して検索するため、 <code>Future</code> にもマッチします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: futureにマッチするが、Futureにはマッチしない。</span></span><br><span class="line">grep <span class="string">'future'</span> sample.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: future, Futureどちらにもマッチする。</span></span><br><span class="line">grep -i <span class="string">'future'</span> sample.txt</span><br></pre></td></tr></table></figure><p>大文字/小文字の違いを無視して広めに検索したい時によく使います。</p><h2 id="フォルダを再帰的に検索-r"><a href="#フォルダを再帰的に検索-r" class="headerlink" title="フォルダを再帰的に検索: -r"></a>フォルダを再帰的に検索: <code>-r</code></h2><p>前述の通り、検索対象ファイルは複数列挙できますが、フォルダ階層が切られたソースを検索する場合にファイルを1個ずつ指定するのは面倒です。そのような場合に <code>-r</code> オプションとともに検索対象ファイルではなくフォルダを指定すると、指定されたフォルダに存在するファイルと、サブフォルダがあればその中に存在するファイルも再帰的に検索します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: some_dirフォルダから再帰的に、配下に存在するファイルを対象に検索する。</span></span><br><span class="line">grep -r <span class="string">'Future'</span> some_dir/</span><br></pre></td></tr></table></figure><p>なお、フォルダ指定を省略するとカレントディレクトリから検索するため、私はよく <code>grep -ir &#39;future&#39;</code> といった形で使います。</p><h2 id="特定のファイルだけ検索-include"><a href="#特定のファイルだけ検索-include" class="headerlink" title="特定のファイルだけ検索: --include"></a>特定のファイルだけ検索: <code>--include</code></h2><p>フォルダ指定で検索する場合は指定したフォルダ配下のすべてのファイルが検索されますが、これを限定したいことがあります。そのような場合に  <code>--include</code> オプションで検索対象とするファイル名の条件を指定できます。ファイル名の条件にはglobパターンを使えます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: some_dirフォルダから再帰的に、配下に存在する拡張子.vueのファイルを対象に検索する。</span></span><br><span class="line">grep -r --include=<span class="string">'*.vue'</span> <span class="string">'Future'</span> some_dir/</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: 検索対象にしたいファイル名の条件が複数ある場合はオプションを複数回指定する。</span></span><br><span class="line">grep -r --include=<span class="string">'*.vue'</span> --include=<span class="string">'*.js'</span> <span class="string">'Future'</span> some_dir/</span><br></pre></td></tr></table></figure><h2 id="特定のファイル-フォルダを除外-exclude-exclude-dir"><a href="#特定のファイル-フォルダを除外-exclude-exclude-dir" class="headerlink" title="特定のファイル/フォルダを除外: --exclude, --exclude-dir"></a>特定のファイル/フォルダを除外: <code>--exclude</code>, <code>--exclude-dir</code></h2><p>上記とは逆に、検索対象から除外するファイルを指定することもできます。除外するファイル名は <code>--exclude</code> オプション、フォルダ単位で除外するには <code>--exclude-dir</code> オプションで条件を指定でき、どちらもglobパターンを使えます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: some_dirフォルダから再帰的に、配下に存在する拡張子.log以外のファイルを対象に検索する。</span></span><br><span class="line">grep -r --exclude=<span class="string">'*.log'</span> <span class="string">'Future'</span> some_dir/</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: some_dirフォルダから再帰的に、logフォルダ以外の配下に存在するファイルを対象に検索する。</span></span><br><span class="line">grep -r --exclude-dir=<span class="string">'log'</span> <span class="string">'Future'</span> some_dir/</span><br></pre></td></tr></table></figure><h2 id="拡張正規表現を使う-E"><a href="#拡張正規表現を使う-E" class="headerlink" title="拡張正規表現を使う: -E"></a>拡張正規表現を使う: <code>-E</code></h2><p>grepの検索パターンはデフォルトでは基本正規表現 (BRE) として解釈されます。BREでは <code>?</code>, <code>+</code>, <code>{</code>, <code>|</code>, <code>(</code>, <code>)</code> の文字はメタ文字ではなく普通の文字です。BREでこれらをメタ文字として機能させるには <code>\?</code>, <code>\+</code>, <code>\{</code>, <code>\|</code>, <code>\(</code>, <code>\)</code> と指定する必要があります<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>。</p><p>一方、拡張正規表現 (ERE) ではこれらの文字は単体でメタ文字として機能します。したがって、検索パターンによってEREにした方がスッキリ書ける場合は <code>-E</code> オプションを指定することで検索パターンをEREとして解釈させることができます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: BRE</span></span><br><span class="line">grep <span class="string">'[0-9]\&#123;4\&#125;'</span> sample.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: ERE</span></span><br><span class="line">grep -E <span class="string">'[0-9]&#123;4&#125;'</span> sample.txt</span><br></pre></td></tr></table></figure><p> マッチした周辺行も出力: <code>-A num</code>, <code>-B num</code>, <code>-num</code> (<code>-C num</code>)</p><p>検索パターンがどのような状況で使われているか、知りたいことがあります。そのような場合に、マッチした行に加えてその周辺の行を出力するオプションがあります。</p><ul><li>マッチした行の後 num 行も出力: <code>-A num</code></li><li>マッチした行の前 num 行も出力: <code>-B num</code></li><li>マッチした行の前後 num 行も出力: <code>-num</code> (<code>-C num</code>)</li></ul><h2 id="行番号を出力-n"><a href="#行番号を出力-n" class="headerlink" title="行番号を出力: -n"></a>行番号を出力: <code>-n</code></h2><p>行番号が必要であれば <code>-n</code> オプションでマッチした行の行番号を出力できます。</p><h2 id="ファイル名を出力しない-h"><a href="#ファイル名を出力しない-h" class="headerlink" title="ファイル名を出力しない: -h"></a>ファイル名を出力しない: <code>-h</code></h2><p>検索対象のファイルが複数ある場合、デフォルトでは検索結果にファイル名が出力されます。単一ファイルの検索時同様にファイル名なしの出力にするには <code>-h</code> オプションを指定します。</p><p>検索結果をパイプで繋いで処理したい場合によく使います。</p><h2 id="ファイル名だけ出力-l"><a href="#ファイル名だけ出力-l" class="headerlink" title="ファイル名だけ出力: -l"></a>ファイル名だけ出力: <code>-l</code></h2><p>デフォルトでは検索結果にはマッチした行テキストが出力されます。これの代わりにマッチするデータがあるファイル名だけ表示するには <code>-l</code> オプションを指定します。</p><h2 id="文字コードShift-JISのファイルを検索"><a href="#文字コードShift-JISのファイルを検索" class="headerlink" title="文字コードShift_JISのファイルを検索"></a>文字コードShift_JISのファイルを検索</h2><p>grepは文字コードUTF-8のファイルならマルチバイト文字も検索できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 日本語を検索する。</span></span><br><span class="line">grep <span class="string">'フューチャー'</span> sample.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: 絵文字を検索する。</span></span><br><span class="line">grep -P <span class="string">'🤠'</span> sample.txt</span><br></pre></td></tr></table></figure><p>ただ、Windowsにおいては文字コードShift_JISのファイルを相手にすることもまだまだ多いものの、grepは単純にはShift_JISのファイルを検索できません。そのような場合は、次のように文字コードShift_JISの検索パターンを指定すると検索できます。ただし、正規表現が使えません。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 文字コードShift_JISのファイルを対象に検索する。</span></span><br><span class="line">grep -aF $(<span class="built_in">echo</span> <span class="string">'フューチャー'</span> | iconv -t SJIS) sample_sjis.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: 検索結果の文字化けを解消するには、検索結果の文字コードを変換する。</span></span><br><span class="line">grep -aF $(<span class="built_in">echo</span> <span class="string">'フューチャー'</span> | iconv -t SJIS) sample_sjis.txt | iconv -f SJIS</span><br></pre></td></tr></table></figure><p>この例ではコマンド置換 (<code>$(...)</code> の部分、grepではなくシェルの機能) により文字コードShift_JISに変換するコマンドを実行してその結果を検索パターンに指定しています。</p><p>各オプションの意味とその意図は次のとおりです。</p><ul><li><code>-a</code>: バイナリファイルもテキストとして検索します。<br>Shift_JISのファイルはgrepにバイナリファイルと認識され、検索結果にマッチした行テキストが出力されないことがあります。 <code>-a</code> を指定するとバイナリファイルもテキスト扱いで検索してマッチした行テキストが出力されます。</li><li><code>-F</code>: 検索パターンを正規表現として解釈せず普通の文字列として扱います。<br>Shift_JISの検索文字列の一部はメタ文字として解釈されてしまい、エラーになることがあります。そのような場合は <code>-F</code> オプションを指定して検索パターンをただの文字列として指定するとエラーを解消できます。</li></ul><h2 id="マッチしない行を検索-v"><a href="#マッチしない行を検索-v" class="headerlink" title="マッチしない行を検索: -v"></a>マッチしない行を検索: <code>-v</code></h2><p>検索パターンを含まない行を検索したい (NOT条件のような) 場合は <code>-v</code> オプションを指定します。</p><h2 id="複数の検索パターン-e"><a href="#複数の検索パターン-e" class="headerlink" title="複数の検索パターン: -e"></a>複数の検索パターン: <code>-e</code></h2><p>複数の検索パターンのいずれかを含む行を検索したい (OR条件のような) 場合はいくつか方法がありますが、 <code>-e</code> オプションで検索パターンを複数指定する方法が簡単です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: HackまたはBackという文字列を含む行を検索する。</span></span><br><span class="line">grep -e <span class="string">'Hack'</span> -e <span class="string">'Back'</span> sample.txt</span><br></pre></td></tr></table></figure><h2 id="検索パターンをファイルで指定-f"><a href="#検索パターンをファイルで指定-f" class="headerlink" title="検索パターンをファイルで指定: -f"></a>検索パターンをファイルで指定: <code>-f</code></h2><p>検索パターンは <code>-f</code> オプションを使ってファイルで指定できます。検索パターンを指定するファイルは1行に1個の検索パターンを記述します。このとき、検索パターンを指定するファイルの改行コードは <code>LF</code> にする必要があります。改行コードに <code>CR</code> が含まれていると意図した検索ができません。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: ファイルから検索パターンを読み取って検索する。</span></span><br><span class="line">grep -f patterns.txt sample.txt</span><br></pre></td></tr></table></figure><p>このオプションは次の例のように、別のコマンドの結果を検索パターンとして使う時に指定することが多いです。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 別コマンドの結果を検索パターンとして指定し、検索する。</span></span><br><span class="line">grep -r --include=<span class="string">'*.vue'</span> -f &lt;(grep -Eo <span class="string">'[EWI][0-9]+'</span> some-resource.yml) some_dir/</span><br></pre></td></tr></table></figure><p>この例ではプロセス置換 (<code>&lt;(...)</code> の部分、grepではなくシェルの機能) により別のコマンドの結果を検索パターンファイルとして指定しています。</p><h2 id="最短一致検索"><a href="#最短一致検索" class="headerlink" title="最短一致検索"></a>最短一致検索</h2><p>検索パターンで紹介した量指定子の <code>*</code> や <code>+</code> はマッチする部分ができるだけ長くなるようにマッチされます (最長一致検索)。例えば、検索パターン <code>H.*e</code> は文字列 <code>Hack to the Future</code> の全体にマッチします。そうではなく、1個目の <code>e</code> までマッチさせる (最短一致検索) 場合は、 <code>-P</code> オプションを指定し、Perl互換正規表現 (PCRE) のメタ文字 <code>*?</code> や <code>+?</code> を使います。検索パターン <code>H.*?e</code> は文字列 <code>Hack to the Future</code> に対して <code>Hack to the</code> の部分にマッチします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 最短一致検索する。</span></span><br><span class="line">grep -P <span class="string">'H.*?e'</span> sample.txt</span><br></pre></td></tr></table></figure><h1 id="git-grep"><a href="#git-grep" class="headerlink" title="git grep"></a>git grep</h1><p>gitのサブコマンドにはgitリポジトリを検索するgit grepコマンドがあります。単にワークツリーを検索するだけであればgrepを使えば良いですが、コミット内を検索したい場合にはgit grepを使う必要があります。git grepはワークツリーとコミット内のどちらも検索できます。</p><p>git grepは名前にgrepが含まれている通りgrepと似ており、使い方がgrepとほぼ同じでオプションも同じように使えるものが多いです。ここでは前述したgrepのオプションとは異なる部分と、git grep特有の便利機能を紹介します。</p><h2 id="特定のファイルだけ検索"><a href="#特定のファイルだけ検索" class="headerlink" title="特定のファイルだけ検索"></a>特定のファイルだけ検索</h2><p>git grepには <code>--include</code> オプションがありません。代わりに、git grepではコマンドライン引数の最後に検索対象のファイルを限定する「パス仕様」を指定できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: カレントディレクトリから再帰的に、配下に存在する拡張子.vueのファイルを対象に検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> -- <span class="string">'*.vue'</span></span><br></pre></td></tr></table></figure><p>この例では <code>&#39;*.vue&#39;</code> の部分がパス仕様で、 <code>--</code> はそれより後ろの引数がパス仕様であることを明示するために指定します。</p><p>なお、git grepは <code>-r</code> オプションの動作がデフォルトのため、オプション無しでもフォルダを再帰的に検索します。</p><h3 id="特定のファイル-フォルダを除外"><a href="#特定のファイル-フォルダを除外" class="headerlink" title="特定のファイル/フォルダを除外"></a>特定のファイル/フォルダを除外</h3><p><code>--include</code> と同様にgit grepには <code>--exclude</code>, <code>--exclude-dir</code> オプションが無いため、コマンドライン引数の最後で除外するパス仕様を指定します。除外するパスは先頭に <code>:^</code> または <code>:!</code> という文字 (どちらも同じ意味) を付けて指定します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: カレントディレクトリから再帰的に、配下に存在する拡張子.log以外のファイルを対象に検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> -- <span class="string">':^*.log'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: カレントディレクトリから再帰的に、logフォルダ以外の配下に存在するファイルを対象に検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> -- <span class="string">':^*/log/*'</span></span><br></pre></td></tr></table></figure><h2 id="他ブランチ-全ブランチ検索"><a href="#他ブランチ-全ブランチ検索" class="headerlink" title="他ブランチ/全ブランチ検索"></a>他ブランチ/全ブランチ検索</h2><p>gitは機能や修正毎にブランチを分けて開発することが多いため、他ブランチを対象に検索したいことがあります。そのような場合はコマンドライン引数でブランチを指定して検索できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: dev/awesome-featureブランチを対象に検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> dev/awesome-feature</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: リモートブランチを対象に検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> origin/dev/awesome-feature</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: 検索対象のブランチを複数指定する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> dev/awesome-feature dev/pretty-feature</span><br></pre></td></tr></table></figure><p>また、もっと広く検索するために全ブランチを対象に検索したいことがあります。そのような場合、私は次のように検索しています。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 全リモートブランチを対象に検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> $(git show-ref | cut -d<span class="string">' '</span> -f2 | grep <span class="string">'/origin/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: 全リモートブランチを対象に、特定のパターンのファイルのみ検索する。</span></span><br><span class="line">git grep <span class="string">'Future'</span> $(git show-ref | cut -d<span class="string">' '</span> -f2 | grep <span class="string">'/origin/'</span>) -- <span class="string">'*.vue'</span> <span class="string">':^*.log'</span></span><br></pre></td></tr></table></figure><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>当記事では、私がよく使うgrepオプションやgit grepの機能を紹介しました。grepは他のコマンドと組み合わせるとさらに強力に使うことができます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># コマンド例: 別コマンドの結果を検索する。</span></span><br><span class="line">hoge | grep <span class="string">'Future'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: 3日以内に更新されたログファイルを対象に検索する。</span></span><br><span class="line">find . -maxdepth 2 -<span class="built_in">type</span> f -name <span class="string">'*.log'</span> -mtime -3 -print0 | xargs -0 grep <span class="string">'Future'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># コマンド例: grepで検索されたファイルを対象に置換処理する。</span></span><br><span class="line">perl -pi -e <span class="string">'s/foo([-\/])/bar$&#123;1&#125;/g'</span> $(grep -rl <span class="string">'foo[-/]'</span>)</span><br></pre></td></tr></table></figure><p>当blog過去記事の <a href="https://future-architect.github.io/articles/20160527/">grepのLT</a> では、「find, while, cut, …もgrepのオプションだよね？」といった衝撃の発表もされていて面白い内容ですのでよろしければそちらも参照ください。</p><h1 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h1><ul><li><a href="https://www.gnu.org/software/grep/manual/" target="_blank" rel="noopener">GNU Grepのマニュアル</a></li><li><a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html" target="_blank" rel="noopener">POSIXの正規表現仕様</a><br>GNU Grepのマニュアルに記載のないBRE, EREの仕様はこちらが参考になります。</li><li><a href="https://git-scm.com/docs/git-grep" target="_blank" rel="noopener">git-grepのドキュメント</a></li><li><a href="https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefpathspecapathspec" target="_blank" rel="noopener">gitglossaryのドキュメント (パス仕様の詳細)</a></li></ul><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;"><a href="https://www.gnu.org/software/grep/manual/grep.html#Basic-vs-Extended" target="_blank" rel="noopener">GNU grep manual: 3.6 Basic vs Extended Regular Expressions</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200611/top.png&quot;&gt;


&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、TIGメディアユニット岸本卓也です
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Shellscript" scheme="https://future-architect.github.io/tags/Shellscript/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #8 人生を豊かにする文字列diff入門</title>
    <link href="https://future-architect.github.io/articles/20200610/"/>
    <id>https://future-architect.github.io/articles/20200610/</id>
    <published>2020-06-10T02:31:40.000Z</published>
    <updated>2020-06-23T03:14:54.868Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>の8日目です。</p><p>文字列の新旧の違いを表現する時によくdiffをとるとか言いますよね。そこで実行されるのが差分アルゴリズムです。差分のアルゴリズムって結構知れば知るほど難しいやつです。「より良い差分」という基準が、状況によって変わるからです。ヒューリスティックなやつです。例えば、HTMLの説明の文章を書いていたとします。タイトルをテーブルに書き換えてみたとします。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">&lt;title&gt;</span><br></pre></td></tr></table></figure><p>どちらの差分の方がわかりやすいでしょうか？</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- &lt;title&gt;</span></span><br><span class="line"><span class="addition">+ &lt;table&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">  &lt;t</span><br><span class="line"><span class="deletion">- it</span></span><br><span class="line"><span class="addition">+ ab</span></span><br><span class="line">  le&gt;</span><br></pre></td></tr></table></figure><p>どちらも間違ってはおらず、この差分を元にパッチを当てたりも可能です。ただ、読んだ時の読みやすさが違います。</p><p>これはもちろん前者と答える人の方が多いでしょう。だって、タグという意味の塊が維持されていますからね。<br>これは究極的にはわかりやすいdiffというのは「意味」を理解しないと作れないということを意味します。これがdiffは簡単なようで難しいと書いた理由です。もちろん、ほどほどの工数で、ほどほどの見た目のdiffも作成可能です。</p><p>案件の中で「とりあえず差分を」となるとあまり細かい部分まで詰めきれないことが多いと思います。差分の表示の質はどちらかというと、「あれば嬉しい」話で、「ないと困る」という線引きがしにくいものです。とりあえず出せてしまったらそこで試合終了になることも多いかも知れません。というか、そもそも差分アルゴリズムを案件で使おうという議論にもあまりならない気がします。</p><p>個人的には結構工夫しがいがあってお気に入りの差分アルゴリズムについて、それが何者であるか、どういう特製があって、どういう工夫ができるのかを紹介していきます。この説明では、Google製のdiff-match-patchのGo移植を元に説明していきますが、基本的な考え方は他の実装でも使えると思います。なお、このライブラリはdiff以外にmatchとpatchの機能もありますが、このエントリーではdiffのみを扱います。</p><h1 id="差分検知では何が行われるのか？"><a href="#差分検知では何が行われるのか？" class="headerlink" title="差分検知では何が行われるのか？"></a>差分検知では何が行われるのか？</h1><p>さっそく、<a href="https://play.golang.org/p/c0kcz7IO0Op" target="_blank" rel="noopener">差分を表示して</a>みます。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/sergi/go-diff/diffmatchpatch"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">text1 = <span class="string">"github.com/mattn_jp/go-sqlite3"</span></span><br><span class="line">text2 = <span class="string">"github.com/shibukawa/nanogui-go"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dmp := diffmatchpatch.New()</span><br><span class="line"></span><br><span class="line">diffs := dmp.DiffMain(text1, text2, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">log.Println(diffs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[{Equal github.com/} {Delete m} {Insert shibuk}]</code>みたいなテキストで出力されますが、手動でdiffコマンド的に出力をわかりやすく表示すると以下のようになります。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">  github.com/</span><br><span class="line"><span class="deletion">- m</span></span><br><span class="line"><span class="addition">+ shibuk</span></span><br><span class="line">  a</span><br><span class="line"><span class="deletion">- tt</span></span><br><span class="line"><span class="addition">+ wa/</span></span><br><span class="line">  n</span><br><span class="line"><span class="deletion">- _jp/</span></span><br><span class="line"><span class="addition">+ anogui-</span></span><br><span class="line">  go</span><br><span class="line"><span class="deletion">- -sqlite3</span></span><br></pre></td></tr></table></figure><p>結果のdiffsは差分のリストで、文字列片ごとに、Equal/Insert/Deleteのフラグ(Type)がついたものです。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Diff <span class="keyword">struct</span> &#123;</span><br><span class="line">    Type Operation</span><br><span class="line">    Text <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>差分アルゴリズムがやっていることは、この編集リストを作るのがお仕事です。ちなみに、このEqualとInsertだけをピックアップして文字列を結合すれば新しい文字列が、EqualとDeleteだけをピックアップすると古い文字列になります。</p><p>文章を編集するアクションのリストなので、ここから<a href="https://play.golang.org/p/hj2ekE8Rtjd" target="_blank" rel="noopener">レーベンシュタイン距離を計算</a>することもできます。diff-match-patchのライブラリではまさにその関数が提供されています。レーベンシュタイン距離はInsertやDeleteが多いほどスコアが上がるアルゴリズムで、単語同士の距離を計算できます。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log.Println(dmp.DiffLevenshtein(diffs))</span><br><span class="line"><span class="comment">// output: 24</span></span><br></pre></td></tr></table></figure><p>レーベンシュタイン距離を使うと、ユーザーが入力したコマンドが、利用可能なコマンドリストのどれにもマッチしないときに、一番近いコマンド名を出して「これを入力しようとしたんでしょうか？」と聞くことができます。</p><h2 id="出力部分の補助関数"><a href="#出力部分の補助関数" class="headerlink" title="出力部分の補助関数"></a>出力部分の補助関数</h2><p>diffの結果を加工する関数がいくつか提供されています。HTMLにしたり、カラーコード付きでコンソール出力したり、diffから元のテキストを復元したり、diffのテキストのように出力したり・・・</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffPrettyHtml</span><span class="params">(diffs []Diff)</span> <span class="title">string</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffPrettyText</span><span class="params">(diffs []Diff)</span> <span class="title">string</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffText1</span><span class="params">(diffs []Diff)</span> <span class="title">string</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffText2</span><span class="params">(diffs []Diff)</span> <span class="title">string</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffToDelta</span><span class="params">(diffs []Diff)</span> <span class="title">string</span></span></span><br></pre></td></tr></table></figure><h2 id="基本の検知ロジックのカスタマイズ"><a href="#基本の検知ロジックのカスタマイズ" class="headerlink" title="基本の検知ロジックのカスタマイズ"></a>基本の検知ロジックのカスタマイズ</h2><p>マッチを探す文字数の範囲やコスト計算のパラメータ調整は構造体の属性をいじると行えます。diff以外のmatchとpatch用のパラメータもあります。とはいえ、これだけで「見やすいdiff」を作り出すのは難しいと思います。そのため、基本の差分ロジックの出力を後から変更していく方法をこのあと紹介します。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DiffMatchPatch <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Number of seconds to map a diff before giving up (0 for infinity).</span></span><br><span class="line">    DiffTimeout time.Duration</span><br><span class="line">    <span class="comment">// Cost of an empty edit operation in terms of edit characters.</span></span><br><span class="line">    DiffEditCost <span class="keyword">int</span></span><br><span class="line">    <span class="comment">// How far to search for a match (0 = exact location, 1000+ = broad match). A match this many characters away from the expected location will add 1.0 to the score (0.0 is a perfect match).</span></span><br><span class="line">    MatchDistance <span class="keyword">int</span></span><br><span class="line">    <span class="comment">// When deleting a large block of text (over ~64 characters), how close do the contents have to be to match the expected contents. (0.0 = perfection, 1.0 = very loose).  Note that MatchThreshold controls how closely the end points of a delete need to match.</span></span><br><span class="line">    PatchDeleteThreshold <span class="keyword">float64</span></span><br><span class="line">    <span class="comment">// Chunk size for context length.</span></span><br><span class="line">    PatchMargin <span class="keyword">int</span></span><br><span class="line">    <span class="comment">// The number of bits in an int.</span></span><br><span class="line">    MatchMaxBits <span class="keyword">int</span></span><br><span class="line">    <span class="comment">// At what point is no match declared (0.0 = perfection, 1.0 = very loose).</span></span><br><span class="line">    MatchThreshold <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="後処理でのdiffの統合"><a href="#後処理でのdiffの統合" class="headerlink" title="後処理でのdiffの統合"></a>後処理でのdiffの統合</h1><p>最初のサンプルをみた時に、わかりにくかった原因は「細かすぎる」ことにありました。diff-match-patchはデフォルトではなるべく細かい差分を見つけようとします。ただ、それではわかりにくかったりするので、行ごとの差分になるようにしたり「編集リストをまとめて数を減らす」のが基本的なチューニングの方向性になります。</p><p>例えばこの差分は、Equalが2つ、DeleteとInsertが一つずつのリストになっています。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">  &lt;t</span><br><span class="line"><span class="deletion">- it</span></span><br><span class="line"><span class="addition">+ ab</span></span><br><span class="line">  le&gt;</span><br></pre></td></tr></table></figure><p>で、読みやすい方は、Equal要素はDeleteとInsertにそれぞれマージされています。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- &lt;title&gt;</span></span><br><span class="line"><span class="addition">+ &lt;table&gt;</span></span><br></pre></td></tr></table></figure><p>diff-match-patchには、デフォルトのアルゴリズムで作成した編集リストを、ある程度まとめてわかりやすくする関数がいくつも提供されています。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffCleanupEfficiency</span><span class="params">(diffs []Diff)</span> []<span class="title">Diff</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffCleanupMerge</span><span class="params">(diffs []Diff)</span> []<span class="title">Diff</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffCleanupSemantic</span><span class="params">(diffs []Diff)</span> []<span class="title">Diff</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dmp *DiffMatchPatch)</span> <span class="title">DiffCleanupSemanticLossless</span><span class="params">(diffs []Diff)</span> []<span class="title">Diff</span></span></span><br></pre></td></tr></table></figure><p>それぞれ、異なる戦略でマージしようとします。<a href="https://play.golang.org/p/xDf4MyftWgM" target="_blank" rel="noopener">DiffCleanupEfficiency()</a>と<a href="https://play.golang.org/p/A9coFnr-LK8" target="_blank" rel="noopener">DiffCleanupSemantic()</a>の結果は次の通りです。他の二つはこの入力では変わりませんでした。</p><figure class="highlight diff"><figcaption><span>DiffCleanupEfficiency()</span></figcaption><table><tr><td class="code"><pre><span class="line">  github.com/</span><br><span class="line"><span class="deletion">- mattn_jp/</span></span><br><span class="line"><span class="addition">+ shibukawa/nanogui-</span></span><br><span class="line">  go</span><br><span class="line"><span class="deletion">- -sqlite3</span></span><br></pre></td></tr></table></figure><figure class="highlight diff"><figcaption><span>DiffCleanupSemantic()</span></figcaption><table><tr><td class="code"><pre><span class="line">  github.com/</span><br><span class="line"><span class="deletion">- mattn_jp/go-sqlite3</span></span><br><span class="line"><span class="addition">+ shibukawa/nanogui-go</span></span><br></pre></td></tr></table></figure><h1 id="行単位のdiff"><a href="#行単位のdiff" class="headerlink" title="行単位のdiff"></a>行単位のdiff</h1><p><a href="https://play.golang.org/p/6hQaDU230yT" target="_blank" rel="noopener">複数行のテキスト</a>を今までの関数に入れてみます。行頭に改行が来たり、テキストの中に来たり、まちまちです。そのまま色付きで表示してもなんかわかりにくい表示結果になりがちです。</p><p>何も考えずに複数行テキストを入れてみる</p><figure class="highlight diff"><figcaption><span>何も考えずに複数行テキストを入れてみる</span></figcaption><table><tr><td class="code"><pre><span class="line">  github.com/</span><br><span class="line"><span class="deletion">- mattn_jp/go-sqlite3</span></span><br><span class="line"><span class="addition">+ shibukawa/nanogui-go</span></span><br><span class="line">  (改行)github.com/labstack/echo(改行)github.com/g</span><br><span class="line"><span class="deletion">- orilla/mux</span></span><br><span class="line"><span class="addition">+ in-gonic/gin</span></span><br><span class="line">  (改行)</span><br></pre></td></tr></table></figure><p>この結果をゴニョゴニョ直しても良いのですが、行単位でのdiffでは<a href="https://play.golang.org/p/7PKXZXA3D2O" target="_blank" rel="noopener">今までとは違うメソッドを使って入力と出力をフィルター</a>することで読みやすい差分出力を行うロジックが提供されています。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/sergi/go-diff/diffmatchpatch"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">text1 = <span class="string">"github.com/mattn_jp/go-sqlite3"</span></span><br><span class="line">text2 = <span class="string">"github.com/shibukawa/nanogui-go"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">dmp := diffmatchpatch.New()</span><br><span class="line">a, b, c := dmp.DiffLinesToChars(text1, text2)</span><br><span class="line">diffs := dmp.DiffMain(a, b, <span class="literal">false</span>)</span><br><span class="line">diffs = dmp.DiffCharsToLines(diffs, c)</span><br><span class="line"></span><br><span class="line">log.Println(diffs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- Delete github.com/mattn_jp/go-sqlite3(改行)</span></span><br><span class="line"><span class="addition">+ Insert github.com/shibukawa/nanogui-go(改行)</span></span><br><span class="line">  github.com/labstack/echo(改行)</span><br><span class="line"><span class="deletion">- Delete github.com/gorilla/mux(改行)</span></span><br><span class="line"><span class="addition">+ Insert github.com/gin-gonic/gin(改行)</span></span><br></pre></td></tr></table></figure><p>見慣れたdiffが出てきましたね。</p><p>これ、何をしているかというと、入力のテキストを行単位にわけ、1行1文字となるように、前処理をしているのですよね。そして、最後に文字を行に戻しています。文字というのは、それ以上は分られない単位ですので、この前処理を行うことで行単位でのdiffが出力されるわけです。</p><h1 id="応用編-GitHubのようなdiff"><a href="#応用編-GitHubのようなdiff" class="headerlink" title="応用編: GitHubのようなdiff"></a>応用編: GitHubのようなdiff</h1><p>みなさんが見慣れているGitHubでは、行単位のdiffの中に、文字単位のdiffが入った出力が行われます。この出力の情報量は多く、長い行の一部が変更された場合などに力を発揮します。</p><p>これを実現するには既製のライブラリをそのまま使うだけではダメで、いろいろ後処理を加える必要があります。完成品は<a href="https://github.com/shibukawa/cdiff/blob/master/diff.go#L141" target="_blank" rel="noopener">こちら</a>にあります。</p><p>やっていることは単純で、diffsの差分の結果中で、Delete→Insertの順番に並んでいるところを見つけ、その差分を行内のdiffとして出力してあげればいけます。</p><p>なお、GitHubの場合は新旧の行番号を両方表示しているため、そこをエミュレーションするにはdiffsのテキストを解析し、新旧の行番号をカウントしてあげる必要があります。上記のコードでは<a href="https://github.com/shibukawa/cdiff/blob/master/diff.go#L16" target="_blank" rel="noopener">まずさいしょに</a>この処理を行っています。Equalなら両方の、Deleteなら旧の方のみ、Insertなら新の方のみの行カウンターをインクリメントする、みたいな感じですね。</p><p>これらの処理を組み合わせることで、次のような行単位差分と、その中のテキスト単位差分を出しつつ、新旧の行数を両方出す（unified形式）で出したのが次のスクリーンショットです。まあ、テキスト単位差分はもうちょっと何かしらの後処理はした方が良いですが、とりあえず実証実験ということで。</p><img src="/images/20200610/99.png"><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>diffのアルゴリズムと応用について紹介しました。</p><p>diffってすごく人間臭いアルゴリズムだと思うんですよね。そもそもすべてがきちんと動いている・情報が把握されている場合にはあまり必要とされない。間違った時、間違いを見つけようとした時ほど役立つんですよね。フューチャーが扱うようなシステムでも必須要件に入ることはあまりないと思いますし、僕が前職でやっていたような社内SE業でも必ずしも必要とされない。でも、それを知っていると、もしユーザーが間違った時に「もしかしてこれじゃないですか？」「前回の設定との違いはこれですよ。間違いの原因はこの中にありますか？」みたいな親切なことができるんですよね。</p><p>「なくても困らないけど、あったら嬉しい」ものって、ほとんどの場合「付加価値」を提供するものです。diffアルゴリズムも自分が使える道具の中に入れておくと、いざと言う時に「最低限を満足するだけのシステム」から「すごく親切なシステム」にパワーアップできると思います。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><ul><li><a href="https://future-architect.github.io/articles/20200310/">Goの標準ライブラリのコードリーディングのすすめ</a></li><li><a href="https://future-architect.github.io/articles/20191203/">Go Conferenceの📛を作る</a></li><li><a href="https://future-architect.github.io/articles/20191114/">Go Cloud#4 URLを編集するパッケージ</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;の8日目です。&lt;/p&gt;
&lt;p&gt;文字列の新旧の違いを表現する時によくdiffをとるとか言いますよね。そこで実行されるのが差分アル
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="Algorithm" scheme="https://future-architect.github.io/tags/Algorithm/"/>
    
  </entry>
  
  <entry>
    <title>春の入門祭り🌸 #7 作って学ぶGraphQL。gqlgenを用いて鉄道データ検索API開発入門</title>
    <link href="https://future-architect.github.io/articles/20200609/"/>
    <id>https://future-architect.github.io/articles/20200609/</id>
    <published>2020-06-09T02:16:57.000Z</published>
    <updated>2020-06-10T02:23:39.894Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200609/top.png"><p><a href="https://future-architect.github.io/articles/20200529/">春の入門祭り</a>の7日目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p><strong>※このエントリーはGoでGraphQLサーバアプリ開発の入門記事です。技術要素にGo, gqlgen, Docker, PosgreSQLなどが登場します。</strong></p><p>TIG DXユニット<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>の真野です。技術ブログ運営もしています。</p><p>フューチャーでは<a href="/tags/OpenAPI/">OpenAPI関連の過去記事</a>からお察しもできるように、REST-likeなWebAPIを実装することが多いです。しかし<a href="https://future-architect.github.io/articles/20200512/">日本製HeadlessCMSのmicroCMSを触ってみた</a>の記事で紹介されたように、HeadlessCMS界隈を初めGraphQLのAPIを提供するサービスが増えている体感もあり、GraphQLを春の入門祭りのテーマにしました。</p><p>学習する上でドキュメントを読み込むだけでは忘れがちです。手を動かしながらタイトルにあるように<strong>鉄道データ検索API</strong>をGraphQLで実装していきましょう。実装の前に結果のみを知りたい人は <a href="#クエリ：「渋谷駅」を検索する">クエリ：「渋谷駅」を検索する</a>にお進みください。スキーマは<a href="#GraphQLスキーマ設計">#GraphQLスキーマ設計</a>にあります。</p><h1 id="GraphQLとは"><a href="#GraphQLとは" class="headerlink" title="GraphQLとは"></a>GraphQLとは</h1><img src="/images/20200609/photo_20200609_01.png"><ul><li><a href="https://graphql.org/" target="_blank" rel="noopener">https://graphql.org/</a></li></ul><p>GraphQLはWebAPI用のクエリ言語です。誤解を恐れずに書けばWebAPIにおけるSQLのような存在です。GraphQL（つまりクエリ）と呼ぶとSelectしかない印象を持ってしまいそうですが、Mutationと呼ばれるスキーマを定義すればInsert/Update/Delteが相当の処理を実行できます。今回はMutationは省略してQueryのみを実装していきます。</p><p>GraphQLはRDBのDDL（Data Definition Language）のようなスキーマも持て、<code>.graphqls</code>の拡張子で管理します。このGraphQLスキーマを元に、クライアントやサーバサイドのテンプレートコードを自動生成できます。サーバサイド実装者側の立場に立てば、この宣言したGraphQLに沿ったリクエストを受付、レスポンスを応答する必要があります。</p><h1 id="GraphQLスキーマ定義"><a href="#GraphQLスキーマ定義" class="headerlink" title="GraphQLスキーマ定義"></a>GraphQLスキーマ定義</h1><p>スキーマ定義の文法は以下のような形式で、項目ごとに型定義を行えます。 <code>!</code> の意味は、Not Null条件です。</p><figure class="highlight ts"><figcaption><span>GraphQLのスキーマ例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Query &#123;</span><br><span class="line">  me: User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  name: <span class="built_in">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>このスキーマに対して、以下のクエリを実行すると…</p><figure class="highlight ts"><figcaption><span>クエリ実行例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  me &#123;</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下の形式のレスポンスが取得されます。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"me"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Luke Skywalker"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>この例だと宣言している項目が少ないので恩恵が少なそうですが、属性が増えたりネストした属性（Lukeの友人関係もスキーマ定義するなど）をすると、名前だけ取得したい場合と、友人関係も取得したいときで、クエリによって呼び分けられるので便利です（実装次第ですが、おそらくサーバサイドの負荷も下げることができます）。</p><p>文法詳細は<a href="https://graphql.org/learn/" target="_blank" rel="noopener">公式のlearn</a>ページをさらっと目を通すとオススメです。公式がスターウオーズのデータで説明しているため、この界隈に入門するときはスター・ウォーズシリーズの視聴をしておくと有利な気がします。他にも<a href="https://kakakakakku.hatenablog.com/entry/2019/12/30/135420" target="_blank" rel="noopener">ポケモン初代</a>のデータや実装が公開されているため、トレーナの皆様におかれましてはこちらの方が良いかもです。ポケモン、非常に良いと思ったのですがポケモン名や技名が、英語限定なのでそこがネックかも知れません。</p><h1 id="スターウォーズスキーマお試し環境の構築手順"><a href="#スターウォーズスキーマお試し環境の構築手順" class="headerlink" title="スターウォーズスキーマお試し環境の構築手順"></a>スターウォーズスキーマお試し環境の構築手順</h1><p>スターウォーズで良ければサンプル実装で試すのが早いです。Goの開発環境が入っていれば、以下の手順でクイックにサーバを起動できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; mkdir <span class="variable">$GOPATH</span>/src/github.com/graphql-go</span><br><span class="line">&gt; <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/graphql-go</span><br><span class="line">&gt; git <span class="built_in">clone</span> https://github.com/graphql-go/graphql.git</span><br><span class="line">&gt; <span class="built_in">cd</span> graphql-go/examples</span><br><span class="line">&gt; go run main.go</span><br><span class="line">Now server is running on port 8080</span><br><span class="line">Test with Get      : curl -g <span class="string">'http://localhost:8080/graphql?query=&#123;hero&#123;name&#125;&#125;'</span></span><br></pre></td></tr></table></figure><p>GraphQLクライアントですが、ログ出力している通り、<code>curl</code> で試しても良いですが、GraphiQLというElectron製のtypoしているような名前のツールが便利です。</p><ul><li><a href="https://www.electronjs.org/apps/graphiql" target="_blank" rel="noopener">https://www.electronjs.org/apps/graphiql</a></li></ul><p>GraphiQLを起動後に、Endpiontには先ほどログ出力されていた、<code>http://localhost:8080/graphql</code> と <code>GET</code>に書き換えると実行可能です。てっきりGraphQLは <code>POST</code>で <code>/graphql</code> で固定的に提供されるものだと思っていましたが、実装元の提供方法次第で自由に変えられることがわかります。</p><img src="/images/20200609/photo_20200609_02.gif"><p>サンプルのクエリは、ここの<a href="https://github.com/graphql-go/graphql/blob/master/graphql_test.go" target="_blank" rel="noopener">テストケース</a>を参考に試してみてください。</p><h1 id="GoでのGraphQL実装方法"><a href="#GoでのGraphQL実装方法" class="headerlink" title="GoでのGraphQL実装方法"></a>GoでのGraphQL実装方法</h1><p>さて、ここからは実際に手を動かしてみるパートです。コードは全て<a href="https://github.com/laqiiz/gqlgen-ekiapp" target="_blank" rel="noopener">こちらのリポジトリ</a>にコミットしていますので、適時参照ください。</p><p>GoでのGraphQLサーバの実装に用いるライブラリは、メジャーなのが2種類ありそれぞれ特色が大きく違います。</p><ol><li><a href="https://github.com/graphql-go/graphql" target="_blank" rel="noopener">graphql-go/graphql</a><ul><li>コードでGraphQLスキーマを表現するタイプ</li></ul></li><li><a href="https://github.com/99designs/gqlgen" target="_blank" rel="noopener">99designs/gqlgen</a><ul><li>GraphQLのスキーマを元にコードを自動生成するタイプ</li></ul></li></ol><p>どちらを選ぶかはチームの戦略次第だと思いますが、今回はスキーマ駆動で開発を進められる <strong>gqlgen</strong> を採用します。</p><h1 id="実装するもの"><a href="#実装するもの" class="headerlink" title="実装するもの"></a>実装するもの</h1><p>スターウォーズ・ポケモン（英語）、どちらも不朽の名作ですが、今回は趣向を変えます。昨今の情勢下でフューチャーはリモートワーク推進のためでしたが、それまで非常にお世話になった<strong>鉄道🚃の駅情報を検索するAPI</strong>をGraphQLサーバで実装していきます。データは<a href="https://ekidata.jp/" target="_blank" rel="noopener">駅データ.jp</a>を使わせていただきました。</p><h1 id="今回利用する駅データ"><a href="#今回利用する駅データ" class="headerlink" title="今回利用する駅データ"></a>今回利用する駅データ</h1><p><a href="https://ekidata.jp/" target="_blank" rel="noopener">駅データ.jp</a>さんからCSVファイルをダウンロードします。データ取得にはユーザ登録（無料）が必要です。有料データには路線カラー情報や新幹線駅データなどさらに有益な情報が含まれているそうなので、必要に応じて切り替えてください。今回は無料版で行います。スキーマ情報は仕様書のページに記載されています。控えめに言って神サイトです。</p><img src="/images/20200609/photo_20200609_03.gif"><ul><li><a href="https://ekidata.jp/doc/" target="_blank" rel="noopener">駅データ.jpのデータ仕様書ページより</a></li></ul><h1 id="PostgreSQLにデータを登録する"><a href="#PostgreSQLにデータを登録する" class="headerlink" title="PostgreSQLにデータを登録する"></a>PostgreSQLにデータを登録する</h1><p>GraphQLサーバから直接CSVファイルを読み取っても良いですが、結合が面倒なのでPostgreSQLに登録します。以下のDockerfile, docker-compose.ymlを作成します。</p><figure class="highlight dockerfile"><figcaption><span>駅データ格納PosgreSQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> postgres:<span class="number">10.7</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> init /docker-entrypoint-initdb.d/</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.5"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  postgresql:</span></span><br><span class="line"><span class="attr">    build:</span> <span class="string">./</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">postgre-eki</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">POSTGRES_USER=postgres</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">POSTGRES_PASSWORD=postgres</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">POSTGRES_INITDB_ARGS=--encoding=UTF-8</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"5432:5432"</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - pg-data-eki:</span><span class="string">/var/lib/pgdata</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  pg-data-eki:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">local</span></span><br></pre></td></tr></table></figure><p>記事ではstationのCreate文とcopy句を記載します。</p><figure class="highlight sql"><figcaption><span>1_create.sql(company,line,joinは省略)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> station</span><br><span class="line">(</span><br><span class="line">    station_cd <span class="built_in">integer</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    station_g_cd <span class="built_in">integer</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    station_name <span class="built_in">varchar</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    station_name_k <span class="built_in">varchar</span>,</span><br><span class="line">    station_name_r <span class="built_in">varchar</span>,</span><br><span class="line">    line_cd <span class="built_in">integer</span>,</span><br><span class="line">    pref_cd <span class="built_in">integer</span>,</span><br><span class="line">    post <span class="built_in">varchar</span>,</span><br><span class="line">    address <span class="built_in">varchar</span>,</span><br><span class="line">    lon <span class="built_in">float</span>,</span><br><span class="line">    lat <span class="built_in">float</span>,</span><br><span class="line">    open_ymd <span class="built_in">varchar</span> ,</span><br><span class="line">    close_ymd <span class="built_in">varchar</span>,</span><br><span class="line">    e_status <span class="built_in">integer</span>,</span><br><span class="line">    e_sort <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (station_cd)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">table</span> station <span class="keyword">is</span> <span class="string">'station20200316free.csv'</span>;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><figcaption><span>2_copy.sql(company,line,joinは省略)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy company(company_cd,rr_cd,company_name,company_name_k,company_name_h,company_name_r,company_url,company_type,e_status,e_sort)</span><br><span class="line">  from '/docker-entrypoint-initdb.d/company20200309.csv' <span class="keyword">with</span> csv header;</span><br></pre></td></tr></table></figure><p>また、先ほどダウンロードしたCSVファイルと、それぞれに相当するDDL文を作成して、以下のフォルダに格納します。こんな感じで作成してコンテナを起動させます。PostgreSQLのコンテナは<code>/docker-entrypoint-initdb.d/</code>配下にSQLを配備すると、起動時にファイル名の順番で実行してくれて便利です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.gqlgen-ekiapp</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── init</span><br><span class="line">    ├── 1_create.sql              <span class="comment"># DDL</span></span><br><span class="line">    ├── 2_copy.sql                <span class="comment"># Copy句</span></span><br><span class="line">    ├── company20200309.csv       <span class="comment"># DownloadしたCSV</span></span><br><span class="line">    ├── join20200306.csv          <span class="comment"># DownloadしたCSV</span></span><br><span class="line">    ├── line20200306free.csv      <span class="comment"># DownloadしたCSV</span></span><br><span class="line">    └── station20200316free.csv   <span class="comment"># DownloadしたCSV</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初回だけ</span></span><br><span class="line">docker volume create pg-data-eki</span><br><span class="line"></span><br><span class="line"><span class="comment"># 起動（コンテナイメージ作成処理でinitフォルダ以下が/docker-entrypoint-initdb.d/にコピーされ、createとcopyが実行される）</span></span><br><span class="line">docker-compose up --build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line"><span class="comment">#docker-compose down</span></span><br></pre></td></tr></table></figure><p>上手く起動できれば、psqlツールを用いると結果が取得できるようになっています。psqlを使わずともお好きなSQLクライアントツールで確認してみてください。先ほどのDockerfileだと postgres/postgresでログインできます。</p><figure class="highlight bash"><figcaption><span>接続確認</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d postgres -c <span class="string">'select * from station limit 10'</span>;</span><br></pre></td></tr></table></figure><p>データ登録はこれでおしまいです。</p><h1 id="GraphQLスキーマ設計"><a href="#GraphQLスキーマ設計" class="headerlink" title="GraphQLスキーマ設計"></a>GraphQLスキーマ設計</h1><p>ここからGraphQLのスキーマを検討します。GraphQLスキーマ設計のコツは、上図の事業マスタ(Company)、路線マスタ(Line)、駅マスタ(Station)、接続駅マスタ(Join)といった<strong>RDBのスキーマ構造に縛られない</strong>ことです。設計上の重要なインプットではありますが、いったんRDBは忘れWebAPIとしてどういう構造が使いやすいかを考えて設計します。</p><p>あるべき構造を考え、さらに仕様書ページを参考に、型・必須有無を設定します。元データにはもっと多くの属性が存在しますが、今回は簡略化のためかなり削っています。必要に応じて追加してください。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Station &#123;</span><br><span class="line">    stationCD: Int!</span><br><span class="line">    lineName: <span class="built_in">String</span></span><br><span class="line">    stationName: <span class="built_in">String</span>!</span><br><span class="line">    address: <span class="built_in">String</span></span><br><span class="line">    beforeStation: Station</span><br><span class="line">    afterStation: Station</span><br><span class="line">    transferStation: [Station]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>今回はStationという型のみを定義します。beforeStation/afterStationは同じ路線（JR山手線とかJR東海道線とか）の前後の駅を指し、transferStationは乗り換え駅を指します。今回グラフぽいところは、Stationの中に、beforeStation/afterStation/transferSationという別のStationのフィールドを持っていることです。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Query &#123;</span><br><span class="line">    stationByCD(stationCD: Int): Station!</span><br><span class="line">    stationByName(stationName: String): [Station]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>データ型が宣言できれば、Queryというエンドポイントとなるルートの関数を宣言します。<code>stationByName</code>と<code>stationByCD</code>の2つです。駅名で検索できるか、駅CDで検索できるかの2種類です。<code>[Station]</code>で配列であることを示します。駅名だと”横浜”で検索すると、<code>JR根岸線</code>や<code>JR横須賀線</code>など11路線がヒットしますので複数受け取れるようにしないとならないです。<code>stationCD</code>は「路線×駅」を示すIDで、JR根岸線の横浜駅といったかたちで駅データ.jpさんに登録されていて、ユニークな値ですので単一のStationを返すようにします。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Query &#123;</span><br><span class="line">    stationByName(stationName: <span class="built_in">String</span>): [Station]</span><br><span class="line">    stationByCD(stationCD: Int): Station!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これらを1つにした.graphqlsファイルを作成し、gqlgenでサーバコードのテンプレートを作成します。</p><h1 id="GraphQLスキーマからGoコードを生成"><a href="#GraphQLスキーマからGoコードを生成" class="headerlink" title="GraphQLスキーマからGoコードを生成"></a>GraphQLスキーマからGoコードを生成</h1><p>gqlgenの<a href="https://gqlgen.com/getting-started/#install-gqlgen" target="_blank" rel="noopener">Getting Started</a>を参考にしてgqlgenをインストールします。Goのインストールは必須です。私は1.14を使っています。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go version</span><br><span class="line">go version go1.14.2 linux/amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># gqlgenのインストール</span></span><br><span class="line">$ go get -u github.com/99designs/gqlgen</span><br></pre></td></tr></table></figure><p>今回作成するサンプルを仮に<code>gqlgen-ekiapp</code>と名付けます。</p><figure class="highlight bash"><figcaption><span>プロジェクトの作成</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir gqlgen-ekiapp</span><br><span class="line">$ <span class="built_in">cd</span> gqlgen-ekiapp</span><br><span class="line">$ go mod init</span><br></pre></td></tr></table></figure><p>以下のような構成になります。</p><figure class="highlight bash"><figcaption><span>プロジェクトディレクトリ構成(コード生成前）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── go.mod</span><br><span class="line">└── graph</span><br><span class="line">    └── schema.graphqls    <span class="comment"># GraphQLスキーマ</span></span><br></pre></td></tr></table></figure><p>このルートディレクトリで<code>gqlgen init</code>（2回目以降は<code>gqlgen generate</code>）コマンドでテンプレートコードを生成します。</p><figure class="highlight bash"><figcaption><span>テンプレートコードの生成</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gqlgen init</span><br><span class="line">$ go mod tidy</span><br></pre></td></tr></table></figure><p>そうすると、以下のような構成になります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── gqlgen.yml                <span class="comment"># gqlgenコマンドのコンフィグファイル(初回のみ作成)</span></span><br><span class="line">├── graph</span><br><span class="line">│   ├── generated</span><br><span class="line">│   │   └── generated.go      <span class="comment"># 自動生成されたクエリのパース処理などの部分</span></span><br><span class="line">│   ├── model</span><br><span class="line">│   │   └── models_gen.go     <span class="comment"># 自動生成されたmodel</span></span><br><span class="line">│   ├── resolver.go           <span class="comment"># Resolverコードの実体を実装する部分(☆初回のみ作成)</span></span><br><span class="line">│   ├── schema.graphqls       <span class="comment"># GraphQLスキーマ</span></span><br><span class="line">│   └── schema.resolvers.go   <span class="comment"># 各Resolverのエンドポイント(☆初回のみ作成)</span></span><br><span class="line">├── server.go                 <span class="comment"># mainパッケージ</span></span><br><span class="line">|                </span><br><span class="line">└── postgresql</span><br><span class="line">    ├── ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>最初はresolver.goを実装していきます。</p><h1 id="SQLクエリからGoのStructを作成（シンプルな実装）"><a href="#SQLクエリからGoのStructを作成（シンプルな実装）" class="headerlink" title="SQLクエリからGoのStructを作成（シンプルな実装）"></a>SQLクエリからGoのStructを作成（シンプルな実装）</h1><p>resolver.goの実装に入る前に前処理を行います。今回はデータストアがPostgreSQLに存在し、すでにテーブルが実装済みでデータも登録されている状態ですこれを上手く利用したいと思います。</p><p>DBスキーマからGoのStructを作成するツールはsqlboilerなどたくさんの選択肢がありますが、今回は<a href="https://github.com/xo/xo" target="_blank" rel="noopener">xo/xo</a>を利用します。xo/xoではSQLからStructを生成できて便利です。</p><p>インプットとして利用するSQLは、PostgreSQLからJoinを駆使して、同一路線の前後の駅や、乗り換え情報を一度に取得しています。そのため少しばかり重厚です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xoのインストール</span></span><br><span class="line">$ go get -u github.com/xo/xo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 出力先フォルダの作成</span></span><br><span class="line">$ mkdir -p models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Structの生成</span></span><br><span class="line">$ xo pgsql://postgres:postgres@localhost/postgres?sslmode=<span class="built_in">disable</span> -N -M -B -T StationConn -o models/ &lt;&lt; ENDSQL</span><br><span class="line">select li.line_name,</span><br><span class="line">       li.line_name_h,</span><br><span class="line">       li.line_cd,</span><br><span class="line">       st.station_cd,</span><br><span class="line">       st.station_g_cd,</span><br><span class="line">       st.address,</span><br><span class="line">       st.station_name,</span><br><span class="line">       COALESCE(s2l.line_name, <span class="string">''</span>)     as before_line_name,</span><br><span class="line">       COALESCE(st2.station_cd, 0)    as before_station_cd,</span><br><span class="line">       COALESCE(st2.station_name, <span class="string">''</span>) as before_station_name,</span><br><span class="line">       COALESCE(st2.address, <span class="string">''</span>)      as before_address,</span><br><span class="line">       COALESCE(s3l.line_name, <span class="string">''</span>)     as after_line_name,</span><br><span class="line">       COALESCE(st3.station_cd, 0)    as after_station_cd,</span><br><span class="line">       COALESCE(st3.station_name, <span class="string">''</span>) as after_station_name,</span><br><span class="line">       COALESCE(st2.address, <span class="string">''</span>)      as after_address,</span><br><span class="line">       COALESCE(gli.line_name, <span class="string">''</span>)    as transfer_line_name,</span><br><span class="line">       COALESCE(gs.station_cd, 0)     as transfer_station_cd,</span><br><span class="line">       COALESCE(gs.station_name, <span class="string">''</span>)  as transfer_station_name,</span><br><span class="line">       COALESCE(gs.address, <span class="string">''</span>)       as transfer_address</span><br><span class="line">from station st</span><br><span class="line">         inner join line li on st.line_cd = li.line_cd</span><br><span class="line">         left outer join station_join sjb on st.line_cd = sjb.line_cd and st.station_cd = sjb.station_cd2</span><br><span class="line">         left outer join station_join sja on st.line_cd = sja.line_cd and st.station_cd = sja.station_cd1</span><br><span class="line">         left outer join station st2 on sjb.line_cd = st2.line_cd and sjb.station_cd1 = st2.station_cd</span><br><span class="line">         left outer join line s2l on st2.line_cd = s2l.line_cd</span><br><span class="line">         left outer join station st3 on sja.line_cd = st3.line_cd and sja.station_cd2 = st3.station_cd</span><br><span class="line">         left outer join line s3l on st3.line_cd = s3l.line_cd</span><br><span class="line">         left outer join station gs on st.station_g_cd = gs.station_g_cd and st.station_cd &lt;&gt; gs.station_cd</span><br><span class="line">         left outer join line gli on gs.line_cd = gli.line_cd</span><br><span class="line"><span class="built_in">where</span> st.station_cd = %%stationCD int%%</span><br><span class="line">  and st.e_status = 0</span><br><span class="line">order by st.e_sort</span><br><span class="line">ENDSQL</span><br></pre></td></tr></table></figure><p>正常に実行できると、models配下にクエリ結果を格納するStructと実行用の関数が生成されます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── models                <span class="comment"># 自動生成対象のフォルダ</span></span><br><span class="line">│   ├── stationconn.xo.go <span class="comment"># 自動生成コード</span></span><br><span class="line">│   └── xo_db.xo.go       <span class="comment"># 自動生成コード</span></span><br><span class="line">|</span><br><span class="line">└── postgresql</span><br><span class="line">    ├── ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h1 id="Resolverの実装（初回）"><a href="#Resolverの実装（初回）" class="headerlink" title="Resolverの実装（初回）"></a>Resolverの実装（初回）</h1><p><code>resolver.go</code> を実装していきます。ResolverにgetStation関数を追加して実装していきます。この実装は後で書き直すので流すくらいでOKです。少し長いです。</p><details><summary>resolver.goの実装</summary><pre><code>func (r *Resolver) getStationByCD(ctx context.Context, stationCd *int) (*model.StationConn, error) {    stations, err := models.StationConnsByStationCD(db, *stationCd)    if err != nil {        return nil, err    }    if len(stations) == 0 {        return nil, errors.New("not found")    }    first := stations[0]    var beforeStation *model.Station    if first.BeforeStationName != "" {        beforeStation = &model.Station{            LineName:    &first.LineName,            StationCd:   first.BeforeStationCd,            StationName: first.BeforeStationName,            Address:     nil,        }    }    var afterStation *model.Station    if first.AfterStationName != "" {        afterStation = &model.Station{            LineName:    &first.LineName,            StationCd:   first.AfterStationCd,            StationName: first.AfterStationName,            Address:     nil,        }    }    transfers := make([]*model.Station, 0, len(stations))    for _, v := range stations {        if v.TransferStationName == "" {            continue        }        transfers = append(transfers, &model.Station{            LineName:    &v.TransferLineName,            StationCd:   v.TransferStationCd,            StationName: v.TransferStationName,            Address:     nil,        })    }    return &model.StationConn{        Station: &model.Station{            LineName:    &first.LineName,            StationCd:   first.StationCd,            StationName: first.StationName,            Address:     &first.Address,        },        TransferStation: transfers,        BeforeStation:   beforeStation,        AfterStation:    afterStation,    }, nil}</code></pre></details><p>xoで生成された関数を呼び出すだけです。ただし、呼び出し後はGraphQLのスキーマに沿った応答を返すためStruct詰め替えなGlueコードが多いです。</p><p>これを、<code>schema.resolvers.go</code> から呼び出してあげます。</p><figure class="highlight go"><figcaption><span>schema.resolvers.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *queryResolver)</span> <span class="title">StationByCd</span><span class="params">(ctx context.Context, stationCd *<span class="keyword">int</span>)</span> <span class="params">(*model.Station, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.getStationByCD(ctx, stationCd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>queryResolverから先ほどの関数を呼び出せることについてちょっと謎感がありますね。これは<code>queryResolver</code>は先ほど実装した <code>Resolver</code> を埋め込んでいるため、Resolverに実装した関数をそのまま呼べるというテクニックがgqlgenで行われています。簡単にインジェクションできて面白いですね。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> queryResolver <span class="keyword">struct</span>&#123; *Resolver &#125;</span><br></pre></td></tr></table></figure><p>記事中では省略していますが、この手順と同様の流れで <code>getStationByName</code> も実装しています。</p><h1 id="実装したデータのお試し"><a href="#実装したデータのお試し" class="headerlink" title="実装したデータのお試し"></a>実装したデータのお試し</h1><p>先ほどのサーバを起動します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$go</span> run server.go</span><br><span class="line">2020/06/09 09:00:11 connect to http://localhost:8080/ <span class="keyword">for</span> GraphQL playground</span><br></pre></td></tr></table></figure><p>ブラウザでlocalhost:8080にアクセスするとGraphQLコンソールが開けるのでそれでお試しします。JR東海道本線の横浜駅を示す station_cdの<code>1130105</code>で検索してみます。</p><img src="/images/20200609/photo_20200609_04.gif"><p>上手く動きました🎉</p><h1 id="今の実装の課題"><a href="#今の実装の課題" class="headerlink" title="今の実装の課題"></a>今の実装の課題</h1><p>先ほどのGraphQLサーバは表面上は上手く動きました。一方で今の実装では以下の課題があります。</p><ol><li>1つのSQLで全てのデータ（前後の隣駅や乗換駅）を取得しているため、クエリにそれらのフィールド無い場合もDBに負荷をかけてしまう。（また巨大なSQLになりがちで性能劣化の懸念がある）</li><li>乗換駅の隣駅の隣駅といった、<strong>ネストしたクエリを実行できない</strong></li></ol><p>これを解決する1つとして、<strong>SQLの結合が必要になるフィールドには GraphQL resolverを分離し別に用意する</strong> 方法があります。gqlgen側にクエリの実行順序やレスポンス整形を委ねるということです。これを行うと各resolverの実装をシンプルに保ちつつ、複雑なクエリに対応できます。</p><h1 id="Resolverを別に用意する"><a href="#Resolverを別に用意する" class="headerlink" title="Resolverを別に用意する"></a>Resolverを別に用意する</h1><p><code>gqlgen init</code>で作成された、gqlgenの設定ファイルを以下のように変更します。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="comment"># 中略</span></span><br><span class="line"><span class="attr">  Station:</span>                <span class="comment"># GraphQLスキーマのStation型</span></span><br><span class="line"><span class="attr">    fields:</span></span><br><span class="line"><span class="attr">      beforeStation:</span>      <span class="comment"># フィールド名</span></span><br><span class="line"><span class="attr">        resolver:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      afterStation:</span>       <span class="comment"># フィールド名</span></span><br><span class="line"><span class="attr">        resolver:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      transferStation:</span>    <span class="comment"># フィールド名</span></span><br><span class="line"><span class="attr">        resolver:</span>  <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>GraphQLスキーマで定義した<code>Station</code>のフィールドである、<code>beforeStation</code>, <code>afterStation</code>, <code>transferStation</code>にたいして、 <code>resolver: true</code> を設定することで、このフィールドを取得する際にはそれぞれ個別のresolverを用いるようにgqlgenに指定します。</p><p>変更を保存したら、既存の<code>resolver.go</code>と<code>schema.resolvers.go</code>はバックアップを取って削除しておきましょう。続いてgql generateで再生成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gqlgen generate</span><br></pre></td></tr></table></figure><p>そうすると、<code>schema.resolvers.go</code>で実装すべき関数が増えます。引数は *model.Stationでここから<code>stationCD</code> が取得できるので、これをキーに前後の隣駅と、乗り換え駅を取得していきます。</p><figure class="highlight go"><figcaption><span>schema.resolvers.goで増えた関数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *stationResolver)</span> <span class="title">BeforeStation</span><span class="params">(ctx context.Context, obj *model.Station)</span> <span class="params">(*model.Station, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// TODO 実装</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *stationResolver)</span> <span class="title">AfterStation</span><span class="params">(ctx context.Context, obj *model.Station)</span> <span class="params">(*model.Station, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// TODO 実装</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *stationResolver)</span> <span class="title">TransferStation</span><span class="params">(ctx context.Context, obj *model.Station)</span> <span class="params">([]*model.Station, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// TODO 実装</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>実装ですが、今まで通りResolver.go側に実体の実装を行います。SQLの結合部分がなくなったので、どのSQLもかなりシンプルになります。本文では駅CD検索と乗り換え駅検索の2つのResolverの実装を載せて、残りは省略しています。</p><p>まずはxoでSQLからStructと検索用の関数を生成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 駅CD検索</span></span><br><span class="line">xo pgsql://postgres:postgres@localhost/postgres?sslmode=<span class="built_in">disable</span> -N -M -B -T StationByCD -o models/ &lt;&lt; ENDSQL</span><br><span class="line">select l.line_cd, l.line_name, s.station_cd, station_g_cd, s.station_name, s.address </span><br><span class="line">from station s</span><br><span class="line">         inner join line l on s.line_cd = l.line_cd</span><br><span class="line"><span class="built_in">where</span> s.station_cd = %%stationCD int%%</span><br><span class="line">  and s.e_status = 0</span><br><span class="line">ENDSQL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 乗り換え検索</span></span><br><span class="line"><span class="comment"># 乗換駅検索</span></span><br><span class="line">xo pgsql://postgres:postgres@localhost/postgres?sslmode=<span class="built_in">disable</span> -N -M -B -T Transfer -o models/ &lt;&lt; ENDSQL</span><br><span class="line">select s.station_cd,</span><br><span class="line">       ls.line_cd,</span><br><span class="line">       ls.line_name,</span><br><span class="line">       s.station_name,</span><br><span class="line">       s.station_g_cd,</span><br><span class="line">       s.address,</span><br><span class="line">       COALESCE(lt.line_cd, 0)     as transfer_line_cd,</span><br><span class="line">       COALESCE(lt.line_name, <span class="string">''</span>)   as transfer_line_name,</span><br><span class="line">       COALESCE(t.station_cd, 0)   as transfer_station_cd,</span><br><span class="line">       COALESCE(t.station_name, <span class="string">''</span>) as transfer_station_name,</span><br><span class="line">       COALESCE(t.address, <span class="string">''</span>)      as transfer_address</span><br><span class="line">from station s</span><br><span class="line">         left outer join station t on s.station_g_cd = t.station_g_cd and s.station_cd &lt;&gt; t.station_cd</span><br><span class="line">         left outer join line ls on s.line_cd = ls.line_cd</span><br><span class="line">         left outer join line lt on t.line_cd = lt.line_cd</span><br><span class="line"><span class="built_in">where</span> s.station_cd = %%stationCD int%%</span><br><span class="line">ENDSQL</span><br></pre></td></tr></table></figure><p>Resolverを分離した分、SQLが少しシンプルになりました。</p><figure class="highlight go"><figcaption><span>Reolverの実装部分（駅CD検索と乗り換え駅取得の2つだけ抜粋）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 駅CD検索部分</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Resolver)</span> <span class="title">getStationByCD</span><span class="params">(ctx context.Context, stationCd *<span class="keyword">int</span>)</span> <span class="params">(*model.Station, error)</span></span> &#123;</span><br><span class="line">stations, err := models.StationByCDsByStationCD(db, *stationCd)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(stations) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"not found"</span>)</span><br><span class="line">&#125;</span><br><span class="line">first := stations[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;model.Station&#123;</span><br><span class="line">StationCd:   first.StationCd,</span><br><span class="line">StationName: first.StationName,</span><br><span class="line">LineName:    &amp;first.LineName,</span><br><span class="line">Address:     &amp;first.Address,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 乗り換え駅取得部分</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Resolver)</span> <span class="title">transferStation</span><span class="params">(ctx context.Context, obj *model.Station)</span> <span class="params">([]*model.Station, error)</span></span> &#123;</span><br><span class="line">stationCd := obj.StationCd</span><br><span class="line"></span><br><span class="line">records, err := models.TransfersByStationCD(db, stationCd)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp := <span class="built_in">make</span>([]*model.Station, <span class="number">0</span>, <span class="built_in">len</span>(records))</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> records &#123;</span><br><span class="line"><span class="keyword">if</span> v.TransferStationName == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">resp = <span class="built_in">append</span>(resp, &amp;model.Station&#123;</span><br><span class="line">StationCd:   v.TransferStationCd,</span><br><span class="line">StationName: v.TransferStationName,</span><br><span class="line">LineName:    &amp;v.TransferLineName,</span><br><span class="line">Address:     &amp;v.TransferAddress,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Resolver側の実装は、xoで生成された検索用の関数を呼び出して、Structの詰め替え作業をしているだけです。これを <code>schema.resolvers.go</code> で生成されたテンプレート関数から呼び出してあげます。</p><p>こういったResolver関数だけ用意しておけば、GraphQLのクエリでそのフィールドが指定されているときだけSQLが実行されるようになります。残りのResolverの実装が終わったら<code>go run server.go</code> でサーバを起動させ、localhost:8080のコンソールで確認します。</p><h1 id="クエリ：「渋谷駅」を検索する"><a href="#クエリ：「渋谷駅」を検索する" class="headerlink" title="クエリ：「渋谷駅」を検索する"></a>クエリ：「渋谷駅」を検索する</h1><p>今回開発したGraphQLサーバに対してクエリを実行して動作確認しましょう。</p><p>まずは<code>stationByName</code>で大崎駅で検索します。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">query osaki&#123;</span><br><span class="line">  stationByName(stationName: <span class="string">"大崎"</span>) &#123;</span><br><span class="line">    lineName</span><br><span class="line">    stationCD</span><br><span class="line">    stationName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>すると、大崎駅を利用する各路線とその駅CD（stationCD）が取得できます。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"stationByName"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130201</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"大崎"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR埼京線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1132101</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"大崎"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR湘南新宿ライン"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1133307</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"大崎"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"りんかい線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">9933708</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"大崎"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="クエリ：「大崎駅」の隣の駅を調べる"><a href="#クエリ：「大崎駅」の隣の駅を調べる" class="headerlink" title="クエリ：「大崎駅」の隣の駅を調べる"></a>クエリ：「大崎駅」の隣の駅を調べる</h1><p>先ほど取得した<code>1130201</code>のstationCDを元に、stationByCDを指定して隣駅を調べます。隣駅は、<code>beforeStation</code>、<code>afterStation</code>で調べられます。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">query nextStation &#123;</span><br><span class="line">  stationByCD(stationCD: <span class="number">1130201</span>) &#123;</span><br><span class="line">    lineName</span><br><span class="line">    stationCD</span><br><span class="line">    stationName</span><br><span class="line">    beforeStation &#123;</span><br><span class="line">      lineName</span><br><span class="line">      stationCD</span><br><span class="line">      stationName</span><br><span class="line">    &#125;</span><br><span class="line">    afterStation &#123;</span><br><span class="line">      lineName</span><br><span class="line">      stationCD</span><br><span class="line">      stationName</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>すると、大崎の隣駅は<code>五反田</code>と<code>品川</code>であることがわかります。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"stationByCD"</span>: &#123;</span><br><span class="line">      <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">      <span class="attr">"stationCD"</span>: <span class="number">1130201</span>,</span><br><span class="line">      <span class="attr">"stationName"</span>: <span class="string">"大崎"</span>,</span><br><span class="line">      <span class="attr">"beforeStation"</span>: &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130202</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"五反田"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"afterStation"</span>: &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130229</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"品川"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="クエリ：五反田の乗り換え駅を調べる"><a href="#クエリ：五反田の乗り換え駅を調べる" class="headerlink" title="クエリ：五反田の乗り換え駅を調べる"></a>クエリ：五反田の乗り換え駅を調べる</h1><p><code>transferStation</code>を追加することで、乗換駅を取得できます。beforeStationに<code>beforeStation</code>を追加することで、五反田駅の乗換駅を取得します。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">query stationByCD &#123;</span><br><span class="line">  stationByCD(stationCD: <span class="number">1130201</span>) &#123;</span><br><span class="line">    lineName</span><br><span class="line">    stationCD</span><br><span class="line">    stationName</span><br><span class="line">    beforeStation &#123;</span><br><span class="line">      lineName</span><br><span class="line">      stationCD</span><br><span class="line">      stationName</span><br><span class="line">      transferStation &#123;</span><br><span class="line">        lineName</span><br><span class="line">        stationCD</span><br><span class="line">        stationName</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    afterStation &#123;</span><br><span class="line">      lineName</span><br><span class="line">      stationCD</span><br><span class="line">      stationName</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>そうすると、五反田駅の乗換駅が、東急池上線と都営浅草線があることがわかります。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"stationByCD"</span>: &#123;</span><br><span class="line">      <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">      <span class="attr">"stationCD"</span>: <span class="number">1130201</span>,</span><br><span class="line">      <span class="attr">"stationName"</span>: <span class="string">"大崎"</span>,</span><br><span class="line">      <span class="attr">"beforeStation"</span>: &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130202</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"五反田"</span>,</span><br><span class="line">        <span class="attr">"transferStation"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"lineName"</span>: <span class="string">"東急池上線"</span>,</span><br><span class="line">            <span class="attr">"stationCD"</span>: <span class="number">2600501</span>,</span><br><span class="line">            <span class="attr">"stationName"</span>: <span class="string">"五反田"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"lineName"</span>: <span class="string">"都営浅草線"</span>,</span><br><span class="line">            <span class="attr">"stationCD"</span>: <span class="number">9930205</span>,</span><br><span class="line">            <span class="attr">"stationName"</span>: <span class="string">"五反田"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"afterStation"</span>: &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130229</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"品川"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="フラグメントを活用する"><a href="#フラグメントを活用する" class="headerlink" title="フラグメントを活用する"></a>フラグメントを活用する</h1><p>どの要素も、同じような属性を持っているので冗長な気がしますね。GraphQL クエリの「フラグメント」を使って共通化する事ができます。<code>stationF</code>というフラグメントに、3つのフィールドを集約しました。利用する側は <code>...stationF</code>という形で呼び出します。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">fragment stationF on Station &#123;</span><br><span class="line">  lineName</span><br><span class="line">  stationCD</span><br><span class="line">  stationName</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">query stationByCD &#123;</span><br><span class="line">  stationByCD(stationCD: <span class="number">1130201</span>) &#123;</span><br><span class="line">    ...stationF</span><br><span class="line">    beforeStation &#123;</span><br><span class="line">      ...stationF</span><br><span class="line">      transferStation &#123;</span><br><span class="line">        ...stationF</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    afterStation &#123;</span><br><span class="line">      ...stationF</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>結果はフラグメントを利用する前と同様です。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"stationByCD"</span>: &#123;</span><br><span class="line">      <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">      <span class="attr">"stationCD"</span>: <span class="number">1130201</span>,</span><br><span class="line">      <span class="attr">"stationName"</span>: <span class="string">"大崎"</span>,</span><br><span class="line">      <span class="attr">"beforeStation"</span>: &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130202</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"五反田"</span>,</span><br><span class="line">        <span class="attr">"transferStation"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"lineName"</span>: <span class="string">"東急池上線"</span>,</span><br><span class="line">            <span class="attr">"stationCD"</span>: <span class="number">2600501</span>,</span><br><span class="line">            <span class="attr">"stationName"</span>: <span class="string">"五反田"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"lineName"</span>: <span class="string">"都営浅草線"</span>,</span><br><span class="line">            <span class="attr">"stationCD"</span>: <span class="number">9930205</span>,</span><br><span class="line">            <span class="attr">"stationName"</span>: <span class="string">"五反田"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"afterStation"</span>: &#123;</span><br><span class="line">        <span class="attr">"lineName"</span>: <span class="string">"JR山手線"</span>,</span><br><span class="line">        <span class="attr">"stationCD"</span>: <span class="number">1130229</span>,</span><br><span class="line">        <span class="attr">"stationName"</span>: <span class="string">"品川"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>フラグメントを活用すると、クエリ本体の密度が高まって良いですね。（SQLにもこういう文法が欲しい..）</p><p>見知ったデータで試すと意図したクエリになっているかすぐ分かるのでGraphQLの学習には向いているとおもいます。</p><h1 id="次の拡張にむけて"><a href="#次の拡張にむけて" class="headerlink" title="次の拡張にむけて"></a>次の拡張にむけて</h1><p>現状の実装ではいくつか課題が出ることが分かっています。ざっと問題になりやすいものだけ上げておきます</p><ol><li>N+1クエリ<ul><li>beforeStation/afterStation/transferStationなどResolverを分割したのは良いですが、gqlgen側によって1回ずつ実行されます。クエリによってはとても大きな負荷になりえます。対応策としては<code>DataLoader</code>と呼ばれるバッチ処理に対応したライブラリでサーバサイドを実装すると良いでしょう。</li></ul></li><li>それでも負荷が大きいクエリ対策<ul><li>サーバに負荷を書けるようなネストが深いクエリを実行されると、1のバッチ処理対応をしても負荷が高くなります。また、今回は駅名重複や乗り換え駅でしか複数件数が取得できず、かつ件数が限られるため良いですが、データによっては最大件数の制約をかけたほうが良いでしょう。クエリの複雑とその制約に関しては <a href="https://gqlgen.com/reference/complexity/#limiting-query-complexity" target="_blank" rel="noopener">Limiting Query Complexity</a>で指定ができるようです</li></ul></li><li>認証認可<ul><li>GraphQLの仕様とは外れますが、実アプリだと認証認可が必要になってくると思います。認証については<a href="https://gqlgen.com/recipes/authentication/" target="_blank" rel="noopener">Recipes/Autehtification</a>で触れられています。認可もこのページの<code>directives</code>という仕組みで対応できるか検討します</li></ul></li></ol><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>GraphQL クエリを学ぶ場合、スターウォーズや英語版ポケモンに馴染みがあればそれらを用いる良いでしょう。もし駅や路線の方が理解しやすいのであれば、今回実装したサーバを用いると便利だと思います。少しでも皆さまのGraphQLライフの参考になればと思います。</p><p>GraphQLサーバを実装について。実装前はイマイチどこまでがフレームワークが担って、どこから個別実装なのかよく理解できていませんでしたが、実際に手を動かすことによって、その区別が非常にクリアになりました。仕組みが分かるとこのクエリは負荷が高そうだということもすぐ分かるようになると思います。今回は鉄道路線のデータを利用しましたが、他にも公開されているデータを用いたサンプルアプリ実装が増える流れになると良いですね。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">Technology Innovation Groupの略で、フューチャーの中でも特にIT技術に特化した部隊です。その中でもDXチームは特にデジタルトランスフォーメーションに関わる仕事を推進していくチームです。</span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200609/top.png&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200529/&quot;&gt;春の入門祭り&lt;/a&gt;の7日目です。&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="GraphQL" scheme="https://future-architect.github.io/tags/GraphQL/"/>
    
      <category term="PostgreSQL" scheme="https://future-architect.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
</feed>
