<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>フューチャー技術ブログ</title>
  
  <subtitle>Future Tech Blog</subtitle>
  <link href="https://future-architect.github.io/atom.xml" rel="self"/>
  
  <link href="https://future-architect.github.io/"/>
  <updated>2021-05-14T05:43:37.050Z</updated>
  <id>https://future-architect.github.io/</id>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Flutterで技術ブログRSSリーダー</title>
    <link href="https://future-architect.github.io/articles/20210514a/"/>
    <id>https://future-architect.github.io/articles/20210514a/</id>
    <published>2021-05-13T15:00:01.000Z</published>
    <updated>2021-05-14T05:43:37.050Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIG DXユニット<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>真野です。</p><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の5日目です。昨日は鶴巻さんの<a href="/articles/20210513b/">Flutterレイアウト入門</a>でした。</p><p>この記事ではFlutterでRSSを用いてフューチャー技術ブログリーダーを作ろうと思います。</p><h2 id="RSSとは"><a href="#RSSとは" class="headerlink" title="RSSとは"></a>RSSとは</h2><blockquote><p>RSS（RDF Site Summary/Rich Site Summary）はXMLを応用したデータ形式の一種で、Webサイト内の新着ページや更新ページのタイトルやURL、更新日時、要約などを一覧形式で記述することができる。</p><ul><li><a href="https://e-words.jp/w/RSS%E3%83%95%E3%82%A3%E3%83%BC%E3%83%89.html">IT用語辞典</a></li></ul></blockquote><p>新着記事などの把握のためにサイトが配信しているXMLファイルのことですね。フューチャー技術ブログでは<a href="https://future-architect.github.io/atom.xml">atom.xml</a>を配信しています。</p><p>さきほどのatom.xmlのリンクを開いた人はほとんどいないと思いますが、<code>Atom 1.0</code> という一般的な形式で、記事数は <code>20件</code> を上限にして生成しています。本ブログは静的サイトジェネレータに<a href="https://hexo.io/">Hexo</a>を使っていて、atom.xmlの生成にはメジャーそうだった<a href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a>のデフォルトで出力しています。今の所この設定に運営の意思は働いていないので、要望/アドバイスがあればTwitterでコメント下さい。今回開発するリーダーではこれを入力に利用します。</p><h2 id="インプットを怠けてしまう"><a href="#インプットを怠けてしまう" class="headerlink" title="インプットを怠けてしまう"></a>インプットを怠けてしまう</h2><p>話は変わりますが、ITエンジニアにとってインプットを行わないと、<code>今までの知識や経験のみで判断することになり、新たな技術でより効率的なやり方を発想できなくなる</code> そうです。<a href="https://qiita.com/kotakanbe@github/items/32cf4eb3de1741af26fb">究極のIT系最新技術情報収集用Slackチーム公開</a>の記事に書いてありました。インプット大事ですよね。</p><p>モヒカンSlackチームは良いものですが、ワークスペース設定の宿命でデータが消えてしまい悲しいです。そこで自分のペースで自由自在にインプトットできるツールを欲する人は意外と多いのではないでしょうか。</p><p>そのため個人的な様々な要求に耐えられるRSSリーダーを作ろうと思いました。今回は左右のスワイプでスキップ・既読の操作を行えると気持ちが良いと思ったので記事の表示＋スワイプ操作ができることまでを題材とします。</p><h2 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h2><p><a href="https://flutter.dev/docs/get-started/install">get-started/install</a> に従い構築します。</p><p>自分の環境では以下です。</p><figure class="highlight bash"><figcaption><span>環境情報</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;flutter doctor</span><br><span class="line">Doctor summary (to see all details, run flutter doctor -v):</span><br><span class="line">[√] Flutter (Channel stable, 2.0.6, on Microsoft Windows [Version 10.0.19043.964], locale ja-JP)</span><br><span class="line">[√] Android toolchain - develop <span class="keyword">for</span> Android devices (Android SDK version 30.0.3)</span><br><span class="line">[√] Chrome - develop <span class="keyword">for</span> the web</span><br><span class="line">[√] Android Studio</span><br><span class="line">[√] IntelliJ IDEA Community Edition (version 2020.2)</span><br><span class="line">[√] VS Code (version 1.56.0)</span><br><span class="line">[√] Connected device (2 available)</span><br></pre></td></tr></table></figure><p>わたしの開発はIntelliJで行っていますが、VSCodeでも十分開発できるそうです。</p><h2 id="Widget開発"><a href="#Widget開発" class="headerlink" title="Widget開発"></a>Widget開発</h2><p>StatelessWidgetで作っていきます</p><p><code>lib/main.dart</code> に実装します。</p><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() =&gt; runApp(App());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">        title: <span class="string">&#x27;Future Tech Blog Reader&#x27;</span>,</span><br><span class="line">        theme: ThemeData(</span><br><span class="line">          primaryColor: Colors.white,</span><br><span class="line">        ),</span><br><span class="line">        home: TechBlog());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TechBlog</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TechBlogState createState() =&gt; _TechBlogState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TechBlogState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TechBlog</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 次から実装していきます。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>次章から <code>_TechBlogState</code> にメインのロジックを詰めていきます。</p><h2 id="RSSフィードの取得"><a href="#RSSフィードの取得" class="headerlink" title="RSSフィードの取得"></a>RSSフィードの取得</h2><p>まずはatom.xmlを取得しないと始まらないので、ファイルをダウンロードします。</p><p><a href="https://pub.dev/packages/http">http</a>パッケージを利用します。<code>pubspec.yaml</code>に以下を追記します。</p><figure class="highlight yml"><figcaption><span>pubspec.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">http:</span> <span class="string">^0.13.3</span></span><br></pre></td></tr></table></figure><p>Dartのコードでは以下のようにアクセスします。<code>response.body</code>で直接String型が取得できますが、利用している文字コードが不正なのか文字化けするので、<code>dart:convert</code> パッケージを用いて自前でUTF-8でデコードします。</p><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;dart:convert&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:http/http.dart&#x27;</span> <span class="keyword">as</span> http;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TechBlogState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TechBlog</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    fetchFeed();</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> fetchFeed() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> response = <span class="keyword">await</span> http</span><br><span class="line">        .<span class="keyword">get</span>(<span class="built_in">Uri</span>.parse(<span class="string">&#x27;https://future-architect.github.io/atom.xml&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (response.statusCode != <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> Exception(<span class="string">&#x27;Failed to fetch atom.xml&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    debugPrint(utf8.decode(response.bodyBytes))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここでXMLが問題なく表示できていれば、フィードの解析に進みます。</p><h2 id="RSSフィード解析"><a href="#RSSフィード解析" class="headerlink" title="RSSフィード解析"></a>RSSフィード解析</h2><p>atom.xml パース用の<a href="https://pub.dev/packages/webfeed">webfeed</a>と呼ばれるパッケージを利用します。 <code>_articles</code>のリストに結果を追加します。</p><figure class="highlight yml"><figcaption><span>pubspec.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">http:</span> <span class="string">^0.13.3</span></span><br><span class="line">  <span class="attr">webfeed:</span> <span class="string">^0.7.0</span></span><br></pre></td></tr></table></figure><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> _articles = &lt;AtomItem&gt;[];</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> fetchFeed() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">// 中略</span></span><br><span class="line">  <span class="keyword">final</span> atomFeed = AtomFeed.parse(utf8.decode(response.bodyBytes));</span><br><span class="line">  atomFeed.items!.forEach((item) =&gt; &#123;_articles.add(item)&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AtomFeed.parseで解析結果はドキュメントに書いてあるとおり、一通り必要な要素が入っています。必ずしも要素が入っているか保証されていないので、<code>String?</code> 型でした。</p><figure class="highlight dart"><figcaption><span>atom_item.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AtomItem</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> id;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> title;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">DateTime?</span> updated;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;AtomPerson&gt;? authors;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;AtomLink&gt;? links;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;AtomCategory&gt;? categories;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;AtomPerson&gt;? contributors;</span><br><span class="line">  <span class="keyword">final</span> AtomSource? source;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> published;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> content;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> summary;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> rights;</span><br><span class="line">  <span class="keyword">final</span> Media? media;</span><br><span class="line">  <span class="comment">// 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここの<code>id</code>が記事のURLになります。他には<code>title</code>、<code>published</code>のフィールドを利用します。</p><h2 id="リストの作成"><a href="#リストの作成" class="headerlink" title="リストの作成"></a>リストの作成</h2><p>先程取得した、_articleのリストをListViewに変換します。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> Scaffold(</span><br><span class="line">    appBar: AppBar(</span><br><span class="line">      title: Text(<span class="string">&#x27;Future Tech Blog Reader&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">    body: ListView.builder(</span><br><span class="line">      itemCount: _articles.length,</span><br><span class="line">      itemBuilder: (context, index) &#123;</span><br><span class="line">          <span class="keyword">return</span> ListTile(</span><br><span class="line">            leading: Text(_articles[index].published.toString()),</span><br><span class="line">            title: Text(_articles[index].title.toString()),</span><br><span class="line">            onTap: () =&gt; &#123;_launchURL(_articles[index].id.toString())&#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>URLを開くためには、<code>package:url_launcher/url_launcher.dart</code> パッケージを利用したヘルパー関数を用意すると良さそうです。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _launchURL(<span class="built_in">String</span> _url) <span class="keyword">async</span> =&gt; <span class="keyword">await</span> canLaunch(_url)</span><br><span class="line">    ? <span class="keyword">await</span> launch(_url)</span><br><span class="line">    : <span class="keyword">throw</span> <span class="string">&#x27;Could not launch <span class="subst">$_url</span>&#x27;</span>;</span><br></pre></td></tr></table></figure><p>これでスワイプなしで、技術ブログの記事をひらけるようになりました。</p><p>Androidの場合はブラウザの起動に権限設定が必要です。</p><figure class="highlight xml"><figcaption><span>AndroidManifest.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.QUERY_ALL_PACKAGES&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>エミュレータで動かしてみるとこんな感じです。</p><img src="/images/20210514a/Animation.gif" alt="モバイルアプリで実行例" wight="469" height="842" loading="lazy"><h2 id="スワイプでリストを閉じる"><a href="#スワイプでリストを閉じる" class="headerlink" title="スワイプでリストを閉じる"></a>スワイプでリストを閉じる</h2><p>次はスワイプで既読を管理する機能です。</p><p>需要が多いのか公式ドキュメントのCookbookに<a href="https://flutter.dev/docs/cookbook/gestures/dismissible">実装例</a>が照会されています。</p><p>さきほどのitemBuilderを<code>Dismissible</code>ウィジェットで拡張します。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">itemBuilder: (context, index) &#123;</span><br><span class="line">  <span class="keyword">final</span> item = _articles[index];</span><br><span class="line">  <span class="keyword">return</span> Dismissible(</span><br><span class="line">    key: Key(item.title.toString()),</span><br><span class="line">    onDismissed: (direction) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _articles.removeAt(index);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    background: Container(color: Colors.red),</span><br><span class="line">    secondaryBackground: Container(color: Colors.blue),</span><br><span class="line">    child: ListTile(</span><br><span class="line">      leading: Text(item.published.toString()),</span><br><span class="line">      title: Text(item.title.toString()),</span><br><span class="line">      onTap: () =&gt; &#123;_launchURL(item.id.toString())&#125;,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><code>background</code> が右スワイプ時の色、<code>secondaryBackground</code>が左スワイプ時の色です。</p><p><code>onDismissed</code> でスワイプ時のアクションを決められます。今回はスワイプされたらリストから除外するシンプルな実装をあげます。</p><p>動かしてみると以下のような使い勝手です。</p><img src="/images/20210514a/スワイプ.gif" alt="スワイプ動作イメージ" wight="469" height="842" loading="lazy"><p>気持ち良いですね…！！</p><p>デモ上はタイトルだけで判断して捨てていますが、本来はクリックして記事を一読してからスワイプするイメージです。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>RSSを読み込んでスワイプで記事を管理できるシンプルなリーダーを作りました。</p><p>今回はフューチャー技術ブログのみを対象としましたが、他のお気に入りのサイトを追加したり、左右のスワイプごとに別の機能を付けたり（後で読むとか）、新着を通知させたり色々アイデアを実装させてお楽しみいただけると幸いです。</p><p>初めてのFlutterでしたが、大きなハマりもなくレイアウトをXMLではなく、コードで記載することは新鮮でした。</p><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の5日目でした。次は越島さんの「FlutterでMONETマーケットプレイスAPIを使ってみた」です。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">Technology Innovation Group（TIG）は、「最先端、且つ先進的なテクノロジーのプロフェッショナル集団」、「プロジェクト品質と生産性の向上」、「自社サービス事業の立ち上げ」を主なミッションとする、技術部隊です。DXユニットとはデジタルトランスフォーメーションを推進するチームで、IoTやらMaaSなどのテクノロジーカットでビジネス転換を行っています。</span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;TIG DXユニット&lt;sup id=&quot;fnref:1&quot;&gt;&lt;a href=&quot;#fn:1&quot; rel=&quot;footnote&quot;&gt;1&lt;/</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Flutter" scheme="https://future-architect.github.io/tags/Flutter/"/>
    
    <category term="Flutter連載" scheme="https://future-architect.github.io/tags/Flutter%E9%80%A3%E8%BC%89/"/>
    
    <category term="RSS" scheme="https://future-architect.github.io/tags/RSS/"/>
    
  </entry>
  
  <entry>
    <title>Flutterレイアウト入門</title>
    <link href="https://future-architect.github.io/articles/20210513b/"/>
    <id>https://future-architect.github.io/articles/20210513b/</id>
    <published>2021-05-12T15:00:01.000Z</published>
    <updated>2021-05-14T05:40:11.717Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20210510a/">Dart/Flutter連載</a>の4記事目は、Flutterでの画面レイアウトの入門です。</p><p>Flutterを触ったことがない方にも「こんな感じで画面が作れるんだな」というイメージがつくようお伝えできればと思います。また、私がつまずいたWidgetのサイズ調整についても記載します。</p><h2 id="Scaffold-Widgetでベースとなるレイアウト構造を作成"><a href="#Scaffold-Widgetでベースとなるレイアウト構造を作成" class="headerlink" title="Scaffold Widgetでベースとなるレイアウト構造を作成"></a>Scaffold Widgetでベースとなるレイアウト構造を作成</h2><p>FlutterのUIは、Widgetと呼ばれる部品を組み合わせて構築します。</p><p>画面のベースとなるレイアウト構造は、Scaffold Widgetで定義します。Scaffold Widgetには、appBar, body, botomNavigationBar等のプロパティが用意されており、それぞれに各Widgetを配置することでページ上部のAppBarや下部のナビゲーションバー等を簡単に配置できます。ページのメインコンテンツはbodyに定義します。</p><p>FAB(フローティングアクションボタン)と呼ばれる、スマホアプリのUIでよく見かける画面上の浮いているようなボタンについても、Scaffoldプロパティに用意されており、配置位置も簡単に定義できます。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Scaffold(</span><br><span class="line">  <span class="comment">//　AppBarの表示</span></span><br><span class="line">  appBar: AppBar(</span><br><span class="line">    title: Text(<span class="string">&#x27;Flutter Demo&#x27;</span>),</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// ページのメインコンテンツ</span></span><br><span class="line">  body: ...,</span><br><span class="line">  <span class="comment">// フッターのナビゲーション</span></span><br><span class="line">  bottomNavigationBar: ...,</span><br><span class="line">  <span class="comment">// FAB(フローティングアクションボタン)</span></span><br><span class="line">  floatingActionButton: ...,</span><br><span class="line">  <span class="comment">// FABの位置</span></span><br><span class="line">  floatingActionButtonLocation: FloatingActionButtonLocation.centerDocked,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><img src="/images/20210513b/c319f243-8175-36f6-f541-de4ec59fb7d9.png" alt="フローティングアクションボタン" class="img-small-size" width="428" height="704"><h2 id="Widgetの配置に必須のColumn-Row-Widget"><a href="#Widgetの配置に必須のColumn-Row-Widget" class="headerlink" title="Widgetの配置に必須のColumn, Row Widget"></a>Widgetの配置に必須のColumn, Row Widget</h2><p>Widgetを垂直に並べたいときは、Column Widget, 水平に並べたいときはRow Widgetを用いて配置します。メイン軸方向にどのように配置するかを<code>mainAxisAlignment</code>プロパティで定義することができ、Column Widgetの場合は垂直方向、Row Widgetの場合は水平方向を指します。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">body: Column(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.start, <span class="comment">// ここで配置の仕方を定義</span></span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Card(color: Colors.yellow, child: Text(<span class="string">&#x27;text01&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>))),</span><br><span class="line">    Card(color: Colors.teal, child: Text(<span class="string">&#x27;text01&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>))),</span><br><span class="line">    Card(color: Colors.blueAccent, child: Text(<span class="string">&#x27;text01&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>))),</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure><img src="/images/20210513b/b1e35360-8fa9-84dc-8b0f-9df591516120.png" alt="mainAxisAlignmentのstart,center,spaceEvenly設定の表示位置" width="949" height="546" loading="lazy"><h2 id="意外と難しいWidgetのサイズ調整"><a href="#意外と難しいWidgetのサイズ調整" class="headerlink" title="意外と難しいWidgetのサイズ調整"></a>意外と難しいWidgetのサイズ調整</h2><p>Widgetのサイズは、直接的には指定せずにFlutterの自動調整に任せる場合も多く、異なる画面サイズにも柔軟に対応できて便利です。ただし明示的に指定していないため、意図しないサイズになってしまい戸惑うことがよくありました。</p><p>Widgetは、親Widgetから与えられた幅・高さの最大値と最小値をもとに、自身のサイズを決定します。<br><a href="https://flutter.dev/docs/development/ui/layout/constraints">https://flutter.dev/docs/development/ui/layout/constraints</a></p><p>ただし、与えられた最大値・最小値からどのようにサイズを決定するかは、Widgetによって異なり、またWidgetの親子関係によっても変わってきます。各Widgetのサイズ決定については私自身まだ理解できていない部分が多くありますが、一例としてContainer Widgetのサイズの挙動について紹介します。Container Widgetは明示的にサイズを指定することも可能ですが、今回は直接的な指定は行わない場合のサイズの挙動・調整について記載します。</p><h3 id="Container-Widgetのサイズ"><a href="#Container-Widgetのサイズ" class="headerlink" title="Container Widgetのサイズ"></a>Container Widgetのサイズ</h3><p>Container Widgetのサイズは、子要素の有無で違ってきます。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子要素がない場合は可能な限り最大サイズになる</span></span><br><span class="line">body: Container(color: Colors.yellow),</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子要素がある場合は子要素に応じた最小限のサイズになる</span></span><br><span class="line">body: Container(color: Colors.yellow, child: Text(<span class="string">&#x27;text&#x27;</span>)),</span><br></pre></td></tr></table></figure><img src="/images/20210513b/914c4dba-d8c4-700c-1aa0-35231a59c4b2.png" alt="mainAxisAlignmentのstart,center,spaceEvenly設定の表示位置" class="img-middle-size" width="1098" height="964" loading="lazy"><h3 id="Column-Widgetでラップした際のContainer-Widgetのサイズ"><a href="#Column-Widgetでラップした際のContainer-Widgetのサイズ" class="headerlink" title="Column Widgetでラップした際のContainer Widgetのサイズ"></a>Column Widgetでラップした際のContainer Widgetのサイズ</h3><p>単純にColumn Widgetでラップした場合は、最小限のサイズになります。</p><p>さらにContainer WidgetをExpanded Widgetでラップすると、メイン軸方向(Columnの場合は垂直方向）にサイズを拡張してくれます。また、Expanded Widgetの<code>Flex</code>プロパティで、各Widgetを均等な大きさにしたり大きさの割合を指定できます。</p><p>垂直方向へのサイズの拡張は、Column Widgetの<code>CrossAxisAlignment</code>プロパティにCrossAxisAlignment.stretchを指定することで可能になります。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Column Widgetのみ</span></span><br><span class="line">body: Column(</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Container(color: Colors.yellow, child: Text(<span class="string">&#x27;text&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>))),</span><br><span class="line">    Container(color: Colors.teal, child: Text(<span class="string">&#x27;text&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>))),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line"></span><br><span class="line"><span class="comment">// Column Widget + Expanded Widget</span></span><br><span class="line">body: Column(</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Expanded(flex: <span class="number">1</span>, child: Container(color: Colors.yellow, child: Text(<span class="string">&#x27;text&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>)))),</span><br><span class="line">    Expanded(flex: <span class="number">1</span>, child: Container(color: Colors.teal, child: Text(<span class="string">&#x27;text&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>)))),</span><br><span class="line">  ],</span><br><span class="line">),</span><br><span class="line"></span><br><span class="line"><span class="comment">// Column Widget + Expanded Widget + CrossAxisAlignment.stretch</span></span><br><span class="line">body: Column(</span><br><span class="line">  crossAxisAlignment: CrossAxisAlignment.stretch,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Expanded(flex: <span class="number">1</span>, child: Container(color: Colors.yellow, child: Text(<span class="string">&#x27;text&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>)))),</span><br><span class="line">    Expanded(flex: <span class="number">1</span>, child: Container(color: Colors.teal, child: Text(<span class="string">&#x27;text&#x27;</span>, style: TextStyle(fontSize: <span class="number">40</span>)))),</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure><img src="/images/20210513b/524888ee-5362-c8d3-5260-e01df14a038c.png" alt="mainAxisAlignmentのstart,center,spaceEvenly設定の表示位置" width="1200" height="727" loading="lazy"><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>Flutterの画面構築は細かく位置やサイズを指定しなくても、それらしいUIが作れるため、かなりスピーディーに開発ができる印象です。その反面、Widgetのサイズ決定の理解に難しさも感じています。</p><p>今回はレイアウト作成の導入的な記事となりましたが、より理解が進んだ後にWidgetのサイズ決定についても記事化できればと思います。</p><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の4記事目でした。明日は真野さんの<a href="/articles/20210514a/">Flutterで技術ブログRSSリーダー</a>の記事です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/articles/20210510a/&quot;&gt;Dart/Flutter連載&lt;/a&gt;の4記事目は、Flutterでの画面レイアウトの入門です。&lt;/p&gt;
&lt;p&gt;Flutterを触ったことがない方にも「こんな感じで画面が作れるんだな」というイメージがつくようお伝え</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Flutter" scheme="https://future-architect.github.io/tags/Flutter/"/>
    
    <category term="Flutter連載" scheme="https://future-architect.github.io/tags/Flutter%E9%80%A3%E8%BC%89/"/>
    
    <category term="モバイル" scheme="https://future-architect.github.io/tags/%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB/"/>
    
  </entry>
  
  <entry>
    <title>背が高いエンジニアが考えるリモートワーク環境</title>
    <link href="https://future-architect.github.io/articles/20210513a/"/>
    <id>https://future-architect.github.io/articles/20210513a/</id>
    <published>2021-05-12T15:00:00.000Z</published>
    <updated>2021-05-13T00:48:59.471Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20210513a/IMG_0030.jpg" alt="おしゃれな自宅デスク画像" width="1200" height="800">※写真は実際の私のデスク環境です<p>こんにちは。TIGの<a href="https://twitter.com/kaedemalu">伊藤太斉</a>です。<a href="/articles/20210118/">リモートワーク連載</a>の6本目です。</p><p>リモートワークになって以来、私も多くの方と同じようにリモートワーク環境を整えてきました。将来の投資と自分に言い聞かせながらかなり投資してしまいましたが、満足した環境ができたのでこの記事で紹介します。</p><p>そんな私のリモートワーク環境ですが、「自分の体格に合わせる」という他の方とちょっと違う観点で環境構築してみたので、体格が平均から大きく離れている方は、ぜひこの記事を参考にしていただければと思います。この記事は購入したものの紹介もしますが、デスク設計の上で「何故そうしたか」も書いていきます。</p><h2 id="私のプロフィール"><a href="#私のプロフィール" class="headerlink" title="私のプロフィール"></a>私のプロフィール</h2><p>はじめに、私の体格やら住んでいる部屋について書いていきます。</p><ul><li>身長188cmの痩せ型</li><li>10畳1Kのマンション（角部屋なので2面採光）</li><li>駅から徒歩15分</li></ul><h2 id="自宅で環境を整備できる良さ"><a href="#自宅で環境を整備できる良さ" class="headerlink" title="自宅で環境を整備できる良さ"></a>自宅で環境を整備できる良さ</h2><p>会社で自分の環境を整えるとなると、</p><ul><li>キーボード</li><li>マウス</li><li>（モニター）</li></ul><p>くらいかなと思いますが、自宅であればそれに加えて、</p><ul><li>デスク</li><li>椅子</li><li>etc…</li></ul><p>と際限なく環境を整えることができます。特に会社だと制約のあるデスクと椅子についてはオフィスでは一般的な体格に合わせて作られているため、人と極端に体格が違うと負荷も大きくなります。体の負荷を軽減するという意味で仕事環境にまつわる全てを好きな物を用意できるというのは自宅ならではだと思います。</p><h2 id="リモートワークになるに当たって買ったもの一覧"><a href="#リモートワークになるに当たって買ったもの一覧" class="headerlink" title="リモートワークになるに当たって買ったもの一覧"></a>リモートワークになるに当たって買ったもの一覧</h2><p>ここから実際にリモートワークを始めて買ったものを紹介します。まずはじめに一覧です。</p><ul><li>27インチ4Kモニター</li><li>コンデンサーマイク</li><li>Webカメラ</li><li>キーボード2種類</li><li>スタンディングデスク</li><li>オフィスチェア</li><li>PCスタンド</li><li>モニターアーム</li></ul><p>書き上げてみたらほぼフルセット買っていたことに気がついてしまいました笑。</p><h3 id="モニタ"><a href="#モニタ" class="headerlink" title="モニタ"></a>モニタ</h3><p>モニタは27インチの4Kモニターを買いました。会社で4Kモニターを使って以来フルHDに戻れなくなってしまったこと、PCとの接続はThunderbolt1つで、モニターをハブとして使えることから<a href="https://www.amazon.co.jp/gp/product/B085TWLMF9">DELLのモニター</a>を買いました。接続するものが多い方にはハブ、もしくはハブ機能を有するモニターをお勧めします。一度に表示できるコードが多い方が効率面から考えても良いです。<br>お気に入りポイントはケーブル１本でPCとの接続を管理できるところです。プライベート環境もiMacからMacBookに変えてデスク環境を組み直したので、プライベートと仕事をケーブル一つで切り替えできるのはやはり楽です。</p><h3 id="コンデンサーマイク"><a href="#コンデンサーマイク" class="headerlink" title="コンデンサーマイク"></a>コンデンサーマイク</h3><p>カンファレンス運営で声の出演をすることもあり、その時にマイクを買いました。リモートだとカメラの画質よりも声で印象が決まりやすい（と思う）ので、買っておいて良かったと思っています。近頃はもう少し良いマイクに変えても良い気もしてきました。沼ですね。<br>現状使っているマイクは品薄な時に買った7000円くらいのUSBタイプのマイクです。</p><h3 id="Webカメラ"><a href="#Webカメラ" class="headerlink" title="Webカメラ"></a>Webカメラ</h3><p>本来はノートPCのカメラで事足りるので割と悩んだものではありますが、モニターは外部モニター1枚あれば十分なので、PCを閉じて使うために買いました。購入したのは<a href="https://www.amazon.co.jp/gp/product/B07QQR6G5N">Logicoolのカメラ</a>です。<br>Webカメラを導入したことにもいくつか意図はあり、目線の高さにカメラがあることで、</p><ul><li>顔が暗くなりにくい</li><li>カメラを見て話せる（目を見て話す状態に近づけられる）</li></ul><p>といった印象に関わる部分もよりよくすることができます。<br>また、登壇などよりきれいに写したい場合には、Canonの一眼レフを接続して利用いています。</p><h3 id="キーボード2種類"><a href="#キーボード2種類" class="headerlink" title="キーボード2種類"></a>キーボード2種類</h3><p>キーボードは気分転換も込めて2種類を行き来して使っています。使っているのは</p><ul><li>Corne Cherry</li><li>Realforce for Mac</li></ul><p>です。<br>Realforce（アイキャッチ画像参照）は全然買うつもりがなかったのですが、後述するCorne Cherryで失ったファンクションキーなど、本来キーボードが有しているであろうキーが必要な時もあることに気がついたので買いました。使い心地は言うまでもなく最高です。今では、時々入れ替えながら使ってリフレッシュしています。<br><del>最近、比較的キーが揃った分割を買えばいいのではということに気がつきました。</del><br>Corne Cherryを買う（作る）経緯については、昔話があります。</p><p>前職から<a href="https://ergodox-ez.com/">Ergodox</a>という分割キーボードを使っていたので、リモートワークになって以来、家でも継続して使っていました。しかし、会社が自由出社になり、これを持ち運ぶとしても身体への負担が大きいことを感じました（あとキースイッチの音が少々うるさい）。そこで小さい分割キーボードが欲しくなったのですが、既製品では希望に沿うものがなかったのでCorne Cherryを作ることにしました。作った時のことは<a href="https://kaedem-dev.hatenablog.com/entry/2020/11/23/155602">個人ブログ</a>に書いてあるのでぜひ読んでみてください。買ったところはみなさん大好きな<a href="https://yushakobo.jp/">遊舎工房</a>さんです。ちなみに、大きさ比較をしましたが、差は歴然でした。</p><img src="/images/20210513a/IMG_7341.jpg" alt="分割キーボード" width="1200" height="800" loading="lazy"><p>ここで、分割キーボードを使うことと、極端にキーが少ないことについて疑問を感じる方もいると思いますのでそこについての考えを書きます。</p><h4 id="分割キーボードを使うこと"><a href="#分割キーボードを使うこと" class="headerlink" title="分割キーボードを使うこと"></a>分割キーボードを使うこと</h4><p>分割キーボードを使うことは単に「身体のため」と思って使っています。通常のキーボードだと胸が塞がる姿勢になり、猫背になりやすくなります。結果、肩こりなど不調をきたすことにつながります。特に肩幅も少しあったり、体格が大きい方はこの塞ぎ込みがよりキツくなることもあり、私は早々に分割キーボードに手を出しました。初めは全く慣れなくて作業効率ガタ落ちでしたが、今ではなくてはならない仕事のお供になりました。</p><h4 id="キー数が少ないこと"><a href="#キー数が少ないこと" class="headerlink" title="キー数が少ないこと"></a>キー数が少ないこと</h4><p>Ergodoxを使っていた時に思っていたのが「1日1回も押さないキー」があることでした。利用しないところに場所を取られているのは非常にもったいないことですし、先述した出社も重なり、キー数を削る決断をしました。本来必要なキーすらも削っているのですが、良かったことは指を伸ばし切らなくても全部のキーを触れることです。そのため、指が疲れにくくなった気がします。また、Ergodoxを使っていた時に感じていた不要なキーについても見事にクリアされ、押さないキーはなくなりました。</p><h3 id="スタンディングデスク"><a href="#スタンディングデスク" class="headerlink" title="スタンディングデスク"></a>スタンディングデスク</h3><p>これはあまり買うつもりがなかったのですが、座り続けていることのデメリットも叫ばれる中、身体のためと思って買いました。<br>買ったのはこれも有名なFlexiSpotの<a href="https://flexispot.jp/desk/height-adjustable-desks/e3-set.html">E3</a>を買いました。理由としてはFlexiSpotの中で一番高いところまでデスクを上げられるため選びました。午後の眠い時やリフレッシュしたい時にはとても重宝しています。<br>購入の際に、<a href="https://flexispot.jp/desk/height-adjustable-desks/ej2-set.html">EJ2</a>という少し安めなデスクも候補にあり、相当悩みました。最大の悩みポイントは昇降範囲で、購入したE3の方がより高く設定できます。ただ、私でも上限まで使うことがなかったため、よっぽどのことがない限りEJ2の方が選択肢としては良いかもしれません（何より値段と重量が上がることがネックです。。）。<br>FlexiSpotは天板と脚が別売りなのですが、天板も公式から140x70cmの広めのサイズを購入しました。PCを2つおいても余裕が持てるので結果としては良かったです。そして、部屋の中に占めるデスクの圧迫感も増しました。</p><h3 id="オフィスチェア"><a href="#オフィスチェア" class="headerlink" title="オフィスチェア"></a>オフィスチェア</h3><p>オフィスチェアはずっと憧れていたハーマンミラーの<a href="https://store.hermanmiller.co.jp/c/chairs/office_chairs/AS1YA23/AS1YA23HAN265BBRO829112">セイルチェア</a>を買いました。良かったところは</p><ul><li><strong>オシャレ</strong></li><li>ハーマンミラーの中でも比較的安価</li><li>機能が多すぎない</li></ul><p>です。給付金がセイルチェアになりましたが、スタイリッシュなデスクの一助になっています。ハーマンミラーのオフィスチェアの設計で多く使われている、背もたれを前傾にする機能は集中したい時に役立っています。毎日使うものなのでお気に入りの家具として気分を上げてくれるものになりました。</p><h3 id="モニターアーム"><a href="#モニターアーム" class="headerlink" title="モニターアーム"></a>モニターアーム</h3><p>一番こだわりのないところがモニターアームですが、買ってみて納得する良さもありました。</p><ul><li>付属のスタンドより高く設定できる</li><li>デスクにホコリがたまりにくくなった（掃除がしやすい）</li></ul><p>良さを上げるとするとこれくらいですが、ちゃんと使い込めば、モニターの位置を変えることも簡単だというところも良さですが、ほとんど使わない機能なのであまり恩恵を享受していません。</p><p>モニターの位置をしっかり設定できることは大きなメリットがあると考えています。モニターを覗き込む姿勢は、猫背になったり、ストレートネックの原因になると散々言われていることなので、この辺は元々気をつけいていました。また、効率面を考えても広い画面を使いたいので、モニターは必須です。<br>モニターの高さは一般的には目線がモニターの上辺に来るようにと言うのがよく言われているため、私もその高さで設定しています。</p><h3 id="おまけ：マウス"><a href="#おまけ：マウス" class="headerlink" title="おまけ：マウス"></a>おまけ：マウス</h3><p>エンジニアになって初めて買ったのがLogicoolの<a href="https://www.amazon.co.jp/dp/B074Z71C2M">トラックボールマウス</a>ですが、diagrams.netを使うときや、プライベートで写真を編集する時などの細かい作業にはとても向いていました。<br>加えて、Macの操作をより良くするトラックパッドも入れ替えながら使っています。トラックパッドについては<a href="/articles/20210219/">富山さんの記事</a>でも触れているのでぜひ見てください。</p><h2 id="完成形"><a href="#完成形" class="headerlink" title="完成形"></a>完成形</h2><p>そして、（今のところの）完成形を撮影しました。</p><img src="/images/20210513a/IMG_0854.JPG" alt="おしゃれな自宅デスクの完成形" width="1200" height="800" loading="lazy"><p>どこかのプロデューサーさんみたいなデスクになっていますが、好きなものに囲まれながら作り込んだデスクなので、楽しく仕事できています。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>家で環境を作り込める、ということは、好きなものを取り入れることはもちろんですが、自分の身体に合わせて設計できることだと思っているので、並外れて体格の異なる方はぜひ身体を合わせずに、道具を自身に合わせて健康に働けるようにしましょう！</p><p><a href="/articles/20210118/">リモートワーク連載</a>に他のリモートワーク環境構築例がありますので、探してもらえると嬉しいです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;/images/20210513a/IMG_0030.jpg&quot; alt=&quot;おしゃれな自宅デスク画像&quot; width=&quot;1200&quot; height=&quot;800&quot;&gt;
※写真は実際の私のデスク環境です

&lt;p&gt;こんにちは。TIGの&lt;a href=&quot;https://twit</summary>
      
    
    
    
    <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
    <category term="リモートワーク" scheme="https://future-architect.github.io/tags/%E3%83%AA%E3%83%A2%E3%83%BC%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF/"/>
    
  </entry>
  
  <entry>
    <title>Goのサーバーの管理画面をFlutter Webで作ってみるための調査</title>
    <link href="https://future-architect.github.io/articles/20210512a/"/>
    <id>https://future-architect.github.io/articles/20210512a/</id>
    <published>2021-05-11T15:00:00.000Z</published>
    <updated>2021-05-14T05:17:15.427Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20210510a/">Dart/Flutter連載</a>の3本目はFlutter Webを紹介します。</p><p>Flutter 2になって、Web向けに出力する機能もStableになりました。</p><p>Flutter for Webは標準のHTMLにするHTMLレンダラーと、CanvasKitレンダラーと2種類あります。後者はSkiaという2DグラフィックスのライブラリをWebAssembly化したものを使います。Skiaはウェブ向けではないFlutterでも使っているため、モバイルとの互換性の高さが期待されます。</p><p>現状では明示的に指定しなければauto（モバイルはHTMLレンダラー、PCはCanvasKitレンダラー）になりますが、明示的に指定もできます。これらの違いはまた後で触れますが、せっかくウェブが出せるようになったので、ウェブフロントエンドをFlutterで作ってみるための色々調査をしてみました。React/Vue/Angularを一通り業務で使ってみましたし、フロントエンド開発周りもここ5-6年ぐらい、書き方が違うぐらいでやっていることはあんまり変わらなくて個人的に飽きてきたこともあります。</p><h1 id="ウェブアプリといえばRouter"><a href="#ウェブアプリといえばRouter" class="headerlink" title="ウェブアプリといえばRouter"></a>ウェブアプリといえばRouter</h1><p>SPAで管理画面を作っていく上で、最低限必要なことはRouterと呼ばれる機能です。VueやAngularだと標準で用意されています。Reactは標準はないですが、使うときはだいたい何かしら入れるでしょう。</p><p>FlutterはデフォルトでNavigotorというクラスがあります。以下のページがめちゃくちゃまとまっていますので、詳細はこちらをご覧ください。</p><p><a href="https://medium.com/flutter/learning-flutters-new-navigation-and-routing-system-7c9068155ade">https://medium.com/flutter/learning-flutters-new-navigation-and-routing-system-7c9068155ade</a></p><p>ウェブアプリケーションユーザー目線で、いくつか知っておくべきポイントがあります。</p><ul><li>1.0と2.0と大きく2種類に分かれる（ここでは2を扱います）ので、ウェブを検索して出てきた内容を参考にするには利用バージョンと同じかどうか注意が必要</li><li>サンプルの一番シンプルな書き方だと、URLのパスを決めるのではなく、その場でウィジェットを上書きする（pushする）モードで、ウェブのよくある挙動とは違う動きになる</li><li>named navigator routesという、ウェブのRouterに近い、パスのルールとその時の表示するウィジェットのマッピングを定義するモードもある（ネストもできる）</li><li>named navigator routesでデフォルトはハッシュを挟んだパスになる（AngularでいうところのHashLocationStrategy）が、PathLocationStrategyも設定可能</li><li>パスの一部をパラメータとして利用しようとすると面倒</li></ul><p>あとは次のあたりも僕がFlutterを学び始めたときにちょっと悩んだポイントです。</p><ul><li>statefulとstatelessでウィジェットを作り分ける必要がある</li><li>buildメソッドはReactのrender</li><li>builderという言葉はVueのslot的な、特定のライフサイクルで呼ばれてビューの一部を返す何か←某握力王の人に教えてもらいました</li><li>debug(）関数でconsole.logに出力できる</li></ul><h2 id="最小のRouter"><a href="#最小のRouter" class="headerlink" title="最小のRouter"></a>最小のRouter</h2><p>次のコードが↑に書いてあるnamed navigator routesを使った最小のコードです。2つの画面の間の遷移をします。まず、ルートのMaterialAppに、routesの引数でURLとページのマップを定義します。あとは、Navigatorクラスを使って、pushNamed()メソッドや、pop()メソッドを使ってページ遷移ができます。よくあるSPAと変わらないですね。</p><figure class="highlight dart"><figcaption><span>lib/main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  configureApp();</span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This widget is the root of your application.</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      routes: &#123;</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span>: (context) =&gt; HomeScreen(),</span><br><span class="line">        <span class="string">&#x27;/details&#x27;</span>: (context) =&gt; DetailScreen(),</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeScreen</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: TextButton(</span><br><span class="line">          child: Text(<span class="string">&#x27;View Details&#x27;</span>),</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            Navigator.pushNamed(context, <span class="string">&#x27;/details&#x27;</span>);</span><br><span class="line">          &#125;,</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailScreen</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: TextButton(</span><br><span class="line">          child: Text(<span class="string">&#x27;Pop!&#x27;</span>),</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            Navigator.pop(context);</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>こちらができあがりです。Android Studioで作った環境でウェブで表示してみたものになります。</p><img src="/images/20210512a/スクリーンショット_2021-05-11_8.49.21.png" alt="Routerのデモをウェブ表示" width="1200" height="1659"  loading="lazy"><p>なお、URLの一部がエンティティのIDとしてパスパラメータとして使いたい場合は、RouteInformationParserを継承したクラスを作ってアプリに渡す必要があります。上記のmediumのページの中でRouteInformationParserで検索して見てみれば書き方がわかりますが、面倒です。ここはそのうち改善されるのでは、ということを期待しています。</p><h2 id="ハッシュがURLに入ってしまうのをやめる"><a href="#ハッシュがURLに入ってしまうのをやめる" class="headerlink" title="ハッシュがURLに入ってしまうのをやめる"></a>ハッシュがURLに入ってしまうのをやめる</h2><p>PathLocationStrategy相当への切り替え方法については次のページで説明されています。</p><p><a href="https://flutter.dev/docs/development/ui/navigation/url-strategies">https://flutter.dev/docs/development/ui/navigation/url-strategies</a></p><p>まず、依存パッケージにflutter_web_pluginsを追加します。</p><figure class="highlight yaml"><figcaption><span>pubspec.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">flutter_web_plugins:</span></span><br><span class="line">    <span class="attr">sdk:</span> <span class="string">flutter</span></span><br></pre></td></tr></table></figure><p>次に、main関数の中で、URLのルールを変更します。↑のページには、Web向けとそれ以外向けでルールを切り替える方法も紹介されていますが、ここではウェブでしか使わない前提でシンプルにmainに書いてしまっています。</p><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_web_plugins/flutter_web_plugins.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    setUrlStrategy(PathUrlStrategy());</span><br><span class="line"></span><br><span class="line">    runApp(MyApp());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これでパスにハッシュが入ることがなくなりました。</p><img src="/images/20210512a/スクリーンショット_2021-05-11_8.56.50.png" alt="URLにハッシュが入っていないデモ画面" width="1006" height="260"  loading="lazy"><h1 id="Goのアプリケーションに組み込む"><a href="#Goのアプリケーションに組み込む" class="headerlink" title="Goのアプリケーションに組み込む"></a>Goのアプリケーションに組み込む</h1><p>Goで作ったサーバーの管理画面をFlutterで作る前提で、go:embedでアプリにバンドルしてみます。以前、本技術ブログでVueで行ったことをFlutterでもやってみます。</p><p><a href="https://future-architect.github.io/articles/20210408/">https://future-architect.github.io/articles/20210408/</a></p><p>まずビルドします。<a href="https://recruit.gmo.jp/engineer/jisedai/blog/flutter2-canvaskit-performance/">CanvasKitのほうが描画性能は高いとのこと</a>ですが、たぶん、レンダラーはHTMLが良いかと思います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flutter build web --web-renderer=html --source-maps</span><br></pre></td></tr></table></figure><p>ビルドオプションには–releaseをつけることができます。つけるとビルドは遅くなります（M1 MacBook Proで20秒ほど。つけないと0.3秒）。</p><p>ビルド結果は<code>build/web</code>フォルダに出力されます。</p><p>一見、CanvasKitもHTMLもファイルサイズがほとんど変わらない（3.4MBと3.5MB)のですが、CanvasKitでビルドすると、CanvasKitの本体のwasmのビルド済みのファイルをネット越しにダウンロードしているようです。これが2MBぐらいあるみたいですし、もしかしたらプロキシが必要なイントラネットで利用とか考えると、外部依存はないに越したことはありません。</p><figure class="highlight js"><figcaption><span>main.dart.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14151</span>:$<span class="number">2</span>:<span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;<span class="keyword">return</span><span class="string">&quot;https://unpkg.com/canvaskit-wasm@0.25.1/bin/&quot;</span>+a&#125;,</span><br><span class="line"><span class="number">41865</span>:s($,<span class="string">&quot;ae9&quot;</span>,<span class="string">&quot;a2x&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span><span class="string">&quot;https://unpkg.com/canvaskit-wasm@0.25.1/bin/canvaskit.js&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><p>Goのファイルをいくつか作成します。go:embedが、今いるフォルダよりも子供のフォルダしか読み込めないので、Flutterのルートのフォルダでgo mod init flutter_with_goを叩いて、go.modを作成します。</p><p>ファイルを参照するgo:embedは次のように書きます。</p><figure class="highlight go"><figcaption><span>asest.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> flutter_with_go</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;embed&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed build/web/*</span></span><br><span class="line"><span class="keyword">var</span> assets embed.FS</span><br></pre></td></tr></table></figure><p>NotFoundHandlerハンドラーは<a href="https://future-architect.github.io/articles/20210408/">前回の記事のファイルの配信のハンドラー</a>で紹介したコードとほぼ同じです。ファイルの置き場をプロジェクトルートにしてみたのと、パスがbuild/webになったぐらいです。main関数もほぼ以前と同じです。</p><p>無事、GoでもFlutter Webのビルド結果をホストできました。</p><img src="/images/20210512a/スクリーンショット_2021-05-11_18.15.39.png" alt="GoでもFlutter Webのビルド結果をホストしたデモ表示" width="1200" height="1398"  loading="lazy"><p>今回のフォルダ構成は次の通りです。Goのコードはserverみたいなサブパッケージを作って入れてもよかったかも。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── android</span><br><span class="line">├── asset.go</span><br><span class="line">├── cmd</span><br><span class="line">│   └── flutter_with_go</span><br><span class="line">│       └── main.go</span><br><span class="line">├── flutter_with_go.iml</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── ios</span><br><span class="line">├── lib</span><br><span class="line">│   └── main.dart</span><br><span class="line">├── notfound.go</span><br><span class="line">├── pubspec.lock</span><br><span class="line">├── pubspec.yaml</span><br><span class="line">└── web</span><br><span class="line">    ├── favicon.png</span><br><span class="line">    ├── icons</span><br><span class="line">    │   ├── Icon-192.png</span><br><span class="line">    │   └── Icon-512.png</span><br><span class="line">    ├── index.html</span><br><span class="line">    └── manifest.json</span><br></pre></td></tr></table></figure><h1 id="サーバーへのHTTPアクセス"><a href="#サーバーへのHTTPアクセス" class="headerlink" title="サーバーへのHTTPアクセス"></a>サーバーへのHTTPアクセス</h1><p>静的HTMLを表示するだけでは管理画面にはなりませんので、HTTPアクセスを行ってみます。より高度なサービスになると、昨日のエントリーの<a href="https://future-architect.github.io/articles/20210511b/">Swaggerを使ったサーバーアクセス</a>や、GraphQLやgRPCを使いたくなるかもしれません。今時なプロトコルはどれでも利用できるのも、Flutterの良いところですが、今回はシンプルなHTTPアクセスをします。</p><p>題材としては今話題沸騰のイケてるWeb APIである<a href="https://kenall.jp/">ケンオール</a>にアクセスしてみます。</p><img src="/images/20210512a/スクリーンショット_2021-05-11_20.34.54.png" alt="ケンオールのサイト画面" width="1200" height="952"  loading="lazy"><p>ケンオールはアカウント登録するとAPIキーが発行され、これを使ってアクセスします。サンプルと言えど、APIキーはフロントエンドに置きたくないので、サーバー側で中継することとします。</p><h2 id="サーバー側の実装"><a href="#サーバー側の実装" class="headerlink" title="サーバー側の実装"></a>サーバー側の実装</h2><p><code>/api/postal/&#123;code&#125;</code>にアクセスしたら、住所情報を返すAPIをGoで実装しました。APIキーは環境変数で渡します。Vue.jsのときのサンプルの差分だけ表示します。</p><figure class="highlight go"><figcaption><span>cmd/flutter_with_go/main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> Env <span class="keyword">struct</span> &#123;</span><br><span class="line">Port         <span class="keyword">uint16</span> <span class="string">`envconfig:&quot;PORT&quot; default:&quot;8000&quot;`</span></span><br><span class="line">KenAllAPIKey <span class="keyword">string</span> <span class="string">`envconfig:&quot;KENALL_API_KEY&quot; required:&quot;true&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newHandler</span><span class="params">(apiKey <span class="keyword">string</span>)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">router := chi.NewRouter()</span><br><span class="line"></span><br><span class="line">router.Route(<span class="string">&quot;/api&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(r chi.Router)</span></span> &#123;</span><br><span class="line">r.Get(<span class="string">&quot;/postal/&#123;code&#125;&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">code := chi.URLParam(r, <span class="string">&quot;code&quot;</span>)</span><br><span class="line">req, _ := http.NewRequestWithContext(r.Context(), <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;https://api.kenall.jp/v1/postalcode/&quot;</span>+code, <span class="literal">nil</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Token &quot;</span>+apiKey)</span><br><span class="line">res, err := http.DefaultClient.Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> res.Body.Close()</span><br><span class="line">io.Copy(w, res.Body)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.NotFound(flutter_with_go.NotFoundHandler)</span><br><span class="line"><span class="keyword">return</span> router</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// これの前後は同じ</span></span><br><span class="line">server := &amp;http.Server&#123;</span><br><span class="line">Addr:    <span class="string">&quot;:&quot;</span> + strconv.FormatUint(<span class="keyword">uint64</span>(env.Port), <span class="number">10</span>),</span><br><span class="line">Handler: newHandler(env.KenAllAPIKey),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ビルドしたら試しにcurlでこのサーバーAPIを叩いてみます。バッチリですね(長いのでレスポンスは短くしてます)。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">% curl http://localhost:8000/api/postal/1410032</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;2021-04-30&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;postal_code&quot;</span>: <span class="string">&quot;1410032&quot;</span>,</span><br><span class="line">      <span class="string">&quot;prefecture_kana&quot;</span>: <span class="string">&quot;トウキョウト&quot;</span>,</span><br><span class="line">      <span class="string">&quot;city_kana&quot;</span>: <span class="string">&quot;シナガワク&quot;</span>,</span><br><span class="line">      <span class="string">&quot;town_kana&quot;</span>: <span class="string">&quot;オオサキ&quot;</span>,</span><br><span class="line">      <span class="string">&quot;prefecture&quot;</span>: <span class="string">&quot;東京都&quot;</span>,</span><br><span class="line">      <span class="string">&quot;city&quot;</span>: <span class="string">&quot;品川区&quot;</span>,</span><br><span class="line">      <span class="string">&quot;town&quot;</span>: <span class="string">&quot;大崎&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="フロント側の実装"><a href="#フロント側の実装" class="headerlink" title="フロント側の実装"></a>フロント側の実装</h2><p>フロント側からはサーバーアクセスをさせたいと思います。状態をもつのでstatefulなウィジェットとします。</p><figure class="highlight dart"><figcaption><span>lib/main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This widget is the root of your application.</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: Scaffold(</span><br><span class="line">        appBar: AppBar(</span><br><span class="line">          title: Text(<span class="string">&#x27;KenAll Sample&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">        body: Center(</span><br><span class="line">          child: KenAll(),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KenAll</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _KenAllState createState() =&gt; _KenAllState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>実サーバーアクセスと表示を行う部分はこちらです。フィールドの入力が7文字になったらサーバーアクセスを行い、取得してきた情報をStateに入れています。</p><figure class="highlight dart"><figcaption><span>lib/main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_KenAllState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">KenAll</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _formKey = GlobalKey&lt;FormState&gt;();</span><br><span class="line">  <span class="built_in">String</span> prefecture = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">String</span> city = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">String</span> town = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">String</span> koaza = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">String</span> kyoto_street = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">String</span> building = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="built_in">String</span> floor = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Form(</span><br><span class="line">      key: _formKey,</span><br><span class="line">      child: Column(</span><br><span class="line">        children: [</span><br><span class="line">          TextFormField(</span><br><span class="line">            decoration: InputDecoration(</span><br><span class="line">              filled: <span class="keyword">true</span>,</span><br><span class="line">              hintText: <span class="string">&#x27;Enter a postal code...&#x27;</span>,</span><br><span class="line">              labelText: <span class="string">&#x27;Postal Code&#x27;</span>,</span><br><span class="line">            ),</span><br><span class="line">            onChanged: (value) <span class="keyword">async</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (value.length == <span class="number">7</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> response = <span class="keyword">await</span> http.<span class="keyword">get</span>(<span class="built_in">Uri</span>.parse(<span class="string">&#x27;/api/postal/<span class="subst">$&#123;value&#125;</span>&#x27;</span>));</span><br><span class="line">                debugPrint(response.body);</span><br><span class="line">                <span class="keyword">if</span> (response.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">                  <span class="keyword">final</span> json = jsonDecode(response.body);</span><br><span class="line">                  <span class="keyword">final</span> body = json[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>];</span><br><span class="line">                  <span class="built_in">print</span>(body);</span><br><span class="line">                  setState(() &#123;</span><br><span class="line">                    prefecture = body[<span class="string">&#x27;prefecture&#x27;</span>];</span><br><span class="line">                    city = body[<span class="string">&#x27;city&#x27;</span>];</span><br><span class="line">                    town = body[<span class="string">&#x27;town&#x27;</span>];</span><br><span class="line">                    koaza = body[<span class="string">&#x27;koaza&#x27;</span>];</span><br><span class="line">                    kyoto_street = body[<span class="string">&#x27;kyoto_street&#x27;</span>];</span><br><span class="line">                    building = body[<span class="string">&#x27;building&#x27;</span>];</span><br><span class="line">                    floor = body[<span class="string">&#x27;floor&#x27;</span>];</span><br><span class="line">                  &#125;);</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              setState(() &#123;</span><br><span class="line">                prefecture = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                city = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                town = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                koaza = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                kyoto_street = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                building = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                floor = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">          Expanded(</span><br><span class="line">            child:  ListView(</span><br><span class="line">              children: [</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;Prefecture&#x27;</span>),</span><br><span class="line">                  title: Text(prefecture),</span><br><span class="line">                ),</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;City&#x27;</span>),</span><br><span class="line">                  title: Text(city),</span><br><span class="line">                ),</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;Town&#x27;</span>),</span><br><span class="line">                  title: Text(town),</span><br><span class="line">                ),</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;Koaza&#x27;</span>),</span><br><span class="line">                  title: Text(koaza),</span><br><span class="line">                ),</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;Kyoto Street&#x27;</span>),</span><br><span class="line">                  title: Text(kyoto_street),</span><br><span class="line">                ),</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;Building&#x27;</span>),</span><br><span class="line">                  title: Text(building),</span><br><span class="line">                ),</span><br><span class="line">                ListTile(</span><br><span class="line">                  leading: Text(<span class="string">&#x27;Floor&#x27;</span>),</span><br><span class="line">                  title: Text(floor),</span><br><span class="line">                ),</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ]</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>このHTTPアクセスには外部パッケージが必要なため、pubspec.yamlとHTTPリクエストを送っているコードへのimportの追加を行いま。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dependencies:</span><br><span class="line"> http: ^0.13.3</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#39;package:http&#x2F;http.dart&#39; as http;</span><br></pre></td></tr></table></figure><p>無事動いたようです。</p><img src="/images/20210512a/スクリーンショット_2021-05-11_22.32.50.png" alt="ケンオールAPIを利用したFlutter画面" width="1200" height="1371"  loading="lazy"><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>そろそろReact/Vue/Angularに飽きてきたかも？な人の新たなおもちゃとしてFlutter Webの紹介をしました。機能的には以下の3つを紹介しました</p><ul><li>Router周り</li><li>ビルドした成果物がどうなっていて他の言語(Go)のサーバーにどう組み込めばいいのか</li><li>サーバーへのHTTPアクセス</li></ul><p>モバイルアプリ開発案件じゃなくてもFlutterができてしまうので、スカンクワークスにぴったりですね。用途が広くていつの間にかシェアを広げていた黎明期のGoと同じように、上司に内緒でこっそり導入に最適です。</p><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の3記事目でした。次回は鶴巻さんの<a href="/articles/20210513b/">Flutterレイアウト入門</a>です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/articles/20210510a/&quot;&gt;Dart/Flutter連載&lt;/a&gt;の3本目はFlutter Webを紹介します。&lt;/p&gt;
&lt;p&gt;Flutter 2になって、Web向けに出力する機能もStableになりました。&lt;/p&gt;
&lt;p&gt;Flutter f</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="SPA" scheme="https://future-architect.github.io/tags/SPA/"/>
    
    <category term="Flutter" scheme="https://future-architect.github.io/tags/Flutter/"/>
    
    <category term="Flutter連載" scheme="https://future-architect.github.io/tags/Flutter%E9%80%A3%E8%BC%89/"/>
    
    <category term="ケンオール" scheme="https://future-architect.github.io/tags/%E3%82%B1%E3%83%B3%E3%82%AA%E3%83%BC%E3%83%AB/"/>
    
  </entry>
  
  <entry>
    <title>Flutter Swagger統合</title>
    <link href="https://future-architect.github.io/articles/20210511b/"/>
    <id>https://future-architect.github.io/articles/20210511b/</id>
    <published>2021-05-10T15:00:01.000Z</published>
    <updated>2021-05-12T08:41:10.384Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の2記事目です。</p><p>はじめまして、TIGの宮崎将太です。</p><p>突然ですがみなさん、Swagger使いたいですよね。当社でもGo言語などでSwaggerを用いてREST APIサーバ/クライアントコードを生成する機会が増えています。</p><p>たまたま Flutter+Rails でアプリケーション構築をする機会があったので、今回Flutterのみに着目してSwagger(OpenAPISpec)を使用する方法をコード付きで解説していきます。(Railsは需要があったら書こうと思いますので、SNSでリアクションもらえるとです！)</p><h1 id="Swaggerとは？"><a href="#Swaggerとは？" class="headerlink" title="Swaggerとは？"></a>Swaggerとは？</h1><p>Swagger(OpenAPISpec)とはREST API仕様をyamlやjsonベースで定義できるフォーマットを定めたツールで、定義書を書くとAPI仕様書やサーバ、クライアントコードを生成できちゃう優れものです。</p><p>2系、3系いろいろありますが、今回はエコシステムが充実している2系を使用していきます。</p><p>Swaggerの詳しい説明は、敬愛する武田さんが以前記載してくださっているので、そちらをチェックしてください。m(__)m</p><p><a href="https://future-architect.github.io/articles/20191008/">https://future-architect.github.io/articles/20191008/</a></p><h1 id="0からクライアントコード実装までやってみる"><a href="#0からクライアントコード実装までやってみる" class="headerlink" title="0からクライアントコード実装までやってみる"></a>0からクライアントコード実装までやってみる</h1><p>百聞は一見に如かず。</p><p>0の状態からクライアントコード実装までやってみます。</p><p>なお、flutter/dartはインストール済みの前提として進めます。まだの方は<a href="https://flutter.dev/docs/get-started/install">公式</a>にインストール方法がありますので、準備してからやってみてください。</p><p>各バージョン情報は以下の通りです。</p><ul><li>開発機OS: Mac Catalina</li><li>Flutter: 2.0.4</li><li>Dart: 2.12.2</li><li>Swagger: 2.0</li></ul><h2 id="openapi-generatorインストール"><a href="#openapi-generatorインストール" class="headerlink" title="openapi-generatorインストール"></a>openapi-generatorインストール</h2><p>後ほどSwaggerからコードを生成するので、まずは生成ツールである<code>openapi-generator</code>をインストールします。</p><p>生成ツールはjar、dockerなどいろいろな形式で提供されていますが、今回は楽にHomebrew経由でインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install openapi-generator</span><br></pre></td></tr></table></figure><p>その他の形式については下記参考に導入してください。<br><a href="https://openapi-generator.tech/docs/installation/">https://openapi-generator.tech/docs/installation/</a></p><h2 id="Flutterプロジェクト作成"><a href="#Flutterプロジェクト作成" class="headerlink" title="Flutterプロジェクト作成"></a>Flutterプロジェクト作成</h2><p>ツール導入が完了したので、プロジェクトを作成。<br><code>flutter_swagger</code>という名称でプロジェクトを作成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter create flutter_swagger</span><br></pre></td></tr></table></figure><p>以下のようなプロジェクトが生成されるはずです。</p><p>あくまでAPIリクエスト実行までを実装するので、今回いじるのは<code>pubspec.yaml</code>と<code>lib/main.dart</code>のみです。</p><p>※Flutter基本的なディレクトリ構造に関しての説明は今回は割愛します。</p><img src="/images/20210511b/image.png" alt="ディレクトリ構成" width="580" height="758" loading="lazy"><h2 id="swagger-yaml配置"><a href="#swagger-yaml配置" class="headerlink" title="swagger.yaml配置"></a>swagger.yaml配置</h2><p>プロジェクト作成が完了したので、プロジェクトルートに<code>swagger.yaml</code>を作成します。<br>swaggerはヘルスチェックに対して200OKを返すのみの簡単なもの。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">swagger:</span> <span class="string">&quot;2.0&quot;</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">&quot;api&quot;</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">&quot;0.0.1-SNAPSHOT&quot;</span></span><br><span class="line"><span class="comment"># host: &quot;localhost:8080&quot;</span></span><br><span class="line"><span class="attr">basePath:</span> <span class="string">/api/v1</span></span><br><span class="line"><span class="attr">schemes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">http</span></span><br><span class="line"><span class="attr">consumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;application/json&quot;</span></span><br><span class="line"><span class="attr">produces:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;application/json&quot;</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">System</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;システム共通機能&quot;</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/health:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">System</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">200:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">OK</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="string">$ref:</span> <span class="string">&quot;#/definitions/health&quot;</span></span><br><span class="line"><span class="attr">definitions:</span></span><br><span class="line">  <span class="attr">health:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">enum:</span> [<span class="string">OK</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="APIクライアントコード生成"><a href="#APIクライアントコード生成" class="headerlink" title="APIクライアントコード生成"></a>APIクライアントコード生成</h2><p><code>swagger.yaml</code>の配置が終わったので<code>openapi-generator</code>でAPIクライアントコードを生成します。</p><p>dartのクライアントコードはパッケージ形式で生成されるので、<code>lib</code>配下には生成せず別ディレクトリに生成（<code>client</code>配下）し、後ほどimportします。</p><p>terminalにて以下を実行してください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openapi-generator generate -i ./swagger.yaml -g dart -o ./client</span><br></pre></td></tr></table></figure><p>各オプションは以下の通りです。</p><ul><li><code>i</code>: swagger.yamlへのパス</li><li><code>g</code>: 生成コードの形式(≒言語)を指定します。様々な形式での生成ができるので以下参考にしてください。（dartも別形式である<code>dart-dio</code>を指定可能。）<br><a href="https://openapi-generator.tech/docs/generators/">https://openapi-generator.tech/docs/generators/</a></li><li><code>o</code>: 生成コードの出力先パス</li></ul><p>クライアントコードの生成が完了すると、以下のように<code>client</code>配下に別パッケージが確認できます。</p><p>※コンパイルエラーが発生している場合は<code>client</code>配下で<code>flutter pub get</code>を実行して依存ライブラリを解決してください。</p><img src="/images/20210511b/image_2.png" alt="openapi-generatorでの生成先ディレクトリ" width="554" height="1102"  loading="lazy"><p>主たる生成コードの役割は以下の通りです。</p><ul><li><code>lib/api/xxx_api.dart</code>: swaggerの<code>tag</code>ごとに生成されます。APIレスポンスのモデルバインド等を実行するAPIクライアントラッパーが定義されます。</li><li><code>lib/auth/xxx.dart</code>: 認証系の生成コードです。APIキー認証、basic認証、Bearer認証、OAuth認証が可能。今回は使用しません。</li><li><code>lib/model/xxx.dart</code>: swaggerの<code>definition</code>ディレクティブで定義するAPIリクエスト/レスポンスがモデルクラスとして生成されます。</li><li><code>lib/api_client.dart</code>: APIクライアントが定義されます。</li></ul><h2 id="openapiパッケージの導入"><a href="#openapiパッケージの導入" class="headerlink" title="openapiパッケージの導入"></a>openapiパッケージの導入</h2><p>生成されたコードは<code>openapi</code>という名称のパッケージになっているので、プロジェクトルートの<code>pubspec.yaml</code>にて依存定義を記載します。</p><p>以下、最後2行を<code>pubspec.yaml</code>に記載後、プロジェクトルートにて<code>flutter pub get</code>を実行してください。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">flutter:</span></span><br><span class="line">    <span class="attr">sdk:</span> <span class="string">flutter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The following adds the Cupertino Icons font to your application.</span></span><br><span class="line">  <span class="comment"># Use with the CupertinoIcons class for iOS style icons.</span></span><br><span class="line">  <span class="attr">cupertino_icons:</span> <span class="string">^1.0.2</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 以下2行追記</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">./client/</span></span><br></pre></td></tr></table></figure><h2 id="APIリクエスト実行"><a href="#APIリクエスト実行" class="headerlink" title="APIリクエスト実行"></a>APIリクエスト実行</h2><p>ここまででようやくAPIリクエストを実行する準備が整いました。</p><p>あとは通常通り<code>openapi</code>パッケージをimportし、<code>main.dart</code>など任意の箇所にコーディングするだけです。</p><p>以下、参考コードになります。</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:openapi/api.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:http/http.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ① ベースとなるAPIクライアント生成</span></span><br><span class="line"><span class="keyword">var</span> client = ApiClient(basePath: <span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line"><span class="comment">// ヘッダを追加したい場合はクライアントに設定可能</span></span><br><span class="line">client.addDefaultHeader(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ② APIクライアントラッパーを生成</span></span><br><span class="line"><span class="comment">// APIレスポンスをモデルに変換してくれる</span></span><br><span class="line"><span class="keyword">var</span> api = SystemApi(client);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ③ レスポンスボディのみが欲しい場合は$&#123;パス名+HTTPメッソド名&#125;のメソッドをcall</span></span><br><span class="line">Health health = <span class="keyword">await</span> api.healthGet();</span><br><span class="line"><span class="built_in">print</span>(health.value); <span class="comment">// =&gt; OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ④ HTTPステータスや、その他ヘッダ情報が欲しい場合は$&#123;パス名+HTTPメッソド名&#125;WithHttpInfoのメソッドをcall</span></span><br><span class="line">Response res = <span class="keyword">await</span> api.healthGetWithHttpInfo();</span><br><span class="line"><span class="built_in">print</span>(res.statusCode); <span class="comment">// =&gt; 200</span></span><br><span class="line"><span class="built_in">print</span>(res.headers); <span class="comment">// =&gt; HTTPヘッダーMap</span></span><br><span class="line"><span class="built_in">print</span>(res.body); <span class="comment">// =&gt; OK</span></span><br></pre></td></tr></table></figure><ol><li>ベースとなるAPIクライアント生成<br><code>ApiClient</code>をインスタンス化しています。アクセスの設定や共通ヘッダを実装したい場合は此処に実装することになります。<br><code>ApiClient</code>の定義は<code>client/lib/api_client.dart</code>に生成されます。</li><li>APIクライアントラッパーを生成<br>swaggerの<code>tag</code>ごとに生成されるクラスです。APIレスポンスのモデルへバインド等を実行します。swaggerの<code>path</code>一つにつき後述の3と4の2メソッドが生成されます。クラス定義は<code>client/lib/api/xxx_api.dart</code>に生成されます。</li><li>リクエスト発行（レスポンスボディのみが欲しい場合）<br>単純にレスポンスボディのみが欲しい場合は<code>$&#123;パス名+HTTPメッソド名&#125;</code>のメソッドをcallします。（この場合は<code>healthGet</code>）。HTTPステータスが400以上の場合やレスポンスボディがnullの場合は例外(<code>ApiException</code>)をthrowしてくれます。</li><li>リクエスト発行（ヘッダも含めて欲しい場合）<br>③のメソッドではHTTPヘッダ情報が取得できなかったり、HTTPステータスが400以上の場合には例外をthrowしてしまうので、この挙動が嫌な場合は<code>$&#123;パス名+HTTPメッソド名&#125;WithHttpInfo</code>をcallします。（例の場合は<code>healthGetWithHttpInfo</code>）<br>ただし、返り値は<code>http/http.dart</code>パッケージの<code>Response</code>インスタンスとなるので、レスポンスボディのモデルバインドは自前で実装する必要がある点に注意してください。生成コード的には③の中で④をcallするような構造になっています。</li></ol><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>お手軽にSwaggerからAPIクライアントコードの生成&amp;実装ができました。</p><p>今回はスキップしましたが、認証機構も生成されていたり、APIクライアントのカスタマイズも可能なので自動生成コードの中身は是非見てみてください。</p><p>Flutterに関しては他にもいろいろ知見を深めることができたので、別の機会があれば記事にできればと。m(__)m</p><h1 id="おまけ"><a href="#おまけ" class="headerlink" title="おまけ"></a>おまけ</h1><p>需要があるかわかりませんが、サンプルとして載せたSwaggerから生成されたコードを載せておきます。<br>コード見てみたいけど手元に環境がない、なんて方の参考になればと。</p><details><summary>▽Swaggerから生成したコード（クリックで開けます）</summary><div><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client/lib/api/sytem_api.dart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">part</span> of openapi.api;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SystemApi</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ApiClient apiClient;</span><br><span class="line"></span><br><span class="line">  SystemApi([ApiClient apiClient]) : apiClient = apiClient ?? defaultApiClient;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///  <span class="markdown">with HTTP info returned</span></span></span><br><span class="line">  Future&lt;Response&gt; healthGetWithHttpInfo() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span> postBody;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verify required params are set</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create path and map variables</span></span><br><span class="line">    <span class="built_in">String</span> path = <span class="string">&quot;/health&quot;</span>.replaceAll(<span class="string">&quot;&#123;format&#125;&quot;</span>,<span class="string">&quot;json&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// query params</span></span><br><span class="line">    <span class="built_in">List</span>&lt;QueryParam&gt; queryParams = [];</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; headerParams = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; formParams = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; contentTypes = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span> nullableContentType = contentTypes.isNotEmpty ? contentTypes[<span class="number">0</span>] : <span class="keyword">null</span>;</span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; authNames = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(nullableContentType != <span class="keyword">null</span> &amp;&amp; nullableContentType.startsWith(<span class="string">&quot;multipart/form-data&quot;</span>)) &#123;</span><br><span class="line">      <span class="built_in">bool</span> hasFields = <span class="keyword">false</span>;</span><br><span class="line">      MultipartRequest mp = MultipartRequest(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">if</span>(hasFields)</span><br><span class="line">        postBody = mp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> response = <span class="keyword">await</span> apiClient.invokeAPI(path,</span><br><span class="line">                                             <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                                             queryParams,</span><br><span class="line">                                             postBody,</span><br><span class="line">                                             headerParams,</span><br><span class="line">                                             formParams,</span><br><span class="line">                                             nullableContentType,</span><br><span class="line">                                             authNames);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;Health&gt; healthGet() <span class="keyword">async</span> &#123;</span><br><span class="line">    Response response = <span class="keyword">await</span> healthGetWithHttpInfo();</span><br><span class="line">    <span class="keyword">if</span>(response.statusCode &gt;= <span class="number">400</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ApiException(response.statusCode, _decodeBodyBytes(response));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(response.body != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> apiClient.deserialize(_decodeBodyBytes(response), <span class="string">&#x27;Health&#x27;</span>) <span class="keyword">as</span> Health;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client/lib/model/health.dart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">part</span> of openapi.api;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Health</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="markdown">The underlying value of this enum member.</span></span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> Health._internal(<span class="keyword">this</span>.value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> Health oK_ = <span class="keyword">const</span> Health._internal(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Health fromJson(<span class="built_in">String</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HealthTypeTransformer().decode(value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">List</span>&lt;Health&gt; listFromJson(<span class="built_in">List</span>&lt;<span class="built_in">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> json == <span class="keyword">null</span> ? <span class="keyword">new</span> <span class="built_in">List</span>&lt;Health&gt;() : json.map((value) =&gt; Health.fromJson(value)).toList();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HealthTypeTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">dynamic</span> encode(Health data) &#123;</span><br><span class="line">    <span class="keyword">return</span> data.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Health decode(<span class="built_in">dynamic</span> data) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (data) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;OK&quot;</span>: <span class="keyword">return</span> Health.oK_;</span><br><span class="line">      <span class="keyword">default</span>: <span class="keyword">throw</span>(<span class="string">&#x27;Unknown enum value to decode: <span class="subst">$data</span>&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client/lib/api_client.dart</span></span><br><span class="line"><span class="keyword">part</span> of openapi.api;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryParam</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> name;</span><br><span class="line">  <span class="built_in">String</span> value;</span><br><span class="line"></span><br><span class="line">  QueryParam(<span class="keyword">this</span>.name, <span class="keyword">this</span>.value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> basePath;</span><br><span class="line">  <span class="keyword">var</span> client = Client();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; _defaultHeaderMap = &#123;&#125;;</span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Authentication&gt; _authentications = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> _regList = <span class="built_in">RegExp</span>(<span class="string">r&#x27;^List&lt;(.*)&gt;$&#x27;</span>);</span><br><span class="line">  <span class="keyword">final</span> _regMap = <span class="built_in">RegExp</span>(<span class="string">r&#x27;^Map&lt;String,(.*)&gt;$&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  ApiClient(&#123;<span class="keyword">this</span>.basePath = <span class="string">&quot;http://localhost/api/v1&quot;</span>&#125;) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> addDefaultHeader(<span class="built_in">String</span> key, <span class="built_in">String</span> value) &#123;</span><br><span class="line">     _defaultHeaderMap[key] = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">dynamic</span> _deserialize(<span class="built_in">dynamic</span> value, <span class="built_in">String</span> targetType) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (targetType) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;String&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;<span class="subst">$value</span>&#x27;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;int&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> value <span class="keyword">is</span> <span class="built_in">int</span> ? value : <span class="built_in">int</span>.parse(<span class="string">&#x27;<span class="subst">$value</span>&#x27;</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;bool&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> value <span class="keyword">is</span> <span class="built_in">bool</span> ? value : <span class="string">&#x27;<span class="subst">$value</span>&#x27;</span>.toLowerCase() == <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;double&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> value <span class="keyword">is</span> <span class="built_in">double</span> ? value : <span class="built_in">double</span>.parse(<span class="string">&#x27;<span class="subst">$value</span>&#x27;</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;Health&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> HealthTypeTransformer().decode(value);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">Match</span> match;</span><br><span class="line">            <span class="keyword">if</span> (value <span class="keyword">is</span> <span class="built_in">List</span> &amp;&amp;</span><br><span class="line">                (match = _regList.firstMatch(targetType)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">var</span> newTargetType = match[<span class="number">1</span>];</span><br><span class="line">              <span class="keyword">return</span> value.map((v) =&gt; _deserialize(v, newTargetType)).toList();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">is</span> <span class="built_in">Map</span> &amp;&amp;</span><br><span class="line">                (match = _regMap.firstMatch(targetType)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">var</span> newTargetType = match[<span class="number">1</span>];</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">Map</span>.fromIterables(value.keys,</span><br><span class="line">                  value.values.map((v) =&gt; _deserialize(v, newTargetType)));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">on</span> Exception <span class="keyword">catch</span> (e, stack) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ApiException.withInner(<span class="number">500</span>, <span class="string">&#x27;Exception during deserialization.&#x27;</span>, e, stack);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> ApiException(<span class="number">500</span>, <span class="string">&#x27;Could not find a suitable class for deserialization&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">dynamic</span> deserialize(<span class="built_in">String</span> json, <span class="built_in">String</span> targetType) &#123;</span><br><span class="line">    <span class="comment">// Remove all spaces.  Necessary for reg expressions as well.</span></span><br><span class="line">    targetType = targetType.replaceAll(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetType == <span class="string">&#x27;String&#x27;</span>) <span class="keyword">return</span> json;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> decodedJson = jsonDecode(json);</span><br><span class="line">    <span class="keyword">return</span> _deserialize(decodedJson, targetType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> serialize(<span class="built_in">Object</span> obj) &#123;</span><br><span class="line">    <span class="built_in">String</span> serialized = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">      serialized = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      serialized = json.encode(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serialized;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We don&#x27;t use a Map&lt;String, String&gt; for queryParams.</span></span><br><span class="line">  <span class="comment">// If collectionFormat is &#x27;multi&#x27; a key might appear multiple times.</span></span><br><span class="line">  Future&lt;Response&gt; invokeAPI(<span class="built_in">String</span> path,</span><br><span class="line">                             <span class="built_in">String</span> method,</span><br><span class="line">                             <span class="built_in">Iterable</span>&lt;QueryParam&gt; queryParams,</span><br><span class="line">                             <span class="built_in">Object</span> body,</span><br><span class="line">                             <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; headerParams,</span><br><span class="line">                             <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; formParams,</span><br><span class="line">                             <span class="built_in">String</span> nullableContentType,</span><br><span class="line">                             <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; authNames) <span class="keyword">async</span> &#123;</span><br><span class="line"></span><br><span class="line">    _updateParamsForAuth(authNames, queryParams, headerParams);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ps = queryParams</span><br><span class="line">      .where((p) =&gt; p.value != <span class="keyword">null</span>)</span><br><span class="line">      .map((p) =&gt; <span class="string">&#x27;<span class="subst">$&#123;p.name&#125;</span>=<span class="subst">$&#123;Uri.encodeQueryComponent(p.value)&#125;</span>&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span> queryString = ps.isNotEmpty ?</span><br><span class="line">                         <span class="string">&#x27;?&#x27;</span> + ps.join(<span class="string">&#x27;&amp;&#x27;</span>) :</span><br><span class="line">                         <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span> url = basePath + path + queryString;</span><br><span class="line"></span><br><span class="line">    headerParams.addAll(_defaultHeaderMap);</span><br><span class="line">    <span class="keyword">if</span> (nullableContentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> contentType = nullableContentType;</span><br><span class="line">      headerParams[<span class="string">&#x27;Content-Type&#x27;</span>] = contentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(body <span class="keyword">is</span> MultipartRequest) &#123;</span><br><span class="line">      <span class="keyword">var</span> request = MultipartRequest(method, <span class="built_in">Uri</span>.parse(url));</span><br><span class="line">      request.fields.addAll(body.fields);</span><br><span class="line">      request.files.addAll(body.files);</span><br><span class="line">      request.headers.addAll(body.headers);</span><br><span class="line">      request.headers.addAll(headerParams);</span><br><span class="line">      <span class="keyword">var</span> response = <span class="keyword">await</span> client.send(request);</span><br><span class="line">      <span class="keyword">return</span> Response.fromStream(response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> msgBody = nullableContentType == <span class="string">&quot;application/x-www-form-urlencoded&quot;</span> ? formParams : serialize(body);</span><br><span class="line">      <span class="keyword">final</span> nullableHeaderParams = (headerParams.isEmpty)? <span class="keyword">null</span>: headerParams;</span><br><span class="line">      <span class="keyword">switch</span>(method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">          <span class="keyword">return</span> client.post(url, headers: nullableHeaderParams, body: msgBody);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;PUT&quot;</span>:</span><br><span class="line">          <span class="keyword">return</span> client.put(url, headers: nullableHeaderParams, body: msgBody);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;DELETE&quot;</span>:</span><br><span class="line">          <span class="keyword">return</span> client.delete(url, headers: nullableHeaderParams);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;PATCH&quot;</span>:</span><br><span class="line">          <span class="keyword">return</span> client.patch(url, headers: nullableHeaderParams, body: msgBody);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;HEAD&quot;</span>:</span><br><span class="line">          <span class="keyword">return</span> client.head(url, headers: nullableHeaderParams);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">return</span> client.<span class="keyword">get</span>(url, headers: nullableHeaderParams);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">Update query and header parameters based on authentication settings.</span></span></span><br><span class="line">  <span class="comment">/// <span class="markdown">@param authNames The authentications to apply</span></span></span><br><span class="line">  <span class="keyword">void</span> _updateParamsForAuth(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; authNames, <span class="built_in">List</span>&lt;QueryParam&gt; queryParams, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; headerParams) &#123;</span><br><span class="line">    authNames.forEach((authName) &#123;</span><br><span class="line">      Authentication auth = _authentications[authName];</span><br><span class="line">      <span class="keyword">if</span> (auth == <span class="keyword">null</span>) <span class="keyword">throw</span> ArgumentError(<span class="string">&quot;Authentication undefined: &quot;</span> + authName);</span><br><span class="line">      auth.applyToParams(queryParams, headerParams);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  T getAuthentication&lt;T <span class="keyword">extends</span> Authentication&gt;(<span class="built_in">String</span> name) &#123;</span><br><span class="line">    <span class="keyword">var</span> authentication = _authentications[name];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authentication <span class="keyword">is</span> T ? authentication : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の2記事目でした。次回は澁川さんの <a href="/articles/20210512a/">Goのサーバーの管理画面をFlutter Webで作ってみるための調査</a> です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;/articles/20210510a/&quot;&gt;Dart/Flutter連載&lt;/a&gt;の2記事目です。&lt;/p&gt;
</summary>
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Swagger" scheme="https://future-architect.github.io/tags/Swagger/"/>
    
    <category term="OpenAPI" scheme="https://future-architect.github.io/tags/OpenAPI/"/>
    
    <category term="Flutter" scheme="https://future-architect.github.io/tags/Flutter/"/>
    
    <category term="Dart" scheme="https://future-architect.github.io/tags/Dart/"/>
    
    <category term="Flutter連載" scheme="https://future-architect.github.io/tags/Flutter%E9%80%A3%E8%BC%89/"/>
    
  </entry>
  
  <entry>
    <title>技育祭登壇しました。これから機械学習を学びたい方向けへの自分の経験談とおすすめの本、サイトの紹介もします</title>
    <link href="https://future-architect.github.io/articles/20210511a/"/>
    <id>https://future-architect.github.io/articles/20210511a/</id>
    <published>2021-05-10T15:00:00.000Z</published>
    <updated>2021-05-12T00:44:58.657Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20210511a/geeksai_logo.png" alt="geeksai_logo" width="640" height="602"><p>TIGの玉木です。去年の12月までは主に機械学習エンジニアとして機械学習案件を任されていましたが、今年の1月からはITコンサルタントとして業務の幅が広くなりいろいろやっています。</p><p>先月技育祭<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>と呼ばれるイベントの勉強会という枠で、同僚の上野さんと一緒に「初心者必見！機械学習エンジニアがあれこれ話します。〜基礎から実社会応用まで〜」というタイトルで発表しました。この記事では技育祭の簡単な紹介と、当日あったこれから機械学習学びたい方向けへの本、サイトの紹介をします。</p><h2 id="技育祭とは"><a href="#技育祭とは" class="headerlink" title="技育祭とは"></a>技育祭とは</h2><p>公式サイト<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>から引用させていただくと、</p><blockquote><p>技育祭は「技術者を育てる」ことを目的としたエンジニアを目指す学生のための日本最大のテックカンファレンスです</p></blockquote><p>とのことです。元2ちゃんねる管理人のひろゆきさんや、東京大学の松尾豊先生など、豪華なゲストの方々が参加され、学生向けにためになる話をしてくれるイベントでした。講演セッションが3つ、勉強会セッションが2つ同時に進み、我々が話した勉強会セッションの裏ではRuby開発者のまつもとゆきひろさん、AtCoder社長のchokudaiさん、株式会社ドワンゴの川上量生さんが話されていました。こんな豪華なメンツが講演している中勉強会きてくれる人いるのかと不安だったのですが、当日は50人超の学生の方々が参加してくれました。</p><h2 id="当日の内容"><a href="#当日の内容" class="headerlink" title="当日の内容"></a>当日の内容</h2><img src="/images/20210511a/スクリーンショット_2021-04-27_15.54.35.png" alt="当日の発表スライド_ワクチン開発における教師あり学習" width="1200" height="863" loading="lazy"><p>「初心者必見！機械学習エンジニアがあれこれ話します。〜基礎から実社会応用まで〜」と、かなり抽象的なタイトルで話しました。私は教師あり学習について少し説明したあと、以前ブログに書いたワクチンの話<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>を簡単に紹介し、word2vecなどの事前学習モデルについて説明したあと、それを使った案件への応用を紹介しました。上記の図は当日話したスライドの1部で、自然言語処理のタスクの1つである感情分析の説明をしたあと、ワクチン候補を見つけるのも感情分析と同じ枠組みで解けることを説明している図になります。上野さんは主に画像処理での案件への応用を紹介していました。</p><p>当日はチャットが大いに盛り上がりました(書き込んでくれた皆様ありがとうございました！)。よくあった質問が「どうやって機械学習勉強しましたか？」「おすすめの参考になる本などありますか？」という質問でした。その場で口頭で答えたものの、初心者向けの本、サイトを紹介するというのは一定の需要がありそうなので、この記事では</p><ul><li>私がどうやって機械学習を学んだか</li><li>今ならどうやって機械学習を学ぶか</li></ul><p>を紹介しようと思います。これから機械学習関係の研究室に入ってガッツリ学ぶ方向けというよりは、当日勉強会に参加していた、機械学習ちょっと学んでみたいぐらいのレベル感の方に向けてこの記事を書きます。</p><h2 id="私がどうやって機械学習を学んだか"><a href="#私がどうやって機械学習を学んだか" class="headerlink" title="私がどうやって機械学習を学んだか"></a>私がどうやって機械学習を学んだか</h2><p>私は大学院から自然言語処理の研究室に入り、現職では自然言語処理の案件や、ワクチンの案件に配属されて、機械学習のデータを作ったり、機械学習モデルを作ったりしていました。Kaggleと呼ばれる機械学習のコンペティションサイトではKaggle Expertぐらいの実力です(凄くないです)。<br>私が入った大学院の研究室はできたばかりの研究室だったこともあり、多くの部分を独学で学びました。最初に参考にしたサイトは、東京都立大学の小町先生が書かれた「自然言語処理を独習したい人のために」、「自然言語処理を学ぶ推薦書籍」というサイトです。当時非常に参考になりました。</p><ul><li><a href="http://cl.sd.tmu.ac.jp/prospective/prerequisite">自然言語処理を独習したい人のために</a></li><li><a href="http://cl.sd.tmu.ac.jp/prospective/readings">自然言語処理を学ぶ推薦書籍</a></li></ul><p>上記のサイトは私が学生のときにはすでにあり、現在も更新されています。実際に当時私が読んで役に経ったなと思っている本は</p><ul><li><a href="https://www.coronasha.co.jp/np/isbn/9784339027518/">言語処理のための機械学習入門</a></li><li><a href="https://book.impress.co.jp/books/1120101017">Python 機械学習プログラミング</a></li></ul><p>の2つです。「言語処理のための機械学習入門」は今はあまり使われないようなモデルも紹介されていますが、大学院で研究をする上での基礎になりました。「Python 機械学習プログラミング」はコードを書いて結果が出るので、その分楽しく読めた記憶があります。本ではありませんが、</p><ul><li>courseraのAndrew Ng先生の「<a href="https://ja.coursera.org/learn/machine-learning">Machine Learning</a>」</li><li>PFN海野さん、東工大岡崎先生といった方々が公開されている論文紹介の資料</li><li>論文</li></ul><p>を見たり読んだりして知識をつけました。courseraのAndrew Ng先生の「Machine Learning」は英語に抵抗がなければおすすめします。最近は<a href="https://ja.coursera.org/specializations/deep-learning">Deep Learning用の別の講座</a>もできていて、そちらを見るのがいいのかなと思います。かなり時間がかかるのがネックですが、内容はとても良いです。Andrew Ng先生のYouTubeに上がっている授業の方は結構難しいのですが、courseraの授業は易しめだと思います。</p><p>実験面や機械学習のコードに関して最も参考になったのが、<a href="https://www.kaggle.com/">Kaggle</a>と呼ばれる機械学習のコンペティションサイトです。当時<a href="https://www.kaggle.com/c/quora-question-pairs">Quora Question Pairs</a>というコンペが開催されており、データや内容に興味があったため参加しました。その後もぼちぼち興味のあるコンペティションに参加し、知見を得ています。またその他に、kerasやchainerのサンプルコードや、論文の実装を参考にして当時は機械学習のコードの書き方を学んでいきました。</p><h2 id="今ならどうやって機械学習を学ぶか"><a href="#今ならどうやって機械学習を学ぶか" class="headerlink" title="今ならどうやって機械学習を学ぶか"></a>今ならどうやって機械学習を学ぶか</h2><p>今もし1から自分が機械学習を学び直すとしたら、Kaggleでたくさん実験するところから始めると思います。本をただ読むよりも、コードを実際に動かして、実行結果がわかることが自分の好みというのがあります。そのような方に特にKaggleがおすすめできます。Kaggleはある程度データや環境がすでに用意されており、いきなりコードを書き始めることができます。公開されているデータの種類も多岐にわたります。余談ですが、弊社もコンペティションではないですが、データの公開を行っています<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>。Kaggle上でGPUやTPUも制限付きで使うことができます。参考になるコードや議論も公開されています。Kaggle上に公開されている内容が全くわからないと最初はなると思います。その中でおすすめなのが以下の2つです。</p><ul><li><a href="https://developers.google.com/machine-learning/crash-course">Machine Learning Crash Course</a></li><li><a href="https://www.kspub.co.jp/book/detail/5190067.html">実践Data Scienceシリーズ PythonではじめるKaggleスタートブック</a></li></ul><p>Machine Learning Crash Courseは前述のcourseraの授業に比べて量もそんなに多くなく、最初に学ぶ内容として必要なことが一通り揃っているように思います。<br>PythonではじめるKaggleスタートブックが出たときすでに自分はKaggleに出たことがあったのでこの本は読んだことがないのに紹介してしまい申し訳ないのですが、本の紹介、レビューを見る限り良さそうだなと思います。当社ブログでも紹介しています<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>。</p><p>上記2冊に比べて内容は難しくなりますが、</p><ul><li><a href="https://gihyo.jp/book/2019/978-4-297-10843-4">Kaggleで勝つデータ分析の技術</a></li></ul><p>もおすすめします。機械学習モデルの精度をあげる工夫ももちろん載っているのですが、正しくモデルを評価する、データを変換するといった基礎的なことも学べます。実務で機械学習をやっていても、この点難しいと感じることが多いのですが、Kaggleで勝つデータ分析の技術は一通りまとまっていて今でも参考にしてます。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>技育祭でよくあった質問の「どうやって機械学習勉強しましたか？」「おすすめの参考になる本などありますか？」に対する答えとなる記事を書きました。現在もKaggle上でいくつかコンペティションが開催されているので、機械学習に興味のある方は参加してみてはいかがでしょうか。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;"><a href="https://talent.supporterz.jp/geeksai/2021/">https://talent.supporterz.jp/geeksai/2021/</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;"><a href="/articles/20201208/">https://future-architect.github.io/articles/20201208/</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;"><a href="/articles/20200801/">https://future-architect.github.io/articles/20200801/</a></span><a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">4.</span><span style="display: inline-block; vertical-align: top;"><a href="/articles/20200615/">https://future-architect.github.io/articles/20200615/</a></span><a href="#fnref:4" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;/images/20210511a/geeksai_logo.png&quot; alt=&quot;geeksai_logo&quot; width=&quot;640&quot; height=&quot;602&quot;&gt;

&lt;p&gt;TIGの玉木です。去年の12月までは主に機械学習エンジニアとして機械学習案件を任されていま</summary>
      
    
    
    
    <category term="DataScience" scheme="https://future-architect.github.io/categories/DataScience/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="書籍" scheme="https://future-architect.github.io/tags/%E6%9B%B8%E7%B1%8D/"/>
    
    <category term="機械学習" scheme="https://future-architect.github.io/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/"/>
    
    <category term="技育祭" scheme="https://future-architect.github.io/tags/%E6%8A%80%E8%82%B2%E7%A5%AD/"/>
    
  </entry>
  
  <entry>
    <title>Dart入門</title>
    <link href="https://future-architect.github.io/articles/20210510b/"/>
    <id>https://future-architect.github.io/articles/20210510b/</id>
    <published>2021-05-09T15:00:01.000Z</published>
    <updated>2021-05-12T08:40:09.534Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は<a href="/articles/20210510a/">Dart/Flutter連載</a>の1記事目です。</p><p>TIGの伊藤真彦です。</p><p>Dart/Flutter入門に参加します、DartといえばFlutterの話が必ずついてくるものですが、今回は連載1記事目として、敢えてプログラミング言語としてのDartに焦点を絞った記事にします。</p><h1 id="Dartとは"><a href="#Dartとは" class="headerlink" title="Dartとは"></a>Dartとは</h1><img src="/images/20210510b/logo_lockup_dart_horizontal.png" alt="dart horizontal logo" width="560" height="202"><p>DartはGoogleによって開発されたウェブ向けのプログラミング言語です、正式発表された時期は2011年です。</p><p>元々はJavaScriptの代替となることを目的に作られましたが、Javascriptのようにブラウザに統合される事なく今日まで至ります。JavaScriptの代替、という概念では競合にあたるTypeScriptが今ではGoogle社内の標準プログラミング言語として承認されています。</p><p>しかし、2018年にDart2として再起動、モバイルアプリケーション向けフレームワークである<code>Flutter</code>の基本ライブラリでDartが採用される事により、近年注目度が上昇しています。今iOS/Androidのクロスプラットフォームでのアプリケーション開発を行うならDartが熱い、という事ですね。</p><h1 id="技術的特徴"><a href="#技術的特徴" class="headerlink" title="技術的特徴"></a>技術的特徴</h1><p>Dartはクラスベースのオブジェクト指向言語です、単一継承のみがサポートされていますが、Mixinを利用することも可能です。</p><p>静的型付け言語としての型アノテーションが存在しつつも、dynamic型と呼ばれる特徴的な型により、動的型付け言語のようにも扱うことが可能です。上記の特徴により、大規模システムでも耐えられる堅牢さ、高パフォーマンスを維持しつつ、時には柔軟性を持つこともできる言語として設計されています。</p><p>JavaScriptトランスパイラにより、作成したコードをJavascriptに変換することが可能です。デバッグビルドでのみ動作する<code>assert</code>という構文があるのも特徴です。</p><h1 id="Dartのインストール"><a href="#Dartのインストール" class="headerlink" title="Dartのインストール"></a>Dartのインストール</h1><p><a href="https://dart.dev/get-dart">公式サイト</a>にOSごとのインストールの方法がまとめられています、MACでのインストールが一番簡単です。</p><p>インストールに成功したら<code>dart --version</code>コマンドでバージョンを確認できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart --version</span><br><span class="line">Dart SDK version: 2.12.4 (stable) (Thu Apr 15 12:26:53 2021 +0200) on <span class="string">&quot;macos_x64&quot;</span></span><br></pre></td></tr></table></figure><h1 id="Dartの実行"><a href="#Dartの実行" class="headerlink" title="Dartの実行"></a>Dartの実行</h1><p><code>dart ファイル名</code>で作成したDARTファイルを実行できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure><p>拡張子は<code>.dart</code>が一般的なようですが、dartコマンドに渡す分には他の拡張子でも読み込み、実行できました。</p><h1 id="Dartの基礎文法"><a href="#Dartの基礎文法" class="headerlink" title="Dartの基礎文法"></a>Dartの基礎文法</h1><p>基本的な文法を紹介する形でDartに触れてみます。</p><h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dartはmain関数に実行したい処理を書く形式で単一ファイルでとして実行可能です。</p><h2 id="コマンドライン引数"><a href="#コマンドライン引数" class="headerlink" title="コマンドライン引数"></a>コマンドライン引数</h2><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ % dart hello.dart Dart</span><br><span class="line">Hello Dart!</span><br></pre></td></tr></table></figure><p>main関数に引数を持たせることでコマンドライン引数を受け取ることができます。</p><p>Goの<code>flag.Parse()</code>、Rubyの<code>ARGV</code>のようなコマンドライン引数を取り扱うための独自な手法が無い。引数の書き方が<code>型名 変数名</code>の順番である、などgoに慣れた状態で触れると異文化を感じます。文字列への変数展開はJavaScriptであれば``で囲った文字列である必要があるところを’’でも問題ないあたりも細かい作法が異なりますね。</p><h2 id="変数宣言"><a href="#変数宣言" class="headerlink" title="変数宣言"></a>変数宣言</h2><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">var</span> name = args[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;name&#125;</span>!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新しい変数は<code>var 変数名 = 値</code>の形式で宣言します。</p><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="built_in">String</span> name = args[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;name&#125;</span>!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>変数の型を明示的に指定することも可能です。</p><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">dynamic</span> obj = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span> + obj);</span><br><span class="line">    obj = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span> + obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ dart main.dart</span><br><span class="line">2</span><br><span class="line">11</span><br></pre></td></tr></table></figure><p>特定の形を期待しない場合は<code>dynamic</code>を型アノテーションとして付けることができます。<br>どのような型でも再代入可能になる一方で、<code>dynamic obj = 1;</code>をそのまま<code>&quot;1&quot; + obj</code>でString型の文字列と結合することはできません。</p><p><a href="https://dart.dev/guides/language/effective-dart/style">スタイルガイド</a>によると、ローカル変数には型アノテーション無しの<code>var</code>を、公開APIの引数等で型アノテーションを書くようにするような用法が推奨されています。</p><h3 id="デフォルト値"><a href="#デフォルト値" class="headerlink" title="デフォルト値"></a>デフォルト値</h3><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">String</span> s;</span><br><span class="line">    s = <span class="string">&#x27;Hello Dart!&#x27;</span>;</span><br><span class="line">    <span class="built_in">print</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ % dart main.dart</span><br><span class="line">Hello Dart!</span><br></pre></td></tr></table></figure><p>値を決めずに変数を宣言することが可能です。</p><figure class="highlight dart"><figcaption><span>main.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="built_in">String</span> s;</span><br><span class="line">    <span class="built_in">print</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dart main.dart</span><br><span class="line">main.dart:3:11: Error: Non-nullable variable <span class="string">&#x27;s&#x27;</span> must be assigned before it can be used.</span><br><span class="line">    <span class="built_in">print</span>(s);</span><br></pre></td></tr></table></figure><p>変数のデフォルト値はどのような型であってもnullです、nullを許容しない型の変数を代入しないまま参照するとコンパイルエラーが発生します。</p><h2 id="定数"><a href="#定数" class="headerlink" title="定数"></a>定数</h2><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">String</span> s = <span class="string">&quot;Hello Dart!&quot;</span>;</span><br><span class="line">    <span class="built_in">print</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>const</code>を先頭に付与することで定数として宣言することも可能です。<br>定数の値を変更しようとするとコンパイルエラー<code>Can&#39;t assign to the const variable</code>が発生します。</p><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> s = <span class="string">&quot;Hello Dart!&quot;</span>;</span><br><span class="line">    <span class="built_in">print</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dartには<code>final</code>という修飾子も存在します。<br>finalを使って宣言した変数を変更しようとするとコンパイルエラー<code>Can&#39;t assign to the final variable</code>が発生します。</p><p>使い方が似ていますが、<code>const</code>はコンパイル時に評価され、<code>final</code>は実行段階で評価されるという違いがあります。</p><p>例えばコンパイル段階で計算できない実行時の時刻を<code>const</code>で宣言することはできません。</p><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="keyword">final</span> now = <span class="built_in">DateTime</span>.now();</span><br><span class="line">    <span class="built_in">print</span>(now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>このコードは正常に動作します。</p><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">    <span class="keyword">const</span> now = <span class="built_in">DateTime</span>.now();</span><br><span class="line">    <span class="built_in">print</span>(now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>constに置き換えると下記のエラーが発生します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Error compiling to JavaScript:</span><br><span class="line">Warning: Interpreting this as package URI, <span class="string">&#x27;package:dartpad_sample/main.dart&#x27;</span>.</span><br><span class="line">lib/main.dart:2:26:</span><br><span class="line">Error: Cannot invoke a non-<span class="string">&#x27;const&#x27;</span> constructor <span class="built_in">where</span> a const expression is expected.</span><br><span class="line">    const now = DateTime.now();</span><br><span class="line">                         ^^^</span><br><span class="line">Error: Compilation failed.</span><br></pre></td></tr></table></figure><p>このような多様な修飾子の存在はコンパイル速度のパフォーマンスチューニングに貢献しますが、若干難易度が高い印象ですね。</p><p>Dart 2.12から<code>late</code>修飾子も追加されています。</p><figure class="highlight dart"><figcaption><span>late.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">late</span> <span class="built_in">String</span> description;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  description = <span class="string">&#x27;Feijoada!&#x27;</span>;</span><br><span class="line">  <span class="built_in">print</span>(description);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>late</code>修飾子には主に2つのメリットがあります。</p><ul><li>変数がnullを許容しない</li><li>変数を遅延評価することでパフォーマンスを改善する</li></ul><p>条件分岐によっては利用しない値を<code>late</code>修飾子付きで宣言するような使い方が期待できます。</p><h2 id="組み込み型"><a href="#組み込み型" class="headerlink" title="組み込み型"></a>組み込み型</h2><p>Dartには下記の組み込み型が用意されています。</p><ul><li>Numbers (int, double)</li><li>Strings (String)</li><li>Booleans (bool)</li><li>Lists (List, also known as arrays)</li><li>Sets (Set)</li><li>Maps (Map)</li><li>Runes (Runes; often replaced by the characters API)</li><li>Symbols (Symbol)</li><li>The value null (Null)</li></ul><p>特徴的なものは<code>List</code>、<code>Set</code>の違いでしょうか。<br><code>List</code>はお馴染みの配列であるのに対し、<code>Set</code>は重複した値を持たないコレクション型です。</p><p><code>String</code>型の変数はシングルクオート、またはダブルクオート文字列を作成することが可能です。<br>シングルクオートとダブルクオートでは特殊文字のエスケープのルールが異なります。</p><figure class="highlight dart"><figcaption><span>string.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="string">&#x27;Single quotes.&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="string">&quot;Double quotes.&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> s3 = <span class="string">&#x27;It\&#x27;s easy to escape the string delimiter.&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> s4 = <span class="string">&quot;It&#x27;s even easier to use the other delimiter.&quot;</span>;</span><br></pre></td></tr></table></figure><p><code>トリプルクオート</code>で複数行の文字列を書くことができるのが特徴的です。</p><figure class="highlight dart"><figcaption><span>string.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">You can create</span></span><br><span class="line"><span class="string">multi-line strings like this one.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="string">&quot;&quot;&quot;This is also a</span></span><br><span class="line"><span class="string">multi-line string.&quot;&quot;&quot;</span>;</span><br></pre></td></tr></table></figure><p>Dartにおける<code>Symbol</code>はコンパイル時常数として扱われる、文字列から生成できるデータ型です。<br>コンパイル時に難読化なれないため、ライブラリのメタデータの整理などに利用されますが。<br>ユーザー目線ではほぼ使わないようです。</p><h3 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h3><figure class="highlight dart"><figcaption><span>enum.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">enum</span> Color &#123;</span><br><span class="line">   red,</span><br><span class="line">   blue,</span><br><span class="line">   green</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(Color.red);</span><br><span class="line">  <span class="built_in">print</span>(Color.green.index);</span><br><span class="line">  <span class="built_in">print</span>(Color.values);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ dart enum.dart</span><br><span class="line">Color.red</span><br><span class="line">2</span><br><span class="line">[Color.red, Color.blue, Color.green]</span><br></pre></td></tr></table></figure><p>Dartではバージョン1.8からenumがサポートされています。<br>比較的素朴な仕組みで、インデックスを1から始めたり飛ばしたり、文字列に変換するような機能はありません。</p><h2 id="条件分岐"><a href="#条件分岐" class="headerlink" title="条件分岐"></a>条件分岐</h2><h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args[<span class="number">0</span>] == <span class="string">&quot;Dart&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hello Dart!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[<span class="number">0</span>] == <span class="string">&quot;Flutter&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Welcome Flutter!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;bye&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>if文は特に違和感のないシンプルなスタイルです。<br>JavaScriptでは比較演算子に<code>===</code>がありましたが、現在のDartでは存在しません。(初期のDartには存在していたようです)</p><h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (args[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Dart&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello Dart!&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Flutter&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Welcome Flutter!&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bye&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>switch文も存在します。<br>各case毎にbreak文を設置しないと次のcaseが実行される<code>fall through</code>形式でありつつ、case内部で何かを実行したのにbreakしないとコンパイルエラーが発生するという若干癖のある仕様になっています。</p><p>つまり下記のコードはbreakが存在しないためエラーになります。</p><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (args[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Dart&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello Dart!&#x27;</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Flutter&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Welcome Flutter!&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bye&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello.dart:3:5: Error: Switch <span class="keyword">case</span> may fall through to the next <span class="keyword">case</span>.</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Dart&#x27;</span>:</span><br></pre></td></tr></table></figure><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (args[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Dart&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Flutter&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello!&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bye&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>空のケースのみ<code>fall through</code>することで複数条件のケース文を実現するような用途が想定されています。</p><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (args[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Dart&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello Dart!&#x27;</span>);</span><br><span class="line">    <span class="keyword">continue</span> bye;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Flutter&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello Flutter!&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    bye:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bye&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>何か処理を実行してから<code>fall through</code>することはラベルを利用することで実現できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart Dart</span><br><span class="line">Hello Dart!</span><br><span class="line"><span class="built_in">bye</span></span><br></pre></td></tr></table></figure><h2 id="ループ処理"><a href="#ループ処理" class="headerlink" title="ループ処理"></a>ループ処理</h2><h3 id="for"><a href="#for" class="headerlink" title="for"></a>for</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; args.length; i++)&#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;args[i]&#125;</span>!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初期化文、条件式、後処理文の古典的なfor文が利用可能です。</p><h3 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    args.forEach((<span class="built_in">String</span> arg)&#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;arg&#125;</span>!&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>forEach文でループを処理することも可能です。</p><h3 id="item-in-list"><a href="#item-in-list" class="headerlink" title="item in list"></a>item in list</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> arg <span class="keyword">in</span> args)&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;arg&#125;</span>!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dartでは上記２種類に加えPython系のテイストを感じる書き方でもループを回すことが可能です。</p><h3 id="while"><a href="#while" class="headerlink" title="while"></a>while</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= args.length)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;args[index]&#125;</span>!&#x27;</span>);</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="do-while"><a href="#do-while" class="headerlink" title="do while"></a>do while</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args) &#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;args[index]&#125;</span>!&#x27;</span>);</span><br><span class="line">        index++;</span><br><span class="line">    &#125; <span class="keyword">while</span>(index &lt; args.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>while文、do~while分も存在します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart Dart Flutter</span><br><span class="line">Hello Dart!</span><br><span class="line">Hello Flutter!</span><br></pre></td></tr></table></figure><h2 id="関数"><a href="#関数" class="headerlink" title="関数"></a>関数</h2><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  hello(<span class="string">&#x27;Dart&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> hello(<span class="built_in">String</span> name) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Hello <span class="subst">$&#123;name&#125;</span>!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>関数を定義、実行することが可能です。<br>関数および関数が受け取る引数の型アノテーションは<a href="https://dart.dev/guides/language/effective-dart/style">スタイルガイド</a>で推奨されていますが、必須ではありません。</p><h2 id="非同期処理"><a href="#非同期処理" class="headerlink" title="非同期処理"></a>非同期処理</h2><p>Dartは非同期処理をサポートしています。</p><figure class="highlight dart"><figcaption><span>async.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunction() &#123;</span><br><span class="line">  <span class="keyword">return</span> Future&lt;<span class="built_in">String</span>&gt;.value(<span class="string">&quot;it is Asynchronous processing&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">final</span> resp = asyncFunction();</span><br><span class="line">  resp.then((value) =&gt; <span class="built_in">print</span>(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart aync.dart</span><br><span class="line">it is Asynchronous processing</span><br></pre></td></tr></table></figure><p><code>Future&lt;型名&gt;</code>という型アサーションで非同期処理を定義できます。<br>Future社員としては使いこなすモチベーションが無駄に高まります。</p><figure class="highlight dart"><figcaption><span>async.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunction() &#123;</span><br><span class="line">  <span class="keyword">return</span> Future&lt;<span class="built_in">String</span>&gt;.value(<span class="string">&quot;it is Asynchronous processing&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> resp = <span class="keyword">await</span> asyncFunction();</span><br><span class="line">  <span class="built_in">print</span>(resp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javascriptのように、<code>async</code>、<code>await</code>の構文も利用可能です。</p><figure class="highlight dart"><figcaption><span>async.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> resp = <span class="keyword">await</span> <span class="keyword">new</span> Future(()&#123;</span><br><span class="line">    <span class="built_in">String</span> s = <span class="string">&#x27;it is Asynchronous processing&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">print</span>(resp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記のように無名関数をそのまま書いていく事も可能です。</p><h2 id="クラス"><a href="#クラス" class="headerlink" title="クラス"></a>クラス</h2><p>Dartはオブジェクト指向言語であるため、クラスが存在します。</p><p>インスタンス変数、コンストラクタ、メソッドを指定して、クラスを定義することが可能です。Personクラスの定義の内部にPerson()を定義する形でコンストラクタを設定します。<br>コンストラクタの定義には様々なパターンが存在します。</p><p>常数コンストラクタ、ファクトリ・コンストラクタなど高度な定義方法もありますが、ひとまずは基礎的なクラス定義を紹介します。</p><h3 id="Generative-Constructors"><a href="#Generative-Constructors" class="headerlink" title="Generative Constructors"></a>Generative Constructors</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> yamada = <span class="keyword">new</span> Person();</span><br><span class="line">  yamada.name = <span class="string">&#x27;yamada&#x27;</span>;</span><br><span class="line">  <span class="built_in">print</span>(yamada.hello());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line"></span><br><span class="line">  Person()&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>コンストラクタでは引数を受け取らず適当な初期値を入力し、インスタンス生成後にメンバ変数を指定するシンプルな方式です。</p><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> yamada = <span class="keyword">new</span> Person(<span class="string">&#x27;yamada&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(yamada.hello());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line"></span><br><span class="line">  Person(<span class="built_in">String</span> name)&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart</span><br><span class="line">Hello, My name is yamada</span><br></pre></td></tr></table></figure><p>コンストラクタに引数を定義し、初期化時に受け取る方式です。</p><h3 id="Automatic-field-initialization"><a href="#Automatic-field-initialization" class="headerlink" title="Automatic field initialization"></a>Automatic field initialization</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> yamada = <span class="keyword">new</span> Person(<span class="string">&#x27;yamada&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(yamada.hello());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line"></span><br><span class="line">  Person(<span class="keyword">this</span>.name);</span><br><span class="line"></span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart</span><br><span class="line">Hello, My name is yamada</span><br></pre></td></tr></table></figure><p>コンストラクタの記述をシンプルに定義可能な方式です。</p><h3 id="Named-Constructors"><a href="#Named-Constructors" class="headerlink" title="Named Constructors"></a>Named Constructors</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> yamada = <span class="keyword">new</span> Person.asConsultant(<span class="string">&#x27;yamada&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(yamada.hello());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line">  <span class="keyword">var</span> job;</span><br><span class="line"></span><br><span class="line">  Person(<span class="keyword">this</span>.name, <span class="keyword">this</span>.job);</span><br><span class="line"></span><br><span class="line">  Person.asConsultant(<span class="built_in">String</span> name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.job = <span class="string">&#x27;IT Consultant&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>, I am <span class="subst">$&#123;<span class="keyword">this</span>.job&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart</span><br><span class="line">Hello, My name is yamada, I am IT Consultant</span><br></pre></td></tr></table></figure><p>特定条件付きのコンストラクタを定義可能です。</p><h3 id="Redirecting-Constructors"><a href="#Redirecting-Constructors" class="headerlink" title="Redirecting Constructors"></a>Redirecting Constructors</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> yamada = <span class="keyword">new</span> Person.asConsultant(<span class="string">&#x27;yamada&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(yamada.hello());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line">  <span class="keyword">var</span> job;</span><br><span class="line"></span><br><span class="line">  Person(<span class="keyword">this</span>.name, <span class="keyword">this</span>.job);</span><br><span class="line"></span><br><span class="line">  Person.asConsultant(<span class="built_in">String</span> name) : <span class="keyword">this</span>(name, <span class="string">&quot;IT Consultant&quot;</span>);</span><br><span class="line"></span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>, I am <span class="subst">$&#123;<span class="keyword">this</span>.job&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart</span><br><span class="line">Hello, My name is yamada, I am IT Consultant</span><br></pre></td></tr></table></figure><p>他のコンストラクタの定義を再利用する方式です。</p><h3 id="クラスの継承"><a href="#クラスの継承" class="headerlink" title="クラスの継承"></a>クラスの継承</h3><figure class="highlight dart"><figcaption><span>hello.dart</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">var</span> yamada = <span class="keyword">new</span> ITConsultant(<span class="string">&#x27;yamada&#x27;</span>);</span><br><span class="line">  <span class="built_in">print</span>(yamada.hello());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line"></span><br><span class="line">  Person(<span class="keyword">this</span>.name);</span><br><span class="line"></span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ITConsultant</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  ITConsultant(<span class="built_in">String</span> name) : <span class="keyword">super</span>(name);</span><br><span class="line">  hello() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, My name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>, I am IT Consultant&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dart hello.dart</span><br><span class="line">Hello, My name is yamada, I am IT Consultant</span><br></pre></td></tr></table></figure><p>他のオブジェクト指向言語同様クラスは継承することができます。</p><h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>一通り基礎部分をさらってみましたが、豊富な表現力と適度な硬さの両立を目指そうとしている印象を受けました。</p><p>その辺りの思想と肌感覚がマッチすればハマる言語かもしれません。</p><p>破壊的な変更により今では動かないシンタックスが検索結果の上位に散見しているので、学習障壁を高めてしまうかなと感じました。<br>今回の連載で有用な記事を増やして盛り上げていきたいですね。</p><p><a href="/articles/20210510a/">Dart/Flutter連載</a>の1記事目ででした。次は宮崎さんの<a href="/articles/20210511b/">Flutter Swagger統合</a>です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;この記事は&lt;a href=&quot;/articles/20210510a/&quot;&gt;Dart/Flutter連載&lt;/a&gt;の1記事目です。&lt;/p&gt;
&lt;p&gt;TIGの伊藤真彦です。&lt;/p&gt;
&lt;p&gt;Dart/Flutter入門に参加します、DartといえばFlutterの話が必ずついてくるもの</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Dart" scheme="https://future-architect.github.io/tags/Dart/"/>
    
    <category term="Flutter連載" scheme="https://future-architect.github.io/tags/Flutter%E9%80%A3%E8%BC%89/"/>
    
  </entry>
  
  <entry>
    <title>Dart/Flutter連載始めます</title>
    <link href="https://future-architect.github.io/articles/20210510a/"/>
    <id>https://future-architect.github.io/articles/20210510a/</id>
    <published>2021-05-09T15:00:00.000Z</published>
    <updated>2021-05-14T05:39:44.165Z</updated>
    
    <content type="html"><![CDATA[<p>2021年3月に「Flutter 2.0」のリリースが発表されました！</p><p>そして、本ブログ初のDart/Flutterをテーマにした連載を行います。内容は次のようになっています。</p><table><thead><tr><th>公開日</th><th>執筆者</th><th>タイトル</th></tr></thead><tbody><tr><td>5月10日</td><td>伊藤真彦</td><td><a href="/articles/20210510b/">Dart入門</a></td></tr><tr><td>5月11日</td><td>宮崎将太</td><td><a href="/articles/20210511b/">Flutter Swagger統合</a></td></tr><tr><td>5月12日</td><td>澁川喜規</td><td><a href="/articles/20210512a/">Goのサーバーの管理画面をFlutter Webで作ってみるための調査</a></td></tr><tr><td>5月13日</td><td>鶴巻彩夏</td><td><a href="/articles/20210513b/">Flutterレイアウト入門</a></td></tr><tr><td>5月14日</td><td>真野隼記</td><td><a href="/articles/20210514a/">Flutterで技術ブログRSSリーダー</a></td></tr><tr><td>5月17日</td><td>越島亮介</td><td>MaaSアプリ作ってみた</td></tr><tr><td>5月18日</td><td>村田靖拓</td><td></td></tr></tbody></table><p>本記事では、Flutterの概要についてお伝えします。</p><h2 id="Flutter-モバイル・Web・デスクトップ対応のフレームワーク"><a href="#Flutter-モバイル・Web・デスクトップ対応のフレームワーク" class="headerlink" title="Flutter = モバイル・Web・デスクトップ対応のフレームワーク"></a>Flutter = モバイル・Web・デスクトップ対応のフレームワーク</h2><img src="/images/20210510a/logo_lockup_flutter_horizontal.png" alt="flutter horizontal logo" width="700px" height="196px"><p>FlutterはGoogle製フレームワークで、単一のソースコードでモバイル・Web・デスクトップ対応可能なアプリケーションを開発することができます。言語はDartで、こちらもGoogle製です。</p><p>今までは、iOS/Androidの両OSに対応したモバイルアプリケーション開発機能のみが安定版として提供されていましたが、「Flutter 2.0」のリリースで、Webアプリケーション開発機能がベータ版から安定版となりました。</p><p>Windows/Mac/Linux対応のデスクトップアプケーション開発機能は現在ベータ版で、「early release flag付き」で安定版でも利用可能となっています。<a href="https://medium.com/flutter/whats-new-in-flutter-2-0-fe8e95ecc65">Flutterの技術ブログ</a>によると、 デスクトップアプリケーションについても今年後半に安定版がリリースされるようです。</p><p>弊社では、モバイルアプリケーション開発においてFlutterの採用事例があります。</p><p>今後はあらゆるプラットフォームで選択肢となる可能性があり、今後が楽しみです。</p><h2 id="Googleトレンドによる国内・海外での動向"><a href="#Googleトレンドによる国内・海外での動向" class="headerlink" title="Googleトレンドによる国内・海外での動向"></a>Googleトレンドによる国内・海外での動向</h2><p>Googleトレンドで、Flutterとモバイルやクロスプラットフォーム対応フレームワークについて「日本」と「すべての国」で比較してみました。Flutter 1.0がリリースされた2018年12月を始点としています。Googleトレンド上では、国内ではじわじわとFlutterの検索が増えており、海外ではすでに他の言語・フレームワークを超えてFlutterが盛り上がっているようです。</p><ul><li>日本<img src="/images/20210510a/flutter_google_treand_in_japan.png" alt="Flutter Google Trend in Japan" width="1191" height="564" loading="lazy"></li><li>すべての国<img src="/images/20210510a/flutter_google_treand_in_global.png" alt="Flutter Google Trend in Globa" width="1178" height="560" loading="lazy"></li></ul><h2 id="特徴"><a href="#特徴" class="headerlink" title="特徴"></a>特徴</h2><p>Flutterの特徴として、公式サイトでは以下の3つが挙げられています。</p><p><strong>特徴①： 「高速ホットリロード」と「豊富なウィジェット」による高速なアプリ開発体験</strong><br>開発時にコードの変更をすぐにエミュレータや実機に反映することができ、フラストレーションなく開発を行うことができます。また、ボタンやリスト、カード、モーダルなど予め豊富なUI部品が用意されているので、簡単に画面を構築することができます。</p><p>フロントエンド開発の経験があまりない私は、モバイルアプリケーションにはさらに高いハードルを感じていましたが、Flutterでスマホアプリの画面をスムーズに作ることができ、とても魅力を感じました。</p><p><strong>特徴②： 表現力豊かで柔軟なユーザインタフェース</strong><br>開発者はエンドユーザの体験に重点を置いた機能を素早く開発することができます。<br>Flutterの階層的なアーキテクチャーにより、複雑なUIにも対応することが可能で、<br>非常に高速なレンダリングと表現力豊かで柔軟なデザインを実現できます。</p><p><strong>特徴③: ネイティブなパフォーマンス</strong><br>Flutterのコードはマシンコードにコンパイルされ、ネイティブアプリ同等のパフォーマンスを提供します。Flutterの独自レンダリングの仕組みもパフォーマンスが高い理由の1つのようです。</p><p><strong>公式サイトのトップページで、Flutterのソースコードを動かしてみることができるので、ぜひ触って体感してみてください！</strong></p><h2 id="Flutter-2-0"><a href="#Flutter-2-0" class="headerlink" title="Flutter 2.0"></a>Flutter 2.0</h2><p>今年3月にリリースされた「Flutter 2.0」は様々なアップデートがありますが、特に下記の2つが大きなトピックだと思います。</p><p><strong>・Webアプリケーション開発機能が安定版となった</strong><br><strong>・デスクトップアプリケーション開発機能がearly release付きで安定版で使用可能になった</strong></p><p>また、Googleの<a href="https://developers.googleblog.com/2021/03/announcing-flutter-2.html">Flutter 2.0リリース記事</a>には、各企業と協力している取り組みにも言及されており、とても興味深いです。詳細が気になる方は、ぜひご確認ください。</p><p><strong>・Canonicalと連携したLinuxデスクトップアプリケーション開発機能のサポート</strong><br><strong>・Microsoftと連携したWindowsアプリケーション開発と折りたたみデバイス(Surface Duo等)アプリケーション開発のサポート</strong><br><strong>・トヨタが車載システムにFlutterを導入する計画を発表</strong></p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>Flutter 2.0がリリースされ、これから様々なプラットフォームで使われていくことが期待されます。</p><p>Flutter連載もぜひお楽しみください！</p><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20210112/index.html" data-iframely-url="//cdn.iframe.ly/P7BPs3C?iframe=card-small"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;2021年3月に「Flutter 2.0」のリリースが発表されました！&lt;/p&gt;
&lt;p&gt;そして、本ブログ初のDart/Flutterをテーマにした連載を行います。内容は次のようになっています。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;公開日&lt;/th&gt;
&lt;th</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="インデックス" scheme="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9/"/>
    
    <category term="Flutter" scheme="https://future-architect.github.io/tags/Flutter/"/>
    
    <category term="Flutter連載" scheme="https://future-architect.github.io/tags/Flutter%E9%80%A3%E8%BC%89/"/>
    
  </entry>
  
  <entry>
    <title>Goでバッチ登録するときのイディオム</title>
    <link href="https://future-architect.github.io/articles/20210430b/"/>
    <id>https://future-architect.github.io/articles/20210430b/</id>
    <published>2021-04-29T15:00:01.000Z</published>
    <updated>2021-05-12T13:36:41.505Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIG DXユニット<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>真野です。</p><p>個人利用など、ごく小さなサービスなどでない限り、複数件のレコードを一括でデータストア層へ登録する必要は出てくると思います。この時1件ずつループ処理で登録するのではなく、効率性などの観点で各データストアが提供する一括登録の仕組みを利用すると思います。</p><p>RDBであればバルク（Bulk Insert）とかバッチ（Batch Insert）の登録手段が存在すると思います。PostgreSQLであればCopy句で、OracleであればSQL*Loaderを使ってCSVを直接読み込ませる方法があります。</p><p>この記事ではCSVなどの一括登録ではなく、Batch Insertの実装について触れていきます。タイトルはバッチ登録ですがバッチ検索でもバッチ削除でも同じように役立つ内容かと思います。</p><h2 id="バッチ登録を行う側で気をつけること"><a href="#バッチ登録を行う側で気をつけること" class="headerlink" title="バッチ登録を行う側で気をつけること"></a>バッチ登録を行う側で気をつけること</h2><p>例えばAWS DynamoDBであればバッチ登録（<a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_BatchWriteItem.html">BatchWriteItem</a>）では1操作で最大25項目までしか対応していません<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>。（RDBであればこうした分かりやすい数値的な上限はないかと思いますが、クライアントとDBサーバ側の主にメモリ資源を使いすぎないように、例えば1000件ずつなど小分けして登録することが多いかと思います）</p><p>つまり、DynamoDBであれば120件のデータをBatchWriteItemで登録するためには、最低でも5回（25件×4回＋20件×1回）の操作が必要です。</p><p>こうした、1操作で登録しきれない件数のバッチ登録（Batch Put）するときの実装方法ですが、書く人によって色々種類があることに気が付きました。すこし面白かったので本記事ではまとめます。データストアはDynamoDBを利用しますが、どのデータストアでも伝わる部分があると思います。DynamoDBって何か気になって先に進めない方は、富山さんの<a href="/articles/20200818/">【入門】私を苦しめたDynamoDB</a>記事がおすすめです。</p><p>コードは<a href="https://github.com/ma91n/go-batch-put-idioms">こちら</a>にまとめました。</p><h2 id="各イディオムで用いる共通部分"><a href="#各イディオムで用いる共通部分" class="headerlink" title="各イディオムで用いる共通部分"></a>各イディオムで用いる共通部分</h2><p>各イディオムに入る前に永続化に用いる関数を用意します。ローカルでも動かせるようにLocakStackを利用します。これの実装は本題じゃないので読み飛ばし推奨です。</p><ul><li><code>func BatchWrite(ctx context.Context, writes[]Forum) error</code></li></ul><details><summary>BatchWriteの実装についての詳細(※👈クリックで開く。読み飛ばしてもOK)</summary><div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LocalStackを用いるための初期化部分（読み飛ばしOK）</span></span><br><span class="line"><span class="keyword">var</span> dy = dynamodb.New(session.Must(session.NewSession(&amp;aws.Config&#123;</span><br><span class="line">Endpoint: aws.String(<span class="string">&quot;http://localhost:4566&quot;</span>),        <span class="comment">// LocalStack</span></span><br><span class="line">Region:   aws.String(endpoints.ApNortheast1RegionID), <span class="comment">// Tokyo Region</span></span><br><span class="line">&#125;)))</span><br></pre></td></tr></table></figure><p><code>dy</code> を用いて以下の永続化用の関数を用意します。25件以上であるときはエラーにしていること以外は、UnprocessedItemsの救済の為に少し処理を追加しています。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 永続化関数（読み飛ばしOK）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BatchWrite</span><span class="params">(ctx context.Context, writes[]Forum)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(writes) &gt; <span class="number">25</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;batch write size is within 25 items&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">items := <span class="built_in">make</span>([]*dynamodb.WriteRequest, <span class="number">0</span>, <span class="built_in">len</span>(writes))</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> writes&#123;</span><br><span class="line">av, _ := dynamodbattribute.MarshalMap(v) <span class="comment">// エラーハンドリングは省略</span></span><br><span class="line">items = <span class="built_in">append</span>(items, &amp;dynamodb.WriteRequest&#123;</span><br><span class="line">PutRequest: &amp;dynamodb.PutRequest&#123;</span><br><span class="line">Item: av,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">len</span>(items) &gt; <span class="number">0</span> &#123;</span><br><span class="line">out, err := dy.BatchWriteItemWithContext(ctx, &amp;dynamodb.BatchWriteItemInput&#123;</span><br><span class="line">RequestItems: <span class="keyword">map</span>[<span class="keyword">string</span>][]*dynamodb.WriteRequest&#123;</span><br><span class="line"><span class="string">&quot;forum&quot;</span>: items,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;batch write to %s: %w&quot;</span>, <span class="string">&quot;forum&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">items = <span class="built_in">append</span>(items[:<span class="number">0</span>] , out.UnprocessedItems[<span class="string">&quot;forum&quot;</span>]...) <span class="comment">// スライスを初期化して未処理のitemsがあれば追加</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>永続化対象の <code>Forum</code> テーブルを示すモデルですが、AWS SDK for Goのドキュメントに書いていた構造です。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 永続化対象のモデル（読み飛ばしOK）</span></span><br><span class="line"><span class="keyword">type</span> Forum <span class="keyword">struct</span> &#123;</span><br><span class="line">Name     <span class="keyword">string</span></span><br><span class="line">Category <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><h2 id="①素朴なバッチ登録実装"><a href="#①素朴なバッチ登録実装" class="headerlink" title="①素朴なバッチ登録実装"></a>①素朴なバッチ登録実装</h2><p>本題のイディオムです。まずは素朴にループを回す実装です。何も考えずに実装すると多くの人が最初にこのコードを実装するのではないでしょうか？ <code>LoadForums</code> は<code>[]Forum</code>を返す、数百～数千件くらいのCSVを読み取るような処理をイメージください。</p><figure class="highlight go"><figcaption><span>素朴な実装</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line">loadForums := LoadForums() <span class="comment">// 数千件くらいのそこそこ大きいデータ</span></span><br><span class="line"></span><br><span class="line">batch := <span class="built_in">make</span>([]Forum, <span class="number">0</span>, <span class="number">25</span>)</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> loadForums &#123;</span><br><span class="line"></span><br><span class="line">batch = <span class="built_in">append</span>(batch, v) <span class="comment">// 1行毎にスライスに追加</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(batch) &gt;= <span class="number">25</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := BatchWrite(ctx, batch); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">batch = batch[:<span class="number">0</span>] <span class="comment">// スライスをクリア</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(batch) &gt; <span class="number">0</span> &#123;  <span class="comment">// 25の剰余が1~24の場合の救済</span></span><br><span class="line"><span class="keyword">if</span> err := BatchWrite(context.Background(), batch); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;finished&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最初のfor文で1行ずつスライスに要素を追加し、指定件数（今回だと25件）になったタイミングで <code>BatchWrite</code> を呼び出し永続化します。最後の if文のブロックでは、1件以上かつ25件未満のケースを救済しています。</p><p>便宜上、素朴と表現しましたが、IteratorパターンのようにHasNext/NextしかAPIを公開されておらず次のレコードの有無がわからない場合はこういったアプローチを取るしか無い場合もあるので、利用シーンも少なからずあるかと思います。</p><h2 id="②すこし進化したバッチ登録"><a href="#②すこし進化したバッチ登録" class="headerlink" title="②すこし進化したバッチ登録"></a>②すこし進化したバッチ登録</h2><p>さきほど書いた素朴なコードですが、少し冗長な部分があります。for文とif文の<code>BatchWrite</code>呼び出し部分が重複しており冗長ですね。ここをスッキリさせたバージョンが次です。</p><figure class="highlight go"><figcaption><span>すこしスッキリさせた実装</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx  := context.Background()</span><br><span class="line">forums := LoadForums()</span><br><span class="line"></span><br><span class="line">batch := <span class="built_in">make</span>([]Forum, <span class="number">0</span>, <span class="number">25</span>)</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> forums &#123;</span><br><span class="line"></span><br><span class="line">batch = <span class="built_in">append</span>(batch, v) <span class="comment">// 1行枚にスライスに追加</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(batch) &gt;= <span class="number">25</span> || i == <span class="built_in">len</span>(forums) <span class="number">-1</span> &#123; <span class="comment">// 25個になったか、最終行の場合</span></span><br><span class="line"><span class="keyword">if</span> err := BatchWrite(ctx, batch); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">batch = batch[:<span class="number">0</span>] <span class="comment">// スライスをクリア</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;finished&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>for文の中のif文で、<code>BatchWrite</code> を呼び出す条件を変えました。スライスが25件に達した時に加え、 <strong>最終行の場合にも</strong> 分岐を通すようにします。for文の後にあった <code>BatchWrite</code> の分岐を消せました。かなりスッキリです。</p><p>今回は、処理対象のレコードがすべてスライスになっている（メモリに読み込んでいる）状態ですが、これが巨大なCSVファイルを入力とするケースでは、1, 2の実装のように逐次的な処理をする必要があると思います。</p><h2 id="③少しエレガント実装"><a href="#③少しエレガント実装" class="headerlink" title="③少しエレガント実装"></a>③少しエレガント実装</h2><p>新規にスライスを宣言せず、読み取ったスライスから部分スライスを作成する実装です。少しトリッキーに見えるかもしれませんが、そんなに難しいことをしていないです。ポイントはループ変数 <code>i</code>　～ <code>i+25(end)</code> で部分スライスをループ毎に作るというアプローチでしょうか。</p><figure class="highlight go"><figcaption><span>スライスを新規に配置しないケース</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line">forums := LoadForums()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(forums); i += <span class="number">25</span> &#123;</span><br><span class="line">end := i + <span class="number">25</span></span><br><span class="line"><span class="keyword">if</span> end &gt; <span class="built_in">len</span>(forums) &#123;</span><br><span class="line">end = <span class="built_in">len</span>(forums)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := BatchWrite(ctx, forums[i:end]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;finished&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>イメージしにくい方のために、バッチサイズを5、処理対象のレコード数が13での動作イメージを書きました。</p><img src="/images/20210430b/batch_slice.png" alt="バッチ化の動作イメージ" width="741" height="291" loading="lazy"><p>もしも、最初から <code>BatchWrite</code> したいレコードがスライスの状態にある（メモリに載っている）のであれば、この実装方法が可読性もそこまで落ちず、かつ最も効率が良さそうです。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><ul><li>バッチ登録のイディオムはいくつかパターンがある</li><li>メモリに載っている場合は、③のように元のスライスからサブスライスを作る方法が良さそう</li><li>入力データが巨大な場合は、①、②のような逐次的な処理を入れる必要が出てきそう</li></ul><p>Goだとgoroutineとチャネルを利用してこうした複数チャンクに分割しつつ、並列にデータ登録することも容易にできそうですね。そのあたりも機会があれば書いていこうと思います。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">Technology Innovation Group（TIG）は、「最先端、且つ先進的なテクノロジーのプロフェッショナル集団」、「プロジェクト品質と生産性の向上」、「自社サービス事業の立ち上げ」を主なミッションとする、技術部隊です。</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;"><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_BatchWriteItem.html">https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_BatchWriteItem.html</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;TIG DXユニット&lt;sup id=&quot;fnref:1&quot;&gt;&lt;a href=&quot;#fn:1&quot; rel=&quot;footnote&quot;&gt;1&lt;/</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="DynamoDB" scheme="https://future-architect.github.io/tags/DynamoDB/"/>
    
    <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
    <category term="バッチ処理" scheme="https://future-architect.github.io/tags/%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Go Conference 2021 Springに登壇しました</title>
    <link href="https://future-architect.github.io/articles/20210430a/"/>
    <id>https://future-architect.github.io/articles/20210430a/</id>
    <published>2021-04-29T15:00:00.000Z</published>
    <updated>2021-05-12T09:08:10.751Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>こんにちは、辻です。先日開催されました <a href="https://gocon.jp/">Go Conference 2021 spring</a> にTIGから渋川、辻の計2名が登壇しました。</p><p><img src="/images/20210430a/logo_text.png"></p><blockquote><p>The Gopher character is based on the Go mascot designed by Renée French.</p></blockquote><p><a href="https://sendai.gocon.jp/">Go Conference’20 in Autumn</a>ではオンラインとオフラインのハイブリッドな構成でしたが、今回はGo Conference史上初となるフルオンラインでの開催となりました。今回のカンファレンスでは事前録画したビデオによる発表もサポートされていました。またオンラインでのリアルタイム登壇にあたって、リハーサルを始め手厚いサポートをいただき、安心して発表することができました。運営の皆様、ありがとうございました！</p><h3 id="実務で役立つTCPクライアントの作り方"><a href="#実務で役立つTCPクライアントの作り方" class="headerlink" title="実務で役立つTCPクライアントの作り方"></a>実務で役立つTCPクライアントの作り方</h3><p>発表資料は以下です。</p><script async class="speakerdeck-embed" data-id="340854fb6cf14990bfe4daa1d1c11efb" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script><p>発表内容は、TCPクライアントを実装するときの考慮点をまとめたものです。普段HTTPなどを用いて通信するときはGoの標準ライブラリである <code>net/http</code> パッケージのAPIを使います。自前で <code>net</code> パッケージを使ってTCPクライアントを実装する必要はありません。しかし標準ライブラリではサポートされていないTCP上の独自のプロトコルで通信する必要がある場合や、通信したいプロトコルがOSSとして公開されているライブラリでは不足がある場合などは、自前でTCPクライアントを実装する必要があります。Go Conferenceの他のセッションでも、金融系のプロトコルである<a href="https://ja.wikipedia.org/wiki/ISO_8583">ISO8583</a>をTCPで扱っている例が紹介されており、実は身近なところで独自のTCPクライアントが必要になるかもしれません。</p><p>Goでは <code>net</code> パッケージを使うと簡単にTCPクライアントを実装できますが、プロダクションレディなTCPクライアントに仕上げていくにはいくつか考慮点があります。</p><ul><li>タイムアウト</li><li>コネクションプーリング</li><li>エラーハンドリング</li><li>リトライ</li></ul><p>といったポイントを紹介しています。</p><p>セッションを見ていただいた皆様、twitterでコメントくださった皆様、ありがとうございました！</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Goでソケットを直接触る機会、ありそうでなかなかないのでこういった知識の復習大事 <a href="https://twitter.com/hashtag/gocon?src=hash&amp;ref_src=twsrc%5Etfw">#gocon</a> <a href="https://twitter.com/hashtag/goconA?src=hash&amp;ref_src=twsrc%5Etfw">#goconA</a></p>&mdash; castaneai (@castanea) <a href="https://twitter.com/castanea/status/1385837483384995841?ref_src=twsrc%5Etfw">April 24, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">コネクションプーリングしていてそのコネクションが悪くなっていることがあるって怖いね。<a href="https://twitter.com/hashtag/gocon?src=hash&amp;ref_src=twsrc%5Etfw">#gocon</a> <a href="https://twitter.com/hashtag/goconA?src=hash&amp;ref_src=twsrc%5Etfw">#goconA</a></p>&mdash; Kabo (@kabochapo) <a href="https://twitter.com/kabochapo/status/1385841331365310464?ref_src=twsrc%5Etfw">April 24, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">TCP面白かったです！！！<a href="https://twitter.com/hashtag/gocon?src=hash&amp;ref_src=twsrc%5Etfw">#gocon</a> <a href="https://twitter.com/hashtag/goconA?src=hash&amp;ref_src=twsrc%5Etfw">#goconA</a></p>&mdash; luccafort (@luccafort) <a href="https://twitter.com/luccafort/status/1385841179648872452?ref_src=twsrc%5Etfw">April 24, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;こんにちは、辻です。先日開催されました &lt;a href=&quot;https://gocon.jp/&quot;&gt;Go Conference </summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇資料" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E8%B3%87%E6%96%99/"/>
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Cypress - 書きやすいテストの秘密と独自コマンドの実装</title>
    <link href="https://future-architect.github.io/articles/20210428d/"/>
    <id>https://future-architect.github.io/articles/20210428d/</id>
    <published>2021-04-27T15:00:04.000Z</published>
    <updated>2021-05-12T01:23:11.659Z</updated>
    
    <content type="html"><![CDATA[<p>@testing-library/cypressの存在を知らずに、それっぽいものを作ろうとしたときにいろいろ調査した記録です。Cypressにはテストコードが縦と横に短くなる工夫がされており、そのメカニズムにしたがった独自コマンドを実装するにはコツが必要です。</p><p>実装は次のところにありますが、@testing-library/cypressの方がメンテされているので、こちらは実際には使わないのをお勧めします。</p><p><a href="https://gitlab.com/osaki-lab/cypress-aria">https://gitlab.com/osaki-lab/cypress-aria</a></p><h1 id="Cypressのテストが縦横に短く書けるわけ"><a href="#Cypressのテストが縦横に短く書けるわけ" class="headerlink" title="Cypressのテストが縦横に短く書けるわけ"></a>Cypressのテストが縦横に短く書けるわけ</h1><p>CypressはWebDriver系(Selenium)やChrome DevTool Protocol系（Puppeteer)のツールとAPIの粒度が異なります。Seleniumはそもそもウェブサイトのタイトルに「Browser Automation Tool」とありますし、PuppeteerのAPIもそれに近いです。ソースコードに書かれているコードと、ブラウザ上で動作する挙動に違いはありません。</p><p>Cypressは一言で要素探索のAPI呼び出しといっても、検索とパターンマッチを裏で高速に繰り返します。デフォルトのタイムアウトは4秒で、その間、100mS間隔ぐらいでリクエストを繰り返します。これの何がよいかというと、最近のReactやVueやAngularといった仮想DOMやIncremental DOMなソリューションと相性が良い点です。</p><p>これらのフロントエンドでは、何かしらのボタン操作やその結果のAPIアクセスの結果で、非同期で画面が更新されます。いつ画面の更新処理が終わったのか通知が来るわけではありません。例えば、ウェブサーバーに問い合わせをして、その結果を受けて画面表示する場合、WebDriverやCDP系ツールでは自分でウェイトを置いて、0.1秒待つ、といったことをします。</p><p>Cypressは次のようなメソッドチェーンの命令になっており、<code>should(&quot;exist&quot;)</code>が成功するまでタイムアウト時間（デフォルト4秒）までの間、100mSぐらいことに<code>find(&quot;button.ok&quot;)</code>を繰り返します。<code>find()</code>の関数の呼び出し結果にこのDOM要素が入ってくるわけではなく、これらのAPIの裏で複雑な動きをします。そもそもJSなのに<code>await</code>を使わないで済むのはこれが実際の命令と一対一に対応していないからです。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.find(<span class="string">&quot;button.ok&quot;</span>).should(<span class="string">&quot;exist&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="/images/20210428d/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-04-24_8.14.01.png"></p><p>明示的なwaitを書かずに済むことで、処理時間と成功率のトレードオフを考えなくても済むというメリットがあります。</p><p>まず、逐次処理のパターンではテストが失敗しないためには余裕を持った大きめの待ち時間をテストコードに書く必要があります。テストの時間を短くしようとして50パーセンタイルな時間を書けば50%は失敗するということです。そして、たいてい99パーセンタイルは50パーセンタイルよりも遥かに大きな値であることが往々にしてあります。</p><p>Cypressでは成功次第次の処理が実行されるため、毎回待ち時間の最大値で待つのに比べて、実行時間が短縮されますし、待ち時間が足りなくてテストがランダムに壊れるのを防ぐためにウェイトを調整するといった不毛な作業が減ります。また、待ち時間を忘れてテストが失敗するというわかりにくい不具合も減ります。</p><p>また、ウェイトを自分で入れる必要性があまりないのでコードが縦に短くなります。表示を待つだけならNightwatchでもSeleniumできますが、待つための余計なコードを書く必要がなく、クリックなどもすべてリトライしてくれるところがCypressの良いところです。また、逐次処理ではなく、期待する状態の宣言なので、<code>await</code>などがいらないので横も短くなります。</p><p>ただし、waitが100%不要になるかというと、部分的には必要です。例えばレビューの星の数を設定して数が変化するテストを書こうとしているとします。星の数が設定されて更新されるまでにタイムラグがあるとすると、find()は変更前の状態で早々にマッチしてしまうため、処理が先に進んでしまいます。この場合はエラーになってしまうので処理の完了を待つ<code>cy.wait()</code>が必要となります。</p><p>それ以外に、E2Eテストとして信頼できるテストが書けるための機能としては、きちんと人が操作できるかどうかをCSSや属性も見てチェックしてくれる点もポイントです。ブラウザの見た目の完全なシミュレートではないのですが、テストが成功したのに手動でテストしたらバグっている、みたいなことが減ります。</p><ul><li>要素がvisibleなのか？</li><li>disabledな要素を操作しようとしていないか？</li><li>readonlyがついているのにタイプしようとしてないか？　</li><li>親要素のスクロールとかoverflowとかで隠れていないか？</li><li>他の要素に隠されていないか？</li></ul><h1 id="Cypressのリトライポリシーに従ったコマンドの作り方"><a href="#Cypressのリトライポリシーに従ったコマンドの作り方" class="headerlink" title="Cypressのリトライポリシーに従ったコマンドの作り方"></a>Cypressのリトライポリシーに従ったコマンドの作り方</h1><p>同じ複雑なセレクターを何度も繰り返し書くのを楽にしてあげるだけであれば、コマンドを作って、その中で<code>cy.get()</code>や<code>cy.find()</code>を使ってあげればOKです。</p><p>しかし、AまたBを取得、みたいなケースではうまく書かないと、Aの取得でタイムアウト、Bの取得でもタイムアウトと2倍時間がかかって、リトライの挙動が他のコマンドと違う動きになってしまいます。リトライポリシーに準拠するには、Cypressの作法に従って書く必要があります。</p><p>公式ドキュメントにはここを参上にするように、と書かれていますがピンポイントで参考にするのはちょっと難しい実装でした。これだけ見ても実装方法がよくわからなかったのでこれを読み解いた＆モダンなTypeScriptの書き方を紹介していきます。</p><p><a href="https://github.com/cypress-io/cypress-xpath/pull/12/files">https://github.com/cypress-io/cypress-xpath/pull/12/files</a></p><p>ここで紹介する以外にもボタンなどさまざまな要素取得を実装したのがこちらのパッケージです。</p><p><a href="https://gitlab.com/osaki-lab/cypress-aria">https://gitlab.com/osaki-lab/cypress-aria</a></p><p>ただ、@testing-library/cypressというもっと前から開発されているパッケージがあるので、これを使う必要はありませんので、参考実装としてみていただければと思います。</p><h2 id="これから作るコマンドの要件"><a href="#これから作るコマンドの要件" class="headerlink" title="これから作るコマンドの要件"></a>これから作るコマンドの要件</h2><p>aria属性に従って要素取得を実装したときは、「aria-labelがあればそれを名前とする、aria-labelledbyがあれば、参照先のDOMのテキストを名前とする、親が<code>&lt;label&gt;</code>で<code>for=</code>で自分の要素のIDがついていたらそちらを名前とする、みたいなOR条件で要素を取得します。</p><p>まずはコマンドの枠組みです。ここに追加していきます。</p><figure class="highlight ts"><figcaption><span>index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"></span><br><span class="line">Cypress.Commands.add( <span class="comment">// ポイント1: コマンド登録</span></span><br><span class="line">    <span class="string">&#x27;ariaLink&#x27;</span>,</span><br><span class="line">    &#123; <span class="attr">prevSubject</span>: [<span class="string">&#x27;optional&#x27;</span>, <span class="string">&#x27;element&#x27;</span>, <span class="string">&#x27;document&#x27;</span>] &#125;,</span><br><span class="line">    aria</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ポイント2: asyncな関数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async</span> <span class="title">ariaLink</span>(<span class="params">subject, selector, options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> resolveValue = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> value = なんらかの処理();</span><br><span class="line">        <span class="keyword">return</span> cy.verifyUpcomingAssertions(value, options, &#123;</span><br><span class="line">            onRetry: resolveValue, <span class="comment">// ポイント3: 自分自身をretry対象にしつつassetする関数を定義</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> resolveValue()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ポイントはコード中に書いた3箇所です。</p><h2 id="コマンドのコンテキスト"><a href="#コマンドのコンテキスト" class="headerlink" title="コマンドのコンテキスト"></a>コマンドのコンテキスト</h2><p>Cypress.Commands.addを呼び出すところはすでに紹介しました。名前と実際に呼び出される関数以外に実行コンテキストのオプションがあります。</p><p>prevSubjectはcy.の直後に呼ばれるべきか、他のコマンドで絞り込んだあとに呼ぶのか、どちらを想定しているのかという指定です。trueなら他のコマンドの後限定、falseなら先頭限定、’optional’なら両方です。また、element/document/windowで、他のコマンドの結果としてもらえる要素を設定できます。</p><p><code>cy.get</code>は<code>&#123;prevSubject: false&#125;</code>, <code>cy.find</code>は<code>&#123;prevSubject: true&#125;</code>ですね。</p><figure class="highlight js"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(</span><br><span class="line">    <span class="string">&#x27;mycommand&#x27;</span>,</span><br><span class="line">    &#123; <span class="attr">prevSubject</span>: [<span class="string">&#x27;optional&#x27;</span>, <span class="string">&#x27;element&#x27;</span>, <span class="string">&#x27;document&#x27;</span>] &#125;,</span><br><span class="line">    mycommand</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="コンテキストの取得"><a href="#コンテキストの取得" class="headerlink" title="コンテキストの取得"></a>コンテキストの取得</h2><p>コマンドは次の形式をしています。前述のコンテキストの元になるのがsubjectです。selectorは1つの文字列です。追加のオプションはオブジェクトの形式で渡します。</p><figure class="highlight js"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mycommand</span>(<span class="params">subject, selector, options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>前の設定でprevSubjectに”element”を渡したり、trueを設定した場合はsubjectからコンテキストを取り出します。コマンドの関数の先頭でcontextNodeを初期化します。要素探索を実装する場合はこのcontextNodeの中から探すようにしていけばOKです。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// コンテキストの取得</span></span><br><span class="line"><span class="keyword">let</span> contextNode;</span><br><span class="line"><span class="keyword">let</span> withinSubject = cy.state(<span class="string">&#x27;withinSubject&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (Cypress.dom.isElement(subject)) &#123;</span><br><span class="line">    contextNode = subject[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Cypress.dom.isDocument(subject)) &#123;</span><br><span class="line">    contextNode = subject;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (withinSubject) &#123;</span><br><span class="line">    contextNode = withinSubject[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    contextNode = cy.state(<span class="string">&#x27;window&#x27;</span>).document;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>コンテキストに対応しない（常にグローバルからの取得）であればここは書かなくても良いです。</p><h2 id="要素の取得"><a href="#要素の取得" class="headerlink" title="要素の取得"></a>要素の取得</h2><p>実際の要素の取得の処理はjQueryを使います。cy.find()やcy.get()は非同期なリトライ付きの取得でしたが、プリミティブな同期的な要素の取得はjQueryです。jQueryは動的なウェブサイトの作成ではいろいろネガティブな話も出てきていますが、DOMを変化させない、要素の取得に限定すればまだまだ便利です。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> value = Cypress.$(<span class="string">&#x27;a, *[role=&quot;link&quot;]&#x27;</span>, contextNode);</span><br><span class="line"><span class="keyword">if</span> (selector) &#123;</span><br><span class="line">    value = value.filter(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> self = Cypress.$(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// aria-label属性で検索</span></span><br><span class="line">        <span class="keyword">if</span> (self.attr(<span class="string">&#x27;aria-label&#x27;</span>) === selector) &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// aria-labelledby属性で検索</span></span><br><span class="line">        <span class="keyword">const</span> labelledBy = self.attr(<span class="string">&#x27;aria-labelledby&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (labelledBy &amp;&amp; Cypress.$(<span class="string">`#<span class="subst">$&#123;labelledBy&#125;</span>`</span>).text() === selector) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// テキストを見て検索</span></span><br><span class="line">        <span class="keyword">if</span> (self.text().trim() === selector) &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 画像のalt属性を見て検索</span></span><br><span class="line">        <span class="keyword">const</span> images = self.find(<span class="string">`img[alt=&quot;<span class="subst">$&#123;selector&#125;</span>&quot;]`</span>);</span><br><span class="line">        <span class="keyword">return</span> images.length &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここでは、4パターンの検索を実行して返す実装になっています。一つのセレクターの一筆書きで書けないような複雑な検索処理が行えます。</p><p>上記のresolveValue()の中身は最終的にはこうなります。</p><figure class="highlight ts"><figcaption><span>resolveValue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// コンテキストの取得</span></span><br><span class="line"><span class="keyword">let</span> contextNode;</span><br><span class="line"><span class="keyword">let</span> withinSubject = cy.state(<span class="string">&#x27;withinSubject&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (Cypress.dom.isElement(subject)) &#123;</span><br><span class="line">    contextNode = subject[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Cypress.dom.isDocument(subject)) &#123;</span><br><span class="line">    contextNode = subject;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (withinSubject) &#123;</span><br><span class="line">    contextNode = withinSubject[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    contextNode = cy.state(<span class="string">&#x27;window&#x27;</span>).document;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jQueryを使って要素を取得</span></span><br><span class="line"><span class="keyword">let</span> value = Cypress.$(<span class="string">&#x27;a, *[role=&quot;link&quot;]&#x27;</span>, contextNode);</span><br><span class="line"><span class="keyword">if</span> (selector) &#123;</span><br><span class="line">    value = value.filter(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> self = Cypress.$(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// aria-label属性で検索</span></span><br><span class="line">        <span class="keyword">if</span> (self.attr(<span class="string">&#x27;aria-label&#x27;</span>) === selector) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// aria-labelledby属性で検索</span></span><br><span class="line">        <span class="keyword">const</span> labelledBy = self.attr(<span class="string">&#x27;aria-labelledby&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (labelledBy &amp;&amp; Cypress.$(<span class="string">`#<span class="subst">$&#123;labelledBy&#125;</span>`</span>).text() === selector) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// テキストを見て検索</span></span><br><span class="line">        <span class="keyword">if</span> (self.text().trim() === selector) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 画像のalt属性を見て検索</span></span><br><span class="line">        <span class="keyword">const</span> images = self.find(<span class="string">`img[alt=&quot;<span class="subst">$&#123;selector&#125;</span>&quot;]`</span>);</span><br><span class="line">        <span class="keyword">return</span> images.length &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cy.verifyUpcomingAssertions(value, options, &#123;</span><br><span class="line">    onRetry: resolveValue,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="ログ出力"><a href="#ログ出力" class="headerlink" title="ログ出力"></a>ログ出力</h2><p>最後ですが、必要に応じて探索中の情報のログを出しておくと、TestRunnerで問題追跡がしやすくなりますなぜ見つからなかったのか、途中経過はマッチしていたが、この情報でマッチしなくなったとか。宣言的な書き方は、失敗した時のフィードバックが弱いのでこの手のログを出してあげるのは良いと思います。</p><p>ログの出力はCypress.logで行います。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成功したらログを出す</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> resolveValue()</span><br><span class="line"><span class="keyword">if</span> (options.log !== <span class="literal">false</span>) &#123;</span><br><span class="line">    Cypress.log(&#123;</span><br><span class="line">        name: <span class="string">&#x27;aria&#x27;</span>,</span><br><span class="line">        message: selector,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Cypressの中身で、書きやすく効率の良いテストを実現する重要な要素であるリトライポリシーについて紹介し、そのリトライポリシーに従ったプラグインの書き方も紹介しました。</p><ul><li>逐次処理なら通常のAPIを列挙すればOK</li><li>取得のロジックはasyncな関数に納める</li><li>jQueryを使って要素を取得</li><li>cy.verifyUpcomingAssertions()にとってきた要素を渡して後段のアサーションを実行</li><li>cy.verifyUpcomingAssertions()にはこの関数自身をonRetryに渡す<br>リトライは繰り返し行われるが、ループを自分で書くのではなく、CypressのAPIにonRetryに渡すことで再起的にループが行われる</li><li>要素の探索する場所（コンテキスト）の処理をしたり、ログを出せば完璧</li></ul><h1 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h1><p>本記事は、<a href="https://future.connpass.com/event/208056/presentation/">Future Tech Night #8</a>というイベントでお話した内容を記事化したものです。<br>同イベントの他の発表も記事として投稿されてますので、ぜひご覧ください！</p><ul><li><a href="/articles/20210428a/">Cypress入門～初心者でも簡単にE2Eテストが作れる～</a></li><li><a href="/articles/20210428b/">Cypress - 設定編</a></li><li><a href="/articles/20210428c/">保守・拡張をしやすいカプセル化したCypress</a></li><li>Cypress - 書きやすいテストの秘密と独自コマンドの実装（この記事です）</li></ul><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20210226/index.html" data-iframely-url="//cdn.iframe.ly/ZMlnZ2M?iframe=card-small"></a></div></div><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20200115/index.html" data-iframely-url="//cdn.iframe.ly/uGST3JI?iframe=card-small"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;@testing-library/cypressの存在を知らずに、それっぽいものを作ろうとしたときにいろいろ調査した記録です。Cypressにはテストコードが縦と横に短くなる工夫がされており、そのメカニズムにしたがった独自コマンドを実装するにはコツが必要です。&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Cypress" scheme="https://future-architect.github.io/tags/Cypress/"/>
    
    <category term="E2Eテスト" scheme="https://future-architect.github.io/tags/E2E%E3%83%86%E3%82%B9%E3%83%88/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
  </entry>
  
  <entry>
    <title>保守・拡張をしやすいカプセル化したCypress</title>
    <link href="https://future-architect.github.io/articles/20210428c/"/>
    <id>https://future-architect.github.io/articles/20210428c/</id>
    <published>2021-04-27T15:00:03.000Z</published>
    <updated>2021-05-12T13:36:49.258Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一行まとめ"><a href="#一行まとめ" class="headerlink" title="一行まとめ"></a>一行まとめ</h1><p>壊れやすい上に読みにくくなりがちなE2Eテストは、cypressのCustom Commandsなどでカプセル化すると読みやすくなおしやすい。</p><h1 id="CypressでE2Eテスト"><a href="#CypressでE2Eテスト" class="headerlink" title="CypressでE2Eテスト"></a>CypressでE2Eテスト</h1><p><a href="https://future.connpass.com/event/208056/presentation/">Future Tech Night #8</a> というイベントで、E2EテストをCypressで快適に行う方法を紹介しました。文字起こし兼補足として投稿します。</p><p>同イベントの他の発表も記事として投稿されてますので、こちらもご覧いただければ。</p><ul><li><a href="/articles/20210428a/">Cypress入門～初心者でも簡単にE2Eテストが作れる～</a></li><li><a href="/articles/20210428b/">Cypress - 設定編</a></li><li>保守・拡張をしやすいカプセル化したCypress(この記事)</li><li><a href="/articles/20210428d/">Cypress - 書きやすいテストの秘密と独自コマンドの実装</a></li></ul><h1 id="E2Eテストは壊れやすい"><a href="#E2Eテストは壊れやすい" class="headerlink" title="E2Eテストは壊れやすい"></a>E2Eテストは壊れやすい</h1><p>まずはE2Eテストとユニットテストを比較して、それぞれの特長をみてみましょう。</p><p>ユニットテストは基本的に開発するときに部品単位でつくられて、リポジトリにpushする前にサクッと動かしてテスト通るか確認する、という使い方をします。</p><p>対して、E2Eテストは画面単位でつくられて、ユーザの視点から画面を叩いて動くかどうかを検証するという使い方をします。つまり、ユーザの視点から見て、あからさまにおかしいなと感じるバグが見つかりやすい。結果としてクレームや問い合わせが減りやすくなります。</p><p><img src="/images/20210428c/Slide_-_6.png"></p><p>しかしながら、E2Eテストは壊れやすいのも特徴。</p><p>ユニットテストと比べてカバーする範囲が大きくなるので、どこかに変更があるとすぐ動かなくなってしまいます。例えば日本語の説明文に変更があったとかinputのnameが変わったとか、ちょっとしたことですぐ動かなくなってしまいます。</p><p>そして、画面の要素をidとかclassとかのセレクタで指定するため、どのセレクタがどのボタンを押してるのか追っていく必要があり、後から見たときに直しにくいのも難点。そのため、E2Eテストをつくるときは壊れることを前提に作っていくことが大事になってきます。特アジャイル的な開発をしているなら、機能追加の度にどこか動かなくなるという気持ちでいきましょう。</p><h1 id="壊れたときに直しやすいように可読性をあげる"><a href="#壊れたときに直しやすいように可読性をあげる" class="headerlink" title="壊れたときに直しやすいように可読性をあげる"></a>壊れたときに直しやすいように可読性をあげる</h1><p>頻繁に壊れるということはコードを読み返すことも多くなるということ。壊れても直しやすいようにテストコードの可読性を上げていくことがメンテナンスを続けていくために大事になっていきます。</p><p>具体的な例としてToDoアプリを考えてみましょう。<br>Webアプリのチュートリアルによく出てくる、ToDoの追加と削除ができるページに対して Cypressでテストを行ってみます。<br><img src="/images/20210428c/image_10.png"></p><p>このToDoアプリに対して追加と削除が正常に動作しているか確認するE2Eテストを書いていきましょう。「Todo1」「Todo2」「Todo3」を追加して、2つ目を削除、残ってるTodoを確認する、というテストをCypressで実現すると以下のようになります。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;add 3 todo and delete middle todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// todo1を追加</span></span><br><span class="line">   cy.get(<span class="string">&#x27;#new-todo&#x27;</span>)</span><br><span class="line">     .type(<span class="string">&#x27;todo1&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;todo1&#x27;</span>)</span><br><span class="line">     .type(<span class="string">&#x27;&#123;enter&#125;&#x27;</span>, &#123; <span class="attr">delay</span>: <span class="number">100</span> &#125;);</span><br><span class="line">   cy.get(<span class="string">&#x27;#new-todo&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo1&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// todo2を追加</span></span><br><span class="line">   cy.get(<span class="string">&#x27;#new-todo&#x27;</span>)</span><br><span class="line">     .type(<span class="string">&#x27;todo2&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;todo2&#x27;</span>)</span><br><span class="line">     .type(<span class="string">&#x27;&#123;enter&#125;&#x27;</span>, &#123; <span class="attr">delay</span>: <span class="number">100</span> &#125;);</span><br><span class="line">   cy.get(<span class="string">&#x27;#new-todo&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo2&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// todo3を追加</span></span><br><span class="line">   cy.get(<span class="string">&#x27;#new-todo&#x27;</span>)</span><br><span class="line">     .type(<span class="string">&#x27;todo3&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;todo3&#x27;</span>)</span><br><span class="line">     .type(<span class="string">&#x27;&#123;enter&#125;&#x27;</span>, &#123; <span class="attr">delay</span>: <span class="number">100</span> &#125;);</span><br><span class="line">   cy.get(<span class="string">&#x27;#new-todo&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo3&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2つ目を削除</span></span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item:nth(1)&#x27;</span>).contains(<span class="string">&#x27;DEL&#x27;</span>).click();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 残アイテムの確認</span></span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo1&#x27;</span>);</span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo2&#x27;</span>).should(<span class="string">&#x27;not.exist&#x27;</span>);</span><br><span class="line">   cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo3&#x27;</span>);</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure><p>Cypressを使ったことない、という方でも上のコードが何をしているかがなんとなくはわかってもらえるかなと。それくたいCypressの学習コストは低め。jQueryやCSSなどをかじっていてDOM要素を指定する知識があれば、Webアプリのベテランでなくてもすぐに書けるかなと思っています。</p><p>しかしながら、DOM要素を指定するためにセレクタを書いていくと、段々と読みにくいコードになっていきます。</p><p>例えば、動的に追加された要素やインポートした外部ライブラリのDOM要素を指定する際に、<code>nth</code> や <code>&gt;</code> などで掘っていって指定する複雑なセレクタが書かれがちになります。そうすると後で見返したときに、どこをどう直せばテストが通るようになるのか判断するために画面のDOMと見比べて追っていく必要が出てきます。</p><p>後で見返したときにわかりやすいように、テストコードの可読性をあげていきたい。</p><p>もちろん、コメントで 「ToDoを追加する」「ToDoを削除する」と書いて 分割してまとめておくのも見やすくする一つの案なのですが、Cypressの場合、Custom Commandsを使うと、分割して見やすくしたコードをカプセル化し、より読みやすいコードに仕立て上げることができます。</p><h1 id="Custom-Commands"><a href="#Custom-Commands" class="headerlink" title="Custom Commands"></a>Custom Commands</h1><p>Custom Commands、名前の通り自分でコマンドをつくれるという機能です。<br><a href="https://docs.cypress.io/api/cypress-api/custom-commands">https://docs.cypress.io/api/cypress-api/custom-commands</a></p><p>自分の欲しいコマンドを cy.containsやcy.getといったCypressに用意されているコマンドと同じように作ることができます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(name, callbackFn)</span><br></pre></td></tr></table></figure><p>このCustom Commandsで上記のTodoアプリのテストを整理してみましょう。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;add 3 todo and delete middle todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// todo1を追加</span></span><br><span class="line">  cy.addTodo(<span class="string">&#x27;todo1&#x27;</span>);</span><br><span class="line">  <span class="comment">// todo2を追加</span></span><br><span class="line">  cy.addTodo(<span class="string">&#x27;todo2&#x27;</span>);</span><br><span class="line">  <span class="comment">// todo3を追加</span></span><br><span class="line">  cy.addTodo(<span class="string">&#x27;todo3&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2つ目を削除</span></span><br><span class="line">  cy.deleteTodo(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 残アイテムの確認</span></span><br><span class="line">  cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo1&#x27;</span>);</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo2&#x27;</span>).should(<span class="string">&#x27;not.exist&#x27;</span>);</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(<span class="string">&#x27;todo3&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>「ToDoを追加する」「ToDoを削除する」とコメントした箇所をまとめてカスタムコマンドにしました。<br>後から見返しやすいコードになりましたね。</p><p>cy.addTodoとcy.deleteTodoの実態は以下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./cypress/support/commands.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TODOの追加 cy.addTodo(&#x27;todo1&#x27;);</span></span><br><span class="line">Cypress.Commands.add(<span class="string">&#x27;addTodo&#x27;</span>, <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">  cy.get(<span class="string">&#x27;#new-todo&#x27;</span>)</span><br><span class="line">    .type(value).should(<span class="string">&#x27;have.value&#x27;</span>, value)</span><br><span class="line">    .type(<span class="string">&#x27;&#123;enter&#125;&#x27;</span>, &#123; <span class="attr">delay</span>: <span class="number">100</span> &#125;);</span><br><span class="line">  cy.get(<span class="string">&#x27;#new-todo&#x27;</span>).should(<span class="string">&#x27;have.value&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo-item&#x27;</span>).contains(value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODOの削除 cy.deleteTodo(0);</span></span><br><span class="line">Cypress.Commands.add(<span class="string">&#x27;deleteTodo&#x27;</span>, <span class="function">(<span class="params">nth</span>) =&gt;</span> &#123;</span><br><span class="line">  cy.get(<span class="string">`.todo-item:nth(<span class="subst">$&#123;nth&#125;</span>)`</span>).contains(<span class="string">&#x27;DEL&#x27;</span>).click();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>addTodoは共通部分をまとめたのですっきり書けるようになったパターン、deleteTodoは <code>todo-item:nth</code> という画面のDOMを追っていかないと何してるか理解しにくい部分にCustom Commandsとして名前をつけてあげることで後から読み返しやすくなるというパターンです。</p><p>ひとつCustom Commandsをつくるといろんな場所で似たような操作を簡単に書けるようになります。</p><p>お気づきの通り、このCustom CommandsはReactやVueといったコンポーネント指向のライブラリと相性抜群。</p><p>書くのも簡単になり、読むときも理解しやすい。同じ処理が別のspecファイルにあるというときもコピペせずに済む。そして、コンポーネントに変更があった場合もCustom Commandsだけ修正すればOK、という場面が増えます。</p><h1 id="デメリット"><a href="#デメリット" class="headerlink" title="デメリット"></a>デメリット</h1><p>もちろんデメリットもあります。</p><p>テストケースの書き方が不味く「ToDoを追加する」という段階でinputがdisabledでTodoが追加できなかった、といったエラーが出た場合、specファイルの中ではなく、カスタムコマンドを定義しているファイルの該当部分を出します。そのため、どのaddTodoでエラーが起きたのかわかりづらい、呼び出し元がわかりにくいということがときたまあります。</p><p>そういった場合は引数をユニークなものにしておくと一旦の解決策になります。おなじTodoを3つ作成するのではなく、「todo1」・「todo2」・「todo3」としておくと、どのtodoを作成するタイミングでエラーが起きたのかが把握しやすくなります。</p><p>また、Custom Commandsの数が増えてきた際に名前の衝突が起きる可能性が高まります。こちらはある程度の命名規則があれば回避できるかなと思っています。以前登録したCustom Commandsが見つけやすいように <code>cypress\support\commands.js</code> を分割するのも手です。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>E2Eテストは壊れやすい上に読みにくくなりがちなので、CypressのCustom Commandsを上手く利用して、書きやすく読みやすく直しやすいテストコードにしていきましょう。</p><p>とはいえ、Cypressをまだ触ったことないよという方は、ここまで考えずまずは使ってみてください。containsとclickだけ覚えればそこそこのテストが書けます。</p><p>Cypressをしばらく使ってテストコード見返すのが辛くなり始めたら、Custom Commandsで一連の流れを固めてカプセル化するなどして、後から見返しやすいコードにできないか検討してみてください。</p><p>続いて、 <a href="/articles/20210428d/">Cypress - 書きやすいテストの秘密と独自コマンドの実装</a> 記事を参照ください。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20210226/index.html" data-iframely-url="//cdn.iframe.ly/ZMlnZ2M?iframe=card-small"></a></div></div><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20200115/index.html" data-iframely-url="//cdn.iframe.ly/uGST3JI?iframe=card-small"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一行まとめ&quot;&gt;&lt;a href=&quot;#一行まとめ&quot; class=&quot;headerlink&quot; title=&quot;一行まとめ&quot;&gt;&lt;/a&gt;一行まとめ&lt;/h1&gt;&lt;p&gt;壊れやすい上に読みにくくなりがちなE2Eテストは、cypressのCustom Commandsなどでカプセル化する</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Cypress" scheme="https://future-architect.github.io/tags/Cypress/"/>
    
    <category term="E2Eテスト" scheme="https://future-architect.github.io/tags/E2E%E3%83%86%E3%82%B9%E3%83%88/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
  </entry>
  
  <entry>
    <title>Cypress - 設定編</title>
    <link href="https://future-architect.github.io/articles/20210428b/"/>
    <id>https://future-architect.github.io/articles/20210428b/</id>
    <published>2021-04-27T15:00:02.000Z</published>
    <updated>2021-05-12T01:25:17.013Z</updated>
    
    <content type="html"><![CDATA[<p>Cypressの設定周りについて紹介します。</p><p>何も手を加えないデフォルトでも動作します。</p><h1 id="Cypressの設定"><a href="#Cypressの設定" class="headerlink" title="Cypressの設定"></a>Cypressの設定</h1><h2 id="フォルダ構成とTypeScript化"><a href="#フォルダ構成とTypeScript化" class="headerlink" title="フォルダ構成とTypeScript化"></a>フォルダ構成とTypeScript化</h2><p>まず、Cypressのデフォルトのフォルダ構成がこちらです。何も指定しないと、プロジェクトルートにcypressフォルダがあって、その中に関連ファイル（テストケース、プラグインなど）が置かれるのが基本パターンです。</p><figure class="highlight text"><figcaption><span>Cypressのフォルダ構成</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cypress</span><br><span class="line">├── fixtures</span><br><span class="line">│   └── users.json</span><br><span class="line">├── integration</span><br><span class="line">│   ├── textbox.html</span><br><span class="line">│   └── textbox.spec.js</span><br><span class="line">├── plugins</span><br><span class="line">│   └── index.js</span><br><span class="line">├── screenshots</span><br><span class="line">├── support</span><br><span class="line">│   ├── commands.js</span><br><span class="line">│   └── index.js</span><br><span class="line">└── videos</span><br></pre></td></tr></table></figure><p>Cypressは<code>npm install cypress</code>で必要なツールをまとめてインストールできます。</p><p>初回実行時にこの<code>cypress</code>フォルダと<code>cypress.json</code>が作られます。設定やテスト、ヘルパー関数などはこの雛形の中に書いていきます。</p><p>デフォルトで生成される設定ファイルはJavaScriptのコードですが、TypeScript化にも対応しています。TS化したいときは次のことを行います。</p><ul><li><code>npm i -D typescript @types/node</code></li><li><code>tsconfig.json</code>を作成</li></ul><p><code>tsconfig.json</code>は通常、プロジェクトのルートの<code>package.json</code>があるフォルダに置きますが、プロジェクトの<code>tsconfig.json</code>とは別にこのフォルダ内にCypress専用<code>tsconfig.json</code>を置くこともできます。</p><p>あとはこのフォルダ内部の<code>.js</code>を<code>.ts</code>に置換していけば型が書けます。</p><p>↓細かいところはこちらを参照してください。</p><p><a href="https://github.com/cypress-io/cypress-example-recipes/tree/master/examples/fundamentals__typescript">https://github.com/cypress-io/cypress-example-recipes/tree/master/examples/fundamentals__typescript</a></p><p>今時はみんなTypeScript使うでしょうし、この説明では全部TS化する前提で話を進めます。といってもJSのまま使うにはデフォルトのままで大丈夫なので、特に考慮することなくこのエントリーの説明を読み進めていけます。</p><h2 id="テストのカスタマイズポイント"><a href="#テストのカスタマイズポイント" class="headerlink" title="テストのカスタマイズポイント"></a>テストのカスタマイズポイント</h2><p>テスト時の動作のカスタマイズ項目は次のページに書かれています。動画の自動のキャプチャ機能や失敗時のスクリーンショット機能をオフにしたり、テストランナーでの実行時にテストファイルの変更を監視して自動テストを行う（watch）機能を無効にしたり、フォルダ位置を変えたりといったことが変更可能です。</p><p><a href="https://docs.cypress.io/guides/references/configuration">https://docs.cypress.io/guides/references/configuration</a></p><p>基本的に5種類のカスタマイズ方法があります。</p><ul><li>ルートのcypress.json</li><li>cypress.env.json</li><li>環境変数</li><li>CLIのオプション</li><li>cypress/plugins/index.ts</li></ul><p>現在のテストが読み込んでいる設定が、どの項目から読み込まれたのかはテストランナーのSettingsメニューで確認できます。</p><p><img src="/images/20210428b/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-04-07_23.44.00.png"></p><p><code>env</code>の項目で設定した値は、テストコード中からアクセスできるため、テストのパラメータを外部から変更できるようにすることもできます。</p><h2 id="フォルダ構成の詳細"><a href="#フォルダ構成の詳細" class="headerlink" title="フォルダ構成の詳細"></a>フォルダ構成の詳細</h2><p>最初にデフォルトのフォルダ構成を紹介しました。それぞれのフォルダの役割は次の通りです。</p><ul><li>fixtures: テスト中で使いたいデータファイル置き場</li><li>integration: テストコード置き場</li><li>plugins: プラグインの登録や設定の変更</li><li>support: ちょっとしたコマンド追加など</li><li>videos: 実行中に記録された動画ファイル置き場</li><li>screenshots: 実行中に記録されたスクリーンショット置き場</li></ul><p>これらのフォルダは<code>cypress.json</code>でフォルダの位置を変えたりできます。また、最初に呼び出される設定ファイル（基本は<code>cypress/plugins/index.js</code>、このパスも変更できる)でフォルダ構成の変更もできます。</p><p>詳しくは設定の説明を読むと良いでしょう。</p><p><a href="https://docs.cypress.io/guides/references/configuration">https://docs.cypress.io/guides/references/configuration</a></p><h2 id="cypress-support-index-ts"><a href="#cypress-support-index-ts" class="headerlink" title="cypress/support/index.ts"></a>cypress/support/index.ts</h2><p>npm installしたプラグインのうち、ただコマンドを足すだけのシンプルなものを登録したり、自作のコマンドの登録をしたりする設定置き場です。コマンドはcommands.tsに書いて、このファイルにはimport文を書いて参照する方法が一般的なようです（という構成の設定がデフォルトで作られる）。</p><figure class="highlight ts"><figcaption><span>cypress/support/index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@testing-library/cypress/add-commands&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@cypress/code-coverage/support&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./commands&quot;</span></span><br></pre></td></tr></table></figure><p>コマンドの作り方は後述します</p><h2 id="cypress-plugins-index-ts"><a href="#cypress-plugins-index-ts" class="headerlink" title="cypress/plugins/index.ts"></a>cypress/plugins/index.ts</h2><p>Cypress内部のイベントを受け取る必要のあるプラグインの初期化や、設定の上書きなどを行います。</p><figure class="highlight ts"><figcaption><span>cypress/plugins/index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = (</span><br><span class="line">        on: Cypress.PluginEvents,</span><br><span class="line">        config: Cypress.PluginConfigOptions</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;@cypress/code-coverage/task&quot;</span>)(on, config)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...config,</span><br><span class="line">        integrationFolder: <span class="string">&quot;cypress/specs&quot;</span>,</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>最低限のcypress.jsonは空でもいいのですが、baseUrlだけ設定しておくと、cy.visit()とかcy.request()のパスにprefixとしてつくので、テストコードがポートやホスト名にハードコードされなくなります。ちょっと変更に強くなります。ローカルと、リモートのテストの両方で使う場合はbaseUrlを外から変えればいけるようになるので、基本的には設定しておくべきでしょう。npm run serveなどで起動するテストサーバーや、go runで起動するサーバーに向けておきます。</p><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;baseUrl&quot;</span>: <span class="string">&quot;http://localhost:3000&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vue-cliで自動生成すると、ちょっと違うフォルダに入ります。また、vue-cliで実行した場合は、npm run serveして、そのURLをcypressに渡すところまでやってくれるので便利です。</p><p>Cypressの設定は画面からみれます。どこで設定された値なのかが一目瞭然ですごく親切。</p><p>Cypressが起動時に読み込むファイルは次の通り</p><ol><li>cypress.jsonでフォルダの場所などを読み取り</li><li>pluginとsupportの読み込み(設定なければcypress/plugins/index.jsとcypress/support/index.jsなど)</li><li>テストケースの読み込み(設定なければcypress/integrations)</li><li>openモードでなければそのままテストを実行、openモードの場合はIDEを起動</li></ol><p>pluginsというフォルダ名ではあるものの、設定を変えたりします。次のサンプルはコードカバレッジを有効化しつつ、テストの置き場のフォルダを変更しています。WebPackの設定を変更したりするのはこちらです。</p><figure class="highlight ts"><figcaption><span>cypress/plugins/index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">on: Cypress.PluginEvents, config: Cypress.PluginConfigOptions</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;@cypress/code-coverage/task&quot;</span>)(on, config)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...config,</span><br><span class="line">        integrationFolder: <span class="string">&quot;cypress/specs&quot;</span>,</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>これら以外にも、環境変数で値を渡したり、コマンドライン引数で値を設定したりといった機能があります。</p><h2 id="Vue-js以外の実行の流れ"><a href="#Vue-js以外の実行の流れ" class="headerlink" title="Vue.js以外の実行の流れ"></a>Vue.js以外の実行の流れ</h2><p>基本的な流れは次の通りです。</p><ol><li>E2Eテスト対象のサーバーを起動します<br>ウェブサーバーやフロントエンドの開発サーバーが該当します。静的HTMLならホスティングもCypressだけでできます。4/6にリリースされた7.0ではStorybook的にReact/Vueコンポーネントのテストが<br>直接書ける</li><li><code>cypress run</code>でヘッドレス実行、あるいは、<code>cypress open</code>でGUI Test Runnerを起動してテストします。<br>cypress runでヘッドレス実行、あるいは、cypress openでGUI Test Runnerを起動してテストします。テストの中でcy.visit(“接続先URL”)で1で起動したテスト対象のページにアクセスします。cypress.jsonなどでbaseUrlを指定すれば、ここからの相対パスで次のようにテストをシンプルにできます。また、ローカル、stg環境など複数の環境でテストを再利用したい場合に便利です。</li></ol><ul><li><code>cy.visit(“http://localhost:3000/”)</code> # 愚直に書く</li><li><code>cy.visit(“/”)</code>                      # baseUrlからの相対パス</li></ul><figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;baseUrl&quot;</span>: <span class="string">&quot;http://localhost:3000&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Vue-jsの実行の流れ"><a href="#Vue-jsの実行の流れ" class="headerlink" title="Vue.jsの実行の流れ"></a>Vue.jsの実行の流れ</h2><p>CypressをVue.jsのプロジェクトに導入するのは簡単です。</p><p>インストール時にE2Eを選択し、その後の選択でCypressを選択するとインストールされます。また、作成済みのプロジェクトであれば<code>vue add e2e-cypress</code>を実行すれば追加できます。</p><p>Vueの場合、テストはすべてtest/e2e以下に格納するようになっています。</p><p>実行すると開発サーバー実行と、それをbaseUrlに設定して起動するところまでvue-cli-serviceがやってくれます。</p><h2 id="CypressとJest"><a href="#CypressとJest" class="headerlink" title="CypressとJest"></a>CypressとJest</h2><p>Cypressはmocha + chaiベースでテストを書きます。ユニットテストで現在一番人気はJestですが、Jestとmocha, chaiでキーワードがいろいろ衝突します。特にchaiとJestのexpectが大きいです。全然違うなら問題ないのですが、似ているようで微妙にメソッドが違ったりと、微妙な差のため、「こちらは動くのに、こちらは全然動かない」という微妙な落とし穴位になりがちです。</p><p>公式サイトで紹介されている方法はプロジェクトのルートのtsconfig.jsonと、cypress/tsconfig.jsonを使い分けて回避する方法です。まずルートの方のプロジェクトですが、プロジェクトに必要な設定と、型に”jest”を入れておきます。また、<code>include</code>でCypress以外の設定も入れておきましょう。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">&#x27;@jest/globals&#x27;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight json"><figcaption><span>/tsconfig.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;commonjs&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;lib&quot;</span>: [<span class="string">&quot;ES2015&quot;</span>, <span class="string">&quot;DOM&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;types&quot;</span>: [<span class="string">&quot;jest&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;noEmit&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;include&quot;</span>: [<span class="string">&quot;src/*.ts&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span>: [<span class="string">&quot;src/*.test.ts&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>こちらはCypress側の設定です。<code>extends</code>で親フォルダの設定を読み込み、必要な箇所だけ追加します。ここではtypesに<code>cypress</code>を足しています。これで”jest”との衝突を防げます。</p><figure class="highlight json"><figcaption><span>/cypress/tsconfig.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;extends&quot;</span>: <span class="string">&quot;../tsconfig.json&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;noEmit&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;types&quot;</span>: [<span class="string">&quot;cypress&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;include&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;../node_modules/cypress&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./**/*.ts&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CypressのMochaはGUIのテストにしか使ってはいけないわけではなく、単純なユニットテストに使っても良いといえば良いのですが、動画撮影機能とか失敗時のスクリーンショット機能のせいでシンプルなテストほどオーバーヘッドが大きい（全部オフにすれば普通になりますが）ですし、ふたつ使い分ける方が良いでしょう。</p><p>手元の環境ではJestとCypressのカバレッジを統合するのがうまくいかず、いっそのことCypressに寄せる、というのも考えたりはしたのですが、Node.js（というかElectron）の機能を使ったテストが実行できないなど、欠点もあって、それが受容できるかどうか次第ですね。</p><p>簡単に済ませるのであれば、<code>expect()</code>のmatcherの挙動が違うだけなので、cypressとjestを両方tsconfig.jsonに入れてしまって、明示的にimportしてあげれば2つ作らなくても対応可能です。仕事のプロジェクトではこれを書くようにしちゃっています。</p><h1 id="コマンドの作り方"><a href="#コマンドの作り方" class="headerlink" title="コマンドの作り方"></a>コマンドの作り方</h1><p>テストコードを書いていると、同じような命令が繰り返し登場することがあります。例えば、ログインを毎回行っている、特定のページに遷移する、データの登録を行ってデータがある前提のテストに備えるなどなど。</p><p>テストはなるべく構造化しないで、愚直に書いた方が良いことの方が多いのですが、準備コードが長くなりすぎるのもフォーカスがぼやけてしまってよくないです。その場合にテストコードを短くして見通しを改善する方法は主に2つあります。</p><ul><li>同一のファイルのテスト間ではbeforeEach()を使って実装をまとめる</li><li>ファイルを跨いだり、横断的に使う場合はカスタムコマンドを作成する</li></ul><p>ここでは後者の方法について軽く紹介します。ただし、短くしすぎて見にくくならないようにすることが大事です。テストコードの読解のためにたくさんの関数の中身を調べないといけない、というのはよくないテストコードです。多少冗長でも読みやすくて意味が把握しやすければ問題ありません。またこの独自コマンドを活用する方法はびろうさんが詳しく紹介してくれます。また、たんなる公開APIの列挙ではない、よりCypressの内部に突っ込んだ独自コマンドの実装方法も別のエントリーで紹介します。</p><p>追加コマンドの定義箇所はsupportフォルダ以下です。</p><p>npmインストールした追加のコマンドを増やすのは<code>support/index.ts</code>に書きます。プロジェクトで作成するコマンドはここから読み込まれる<code>command.ts</code>に入れておきます。</p><figure class="highlight ts"><figcaption><span>cypress/support/index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@testing-library/cypress/add-commands&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@cypress/code-coverage/support&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./commands&quot;</span></span><br></pre></td></tr></table></figure><p>コマンドはログインだったり、一連の動作を連続実行するのに便利な仕組みです。中ではcypressのテストを書くための一般的なAPIを呼び出します。次のコマンドはログインを一発で行うコマンドを追加した例です。</p><figure class="highlight ts"><figcaption><span>cypress/support/commands.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(<span class="string">&quot;login&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&quot;/&quot;</span>, &#123; <span class="attr">timeout</span>: <span class="number">10000</span> &#125;);</span><br><span class="line">  cy.url().should(<span class="string">&quot;match&quot;</span>, <span class="regexp">/auth/</span>);</span><br><span class="line">  cy.get(<span class="string">&quot;#user&quot;</span>).type(<span class="string">&quot;testuser1&quot;</span>);</span><br><span class="line">  cy.get(<span class="string">&quot;#passwd&quot;</span>).type(<span class="string">&quot;testuser1-password&quot;</span>);</span><br><span class="line">  cy.get(<span class="string">&quot;#login&quot;</span>).click();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>追加したコマンドは、cyオブジェクトの追加メソッドのように見えます。このままではTypeScriptから識別されず、TypeScriptのコンパイルでエラーになってしまいますし、コード補完もできませんので、型定義ファイルを用意します。</p><figure class="highlight ts"><figcaption><span>cypress/support/index.d.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">namespace</span> Cypress &#123;</span><br><span class="line">  <span class="keyword">interface</span> Chainable &#123;</span><br><span class="line">    login();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Cypressの設定周りの構造と初期化周りの挙動と、コマンドの登録について簡単に紹介しました。</p><h1 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h1><p>本記事は、<a href="https://future.connpass.com/event/208056/presentation/">Future Tech Night #8</a>というイベントでお話した内容を記事化したものです。<br>同イベントの他の発表も記事として投稿されてますので、ぜひご覧ください！</p><ol><li><a href="/articles/20210428a/">Cypress入門～初心者でも簡単にE2Eテストが作れる～</a></li><li>Cypress - 設定編（この記事です）</li><li><a href="/articles/20210428c/">保守・拡張をしやすいカプセル化したCypress</a></li><li><a href="/articles/20210428d/">Cypress - 書きやすいテストの秘密と独自コマンドの実装</a></li></ol><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20210226/index.html" data-iframely-url="//cdn.iframe.ly/ZMlnZ2M?iframe=card-small"></a></div></div><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20200115/index.html" data-iframely-url="//cdn.iframe.ly/uGST3JI?iframe=card-small"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Cypressの設定周りについて紹介します。&lt;/p&gt;
&lt;p&gt;何も手を加えないデフォルトでも動作します。&lt;/p&gt;
&lt;h1 id=&quot;Cypressの設定&quot;&gt;&lt;a href=&quot;#Cypressの設定&quot; class=&quot;headerlink&quot; title=&quot;Cypressの設定&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Cypress" scheme="https://future-architect.github.io/tags/Cypress/"/>
    
    <category term="E2Eテスト" scheme="https://future-architect.github.io/tags/E2E%E3%83%86%E3%82%B9%E3%83%88/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
  </entry>
  
  <entry>
    <title>Cypress入門～初心者でも簡単にE2Eテストが作れる～</title>
    <link href="https://future-architect.github.io/articles/20210428a/"/>
    <id>https://future-architect.github.io/articles/20210428a/</id>
    <published>2021-04-27T15:00:01.000Z</published>
    <updated>2021-05-12T13:36:57.994Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。踊るエンジニア、木戸俊輔です。</p><p>2021年4月で社会人2年目になりましたが、総出社回数は3回です。コロナで外出できないのは残念ですが、自宅で安全に業務に取り組むことができる現代の環境には感謝ですね。</p><p>さて、皆さんは普段どのようにE2Eテストを行っていますか？忍耐強く手動でポチポチ画面を触って…というのはなかなかにしんどいですよね。自動化ツールを使って楽したいけど難しくてよくわからない、という方もいらっしゃると思います。</p><p>本記事では、テスト自動化ツールを全く使ったことのなかった私が、テスト自動化ツールである<a href="https://www.cypress.io/">Cypress</a>の導入から基本的な使い方までをご紹介していきます。</p><p>対象：</p><ul><li>Webサービスのテスト自動化に興味がある人</li><li>自動テスト初心者</li><li>Cypressを触ってみたい人</li></ul><h2 id="テストは大事"><a href="#テストは大事" class="headerlink" title="テストは大事"></a>テストは大事</h2><p>当たり前ですが、システムを納品/リリースする際、動作や性能のテストは必須です。もしテストが不十分だと、バグや想定外の挙動が発生し、</p><ul><li>システム納品先からの信頼消失</li><li>再開発のためにコスト増加</li><li>サービスの廃止</li></ul><p>などなど、恐ろしい事態に繋がる可能性があります。</p><h2 id="E2Eテストとは"><a href="#E2Eテストとは" class="headerlink" title="E2Eテストとは"></a>E2Eテストとは</h2><p>E2Eテストとは、「End To Endテスト」の略であり、ユーザが利用するのと同じようにシステム全体をテストします。</p><p>抜け漏れなくテストする必要があるため、かかる労力は膨大です。また、テスト者の未成熟などによりテストが正しく行われない可能性もあります。</p><p>Cypressを用いて自動化することで、コスト削減＆品質向上を狙います。</p><h1 id="Cypressとは"><a href="#Cypressとは" class="headerlink" title="Cypressとは"></a>Cypressとは</h1><p><a href="https://www.cypress.io/">Cypress</a>とはWebテスト用に構築されたJava Scriptライブラリです。</p><p><img src="/images/20210428a/image.png"></p><p>特徴として、以下のができます。</p><ul><li>単体テストからE2Eテストまで広く使える</li><li>テスト構築、実行、バグ検知まで全て行える</li><li>コマンドごとに画面のスナップショットを見返せる</li><li>テスト一連の様子をビデオとして保存できる</li><li>各種CIとの連携が可能である</li></ul><h2 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h2><p>Cypressによるテストを構築したいディレクトリ下で、以下のコマンドを実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cypress</span><br></pre></td></tr></table></figure><p>これだけです。5~10分くらいで簡単にインストールできます。<br>（Java Scriptライブラリなので、node.jsはいれておいてください。）</p><h2 id="実行してみよう"><a href="#実行してみよう" class="headerlink" title="実行してみよう"></a>実行してみよう</h2><p>とりあえず実行してみましょう。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx cypress open</span><br></pre></td></tr></table></figure><p>を実行すると、Cypressの管理画面が開きます。また、インストールしてから1回目の実行時には、いくつかのサンプルテストを生成してくれます。</p><p><img src="/images/20210428a/image_2.png"></p><p>管理画面ではspecファイルごとにテストが並んでおり、実行したいファイルをクリックすると、記述されたテストが自動で実行されていきます。</p><p>試しに、サンプルテストの1つ、<code>actions.spec.js</code>を実行してみましょう。</p><p><img src="/images/20210428a/image_3.png"></p><p>画面右側で、Cypressが実際にどのようなWeb上操作を行っているかが確認できます。また、画面左側では、記述したテストの進行状況やチェック項目の可否が表示されています。失敗したテストがあれば、該当箇所をアラートで教えてくれます。</p><h2 id="Cypressの基本的な使い方"><a href="#Cypressの基本的な使い方" class="headerlink" title="Cypressの基本的な使い方"></a>Cypressの基本的な使い方</h2><p>Cypressではspecファイルにテストを記述していきます。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">&#x27;カテゴリ名&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  it(<span class="string">&#x27;シナリオ名1&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    Cypressコマンドによる処理入力</span><br><span class="line">             ┋</span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;シナリオ名2&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    Cypressコマンドによる処理入力</span><br><span class="line">             ┋</span><br><span class="line">  &#125;)</span><br><span class="line">             ┋</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>CypressではWeb上でのアクションに相当する様々なコマンドが用意されています。</p><p>ここでは、よく使う基本的なコマンドをいくつか紹介します。</p><h3 id="Webサイトを訪れる"><a href="#Webサイトを訪れる" class="headerlink" title="Webサイトを訪れる"></a>Webサイトを訪れる</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.visit(<span class="string">&#x27;URL&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="DOMを取得する"><a href="#DOMを取得する" class="headerlink" title="DOMを取得する"></a>DOMを取得する</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">&#x27;DOMのタグ&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cy.contains(<span class="string">&#x27;探したい文字列&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>get()</code>と<code>contains()</code>どちらを使ってもDOMを取得することができます。</p><p><code>contains()</code>は、引数として与えた文字列を探してくれるので、非常に簡単に記述することができます。しかし、同画面上に対象の文字列が複数存在する場合や、表示される文字列が変更されうる場合には注意が必要です。</p><h3 id="DOMを操作する"><a href="#DOMを操作する" class="headerlink" title="DOMを操作する"></a>DOMを操作する</h3><p><code>get()</code>や<code>contains()</code>でDOMを取得し、DOMに対してコマンドを実行します。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.click()   <span class="comment">// クリック</span></span><br><span class="line"></span><br><span class="line">cy.type(<span class="string">&#x27;入力&#x27;</span>)    <span class="comment">// 文字入力</span></span><br></pre></td></tr></table></figure><p>例えば、「検索フォームに文字を打ち込んで検索する」操作は、</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.get(<span class="string">&#x27;input[title=&quot;検索&quot;]&#x27;</span>).type(<span class="string">&#x27;Cypressの使い方&#x27;</span>);</span><br><span class="line">cy.contains(<span class="string">&#x27;Google 検索&#x27;</span>).click();</span><br></pre></td></tr></table></figure><p>などといった記述で実行することができます。</p><h3 id="チェックする"><a href="#チェックする" class="headerlink" title="チェックする"></a>チェックする</h3><p>画面の表示は適切か、ボタンはクリックできるか、といったテスト項目をCypressに確認させましょう。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.should(<span class="string">&#x27;テストタイプ&#x27;</span>)</span><br><span class="line">cy.should(<span class="string">&#x27;テストタイプ&#x27;</span>, 比較値)</span><br></pre></td></tr></table></figure><p>例：指定の文字列が表示されていることをチェックする</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.contains(<span class="string">&#x27;Gogle&#x27;</span>).should(<span class="string">&#x27;exist&#x27;</span>);</span><br></pre></td></tr></table></figure><p>テストが失敗していた場合はCypressが教えてくれます。<br><img src="/images/20210428a/image_4.png"></p><h2 id="テストの動画を保存する"><a href="#テストの動画を保存する" class="headerlink" title="テストの動画を保存する"></a>テストの動画を保存する</h2><p>CYpressでは、テスト実行中の画面の様子を動画として保存できます。</p><p>ユーザ登録を行うことで、過去の動画の見返しや他者との共有が可能です。</p><ol><li>Cypressを実行し、開いた管理画面の<code>Runs</code>タブからユーザ登録を行う。</li><li>Record Keyが発行される。表示されたコマンドでCypressを実行する。<br><img src="/images/20210428a/image_5.png"></li><li>管理画面の<code>Runs</code>タブに、テストシナリオごとの実行ビデオが表示される。各ビデオファイルごとに保存や共有が可能である。</li></ol><h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>Cypressを用いたE2Eテストの基本的な実行&amp;管理方法を紹介しました。</p><p>画面操作を自動化するだけでなく、バグフィクス、エビデンスとしても役立てることができる優れものですが、私のような初心者でも簡単に構築出来ちゃいます。まだまだ紹介しきれていない機能もありますので、本記事の紹介で気軽にチャレンジしていただければ幸いです。</p><p>ぜひ快適なテストライフを！</p><h1 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h1><p>本記事は、<a href="https://future.connpass.com/event/208056/presentation/">Future Tech Night #8</a>というイベントでお話した内容を記事化したものです。<br>同イベントの他の発表も記事として投稿されてますので、ぜひご覧ください！</p><ul><li>Cypress入門～初心者でも簡単にE2Eテストが作れる～（この記事です）</li><li><a href="/articles/20210428b/">Cypress - 設定編</a></li><li><a href="/articles/20210428c/">保守・拡張をしやすいカプセル化したCypress</a></li><li><a href="/articles/20210428d/">Cypress - 書きやすいテストの秘密と独自コマンドの実装</a></li></ul><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20210226/index.html" data-iframely-url="//cdn.iframe.ly/ZMlnZ2M?iframe=card-small"></a></div></div><div class="iframely-embed"><div class="iframely-responsive" style="height: 140px; padding-bottom: 0;"><a href="https://future-architect.github.io/articles/20200115/index.html" data-iframely-url="//cdn.iframe.ly/uGST3JI?iframe=card-small"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは。踊るエンジニア、木戸俊輔です。&lt;/p&gt;
&lt;p&gt;2021年4月で社会人2年目になりましたが、総出社回数は3回です。</summary>
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
    <category term="Cypress" scheme="https://future-architect.github.io/tags/Cypress/"/>
    
    <category term="E2Eテスト" scheme="https://future-architect.github.io/tags/E2E%E3%83%86%E3%82%B9%E3%83%88/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
  </entry>
  
  <entry>
    <title>GoにおけるAPIドキュメントベースのWeb API開発について登壇しました</title>
    <link href="https://future-architect.github.io/articles/20210427c/"/>
    <id>https://future-architect.github.io/articles/20210427c/</id>
    <published>2021-04-26T15:00:05.000Z</published>
    <updated>2021-05-12T13:36:55.130Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20210427c/top.png"><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG 多賀です。</p><p>2021/3/19(金)に <a href="https://future.connpass.com/event/206387/">【増枠】Future Tech Night #7 〜フューチャーの開発事例と共に学べるGo勉強会〜 - connpass</a> を開催しました。 私は、Goの Web API 開発にて、API ドキュメントベースで開発していることについて話しました。<br>なお、その他の登壇者の資料は <a href="https://future.connpass.com/event/206387/presentation/">こちら</a> に公開済みですので、興味があれば参照ください。</p><p>他の登壇者のレポートはこちらです。</p><ul><li><a href="/articles/20210427a/">Goのフラットパッケージについて登壇しました</a></li><li><a href="/articles/20210427b/">GoでDockerのAPIを叩いてみる</a></li></ul><h2 id="発表内容"><a href="#発表内容" class="headerlink" title="発表内容"></a>発表内容</h2><h3 id="API-ドキュメントベースで-Web-API-開発-go-swagger"><a href="#API-ドキュメントベースで-Web-API-開発-go-swagger" class="headerlink" title="API ドキュメントベースで Web API 開発 (go-swagger)"></a>API ドキュメントベースで Web API 開発 (go-swagger)</h3><iframe src="https://docs.google.com/presentation/d/1P1ntgrIZ_zYhlxQh8UjV1fBCIIObP-ZJPhm7Dn1yc04/embed?start=false&loop=false&delayms=3000" frameborder="0" width="100%" height="550" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><p>ブログで Go の Open API 関連ツールについていくつか記事を書いており、そのまとめ的な内容と実際に案件で使ってみての感想について話しています。</p><p>参考記事</p><ul><li><a href="https://future-architect.github.io/articles/20200701/">Go の Open API 3.0 のジェネレータ oapi-codegen を試してみた | フューチャー技術ブログ</a></li><li><a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選 | フューチャー技術ブログ</a></li><li><a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた | フューチャー技術ブログ</a></li></ul><h3 id="質問内容"><a href="#質問内容" class="headerlink" title="質問内容"></a>質問内容</h3><h4 id="Q-Open-API-3-0が使えないことで問題などは生じないのですか？"><a href="#Q-Open-API-3-0が使えないことで問題などは生じないのですか？" class="headerlink" title="Q. Open API 3.0が使えないことで問題などは生じないのですか？"></a>Q. Open API 3.0が使えないことで問題などは生じないのですか？</h4><p>基本 Open API 2.0 で各種周辺ツール(他言語のクライアント生成、フロントエンドの表示等)の利用は問題なくできていました。Open API 2.0 と Open API 3.0 の変換ツール もありますので、ノックアウトになることはない認識です。</p><p><a href="https://mermade.org.uk/openapi-converter">Mermade Swagger 2.0 to OpenAPI 3.0.0 converter</a></p><h4 id="Q-go-swaggerを選ぶ際に、Open-API-2-0でも良いと判断するためのポイントなどがあれば教えてください"><a href="#Q-go-swaggerを選ぶ際に、Open-API-2-0でも良いと判断するためのポイントなどがあれば教えてください" class="headerlink" title="Q. go-swaggerを選ぶ際に、Open API 2.0でも良いと判断するためのポイントなどがあれば教えてください"></a>Q. go-swaggerを選ぶ際に、Open API 2.0でも良いと判断するためのポイントなどがあれば教えてください</h4><p>Open API 3.0 を利用しなければならない要件が他にないかの確認かと思います。 Open API を利用する場合、ドキュメントを書いて終わりではなく、周辺ツールや他の言語と組み合わせて使うようになることが多い印象です。<br>その際に、他で利用するツールが全て Open API 3.0 必須 で変換コストがかかることで全体のスピード感を損なうのであれば、go-swagger ではなく Open API 3.0 系のツールの利用が良いかと考えています。</p><h4 id="Q-go-swaggerがOpen-API-3-0に対応することはありそうでしょうか"><a href="#Q-go-swaggerがOpen-API-3-0に対応することはありそうでしょうか" class="headerlink" title="Q. go-swaggerがOpen API 3.0に対応することはありそうでしょうか?"></a>Q. go-swaggerがOpen API 3.0に対応することはありそうでしょうか?</h4><p>go-swagger は Open API 3.0 へ対応されない模様です。<br>以下 issue で言及されていました。</p><p><a href="https://github.com/go-swagger/go-swagger/issues/1122#issuecomment-323113089">https://github.com/go-swagger/go-swagger/issues/1122#issuecomment-323113089</a></p><h4 id="Q-go-swagger-のチームメンバーからの評判はどうですか？"><a href="#Q-go-swagger-のチームメンバーからの評判はどうですか？" class="headerlink" title="Q. go-swagger のチームメンバーからの評判はどうですか？"></a>Q. go-swagger のチームメンバーからの評判はどうですか？</h4><p>そこまで悪くはないかなという印象です。<br>他言語経験者で Go 初心者の方が開発する際に、コード生成で Handler 周りが出力されるので、細かい部分で詰まることなく開発できていたのかなと思っています。<br>go-swagger コマンドを開発端末で実行できるように、開発環境をしっかり事前に整備する必要はありました。go-swagger コマンドがうまくインストールできない等の問題は起きて、対応したりしてました。(ちなみに、公式からバイナリ落としてもらうが一番簡単な解決策でした）</p><h4 id="Q-WAF-Web-Application-Framework-よりもgo-swaggerのメリットが大きかったでしょうか？-私ははechoとgo-swaggerで悩んで結局echoにしました。"><a href="#Q-WAF-Web-Application-Framework-よりもgo-swaggerのメリットが大きかったでしょうか？-私ははechoとgo-swaggerで悩んで結局echoにしました。" class="headerlink" title="Q. WAF(Web Application Framework)よりもgo-swaggerのメリットが大きかったでしょうか？ 私ははechoとgo-swaggerで悩んで結局echoにしました。"></a>Q. WAF(Web Application Framework)よりもgo-swaggerのメリットが大きかったでしょうか？ 私ははechoとgo-swaggerで悩んで結局echoにしました。</h4><p>前提として、go-swagger も WAF としての機能は備えている認識です。<br>他のブログ記事に、以下の通り記載があり、私自身も同じ理解です。</p><blockquote><p>go-swaggerがWAF(Webアプリケーションフレームワーク）というのは直感では理解しにくいですが、go-swaggerで生成したサーバサイドのコードは、実質的にechoやginのように多くの機能を持ちます。 例えば、URLのルーティング、入力Validation、クエリパラメータ、フォーム、リクエストヘッダ、リクエストボディなどの 入力modelへのバインディング、HTTPレスポンスコード別のmodelの作成や、Middlewareの設定専用の関数など多くをサポートしていますし、固有のビジネスロジックを書くルールもgo-swaggerの生成したコードによって決められています。</p></blockquote><p>引用: <a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選 | フューチャー技術ブログ</a></p><p>あとは、考え方と優先度次第で決めることになるかと思います。</p><p>当発表では、「APIドキュメントファースト」ととして考えた結果、go-swagger を利用しているというスタンスになっています。ドキュメントと実装の乖離を防ぐというところに、重きを置いた選定を行い、実際に乖離しないメリットは享受できておりました。<br>他の WAF との比較はなんとも言えないですが、複数人でフロント・バックエンドを同時進行での開発であったことを考えるとメリットは大きかったかなと思います。</p><h3 id="発表で話していないこと"><a href="#発表で話していないこと" class="headerlink" title="発表で話していないこと"></a>発表で話していないこと</h3><ul><li>go-swagger 利用がベストの選択肢ではない<ul><li>今回の発表では、ドキュメントファーストを優先しての選定になっていますので、他の優先項目があればまた違う WAF の選定になったかと思います</li><li>個人的な好み的には、生成コードが薄く、中身が読みやすいライブラリのほうが好みです (<a href="https://github.com/go-chi/chi">go-chi/chi</a> とかですね)</li><li>ただ、ドキュメントが大事とは考えていて、他の WAF であまり考えられてなかったりするのが疑問だったりします。 Web API って使い手がいないと存在価値がないと思っていますので。</li></ul></li><li>go-swagger の生成コードは読める人がいたほうが良い<ul><li>細かい設定(タイムアウト等) を行う際に、生成コードを読んで設定することがありました。生成コードだからといって中身を知らないと思わぬ落とし穴にハマることがあるので、ご注意ください。</li></ul></li></ul><h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>案件でしっかり使った内容について、アウトプットできて良かったと思っています。</p><p>他の WAF を使っての開発案件もやって、利用後の比較もしてみたいですね。</p><p>発表をご視聴いただいた方、当記事を最後まで読んでいただいた方、ありがとうございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;/images/20210427c/top.png&quot;&gt;

&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;TIG 多賀です。&lt;/p&gt;
&lt;p&gt;2021/3</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇資料" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E8%B3%87%E6%96%99/"/>
    
    <category term="開催レポート" scheme="https://future-architect.github.io/tags/%E9%96%8B%E5%82%AC%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Swagger" scheme="https://future-architect.github.io/tags/Swagger/"/>
    
    <category term="OpenAPI" scheme="https://future-architect.github.io/tags/OpenAPI/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
  </entry>
  
  <entry>
    <title>GoでDockerのAPIを叩いてみる</title>
    <link href="https://future-architect.github.io/articles/20210427b/"/>
    <id>https://future-architect.github.io/articles/20210427b/</id>
    <published>2021-04-26T15:00:03.000Z</published>
    <updated>2021-05-12T13:37:01.231Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future.connpass.com/event/206387/">Future Tech Night #7</a>で「GoでDockerのAPIを叩いてみる」という発表をしてきました。</p><p>他の登壇者のレポートはこちらです。</p><ul><li><a href="/articles/20210427a/">Goのフラットパッケージについて登壇しました</a></li><li><a href="/articles/20210427c/">GoにおけるAPIドキュメントベースのWeb API開発について登壇しました</a></li></ul><p>近年、コンテナの利用はますます増えています。実行環境としても、クラウドサービスでコンテナをホストするサービスは増えています。コンテナを動かすサービスもあれば、K8Sの利用も増えています。Kubernetesも最小のビルディングブロックはコンテナです。K8SのKnativeベースのGCP Cloud Runが僕の最近のお気に入りです。</p><p><img src="/images/20210427b/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-03-18_23.43.23.png"></p><p>AWS Lambdaもコンテナを実行できるようになりました</p><ul><li><a href="https://www.publickey1.jp/blog/20/aws_lambdaaws_reinvent_2021.html">https://www.publickey1.jp/blog/20/aws_lambdaaws_reinvent_2021.html</a></li></ul><p>実行環境だけではなく、開発環境としても必要不可欠なツールになってきています。OSやバージョンが違っても同じ環境を再現できます。データベースなどのミドルウェアもOSにインストールすることなく、プロジェクトごとに個別の環境を作るのも簡単になりました。</p><p>そのコンテナのデファクトとなっているのがDockerです。Dockerはコンテナのオールインワンツールで、コンテナのビルドから実行までできますし、複数のコンテナを連携して動かす機能（オーケストレーション）もdocker-composeコマンドで提供されています。</p><p>コンテナ自体はDockerだけに限定されるされるものではありません。ビルドはdocker build以外にも、Bazelでも、Buildpacksでも、作成する手段は他にもあります。実行する部分はOCI Runtime Specificationという規格があり、Dockerもその1つです。</p><p>とはいえDockerは便利です。WindowsでもmacでもLinuxでもインストーラで環境が整うので、Dockerの環境構築でトラブル、という例は聞いたことがありません。Docker Hubでさまざまなイメージが1コマンドでダウンロードして起動できるのも良いですし、何よりも情報が多いというメリットがあります。</p><p><a href="https://qiita.com/shibukawa/items/797b7cbb7e530842e6f7">M1 Macの互換性情報のメモ</a>をQiitaに公開したときも感想として一番多かったのが、「Dockerが動くなら買おうかな」というものでした。このエントリーではDockerをもっと活用する方法について紹介します。</p><h1 id="Dockerの仕組み"><a href="#Dockerの仕組み" class="headerlink" title="Dockerの仕組み"></a>Dockerの仕組み</h1><p>Dockerをインストールして実際にサーバーなりを起動する場合、操作はdockerコマンドで行います。このdockerコマンドは単に命令を送るだけで、実態はWindowsなりLinuxなりmacOSで常駐プログラムとして実装されているサーバー(dockerd)が行います。</p><p><img src="/images/20210427b/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-04-23_0.32.50.png"></p><p>Linuxはプロセスやファイルシステムを隔離してそのプロセスだけが動いているように見える状態で動きます。Linuxカーネルが持つ機能を使います。WindowsとmacはHyperVやHypervisor.FrameworkといったOSが持つ仮想PC機能を使い、Linuxを動かし、その中でLinuxカーネルの機能を使って動かします。コンテナごとに独立したOSが起動しているわけではなく、1つのLinuxの中で隔離機能を使って作った環境の中でそれぞれのプロセスが起動します。</p><p>コマンドからサーバーへのアクセスは、通常は/var/run/docker.sockというUnixドメインソケットを通じて動かします。これはHTTPサーバーがこのUDPの中で動いています。別ホストであればDOCKER_HOST環境変数を設定することでTCP/IPを使った連携ができます。</p><p>このサーバーにアクセスすると、コンテナを起動したり止めたりといったコンテナの操作ができます。また、このUDPはDockerのボリュームマウントを使ってコンテナの中に持ち込むことができます。そうすると、コンテナの中からあらゆるコンテナ操作ができる、特権コンテナのようなことも可能になります。</p><p>UDPベースのHTTPなので、curlコマンドでコンテナを操作できます。次のサンプルはhello-worldイメージを実行してそのログをコンソールに出力するコマンドです（CIDは最初のコマンド実行後に出力されるコンテナのIDが代入されているものとします)。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl --unix-socket /var/run/docker.sock -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;Image&quot;: &quot;hello-world&quot;&#125;&#x27;</span> \</span><br><span class="line">  -X POST http://localhost/containers/create</span><br><span class="line"></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock -X POST http://localhost/containers/<span class="variable">$&#123;CID&#125;</span>/start</span><br><span class="line"></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock -X POST http://localhost/containers/<span class="variable">$&#123;CID&#125;</span>/<span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock <span class="string">&quot;http://localhost/containers/<span class="variable">$&#123;CID&#125;</span>/logs?stdout=1&quot;</span></span><br></pre></td></tr></table></figure><p>dockerコマンドなどはこの命令を自分で組み立てているわけではなく、GoやPythonのSDKを使って実装されています。このSDKを使うことでこれらの公式コマンドと同じことができます。</p><p><a href="https://docs.docker.com/engine/api/sdk/">https://docs.docker.com/engine/api/sdk/</a></p><p><img src="/images/20210427b/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-03-18_23.20.12.png"></p><h1 id="Dockerのログビューアを作ってみる"><a href="#Dockerのログビューアを作ってみる" class="headerlink" title="Dockerのログビューアを作ってみる"></a>Dockerのログビューアを作ってみる</h1><p>近年のサービス開発では、オブザーバビリティが大事という機運が高まっています。ただ、数多くのSaaSなサービスはあるものの、手元で開発環境を用意するのは意外と面倒だったりします。オブザーバビリティでは次のような項目が技術要素として挙げられています。</p><ul><li>構造化ログ</li><li>トレーシング</li><li>メトリックス</li></ul><p>オブザーバビリティではこれらのルールに従ったログを出すアプリケーションと、それを閲覧するビューアが二人三脚で必要となります。とりあえず先頭の要素を実現するものを実装してみます。ログ出力は<a href="https://github.com/ymotongpoo/cloud-logging-configurations">JSONを出力する構造化ロガーが各言語にあったり</a>しますので、そのあたりを使って行区切りのJSON（JSONL）として出力したものをパースして色付けして出力します。</p><p>このブログの<a href="https://future-architect.github.io/articles/20201107/">フューチャーOSS推進タスクフォース始めます</a>の記事の中で、ログビューアというものがこっそり書かれていましたが、それがこれにあたります。</p><p><img src="/images/20210427b/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-04-23_1.24.57.png"></p><p>最終的に出来上がったコードがこれです。</p><p><a href="https://gitlab.com/osaki-lab/secondsight">https://gitlab.com/osaki-lab/secondsight</a></p><p>アーキテクチャはこんな感じです。</p><p><img src="/images/20210427b/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2021-04-23_1.25.24.png"></p><h2 id="Docker-APIの利用"><a href="#Docker-APIの利用" class="headerlink" title="Docker APIの利用"></a>Docker APIの利用</h2><p>前述のドキュメントページのリファレンスなどをまず確認し、実行したい機能をまずは探します。dockerコマンドと必ずしも1:1になっているとは限らないので注意が必要です。ログビューアを作るには次のAPIを利用してみると良さそうです。</p><ul><li>コンテナのIDをリストアップ<br>   <a href="https://docs.docker.com/engine/api/v1.41/#operation/ContainerList">Containers - List Containers</a></li><li>コンテナの詳細情報を知る<br>   <a href="https://docs.docker.com/engine/api/v1.41/#operation/ContainerInspect">Containers - Inspect a Container</a></li><li>コンテナのイベント（起動とか停止）を取得<br>   <a href="https://docs.docker.com/engine/api/v1.41/#operation/SystemEvents">System - Monitor Events</a></li><li>コンテナのログを取得<br>   <a href="https://docs.docker.com/engine/api/v1.41/#operation/ContainerLogs">Containers - Get Container Logs</a></li><li>コンテナの消費リソースを取得<br>   <a href="https://docs.docker.com/engine/api/v1.41/#operation/ContainerStats">Containers - Get container stats based on resource usage</a></li></ul><p>なお、Docker SDKを網羅するサンプルコードとして、dockerコマンド自身があります。コードなんかを探索するとパラメータや返り値の加工方法が一発で理解できます。ためしに<code>ContainerStats()</code>などを検索してみてください。</p><p><a href="https://github.com/docker/cli">https://github.com/docker/cli</a></p><p>完成したのが次のプログラムです。半年ぐらい前に作って放置していたものを、発表の一週間前ぐらいからいじり初めてGoのコードをゼロから作り直して、動くようにしてみました（ので実践投入はまだ）。壮大な構想のために複雑化していたところをバサッと切り捨ててシンプルにしました。</p><p><img src="/images/20210427b/secondsight.gif"></p><p>なお、これの実装中に調べて書いたのが次のエントリーです。</p><ul><li><a href="https://future-architect.github.io/articles/20210408/">Go 1.16のembedとchiとSingle Page Application</a></li></ul><p>それ以外の実装部分の理解の助けになるエントリーもいくつもあります。</p><ul><li><a href="https://future-architect.github.io/articles/20210212/">Go 1.16のsignal.NotifyContext()</a></li><li><a href="https://future-architect.github.io/articles/20210208/">Go 1.16からリリースされたgo:embedとは</a></li><li><a href="https://future-architect.github.io/articles/20201111/">Parcel 2.0 beta.1を試す</a></li><li><a href="https://future-architect.github.io/articles/20200501/">TypeScriptでReactをやるときは、小さいアプリでもReduxを最初から使ってもいいかもねというお話</a></li></ul><p>他にも、サーバーレス連載などでDockerやCloud Runについて書いた記事も多数あります</p><p>軽く作ってみると、構造化ログが見えるのは便利です。色がつくとわかりやすいです。今後も、暇を見つけていろいろ機能を足していきたいです。フィルタや検索機能OpenCensus/OpenTelemetryのトレースログ、メトリクスの表示などです。ログ出力ライブラリによっていろいろクセがあったりするので、それぞれの出力をパースしてみやすくするのもいいですね。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Dockerは今時な開発を支える重要なツールですが、Go SDKでいじってみるのは簡単でカスタマイズが可能です。実際にそれらを使うサンプルコードも紹介しました。クラウドサービスを使えば便利なものをローカルで気軽に実現するツールとかは作ってみるチャンスな予感（大手は投資しないだろうし）</p><p>今後、フューチャーでもいろいろOSSを作ったりしていきたいと思っています</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://future.connpass.com/event/206387/&quot;&gt;Future Tech Night #7&lt;/a&gt;で「GoでDockerのAPIを叩いてみる」という発表をしてきました。&lt;/p&gt;
&lt;p&gt;他の登壇者のレポートはこちらです。&lt;</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇資料" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E8%B3%87%E6%96%99/"/>
    
    <category term="開催レポート" scheme="https://future-architect.github.io/tags/%E9%96%8B%E5%82%AC%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="OSS" scheme="https://future-architect.github.io/tags/OSS/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Docker" scheme="https://future-architect.github.io/tags/Docker/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
    <category term="OSS推進タスクフォース" scheme="https://future-architect.github.io/tags/OSS%E6%8E%A8%E9%80%B2%E3%82%BF%E3%82%B9%E3%82%AF%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>Goのフラットパッケージについて登壇しました</title>
    <link href="https://future-architect.github.io/articles/20210427a/"/>
    <id>https://future-architect.github.io/articles/20210427a/</id>
    <published>2021-04-26T15:00:00.000Z</published>
    <updated>2021-05-12T13:36:51.832Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20210427a/building-5630441_640.jpg"><p><a href="https://pixabay.com/ja/users/rotekirsche20-18445331/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=5630441">rotekirsche20</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=5630441">Pixabay</a>からの画像</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIG真野です。</p><p>2021/3/19(金)に<a href="https://future.connpass.com/event/206387/">Future Tech Night #7 〜フューチャーの開発事例と共に学べるGo勉強会〜</a> を開催しました。</p><p>トップバッターでGoの開発構成・アプリアーキテクチャについて話したので報告します。</p><p>なお、その他の登壇者の資料は<a href="https://future.connpass.com/event/206387/presentation/">こちら</a> に公開済み。他の登壇者のレポートはこちらです。</p><ul><li><a href="/articles/20210427b/">GoでDockerのAPIを叩いてみる</a></li><li><a href="/articles/20210427c/">GoにおけるAPIドキュメントベースのWeb API開発について登壇しました</a></li></ul><h1 id="発表内容：Goでフラットパッケージを導入してみて良かったこと、これから"><a href="#発表内容：Goでフラットパッケージを導入してみて良かったこと、これから" class="headerlink" title="発表内容：Goでフラットパッケージを導入してみて良かったこと、これから"></a>発表内容：Goでフラットパッケージを導入してみて良かったこと、これから</h1><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vTVNmDqauFzwlCeehGOrQK-l_CMQOZf2Hw1uFv12xDtXFPBF96k2M0XYOi4oRbh8UsQcfAf25HzV-UW/embed?start=false&loop=false&delayms=3000" frameborder="0" width="100%" height="550" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><p>フューチャー技術ブログで、<a href="/articles/20201109/">GoのWebアプリ開発でフラットパッケージにした話</a> という記事を公開した内容の改定版になります。なぜフラットパッケージに至ったかの経緯についてなるべく自分がたどった経路を細かに説明することを意識しました。</p><p>かなり挑戦的で大胆な設計だったとおもいますが、一定の賛同（？）をいただけて嬉しかったです。</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Repositoryパターンのメリット無くね？<br>モックにできる -&gt; 殆どの関心事がデータアクセスなんでそこモックにするのも...<br>データ層変更できる -&gt; やらねーよ<br><br>...分かる<br> <a href="https://twitter.com/hashtag/future_tech_night?src=hash&amp;ref_src=twsrc%5Etfw">#future_tech_night</a></p>&mdash; 脱脂綿/だっしー (@anchor_cable) <a href="https://twitter.com/anchor_cable/status/1372853753007640576?ref_src=twsrc%5Etfw">March 19, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">設計の理想論と現実論の塩梅の話で非常に良い<br> <a href="https://twitter.com/hashtag/future_tech_night?src=hash&amp;ref_src=twsrc%5Etfw">#future_tech_night</a></p>&mdash; 4月 (@karrybit) <a href="https://twitter.com/karrybit/status/1372854017550737411?ref_src=twsrc%5Etfw">March 19, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>発表資料でも記載の通り、何事もトレードオフがあると思いますが、フラットパッケージがハマる領域も少なからずあるかと思いますので、活用して頂けると嬉しいです。</p><h1 id="発表で話せなかったこと"><a href="#発表で話せなかったこと" class="headerlink" title="発表で話せなかったこと"></a>発表で話せなかったこと</h1><p>15分枠だと話せなかったことがいくつかあるので、補足しておきます。</p><ul><li>パッケージ構造がどうこうより、テストが大変です<ul><li>これは業務系システムの開発者だとけっこう同意してくれると思うのですが、カバレッジ・テスト密度やらをある程度指標に持って品質を見ていこうとすると、けっこうなテスト数、テストコード量になると思います<ul><li>スクロールをどれだけしても、Table Driven Tesingのテーブル宣言部分が終わらないとかザラです</li></ul></li><li>特に業務システム系だと、マスタデータの種類が多く、テストのデータパターンをかなり考える必要があります</li><li>モックでデータパターンを考えようが、実際のDBを使おうが正直大変さは同じですが、込み入ったデータを作るときは実際のDBを用いれたほうがいっそ楽だという視点もあるかなと思います</li></ul></li><li>大きくなると破綻しない？<ul><li>5~10人で1年以上開発を続けていますが、今のところは大丈夫です</li><li>正直複雑化するのはパッケージ構造ではなく、データパターンとか業務ロジックそのものなので、パッケージ構造だから破綻というのは現時点だと自分のチームだと想定しにくく、もし本当に巨大になるのであればリポジトリごと分けるので大丈夫かなと思います</li></ul></li><li>次にGoで新規開発するときもフラットパッケージにするか？<ul><li>規模感やドメインにもよりますが選択できるのであれば多分すると思います<ul><li>現実的には他の開発者の好みや考えもあると思うので、一つの意見として出すレベルかと思います</li></ul></li></ul></li><li>モデルにテストを寄せている話<ul><li>どうしても外部サービスに対して、テストケースや関数毎にデータ登録すると速度が遅くなります</li><li>handlerレベルのテストケースが肥大化しないために、なるべくmodelにロジックを寄せて、model単位でテストするようにしています<ul><li>modelは外界へのアクセスが基本的にないので、関数の引数・戻り値で検証可能。go-cmpで行っています</li></ul></li></ul></li></ul><h1 id="反省点"><a href="#反省点" class="headerlink" title="反省点"></a>反省点</h1><p>Zoomで開催していて質問をもらうスタイルでしたが、中にはTwitterでハッシュタグ付きでコメントしてくれた人もいました。私もよく行うスタイルですが完全に見逃していて、全部終わったあとに気が付きました。次回からはそちらも拾うようにします。</p><p>また、最後に座談会のような時間があったのですが、発表後の放心状態からうまく登壇者同士でワイワイ話すことができませんでした。今後は第三者のモデレータ？のような人を置くなどで改善したいと思います。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>聞き飽きた？感じもあるGoのパッケージですが、意外とフラットな構造でもいけるぞって発表でした。</p><p>フューチャーは2020年から社内の知見を発信して少しでも皆様のお役に建てるように、ブログだけではなく勉強会も積極的に開催していこうとしています。<a href="/articles/20210314/">こちら</a>の記事にあるように、年間の計画をたてています。ぜひウォッチしていただければです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;/images/20210427a/building-5630441_640.jpg&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/rotekirsche20-18445331/?utm_source=link-att</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇資料" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E8%B3%87%E6%96%99/"/>
    
    <category term="開催レポート" scheme="https://future-architect.github.io/tags/%E9%96%8B%E5%82%AC%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="TechNight" scheme="https://future-architect.github.io/tags/TechNight/"/>
    
  </entry>
  
  <entry>
    <title>Go 1.16のembedとgo-swaggerを組み合わせてフルスタック自動生成フレームワークを作る</title>
    <link href="https://future-architect.github.io/articles/20210426b/"/>
    <id>https://future-architect.github.io/articles/20210426b/</id>
    <published>2021-04-25T15:00:01.000Z</published>
    <updated>2021-04-26T02:37:54.020Z</updated>
    
    <content type="html"><![CDATA[<p>TIGの伊藤真彦です。</p><p>渋川さんが投稿された</p><ul><li><a href="https://future-architect.github.io/articles/20210408/">Go 1.16のembedとchiとSingle Page Application</a></li><li><a href="https://future-architect.github.io/articles/20210409/">Go 1.16のgo:embedとNext.jsの相性が悪い問題と戦う</a><br>に近い研究記事です。</li></ul><h2 id="やりたいこと"><a href="#やりたいこと" class="headerlink" title="やりたいこと"></a>やりたいこと</h2><img src="/images/20210426b/go_vue_logo.png" class="img-middle-size"><p>私の最近の仕事はgo-swaggerによるバックエンドAPI開発です。本流はバックエンドですが、必要に応じてクラウドインフラを弄ったり、ちょっとしたフロントエンドアプリケーションを作ったりといった動き方で働いています。</p><p>ある時、go-swaggerで作ったバックエンドAPIの資産を使って、ちょっとした開発者向けアプリケーションを作りたくなりました。</p><p>ローカル環境でサーバーとフロントエンドアプリケーションを両方起動すると、サーバーが<code>localhost:3000</code> フロントエンドが<code>localhost:8080</code>を占拠してしまいます。また、フロントエンドとバックエンドのポートが異なることにより、フロントエンドからのリクエストを処理するためにはCORSの設定が必要になってしまいます。そして単純に2つのアプリケーションを起動するのが面倒だなと感じました。</p><p>そこで、go-swaggerが生成するものをハックして、フロントエンドの成果物と今まで作ってきたバックエンドAPIを同じポートで抱えつつ、APIを叩くクライアントサイドのコードもswagger.yamlから自動生成するようなアプリケーション開発に挑戦してみました。</p><h2 id="バックエンド開発"><a href="#バックエンド開発" class="headerlink" title="バックエンド開発"></a>バックエンド開発</h2><p>説明のために、まずはバックエンドの資産を作ります。</p><p>詳しい作り方、説明は<a href="https://future-architect.github.io/articles/20200824/">go-swaggerでhello world</a>をお読みください。</p><p>今回はこのようなディレクトリ構成でアプリケーションを作ります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">swagger.yaml</span><br><span class="line">server</span><br><span class="line">  ├─gen</span><br><span class="line">　└─get_greeting_handler.go</span><br></pre></td></tr></table></figure><figure class="highlight yml"><figcaption><span>swagger.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">swagger:</span> <span class="string">&#x27;2.0&#x27;</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Greeting</span> <span class="string">Server</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/hello:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">produces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">text/plain</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">name</span></span><br><span class="line">          <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">defaults</span> <span class="string">to</span> <span class="string">World</span> <span class="string">if</span> <span class="string">not</span> <span class="string">given</span></span><br><span class="line">      <span class="attr">operationId:</span> <span class="string">getGreeting</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">200:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">returns</span> <span class="string">a</span> <span class="string">greeting</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">contains</span> <span class="string">the</span> <span class="string">actual</span> <span class="string">greeting</span> <span class="string">as</span> <span class="string">plain</span> <span class="string">text</span></span><br></pre></td></tr></table></figure><p><a href="https://future-architect.github.io/articles/20200824/">上記記事</a>と同じswagger.yamlを用意して、serverパッケージを生成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swagger generate server -a factory -A factory -t server/gen -f ./ swagger.yaml</span><br></pre></td></tr></table></figure><p>get_greeting_handler.goはログ出力だけ少し追加しました。</p><figure class="highlight go"><figcaption><span>get_greeting_handler.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetGreeting</span><span class="params">(p factory.GetGreetingParams)</span> <span class="title">middleware</span>.<span class="title">Responder</span></span> &#123;</span><br><span class="line">payload := <span class="string">&quot;hello go&quot;</span></span><br><span class="line"><span class="keyword">if</span> p.Name != <span class="literal">nil</span> &#123;</span><br><span class="line">payload = *p.Name</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;GetGreeting is called, return %s\n&quot;</span>, payload)</span><br><span class="line"><span class="keyword">return</span> factory.NewGetGreetingOK().WithPayload(payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>localhost:3000/hello</code>でapiが動くことを確認します。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> server</span><br><span class="line">go run .\gen\<span class="built_in">cmd</span>\factory-server\main.go --host <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> --port <span class="number">3000</span></span><br></pre></td></tr></table></figure><img src="/images/20210426b/image.png" style="border:solid 1px #000000"><h2 id="フロンエンド開発"><a href="#フロンエンド開発" class="headerlink" title="フロンエンド開発"></a>フロンエンド開発</h2><p>バックエンドの用意ができたら、上記のAPIを叩くためのサンプルアプリケーションを作ります。<br>まずはVue.jsでのHello Worldアプリケーションを生成します。<br>こちらも過去記事<a href="https://future-architect.github.io/articles/20210107/">Electronの使い方 Web開発の技術でデスクトップアプリを作ろう</a>で詳しく説明しています。</p><p>フロントエンドアプリケーションを下記の構成で生成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swagger.yaml</span><br><span class="line">app</span><br><span class="line">  └─frontend</span><br><span class="line">server</span><br><span class="line">  ├─gen</span><br><span class="line">　└─get_greeting_handler.go</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @vue/cli</span><br><span class="line">mkdir app</span><br><span class="line"><span class="built_in">cd</span> app</span><br><span class="line">vue create frontend</span><br></pre></td></tr></table></figure><p>アプリケーションを起動し、<code>localhost://8080</code>でフロントエンドアプリケーションが起動することを確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> frontend</span><br><span class="line">npm run serve</span><br></pre></td></tr></table></figure><img src="/images/20210426b/image_2.png" style="border:solid 1px #000000"><h2 id="フロントエンドにAPI-Clientを実装する"><a href="#フロントエンドにAPI-Clientを実装する" class="headerlink" title="フロントエンドにAPI Clientを実装する"></a>フロントエンドにAPI Clientを実装する</h2><p>作成したフロントエンドアプリケーション向けに、TypeScriptのAPIクライアントを自動生成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> app</span><br><span class="line">npx -p @openapitools/openapi-generator-cli@cli-4.1.3 openapi-generator generate -g typescript-axios -i ../../swagger.yaml -o ./frontend/src/client-axios -p modelPropertyNaming=snake_case --enable-post-process-file</span><br></pre></td></tr></table></figure><p><code>/frontend/src/client-axios</code>ディレクトリにコードが生成されます。<br><code>.eslintignore</code>に追加するなど、linterの設定を適宜追加してエラーが起きないようにすることを推奨します。</p><p>生成したコードを利用するように<code>app\frontend\src\App.vue</code>を更新します。</p><figure class="highlight html"><figcaption><span>App.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;Vue logo&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./assets/logo.png&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> &#123; Component, Vue &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-property-decorator&#x27;</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> &#123; DefaultApi &#125; <span class="keyword">from</span> <span class="string">&#x27;./client-axios&#x27;</span></span></span><br><span class="line"></span><br><span class="line">@Component(&#123;&#125;)</span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Vue</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  message = <span class="string">&quot;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  mounted():<span class="keyword">void</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> api = <span class="keyword">new</span> DefaultApi().getGreeting(<span class="string">&quot;hello Vue + Go + OpenAPI&quot;</span>);</span></span><br><span class="line"><span class="javascript">    api.then(<span class="function">(<span class="params">resp: any</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.message = resp.data;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#app</span> &#123;</span></span><br><span class="line">  font-family: Avenir, Helvetica, Arial, sans-serif;</span><br><span class="line">  -webkit-font-smoothing: antialiased;</span><br><span class="line">  -moz-osx-font-smoothing: grayscale;</span><br><span class="line">  text-align: center;</span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#2c3e50</span>;</span></span><br><span class="line">  margin-top: 60px;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>app\frontend\src\client-axios\base.ts</code>でAPIの接続先を設定できるので、任意のポート、パスに書き換えます。</p><p><img src="/images/20210426b/image_3.png"></p><p>このまま<code>npm run serve</code>でアプリケーションを起動すると、存在しないAPIにアクセスし、通信に失敗する状態になります。</p><img src="/images/20210426b/image_4.png" style="border:solid 1px #000000"><p><img src="/images/20210426b/image_5.png"></p><p>この状態のアプリケーションを、バックエンドAPIと繋ぎこみます。</p><h2 id="フロントエンドとバックエンドAPIを統合する"><a href="#フロントエンドとバックエンドAPIを統合する" class="headerlink" title="フロントエンドとバックエンドAPIを統合する"></a>フロントエンドとバックエンドAPIを統合する</h2><p>まずは作成したフロントエンドアプリケーションをビルドし、アセットファイルを準備します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> app/frontend</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure><p><code>app\frontend\dist</code>ディレクトリに成果物一式が生成されます。</p><p>生成したファイルを<code>go:embed</code>で埋め込み起動するような<code>main.go</code>を下記の構成で作成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swagger.yaml</span><br><span class="line">app</span><br><span class="line">  ├─frontend</span><br><span class="line">  └─main.go</span><br><span class="line">server</span><br><span class="line">  ├─gen</span><br><span class="line">　└─get_greeting_handler.go</span><br></pre></td></tr></table></figure><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;embed&quot;</span></span><br><span class="line"><span class="string">&quot;io/fs&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/go-openapi/loads&quot;</span></span><br><span class="line">flags <span class="string">&quot;github.com/jessevdk/go-flags&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;regexp&quot;</span></span><br><span class="line"><span class="string">&quot;server/gen/restapi&quot;</span></span><br><span class="line"><span class="string">&quot;server/gen/restapi/factory&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> proxyRegexp = regexp.MustCompile(<span class="string">`^/api`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed frontend/dist/*</span></span><br><span class="line"><span class="keyword">var</span> static embed.FS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">swaggerSpec, err := loads.Embedded(restapi.SwaggerJSON, restapi.FlatSwaggerJSON)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">api := factory.NewFactoryAPI(swaggerSpec)</span><br><span class="line">server := restapi.NewServer(api)</span><br><span class="line"><span class="keyword">defer</span> server.Shutdown()</span><br><span class="line"></span><br><span class="line">parser := flags.NewParser(server, flags.Default)</span><br><span class="line">parser.ShortDescription = <span class="string">&quot;Greeting Server&quot;</span></span><br><span class="line">parser.LongDescription = swaggerSpec.Spec().Info.Description</span><br><span class="line">server.ConfigureFlags()</span><br><span class="line"><span class="keyword">for</span> _, optsGroup := <span class="keyword">range</span> api.CommandLineOptionsGroups &#123;</span><br><span class="line">_, err := parser.AddGroup(optsGroup.ShortDescription, optsGroup.LongDescription, optsGroup.Options)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := parser.Parse(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">code := <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> fe, ok := err.(*flags.Error); ok &#123;</span><br><span class="line"><span class="keyword">if</span> fe.Type == flags.ErrHelp &#123;</span><br><span class="line">code = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">os.Exit(code)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// serve swagger api server.</span></span><br><span class="line">server.ConfigureAPI()</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/api/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// remove &quot;/api&quot; fron api path for swagger api</span></span><br><span class="line">r.URL.Path = proxyRegexp.ReplaceAllString(r.URL.Path, <span class="string">&quot;&quot;</span>)</span><br><span class="line">server.GetHandler().ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// serve frontend HTML.</span></span><br><span class="line">public, err := fs.Sub(static, <span class="string">&quot;frontend/dist&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, http.FileServer(http.FS(public)))</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">&quot;listening on localhost:3000...&quot;</span>)</span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> if you want to use another port, you also have to modify app\frontend\src\client-axios\base.ts</span></span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>※そのまま使用すると<code>server</code>パッケージのimportに失敗します、ご自身の環境での適切なパスに指定するか、<code>go.mod</code>でreplaceしてください”<br>このファイルは、自動生成された<code>server\gen\cmd\factory-server\main.go</code>をベースに拡張したファイルです。</p><p>生成したフロントエンドのコードを<code>go:embed</code>で埋め込みます。<br>詳しくは<a href="https://future-architect.github.io/articles/20210208/">Go 1.16からリリースされたgo:embedとは</a>をお読みください。</p><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:embed frontend/dist/*</span></span><br><span class="line"><span class="keyword">var</span> static embed.FS</span><br></pre></td></tr></table></figure><p>埋め込んだファイルを利用できるようにHTTPハンドラを設定します。</p><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serve frontend HTML.</span></span><br><span class="line">public, err := fs.Sub(static, <span class="string">&quot;frontend/dist&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, http.FileServer(http.FS(public))</span><br></pre></td></tr></table></figure><p>一方、go-swaggerで生成したバックエンドAPIのロジックは<code>api/hello</code>のパスでアクセスできるように退避させつつ読み込みます。</p><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serve swagger api server.</span></span><br><span class="line">server.ConfigureAPI()</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/api/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// remove &quot;/api&quot; fron api path for swagger api</span></span><br><span class="line">r.URL.Path = proxyRegexp.ReplaceAllString(r.URL.Path, <span class="string">&quot;&quot;</span>)</span><br><span class="line">server.GetHandler().ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>本来であれば<code>server.Serve()</code>でポート番号の指定などを解釈しつつ、バックエンドAPIが起動するところを、上記の方法でうまく利用することができました。</p><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> proxyRegexp = regexp.MustCompile(<span class="string">`^/api`</span>)</span><br></pre></td></tr></table></figure><p>パスに<code>api/</code>の文字列が存在するとバックエンドAPIが元々期待しているパスパターンと一致しないため、正規表現を用いて除外しています。<br>余談ですが正規表現の<code>MustCompile</code>は関数内で行うと、呼び出されるたびに毎回コンパイルが走るため、グローバル変数に持たせる事が推奨されています。</p><h2 id="アプリケーションの起動"><a href="#アプリケーションの起動" class="headerlink" title="アプリケーションの起動"></a>アプリケーションの起動</h2><p>これでアプリケーションが完成しました。<br>完成したアプリケーションを起動してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> app</span><br><span class="line">go run main.go</span><br></pre></td></tr></table></figure><img src="/images/20210426b/image_6.png" style="border:solid 1px #000000"><p>無事にアプリケーションが起動し、バックエンドAPIからのレスポンスを表示することができました。</p><p><img src="/images/20210426b/image_7.png"></p><p>ブラウザのデバックコンソールでバックエンドAPIとの疎通に成功している事が確認できます。<br>あとは出来上がったファイルを<code>go build</code>すれば単一バイナリで動くフルスタックWebアプリケーションの完成です。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><ul><li>go-swaggerで生成したバックエンドサーバーと、任意のフロントエンドWebアプリケーションを同じポートで起動することは可能。</li><li>クライアントサイドからバックエンドに繋ぐためのAPIクライアントも自動生成できる。</li><li><code>go:embed</code>を利用することで、単一バイナリとしてビルドすることが可能。</li></ul><p>大規模アプリケーションをこの構成で作成するには若干邪道な雰囲気を感じますが、手早くアプリケーションを開発したいGopherのみなさんにおススメの手法でした。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;TIGの伊藤真彦です。&lt;/p&gt;
&lt;p&gt;渋川さんが投稿された&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20210408/&quot;&gt;Go 1.16のembedとchiとSingle Page </summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Frontend" scheme="https://future-architect.github.io/tags/Frontend/"/>
    
    <category term="Vue.js" scheme="https://future-architect.github.io/tags/Vue-js/"/>
    
    <category term="Go1.16" scheme="https://future-architect.github.io/tags/Go1-16/"/>
    
  </entry>
  
  <entry>
    <title>AWS CLIで用いるMFAをちょっとだけ便利に扱えるツールを公開しました</title>
    <link href="https://future-architect.github.io/articles/20210426a/"/>
    <id>https://future-architect.github.io/articles/20210426a/</id>
    <published>2021-04-25T15:00:00.000Z</published>
    <updated>2021-04-26T02:22:38.463Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20210426a/access-3579221_640.jpg" class="img-middle-size"><blockquote><p><a href="https://pixabay.com/ja/users/mohamed_hassan-5229782/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3579221">mohamed Hassan</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3579221">Pixabay</a>からの画像</p></blockquote><p>こんにちは、辻です。</p><p>AWSのIAMユーザのセキュリティ上、IAMユーザにMFA(他要素認証)を導入するケースがあります。MFAを有効にしているIAMユーザでGUI経由でログインする場合は、ログイン時に認証情報が求められて、MFAデバイスが出力するトークンを入力することでログインできます。一方AWS CLIを用いてリソースにアクセス場合はコマンド発行時に認証情報は求められません。代わりに以下のような記事にかかれているような、一時的な認証情報を発行することがよく行われます。</p><ul><li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/authenticate-mfa-cli/">MFA トークンを使用して、AWS CLI 経由で AWS リソースへのアクセスを認証する方法を教えてください。</a></li></ul><p><code>get-session-token</code> コマンドを発行することで一時的な認証情報を発行する、ということです。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws sts get-session-token --serial-number arn-of-the-mfa-device --token-code code-from-token --profile my-login-profile</span><br></pre></td></tr></table></figure><p>コマンドが成功すると、以下のようなJSONがレスポンスとして返ってきます。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Credentials&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;SecretAccessKey&quot;</span>: <span class="string">&quot;secret-access-key&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;SessionToken&quot;</span>: <span class="string">&quot;temporary-session-token&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Expiration&quot;</span>: <span class="string">&quot;expiration-date-time&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;AccessKeyId&quot;</span>: <span class="string">&quot;access-key-id&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返ってきたレスポンス <code>SecretAccessKey</code>, <code>SessionToken</code> を <code>~/.aws/credentials</code> に記述したり、あるいは環境変数を更新する必要があります。</p><p>上記のJSONの値を <code>~/.aws/credentials</code> に記述することでリソースにアクセスできるようになったものの、<code>get-session-token</code> コマンドを発行した認証情報は最大で129600秒(=36時間)です。一時的な認証情報という意味では妥当ですが、AWS CLIは頻繁に利用するため、ほぼ毎日 <code>get-session-token</code> コマンドで出力したJSONの値を <code>~/.aws/credentials</code> に貼り付ける作業が発生するようになりました。これはちょっと面倒です。</p><p>そこで <a href="https://github.com/future-architect/awsmfa">future-architect/awsmfa</a> というAWS CLIでMFAを扱うときにちょっとだけ便利にMFAを扱うコマンドラインツールを作りました。</p><h2 id="future-architect-awsmfa"><a href="#future-architect-awsmfa" class="headerlink" title="future-architect/awsmfa"></a><code>future-architect/awsmfa</code></h2><p><a href="https://github.com/future-architect/awsmfa"><img src="https://gh-card.dev/repos/future-architect/awsmfa.svg" alt="future-architect/awsmfa - GitHub"></a></p><h3 id="何ができるのか"><a href="#何ができるのか" class="headerlink" title="何ができるのか"></a>何ができるのか</h3><ul><li>AWSの <code>config</code> ファイルや <code>credential</code> ファイルにMFA用の名前付きプロファイルを生成</li><li>MFAに使用する値を、コマンド実行時に自動で更新</li></ul><h3 id="使い方"><a href="#使い方" class="headerlink" title="使い方"></a>使い方</h3><p><code>sts get-session-token</code> と同じ要領で <code>awsmfa</code> コマンドを実行するだけです。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ awsmfa --serial-number arn:aws:iam::123456789012:mfa/my-login-role --profile my-login-profile code-from-token</span><br></pre></td></tr></table></figure><p>MFAの認証情報を扱うプロファイル名はデフォルトで <code>mfa</code> としています。(別のプロファイル名で保存したい場合はオプションに <code>--mfa-profile-name</code> を指定します。)上記の <code>awsfma ...</code> コマンドを実行すると以下のように <code>mfa</code> のプロファイル名が追加されます。2回目以降は <code>~/.aws/credentials</code> の <code>mfa</code> プロファイル名の値を更新するようになっています。</p><ul><li><code>~/.aws/config</code></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[default]</span></span><br><span class="line"><span class="attr">region</span> = us-east-<span class="number">1</span></span><br><span class="line"><span class="attr">output</span> = json</span><br><span class="line"></span><br><span class="line">[profile mfa] &lt;- このプロファイル名が追加されます</span><br></pre></td></tr></table></figure><ul><li><code>~/.aws/credentials</code></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[default]</span></span><br><span class="line"><span class="attr">aws_access_key_id</span>     = ABCDEFGHIJKLMNOPQRST</span><br><span class="line"><span class="attr">aws_secret_access_key</span> = ChEXAMPLEraRNW5iy8XgDyR4QNRT44kKRPmKEGQT</span><br><span class="line"></span><br><span class="line">[mfa] &lt;- このプロファイル名が追加されます。2回目以降は自動でこのプロファイルの中身を更新します</span><br><span class="line"><span class="attr">aws_access_key_id</span>     = AKIAIOSFODNN7EXAMPLE</span><br><span class="line"><span class="attr">aws_secret_access_key</span> = wJalrXUtnFEMI/K7MDENG/bPxRfiCYzEXAMPLEKEY</span><br><span class="line"><span class="attr">aws_session_token</span>     = AQoEXAMPLEH4aoAH0gNCAPyJxz4BlCFFxWNE1OPTgk5TthT+FvwqnKwRcOIfrRh3c/LTo6UDdyJwOOvEVPvLXCrrrUtdnniCEXAMPLE/IvU1dYUg2RVAJBanLiHb4IgRmpRV3zrkuWJOgQs8IZZaIv2BXIa2R4OlgkBN9bkUDNCJiBeb/AXlzBBko7b15fjrBs2+cTQtpZ3CYWFXG8C5zqx37wnOE49mRl/+OtkIKGO7fAE</span><br></pre></td></tr></table></figure><h3 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h3><p>Linuxの場合はシェルスクリプト一発でローカル環境にインストールできます。このコマンドラインツールはGoで書かれており、マルチプラットフォーム向けにシングルバイナリを簡単に提供できます。インストールが簡単に行えるのはとても良いですね。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sfL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;future-architect&#x2F;awsmfa&#x2F;master&#x2F;install.sh | sudo sh -s -- -b &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure><p>Windowsの場合は <a href="https://github.com/future-architect/awsmfa/releases">Releases</a> から最新のバイナリを取得して、パスが通っているディレクトリにバイナリを配備してください。</p><h3 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h3><p>AWS CLIで用いるMFAの運用をちょっとだけ楽にするツールを作りました。</p><p>やろうと思えばシェル芸でもできそうですし、<code>99designs/aws-vault</code> や <code>broamski/aws-mfa</code> などのよりリッチなOSSもあります。今回は自分たちのユースケースのために作ったツールを公開しました。</p><p>さっそくプルリクエストもいただきました。社外の方からも使っていただき嬉しく思います。</p><p><a href="https://github.com/future-architect/awsmfa/pull/9">https://github.com/future-architect/awsmfa/pull/9</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;/images/20210426a/access-3579221_640.jpg&quot; class=&quot;img-middle-size&quot;&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/mohamed_</summary>
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="AWS" scheme="https://future-architect.github.io/tags/AWS/"/>
    
    <category term="OSS" scheme="https://future-architect.github.io/tags/OSS/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="OSS推進タスクフォース" scheme="https://future-architect.github.io/tags/OSS%E6%8E%A8%E9%80%B2%E3%82%BF%E3%82%B9%E3%82%AF%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>実世界データの特徴と処理方法</title>
    <link href="https://future-architect.github.io/articles/20210423b/"/>
    <id>https://future-architect.github.io/articles/20210423b/</id>
    <published>2021-04-22T15:00:01.000Z</published>
    <updated>2021-04-23T02:24:48.050Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。TIG DXユニットの村上です。</p><p>私は大学時代から深層強化学習の研究をしていますが、分野的にほとんど実世界のデータを扱うことがありませんでした。そんな私ですが、実務で実世界データの分析を行う機会があり、その違いに多くの学びがありました。</p><p>実世界データのデータ分析を行った結果見えてきた、実世界データの特徴と欠損値や不正データの処理について解説しようと思います。</p><p>簡易的ですがソースコードも示していますので、参考になれば幸いです。</p><h1 id="実世界データとは"><a href="#実世界データとは" class="headerlink" title="実世界データとは"></a>実世界データとは</h1><img src="/images/20210423b/search-4083722_640.jpg" class="img-middle-size"><blockquote><p><a href="https://pixabay.com/ja/users/mohamed_hassan-5229782/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4083722">mohamed Hassan</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4083722">Pixabay</a>からの画像</p></blockquote><p>内容に入る前に、本記事での実世界データの定義を行っておきます。ここでは以下2点を満たすものを実世界データと呼ぶことにします。</p><ul><li>もともとはアナログデータである</li><li>データ品質を高める処理が行われていない生のデータ</li></ul><p>例えば身近なものだと、温度計や湿度計から取得されたデータは実世界データとなります。これらに欠損値補完<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>などのデータ品質を高める処理を施した後は実世界データと呼ばないことにします。</p><p>また、機械学習用のデータセットや、システムのモニタリングデータなどは実世界データではありません。</p><h1 id="実世界データの品質"><a href="#実世界データの品質" class="headerlink" title="実世界データの品質"></a>実世界データの品質</h1><p>実世界データのデータ品質は基本的に<code>悪い</code>です。欠損値が含まれていたり、不正なデータが存在するのが当たり前です。主な理由は物理的、人間の意志的な影響を受けるからです。これらの作用により、主に以下2ケースのデータ品質悪化が起こります。</p><ol><li><a href="#%E2%91%A0%E6%AC%A0%E6%90%8D%E5%80%A4%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B">欠損値が発生する</a></li><li><a href="#%E2%91%A1%E4%B8%8D%E6%AD%A3%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%B7%B7%E5%85%A5%E3%81%99%E3%82%8B">不正なデータが混入する</a></li></ol><p>これらの発生原因と対処法について解説します。</p><h2 id="①欠損値が発生する"><a href="#①欠損値が発生する" class="headerlink" title="①欠損値が発生する"></a>①欠損値が発生する</h2><p>例えば、データの発生源であるIoTデバイスが屋外に設置されている場合、気象の影響を受けます。台風の時に固いものが飛んできてIoTデバイスに直撃、データを送信できなくなるなんてことも有り得ます。また、単純に電波不良などでデータがサーバに到達しなかったという状況も十分あり得ます。</p><p>このように挙げたらきりがありませんが、実世界ではデータがが発生したにも関わらずそれが取得できないことがよくあります。</p><h2 id="欠損値処理"><a href="#欠損値処理" class="headerlink" title="欠損値処理"></a>欠損値処理</h2><p>欠損値の処理に関しては、そのデータを使ってどのような分析を行うかで適切な処理の仕方が変わってきます。ここでは様々な処理方法とそのユースケースを解説します。</p><h3 id="欠損値を削除する"><a href="#欠損値を削除する" class="headerlink" title="欠損値を削除する"></a>欠損値を削除する</h3><p>欠損値が無視できるものであれば、削除してしまうのが手っ取り早いです。ではどのような時に無視しても良いのかですが、以下のケースがそれにあたります。</p><ol><li>後続のデータ分析で利用しない</li><li>データ数が減っても問題ない</li></ol><p>1番は分りやすいと思いますが、2番は要注意です。極端な例ではありますが、以下のような天気と気温のデータがあるとします。</p><p>見ての通り、データの発生源である温度計は雨が降ると高確率でデータを取得できない残念な仕様になっていたとします。</p><table><thead><tr><th align="center">データ</th><th align="center">1</th><th align="center">2</th><th align="center">3</th><th align="center">4</th><th align="center">5</th><th align="center">6</th><th align="center">7</th><th align="center">8</th><th align="center">9</th></tr></thead><tbody><tr><td align="center"><strong>天気</strong></td><td align="center">晴れ</td><td align="center">晴れ</td><td align="center">晴れ</td><td align="center">雨</td><td align="center">雨</td><td align="center">雨</td><td align="center">曇り</td><td align="center">曇り</td><td align="center">曇り</td></tr><tr><td align="center"><strong>気温</strong></td><td align="center">25℃</td><td align="center">24℃</td><td align="center">26℃</td><td align="center"></td><td align="center"></td><td align="center">18℃</td><td align="center">18℃</td><td align="center">20℃</td><td align="center">19℃</td></tr></tbody></table><p>このような温度計から得られたデータに対して欠損値削除を行い、気温から天気を予測するモデルを構築するとしたらどうなるでしょうか？おそらくそのモデルの予測結果は晴れか曇りのみになります。雨のデータがほとんど存在しないので、とりあえず晴れか曇りと予測しておけば正答率は高くなるということです。このように、データ数が減ること自体が問題になるケースが存在します。</p><p>以上を踏まえて、欠損値を削除しても問題ない場合はpandasを用いて簡単に削除することができます。<br>例として、以下のデータに対して欠損値削除を行います。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">         name gender  profession</span><br><span class="line"><span class="number">0</span>  Goodfellow    man         NaN</span><br><span class="line"><span class="number">1</span>        Mnih    man  researcher</span><br><span class="line"><span class="number">2</span>      Graves    NaN  researcher</span><br><span class="line"><span class="number">3</span>         NaN    NaN         NaN</span><br></pre></td></tr></table></figure><ul><li>全ての項目が欠損値の場合にその行を削除</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.dropna(how=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">         name gender  profession</span><br><span class="line"><span class="number">0</span>  Goodfellow    man         NaN</span><br><span class="line"><span class="number">1</span>        Mnih    man  researcher</span><br><span class="line"><span class="number">2</span>      Graves    NaN  researcher</span><br></pre></td></tr></table></figure><ul><li>1つでも欠損値があればその行を削除</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.dropna(how=<span class="string">&#x27;any&#x27;</span>)</span><br><span class="line">   name gender  profession</span><br><span class="line"><span class="number">1</span>  Mnih    man  researcher</span><br></pre></td></tr></table></figure><h3 id="特定の値で補完する"><a href="#特定の値で補完する" class="headerlink" title="特定の値で補完する"></a>特定の値で補完する</h3><p>欠損値が削除できない場合、何らかの値で補完します。どのような値で補完するかはそのデータに対してどのような分析を行うかに依存するため、目的をよく考えて補完する値を選ぶ必要があります。補完する値の候補と主なユースケースは以下です。</p><ul><li>固定値：その項目に表れる値があらかじめ決まっている場合</li><li>平均値：その項目の値の分散が小さい場合</li><li>中央値：その項目の値の分散が大きい場合</li></ul><p>例えば平均値による補完を行う場合は次のようになります。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">    age</span><br><span class="line"><span class="number">0</span>  <span class="number">20.0</span></span><br><span class="line"><span class="number">1</span>  <span class="number">21.0</span></span><br><span class="line"><span class="number">2</span>   NaN</span><br><span class="line"><span class="number">3</span>  <span class="number">22.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.fillna(b.mean())</span><br><span class="line">    age</span><br><span class="line"><span class="number">0</span>  <span class="number">20.0</span></span><br><span class="line"><span class="number">1</span>  <span class="number">21.0</span></span><br><span class="line"><span class="number">2</span>  <span class="number">21.0</span></span><br><span class="line"><span class="number">3</span>  <span class="number">22.0</span></span><br></pre></td></tr></table></figure><h3 id="一定のアルゴリズムに従って補完する"><a href="#一定のアルゴリズムに従って補完する" class="headerlink" title="一定のアルゴリズムに従って補完する"></a>一定のアルゴリズムに従って補完する</h3><p>欠損値が一定のアルゴリズムに従って推定できる場合、以下の補完方法が有効です。</p><ul><li>線形補完：前後のデータ間の中間の値で補完</li><li>スプライン補完：スプライン曲線を用いて値を推定</li></ul><p>例えば線形補完をする場合は以下のようになります。今回は分りやすいようにmethodを明示的に指定していますが、デフォルトで<code>linear</code>なので、線形補完する場合はmethodの指定は省略可能です。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">    age</span><br><span class="line"><span class="number">0</span>  <span class="number">20.0</span></span><br><span class="line"><span class="number">1</span>  <span class="number">21.0</span></span><br><span class="line"><span class="number">2</span>   NaN</span><br><span class="line"><span class="number">3</span>  <span class="number">22.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.interpolate(method=<span class="string">&#x27;linear&#x27;</span>)</span><br><span class="line">    age</span><br><span class="line"><span class="number">0</span>  <span class="number">20.0</span></span><br><span class="line"><span class="number">1</span>  <span class="number">21.0</span></span><br><span class="line"><span class="number">2</span>  <span class="number">21.5</span></span><br><span class="line"><span class="number">3</span>  <span class="number">22.0</span></span><br></pre></td></tr></table></figure><p>これら以外にも様々な補完アルゴリズムが存在します。いずれもpandasで簡単に行うことができるので、<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.interpolate.html">公式ドキュメント</a>を参考にしてみてください。</p><h2 id="②不正なデータが混入する"><a href="#②不正なデータが混入する" class="headerlink" title="②不正なデータが混入する"></a>②不正なデータが混入する</h2><p>このケースはデータの生成過程で人間による入力が存在する場合、容易に発生し得るものです。また、データの生成過程に人間が介入しないとしても、何らかの事情でデータを手動で作成して差し込む場合もあります。</p><p>このケースの厄介な点は、それが正しいデータなのか、不正なデータなのかの判断が難しいことです。理論上有り得ないデータであればバリデーションチェックを行うことで正確に判断できるのですが、そうでない場合は不正なデータであることに気づくことが困難です。仮に怪しいデータを発見したとしても、それが不正なデータである裏付けを取るためには、そのデータの生成過程を精査する必要があり、多くの手間がかかります。</p><h3 id="不正データの検出方法"><a href="#不正データの検出方法" class="headerlink" title="不正データの検出方法"></a>不正データの検出方法</h3><p>次に不正なデータの検出方法を説明します。以下のフローチャートに従ってデータをチェックするのが効率的です。</p><p><img src="/images/20210423b/flow_chart.png"></p><p>①番、②番について詳しく見ていきます。</p><h4 id="①理論上有り得るデータかチェック（バリデーションチェック）"><a href="#①理論上有り得るデータかチェック（バリデーションチェック）" class="headerlink" title="①理論上有り得るデータかチェック（バリデーションチェック）"></a>①理論上有り得るデータかチェック（バリデーションチェック）</h4><p>この段階では確実に不正であるデータを検出します。そのために、まずは正しいデータとはどのようなデータかをしっかりと定義する必要があります。この定義に間違いがあると、本当は正しいデータでも不正なデータとして検出されてしまう可能性があります。さらに、そのデータの発生源に対して何らかのシステム的、人間の意思決定的な側面から変更が加わる場合、同時に正しいデータの定義にも変更が必要な可能性があります。</p><p>従って、正しいデータの定義は一度決めたらそれで終了ではなく、適時変更が入ることを前提とするのがベターです。</p><p>次にバリデーションチェックのやり方ですが、これはpandera<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>というpandasの拡張ライブラリを使うのがおすすめです。以下のように正しいデータの値域などを定義し、定義を満たさないものを検出することができます。</p><p>以下は<a href="https://pandera.readthedocs.io/en/stable/">pandera公式ドキュメント</a>からの引用です。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pandera <span class="keyword">import</span> Column, DataFrameSchema, Int, Check</span><br><span class="line"></span><br><span class="line">simple_schema = DataFrameSchema(&#123;</span><br><span class="line">    <span class="string">&quot;column1&quot;</span>: Column(</span><br><span class="line">        Int, Check(<span class="keyword">lambda</span> x: <span class="number">0</span> &lt;= x &lt;= <span class="number">10</span>, element_wise=<span class="literal">True</span>,  <span class="comment"># ここで正しいデータを定義</span></span><br><span class="line">                   error=<span class="string">&quot;range checker [0, 10]&quot;</span>))  <span class="comment"># 弾かれた際のメッセージも定義できる</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># データをDataFrameに入力</span></span><br><span class="line">fail_check_df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&quot;column1&quot;</span>: [-<span class="number">20</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">30</span>],  <span class="comment"># 0 &lt;= x &lt;= 10 が正しいデータなので、-20と30は不正データ</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">simple_schema(fail_check_df)  <span class="comment"># バリデーションチェックを実行</span></span><br></pre></td></tr></table></figure><p>バリデーションチェックの実行結果は次のようになります。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">SchemaError: &lt;Schema Column: <span class="string">&#x27;column1&#x27;</span> <span class="built_in">type</span>=<span class="built_in">int</span>&gt; failed element-wise validator <span class="number">0</span>:</span><br><span class="line">&lt;Check &lt;<span class="keyword">lambda</span>&gt;: <span class="built_in">range</span> checker [<span class="number">0</span>, <span class="number">10</span>]&gt;</span><br><span class="line">failure cases:</span><br><span class="line">   index  failure_case</span><br><span class="line"><span class="number">0</span>      <span class="number">0</span>           -<span class="number">20</span></span><br><span class="line"><span class="number">1</span>      <span class="number">3</span>            <span class="number">30</span></span><br></pre></td></tr></table></figure><h4 id="②データの分布から逸脱していないかチェック"><a href="#②データの分布から逸脱していないかチェック" class="headerlink" title="②データの分布から逸脱していないかチェック"></a>②データの分布から逸脱していないかチェック</h4><p>①番で弾かれなかったデータは必ず正しいデータという訳ではありません。理論上有り得るデータだが、入力ミスなどで真のデータと少し異なってしまうケースもあります。</p><p>このような、バリデーションチェックで検出できなかったデータから不正データを見つけるのはものによりますが、一般的には難しいと思います。ここではデータの分布という観点から、不正データの検出手法を解説します。</p><h5 id="データをソートして検出"><a href="#データをソートして検出" class="headerlink" title="データをソートして検出"></a>データをソートして検出</h5><p>一番簡単な方法として、データを昇順や降順に並べ替えて、明らかに他のデータの値から逸脱しているものを検出するというものがあります。エクセルでも簡単に行うことができるため、まずはこの方法から入ると良いかもしれません。</p><p>この手法はお手軽に行うことができる一方で、統計学的妥当性はありません。本質的には人間の感覚による判断になっているため、注意が必要です。</p><h5 id="正規分布による外れ値検出"><a href="#正規分布による外れ値検出" class="headerlink" title="正規分布による外れ値検出"></a>正規分布による外れ値検出</h5><p>データが正規分布<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>に従う場合、この手法が有効です。正規分布では <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex" xmlns="http://www.w3.org/2000/svg" width="6.553ex" height="1.995ex" role="img" focusable="false" viewBox="0 -666 2896.4 882" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-4-TEX-I-1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"></path><path id="MJX-4-TEX-N-B1" d="M56 320T56 333T70 353H369V502Q369 651 371 655Q376 666 388 666Q402 666 405 654T409 596V500V353H707Q722 345 722 333Q722 320 707 313H409V40H707Q722 32 722 20T707 0H70Q56 7 56 20T70 40H369V313H70Q56 320 56 333Z"></path><path id="MJX-4-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-4-TEX-I-1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-4-TEX-I-1D707"></use></g><g data-mml-node="mo" transform="translate(825.2, 0)"><use xlink:href="#MJX-4-TEX-N-B1"></use></g><g data-mml-node="mn" transform="translate(1825.4, 0)"><use xlink:href="#MJX-4-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(2325.4, 0)"><use xlink:href="#MJX-4-TEX-I-1D70E"></use></g></g></g></svg></mjx-container> 以内にデータの約95%、 <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex" xmlns="http://www.w3.org/2000/svg" width="6.553ex" height="1.995ex" role="img" focusable="false" viewBox="0 -666 2896.4 882" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-3-TEX-I-1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"></path><path id="MJX-3-TEX-N-B1" d="M56 320T56 333T70 353H369V502Q369 651 371 655Q376 666 388 666Q402 666 405 654T409 596V500V353H707Q722 345 722 333Q722 320 707 313H409V40H707Q722 32 722 20T707 0H70Q56 7 56 20T70 40H369V313H70Q56 320 56 333Z"></path><path id="MJX-3-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-3-TEX-I-1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-3-TEX-I-1D707"></use></g><g data-mml-node="mo" transform="translate(825.2, 0)"><use xlink:href="#MJX-3-TEX-N-B1"></use></g><g data-mml-node="mn" transform="translate(1825.4, 0)"><use xlink:href="#MJX-3-TEX-N-33"></use></g><g data-mml-node="mi" transform="translate(2325.4, 0)"><use xlink:href="#MJX-3-TEX-I-1D70E"></use></g></g></g></svg></mjx-container> 以内に約99.7%が含まれることが知られています。※ <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex" xmlns="http://www.w3.org/2000/svg" width="1.364ex" height="1.489ex" role="img" focusable="false" viewBox="0 -442 603 658" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D707"></use></g></g></g></svg></mjx-container> は平均、 <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.025ex" xmlns="http://www.w3.org/2000/svg" width="1.292ex" height="1ex" role="img" focusable="false" viewBox="0 -431 571 442" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D70E"></use></g></g></g></svg></mjx-container> は標準偏差</p><p><img src="/images/20210423b/image.png"></p><p>引用：<a href="https://ai-trend.jp/basic-study/normal-distribution/normal-distribution/">https://ai-trend.jp/basic-study/normal-distribution/normal-distribution/</a></p><p>従って、これらを逸脱したデータを不正データの可能性有りとみなすのは、一定の統計学的妥当性があります。</p><p>実装例として、<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.025ex" xmlns="http://www.w3.org/2000/svg" width="2.423ex" height="1.532ex" role="img" focusable="false" viewBox="0 -666 1071 677" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1-TEX-I-1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mn"><use xlink:href="#MJX-1-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(500, 0)"><use xlink:href="#MJX-1-TEX-I-1D70E"></use></g></g></g></svg></mjx-container>を越えたものが検出される様子を以下に示します。10番目の<code>10000</code>のデータが外れ値（不正データ）の想定です。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>df</span><br><span class="line">    price</span><br><span class="line"><span class="number">0</span>     <span class="number">100</span></span><br><span class="line"><span class="number">1</span>     <span class="number">200</span></span><br><span class="line"><span class="number">2</span>     <span class="number">100</span></span><br><span class="line"><span class="number">3</span>      <span class="number">50</span></span><br><span class="line"><span class="number">4</span>     <span class="number">120</span></span><br><span class="line"><span class="number">5</span>     <span class="number">200</span></span><br><span class="line"><span class="number">6</span>     <span class="number">150</span></span><br><span class="line"><span class="number">7</span>     <span class="number">100</span></span><br><span class="line"><span class="number">8</span>      <span class="number">80</span></span><br><span class="line"><span class="number">9</span>      <span class="number">20</span></span><br><span class="line"><span class="number">10</span>  <span class="number">10000</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>mean = df.mean()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>std = df.std()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>df[<span class="string">&#x27;price&#x27;</span>] &gt; (mean + <span class="number">2</span> * std).values[<span class="number">0</span>]</span><br><span class="line"><span class="number">0</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">1</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">2</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">3</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">4</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">5</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">6</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">7</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">8</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">9</span>     <span class="literal">False</span></span><br><span class="line"><span class="number">10</span>     <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>10番目のデータがTrueになり、外れ値（不正データ）が検出できています。</p><h3 id="不正データの再発防止"><a href="#不正データの再発防止" class="headerlink" title="不正データの再発防止"></a>不正データの再発防止</h3><p>不正データを検出し、それらに対して削除などの対応を行った場合、それで終わりではまた再発する可能性があります。</p><p>例えば、不正データの発生原因が人間の介入によるものであった場合、人間が介入する割合を最小限に抑えるようシステム化を進める、人間が介入した際はそのデータのチェックを2人以上で行うなど、人間の作業フローを交えて不正データが発生しない仕組み作りを行う必要があります。</p><p>また、不正データの発生原因がシステムの故障によるものである場合、そのシステムを監視し、異常が検知された場合はその期間のデータを別の場所に隔離するなどの対応が必要になると思います。</p><p>このように、不正データを検知した際は、恒久、暫定的な再発防止策を早急に考える必要があります。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>今回は実世界データの品質が悪いことと、その対処法について解説しました。</p><p>これからの時代は増々データの品質が重視されると思いますので、引き続きデータに対する知識を深めていきたいと思います！</p><p>最後まで読んでくださり、ありがとうございました！</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">欠損値補完： <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.interpolate.html">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.interpolate.html</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;">pandera： <a href="https://pandera.readthedocs.io/en/stable/">https://pandera.readthedocs.io/en/stable/</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;">正規分布の性質： <a href="https://ai-trend.jp/basic-study/normal-distribution/normal-distribution/">https://ai-trend.jp/basic-study/normal-distribution/normal-distribution/</a></span><a href="#fnref:3" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。TIG DXユニットの村上です。&lt;/p&gt;
&lt;p&gt;私は大学時代から深層強化学習の研究をしていますが、分野的にほとんど実世界のデータを扱うことがありませんでした。そんな私ですが、実務で実世界データの分析を行う機会があり、その違いに多くの学びがありました。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="DataScience" scheme="https://future-architect.github.io/categories/DataScience/"/>
    
    
    <category term="データ分析" scheme="https://future-architect.github.io/tags/%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90/"/>
    
    <category term="データ品質" scheme="https://future-architect.github.io/tags/%E3%83%87%E3%83%BC%E3%82%BF%E5%93%81%E8%B3%AA/"/>
    
    <category term="欠損値" scheme="https://future-architect.github.io/tags/%E6%AC%A0%E6%90%8D%E5%80%A4/"/>
    
  </entry>
  
</feed>
