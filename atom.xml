<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>フューチャー技術ブログ</title>
  
  <subtitle>Future Tech Blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://future-architect.github.io/"/>
  <updated>2020-09-18T10:17:48.496Z</updated>
  <id>https://future-architect.github.io/</id>
  
  <author>
    <name>Future Architect Consultants</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Future Engineer Camp 2020 参加記</title>
    <link href="https://future-architect.github.io/articles/20200920/"/>
    <id>https://future-architect.github.io/articles/20200920/</id>
    <published>2020-09-19T15:00:00.000Z</published>
    <updated>2020-09-18T10:17:48.496Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200920/factory-3550550_1280.png"><p><a href="https://pixabay.com/ja/users/ArtsyBee-462611/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3550550" target="_blank" rel="noopener">Oberholster Venita</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3550550" target="_blank" rel="noopener">Pixabay</a>からの画像</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。Future Engineer Camp 2020に参加しました齋藤です。<br>インターンシップやその前のできごとを書いていきます。</p><p>なお、今回隣のチームのインターン生だった中山さんの記事が既に技術ブログにあります。そちらもぜひ参考にしてください。</p><ul><li><a href="https://future-architect.github.io/articles/20200913/">フューチャーの2020 夏季インターンに参加してみた</a></li></ul><h2 id="インターンシップ参加前の技術経験"><a href="#インターンシップ参加前の技術経験" class="headerlink" title="インターンシップ参加前の技術経験"></a>インターンシップ参加前の技術経験</h2><p>インターンシップに参加する前の技術経験は次の通りです。</p><ul><li>使用言語: <ul><li>C++: 競技プログラミング、研究、授業</li><li>Python3: 趣味、授業</li><li>Go: 入門書を一通り終えた</li></ul></li><li>開発経験: 技術系アルバイト、インターン一切なし</li><li>資格: 応用情報技術者</li></ul><p>このように、開発を業務として行ったことはない状態でした。</p><h2 id="インターン前"><a href="#インターン前" class="headerlink" title="インターン前"></a>インターン前</h2><h3 id="参加するきっかけ"><a href="#参加するきっかけ" class="headerlink" title="参加するきっかけ"></a>参加するきっかけ</h3><p>私は競技プログラミング（競プロ）に取り組んでおり、競プロサイトAtCoderと就活支援サイトであるサポーターズ共催のインターン説明会イベントに参加しました。いくつかの企業の説明を受けた上で、フューチャーが</p><ul><li>ITコンサルながら、開発、実装、運用まで行っており、高い技術力を持った方が多数在籍していること</li><li>「初めてに挑戦する」「ないものはつくる」といった理念に惹かれたこと</li><li>インターンが4週間と結構長く、学びが多そうと感じたこと</li></ul><p>などの理由でフューチャーのインターンに参加したいと思いました。</p><h3 id="インターン選考"><a href="#インターン選考" class="headerlink" title="インターン選考"></a>インターン選考</h3><p>インターンの説明はこちらをご覧ください。<br><a href="https://future-architect.github.io/articles/20200606/">フューチャー夏のインターン2020。リモート開催予定です</a></p><p>技術系のインターンEngineer Campは10個のコースに分かれており、②スマート工場IoT設計開発を選択しました。理由としてはバックエンド開発に興味があり、また、研究がIoTに関係していたからです。</p><p>選考はES+コーディング試験→オンライン面接1回でした。面接は受入プロジェクトから2名が面接官で、研究や技術的な話が中心でした。また、雰囲気は終始和やかで、殺伐な雰囲気は感じませんでした。<br>コーディング試験はほぼ競プロらしい問題で、しかも、後半の問題は結構な難易度だと感じました。フューチャーが競プロの活用に積極的なのは承知していましたが、それでも意外でした。ただ、インターン中に競プロの活用理由として「既存のライブラリやツールの活用では解決できない時に、競プロの力が活きてくる」といった旨の発言を聞き、なるほどと思いました。</p><p>無事合格になり、インターンに参加することが決まりました。</p><h3 id="インターン中"><a href="#インターン中" class="headerlink" title="インターン中"></a>インターン中</h3><p>インターンシップは終始リモートで、4週間行われました。実施時間は平日に1日8時間でした。<br>社員の方々もリモートワークでした。社員さんの中には「プロジェクトの他の社員と実際に会ったことがない」という方もいらっしゃって、リモートワークに完全に対応できていると感じました。Slackやビデオ会議ツールを活用して、業務に取り組みました。</p><h4 id="開発概要"><a href="#開発概要" class="headerlink" title="開発概要"></a>開発概要</h4><p>プロジェクトは工場システムの開発で、物流の状況や製造計画情報を作業員の端にはいったアプリ上で管理・閲覧できることです。私が行ったのは工場システムのアプリのバックエンド開発で、概要は以下の通りです。</p><ul><li>Swaggerを用いたREST API定義</li><li>DynamoDBのテーブルの設計</li><li>ハンドラや、DB操作をGoで実装</li><li>テストの実装、実施　</li></ul><h4 id="使用技術"><a href="#使用技術" class="headerlink" title="使用技術"></a>使用技術</h4><p>次の技術を使用しました。</p><ul><li>Go言語</li><li>Swagger (go-swagger)</li><li>AWS<ul><li>DynamoDB</li><li>Lambda</li><li>API Gateway</li></ul></li></ul><p>また、開発環境として、次のものを使用しました。</p><ul><li>Git / GitHub</li><li>CircleCI</li></ul><h4 id="学んだこと"><a href="#学んだこと" class="headerlink" title="学んだこと"></a>学んだこと</h4><p>4週間で多くのことを、技術面、開発面のそれぞれで学べたと思います。まずは技術面から。</p><ul><li>Go言語での開発のお作法（エラーハンドリング等）<ul><li>コードレビューを受けたり、既存のコードを読んだりして、身に付けました</li></ul></li><li>Table Driven Test(TDT)の仕方<ul><li>コードが書きやすいし、読みやすい</li></ul></li><li>DynamoDBや、LambdaなどのAWS技術の理解<ul><li>DynamoDB(NoSQL）のキーの種類、特徴</li></ul></li></ul><p>綺麗なコーディングや、テストは、趣味での開発ではおろそかになりがちですが、しっかりと学べたと思います。<br>続いて、開発面です。</p><ul><li>GitHubを用いた開発手法</li><li>ドキュメント整備<ul><li>GitHubにdocs/にまとめられていて、随時更新</li></ul></li><li>Circle CIを用いたテストの設定方法</li><li>Slackでのコミュニケーション</li></ul><p>チーム開発の流れや、コミュニケーションツールの活用方法を学べましたし、今後も活用できると感じました。</p><h3 id="感想・振り返り"><a href="#感想・振り返り" class="headerlink" title="感想・振り返り"></a>感想・振り返り</h3><p>インターン全体を通して、次のことを感じました。</p><ul><li>バックエンド開発を実際に近い業務ができ、業務のイメージが掴めた</li><li>Go言語は書きやすいし、読みやすい<ul><li>今後も学んでいきたい言語</li></ul></li><li>決められた時間内に仕事を行うことの大変さ<ul><li>だらけずに時間内にパフォーマンスを発揮する重要性を感じました</li></ul></li><li>タスクの割り当てが親切で、成長を実感できた<ul><li>タスクが修正→実装→設計＋実装とステップアップしていくのが良かったです</li></ul></li><li>Future Tech Blogがとても参考になった<ul><li>開発で困って検索したときにトップに出ることがよくありました</li><li>積極的な技術発信は好印象でした</li></ul></li></ul><p>まずはバックエンド開発の主要な技術や、開発について、多数の学びがありました。社員さんからのコメントなどからの収穫も多く、インターンに参加して良かったと感じました。<br>また、コミュニケーションの重要性も感じました。ドキュメントが十分に整っていても、新たに機能を追加するときなどには社員さんとのやりとりは必要不可欠でしたし、特にわからないことを明確にすることが重要だと感じました。</p><p>今回のインターンで多方面のことで多くの学び、気づきがあったと実感しました。</p><h2 id="今後に向けて"><a href="#今後に向けて" class="headerlink" title="今後に向けて"></a>今後に向けて</h2><p>次のことを今後取り組みたいと思っています。</p><ul><li>開発でのコミュニケーション能力を磨く<ul><li>作業ログの作成等を積極的に行う（特にリモートワークで重要）</li><li>分からないこと・行ったことを明確にして伝える</li></ul></li><li>学んだ技術を個人で一から使ってみる<ul><li>swaggerの環境構築など</li><li>インフラ面の理解も深めたい</li></ul></li></ul><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>実際の開発業務の形で様々なタスクを取り組み、様々なコメントを頂いたことは大きな学びになりました。</p><p>受け入れてくれたプロジェクトのみなさま、HRのみなさま本当にありがとうござました。</p><img src="/images/20200920/発表.png"><img src="/images/20200920/集合.png">]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200920/factory-3550550_1280.png&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/ArtsyBee-462611/?utm_source=link-attribution
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="工場" scheme="https://future-architect.github.io/tags/%E5%B7%A5%E5%A0%B4/"/>
    
      <category term="インターン" scheme="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>Engineer CampでSQLフォーマッタを開発しました</title>
    <link href="https://future-architect.github.io/articles/20200919/"/>
    <id>https://future-architect.github.io/articles/20200919/</id>
    <published>2020-09-18T15:00:00.000Z</published>
    <updated>2020-09-18T09:01:12.447Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして。フューチャーのインターン”Engineer Camp”に参加した中村と申します。</p><p>フューチャーのインターンについては<a href="https://future-architect.github.io/articles/20200606/">こちらの記事</a>をご覧ください！</p><p>この記事では、今回のインターンで私が取り組んだ内容を紹介します。</p><h1 id="SQLフォーマッタとは"><a href="#SQLフォーマッタとは" class="headerlink" title="SQLフォーマッタとは"></a>SQLフォーマッタとは</h1><p>今回のインターンで私は、SQLフォーマッタの作成に取り組みました。<br>SQLフォーマッタとは以下のようにSQLのインデントなど整形するツールのことです。</p><img src="/images/20200919/formatter.jpg" class="img-middle-size"><p>SQLフォーマッタを用いることで、SQLの見た目を整える手間を削減したり、チームで統一感があるコーディングを実現できます。</p><h1 id="取り組んだ課題"><a href="#取り組んだ課題" class="headerlink" title="取り組んだ課題"></a>取り組んだ課題</h1><p>もともとフューチャーではuroboroSQL formatterというSQLフォーマッタが開発されていました。（このフォーマッタについては<a href="https://future-architect.github.io/articles/20170228/">こちらの記事</a>をご覧ください！）</p><p>しかし、このフォーマッタはPythonベースで書かれていたため、（現在広く使われているエディタである）VSCodeの拡張機能として動かすことが困難でした。</p><p>そこで、uroboroSQL formatterの後継として、新しいフォーマッタを作成しようと今回のプロジェクトが始まりました。</p><p>新しいフォーマッタが満たすべき条件として、次の3つがあります：</p><ul><li>VSCode上で動く</li><li>2-Way SQL<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>のフォーマットに対応している（≒式中にコメントが入ってもフォーマットが崩れない）</li><li>カラムやAS句等の縦ぞろえに対応している</li></ul><p>これらの条件を満たすフォーマッタを作成することが、今回のインターンでの課題でした。</p><h1 id="使用したOSS"><a href="#使用したOSS" class="headerlink" title="使用したOSS"></a>使用したOSS</h1><p>今回の開発では、すべてのコードを一から書くことはせず、利用できるツールは使っていく方針を取りました。具体的には、以下に示す2つのOSSを使いました。</p><h2 id="Prettier"><a href="#Prettier" class="headerlink" title="Prettier"></a>Prettier</h2><p>PrettierとはVSCodeなど様々なエディタで動作する、OSSのコードフォーマッタです。Prettier単体でもHTMLやCSSといった言語をフォーマットできるのですが、プラグインを作成することで、フォーマット可能な言語をさらに増やすことができます。</p><p>今回のSQLフォーマッタは、このPrettierプラグインとして開発を行いました。このようにすることで、VSCodeからフォーマット対象のコードを取得する処理や、フォーマットしたコードをVSCode上に反映する処理などをPrettierが代わりに行ってくれるため、フォーマット処理に集中して開発を行うことができます。また、Prettierが動作する他のエディタに対しても、今回作成したフォーマッタが使えるというメリットもあります。</p><h2 id="ANTLR"><a href="#ANTLR" class="headerlink" title="ANTLR"></a>ANTLR</h2><p>ANTLRはパーサ（構文解析器）を生成するためのOSSです。パーサとは、コードの処理構造を解析し、結果をASTという表現で出力するプログラムです。（ANTLRやパーサに関する詳しい説明は<a href="https://future-architect.github.io/articles/20200903/">こちらの記事</a>をご覧ください）<br>今回のフォーマッタではパーサとプリンタという二つのプログラムを使用するのですが、そのうちの一つをANTLRで自動生成してしまおう！という作戦です。</p><h1 id="フォーマッタの構成"><a href="#フォーマッタの構成" class="headerlink" title="フォーマッタの構成"></a>フォーマッタの構成</h1><p>今回作成したフォーマッタによる、フォーマット処理の流れを下図に示します。</p><p><img src="/images/20200919/format-flow1.PNG" alt=""></p><p>フォーマット処理は2つのステップからなり、パーサとプリンタという2つのプログラムを用います。</p><p>第1ステップでは、パーサがフォーマット対象のSQLコードを受け取り、コードをASTという表現に変換します。</p><p><img src="/images/20200919/format-flow2.PNG" alt=""></p><p>第2ステップでは、プリンタがASTを受け取り、ASTの情報をもとにフォーマットされたコードを出力します。</p><p><img src="/images/20200919/format-flow3.PNG" alt=""></p><p>この2ステップを組み合わせることで、SQLを入力として受け取り、成形したものを出力するという、フォーマッタの動作が実現できます！</p><p><img src="/images/20200919/format-flow4.PNG" alt=""></p><h1 id="行った作業"><a href="#行った作業" class="headerlink" title="行った作業"></a>行った作業</h1><h2 id="プリンタの開発"><a href="#プリンタの開発" class="headerlink" title="プリンタの開発"></a>プリンタの開発</h2><p>今回のインターンで、私は主にプリンタ（受け取ったASTをもとに、コードを成型して出力するプログラム）の開発を行いました。<br>PrettierプラグインとしてSQLフォーマッタの開発を行ったので、基本的な部分は他のプラグインを参考にすることができたのですが、縦ぞろえや式中コメントへの対応といった独自の機能については、一から実装を行いました。</p><h2 id="ANTLRの高速化"><a href="#ANTLRの高速化" class="headerlink" title="ANTLRの高速化"></a>ANTLRの高速化</h2><p>開発をしていく中で、SQLのパース処理にかかる時間がありえないほど長いという問題が発生しました。<br>メンターの方と調査を行った結果、ANTLR内部の実装にミスがあることが判明し、ANTLRのリポジトリにissueが立つという一幕がありました。</p><p><img src="/images/20200919/image_(2).png" alt=""></p><p>現在は<a href="https://github.com/antlr/antlr4/pull/2905" target="_blank" rel="noopener">修正</a>されているのですが、この修正で今まで90分かけても終わらなかった処理が20秒で終わるようになり、特定の条件下において、約270倍（！）の高速化を行うことができました。</p><h1 id="フォーマット結果"><a href="#フォーマット結果" class="headerlink" title="フォーマット結果"></a>フォーマット結果</h1><p>今回作成したフォーマッタでのフォーマット結果を以下に示します。</p><p>フォーマット前のSQLコードです。とても見にくい…。</p><img src="/images/20200919/before.jpg" class="img-middle-size"><p>フォーマット後のSQLコードです。見やすい！</p><img src="/images/20200919/after.jpg" class="img-middle-size"><p>各カラムや条件式が整えられ、見やすくなっています。また、最後のWHERE句のような、式中にコメントがある場合もうまくフォーマットが行われています。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>今回作成したSQLフォーマッタは基本的な構文にしか対応しておらず、実際の業務で使えるレベルにはまだ達していません。<br>それでも、実際にVSCode上で動作するフォーマッタを開発できたことはとても嬉しく、今後の糧になるような経験でした。<br>今回は私が行ったタスクの話が中心になってしまいましたが、Engineer Campでは業務以外にも次のような沢山のイベントがありました:</p><ul><li>社内競技プログラミング部主催のバーチャルコンテスト</li><li>コミュ会・ランチ会（インターン生同士が集まり、ざっくばらんに話す会）</li><li>社内ベテランエンジニアの方々による講義</li><li>インターン生主催のzoom飲み会</li></ul><p>こういったイベントがあったため、リモートであっても実際にフューチャー社でインターンをしているんだという実感が持てました。</p><p>また、業務においても、ペアプログラミングや夕会（一日の終わりに集まり、今日の進捗や明日やることを共有する場）をしていただけたため、たくさんの知見を得ることができたと感じています。</p><p>総じて本当に楽しいインターンで、一か月があっという間でした。</p><p>受け入れ先プロジェクトの方々やフューチャーHRの皆さん、本当にありがとうございました！</p><h1 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h1><p><a href="https://prettier.io/" target="_blank" rel="noopener">https://prettier.io/</a><br><a href="https://www.antlr.org/" target="_blank" rel="noopener">https://www.antlr.org/</a></p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">2-Way SQLの詳細については<a href="https://future-architect.github.io/uroborosql-doc/background/">こちら</a>のドキュメントをご参照ください。</span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;はじめまして。フューチャーのインターン”Engineer Camp”に参加した中村と申します。&lt;/p&gt;
&lt;p&gt;フューチャーの
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="SQL" scheme="https://future-architect.github.io/tags/SQL/"/>
    
      <category term="インターン" scheme="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%B3/"/>
    
      <category term="VSCode" scheme="https://future-architect.github.io/tags/VSCode/"/>
    
      <category term="構文解析" scheme="https://future-architect.github.io/tags/%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Antlr" scheme="https://future-architect.github.io/tags/Antlr/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootでDIを駆使したルールエンジン開発</title>
    <link href="https://future-architect.github.io/articles/20200918/"/>
    <id>https://future-architect.github.io/articles/20200918/</id>
    <published>2020-09-17T15:00:00.000Z</published>
    <updated>2020-09-18T01:41:53.476Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200914/">GlyphFeeds連載企画</a>第5弾の記事となります。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして、2018年新卒入社の渡邉です。</p><p>第5弾はGlyphFeedsCMSにおけるSpringを駆使したルールエンジンについてです！</p><p>新聞業界の多種多様に変化する業務体系に対してどのようにシステムを構築したかご紹介致します。</p><h1 id="新聞社の業務について"><a href="#新聞社の業務について" class="headerlink" title="新聞社の業務について"></a>新聞社の業務について</h1><p>ニュース（＝コンテンツ）を世の中に配信していく過程において、新聞社には大きく次のアクターが関わります。</p><ul><li><strong>記者</strong>：取材活動を元に記事を書く、写真・動画を撮影する</li><li><strong>デスク</strong>：記者から連携された記事や写真・動画を確認し出稿する</li><li><strong>校閲</strong>：記者やデスクから連携された素材に誤りがないか（誤字脱字・事実関係）を確認する</li><li><strong>紙面制作担当</strong>：新聞制作においてレイアウトを調整する</li><li><strong>デジタル配信担当</strong>：デジタルサイト（各社ニュースサイト、スマホアプリなど）向けにコンテンツを編集・配信する</li></ul><p>記者がニュース記事となる素材(テキストや写真)を生み出し、デスクや校閲と渡って紙面制作担当まで届き、</p><p>新聞やニュースサイトに組み上げられるという大枠でのワークフローはあります。</p><p><img src="/images/20200918/%E6%8A%80%E8%A1%93%E3%83%95%E3%82%99%E3%83%AD%E3%82%AF%E3%82%99%E7%B4%A0%E6%9D%901.png" alt=""></p><p>ベースのワークフローをシステムで担保することは当然ですが、</p><p>新聞社では選挙やオリンピックといったイベント事に対して、専用のチーム（≒組織）が組成され、<strong>通常のフローとはことなるワークフローをまわす</strong>ことがよくあります。</p><p><img src="/images/20200918/%E6%8A%80%E8%A1%93%E3%83%95%E3%82%99%E3%83%AD%E3%82%AF%E3%82%99%E7%B4%A0%E6%9D%902.png" alt=""></p><p>各素材に対してアクターがどんなアクションをしたか、素材の属性情報（新聞社では1素材に対して約500程の属性がある）によって全く異なるフロー・処理を行う必要があります。ここで示したフローはごく一部であり、実際の業務では時と場合により<strong>様々な素材に対して様々なワークフローでニュース記事が作られます。</strong></p><p>つまり、まともにシステムを構築しようとすると、莫大なパターンの業務ロジックを実装しないといけない、しかもそのパターンがシステム稼動後も組織変更や業務変更によって増減してしまいます。</p><p>上記のような複雑な業務に対応するため、ビジネスロジックを部品化して自由に組み合わせることができる<strong>ルールエンジン</strong>という仕組みで実現しました。</p><h1 id="ルールエンジンの概要"><a href="#ルールエンジンの概要" class="headerlink" title="ルールエンジンの概要"></a>ルールエンジンの概要</h1><p>GlyphFeedsのルールエンジンの全体概要は以下の図のようになっています。</p><p><img src="/images/20200918/overview.png" alt=""></p><p>GlyphFeedsで管理する素材データに対し、画面などから特定のアクション（例えば保存や出稿など）が実行されると、そのアクションに対応する各条件に素材データがマッチするか判定し、マッチした条件に対応する処理グループが実行されます。</p><p>処理グループ内では、複数の定義済ルールエンジン処理を自由に組み合わせることができ、これによって自動化したい操作を実現しています。</p><h3 id="処理グループ"><a href="#処理グループ" class="headerlink" title="処理グループ"></a>処理グループ</h3><p>処理グループの部分について、実際にはさらにメイン処理グループとサブ処理グループに分かれています。</p><p>メイン処理グループは１つの条件に対して１つ、サブ処理グループは複数定義することができ、サブ処理グループには追加で判定条件を指定できます。メイン処理グループは基本的に同期で、サブ処理グループは非同期で実行されます。メイン処理グループから非同期に設定することも可能です。</p><p><img src="/images/20200918/procgroup.png" alt=""></p><h3 id="処理の定義方法"><a href="#処理の定義方法" class="headerlink" title="処理の定義方法"></a>処理の定義方法</h3><p>上述した内容はすべてRDS登録されたルールエンジン定義に従います。</p><p>各アクション別の処理条件、条件一致した際に実行される処理、各処理に渡すパラメータなどが定義されています。定義アップロード時にファイル内容を解析し、RDS上のテーブルにデータを格納しています。</p><h1 id="どう実現したか？"><a href="#どう実現したか？" class="headerlink" title="どう実現したか？"></a>どう実現したか？</h1><p>さて、ここからはこのルールエンジンが具体的にどのように実装されているのかについて掻い摘んで説明させていただきます。</p><p>以下の図で示す通り、実装上はルールエンジン実行とメイン処理実行、サブ処理実行、処理グループ実行、個別処理に分かれています。画面などで素材に対してアクションが実行されると、ルールエンジン実行のREST APIが呼び出されそこから個別処理が開始します。</p><p><img src="/images/20200918/architecture.png" alt=""></p><h3 id="ルールエンジン実行"><a href="#ルールエンジン実行" class="headerlink" title="ルールエンジン実行"></a>ルールエンジン実行</h3><p>個別処理の実行を担うREST APIです。</p><p>素材の情報と実行に必要なパラメータを受け取り、ルールエンジン定義を読み込んで条件判定を行い実行すべき処理を特定します。そこから、メイン処理実行とサブ処理実行が呼び出されます。</p><h3 id="メイン処理実行・サブ処理実行"><a href="#メイン処理実行・サブ処理実行" class="headerlink" title="メイン処理実行・サブ処理実行"></a>メイン処理実行・サブ処理実行</h3><p>メイン処理実行とサブ処理実行はSpring BootのAsyncスレッドを利用して実装されています。</p><p>長くなってしまうのでここでは詳細は割愛しますが、AsyncスレッドとJava標準のCompletableFutureを組み合わせており、非同期実行でありながらメイン処理実行部分は同期的にレスポンスを返すことができるようになっています。</p><h3 id="処理グループ実行・ルールエンジン個別処理"><a href="#処理グループ実行・ルールエンジン個別処理" class="headerlink" title="処理グループ実行・ルールエンジン個別処理"></a>処理グループ実行・ルールエンジン個別処理</h3><p>ここではSpringのDI（Dependency Injection）の仕組みを利用して、定義に従い実行時に動的に処理を切り替えます。</p><p>各処理グループ内には最大で10個までの処理を定義することができ、定義された順にSpringのDIコンテナから対応するルールエンジン個別処理のBeanを取得して処理を実行していきます。</p><p>各ルールエンジン個別処理の実装クラスは共通のインターフェースをimplementしており、コンテナ登録時のBean IDをルールエンジン定義のIDと紐づけることにより取得するBeanを特定し、定義ベースでのDIを実現しています。これにより、ソースコードに一切手を加えることなく定義のみで柔軟に実行する処理を切り替えることが可能となります。</p><p>ルールエンジン個別処理と処理グループ実行部分の依存関係が疎（動的）になっているため、新たにルールエンジン個別処理を追加するケースでも、1つルールエンジン個別処理を実装し、それをルールエンジン定義に指定するだけですぐに使えるようになりメンテナンス性が高い仕組みとなっています。<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p><p>各処理には共通のデータコンテキストが渡され、処理間のデータのやり取りはすべてコンテキストを通して行われます。</p><p>細かい部分はお見せできなくて申し訳ないのですが、少しでもイメージが沸くようにルールエンジン個別処理のインターフェース定義と個別処理、処理グループ実行処理の実装サンプル（大枠だけですが💦）を掲載します。</p><figure class="highlight java"><figcaption><span>WfInstructedProcess.java（個別処理のインターフェース） </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WfInstructedProcess</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BaseProcessParam</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// パラメータチェックおよび解析用のメソッド</span></span><br><span class="line"><span class="function">T <span class="title">prepareParam</span><span class="params">(WfProcessContext context, WfDefProcess process)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 処理実行用のメソッド</span></span><br><span class="line"><span class="function">WfResult <span class="title">execute</span><span class="params">(WfProcessContext context, T param)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>SampleProcess.java（個別処理の実装クラス） </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"Proc01"</span>) <span class="comment">// Bean IDにルールエンジン定義と対応する処理IDを指定</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleProcess</span> <span class="keyword">implements</span> <span class="title">WfInstructedProcess</span>&lt;<span class="title">SampleParam</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SampleParam <span class="title">prepareParam</span><span class="params">(WfProcessContext context, WfDefProcess process)</span> </span>&#123;</span><br><span class="line"><span class="comment">// WfDefProcessにはルールエンジン定義の情報が格納されています</span></span><br><span class="line"><span class="comment">// ルールエンジン定義にはパラメータ1～10までの定義欄があり、その値を各処理専用のパラメータクラスに詰めなおします</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SampleParam(process.getParam1(), process.getParam2());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WfResult <span class="title">execute</span><span class="params">(WfProcessContext context, SampleParam param)</span> </span>&#123;</span><br><span class="line"><span class="comment">// paramにはprepareParamで作成したパラメータが格納されています</span></span><br><span class="line"><span class="comment">// 戻り値のWfResultは処理結果を示すenum型で、処理フローを制御します（処理グループ実行を途中で止めるetc）</span></span><br><span class="line"><span class="keyword">return</span> WfResult.NORMAL_END;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>ProcessGroupExecLogic.java（処理グループ実行ロジック） </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessGroupExecLogic</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 指定された処理グループ内に定義されている処理を順次実行する</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param パラメータ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 処理結果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ProcessGroupExecResult <span class="title">execute</span><span class="params">(ProcessGroupExecParam param)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ProcessGroupExecResult groupResult = <span class="keyword">new</span> ProcessGroupExecResult();</span><br><span class="line"><span class="comment">/** 処理グループ実行処理結果の初期化など */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// コンテキストに対象素材データなどを格納</span></span><br><span class="line">WfProcessContext context = <span class="keyword">new</span> WfProcessContext();</span><br><span class="line">context.setData(param.getData());</span><br><span class="line"><span class="comment">/** （中略） */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 処理グループに定義されている処理を順次実行</span></span><br><span class="line"><span class="keyword">for</span> (WfDefProcess defProc : param.getDefProcessList()) &#123;</span><br><span class="line"><span class="comment">// コンテナから実行する個別処理のBeanを取得</span></span><br><span class="line">WfInstructedProcess&lt;BaseProcessParam&gt; instructedProcess = springContext.getBean(defProc.getProcCd(), WfInstructedProcess<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">BaseProcessParam procParam;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// パラメータのチェック、解析</span></span><br><span class="line">procParam = instructedProcess.prepareParam(context, defProc);</span><br><span class="line">&#125; <span class="keyword">catch</span> (WfParamInvalidException e) &#123;</span><br><span class="line"><span class="comment">/** パラメータ不正時の処理 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** （中略） */</span></span><br><span class="line"><span class="comment">// ルールエンジン個別処理の実行</span></span><br><span class="line">WfResult result = instructedProcess.execute(context, procParam);</span><br><span class="line"><span class="keyword">if</span> (result == ERROR_END) &#123;</span><br><span class="line"><span class="comment">/** 異常終了時処理 */</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** （中略） */</span></span><br><span class="line"><span class="keyword">if</span> (result == NORMAL_END_STOP) &#123;</span><br><span class="line"><span class="comment">/** 処理中断 */</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">/** 例外発生時処理 */</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** （中略） */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> groupResult;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GlyphFeedsはサービスとして展開しており、ユーザ企業単位の個別カスタマイズが入ることがあります。</p><p>そういったケースでも個別処理の追加はWfInstructedProcessの実装クラス（とその処理のパラメータクラス）を作成してルールエンジン定義を変更するだけ。既存のエンジン部分などには手を加える必要がないので処理追加の要望はもう怖くありません😀</p><p>余談ですが、標準でAWS Lambda実行のルールエンジン個別処理も用意されており、簡易な処理であればそちらを利用することも可能です。</p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>今回はGlyphFeedsの根幹部分を担っているといっても過言ではない、ルールエンジンについて、仕組みと実装方法の概要をご説明させていただきました。</p><p>Springの機能を活用することで、メンテナンス性の高いルールベースエンジン処理を比較的簡単に実現することができますので、少しでも参考になれば幸いです。</p><p>さて、GlyphFeedsではこれまでの4回でご紹介してきた内容以外にもさまざまな技術要素が含まれています。また機会がありましたらそれらについてもご紹介させていただきますので、次回のGlyphFeeds連載企画までお待ちください！</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">実際にはルールエンジン定義の取り込み部分などでもう少し追加で実装が必要となる箇所があります。</span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200914/&quot;&gt;GlyphFeeds連載企画&lt;/a&gt;第5弾の記事となります。&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;h
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Java" scheme="https://future-architect.github.io/tags/Java/"/>
    
      <category term="ルールエンジン" scheme="https://future-architect.github.io/tags/%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3/"/>
    
      <category term="SpringBoot" scheme="https://future-architect.github.io/tags/SpringBoot/"/>
    
      <category term="Spring" scheme="https://future-architect.github.io/tags/Spring/"/>
    
      <category term="DI" scheme="https://future-architect.github.io/tags/DI/"/>
    
  </entry>
  
  <entry>
    <title>デスクトップWebアプリのモバイル化における考え方・Tips</title>
    <link href="https://future-architect.github.io/articles/20200917/"/>
    <id>https://future-architect.github.io/articles/20200917/</id>
    <published>2020-09-16T15:00:00.000Z</published>
    <updated>2020-09-17T02:46:03.548Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200914/">GlyphFeeds連載企画</a>第4弾の記事となります。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、2019年入社、TIGメディアユニット所属の中村立基です。</p><p>今回はメディア業界向けクラウドサービスGlyphFeedsCMSのモバイル化を例に、Webアプリケーションをモバイル化する際の考え方や手法について書きます。</p><p>Webアプリケーションをモバイル化する際の参考になれば幸いです。</p><h1 id="モバイル化の方針"><a href="#モバイル化の方針" class="headerlink" title="モバイル化の方針"></a>モバイル化の方針</h1><p>昨今「モバイルファースト」という言葉が広まる中、スマートフォンを始めとするモバイル端末利用の風潮は強まっています。それに伴いWebアプリケーションもモバイル端末での利用シーンが拡大しています。</p><p>しかし、ただ既存のWebアプリケーションをモバイル端末で表示するだけではアプリの機能などを十分に利用できない場合が多い為、適切にアプリケーションに手を加える必要があります。</p><p>今回GlyphFeedsCMSでは、以下の考え方の下、モバイル化を行いました。</p><p><strong>1. アプリケーションのユーザを再定義、業務フロー・要件の明確化</strong><br><strong>2. デバイスの特性を考慮した機能設計</strong><br><strong>3. シンプルで誰にでも使いやすいデザイン</strong></p><h2 id="1-アプリケーションのユーザを再定義、業務フロー・要件の明確化"><a href="#1-アプリケーションのユーザを再定義、業務フロー・要件の明確化" class="headerlink" title="1. アプリケーションのユーザを再定義、業務フロー・要件の明確化"></a>1. アプリケーションのユーザを再定義、業務フロー・要件の明確化</h2><p>GlyphFeedsCMSは元来新聞社向けの基幹システムとして開発されました。そこで今回モバイル化するにあたり、ユーザを「記者」に設定して、記者が取材し、記事を執筆、送稿するといったユーザが行う業務シナリオから検討することで、必要な要件を定義しました。その中で、</p><ul><li><strong>移動中での記事の執筆が可能になること</strong></li><li><strong>取材・インタビューしながらそのまま記事を作成できること</strong></li><li><strong>緊急時の取材への対応速度向上が見込めること</strong></li></ul><p>といったユーザが享受できるメリットも明確化することができました。<br>同じアプリケーションと言えど、<strong>デバイス毎にユーザが変わる事を想定して利用シーンや必要な機能を再検討する</strong>ことが重要です。</p><h2 id="2-デバイスの特性を考慮した機能設計"><a href="#2-デバイスの特性を考慮した機能設計" class="headerlink" title="2. デバイスの特性を考慮した機能設計"></a>2. デバイスの特性を考慮した機能設計</h2><p>既存のWebアプリケーションをモバイル化する際には幾つか問題点があります。デスクトップアプリで行っていた業務をモバイル端末で行おうとすると機能的な制約が多々発生します。</p><p>例えば、画面の大きさが極端に小さくなることや、メモリー容量・バッテリー駆動時間などを考慮した機能設計にしなければなりません。その為下記の例に挙げる様にモバイル端末の持つ特徴に合わせて機能設計しました。</p><ul><li><strong>バッテリー駆動時間</strong>：アプリケーションの標準テーマにダークモードを採用し、バッテリーの消費電力抑制</li><li><strong>メモリ容量・通信速度</strong>：デスクトップと比較して大容量のデータ通信には不向きな為、モバイル端末で不要な機能の削減</li></ul><h2 id="3-シンプルで誰にでも使いやすいデザイン"><a href="#3-シンプルで誰にでも使いやすいデザイン" class="headerlink" title="3. シンプルで誰にでも使いやすいデザイン"></a>3. シンプルで誰にでも使いやすいデザイン</h2><p>モバイル化において特に重視した点は<strong>UI/UXデザイン</strong>です。</p><p>キーボードとマウスで操作するデスクトップアプリに比べて、モバイル端末ではタッチ操作が基本となります。その為、<strong>「シンプルで誰にでも使いやすい」</strong>ことをコンセプトに、より直感的に操作できるように画面設計を行いました。<br>下記は特に考慮したポイントです。</p><ul><li>画面上に表示されるアイコンや入力項目の要素を極力削減し、<strong>ユーザが押すアイコンを間違えないような配慮</strong></li><li>マテリアル・デザインを踏襲した<strong>ユーザがより直感的に操作できる画面レイアウト</strong></li><li><strong>「ディスプレイを長時間見続けても目が疲れにくい」「利用頻度の高いオブジェクトを目立たせる」</strong>等に留意した統一感のある配色<br><img src="/images/20200917/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E7%B4%A0%E6%9D%904.png" alt=""></li></ul><h1 id="モバイル化の手法"><a href="#モバイル化の手法" class="headerlink" title="モバイル化の手法"></a>モバイル化の手法</h1><p>一口にモバイル化と言っても、その手法によって下記の様に3つのパターンが存在します。</p><p><strong>1. 動的配信</strong><br><strong>2. レスポンシブWebデザイン</strong><br><strong>3. アダプティブデザイン</strong></p><p>それぞれ特徴を簡単に説明します。</p><h2 id="1-動的配信"><a href="#1-動的配信" class="headerlink" title="1. 動的配信"></a>1. 動的配信</h2><p>サーバーサイドでPC・スマートフォン・タブレットなどのユーザエージェント情報を検出し、対応する個別のテンプレートをHTML、CSSで組み立てて配信する方法です。デバイス毎に適切なデザインのコンテンツ配信が可能ですが、エラー対応やテンプレートの調整等の開発コストが大きい側面があります。</p><p><img src="/images/20200917/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E7%B4%A0%E6%9D%901.png" alt=""></p><h2 id="2-レスポンシブWebデザイン"><a href="#2-レスポンシブWebデザイン" class="headerlink" title="2. レスポンシブWebデザイン"></a>2. レスポンシブWebデザイン</h2><p>主にCSSのメディアクエリを用いてスクリーンサイズや条件に応じて表示を最適化する方法です。<br>デバイスによる画面幅によって、要素の表示/非表示等のレイアウトを切り替えます。モバイル端末で表示する場合、デスクトップ用画面を読み込む為表示速度が遅くなる場合があります。<br><img src="/images/20200917/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E7%B4%A0%E6%9D%902.png" alt=""></p><h2 id="3-アダプティブデザイン"><a href="#3-アダプティブデザイン" class="headerlink" title="3. アダプティブデザイン"></a>3. アダプティブデザイン</h2><p>デバイスやコンテクストに応じてコンテンツを最適なデザインで提供する方法です。JavaScriptなどを利用してクライアントサイドで最適化したページを表示することが可能で、デスクトップ・モバイルそれぞれに合わせた専用要素を持つのでデバイスの特性を生かしたデザインや機能が実装できます。</p><p><img src="/images/20200917/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E7%B4%A0%E6%9D%903.png" alt=""></p><p>GlyphFeedsCMSのモバイル化にはアダプティブデザインを採用しています。<br>下記の様にモバイル画面用アプリ配下にある共通SDKを読み込むことで、モバイルに適した専用要素を切り出して実装できる構造になっています。</p><p><img src="/images/20200917/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E7%B4%A0%E6%9D%906.png" alt=""><br>この様な構造を取ることで、共通化している部分のメンテナンスコストを抑えつつ、デスクトップ・モバイルそれぞれの画面に適したデザインでアプリケーションを実装することができます。より具体的な実装方法やパターンなどに関しては、また別の機会でより深堀できればと思います。</p><p><img src="/images/20200917/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0%E7%B4%A0%E6%9D%908.png" alt=""></p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>今回はGlyphFeedsCMSを例にデスクトップ用Webアプリケーションをモバイル化する際の方針や手法を紹介しました。<br>デバイス毎にユーザの利用する用途やシーンが異なることを意識して、適切にリデザインすることが重要であるということを少しでも伝えることができていたら幸いです。</p><p>今後より深いテーマについて理解していければと思います。ここまで読んで頂きありがとうございました。</p><h1 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h1><p><a href="https://webtan.impress.co.jp/e/2017/09/07/26299" target="_blank" rel="noopener">これからのスマホ対応。アダプティブデザイン、レスポンシブWebデザイン、動的配信</a><br><a href="https://material.io/design" target="_blank" rel="noopener">Design - Material Design</a></p><h2 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h2><p><a href="https://future-architect.github.io/articles/20200318/">【Figma】を使ってチームでUI/UX設計するといいこと</a><br><a href="https://future-architect.github.io/articles/20200511/">PJでUIデザインにAtomic Designを導入したらどうだったのか</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200914/&quot;&gt;GlyphFeeds連載企画&lt;/a&gt;第4弾の記事となります。&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;h
      
    
    </summary>
    
    
      <category term="Design" scheme="https://future-architect.github.io/categories/Design/"/>
    
    
      <category term="設計" scheme="https://future-architect.github.io/tags/%E8%A8%AD%E8%A8%88/"/>
    
      <category term="モバイルアプリ" scheme="https://future-architect.github.io/tags/%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA/"/>
    
      <category term="UI" scheme="https://future-architect.github.io/tags/UI/"/>
    
  </entry>
  
  <entry>
    <title>素材受信インターフェースにSQSを活用してみた ～標準キュー vs FIFOキュー～</title>
    <link href="https://future-architect.github.io/articles/20200916/"/>
    <id>https://future-architect.github.io/articles/20200916/</id>
    <published>2020-09-15T15:00:00.000Z</published>
    <updated>2020-09-16T02:18:13.027Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://future-architect.github.io/articles/20200914/">GlyphFeeds連載企画</a>3つ目の記事です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして、2017年新卒入社、TIG所属の出口です。</p><p>今回は、GlyphFeedsの素材受信インターフェース構築を介してAmazon Simple Queue Service (SQS) の検証について紹介します。</p><h1 id="素材受信インターフェースとは"><a href="#素材受信インターフェースとは" class="headerlink" title="素材受信インターフェースとは"></a>素材受信インターフェースとは</h1><p>今回紹介する素材受信インターフェースについて簡易ですが説明します。</p><h2 id="役割"><a href="#役割" class="headerlink" title="役割"></a>役割</h2><p>GlyphFeedsにおいて、素材受信インターフェースは、外部システムから受信した素材をコンテンツマネジメントシステム (CMS)に連携する役割を担います。</p><p>ここで言う素材とは、主に以下の2種類です。</p><ul><li>記事素材：タイトル、本文、その他様々な情報 (Jsonファイル)</li><li>画像素材：画像、キャプション、その他様々な情報 (Jsonファイル＋画像ファイル)</li></ul><p>新聞業界、メディア業界では、日夜大量の素材が生み出されています。</p><p>そのため、受信インターフェースは分間数百件の素材を受信するような状況を想定する必要があります。</p><p>SQSを使用することで、素材を一度キューイングした後でCMSに連携する形をとることができます。</p><h2 id="構成概要"><a href="#構成概要" class="headerlink" title="構成概要"></a>構成概要</h2><p>今回構成した素材受信インターフェースの構成概要図は以下になります。<br><img src="/images/20200916/%E5%9B%B31.png" alt=""></p><p>大まかな流れとしては、</p><ol><li>外部システムからSFTP経由でS3バケットに素材が送られる</li><li>S3からSQSに連携し、素材を示すメッセージがキューに積まれる</li><li>定期実行LambdaがSQSからメッセージを取得し、CMSの素材受信用APIを叩く</li></ol><h1 id="比較検証：標準キュー-vs-FIFOキュー"><a href="#比較検証：標準キュー-vs-FIFOキュー" class="headerlink" title="比較検証：標準キュー vs FIFOキュー"></a>比較検証：標準キュー vs FIFOキュー</h1><p>SQSは標準キューとFIFOキューの2種類あります。<br>今回、素材受信インターフェースを構築するにあたり、標準キューとFIFOキューのどちらが適しているか検証を行っています。</p><h2 id="各キューの特徴"><a href="#各キューの特徴" class="headerlink" title="各キューの特徴"></a>各キューの特徴</h2><p>今回の素材受信インターフェースの実装に関連のある、各キューの特徴は以下になります。</p><table><thead><tr><th></th><th>標準キュー</th><th>FIFOキュー</th></tr></thead><tbody><tr><td>順序</td><td>順序保証なし</td><td>First In First Out</td></tr><tr><td>S3イベント連携</td><td>あり</td><td>なし</td></tr></tbody></table><p>FIFOキューは名前の通り、最初に入ったメッセージが最初に取り出されるように順序保証されます。</p><p>素材受信で更新が発生する場合を考慮すると、順序保証によって巻き戻りが起こらないので、順序においてはFIFOキューが本ケースに関しては優位です。</p><p>ただし、<a href="https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/NotificationHowTo.html" target="_blank" rel="noopener">FIFOキューを使用する場合は、S3から直接SQSに連携できない</a>ので一工夫必要です。</p><h2 id="FIFOキューでS3～SQS連携する工夫"><a href="#FIFOキューでS3～SQS連携する工夫" class="headerlink" title="FIFOキューでS3～SQS連携する工夫"></a>FIFOキューでS3～SQS連携する工夫</h2><p>素材受信インターフェース構築当時は、S3イベント通知の送信先として、SQSの標準キューは選択できましたが、FIFOキューは選択できませんでした。そのため、FIFOキューではSQSに連携するのに一工夫いるため、標準キューかFIFOキューかによって、S3～SQS間の構成は下図のように異なります。<br><img src="/images/20200916/%E5%9B%B32.png" alt=""></p><p>FIFOキューの場合は、S3オブジェクトputをトリガーにLambdaを実行し、その処理でFIFOキューにメッセージを積んでいきます。</p><h2 id="検証概要：ロスト率の比較"><a href="#検証概要：ロスト率の比較" class="headerlink" title="検証概要：ロスト率の比較"></a>検証概要：ロスト率の比較</h2><p>PoCでは、素材が取り込まれるまでの時間や、短時間で大量に受信した場合の性能等、様々な観点でテストを行いました。</p><p>今回は標準キューとFIFOキューのどちらを採用するかの決め手となった、S3オブジェクトputされた数に対して、SQSに連携されなかった数の割合：ロスト率のテスト結果を紹介します。</p><p>テストの概要としては、</p><ul><li>S3バケットに素材をputする頻度（受信頻度）を変えて何通りか試行</li><li>各施行において、S3オブジェクトputした数、SQSに連携された数を記録</li></ul><p><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/s3-verify-event-notification/" target="_blank" rel="noopener">AWS公式情報</a>で、「ごくまれに、イベントが失われることもあります。」とあります。<br>実際にどの程度ロストするのか、S3を監視して自動リカバリする機能を用意すれば補える程度に少ないか等、確認する必要がありました。</p><h2 id="ロスト率の差異"><a href="#ロスト率の差異" class="headerlink" title="ロスト率の差異"></a>ロスト率の差異</h2><p>標準キューとFIFOキューそれぞれを使用した場合のロスト率を確認したところ、想定以上に明確な差異が見られました。</p><p><img src="/images/20200916/%E5%9B%B33.png" alt=""></p><p>(※FIFOキューでは常にロスト率0%だったのでグラフは省きます。)</p><p>今回のケースでは標準キューを使用した構成と相性が悪かったのか、受信頻度が高いとロスト率が十%を超える結果に…</p><p>一方でFIFOキューでは受信頻度が高くても、常にロスト率0%という結果になりました。</p><p>これが決め手となり、FIFOキューを採用することになりました。</p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>GlyphFeedsの素材受信インターフェースの構築を例にSQSの標準キュー、FIFOキューの比較検証の話を紹介させていただきました。</p><p>個人的には、”ごくまれに”が検証するとケース次第で数十%にもなることが意外でした。今回の話を通じて、実際に検証することの重要さを感じていただければと思います。</p><p>FIFOキューではS3イベント連携できないからと、標準キューのみに候補を絞らず、手の届いていない連携箇所を上手く解消してFIFOキューを候補に残したからこそ、今回の意外な結果が得られました。</p><p>サービスをただ使うのではなく、手の届かない箇所は解消方法を考えて活用することで、より適したサービスを用いた、良いシステムの実現に繋がるのではないかと思いました。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200914/&quot;&gt;GlyphFeeds連載企画&lt;/a&gt;3つ目の記事です。&lt;/p&gt;
&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;head
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="AWS" scheme="https://future-architect.github.io/tags/AWS/"/>
    
      <category term="sqs" scheme="https://future-architect.github.io/tags/sqs/"/>
    
  </entry>
  
  <entry>
    <title>メディア向けCMSサービスのインフラ構成のポイント</title>
    <link href="https://future-architect.github.io/articles/20200915/"/>
    <id>https://future-architect.github.io/articles/20200915/</id>
    <published>2020-09-14T15:00:00.000Z</published>
    <updated>2020-09-15T00:46:23.776Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p><a href="https://future-architect.github.io/articles/20200914/">GlyphFeeds</a>連載企画第2弾の記事となります。</p><p>はじめまして、TIG中神です。</p><p>メディア向けCMSクラウドサービス（以下、GlyphFeedsサービス）のインフラを設計・構築を行いました。メディアならではの特性や構成における重要なポイントについていくつかご紹介します。</p><h2 id="メディアCMSの特性"><a href="#メディアCMSの特性" class="headerlink" title="メディアCMSの特性"></a>メディアCMSの特性</h2><p>メディアCMSサービスに求められる非機能要件の中で、特に重要なものとしては以下の3点があげられます。これらの要件はクラウドとの親和性が高いことからGlyphFeedsサービスではクラウドベースのサービスとして設計・構築を行っています。</p><ul><li><strong>①高速なコンテンツ検索ができること</strong></li><li><strong>②24時間365日稼働し、不慮のサービス停止によるダウンタイムを極力短くすること</strong></li><li><strong>③処理量のスパイクに対応できて、かつ柔軟にスケール出来ること</strong></li></ul><h2 id="①高速なコンテンツ検索"><a href="#①高速なコンテンツ検索" class="headerlink" title="①高速なコンテンツ検索"></a>①高速なコンテンツ検索</h2><p>GlyphFeedsサービスの全体像としてはこのようなになっていて、大きく下記のサービス群で構成しています。</p><ol><li>画面を提供するサービス</li><li>APIを提供するサービス</li><li>非同期処理を行うサービス</li><li>コンテンツの加工を行うサービス</li><li>コンテンツデータの蓄積、検索、ステータスの更新を行うサービス</li></ol><p>このうちコンテンツの高速検索においては上記の1、2、3、5のサービス群で実現しています。<br>これらのサービスを、<strong>EC2、ELB、Elasticsearch、DynamoDBといったマネージドサービス</strong>をベースに、なるべくディスクアクセスが入らないように設計・構築しています。<br>性能を引き出すために複数のレイヤーでチューニングを行っていますが、最後の最後までチューニングに苦労したコンピューティングの部分について記載します。</p><p><img src="/images/20200915/image.png" alt=""></p><h3 id="なぜコンテナ（ECS）ではなく仮想サーバー（EC2）を採用したか？"><a href="#なぜコンテナ（ECS）ではなく仮想サーバー（EC2）を採用したか？" class="headerlink" title="なぜコンテナ（ECS）ではなく仮想サーバー（EC2）を採用したか？"></a>なぜコンテナ（ECS）ではなく仮想サーバー（EC2）を採用したか？</h3><p>コンピューティングの部分は、当初コンテナ利用を検討していましたが、導入前の性能テストにて、コンテナよりも仮想サーバーの方がインスンスの性能を使い切れるという結果となり、最終的には仮想サーバーを採用しました。</p><p>以下に検証の概要を記載します。<br>どのような場合もこの結果になるわけではなく、構成や処理特性・ワークロードにより結果は異なってくると思います。</p><h4 id="■検証時の構成"><a href="#■検証時の構成" class="headerlink" title="■検証時の構成"></a>■検証時の構成</h4><p>EC2(Gatling) =&gt; ALB =&gt; <strong>コンピューティング①</strong> =&gt; NLB =&gt; <strong>コンピューティング②</strong> =&gt; Elasticsearch or DynamoDB</p><ul><li>Gatlingを動かすサーバーがボトルネックにならないように無理のないインスタンスタイプを選択して、念のため<a href="https://gatling.io/docs/current/general/operations/" target="_blank" rel="noopener">GatlingのOS Tuning</a>も行っておきます。</li><li><strong>コンピューティング①②</strong>は下記の構成を基準にをベースに「インスタンス数の変更、インスタンスタイプの変更、CPUユニット、メモリの割り当ての変更、JVMヒープ値の変更、コンピューティング①のみEC2構成またはその逆のパターンなど」を様々な組み合わせとなるように変動していいきます。</li></ul><p><strong>コンピューティング①の構成</strong></p><table><thead><tr><th>構成</th><th>インスタンスタイプ</th><th align="center">数量</th><th>OS</th><th>稼働アプリケーション</th></tr></thead><tbody><tr><td>ECSの場合</td><td>m4.large(2vCPU 8GiB)</td><td align="center">2</td><td>ECS-optimized AMI(Linux)</td><td>Spring Bootコンテナ<br>・FROM amazonlinux:2 <br> ・割当500CPUユニット 1500MB <br>・各インスタンスで1つずつ稼働</td></tr><tr><td>EC2の場合</td><td>m4.large(2vCPU 8GiB)</td><td align="center">2</td><td>Amazon Linux 2</td><td>Spring Bootアプリケーション <br>・各インスタンスで1つずつ稼働</td></tr></tbody></table><p><strong>コンピューティング②の構成</strong></p><table><thead><tr><th>構成</th><th>インスタンスタイプ</th><th align="center">数量</th><th>OS</th><th>稼働アプリケーション</th></tr></thead><tbody><tr><td>ECSの場合</td><td>m4.large(2vCPU 8GiB)</td><td align="center">2</td><td>ECS-optimized AMI(Linux)</td><td>gRPCコンテナ<br>・FROM alpine:3.4 <br> ・割当500CPUユニット 1500MB <br>・各インスタンスで1つずつ稼働</td></tr><tr><td>EC2の場合</td><td>m4.large(2vCPU 8GiB)</td><td align="center">2</td><td>Amazon Linux 2</td><td>gRPCアプリケーション <br>・各インスタンスで1つずつ稼働</td></tr></tbody></table><h4 id="■検証結果"><a href="#■検証結果" class="headerlink" title="■検証結果"></a>■検証結果</h4><p>下記は検証結果のグラフの線形のイメージです。当然どちらの構成でも、処理の多重度があがると処理時間も増加してきますが、同等のインスタンスのスペックで見た場合、ECS構成の方が処理多重度が増えると処理時間の劣化が大きいという結論になりました。</p><p>平常時は大きな性能差はありませんが、高負荷時に処理時間が大きく劣化する可能性があるという結論のため仮想サーバー（EC2）構成の採用に至っています。</p><p>なお、ボトルネック調査のためネットワーク・OSの性能情報や処理のトレースなど各種情報を確認しましたが、処理の多重度があがるとコンテナ上のAPIが実行されるまでのタイムラグが徐々に大きくなっているようでした。ネットワークやホストOS側では異常値などは出ていなかったのですが、状況的にはDockerエンジン部分がボトルネックになっている可能性が想定されました。</p><p><img src="/images/20200915/image_2.png" alt=""></p><p>最近だとコンテナ構成の選択肢が増えたので、どのパターンが最もインスタンス性能を使い切れるのか、性能維持やスケールしやすいのか、性能が頭打ちになった場合の挙動はどうなるのか、フットプリントの軽いベースOSに変えた場合の差など機会があれば検証してみたいですね。</p><ul><li>Docker on EC2</li><li>ECS on EC2</li><li>ECS on Fargate</li><li>EKS</li><li>Anthos GKE on AWS </li></ul><h2 id="②できる限りダウンタイムを短くする"><a href="#②できる限りダウンタイムを短くする" class="headerlink" title="②できる限りダウンタイムを短くする"></a>②できる限りダウンタイムを短くする</h2><p>GlyphFeedsサービスでは、マルチAZ構成を取り各インスタンスは必ず冗長構成を取るようにしています。<br>さらにマルチリージョン構成を採用し、単一のリージョン障害に対する可用性を高めています。<br>このように可用性を高める構成を採用していますが、冗長構成を取っても絶対に停止しないわけではないので、OS上のサービスの自動復旧やEC2のAuto Recoveryなどリソースが落ちたらすぐに復旧するような方式を採用し極力ダウンタイムを短くするアプローチとしています。</p><p>■GlyphFeedsサービスにおける主要な要素</p><table><thead><tr><th>カテゴリ</th><th>マネージドサービス</th><th>用途</th></tr></thead><tbody><tr><td>コンピューティング</td><td>EC2</td><td>WEB、API、非同期処理、コンテンツ加工、データ操作API</td></tr><tr><td>コンピューティング</td><td>Lambda</td><td>マネージドサービス間連携、時刻起動処理など</td></tr><tr><td>データベース</td><td>DynamoDB</td><td>コンテンツ（テキスト）格納</td></tr><tr><td>データベース</td><td>RDS</td><td>アプリケーションマスタ格納</td></tr><tr><td>分析</td><td>Elasticsearch Service</td><td>検索エンジン</td></tr><tr><td>ストレージ</td><td>S3</td><td>コンテンツオブジェクト格納</td></tr></tbody></table><h3 id="どのような障害まで想定するか？"><a href="#どのような障害まで想定するか？" class="headerlink" title="どのような障害まで想定するか？"></a>どのような障害まで想定するか？</h3><p>AWSだと、Well-Architectedフレームワークやベストプラクティスに沿って設計/構築するだけで比較的容易にAZ障害に対する対障害性を確保できます。また、東京リージョンを見ても複数のAZで構成されており、自然災害などの物理障害に対しては極めて高い耐性があると思います。</p><p>では、ダウンタイム最少化のためにどのような障害まで想定するか？というところですがAWSでいうと多少検索するだけで過去にどんな障害があったか検索できます。</p><p>過去にマネージドサービスが長時間停止する障害が数回発生していますね。また、それらは単一リージョンに閉じた論理障害です。<br>（センター内の物理的な障害が起因して論理障害になったパターンもあるようですが）</p><p>そのため、複数のリージョンでサービスが稼働する構成の場合は、サービスを継続できていた可能性が高いと想定されます。GlyphFeedsサービスでは単一のリージョンダウンまでは発生しうると想定し、マルチリージョン構成を取ることにより、リージョン停止レベルの大障害が発生しても別リージョンに切り替えることによりダウンタイムを最小化しています。</p><h3 id="構成のポイント"><a href="#構成のポイント" class="headerlink" title="構成のポイント"></a>構成のポイント</h3><p>上記のようにマルチリージョン構成を取ることにより可用性は向上します。</p><p>では、具体的にどのような構成にするか？というところですがDRシナリオにも複数のパターンがありGlyphFeedsサービスでは、コストと効果のバランスを取り、パイロットライトとウォームスタンバイの間くらいの可用性になるように設計し、データのリカバリポイントは5分以内、切替/切戻は60分程度というサービスレベルになっています。</p><img src="/images/20200915/image_3.png" class="img-middle-size"><p>設計やバックアップサイトへの切替についても様々な方式があるので、サービスに適した方式を採用することで切替自体は比較的容易に実現することが可能です。</p><p>どのDRシナリオにしてもポイントになってくるのは非機能要件とクラウド利用料などコストを考慮して最もバランスの良い構成をとること、とデータも含めてメインサイトへの切戻ができることがあげられます。</p><p>より高可用な構成としてマルチクラウドによる構成なども考えられますが、果たしてサービスレベルはあがるのか？意図したように切戻も出来るのか？などこちらも機会があれば検証を行ってみたいですね。</p><h2 id="③柔軟なスケール"><a href="#③柔軟なスケール" class="headerlink" title="③柔軟なスケール"></a>③柔軟なスケール</h2><p>メディアCMS特有かもしれませんが、上の方で記載した特性の中で最も要件として定義が難しく、ぶれやすいのが、処理量のスパイクやデータ量の増加をどう見るか？という点です。メディアCMSでは繁忙期・閑散期というような概念はほぼなく、開催されるイベントの大きさによって著しく処理量や連携データ量（記事、写真、音声、動画などの数量）が増加します。さらに年々の機材の進化で取り扱うデータそのもの（写真、音声、動画など）のサイズが爆発的に大きくなってきています。</p><p>このように外部要因を含めてのサイジング難易度が高いことから、柔軟に自動でスケール出来るマネージドサービスを最大限に活用します。人手を介さず自動でスケールしてくれるという点で多大なメリットがありますがいくつか注意点もあります。</p><h3 id="オートスケールの注意点"><a href="#オートスケールの注意点" class="headerlink" title="オートスケールの注意点"></a>オートスケールの注意点</h3><p>マネージドサービスの裏側ではコンテナやインスタンスが起動してくるので起動が完了するまでの待ち時間が発生します。待ち時間はマネージドサービスにより変わってくると思いますがマネージドサービスによってはスケールが完了するまで数分のタイムラグが発生します。</p><p>短い時間（数分など）に想定の何倍もの処理量が発生するような場合はスケールが追い付かなく、スロットリングが発生しその後タイムアウトや処理遅延が発生する可能性があります。<br>以下のような線形が発生し、あと数回スパイクが発生したら処理のタイムアウトが発生すると思います。<br><img src="/images/20200915/image_4.png" alt=""></p><p>システムのスパイク特性やベースの性能をどう定義するか？スケール条件の閾値をどう定義するか？オートスケールを利用する場合でも完全に任せきりではなく、事前のシミュレーションや性能検証によるチューニングが必要だということになります。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>当社の中では、自社サービスを展開しながら運用保守で上がってきた課題をダイナミックに改善していくという機会はなかなかないので貴重な経験となりました。設計してきたものが想定通り動いているのか？どの部分が乖離しやすいのか？なぜ乖離したのか？どう改善するか？などは長期的な視点が必要となるのでプロジェクトベースの仕事とは異なる知見が得られたと思いました。</p><p>また、システム特性を見極めることや、非機能要件を定義しどうコントロールしていくかというのは結局オンプレでもクラウドでも同じだなーと改めて思いました。</p><h2 id="参考資料"><a href="#参考資料" class="headerlink" title="参考資料"></a>参考資料</h2><ul><li><a href="https://gatling.io/docs/current/general/operations/" target="_blank" rel="noopener">Gatling OS Tuning</a></li><li><a href="https://aws.amazon.com/jp/about-aws/global-infrastructure/" target="_blank" rel="noopener">AWSグローバルインフラストラクチャ</a></li><li><a href="https://www.slideshare.net/AmazonWebServicesJapan/aws-black-belt-online-seminar-2018-aws-wellarchitected-framework" target="_blank" rel="noopener">AWS Black Belt Online Seminar 2018 AWS Well-Architected Framework</a></li><li><a href="https://www.slideshare.net/AmazonWebServicesJapan/aws-black-belt-online-seminar-awsdisaster-recovery" target="_blank" rel="noopener">AWS Black Belt Online Seminar AWSで実現するDisaster Recovery</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://future-architect.github.io/articles/20200914/
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="AWS" scheme="https://future-architect.github.io/tags/AWS/"/>
    
      <category term="GlyphFeeds" scheme="https://future-architect.github.io/tags/GlyphFeeds/"/>
    
      <category term="CMS" scheme="https://future-architect.github.io/tags/CMS/"/>
    
      <category term="基幹システム" scheme="https://future-architect.github.io/tags/%E5%9F%BA%E5%B9%B9%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0/"/>
    
  </entry>
  
  <entry>
    <title>GlyphFeeds連載を始めます！</title>
    <link href="https://future-architect.github.io/articles/20200914/"/>
    <id>https://future-architect.github.io/articles/20200914/</id>
    <published>2020-09-13T15:00:00.000Z</published>
    <updated>2020-09-18T02:52:09.799Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして。2012年新卒入社の山上です。TIGメディアユニットのリーダーを務めています。</p><p>AWSをフル活用した<strong>コンテンツマネジメントシステム（以下、CMS）</strong>を中核に持つクラウドサービス<strong>「GlyphFeeds」</strong>を開発し、様々なクライアントへの導入をリードしています。</p><p>今回の連載では、<strong>GlyphFeeds</strong>の技術について紹介していきます。1日目の今回は、<strong>GlyphFeeds</strong>について簡単に紹介します。</p><h1 id="CMSとは"><a href="#CMSとは" class="headerlink" title="CMSとは"></a>CMSとは</h1><p>新聞社向けのCMSは、記者が取材して書く記事やカメラマンが撮影した写真を管理し、新聞紙面やデジタルサイト・ニュースアプリ等にニュースを届けるためのシステムです。CMSが止まればみなさまのスマホアプリにニュースが届くことはありません。</p><p>つまり新聞社にとって非常に重要な基幹システムであり、ある意味ミッションクリティカルなシステムです。</p><p><img src="/images/20200914/%E5%8E%9F%E7%A8%BF.gif" alt=""></p><p><img src="/images/20200914/%E7%94%BB%E5%83%8F%E7%B7%A8%E9%9B%86.gif" alt=""></p><h1 id="GlyphFeedsとは"><a href="#GlyphFeedsとは" class="headerlink" title="GlyphFeedsとは"></a>GlyphFeedsとは</h1><p><img src="/images/20200914/GlyphFeedsLogo.jpg" alt=""></p><p>GlyphFeedsは、<a href="https://prtimes.jp/main/html/rd/p/000000324.000004374.html" target="_blank" rel="noopener">毎日新聞社プロジェクト</a>でゼロから構築したCMS（システム名：MIRAI）をベースに、<br>新聞業界、メディア業界の標準サービスとして展開可能な形に進化させたクラウドサービスです👍<br><img src="/images/20200914/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-09-08_18.11.19.png" alt=""></p><p>新聞社の心臓部とも言えるCMS（＝基幹システム）を<strong>AWSフルクラウド</strong>＆<strong>Webアーキテクチャ</strong>で実装しました。<br>システム完成までには様々な苦労があり💪、5日間の連載では表現しきれない程多くの技術的チャレンジを行ってきましたが、特徴的な部分を中心にぎゅぎゅっと凝縮してGlyphFeedsの技術についてお届けします！！</p><h2 id="連載スケジュール"><a href="#連載スケジュール" class="headerlink" title="連載スケジュール"></a>連載スケジュール</h2><p>連載スケジュールは下記を予定しています。</p><table><thead><tr><th align="left">日にち</th><th align="left">執筆者</th><th align="left">記事テーマ</th><th align="left">キーワード</th></tr></thead><tbody><tr><td align="left">9/14（月）</td><td align="left">山上燦</td><td align="left">GlyphFeedsとは</td><td align="left">クラウドサービス,AWS,CMS</td></tr><tr><td align="left">9/15（火）</td><td align="left">中神孝士</td><td align="left"><a href="/articles/20200915/">メディア向けCMSサービスのインフラ構成のポイント</a></td><td align="left">AWS,infrastructure,CMS,クラウドサービス,基幹システム</td></tr><tr><td align="left">9/16（水）</td><td align="left">出口豊</td><td align="left"><a href="/articles/20200916/">素材受信インターフェースにSQSを活用してみた_～標準キュー_vs_FIFOキュー～</a></td><td align="left">AWS,SQS</td></tr><tr><td align="left">9/17（木）</td><td align="left">中村立基</td><td align="left"><a href="/articles/20200917/">デスクトップwebアプリのモバイル化における考え方・Tips</a></td><td align="left">UI,設計,Webアプリケーション,モバイルアプリ</td></tr><tr><td align="left">9/18（金）</td><td align="left">渡邉拓</td><td align="left"><a href="/articles/20200918/">SpringBootでDIを駆使したルールエンジン開発</a></td><td align="left">Spring,DI,ルールエンジン</td></tr></tbody></table><p>※正確なタイトルは直前で変更するかも知れませんが、ご了承ください！</p><h1 id="参考-関連リンク"><a href="#参考-関連リンク" class="headerlink" title="参考/関連リンク"></a>参考/関連リンク</h1><p>GlyphFeedsで採用している技術要素たち。</p><ul><li><a href="https://future-architect.github.io/articles/20170605/">ES2015 Web componentsと国産Web componentsフレームワークUrushi</a></li><li><a href="https://future-architect.github.io/articles/20170828/">uroboroSQL x Spring BootによるWebアプリケーション開発</a></li><li><a href="https://future-architect.github.io/tags/DynamoDB%C3%97Go/">DynamoDB×Go連載企画</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;はじめまして。2012年新卒入社の山上です。TIGメディアユニットのリーダーを務めています。&lt;/p&gt;
&lt;p&gt;AWSをフル活用
      
    
    </summary>
    
    
      <category term="Product" scheme="https://future-architect.github.io/categories/Product/"/>
    
    
      <category term="AWS" scheme="https://future-architect.github.io/tags/AWS/"/>
    
      <category term="GlyphFeeds" scheme="https://future-architect.github.io/tags/GlyphFeeds/"/>
    
      <category term="CMS" scheme="https://future-architect.github.io/tags/CMS/"/>
    
      <category term="基幹システム" scheme="https://future-architect.github.io/tags/%E5%9F%BA%E5%B9%B9%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0/"/>
    
  </entry>
  
  <entry>
    <title>フューチャーの2020 夏季インターンに参加してみた</title>
    <link href="https://future-architect.github.io/articles/20200913/"/>
    <id>https://future-architect.github.io/articles/20200913/</id>
    <published>2020-09-12T15:00:00.000Z</published>
    <updated>2020-09-15T01:33:55.952Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/20200913/pixel-cells-3974186_1280.png" alt=""></p><p><a href="https://pixabay.com/ja/users/manfredsteger-1848497/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3974186" target="_blank" rel="noopener">Manfred Steger</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3974186" target="_blank" rel="noopener">Pixabay</a>からの画像</p><h1 id="導入"><a href="#導入" class="headerlink" title="導入"></a>導入</h1><p>はじめまして。フューチャーのインターンシップに参加していた中山です。<br>私が参加したインターンシップであるEngineer Campの経験を話します。</p><h1 id="インターン参加前の状況"><a href="#インターン参加前の状況" class="headerlink" title="インターン参加前の状況"></a>インターン参加前の状況</h1><h2 id="インターンで経験したいと思っていたこと"><a href="#インターンで経験したいと思っていたこと" class="headerlink" title="インターンで経験したいと思っていたこと"></a>インターンで経験したいと思っていたこと</h2><p>今回のインターン参加前、自分が経験したいと考えていたことは以下の通りです。</p><ul><li>サーバサイドのプログラミングを経験する</li><li>インフラ周りの設定、環境構築、設計などを学ぶ</li><li>チーム開発の流れを経験する</li></ul><h2 id="自分の技術スタック"><a href="#自分の技術スタック" class="headerlink" title="自分の技術スタック"></a>自分の技術スタック</h2><p>また、今回のインターンに参加する前の自分の技術スタックは以下でした。</p><ul><li>フロント：React</li><li>サーバ：Go, Node.js, Ruby</li><li>DB：MySQL, SQLite3</li><li>OS：MacOS, Linux</li><li>その他言語：c++, Python, Scala</li></ul><p>C++, Node.js, Rubyは授業や趣味で少し触れたことがある程度、インフラ周りは名前しか分からないという感じでした。<br>情報系の学生で、IT系のアルバイトやインターンなどに参加したことが無い学生の典型的なスキルセットだったと思います。</p><h1 id="参加したインターン"><a href="#参加したインターン" class="headerlink" title="参加したインターン"></a>参加したインターン</h1><p>上記のような希望を持っていた私は、Engineer Campの中から「③IoTプラットフォームバックエンド開発🏭」を選択しました。<br>このインターンの特徴は募集ページには以下のように書かれており、IoTのバックエンド周りを実装することです。<br><a href="https://future-architect.github.io/articles/20200606/">フューチャー夏のインターン2020。リモート開催予定です</a></p><blockquote><p>実際に稼働している、ミッションクリティカル（高い信頼性が求められるシステム）のバックエンドシステムを開発します。フューチャーでは貴重な広域・大規模な接続数（数十万規模）であり、多くの課題が山積みなので一緒に解決に導きましょう。</p></blockquote><p>未来報にもインターン記事があるので、興味がある方は確認ください。</p><ul><li><a href="https://note.future.co.jp/n/n3d3b635c4c1b" target="_blank" rel="noopener">https://note.future.co.jp/n/n3d3b635c4c1b</a></li></ul><h1 id="インターン参加までの流れ"><a href="#インターン参加までの流れ" class="headerlink" title="インターン参加までの流れ"></a>インターン参加までの流れ</h1><p>正直に話すと、私は就業型のインターンで給料のもらえるアルバイトを色々と探していたため、フューチャーはサポーターズのイベントで見た時にとりあえず応募してみようという思いでした。</p><p>おそらくほとんどの人が最初に思うように、私もフューチャーのインターンの受け入れ先の種類の多さに驚きました。10種類もある受け入れ先の中から、技術的な応募条件と自分のスキルセットが合うものを探し、今回参加した③IoTプラットフォームバックエンド開発🏭を選択しました。</p><p>インターン合格までに受けた面接は、コーディング試験＋オンライン面接1回のみでした。オンライン面接では、実際に参加したプロジェクトの現役開発メンバーの方2名が面接官となり、開発経験、技術スタック、そもそもなんで今回応募したのか、今まででの開発で大変だったことエピソードなど定番の質問を受けました。</p><p>一方で、コーディング試験の手応えはあまりなく、今年のインターンはコロナの影響もあり全国的にオンライン開催となり、学生側が気軽に応募しやすい関係から、倍率が上がるという話が噂されていたことに加え、就業型で給料のもらえるインターンは人気が高いと思っていたため、あまり受かるとは思っていませんでした。</p><p>蓋を開けてみると、結果は合格、話を聞くと作業用のPCまで貸与、さらに最新モデルのMac Book Proという素晴らしい環境を用意していただいたので非常にうれしかったです。</p><h1 id="インターンに参加してみて"><a href="#インターンに参加してみて" class="headerlink" title="インターンに参加してみて"></a>インターンに参加してみて</h1><p>まず前提として、今年はコロナの影響もあり、インターン自体が完全オンライン開催でした。プロジェクトのメンバーの方達も基本的に全員在宅ワークという形であり、Google Meet, Slackなどを利用して活発に連絡をやりとりしている状況でした。</p><h2 id="インターンでやったこと"><a href="#インターンでやったこと" class="headerlink" title="インターンでやったこと"></a>インターンでやったこと</h2><p>実際のインターンでは、まず初日に環境構築から始まります。</p><p>インターン参加学生には全員フューチャーから作業用PCが与えられ、このセットアップから行います。環境構築のはじめにやることは、インターン中は常にVPNを利用してフューチャーのプライベートネットワークにつないでいるため、プロキシ周りの設定になります。プロキシの設定後、プロジェクトで利用しているGoやDockerなど必要な物をインストールします。環境構築完了後は既存のテストを走らせ、通れば作業開始です！</p><p>環境構築後、インターン中に実際にやったことは以下のようなタスクです。</p><ul><li>Swaggerを用いてAPIの設計</li><li>APIのエンドポイントに対応したハンドラの作成</li><li>テスト</li><li>DB操作系の実装</li><li>Goを使ってCSV,Excelファイルの処理</li><li>少しだけDB設計</li></ul><h2 id="採用技術"><a href="#採用技術" class="headerlink" title="採用技術"></a>採用技術</h2><p>今回参加したプロジェクトは以下のような技術を採用していました。</p><ul><li>フロントエンド： Vue.js</li><li>バックエンド：Go、Swagger</li><li>DB: DynamoDB</li><li>インフラ：AWS、Terraform</li><li>その他：GitHub, CircleCI, draw.io, Slack, etc.</li></ul><p>このうち、バックエンドを中心に開発しました。</p><h2 id="インターン中の1日"><a href="#インターン中の1日" class="headerlink" title="インターン中の1日"></a>インターン中の1日</h2><p>ここでは3週間のインターン中どのような1日を過ごしていたかまとめました。<br><strong>10:00～ 朝会に参加</strong>👪<br>参加したプロジェクトは毎日午前10時から30分ほどで前日の進捗と、当日の予定をスプレッドシートに記入、報告するミーティングがあり、それに参加していました。<br><strong>10:30～ 作業開始</strong>🏭<br>任されたタスクの作業をはじめます。<br>基本的に、GitHubのIssueページ、リポジトリ内のドキュメントを読みながら実装を進めます。<br>実装用件などで分からないところがあれば、メンターさんにSlackで質問しながら進めます。<br><strong>12:30～ 昼休憩</strong>☕<br>基本的にお昼は12:00～13:00ですが、リモートワークで家で作業ということもあり、こっそりと12時半まで作業してから1時間休むことで、13時を過ぎてもまだ休んでいていいという優越感にひたるライフハックです。<br>毎週月曜日はインターンに参加している他の学生とランチ会がありました。<br><strong>13:30～ 作業再開</strong>🏭<br>作業に詰まっていると、メンターさんとGoogle Meetを用いて1on1で相談をしたりすることもありました。<br>参加したプロジェクトではSlackのチャンネル内に作業スレを立て、自分の現在行っている作業を書き連ねることで、自分の仕事状況を見える化する試みが行われていました。別途私は日記をつけて、作業ログを残していましたが、作業の途中で前日どのように実装したかなどを振り返るのにも便利でした。<br>また、今回のインターンでは数回フューチャーの各部門のトップの方が30分時間を取ってくださり、それぞれ働き方のマインドや事業の紹介などいろいろなことを講義してくれる日がありました。<br><strong>19:00~ 作業終了</strong>📄<br>インターンの振り返りを日報に書き、その日働いた分の勤務報告を記入しPCを落としてその日のインターンは終了です。</p><h2 id="インターンから学んだこと"><a href="#インターンから学んだこと" class="headerlink" title="インターンから学んだこと"></a>インターンから学んだこと</h2><p>インターン自体からは非常に多くのことを学びましたが、振り返って思いつく内容は以下のような内容です。</p><ul><li>Swaggerが便利！<ul><li>swagger generateでRequest/Response系の自動生成されるコードがたくさん！</li></ul></li><li>TDT(Table Driven Test)が便利！<ul><li>テストケースの増減のしやすさ</li><li>テストコードの可読性の高さ</li></ul></li><li>Go言語書きやすい！<ul><li>型がある安心感とスライスなどの柔軟な記述性</li></ul></li><li>プロキシ周りの設定は大変。<ul><li>Docker for Macのプロキシ設定箇所どこ・・・</li><li>Docker内のgoはなぜ大文字のHTTP_PROXYしか受け取れないのか・・・</li></ul></li><li>チーム開発におけるREADMEなどによる開発手法・設計・データ構造の定義などの明文化の大切さ</li></ul><p>やはり開発現場に入って初めて気付けることは多く、便利な新しい技術に出会えるのはもちろん、途中参加者のキャッチアップのための充実したドキュメントの大切さなど多くのものを学びました。</p><p>特に、インターン参加前にGoでサーバサイドのコードを記述していた際には、ginを利用しており、Response, Request共に構造体を何度も書き、bindの記述を書いていましたが、swaggerでそれらのコードが自動生成されるのを見ると感動しました。</p><h2 id="インターンを振り返ってみて"><a href="#インターンを振り返ってみて" class="headerlink" title="インターンを振り返ってみて"></a>インターンを振り返ってみて</h2><p>自分のコードがマージされたときは最高の気分！！Slackでも祝ってもらえます。<br><img src="/images/20200913/初マージ！.png" class="img-middle-size"></p><p>インターンを全体的に振り返ると以下のようなことを思いました。</p><ul><li>参加前にインターンで学びたいことは概ね達成<ul><li>サーバサイドプログラミングの体験</li><li>Gitを用いたチーム開発の経験</li><li>実際の業務に参加し、キャッチアップしながら開発を経験</li></ul></li><li>改めてITエンジニアの大変さを知る<ul><li>プロジェクトの連携企業との連携の大変さ</li><li>納期の遅れ</li></ul></li><li>プロキシの設定が非常に大変。。</li><li>日を跨いだタスクの持ち越しは精神的に辛い。<ul><li>レポートや卒論に追われているときに似た感覚</li></ul></li><li>インターン自体はタスクも面白く、楽しかった</li></ul><p>個人的な都合で当初の4週間から3週間に期間が縮まった影響もあり、インフラ周りにまで手を出せなかったのは残念でしたが、Swaggerという新しいフレームワークを学べたり、様々な質問をする中でAPI設計の思想など今回のようなインターンで直接現場の方に熱心に教えていただかなければ中々知ることができないことを学べたのが大きかったと思います。</p><p>一方で、与えられるタスクには実装のために必要な資料や背景情報が足りていない場合もあり、そういった場合には質問を重ねる必要があるため、Slackなどで積極的にコミュニケーションを取る必要があるように感じられました。そのため、プログラミング力だけでなく、ある程度自主的に考え、動く力を求められるインターンでもあったと感じました。</p><p>そうした環境だったからこそ、与えられるタスクのIssueの要件そのままに実装するのではなく、今回の実装が何を解決するためのものなのかを考え、時に問題の内容を抽象化、具体化するなどの訓練を積むことができたのではないかと思います。</p><p>単純にプログラミング能力を鍛えるだけでなく、働き方自体を学ぶことができるインターンであったと思います。</p><h1 id="今後に向けて"><a href="#今後に向けて" class="headerlink" title="今後に向けて"></a>今後に向けて</h1><p>今回学んだ</p><ul><li>Gitを利用したチーム開発の流れ</li><li>Swaggerの便利さ</li></ul><p>などを今後の就活、アルバイト、趣味、研究などに生かしていきたいと思います！</p><h1 id="結び"><a href="#結び" class="headerlink" title="結び"></a>結び</h1><p>自分の都合により、本来4週間のインターンを3週間に削ってもらい参加する形となりましたが、様々なタスクを経験させて頂いたり、インターン期間中に色々サポートを頂いたりしました。<br>受け入れ先のプロジェクトのみなさん、フューチャーのHRのみなさんありがとうございました。</p><p><img src="/images/20200913/%E9%9B%86%E5%90%88%E5%86%99%E7%9C%9F.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/20200913/pixel-cells-3974186_1280.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/manfredsteger-1848497/?utm_
      
    
    </summary>
    
    
      <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
      <category term="インターン" scheme="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%B3/"/>
    
      <category term="採用" scheme="https://future-architect.github.io/tags/%E6%8E%A1%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>いぶし銀なインフラ機能「テープバックアップ／リストア」を語る</title>
    <link href="https://future-architect.github.io/articles/20200911/"/>
    <id>https://future-architect.github.io/articles/20200911/</id>
    <published>2020-09-10T15:00:00.000Z</published>
    <updated>2020-09-11T01:13:46.701Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、2018年新卒入社の中本です。</p><p>掲題の通り、本稿ではテープバックアップ/リストアについてご紹介したいと思います。なぜこのクラウドネイティブな時代にテープバックアップ/リストア！？という意見もあるかと思われますが、影を潜めつつあるテープバックアップ/リストアを振り返り、</p><p>ご存じの方は<strong><em>ノスタルジー</em></strong>を、知らない方は<strong><em>テクノロジー</em></strong>を感じていただければ幸いです。</p><h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1><p>以下の順で進めていきます。</p><ul><li><strong><em>テープバックアップ/リストアとは</em></strong></li><li><strong><em>主なバックアップソフトウェア</em></strong></li><li><strong><em>テープバックアップ/リストアのメリット/デメリット</em></strong></li><li><strong><em>テープリストアの流れ</em></strong></li><li><strong><em>主なリストアコマンド</em></strong></li><li><strong><em>個人的にハマったポイント</em></strong></li></ul><h1 id="テープバックアップ-リストアとは？"><a href="#テープバックアップ-リストアとは？" class="headerlink" title="テープバックアップ/リストアとは？"></a>テープバックアップ/リストアとは？</h1><p>テープバックアップ/リストアとはその名の通り磁気テープを利用した長期保存・大容量・低コストなバックアップ/手法の一つです。</p><p><img src="/images/20200911/%E3%83%86%E3%83%BC%E3%83%97%E8%A3%85%E7%BD%AE.png" alt=""></p><blockquote><p><code>HPE StoreEver MSL2024 テープライブラリ</code></p></blockquote><p>テープマガジンを取り出し、都度テープを入れ替えることでバックアップを取得していきます。<br>※オートローダのテープ装置では、ロボットが自動的にバックアップ用テープを読込み、バックアップを自動化します。</p><p><img src="/images/20200911/%E3%83%86%E3%83%BC%E3%83%97.png" alt=""></p><blockquote><p><code>HPE StoreEver MSL2024 テープマガジン</code></p></blockquote><p>オフラインでバックアップを行うため、ウイルス感染や人為的なオペミスによるバックアップ領域への影響などの懸念はありません。<br>また、磁気テープ規格であるLTOのストレージ容量は2020年現在で2.5TB～最大30TBまであり、将来的には数百TBにまで拡張するロードマップも公表されています。</p><blockquote><p>＜ご参考＞<br>LTO6：非圧縮容量2.5TB、圧縮容量6.25TB<br>LTO7：非圧縮容量6TB、圧縮容量15TB<br>LTO8：非圧縮時12TB、最大30TB</p></blockquote><h1 id="主なバックアップソフトウェア"><a href="#主なバックアップソフトウェア" class="headerlink" title="主なバックアップソフトウェア"></a>主なバックアップソフトウェア</h1><p>テープバックアップを支える主なバックアップソフトウェアです。</p><ul><li>Data Protector（HPE）</li><li>NetBackup（VERITAS）</li><li>Backup Exec（VERITAS）</li><li>ARCSERVE BACKUP(arcserve)</li><li>NetVault Backup(Quest Software)</li></ul><p>本稿では、<strong><em><code>NetBackup</code></em></strong>をベースにテープバックアップ/リストアについてご紹介いたします。</p><h1 id="テープバックアップ-リストアのメリット-デメリット"><a href="#テープバックアップ-リストアのメリット-デメリット" class="headerlink" title="テープバックアップ/リストアのメリット/デメリット"></a>テープバックアップ/リストアのメリット/デメリット</h1><table><thead><tr><th>メリット</th><th>デメリット</th></tr></thead><tbody><tr><td>テープメディアの容量単価が安い</td><td>磁気ヘッドなどのゴミ除去の定期メンテナンスが必要</td></tr><tr><td>電力消費がディスクより少ない</td><td>物理的なテープ交換などの人的コストが掛かる</td></tr><tr><td>記録容量が大きい</td><td>磁気テープのためランダムアクセスできない</td></tr><tr><td>遠隔地バックアップなど可搬性に優れている</td><td>遠隔地で送付・保管する諸々のコストが掛かる</td></tr><tr><td>耐久性に優れている</td><td>テープ装置が必要なため環境に依存する</td></tr><tr><td>-</td><td>ファイル単位での個別リストアに不向き</td></tr><tr><td>-</td><td>クラウド化に伴い知見が少ない</td></tr></tbody></table><p><strong><em>「リストアする頻度は限りなく少なく、仮に戻したとしても即時性を要求しないので、大容量データを安価でバックアップしたい」</em></strong>といったデータの二次的な保管に向いているように思えます。</p><h1 id="でも、戻せないと意味がない"><a href="#でも、戻せないと意味がない" class="headerlink" title="でも、戻せないと意味がない"></a>でも、戻せないと意味がない</h1><p>安価で大容量のバックアップを可能にするのがテープバックアップということは理解しました。ただ、バックアップとして保管する以上、リストア出来なければバックアップ装置として意味がありません。</p><p><strong><em>障害時にリストアしようとしたが、データを復旧できなかった</em></strong>といったことにならないように、テープのリストアの流れとハマったポイントについて確認し、今後の参考にしていただければと思います。</p><h1 id="テープリストアフロー"><a href="#テープリストアフロー" class="headerlink" title="テープリストアフロー"></a>テープリストアフロー</h1><ol><li><strong><em>テープスロットにあるテープの一覧取得</em></strong><br> →　スロットに装填されているテープの一覧情報を取得し、対象テープの情報を取得する。</li><li><strong><em>指定テープのデータ情報を取得（IMPORTフェーズ1）</em></strong><br> →　テープメディア情報のカタログエントリのリストを作成する。</li><li><strong><em>テープデータのインポート（IMPORTフェーズ2）</em></strong><br> →　フェーズ1で作成したイメージのリストから、インポートするイメージを選択する。</li><li><strong><em>リストア（全量、もしくはファイル単位）</em></strong></li></ol><h1 id="主なリストアコマンド"><a href="#主なリストアコマンド" class="headerlink" title="主なリストアコマンド"></a>主なリストアコマンド</h1><h3 id="VMQUERY"><a href="#VMQUERY" class="headerlink" title="VMQUERY"></a>VMQUERY</h3><p>テープスロットに挿入されているテープメディア情報を取得するコマンド</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$/usr/openv/volmgr/bin/vmquery -pn プール名 -b</span><br><span class="line">================================================================================</span><br><span class="line">media   media  robot  robot  robot  side/  optical  <span class="comment"># mounts/      last</span></span><br><span class="line"> ID     <span class="built_in">type</span>   <span class="built_in">type</span>     <span class="comment">#    slot   face   partner  cleanings    mount time </span></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1161L4  HCART  TLD      0       2     -       -           1     2017/07/03 08:59</span><br><span class="line">1168L4  HCART  TLD      0       7     -       -           1     2017/10/02 08:21</span><br><span class="line">1174L4  HCART  TLD      0       5     -       -           1     2018/01/08 09:39</span><br><span class="line">1181L4  HCART  TLD      0       4     -       -           1     2018/04/02 07:54</span><br></pre></td></tr></table></figure><p><code>※プール名での問い合わせが可能な[pn]オプション</code><br><code>※ボリューム情報が簡易形式で出力される[b]オプション</code></p><h3 id="BPIMPORT"><a href="#BPIMPORT" class="headerlink" title="BPIMPORT"></a>BPIMPORT</h3><p>テープメディア情報のカタログエントリの作成（Phase1）、データのインポート（Phase2）を行うコマンド<code>VMQUERY</code>で確認したmediaIDを指定する。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/openv/netbackup/bin/admincmd/bpimport -id [mediaID]</span><br><span class="line">Import phase 1 started 2020年07月13日 11時13分46秒</span><br><span class="line">11:13:46 INF - Create DB information <span class="keyword">for</span> media id [mediaID].</span><br><span class="line">11:13:46 INF - Initiation of bptm process to phase 1 import media id [mediaID] was successful.</span><br><span class="line">11:13:49 INF - Waiting <span class="keyword">for</span> mount of media id [mediaID] on server XXXXXXX <span class="keyword">for</span> reading.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">Import phase 2 started 2020年07月13日 11時23分49秒</span><br><span class="line">11:23:51 INF - If Media id [mediaID] is not <span class="keyword">in</span> a robotic library administrative interaction may be required to satisfy this mount request.</span><br><span class="line">11:23:53 INF - Waiting <span class="keyword">for</span> mount of media id [mediaID] on server XXXXXXX  <span class="keyword">for</span> reading.</span><br><span class="line">11:25:01 INF - Waiting <span class="keyword">for</span> positioning of media id [mediaID] on server XXXXXXX  <span class="keyword">for</span> reading.</span><br><span class="line">11:25:02 INF - Beginning import on server XXXXXXX of client XXXXXXX .</span><br></pre></td></tr></table></figure><h3 id="BPLIST"><a href="#BPLIST" class="headerlink" title="BPLIST"></a>BPLIST</h3><p>テープ内のファイルを確認するコマンド<br><code>※上記でテープ情報のインポートが完了している対象のみ実行可能</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/openv/netbackup/bibplist -C ＜クライアント名＞ -R -s ＜検索範囲開始日時＞ -e ＜検索範囲終了日次＞ ＜検索対象パス＞</span><br><span class="line">-rw-r----- 200       200         24884756K  3月 20  2019 /XXX/XXX/XXX</span><br><span class="line">-rw-r----- 200       200         24884756K  3月 20  2019 /XXX/XXX/XXX</span><br><span class="line">-rw-r----- 200       200         24884756K  3月 20  2019 /XXX/XXX/XXX</span><br><span class="line">-rw-r----- 200       200         24884756K  3月 20  2019 /XXX/XXX/XXX</span><br></pre></td></tr></table></figure><h3 id="BPRESTORE"><a href="#BPRESTORE" class="headerlink" title="BPRESTORE"></a>BPRESTORE</h3><p>テープ内のファイルをオリジナルと同一のパスへ上書きリストアを行うコマンド</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/openv/netbackup/bin/bprestore -C ＜バックアップ元クライアント名＞ -D ＜バックアップ先クライアント名＞ -s ＜検索範囲開始日時＞ -e ＜検索範囲終了日次＞ </span><br><span class="line">11:10:40 (43724.xxx) Restore job id 43724 will require 1 image.</span><br><span class="line">11:10:40 (43724.xxx) Media id [mediaID] is needed <span class="keyword">for</span> the restore.</span><br><span class="line"></span><br><span class="line">11:11:14 (43724.001) Restoring from image created 2020年07月14日 08時14分33秒</span><br><span class="line">11:11:15 (43724.001) TAR STARTED</span><br><span class="line">11:11:15 (43724.001) INF - If Media id [mediaID] is not <span class="keyword">in</span> a robotic library administrative interaction may be required to satisfy this mount request.</span><br><span class="line">11:11:17 (43724.001) INF - Waiting <span class="keyword">for</span> mount of media id [mediaID] on server XXXXXXX <span class="keyword">for</span> reading.</span><br><span class="line">11:12:25 (43724.001) INF - Waiting <span class="keyword">for</span> positioning of media id [mediaID] on server XXXXXXX <span class="keyword">for</span> reading.</span><br><span class="line">11:12:26 (43724.001) INF - Beginning restore from server XXXXXXX to client XXXXXXX.</span><br></pre></td></tr></table></figure><p><code>※[R]オプション + ＜リストア先対象パス＞で別のパスにリストア可能</code></p><h1 id="個人的にハマったポイント"><a href="#個人的にハマったポイント" class="headerlink" title="個人的にハマったポイント"></a>個人的にハマったポイント</h1><p>上記コマンドがあればテープからローカルサーバへのリストアは最低限可能です。ここからは個人的にハマった箇所について共有したいと思います。</p><blockquote><p>＜テープリストアをするに至った経緯＞<br>基盤更改後の稼働していない旧オンプレミス基盤にて、テープバックアップにより長期保管されている過去10年分の特定データを抽出。<br>テープ装置がマウントされているバックアップサーバにてCUIベースでリストアを行い、抽出したデータをバックアップサーバから外部メディア（DVD等）にエクスポートという抽出作業を実施。（テープ → バックアップサーバ → 外部メディア）</p></blockquote><h2 id="テープメディア内のファイルを表示するBPLISTコマンドはIMPORTフェーズを終えてからでないと、正しく表示されない。"><a href="#テープメディア内のファイルを表示するBPLISTコマンドはIMPORTフェーズを終えてからでないと、正しく表示されない。" class="headerlink" title="テープメディア内のファイルを表示するBPLISTコマンドはIMPORTフェーズを終えてからでないと、正しく表示されない。"></a>テープメディア内のファイルを表示するBPLISTコマンドはIMPORTフェーズを終えてからでないと、正しく表示されない。</h2><p>多くのテープメディアから特定のファイルを探したいときに最も利用したいと考えるのが、テープメディア内のファイル情報を取得するBPLISTコマンドだと思います。しかし、<code>BPLIST</code>コマンドは<strong><em>テープメディア情報のカタログエントリを作成するインポート作業（BPIMPORT）を経てからでないと、実行結果が正常に返ってきません。</em></strong><br>コマンド実行してもリストが取得できない原因がわからず少しハマってしまいましたが、原因判明後も20～30分程度要するIMPORT作業がテープ単位で必要ということを知り、さらにへこんでしまいました。</p><h2 id="大容量ファイルをリストアしようとするとリストア時のメモリ確保に失敗し、処理が中断される。"><a href="#大容量ファイルをリストアしようとするとリストア時のメモリ確保に失敗し、処理が中断される。" class="headerlink" title="大容量ファイルをリストアしようとするとリストア時のメモリ確保に失敗し、処理が中断される。"></a>大容量ファイルをリストアしようとするとリストア時のメモリ確保に失敗し、処理が中断される。</h2><p><code>BPRESTORE</code>コマンドを利用して、oracleDBから作成されたフルバックアップのdmpファイル（80GB程度）のリストアを試みたところ、以下のエラーメッセージが出て、処理が中断されてしまいました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valoc failed <span class="keyword">for</span> hp_save_area_errno(12) (cannot allocate memory)</span><br></pre></td></tr></table></figure><p>どうやらリストアを開始するに差し当たって、最初にメモリを確保してから、リストア作業を開始するようなので、ファイル容量が10GB程度のものでも試行してみましたが、こちらもダメ。オンプレミス環境でメモリ増強対応も不可能であったため、メモリを食わずに本エラーを解消する手段がないか確認するためサポートへ問合せしたところ、サポートからの回答は、</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">リストア時のメモリ確保に失敗したと推察されます。</span><br><span class="line">メーカナレッジを確認した所、Linux環境にて同様にメモリ確保に失敗する以下のバグが確認されています。</span><br><span class="line">BUG REPORT: During some restores on Linux clients using VERITAS NetBackup (tm) 6.5 or 6.5.1, a memory leak can occur, causing the restore to fail.</span><br><span class="line"></span><br><span class="line">お客様ご利用のバージョンは6.5GA(パッチ無し)となっておりましたので、上記でご案内したBugに該当していると考えられます。</span><br><span class="line"></span><br><span class="line">回避方法は、パッチ適用かバージョンアップ以外には確認できませんでしたが、6.5はかなり古いバージョンのため、メーカサイト上には見つけられず、パッチの入手が困難となっております。</span><br></pre></td></tr></table></figure><p>とのこと。既存バグで回避はパッチ適用のみだが、利用バージョンが古くパッチが入手不可という結果に。。<br>結果的にギリギリエラーが出ない2～3GB程度に分割されたdmpファイルが偶然見つかったので、そちらでなんとかリストアは出来ましたが、一時はどうなることやらとかなり肝を冷やしました。。<br>※コマンド実行からメモリ不足エラーが出るまで、1時間から長くて5時間程度要してしまうのも悩みの種でした。。</p><blockquote><p>＜実行環境＞<br>対象サーバ：HP Proliant DL 385 G5（バックアップサーバ）<br>搭載メモリ：8GB<br>プロダクト：Veritas<br>製品名：NetBackup 6.5</p></blockquote><h2 id="複数テープを連続的にリストアしようとすると、「Restore-Started」のメッセージ出力されて以降、処理が開始されないことがある。"><a href="#複数テープを連続的にリストアしようとすると、「Restore-Started」のメッセージ出力されて以降、処理が開始されないことがある。" class="headerlink" title="複数テープを連続的にリストアしようとすると、「Restore Started」のメッセージ出力されて以降、処理が開始されないことがある。"></a>複数テープを連続的にリストアしようとすると、「<code>Restore Started</code>」のメッセージ出力されて以降、処理が開始されないことがある。</h2><p>複数テープのリストアを続けて実行しようとしたところ、1本目では「<code>Restore Started</code>」のメッセージ後即座にリストアが開始されたのですが、2本目になると「<code>Restore Started</code>」後、後続処理が開始されず、リストアjobの状態も「<code>Queued</code>」から変化なし。</p><p>何度か様々なパターンで試行しましたが、2本目で本事象が高頻度で発生するため、サポートに問い合わせをしました。<br>サポートからの回答は、</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">リストアジョブがアクティブになるまでにかかる時間は、主に復元されるファイルの数によって異なります。リストアするファイルの数が多いほど、ジョブがQueued状態に留まる時間が長くなります。</span><br><span class="line"> </span><br><span class="line">リストアジョブのStateが「Queued」は、マスターサーバー（CPU、メモリ、およびイメージカタログを保持するディスク）の仕様と、ファイルのリストを作成している間にリストアジョブで使用できるリソース量にも依存します。</span><br><span class="line">マスターサーバーが頻繁にスワップしている場合や、マスターサーバーで他の多くのジョブが実行されている場合は、ジョブがQueued状態に留まる時間が大幅に増加します。</span><br></pre></td></tr></table></figure><p>・・・。<br>釈然としない回答でしたが、時間を空けてコマンド再実行を行うと事象としては解消されました。<br>複数テープの連続的リストアを行うためにシェルスクリプト等で自動化を図る場合には、別途策を講じる必要がありそうです。</p><p>以上、私がテープリストア時にハマったポイントでした。</p><h1 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h1><p>上記で上げたハマりポイントなど不便なところはたくさんありますが、一方で、安価で大容量なテープメディアや可搬性に優れている点などから磁気テープによるオフラインでのバックアップ/リストアは近年再評価されていると言われています。</p><p>テープ装置での運用を導入する際には、メモリ依存で処理エラーが発生するバグなども念頭に置き、本番運用を想定したリストアのテストも抜かりなく実施できればと思います。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、2018年新卒入社の中本です。&lt;/p&gt;
&lt;p&gt;掲題の通り、本稿ではテープバックアップ/リストアについてご紹介した
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="バックアップ" scheme="https://future-architect.github.io/tags/%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97/"/>
    
      <category term="リストア" scheme="https://future-architect.github.io/tags/%E3%83%AA%E3%82%B9%E3%83%88%E3%82%A2/"/>
    
      <category term="テープ装置" scheme="https://future-architect.github.io/tags/%E3%83%86%E3%83%BC%E3%83%97%E8%A3%85%E7%BD%AE/"/>
    
      <category term="NetBackup" scheme="https://future-architect.github.io/tags/NetBackup/"/>
    
      <category term="Veritas" scheme="https://future-architect.github.io/tags/Veritas/"/>
    
  </entry>
  
  <entry>
    <title>「2020年代のコンテナ時代のPythonアーキテクチャ&amp;デプロイ」というテーマでPyCon.jp 2020で発表してきました</title>
    <link href="https://future-architect.github.io/articles/20200910/"/>
    <id>https://future-architect.github.io/articles/20200910/</id>
    <published>2020-09-09T15:00:00.000Z</published>
    <updated>2020-09-10T00:42:08.476Z</updated>
    
    <content type="html"><![CDATA[<p>初のオンライン＆Python 2サポートが終了したあとのPyCon.jpという節目のイベントで発表してきました。</p><p><img src="/images/20200910/IMG_0039.PNG" alt=""></p><p>発表資料はこちらになります。</p><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vTpZWvGItGIoj4hEX9enLZOf4y1vKWGRmbNxDfmD_tyS4U4D4lYXLtzMuXva_HhJ6mzOAtZOJNAoaow/embed?start=false&loop=false&delayms=3000" frameborder="0" width="100%" height="569px" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><p>日英表記にした関係で表現をだいぶシンプルに削ることになったりしたので、口頭での説明のみ行ったこととか、その後のTwitterの感想を見て思ったことなどを軽く補足します。</p><h2 id="コンテナの時代"><a href="#コンテナの時代" class="headerlink" title="コンテナの時代"></a>コンテナの時代</h2><p>コンテナのカバレッジが広がっている事例としてはDensoのMisakiとか戦闘機にKubernetesを載せてみました、とかもあります。</p><ul><li><a href="https://www.publickey1.jp/blog/20/kubernetesmisaki.html" target="_blank" rel="noopener">https://www.publickey1.jp/blog/20/kubernetesmisaki.html</a></li><li><a href="https://www.publickey1.jp/blog/20/kubernetesf-16.html" target="_blank" rel="noopener">https://www.publickey1.jp/blog/20/kubernetesf-16.html</a></li></ul><p>なお、この説明ではDockerをベースにしていますが、世の中にはランタイムもビルドツールも、Docker以外もたくさんあります。ビルドのレイヤーをどうするのかの問題とかはDockerの設計によって発生した新しい問題な気もしますし、Debianとかのベースイメージも外部でビルドした内容をただファイルコピーしているだけだったりするので、Dockerfileのみのイミュータブルインフラという考え方も別に天地ができたころからのルールというわけではなく、今後は外部ツールとのハイブリッドとかが出てこないともいえないし、ここに書いているベストプラクティスが今後いつまでも続くわけではなく、そのうち知識のアップデートが必要になる可能性もあります。</p><h2 id="コンテナの仕組み"><a href="#コンテナの仕組み" class="headerlink" title="コンテナの仕組み"></a>コンテナの仕組み</h2><p>ここの図はいくつか簡略化しています。</p><ul><li>ここでは仮想化の図はVirtualBoxとかVMWareとかを使った完全仮想化を想定した図になっています。準仮想化であっても、ホストOSの中の対象アプリを直接見れるわけではない、という点ではこの説明の範疇ではあります。</li><li>コンテナも、Linuxを使ってLinuxイメージを動かした想定の図です。WindowsやmacOSの場合は、ホストOSのカーネルとは別にLinuxカーネルを動作させて、その中でDockerを動かしますので、やや事情が異なります。</li></ul><p>macOSのDockerの場合はまず、この仮想PCのつかうCPUコア数やメモリ、ストレージを設定します。ストレージは可変長ストレージなので細かいことは気にしなくても良いのですが、macでコンテナが遅い場合はメモリやCPUの調整が必要です。</p><p>Windowsは以前はmacOSと同じでしたが、WSL2をつかうバックエンドにすると、LinuxからオンデマンドでWindowsの持っているCPUやメモリを自由に割当できるようになり、macより柔軟になりました。Windowsの使えるコアのすべてと、メモリの80%がLinuxから利用可能なメモリに見え、必要に応じてLinux側にメモリとCPUを渡します。実装としてはVMの中で動いているのですが、使い勝手としてはLinuxに近くなりました。もちろん、使いすぎないように<a href="https://docs.microsoft.com/ja-jp/windows/wsl/release-notes#build-18945" target="_blank" rel="noopener">あらかじめMaxのCPUとメモリを制限しておく</a>こともできます。</p><p>しかし、<a href="https://github.com/microsoft/WSL/issues/4166#issuecomment-662705705" target="_blank" rel="noopener">現時点では使い終わったメモリがうまくWindowsに返らず、対症療法としてメモリ制限が50%にされる変更があったり</a>もろもろ混乱は続いています。早く解決して欲しい。</p><p><a href="https://qiita.com/yoichiwo7/items/e3e13b6fe2f32c4c6120" target="_blank" rel="noopener">https://qiita.com/yoichiwo7/items/e3e13b6fe2f32c4c6120</a></p><p>なお、Pythonの発表なので説明はしませんでしたが、Java 8の場合はDockerが用意する壁を突き抜けてメモリを確保しにいってしまうというバグ？があるらしいので、もしJavaを使っている人はJava 8 update 212（ライセンスが変わったあとのバージョンなので注意）か、Java 11以降をつかうようにしましょう。</p><ul><li><a href="https://blog.softwaremill.com/docker-support-in-new-java-8-finally-fd595df0ca54" target="_blank" rel="noopener">https://blog.softwaremill.com/docker-support-in-new-java-8-finally-fd595df0ca54</a></li></ul><h2 id="コンテナの利用法"><a href="#コンテナの利用法" class="headerlink" title="コンテナの利用法"></a>コンテナの利用法</h2><p><img src="/images/20200910/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2020-08-28_12.04.23%EF%BC%883%EF%BC%89.png" alt=""></p><p>ここではいろいろなコンテナの開発での利用方法について紹介しました。まず注意点として、ホストのフォルダをマウントする方式の場合、Linuxのようなただ同一ファイルシステムを別の視点で見せている場合は問題ありませんが、macOSやWindowsのような仮想PCが絡む場合は、ゲストのOS側のファイルシステムにファイルを転送する必要があります。そのため、転送量が大きくなるとパフォーマンスが著しく落ちる可能性があります。macでは新しいマウント方式が入って改善されようとしていたりしますが、<a href="https://github.com/docker/for-mac/issues/1592" target="_blank" rel="noopener">Mutagenが入るぞ、やっぱりやめるぞ</a>とか現在進行形でいろいろ話がされています。</p><p>ゲスト環境の中に潜り込んで編集してくれるような開発環境があれば解決しますが、現時点ではVisual Studio Codeのみがこれに対応しています。PyCharmなどのJetBrains製のツールなどはこれに対応しておらず、Linux版のアプリを使ってホストのX ServerにGUIを飛ばすとかしなければいけません。VSCodeを使うか、マウントの速度ペナルティを負うか、画面を飛ばすか、処理系を動かすのを諦める変わりにツールの自由を得るか、などいろいろトレードオフが現時点ではあります。JetBrainsの方でもissueとしては上がっています。今後の開発ツールは仮想環境内部のバックエンドと、開発ツールのUIのフロントエンドを分離して仮想環境に対応していく、ということで解決されてくると思います。</p><ul><li><a href="https://youtrack.jetbrains.com/issue/JBR-2310" target="_blank" rel="noopener">https://youtrack.jetbrains.com/issue/JBR-2310</a></li></ul><p>そんな感じで、VSCodeが現状は自由度が高いので、コンテナ活用の絵はVSCodeにしていたのでした。僕はこの絵の一番右のスタイルでやることが多いです。Python、Go、Node.jsのどの言語もマルチプラットフォームはきちんとしているので、現在進行形で編集しているコードを動かすものはOSネイティブで動かし、JetBrains系のIDEを使っています。</p><p>これと同じような問題は、WindowsとWSL2間でもあったりします。あっちの方がさらに複雑だったりしますので、そのうち別のエントリーを書くかもしれません。</p><h2 id="コンテナ時代のアーキテクチャ"><a href="#コンテナ時代のアーキテクチャ" class="headerlink" title="コンテナ時代のアーキテクチャ"></a>コンテナ時代のアーキテクチャ</h2><p>古きよきUNIX世界のアーキテクチャに先祖帰りしているぞ、という話をしました</p><ul><li>1つのプロセスが1つのタスクを</li><li>環境変数で設定を変更</li><li>TCP/UDPのソケットを使って外部へのサービスの提供（HTTPサーバー含む）</li><li>ファイルなどの保存もTCP/UDPのソケットを使ってリクエスト</li><li>ログは標準出力へ</li><li>シグナルでプロセスの終了</li></ul><p>シグナルの話はとくに発表では触れませんでしたが、Pythonでは余計なことをしなければ自然と対応できる気がします。</p><p>オンプレで動かしていたサービスをとりあえずコンテナ化してしまうとやりがちなのが、systemdとかを入れて、サービスモリモリのコンテナを作ってしまうというものがあります。systemdなどを使わずに、デーモンなども作らずに、コンテナ中でフォアグラウンドプロセスとしてすべて起動するようにします。そのコンテナを複数束ねてサービスを実現するようにします。お子様ランチのようなワンプレートで全部乗せではなく、1品1品別皿に盛られて、量を増やしたい場合は同一種の皿を増やす回転寿司スタイルがコンテナです。</p><p>ログ出力はサイドカーよりも標準出力で、というのはコンテナのログドライバーとかでそういうものができるようになってきた、という段階で、まだ100%そうだ、とは言えないとは思います。ですが、アプリケーションにログの出力先を教えてあげないといけない、というのは設計思想的にはコンテナっぽくはないので、ログドライバー経由が今後は増えてくるでしょう。</p><p>ちなみに、OpenCensus/OpenTelemetryでぐぐると僕の書いた<a href="https://future-architect.github.io/articles/20190604/">弊社の技術ブログの記事</a>が上位に出てきます。Chromeのシークレットウインドウで検索をすると日本語では1位、英語でも10位以内でした。自慢です。</p><h2 id="コンテナ時代のPythonアーキテクチャ"><a href="#コンテナ時代のPythonアーキテクチャ" class="headerlink" title="コンテナ時代のPythonアーキテクチャ"></a>コンテナ時代のPythonアーキテクチャ</h2><p>前節の話をPythonで実現するには、といった解説です。Dockerのベストプラクティスなどによると、プロセスマネージャなどは利用せずにアプリケーションを直接起動するように書いています。プロセスマネージャというと、PythonではWSGIのgunicorn、uwsgiですね。Rubyだとrackのunicorn、puma、Node.jsだとpm2とかが該当します。ただ、Pythonの場合はFlaskやDjangoなども、組み込みのウェブサーバーはデバッグ用で、そもそもシングルスレッドで1つの処理でブロッキングしたりと性能をまったく<br>重視しない環境だったりします。各フレームワークもgunicornなどの利用を進めていたりしますので、Pythonの場合はgunicornに最低限のワーカーをぶら下げたものをコンテナとするのが良いでしょう。</p><h3 id="アプリケーションフレームワークとパフォーマンス"><a href="#アプリケーションフレームワークとパフォーマンス" class="headerlink" title="アプリケーションフレームワークとパフォーマンス"></a>アプリケーションフレームワークとパフォーマンス</h3><p>僕の周りのPythonistaの中でちょっと話題になるのがこのプレゼンで紹介したStarletteです。あとは、この<a href="https://www.starlette.io/" target="_blank" rel="noopener">Starlette</a>の上に構築されたAPIサーバーのためのフレームワークの<a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener">fastapi</a>です。せっかくPython2がなくなったので、Python3の性能を活用するこれらのフレームワークの利用が増えると面白く仕事ができるんじゃないかな、と思います。フューチャー社内でPython案件で何か質問とかあれば僕に問い合わせてもらいたいのですが、これらのフレームワークを使うヘルプであればさらに大歓迎です。</p><p>Flaskで作ってみたアプリケーションは以下の通りです。たいてい、外部のサービスに問い合わせてその結果をマッシュアップして返すということで、urllibを使ってマシン内部に起動したnginxのコンテナにリクエストを投げ、その結果をそのまま返すというコードです。</p><figure class="highlight python"><figcaption><span>app.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    j = json.load(urllib.request.urlopen(<span class="string">"http://nginx/index.json"</span>))</span><br><span class="line">    <span class="keyword">return</span> jsonify(j)</span><br></pre></td></tr></table></figure><p>Dockerfileはこんな感じです。<a href="https://future-architect.github.io/articles/20200513/">仕事でPythonコンテナをデプロイする人向けのDockerfile (1): オールマイティ編</a>で紹介したエッセンスがいろいろ入っています。今後はマルチステージビルド必須です。BuildKitといったビルド高速化のソリューションもマルチステージビルドをしなければほぼ意味がありません。Docker力を鍛えるにはまずマルチステージビルドです。</p><figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span>-slim-buster</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> APP_HOME /app</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$APP_HOME</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install -r requirements.txt</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONUNBUFFERED=TRUE</span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> gunicorn --<span class="built_in">bind</span> :8000 --workers 1 app:app</span></span><br></pre></td></tr></table></figure><p>Starletteのコードはこんな感じです。asyncioのセッションとかが出てくるのでちょっと冗長ですが、やっていることはそんなに難しくはないでしょう。<a href="https://www.starlette.io/routing/" target="_blank" rel="noopener">routes配列</a>を利用して、パスごとに別のハンドラを設定というのも当然できます。デコレータを使うAPIの方がお洒落に見えますが、まあこっちもそんなに大変ではないかと思います。</p><p>こちらも同じNginxにリクエストを投げていますが、asyncioを生かしたaiohttpを使ったリクエストを投げています。</p><figure class="highlight python"><figcaption><span>main.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> starlette.applications <span class="keyword">import</span> Starlette</span><br><span class="line"><span class="keyword">from</span> starlette.responses <span class="keyword">import</span> UJSONResponse</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">app</span><span class="params">(scope, receive, send)</span>:</span></span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    resp = <span class="keyword">await</span> session.get(<span class="string">"http://nginx/index.json"</span>)</span><br><span class="line">    response = UJSONResponse(<span class="keyword">await</span> resp.json())</span><br><span class="line">    <span class="keyword">await</span> response(scope, receive, send)</span><br><span class="line">    <span class="keyword">await</span> session.close()</span><br></pre></td></tr></table></figure><p>Dockerfileは以下のような感じです。こちらは<a href="https://future-architect.github.io/articles/20200514/">仕事でPythonコンテナをデプロイする人向けのDockerfile (2): distroless編</a>で紹介したDistrolessを使っています。</p><figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.7</span>-slim-buster as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /opt/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.lock /opt/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.lock</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> gcr.io/distroless/python3-debian10 as runner</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /usr/<span class="built_in">local</span>/lib/python3.7/site-packages /root/.<span class="built_in">local</span>/lib/python3.7/site-packages</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /usr/<span class="built_in">local</span>/bin/gunicorn /opt/app/gunicorn</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> main.py /opt/app/main.py</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /opt/app/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PYTHONUNBUFFERED=TRUE</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"./gunicorn"</span>, <span class="string">"-w"</span>, <span class="string">"1"</span>, <span class="string">"-k"</span>, <span class="string">"uvicorn.workers.UvicornWorker"</span>, <span class="string">"--log-level"</span>, <span class="string">"warning"</span>, <span class="string">"--bind"</span>, <span class="string">":8000"</span>, <span class="string">"main:app"</span>]</span></span><br></pre></td></tr></table></figure><p>これらのコンテナを1コアのCPUに割当て、いろいろ属性を変えつつabで計測してみました。なんかMacBook Airは発熱してくると速度が落ちてくるのか安定はしないので具体的な数値を出して議論するような結果は得られませんでしたが、Starletteの方が倍以上高速でした。並列をかなり増加させると、Flaskの方はどんどんパフォーマンスが落ちてきてしまいましたが、Starletteは並列数によらず一定のリクエストを毎秒捌いていました。またワーカー数やスレッド数を1-3あたりで変更して計測しても、Starletteの速度の安定性は変わらずでした。Flaskはスレッドを2にすると少し上がるところもありましたが、ベストプラクティスの3（コア数x2 + 1）にするとかえって落ちたりと安定せずでした。</p><p>ただ、CPUバウンドかI/Oバウンドか、タスクの特性がどちらかにどの程度寄っているかはアプリケーションによって違います。オライリージャパンから出版されたばかりの<a href="https://www.oreilly.co.jp/books/9784873119175/" target="_blank" rel="noopener">Effective Python第2版</a>の項目63あたりのasyncioのセクションではasyncioのイベントループの中でブロッキングする処理を入れてしまうと全体として応答性が下がってしまう話などが書かれています。時間がかかるがレスポンスを返したあとに処理しても構わないもの（バックグラウンドプロセスへのタスクの移譲など）の場合は項目64で紹介されている<code>concurrent.futures</code>を利用するなどした方が良いかもしれません。</p><p>非同期I/Oということで特性はNode.jsやGoに近くなると思いますが、チューニングポイントが減って、リソースをどれだけ増やせばどれだけ捌けるのかが見通しやすい非同期I/Oの特性は、インフラを担当する人にはフレンドリーで助かるんじゃないかと思います。</p><h3 id="ログ"><a href="#ログ" class="headerlink" title="ログ"></a>ログ</h3><p>構造化ロギングについて紹介しました。構造化ロギングは次のリポジトリでPython/Java/Node.js/Go/PHPの実装方法が紹介されています。もしRubyとか他の言語のユーザーの人はPRを送ってみると良いと思います。</p><p><a href="https://github.com/ymotongpoo/cloud-logging-configurations/blob/master/python/structlog/main.py" target="_blank" rel="noopener">https://github.com/ymotongpoo/cloud-logging-configurations/blob/master/python/structlog/main.py</a></p><p>クラウドサービスにつながって便利になるものの、ローカルでは残念ながらそこまで利便性は高くはない、というか検索とかはgrepでやるなら特に普通のログと変わるところはないのですが、たいていどのロガーもカラフルにして出力する機能があったりします。ログの視認性はかなり上がるので、ローカルであっても使ってみると良いのではないでしょうか？これとは別にローカルのビューアーはあってもいいな、と思って少し作り始めて見たりもしています。</p><p>ちょうどPyCon直後に開催されたゲーム開発者のカンファレンスのCEDECでも、任天堂の方がリングフィットアドベンチャーの話をされていて、その中で構造化ロギングの話も出ていました。構造化ロギング来ています。</p><ul><li><a href="https://www.famitsu.com/news/202009/06205314.html" target="_blank" rel="noopener">https://www.famitsu.com/news/202009/06205314.html</a></li></ul><h3 id="イメージ選定補足"><a href="#イメージ選定補足" class="headerlink" title="イメージ選定補足"></a>イメージ選定補足</h3><p>イメージ選定においては、Debian系が無難ですよというのと、Debian系の変種のdistrolessについて紹介しました。</p><p>1点、手元で試したものの検証できなかったのがGPU対応です。Pythonでウェブサービスというと機械学習も関係してくることが多いです。で、Dockerイメージで機械学習のアプリのデプロイというのも事例として良く聞く気がします。</p><p>この辺りをみながら、手元のGeForce RTX 2060のノートでWSL2でDocker GPUというのにチャレンジしてみました。</p><p><a href="https://docs.nvidia.com/cuda/wsl-user-guide/index.html#getting-started" target="_blank" rel="noopener">https://docs.nvidia.com/cuda/wsl-user-guide/index.html#getting-started</a></p><p>一応、ベンチマークは実行できてDockerの中でGPUも認識したのですが、ここに出てくる<code>nvidia-container-cli info</code>コマンドなどは実行できず・・・</p><p><a href="https://blog.amedama.jp/entry/docker-nvidia-container-toolkit" target="_blank" rel="noopener">https://blog.amedama.jp/entry/docker-nvidia-container-toolkit</a></p><p>ここの説明によると、<code>--gpus</code>オプションをつけるとコンテナ内部にホスト側にインストールされているコマンドやライブラリがマウントされてコンテナ内部からも使えるようになるらしいのですが手元では確認できませんでした。<a href="https://hub.docker.com/r/nvidia/cuda" target="_blank" rel="noopener">NVIDIA公式CUDAイメージ</a>はUbuntuとCentOSここで紹介されているのはなんの変哲もないUbuntuイメージで実行していました。原理原則からすればDebianでもいいと思われますが・・・ちょっと機械学習周りはそのうちしっかり調べたいです。</p><h2 id="その他のお話"><a href="#その他のお話" class="headerlink" title="その他のお話"></a>その他のお話</h2><p>この発表では、ビルドイメージのサイズ以外に、ビルド時間も大切であると話をしました。その際にビルド時間にストレートに聞いてくる要素としてビルドのコンテキストについて紹介しました。どのファイルがDockerサーバーへの送信対象になっているかを確認するには以下のDockerfileをビルドして実行してみると分かります。</p><figure class="highlight dockerfile"><figcaption><span>Dockerfile.ctx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /context</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . ./</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"du"</span>, <span class="string">"-h"</span>]</span></span><br></pre></td></tr></table></figure><p>何も設定しないと、.gitフォルダなども送信対象になってしまうので、.gitフォルダが数100MBとかあると、それだけで毎回ビルド時間が数10秒伸びてしまいます。</p><p>.gitignoreと同じフォーマットの.dockerignoreファイルを置くことでDockerに無視されるファイルを指定できます。.git以外に、Dockerの中でビルドし直すようなビルド結果のファイルなどは除外しておくべきです。基本的には.gitignoreのファイルをコピーして.gitを足すぐらいで良いかと思います。</p><p>.gitをコンテキストに含まなければならないケースが1つあり、現在のGitのハッシュ値をとってきてビルド結果にどのコミット断面でビルドしたかの情報を入れたい場合です。あるあるですね。Node.jsのパッケージではありますが、<a href="https://www.npmjs.com/package/next-build-id" target="_blank" rel="noopener">next-build-id</a>みたいなツールが該当しますが、これを実行するためには.gitフォルダもコンテキストに含める必要があります。</p><p>これの高速化のテクととしては、リポジトリの全ファイル履歴が格納されている巨大な.git/objectsフォルダにファイルの実態がいなくても<code>git rev-parse HEAD</code>コマンドは利用できます。ビルドの中でこのコマンドを使っているようなリポジトリの場合は、.git/objectsを.dockerignoreに追加することで、.gitフォルダを指定するのと99.9%同じ結果が得られます（他のフォルダは誤差）。ただし、このフォルダ自体は必要なので、.git/objectsを<code>RUN mkdir .git/objects</code>で作るようにしましょう。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Dockerコンテナがどういうものかを紹介しつつ、それにあったPythonのアーキテクチャの紹介をしてきました。口頭で説明したような内容はこのブログエントリーでだいぶ補完できたんじゃないかと思います。</p><p>技術ブログではGo色が強いのですが、フューチャーの中で一番人材豊富なのはJavaですし、個人的にはPythonも仕事でやりたいので、もし御用命あればお待ちしております。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;初のオンライン＆Python 2サポートが終了したあとのPyCon.jpという節目のイベントで発表してきました。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/20200910/IMG_0039.PNG&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;発表資料はこちらになります。&lt;/p
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="登壇資料" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E8%B3%87%E6%96%99/"/>
    
      <category term="Python" scheme="https://future-architect.github.io/tags/Python/"/>
    
      <category term="Docker" scheme="https://future-architect.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>キーボードを組み立ててみた話</title>
    <link href="https://future-architect.github.io/articles/20200909/"/>
    <id>https://future-architect.github.io/articles/20200909/</id>
    <published>2020-09-08T15:00:00.000Z</published>
    <updated>2020-09-09T00:39:54.809Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。<br>CSIGの井上です。</p><p>08/28に社内で「ITエンジニア怪談 ～背筋も凍る、ゾッとする話Night～ #3」というものがありました(後で公開されると思います)。その中で「自作キーボードの紹介」のLTがあり、キーボード作りたい熱が高まったので、翌日に作ってみた話をします。</p><p>本記事は、これからキーボード作りたいなぁ、という人を後押しするための記事です。<br>予算は <strong>25,000 - 30,000円</strong> 位を見ておくとよいです。</p><h1 id="前提知識や技術"><a href="#前提知識や技術" class="headerlink" title="前提知識や技術"></a>前提知識や技術</h1><p>基本的には作りながら学ぶことで、ほぼ前提知識は不要です。<br>しかしながら、「作り方が細かく説明してあるキーボードキット」を選んだほうがよいです。 </p><ul><li>「作り方が細かく説明してある」ものがよい<ul><li>初心者向けに注意点がある程度細かく書いてあるもの、がお勧めです。WEB上で作成者が組立て手順を公開しているので、買う前に確認しておきましょう。</li><li>中級者向けに一般的な作法（組立て順番とか）が省略されているものは、慣れてからのほうが良いです。</li><li>パーツ売りの物もありますが、自作キット（キースイッチやキーキャップ <strong>以外</strong> がそろっている）をお勧めします。</li></ul></li><li>はんだ付け経験は必要<ul><li>キーボードコントロール用のProMicroのはんだ付けは、慣れが必要かもしれません。</li><li>これ以外は、普通のはんだ付けができれば問題ないと思います。</li><li>はんだ付け自体不要の物も存在するので、不安がある場合は詳しい人に相談しましょう。</li><li>ProMicroは下に示した物です。キーサイズと比べて、自身のはんだ力（経験値）が足りるか検討してください。無理そうな場合は、まずは <a href="https://yushakobo.jp/product-tag/%E3%83%9E%E3%82%AF%E3%83%AD%E3%83%91%E3%83%83%E3%83%89/" target="_blank" rel="noopener">マクロパッド</a> <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>と呼ばれる少数のキースイッチが付いたものを作ってみるのがよいと思います。失敗しても懐の痛みが少ないですし。<br><img src="/images/20200909/ProMicro.jpg" alt=""></li></ul></li><li>英語キーが基本<ul><li>販売されているキーキャップは英語配列のものが大半です。</li><li>一応日本語キーキャップもありますが、キースイッチとの合わせ/キーボードのキー数などと組み合わせの検討が必要です。</li></ul></li></ul><p>尚、私のキーボード遍歴は以下の通りです。そんなに拘りは無いです。</p><ul><li>大学でSlackwareやTureboLinuxなどを使っていたころは、インストール時は英語キーボードから変更ができなかった。キーレイアウトを変更するのが面倒だった為、英語キーボードを利用していました。</li><li>HappyHackingKeybord（初代）発売当時、3台買って使っていました。別々のPCに接続していた為、車用塗料でケースに色を付けていました（未塗装の白、三菱の緑、本田の赤、の塗料）。</li><li>BTC 5100Cキーボードが最高。15年は使ってるかもしれません（2台持っています）。</li><li>80%キーボード<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>好きで、おおよそ12台くらい持っていました。</li><li>トラックボール<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>派なので、トラックボール付きキーボードは見つけ次第買いますが、どれも低品質で泣きを見ます。</li><li>自作キーボードは、riconkenの <a href="https://riconken.bitbucket.io/hifumi/" target="_blank" rel="noopener">hifumi</a>（6キーのマクロパッド）を作った程度です。</li></ul><h1 id="組立ててみた"><a href="#組立ててみた" class="headerlink" title="組立ててみた"></a>組立ててみた</h1><p>08/28(Fri)に <strong>急速にキーボード作りたい欲が高まった</strong> ので、08/29(Sat)に秋葉原の <a href="https://yushakobo.jp/" target="_blank" rel="noopener">遊舎工房</a> に様子を見に行きました。<br>翌日には組立て終わり、利用開始しています。はんだ付けスピード次第で3-4時間あれば作れます。</p><h2 id="買いに行く"><a href="#買いに行く" class="headerlink" title="買いに行く"></a>買いに行く</h2><h3 id="組み立てるキーボードを選定する"><a href="#組み立てるキーボードを選定する" class="headerlink" title="組み立てるキーボードを選定する"></a>組み立てるキーボードを選定する</h3><p>「60%キーボード 、矢印キーがある、千鳥配列 <sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> 、左右分割 <sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup> という条件で検討したところ、<a href="https://eucalyn.shop/shop/kits/mint60-starter" target="_blank" rel="noopener">Mint60</a> に決定。</p><p>60%キーボード初めて作るのであれば、個人的には以下がお勧めです。</p><ul><li>左右分割であれば、Mint60は <a href="http://eucalyn.hatenadiary.jp/entry/how-to-build-mint60" target="_blank" rel="noopener">組立て手順</a> も詳しく、お勧めです。</li><li>左右分割でなくてよい場合は、<a href="https://yushakobo.jp/shop/dz60-rgb-v2/" target="_blank" rel="noopener">DZ60</a> がお勧めです。<ul><li>GH60互換キーボードとして複数のメーカーからパーツが出ています。</li><li>ダイオード接続済み、キースイッチははめ込み式のものもあり、はんだ付けが苦手でも作れそうです。</li></ul></li></ul><h3 id="付帯部品を買う"><a href="#付帯部品を買う" class="headerlink" title="付帯部品を買う"></a>付帯部品を買う</h3><p>キーボード本体以外にも、以下のものが必要です。</p><ul><li>キースイッチ<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup><ul><li>私は、重すぎずカチカチ鳴る（打鍵感覚が分かりやすい）ものが好きなので、Gateron青軸（1個45円程度）にしました。</li></ul></li><li>キーキャップ<sup id="fnref:7"><a href="#fn:7" rel="footnote">7</a></sup>、スタビライザー[^stabilizer]<ul><li>プロファイル[^profile]等いろいろあるので、TAI-HAO社のものを選択。</li></ul></li><li>TRRSケーブル<ul><li>左右のキーボードをつなぐ、3.5mmのステレオプラグです。オーディオレベルのものは不要です。</li><li>このケーブルの自作キットもあるようです。</li></ul></li><li>MicroUSB <sup id="fnref:8"><a href="#fn:8" rel="footnote">8</a></sup> - USB-Aケーブル<ul><li>ProMicroはMicroUSBなので、PCにつなぐケーブルが必要です。何でもよいと思います。</li></ul></li></ul><p>全部でこんな感じになります。<br><img src="/images/20200909/Mint60FullSet.jpg" alt=""></p><h2 id="組立てる"><a href="#組立てる" class="headerlink" title="組立てる"></a>組立てる</h2><h3 id="組立ての記録"><a href="#組立ての記録" class="headerlink" title="組立ての記録"></a>組立ての記録</h3><p>Mint60を買って組み立てた。</p><ul><li>ダイオードのはんだ付け</li><li>リセットスイッチ/TRRSコネクタのはんだ付け</li><li>スタビライザーの設置</li><li>キースイッチのはんだ付け</li><li>ProMicroのはんだ付け</li><li>LEDテープのはんだ付け</li><li>ケース収納</li></ul><p>LEDテープは追加の絶縁が必須で、微妙にケースサイズに合っていない気がするので移設を決意しました。</p><h3 id="改造"><a href="#改造" class="headerlink" title="改造"></a>改造</h3><p>LEDテープは端子が出ていない場所に移設したほうが安全です。<br>今回はProMicroの横が空いているので、ここに移設しました。</p><ul><li>ProMicroの横の空間に入る程度に、LEDテープを切る</li><li>両面テープでLEDテープを固定する</li><li>配線を延長する</li></ul><p>安全にLED点灯できた。<br><img src="/images/20200909/LEDRemove.jpg" alt=""></p><h3 id="ファームウェアの書き込み"><a href="#ファームウェアの書き込み" class="headerlink" title="ファームウェアの書き込み"></a>ファームウェアの書き込み</h3><p>組み立てキットの場合、ProMicroにはMint60用のファームウェアは書かれていません。故に、組み上げただけではキーボードとしては使えません。</p><p>全体として以下のように進めます。</p><ul><li>キーマップの準備<ul><li>キーマップを用意する</li><li>必要に応じて更新する</li><li>キーマップをhexファイルにコンパイルする</li></ul></li><li>ProMicroにキーマップを送り込む<ul><li>書き込み用ソフトを用意する</li><li>キーボード接続後にリセットを行い、ファームウェアを送り込む</li></ul></li></ul><h4 id="キーマップの準備"><a href="#キーマップの準備" class="headerlink" title="キーマップの準備"></a>キーマップの準備</h4><p>WEBサービスの<a href="https://config.qmk.fm/" target="_blank" rel="noopener">QMK Configurator</a>を利用します。</p><ul><li>“KEYBOARD”で”mint60”を選択すると、標準のキー設定が読み込まれる</li><li>“KEYMAP NAME”に適当な設定を入れ、画面を見ながら必要に応じてキー配列を変更する</li><li>変更が終わったら、右上の”COMPILE”を押し、hexファイルを回収する</li></ul><h4 id="ファームウェアの書き込み-1"><a href="#ファームウェアの書き込み-1" class="headerlink" title="ファームウェアの書き込み"></a>ファームウェアの書き込み</h4><p>Windowsの場合は<a href="https://github.com/qmk/qmk_toolbox/releases" target="_blank" rel="noopener">QMK Toolbox</a>を利用するのが一番簡単です。</p><ul><li>QMK Toolboxをダウンロードし、起動する</li><li>”Local file”に先ほどダウンロードしたhexファイルを指定する</li><li>右上の”Flash when ready”にチェックを入れる</li><li>キーボードを接続し、リセットボタンを押す<ul><li>リセットボタンを押すとCOMポート接続され、ファームウェアが転送される</li></ul></li><li>notepadなどでキー入力を確認する</li></ul><h3 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h3><p>完成です。<br>利用しながら使いやすいようにキーマップを変えるとよいでしょう。<br><img src="/images/20200909/mint60complete.jpg" alt=""></p><p>暫く使いましたが、いろいろ思うところが出てきました。</p><ul><li>「ESCは左上にある」が体に染みついているので、ちょっと不便<ul><li>もう20年以上Vimmerなので…</li></ul></li><li>最下段のキーが多すぎる<ul><li>無効にすればよいけど、物理的になくてもいいのでは？</li></ul></li><li>「6と^」のキーは左手で押したい<ul><li>基盤を自分で作らない限り、この要望は満たせなさそう</li></ul></li><li>作ってる時の写真を撮っていなかった<ul><li>作るだけのつもり、、ですからね…</li></ul></li></ul><p>そして、「技術ブログに投稿しないか」という話を頂いたので、翌週に新たにもう一つ買ってきました。。</p><h2 id="組立てる（自作キーボードMk-II）"><a href="#組立てる（自作キーボードMk-II）" class="headerlink" title="組立てる（自作キーボードMk.II）"></a>組立てる（自作キーボードMk.II）</h2><p>今度は <a href="https://yushakobo.jp/shop/choco60/" target="_blank" rel="noopener">Choco60</a> というキーボードを購入しました。</p><ul><li>青軸のキースイッチは必須<ul><li>会社で使う場合は騒音問題になるので、イヤホンで自分の耳を塞ぎ、なかったことにします。</li><li>今は在宅勤務なので、心おきなく打鍵音を出せます。やったね。</li></ul></li><li>矢印キーは存在しないので、レイヤーで対応する必要がある（Functionキーとの組み合わせ）<ul><li>人によっては、カーソルキーは物理であったほうが使いやすい人もいます。好みに合わせましょう。</li></ul></li><li>左上ESCだが、代わりに「~と`」のキーが右上に来た<ul><li>当面は「~/`」キーをBackspaceと押し間違えるリスクがありますが、ESCを物理で連打できる利点があるので目を瞑ります。</li></ul></li><li>かなりシンプルで、左右を結合すると非分割キーボードのようになる<ul><li>気分的に分割ではないように使えます。但し、左右接続のケーブルは必須なのであまり意味はありません。</li></ul></li><li>残念ながらLEDは利用できない<ul><li>初めて作るなら、LEDの見た目も良いので Mint60やDZ60をお勧めします。</li></ul></li></ul><h3 id="リードベンダを作る"><a href="#リードベンダを作る" class="headerlink" title="リードベンダを作る"></a>リードベンダを作る</h3><p>基盤にダイオードを接続する際に、コの字にダイオードを曲げておく必要があります。<br>「手で曲げる/ペンチを利用して曲げる/市販のリードベンダを買う」こともできますが、今回は家に3Dプリンタもあるので作ってしまいます。</p><ul><li>ダイオード本体は3.5mm程度</li><li>リードは0.5mm程度</li><li>曲げたリード間は、今回は7.5-8.0mmくらいが適当のようだ</li><li>適当にプロトタイプを作り <sup id="fnref:9"><a href="#fn:9" rel="footnote">9</a></sup> 、実機確認して微調整をしたら完成</li></ul><p>6個ずつ曲げて作れます。<br><img src="/images/20200909/3dprinter.jpg" alt=""></p><p><img src="/images/20200909/LeadVendor.jpg" alt=""></p><h3 id="はんだ付けをする"><a href="#はんだ付けをする" class="headerlink" title="はんだ付けをする"></a>はんだ付けをする</h3><p>曲げたダイオードをスルーホールに通し、はんだ付けします。<br>リードはあまり残さない形で切ってしまいます（私は、はんだ付け後に後で切る派です）。<br><img src="/images/20200909/DiodeLead.jpg" alt=""></p><p>キースイッチもはんだ付けします（今回はトッププレートは付けていません）。<br><img src="/images/20200909/keyswitch.jpg" alt=""></p><h3 id="ファームウェアを焼きこむ"><a href="#ファームウェアを焼きこむ" class="headerlink" title="ファームウェアを焼きこむ"></a>ファームウェアを焼きこむ</h3><p>今回のキーボードは矢印キーが無いので、Functionと組み合わせて利用します。</p><ul><li>Vimmer向けとして、Function（以下Fn）とhjklで左上下右に割当が違和感がない</li><li>Home/Endも同様に時々使うので、hjklの右である;’に割当</li><li>左上ESCはデフォルトで問題ない</li><li>Fnは頻繁に使えるように、右親指直下とする</li><li>時々使うDeleteは Fn+Backspace だと辛いので、レイヤー0で割当</li><li>弊社から割当られたPCは日本語版キーボードなので、一工夫<ul><li>英語キーボードを日本語キーボードのPCに接続すると、キー数の不足から入力できない文字が発生する</li><li>代表的なものは「￥」キー <sup id="fnref:10"><a href="#fn:10" rel="footnote">10</a></sup> であるため、このキーを割り当てると、英語キーボードを日本語PCに接続しても使える可能性が高まる</li></ul></li><li>Ejectは用意しよう</li><li>特殊入力はあまりいらないので、Fnは1つだけとする<ul><li>Fnキーは一般的に1種類ですが、MO(Modifier)0, MO1, MO2, と複数登録が可能</li><li>また、MO0とMO1の同時押し、のような設定も可能</li><li>頑張って複数のModifierを設定すると、訳が分からなくなる可能性が高い</li></ul></li></ul><p>Layer0は、標準の入力状態を示します。MOはModiferキーで、所謂Fnキーです。<br><img src="/images/20200909/keymap0.png" alt=""></p><p>Layer1は、Layer0の「MO0」と同時押しで入力できます。<br><img src="/images/20200909/keymap1.png" alt=""></p><h1 id="得られた知見"><a href="#得られた知見" class="headerlink" title="得られた知見"></a>得られた知見</h1><p>勢いでキーボードを2台作りましたが、私としては以下の知見を得られました。</p><ul><li>知らない領域の知識を得ることは、自己の成長になる<ul><li>知らないことを調べる、必要な知識を必要な時間で得る、等の練習になる</li><li>身軽に動く訓練になるため、自分の活動範囲が広がる</li></ul></li><li>ないものは作るのは、すごく楽しい<ul><li>治具が無ければ作ればいいし、キー配置が気に食わなければ自分で作ればいい</li><li>「6」キーｍ。が左に欲しい問題を解決するために、基盤を設計する…かもしれません</li></ul></li></ul><p>キーボードは難しい/練習したい　という場合は、例えばRiconkenのhifumiｋ（6キー）を作ってみるのがよいかもしれません。ProMicroを使っているので、キーの数以外は仕組みがほぼ同じです。楽にキーボードを作りたければ、DZ60でLED結線済み、キースイッチはソケット型を使うと簡単に作れます。</p><p><img src="/images/20200909/riconken.png" alt=""></p><p>もしキーボード自作に興味があるようなら、まずは行動を起こしてみるのがよいと思います。</p><p>以上</p><hr><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;">マクロパッド：テンキーパッド以下サイズの小さい入力装置。構成自体はキーボードと同じであるため、お手軽に構造を理解するには最適。ProMicroを使っているものであれば、レイヤーやLEDコントロールの練習になる。</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;">80%キーボード：テンキー付きのおおよそ100個のキーが付いたものをフルキーボード（100%）と呼称する。テンキーが無くなるとおおよそ80-75%、さらにFunctionキーが無くなると65-60%、数字キーが無くなるとおおよそ40%、スペースキーもなくなり3列になったものが30%、と称される。60%キーボード辺りから入力キーが足りなくなるので、Modifierキーとの組み合わせで利用することになる。30%キーボードは <a href="https://yushakobo.jp/shop/nomu30kit/" target="_blank" rel="noopener">このような</a> もので、利用には相当な修練が必要になるが、普通のキーボードに戻れなくなる可能性がある。所謂、沼。</span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;">トラックボール：ボールそれ自体を手で転がすポインティングデバイス。マウスのように移動の場所を取らず、20世紀には「デザイナーなどが使う」といわれていた。トラックボールの名器といえば、古くは<a href="https://pc.watch.impress.co.jp/docs/article/971020/ms.htm" target="_blank" rel="noopener">Microsoft IntelliMouse TrackBall</a>があり、販売終了時に涙した者も多い。現在はKensingtonのトラックボールが最適と考えられる。細かな操作を必要とする場合、ボールは大きいに越したことはない。尚、マウスと異なりボールが脱落しやすい構造の為、ボールを紛失して再購入、というパターンが存在する。</span><a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">4.</span><span style="display: inline-block; vertical-align: top;">千鳥配列：一般的なキーボードは列がずれており、Row Staggerd Layoutと呼ばれている。自作きーぼど界隈では、格子状にキーを配置したOrtholinear Layout（格子レイアウト）と呼ばれているものが多数存在する。曰く、「運指が直線的で最短であり、合理的」との事。RowStaggedに慣れていると、格子配列を使うには訓練が必要な事が多い。</span><a href="#fnref:4" rev="footnote"> ↩</a></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">5.</span><span style="display: inline-block; vertical-align: top;">左右分割：私がこの記事を書くきっかけになった「自作キーボードLT」で、「左右分割キーボードは肩こりに良い」と説明されていた。確かに、非分割キーボードを使うと、左右の方とキーボードで三角形の形になり、猫背の原因になりそうだ。分割キーボードなら左右を話して配置できるので、猫背は回避できそうだ。尚、左右分割キーボードは、左右をつなぐTRRSケーブルが必要になる。左右各キーボードにProMicroを載せており、同じファームウェアを焼きこんで利用する。</span><a href="#fnref:5" rev="footnote"> ↩</a></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">6.</span><span style="display: inline-block; vertical-align: top;">キースイッチ：かなりの種類あります。利用者の趣味や用途により決まる、キーボードの性格が決まる部分。主に、推した時の重さ、ストローク量、クリック音の有無などにより変わる。音や打鍵感は 青軸 &gt; 茶軸 &gt; 赤軸 が一般的。ゲーミング用にストロークを短くしたものもある。尚、キースイッチは沼であり、「紫、銀、黄、クリア、橙、ピンク、緑、といったマイナーなもの」「異なるスイッチを合体させた「キメラ」」「潤滑剤を塗る「ルブ」」「キーフィルムやOリングを使ったカスタム」などの謎の単語が頻出した。キースイッチ怖い。</span><a href="#fnref:6" rev="footnote"> ↩</a></li><li id="fn:7"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">7.</span><span style="display: inline-block; vertical-align: top;">キーキャップ：キーボードの文字が印字されている部分。キースイッチの軸の種類（Cherry MX互換軸、等）に合わせて、後述のプロファイルを選択して買うことになる。また、英語キーのものは流通しているが、日本語キーはほぼ流通していないと思われる（無いわけではない）。[^stabilizer]: スタビライザー：横に長いキーボードを安定して推すための補助機器。ShiftキーやEnter、Spaceなどで使われている。[^profile]: プロファイル：キーキャップの形状のこと。<a href="https://buildersbox.corp-sansan.com/entry/2019/08/16/110000" target="_blank" rel="noopener">ここ</a>にまとまってる。これは好みに依存すると思われる。OEMなどのプロファイルでキーキャップでキーボードの傾斜をつけることもできるが、ケースを傾けるように改造するとよい場合もある。</span><a href="#fnref:7" rev="footnote"> ↩</a></li><li id="fn:8"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">8.</span><span style="display: inline-block; vertical-align: top;">MicroUSB：Micoro USBは耐久性が無いので、頻繁に抜挿する運用には向かない。市販キーボードでもMicro USBが壊れて使えなくなったものは何個もある。自作キーボードの場合はUSB端子はProMicroに接続されているため、ProMicroを交換する（か、ProMicroのMicro USBメスを付け替える）ことで延々と利用できると思われる。また、ProMicro Type-Cというものもあり、これはProMicroの端子がUSB Type-Cになっているようだ。Type-Cの方が耐久性は高いので、予算があればこちらを使うのも良い。</span><a href="#fnref:8" rev="footnote"> ↩</a></li><li id="fn:9"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">9.</span><span style="display: inline-block; vertical-align: top;">プロトタイプ：今回のような簡単なオブジェクトであれば <a href="https://www.tinkercad.com/" target="_blank" rel="noopener">THINKERCAD</a> で十分モデルを作れます。これをスライサーにかけてしまえば、あとは印刷するだけ。プロトタイプを作る場合は、調整不要な部分は極力なくし、できるだけ必要最小限で作ると開発スピードが上がります。</span><a href="#fnref:9" rev="footnote"> ↩</a></li><li id="fn:10"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">10.</span><span style="display: inline-block; vertical-align: top;">￥キー：日本語キーマップのWindowsに 英語キーボードをつなぐと、キー数の問題で入力不能なキーが発生する。特に「￥（半角）」と「\」は扱いがひどい（詳細は省略）。Windowsでファイルサーバにアクセスする際は「￥(ﾊﾝｶｸ)」を使うことになり、「IMEで&quot;えん&quot;を変換して￥を入力し、それをコピーして&quot;￥￥ファイルサーバ名&quot;などで利用する」ということが発生する。キーコード自体が違うので、何らかの手段を用意しないと入力困難になるので注意が必要。尚、英語キーボードの場合は、漢字/変換などのキーが無いため、シンプルである。日本語入力は &quot;ALT + `&quot; 等で利用可能。古くからの*nixユーザは、Shift+SpaceをIME ON/OFFに割り当てていることも多い（Chrome OSでは CTRL+Spaceで、これも使いづらい）。</span><a href="#fnref:10" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。&lt;br&gt;CSIGの井上です。&lt;/p&gt;
&lt;p&gt;08/28に社内で「ITエンジニア怪談 ～背筋も凍る、ゾッとする話Night～ #3」というものがありました(後で公開されると思います)。その中で「自作キーボードの紹介」のLTがあり、キーボード作りたい熱が高まったので
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="電子工作" scheme="https://future-architect.github.io/tags/%E9%9B%BB%E5%AD%90%E5%B7%A5%E4%BD%9C/"/>
    
      <category term="自作キーボード" scheme="https://future-architect.github.io/tags/%E8%87%AA%E4%BD%9C%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89/"/>
    
  </entry>
  
  <entry>
    <title>フューチャー技術ブログで行っている連載企画が良いよって話</title>
    <link href="https://future-architect.github.io/articles/20200908/"/>
    <id>https://future-architect.github.io/articles/20200908/</id>
    <published>2020-09-07T15:00:00.000Z</published>
    <updated>2020-09-07T23:25:59.933Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/20200908/goose-908291_1280.jpg" alt=""></p><p><a href="https://pixabay.com/ja/users/Skitterphoto-324082/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=908291" target="_blank" rel="noopener">Rudy and Peter Skitterians</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=908291" target="_blank" rel="noopener">Pixabay</a>からの画像</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、技術ブログ運営の真野です。ブログ開設から4年半ほど運営を続けています。</p><p>運営のナレッジは<a href="https://future-architect.github.io/articles/20200530/">フューチャー技術ブログの運営で心がけていること</a>に書きましたが、”ブログ連載”という企画がかなり有益だと気がついたのと、ナレッジも溜まってきたのでまとめます。</p><p>フューチャー技術ブログでは2019年から連載企画と称して、 <strong>ある技術テーマに沿った記事を様々な人が集中的に公開する</strong> というイベントを開催しています。数えてみると思ったより多かったので表にまとめました。</p><table><thead><tr><th>No</th><th>テーマ</th><th>記事数</th><th>初投稿</th><th>概要</th></tr></thead><tbody><tr><td>1</td><td><a href="/tags/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E5%85%A5%E9%96%80/">インフラ入門</a></td><td>4</td><td>2017/1/9</td><td>業務・アプリ実装からすると影のイメージがあるインフラについて、この領域をやりたいと思う人を増やしたいというアツ思いから開始</td></tr><tr><td>2</td><td><a href="/tags/GoCDK/">Go Cloud</a></td><td>7</td><td>2019/11/11</td><td>日本でGoCloud（GoCDK）について触れている記事が少ないから、今なら天下が取れると某さんが先導して開始</td></tr><tr><td>3</td><td><a href="/tags/Auth0/">Auth0</a></td><td>3</td><td>2020/1/22</td><td>導入実績が増えたAuth0についてだいぶナレッジが溜まってきたので開始</td></tr><tr><td>4</td><td><a href="/tags/GCP%E9%80%A3%E8%BC%89/">GCP連載</a></td><td>10</td><td>2020/2/5</td><td>GCPの採用実績が増えてきたので良い機会だと開始</td></tr><tr><td>5</td><td><a href="/tags/DynamoDB%C3%97Go/">DynamoDB×Go</a></td><td>3</td><td>2020/2/25</td><td>最初はAWS×Goネタで開始しようとしたところ、書きたいと言ったメンバー全員がDynamoDBについて苦労した話で盛り上がったので範囲を狭めた</td></tr><tr><td>6</td><td><a href="/tags/%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E8%A8%98%E4%BA%8B%E9%9B%86%E4%B8%AD%E6%8A%95%E7%A8%BF/">フロントエンド記事集中投稿</a></td><td>7</td><td>2020/3/16</td><td>記事がバックエンドに寄り過ぎじゃね？と気がついたため、社内事情とバランスを取るために発動した企画。Vue.js使いが社内で激増したことも追い風に</td></tr><tr><td>7</td><td><a href="/tags/Serverless%E9%80%A3%E8%BC%89/">Serverless連載</a></td><td>6</td><td>2020/3/23</td><td>社内チャットで盛り上がった勢いで開始</td></tr><tr><td>8</td><td><a href="/tags/GoTips%E9%80%A3%E8%BC%89/">Go Tips連載</a></td><td>8</td><td>2020/5/18</td><td>社内チャットで盛り上がった勢いで開始。2020/05/18現在連載中。</td></tr><tr><td>9</td><td><a href="https://future-architect.github.io/articles/20200529/">春の入門まつり</a></td><td>21</td><td>2020/6/1</td><td>新人研修空けのフレッシュマンがあふれる時期に開催しようということで社内チャットで広く募集した企画型</td></tr><tr><td>10</td><td><a href="https://future-architect.github.io/tags/Zuora/">Zuora連載</a></td><td>4</td><td>2020/7/6</td><td>サブスクリプションプラットフォームZuoraのナレッジをまとめるレンライ</td></tr><tr><td>11</td><td><a href="https://future-architect.github.io/articles/20200726/">夏休み自由研究</a></td><td>15</td><td>2020/8/1</td><td>自分が好きな技術や興味があるテーマ について 自由に研究（執筆）する</td></tr></tbody></table><p>この記事が公開された後にも、👪組織軸での連載や、🐳<a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF</a>のプロダクト、春の入門・夏の自由研究に続き、🍁秋のブログ週間という”いつもより考え方や技術論”に比重を高めた連載も予定されています。</p><p>まだまだ手探りの面も多いですが、10以上の連載をこなして色々ナレッジが溜まったり、純粋に企画して良かったと感じています。何が良かったのかについて説明していきます。</p><h1 id="ブログの連載企画とは"><a href="#ブログの連載企画とは" class="headerlink" title="ブログの連載企画とは"></a>ブログの連載企画とは</h1><p>ブログの連載企画といっても、おそらく一般的な定義はないと思います。ただ、フューチャー技術ブログでは以下の条件を満たすと社内で連載だよねって呼ばれます。</p><ul><li><strong>あるテーマ</strong>を定める。技術であったり、組織であったり、記事の方向性など</li><li><strong>複数人</strong>で<strong>まとめて</strong>投稿する</li><li>記事数が <strong>最低3本</strong>以上になる</li><li><strong>集中的に投稿する期間</strong>を決める</li></ul><p>今の所、1人でブログ連載を始めたい！っていう猛者は現れていません。今後は出てくることに期待ですね。</p><p>ブログ執筆は割と孤独かと思いますが、この手の連載は興味がある人を広く募集して行なうので、ちょっとしたお祭り感がでてきます。連載一覧を見て分かる通り、テーマはかなり広く設定することが多いです。そのため各人によって記事の内容にバラつきがあり、投稿者同士で応援しあえるのも良いポイントかなと思います。</p><h1 id="ブログ連載の始め方"><a href="#ブログ連載の始め方" class="headerlink" title="ブログ連載の始め方"></a>ブログ連載の始め方</h1><p>テーマはかなり緩いです。「GCPやGo言語やあるライブラリについて知見や思いがある方、一緒に書きませんか？」といったスタート方法が多いです。基本的にはGoogle Formに応募してもらっていますが、この人に書いて欲しいと思ったら運営側からDMを飛ばすこともあります。嘘です。常にDMはかなりの数を飛ばします。DMを送るのを躊躇わないことがとても重要です。</p><p>募集の段階でやっておいたほうが良いのは以下です。</p><ol><li><strong>開催時期を明確に決める</strong>（10月2週目～ではなく、10/12(月)~10/16(金)といった日付単位で決めましょう）<ul><li>みんな本業が忙しいのでバランスが取れるか判断してもらえるようにです</li><li>ブログ連載が連続すると大変なので、なるべく1ヶ月くらいは空けた方が良いと思います（特にターゲットとなる寄稿者が被りそうな場合）</li><li>1.5~2.5ヶ月前くらいが適当かなと思います</li></ul></li><li><strong>応募期限を決める</strong><ul><li>大体2週間くらい。土日が2回あると、ネタを仕込んでくれる人もいます</li></ul></li><li><strong>テーマを決める</strong>（例：GCPについてなら何でもOK！とか緩くても良いかと思います）<ul><li>こういう記事を読みたい！という読み手の気持ちは大事ですが、その前にまず自分がそのテーマで書きたいか、書けるのか？という視点が大事だと思います<ul><li>どんなに良い企画を思いついても、記事が集まらなければ意味がないので、有志運営の企業ブログは書き手視点が本当に大事です</li></ul></li><li>日本語記事も（何なら英語記事も）少ないので、先行者利益を狙っていこうよ！とか少しストレッチ気味のテーマもたまに入れると良いかなと思います</li></ul></li><li><strong>予め書いてくれそうな人が確定してから募集</strong>する<ul><li>これは運営ナレッジなのですが、広く募集しても一向に人が集まらないと心臓に悪いです（1時間おきにGoogle Formの結果を見ちゃいます）。そのため、最初から6,7割の寄稿者を集めておくととても気持ちが楽です。つまり、社内一般募集を開始するときにはほぼ戦いは終わっているのです</li><li>自主的に応募してくれる人はいつも限られる（毎回同じメンバーになりますよね？）ので、いかに在野（といっても社内ですが）の人材を発掘できるかが勝負です。大丈夫です、どの会社でも有能な人材は沢山、本当に沢山眠っています。見つからない場合は過去の寄稿者で最近投稿していない人に声をかけたりもします</li><li>起点はなんだかんだ、Slackなどチャットベースで共通の興味関心があったときに、2人以上が賛同してくれた場合に企画が着火するケースが多かったです</li></ul></li><li><strong>補欠制度</strong>を考える<ul><li>これも運営ナレッジなのですが、突然の業務都合で記事を書けないとか、PCが壊れたと言った理由で、予定通りに入稿されないケースがあります。アドベントカレンダーと違って、毎日投稿にこだわっているわけではないですが、あまり続くと心臓に悪いです。特にインデックス記事で、こういう連載をおこないます！と宣言していると最悪です</li><li>大体、1~3人の補欠を設けると精神的に楽なのでオススメです</li><li>募集の際に毎回連載に名を連ねるのは申し訳ないかも？という奥ゆかしい方がいらっしゃるので、募集のGoogle Formにも人数が多ければ補欠で良いという選択を設けると良いかなと思います</li></ul></li></ol><p>人数が集まらなかった場合も、3人集まれば連載だと思うのでライトに始めます。それすら集まらなくてボツになった企画案もいくつかありますが、2,3個くらいと今のところは成功率の方が高いです。</p><h1 id="12月以外に行なうAdvent-Calendarですか？"><a href="#12月以外に行なうAdvent-Calendarですか？" class="headerlink" title="12月以外に行なうAdvent Calendarですか？"></a>12月以外に行なうAdvent Calendarですか？</h1><p>はい、ほぼほぼそのとおりです。</p><p>違いがあるとすると、枠が25固定ではない・毎日投稿するとは限らない（平日だけですし、週3の場合もある）という点でしょう。</p><p>フューチャーもここ5年くらい（<a href="http://qiita.com/advent-calendar/2019/future" target="_blank" rel="noopener">2019</a>、<a href="http://qiita.com/advent-calendar/2018/future" target="_blank" rel="noopener">2018</a>、 <a href="http://qiita.com/advent-calendar/2017/future" target="_blank" rel="noopener">2017</a>、<a href="http://qiita.com/advent-calendar/2016/future" target="_blank" rel="noopener">2016</a>、<a href="http://qiita.com/advent-calendar/2015/future" target="_blank" rel="noopener">2015</a>）アドベントカレンダーイベントに参加していて感覚に慣れている人が多いので、そのカジュアル版という捉え方をしている人が多いと思います。</p><p>開催時期こそアドベントカレンダーと異なりますが、バトンで連載を繋ぐスタイルは同じなので、さきほど述べたように寄稿者同士で連帯感がでたり、読みてからも注目しやすいといったメリットは同じだと思います。</p><p>なお、春・夏の連載は終わった後にリモート打ち上げをしましたが、あまり人が集まらなかったことを白状します。連帯感どこ行った。</p><h1 id="ブログ連載企画やってみて良かったこと"><a href="#ブログ連載企画やってみて良かったこと" class="headerlink" title="ブログ連載企画やってみて良かったこと"></a>ブログ連載企画やってみて良かったこと</h1><p>書き手側の気持ちでは、みんなで投稿していくのが楽しいよってことですし、運営側としてはご推察の通り、一定の記事数が稼げてウハウハってことですが、他にもいくつかプッシュさせてください。</p><h2 id="①１人だと書ききれない幅と量でかける"><a href="#①１人だと書ききれない幅と量でかける" class="headerlink" title="①１人だと書ききれない幅と量でかける"></a>①１人だと書ききれない幅と量でかける</h2><p>1本だけのTips、入門的な開発環境構築だと、これくらいならブログにするのはちょっと分量が足りないかな…っと躊躇する人も多いと思います。しかし連載企画で集中連載していると、<strong>全体を通して一つの記事</strong>のようなものになるので、むしろそういった幅が広がる記事が歓迎されていました。</p><p>王道的に、「ある技術の背景や導入部分」を書く人もいれば、特定のユーザにしか刺さらないような「マニアックなネタ」を書く人がいて、もちろん「入門的なやってみた」記事もある。お互いをお互い補完しあう関係になれるのは強い気がします。「概要部分」は1本目の記事を読んでください、といった紹介リンクは特によく見られる光景でした。<strong>いろいろな興味・仕事のメンバーを集めたことで、それぞれの興味がオーバーラップして、紹介記事としてのカバレッジをあげることができました。</strong> とはとあるメンバーの発言ですが、まさにその通りの効果が出しやすい作戦だと思います。</p><h2 id="②みんなでやるなら期限を守りやすい"><a href="#②みんなでやるなら期限を守りやすい" class="headerlink" title="②みんなでやるなら期限を守りやすい"></a>②みんなでやるなら期限を守りやすい</h2><p>あるテーマについてやろうと思いながら、日々の忙しさもあり中々手が進まないときも多いと思います。その時、連載企画という<strong>期限</strong>と<strong>他の参加者</strong>があると、<strong>適度な緊張感</strong> で臨むことができます。何かしらアウトプットを出す良いマイルストーンにしやすいです。一部メンバーは週末リモートモクモク会と称して、お互いブログ記事を書いていたりもしていて、目に見えて手を動かす理由付けになるようでした。ついサボりがちな私自身も、自分を追い込む良い理由にできてよかったです。</p><h2 id="③あるテーマについて集中投稿していると外部に宣伝しやすい"><a href="#③あるテーマについて集中投稿していると外部に宣伝しやすい" class="headerlink" title="③あるテーマについて集中投稿していると外部に宣伝しやすい"></a>③あるテーマについて集中投稿していると外部に宣伝しやすい</h2><p>勉強会や採用面接などで、自社が最近注目している技術について話す機会って意外とあると思います。そういったときに、ある技術テーマで集中連載しているという話は意外と食いつきがよく、自社の考え方や興味を表すのに便利だなと感じました。また、この辺の記事とURLをいくつかシェアするより、連載企画のついたタグのURLをシェアできるのでお手軽です。</p><p>また、これは最後のGoTips連載の例ですが、コミュニティのアカウントに紹介していただけました。ありがとうございます。</p><p><a href="https://twitter.com/golangjp/status/1264117466520682497?s=19" target="_blank" rel="noopener">https://twitter.com/golangjp/status/1264117466520682497?s=19</a></p><p>注目度が集まりやすいということに関連して、ニッチなテーマであっても1人ではなくチームで連載をすると、組織として注目しているだという印象を与えやすいと思います。（実際に複数人が記事を書けるという事実はあるので嘘ではないのですが）。個人・企業が運営する技術ブログの数は非常に多いので、その中でも目立たせるため連載記事を通して特徴付けするのが悪くない作戦かなと思います。</p><h2 id="④参画障壁が下がる"><a href="#④参画障壁が下がる" class="headerlink" title="④参画障壁が下がる"></a>④参画障壁が下がる</h2><p>連載企画ですが必ずしもその技術に習熟した人だけが参加するのではなく、<strong>一度もちゃんと触ったことがない人</strong>でも参加することがありました。そういった方には連載企画の執筆陣同志でレビューして教え合ったりすることもあり、良いきっかけづくりになったと思います。また、例えばまだ社内的に実績が無かった技術に関しては、全員が初心者🔰 といった状態もありました。その時は全員がドキュメントを読み、内部のコードを読み、使い方を考えながらキャッチアップしたり、アウトプットをお互いに発表したりで、<strong>個人ではなくチームで学習するサイクル</strong>を持てたと思います。</p><p>また、連載企画を開始するときにメンバーを募集しますが、そのときに今までブログを書いたことがないメンバーも多く手を上げてくれました。1人で何のネタでブログを書くか考えて手を動かすのは敷居が高いけど、<strong>決められたテーマでネタをつくる方が取り組みやすい人もいる</strong>ようです。連載企画の技術テーマ軸でコミュニティを作れるというのも良い側面だと思います。</p><h1 id="ブログ連載企画やってみて失敗したこと"><a href="#ブログ連載企画やってみて失敗したこと" class="headerlink" title="ブログ連載企画やってみて失敗したこと"></a>ブログ連載企画やってみて失敗したこと</h1><p>失敗したなと思ったのは、春の入門祭りは人数が21名と非常に多かったこと、それにより期間もほぼ1ヶ月と長かったことです。（社内でも飽きていた人がいるかも？）。応募者が多数だったとしても、人数は最大15名（平日のみで3週間）がMaxだと思います。それ以上は読み手も運営も大変なので分割した方が良いとは思いました。</p><p>明確な失敗ではないですが改善だなと思うこともあげます。</p><p>春の入門祭り、夏休み自由研究、秋のブログ週間のような特定の技術テーマでない連載は最初は面白がってくれるものの、記載する技術要素は自由です。フリーテーマだと回数をこなすほど集客に難がある気がする（もう少し特化したほうがDMで募集もしやすい）ので、季節モノの連載テーマはもう少し改善が必要だと思っています。具体的に言うと、夏休み自由研究は比較的イメージが湧きやすい（小学校教育の勝利を感じます）ですが、「秋のブログ週間」はこのテーマだと何を書けば良いかわからないので苦戦しました。</p><p>また、春の入門祭りは誰にとっての入門かという点を明示しなかったため、本当の初心者（Futureに新卒入社する若手の平均レベル）からすると技術ハードルが高い記事が混在していた問題もありました。このカオス感はこれはこれで良いという意見もありますし、明示すると書き手の募集にマイナスなのとハードルが上がるので簡単ではないですが、もう少し良いテーマ設定があるとは感じています。</p><h1 id="今後やりたいこと"><a href="#今後やりたいこと" class="headerlink" title="今後やりたいこと"></a>今後やりたいこと</h1><p>来年も継続しようと思っているのは、以下の季節モノは定常化させようと思っています。冬はアドベントカレンダーがあるので開催しません。</p><ul><li>春の入門祭り</li><li>夏休み自由研究</li><li>秋のブログ週間</li></ul><p>個人的にはFlutter連載など、今社内で多少事例はあるけどそこまで広く使われていない技術の連載も増やしたいと思っています。</p><p>また、純粋な技術以外にも、</p><ul><li>アーキテクチャ設計やらかし失敗連載</li><li>システム運用Tips連載</li><li>データ移行連載</li></ul><p>など、設計/運用/移行といった、システム視点の連載も増やしていきたいなと思っています。</p><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>連載企画について社内でよく聞かれる（聞かれた）ことです。</p><ul><li>(Q1)すでに終わった連載企画に記事を追加することは良いの？<ul><li>はい。希望があればご自由にです。Serverless連載は実はちょくちょく追加されています。 </li></ul></li><li>(Q2)同じ連載企画をもう一度始めたいんだけど..<ul><li>連続で3名以上が投稿するなら、第2弾目の連載企画として初めて、初回は第1弾としちゃおうかなと運営内で話しています。Serverless連載2021とか年号をつけるとカッコいいかもとかありますよね</li></ul></li><li>(Q3)自分たちの部署やプロジェクトでも始めたいんだけど、どういうフローで承認されるの？<ul><li>連載したい時期を運営（真野か伊藤太斉）までSlackかGoogle Chatで連絡いただけたらノー審査で承認します！</li></ul></li></ul><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>フューチャー技術ブログでは比較的、新しい取り組みである「連載企画」について話しました。他の企業技術ブログでも実質的に同じような取り組みをすでに行っているよーというところも多いかと思いますが、その事自体の記事をあまり見たことが無かったので今回まとめました。</p><p>名前はさておき、連載企画という考え方や動きが広まることを祈っています。</p><p>本ブログの更新はTwitterでもお知らせしますので、良ければフォローください！励みになります。</p><ul><li><a href="https://twitter.com/future_techblog" target="_blank" rel="noopener">https://twitter.com/future_techblog</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/20200908/goose-908291_1280.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/Skitterphoto-324082/?utm_source=li
      
    
    </summary>
    
    
      <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
      <category term="TechBlog" scheme="https://future-architect.github.io/tags/TechBlog/"/>
    
      <category term="運営" scheme="https://future-architect.github.io/tags/%E9%81%8B%E5%96%B6/"/>
    
  </entry>
  
  <entry>
    <title>親子でプログラミング学習　Alexaスキルを作ろう</title>
    <link href="https://future-architect.github.io/articles/20200907/"/>
    <id>https://future-architect.github.io/articles/20200907/</id>
    <published>2020-09-06T15:00:00.000Z</published>
    <updated>2020-09-07T01:26:29.032Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200907/toys-3644073_1280.png"><p><a href="https://pixabay.com/ja/users/pencilparker-7519217/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3644073" target="_blank" rel="noopener">pencil parker</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3644073" target="_blank" rel="noopener">Pixabay</a>からの画像</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIG DXチームの村瀬です。</p><p>今年から小学校でプログラミング教育が必修化になったとのことですが、プログラミングと聞くとまだまだ「難しい」、「私には無理」と言った苦手意識を持つ子供や親も多いのではないでしょうか？そこで今回は幼児～小学校低学年の子供とその親を対象として一家に一台はあるであろうスマートスピーカーのAlexaを使ったプログラミングをすることで、プログラミングが楽しいと思ってもらえるようにブログを書かせてもらいました。<br>※あくまで楽しいと思ってもらえるところまでがゴールなので分岐や繰り返しの話はしません。</p><h1 id="なぜAlexa"><a href="#なぜAlexa" class="headerlink" title="なぜAlexa"></a>なぜAlexa</h1><p>一家に一台ありますよね？というのは半分冗談で、プログラミング学習のためのツールは多々ありますがやれることが多く、全てを消化できずに終わったり、またプログラミングとは外れたこと(例えばキャラクターの絵を描くこと)に集中してしまい結局プログラミング教育にならなかったということが起きえます。であれば、できることが限られるツールを利用して満足度を高めるほうがファーストステップとしては良いのではないかと考えた次第です。</p><p>また幼児の場合、文字の読み書きはできないけど会話はできるし、既にAlexaが家庭にあり、子供に親しまれているものを使うことで興味を持ちやすいってのもありますね。</p><h1 id="Alexaスキル"><a href="#Alexaスキル" class="headerlink" title="Alexaスキル"></a>Alexaスキル</h1><p>AmazonのスマートスピーカーであるAlexa。音声を利用して天気やさまざまな情報を教えてくれたりする機能のことをAlexaスキルと呼びます。既に数多くの便利なスキルが提供されていますが、実は誰でもスキルを作成することができるんです。</p><p>不安を取り除くため、先にいくつかQ &amp; Aの形で情報をお知らせします。</p><p>Q1. Alexaスキルを作るのにお金かかるの？<br>A1. Alexaとパソコン、インターネット環境さえあれば個人で少し遊ぶ程度ではお金はかかりません。</p><p>Q2. 作ったAlexaスキルが公開されるのは嫌なんですけど。<br>A2. 全世界に公開されず、自分のAlexa(アカウント)でのみ動作させることが可能です。</p><h1 id="開発環境の準備"><a href="#開発環境の準備" class="headerlink" title="開発環境の準備"></a>開発環境の準備</h1><p><a href="https://developer.amazon.com/ja/blogs/alexa/post/31c9fd71-f34f-49fc-901f-d74f4f20e28d/alexatraining-firstskill" target="_blank" rel="noopener">Alexaスキル開発トレーニングシリーズ第1回: 初めてのスキル開発</a> のページの「準備. Amazon 開発者アカウントの作成」に則って進めると簡単にできます。それなりに時間を要するので子供と一緒に作業する前にあらかじめ用意しておくことを推奨します。子供の集中力は長くは持たず、プログラミングする前から飽きられてしまいかねません。<br>※入力項目の一つである「開発者名」は公開した際にAlexaストア上に表示される名前になり、後から変更できませんが、公開せず個人で開発する分にはあまり気にしなくて大丈夫です。</p><h1 id="最低限抑えておきたいポイント"><a href="#最低限抑えておきたいポイント" class="headerlink" title="最低限抑えておきたいポイント"></a>最低限抑えておきたいポイント</h1><p>Alexaスキルを作る上で最低限抑えておきたいポイントが4つあります。<br>1.呼び出し名<br>2.インテント<br>3.発話<br>4.バックエンド処理<br>順に説明します。</p><h2 id="1-呼び出し名"><a href="#1-呼び出し名" class="headerlink" title="1.呼び出し名"></a>1.呼び出し名</h2><p>Alexaスキルを起動させる為のキーワードです。Alexa、〇〇を開いての〇〇の部分。</p><h2 id="2-インテント"><a href="#2-インテント" class="headerlink" title="2.インテント"></a>2.インテント</h2><p>インテントというのはユーザがAlexaに話しかけた際に何として受け取るかの定義です。音楽プレーヤーに例えて説明すると再生、停止、早送り、巻き戻しと言った機能名にあたる部分です。</p><h2 id="3-発話"><a href="#3-発話" class="headerlink" title="3.発話"></a>3.発話</h2><p>インテントに対する設定として何と言ったら再生するかを定義する必要があります。<br>「音楽を再生して」、「曲をかけて」、「開始」、「スタート」と言ったところでしょうか。これらを発話と言います。</p><h2 id="4-バックエンド処理"><a href="#4-バックエンド処理" class="headerlink" title="4.バックエンド処理"></a>4.バックエンド処理</h2><p>呼び出されたインテントに対して何をするかの部分です(※発話に対して処理をするわけ<strong><em>ではない</em></strong>のがポイントです)。</p><p>再生インテントの際には音楽を再生したりする処理ですね。※正式な名称はバックエンド処理ではありませんが、この記事の中ではわかりやすさを優先してこのように呼ぶことにします。</p><p>発話、インテント、バックエンド処理の関係を整理すると下図のようになります。</p><p><img src="/images/20200907/%E9%96%A2%E4%BF%82.png" alt=""></p><h1 id="子供と一緒に楽しく作る"><a href="#子供と一緒に楽しく作る" class="headerlink" title="子供と一緒に楽しく作る"></a>子供と一緒に楽しく作る</h1><p>実際にうちの子供(4歳)とやってみた方法を紹介します。</p><p>ふみくん(子供の名前)のスキルを作ろうか？ハローって言ったらふみくんのことお話してもらおうか？と子供に質問しながらどんなスキルを作るか決めていきました。</p><p>呼び出し名と発話、バックエンド処理が決まったら早速作ってみましょう。</p><p>私と子供で作ったスキルの説明を参考として記載します。</p><dl>  <dt>呼び出し名</dt>  <dd>ふみくん</dd>  <dt>動作(発話とバックエンド処理)</dt>  <dd>「ハロー」と言うと「ふみくんは4歳だよ。好きな食べ物はメロンだよ」と返し、「ばいばい」と言うと「ばいばい。また遊んでね。」と返し終了する</dd></dl> <h2 id="Alexaスキルの作成"><a href="#Alexaスキルの作成" class="headerlink" title="Alexaスキルの作成"></a>Alexaスキルの作成</h2><p><a href="https://developer.amazon.com/alexa/console/ask" target="_blank" rel="noopener">Alexa Developer Console</a>にアクセスし「スキルの作成」ボタンをクリックします。<br>スキル名に作成するスキル名を入力し「スキルを作成」ボタンをクリックします。特段のこだわりがなければスキル名に呼び出し名を入力してください。スキル名に入力した値が呼び出し名のデフォルト値になります。<br>次の画面ではHello Worldスキルが選択された状態で「テンプレートで続ける」ボタンをクリックします。</p><p><img src="/images/20200907/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%A7%E7%B6%9A%E3%81%91%E3%82%8B.png" alt=""></p><p>約1分ほど待つとスキルが作成されます。ここで作成されるスキルはHello Worldのテンプレートから作成されたスキルなので、この状態から編集することで、目的のスキルを作成します。</p><h2 id="インテント、発話の編集"><a href="#インテント、発話の編集" class="headerlink" title="インテント、発話の編集"></a>インテント、発話の編集</h2><p>左のメニューから「対話モデル」をクリックし、表示されるメニューから「インテント」をクリックします。<br><img src="/images/20200907/%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC.png" alt=""></p><p>「HelloWorldIntent」をクリックし、発話を編集します。今回私が作成するスキルはハローと言ったら応答をするものなのでインテント、サンプル発話は編集せず、そのまま利用することにします。必要に応じてインテントの追加とサンプル発話の追加をしてください。</p><p><img src="/images/20200907/%E3%82%A4%E3%83%B3%E3%83%86%E3%83%B3%E3%83%88.png" alt=""></p><p>続いて、「AMAZON.StopIntent」をクリックしてサンプル発話に「ばいばい」を追加します。これで「ばいばい」と言うと、これから編集する「AMAZON.StopIntent」の処理が実行されるようになります。</p><p><img src="/images/20200907/stop.png" alt=""></p><p>編集が終わったら「モデルを保存」、「モデルをビルド」をクリックしてください。</p><h2 id="バックエンド処理の編集"><a href="#バックエンド処理の編集" class="headerlink" title="バックエンド処理の編集"></a>バックエンド処理の編集</h2><p>「コードエディタ」をクリックするとバックエンド処理のプログラムが表示されます。ようやくプログラミングっぽい画面が表示されましたね。このプログラムもHello Worldのテンプレートから作成されたものなので必要な個所を修正していきます。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HelloWorldIntentHandler = &#123;</span><br><span class="line">    canHandle(handlerInput) &#123;</span><br><span class="line">        <span class="keyword">return</span> Alexa.getRequestType(handlerInput.requestEnvelope) === <span class="string">'IntentRequest'</span></span><br><span class="line">            &amp;&amp; Alexa.getIntentName(handlerInput.requestEnvelope) === <span class="string">'HelloWorldIntent'</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    handle(handlerInput) &#123;</span><br><span class="line">        <span class="keyword">const</span> speakOutput = <span class="string">'Hello World!'</span>;</span><br><span class="line">        <span class="keyword">return</span> handlerInput.responseBuilder</span><br><span class="line">            .speak(speakOutput)</span><br><span class="line">            <span class="comment">//.reprompt('add a reprompt if you want to keep the session open for the user to respond')</span></span><br><span class="line">            .getResponse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>HelloWorldIntentHandlerの</p><p><code>&#39;Hello World!&#39;</code>の部分を<code>&#39;ふみくんは4歳だよ。好きな食べ物はメロンだよ&#39;</code>に変更し、<code>//.reprompt(&#39;add a reprompt if you want to keep the session open for the user to respond&#39;)</code>の部分を<code>.reprompt(speakOutput)</code>に変更します。repromptの方は最初はコメントアウト、つまり何も処理しない状態からrepromptを有効にします。有効にしない場合、「ハロー」と言うと「ふみくんは4歳だよ。好きな食べ物はメロンだよ」と返すとスキルが終了してしまいますが、スキルを終了しないようにします。()の中の値はユーザーからの返事がなかった時にAlexaがしゃべる文章になります。ユーザーからの返事がなかった時には「ふみくんは4歳だよ。好きな食べ物はメロンだよ」ともう一度しゃべります。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CancelAndStopIntentHandler = &#123;</span><br><span class="line">    canHandle(handlerInput) &#123;</span><br><span class="line">        <span class="keyword">return</span> Alexa.getRequestType(handlerInput.requestEnvelope) === <span class="string">'IntentRequest'</span></span><br><span class="line">            &amp;&amp; (Alexa.getIntentName(handlerInput.requestEnvelope) === <span class="string">'AMAZON.CancelIntent'</span></span><br><span class="line">                || Alexa.getIntentName(handlerInput.requestEnvelope) === <span class="string">'AMAZON.StopIntent'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    handle(handlerInput) &#123;</span><br><span class="line">        <span class="keyword">const</span> speakOutput = <span class="string">'Goodbye!'</span>;</span><br><span class="line">        <span class="keyword">return</span> handlerInput.responseBuilder</span><br><span class="line">            .speak(speakOutput)</span><br><span class="line">            .getResponse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>続いてCancelAndStopIntentHandlerも同様に<code>&#39;Goodbye!&#39;</code>の部分を<code>&#39;ばいばい。また遊んでね。&#39;</code>に変更します。</p><p>こちらはスキルを終了するので<code>.reprompt(speakOutput)</code>は最初から存在しません。編集が終わったら「保存」、「デプロイ」をクリックしてください。</p><p>「テスト」をクリックして「非公開」になっているステータスを「開発中」に変更すると作成したスキルがお手持ちのAlexaで利用できるようになります。</p><h1 id="Alexaで確認する"><a href="#Alexaで確認する" class="headerlink" title="Alexaで確認する"></a>Alexaで確認する</h1><p>Alexaに「アレクサ、ふみくんを開いて」と言うと、先ほど作成したばかりのスキルが利用できます。起動時のバックエンド処理を変更していなかったのでHelloWorldテンプレートで作成された返答がされてしまいましたが、これは後で直すことにしましょう。ハローやばいばいと言ってみてください。自分で作成した返答がされるはずです。</p><h2 id="飽きさせないように"><a href="#飽きさせないように" class="headerlink" title="飽きさせないように"></a>飽きさせないように</h2><p>PCでの動作確認も可能ですが、実際にAlexaがしゃべってるように感じてもらえるよう都度都度Alexaで確認しました。こうすることで興味を持ってもらえ集中力が切れずにAlexaスキルを完成することができました。毎回同じ言葉を返すと飽きてくるので途中で文章を変更するなどしても良いかもしれません。</p><h1 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h1><p>最近うちの子は逆さ言葉にハマっているのですが、そのスキルを作成しようともしたのですが、Alexaスキルだけでは上手く行きませんでした。</p><p>何が上手く行かなかったかと言うとユーザが発話した言葉は日本語であれば漢字が含まれた文字列としてバックエンドに連携されるので文字列を単純に反対に入れ替えたとしても意図した動作にできませんでした。漢字が含まれた文章をひらがな(またはカタカナ)に変換する外部APIを利用すればできなくはないのですが、そもそもAlexaスキルの思想としてユーザが発話した言葉を直接取り扱うことは推奨してないようです。思わぬ落とし穴にハマらないようにしましょう。</p><p>また作った本人達からすると何と問いかければ良いかはわかるのですが、他の人に使ってもらうにはその辺の説明が必要です。起動時の説明やヘルプで使い方を説明させると親切ですね。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>分岐も繰り返しも使いませんでしたが子供と楽しく一緒にプログラミングできました。家族に披露したところ、Alexaスキルを作ろうと誘っても見向きもしなかった長男(7歳)も次は僕もやってみたいと興味深々でした。読み書きができる子であれば簡単な設計書(呼び出し名と何と言ったら何と応答するか)を書いてもらうのも良いかもしれませんね。</p><p>IT技術者不足が叫ばれる昨今、一人でも多くの人がプログラムに興味を持ちIT業界で働いてくれることを願っております。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200907/toys-3644073_1280.png&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/pencilparker-7519217/?utm_source=link-attributi
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="Alexa" scheme="https://future-architect.github.io/tags/Alexa/"/>
    
      <category term="プログラミング教育" scheme="https://future-architect.github.io/tags/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E6%95%99%E8%82%B2/"/>
    
  </entry>
  
  <entry>
    <title>ANTLRを業務で活用した話</title>
    <link href="https://future-architect.github.io/articles/20200903/"/>
    <id>https://future-architect.github.io/articles/20200903/</id>
    <published>2020-09-02T15:00:00.000Z</published>
    <updated>2020-09-03T02:28:27.763Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、TIG コアテクノロジーユニットの平岡です。</p><p>コアテクノロジーユニットはフューチャーグループ全体のビジネスを支えるコアとなる技術をグループ横断で提供することをミッションにしています。またOSS活動も活発に行っています。コアテクノロジーユニットのメンバーが以前に投稿した記事をいくつか紹介しておきますので、是非そちらもご覧ください。</p><ul><li><a href="https://future-architect.github.io/articles/20190620/">RedmineからGoogle Hangouts Chat へ連携するプラグインを作成しました！</a></li><li><a href="https://future-architect.github.io/articles/20181031/">その問い合わせ、AIが解決します！～Redmineチケットレコメンドシステムのご紹介～</a></li><li><a href="https://future-architect.github.io/articles/20170228/">SQL開発者を幸せにする！？ Sublime Text 3でも使える uroboroSQL Formatter を公開しました</a></li></ul><h1 id="ANTLRとは"><a href="#ANTLRとは" class="headerlink" title="ANTLRとは"></a>ANTLRとは</h1><p>皆さんは<a href="https://www.antlr.org/" target="_blank" rel="noopener">ANTLR</a>をご存知でしょうか？ANTLRとはparser(構文解析器)を生成するためのツール(パーサジェネレータ)で、以下のような特徴があります。</p><ul><li>grammar(解析したいテキストの構造に関するルールを定義したもの)を元に、parserを自動生成できる</li><li>解析対象をparserに渡した後に構成されるAST(抽象構文木)をトラバースすることで、目的に合った解析を行うことができる</li><li>様々なプログラミング言語のgrammarが<a href="https://github.com/antlr/grammars-v4" target="_blank" rel="noopener">公式</a>で整備されている<ul><li>もちろん、自分でgrammarを作ることもできる</li></ul></li><li>ターゲット言語(生成されるparserの実装に使用可能な言語)はJava, JavaScript, Pythonなど主要なものをサポートしている(<a href="https://github.com/antlr/antlr4/blob/master/doc/targets.md" target="_blank" rel="noopener">詳細</a>)<ul><li>Javaで開発をしない人向けに：ただし、ANTLRはJavaで実装されているため、Java以外の言語で実装されたparser生成にもJavaが必要となる(<a href="https://github.com/antlr/antlr4/blob/master/doc/getting-started.md" target="_blank" rel="noopener">Javaコマンドでparser生成したい場合の手順</a>)</li></ul></li></ul><p>このように非常に汎用性の高いツールであり、応用先は多岐にわたるようです。公式サイトによると、Twitterの検索機能にも使われているという記述がありました。</p><p>パーサジェネレータや構文解析に関連した他のトピックもいくつか紹介しておきましょう。</p><ul><li>ANTLR以外のパーサジェネレータの例としては、<a href="https://github.com/javacc/javacc" target="_blank" rel="noopener">JavaCC</a>(Java), <a href="https://github.com/pegjs/pegjs" target="_blank" rel="noopener">PEG.js</a>(JavaScript), <a href="https://www.gnu.org/software/bison/" target="_blank" rel="noopener">Bison</a>(C)などが有名ですが、いずれもターゲット言語=実装言語です。一方で、ANTLRはターゲット言語の種類が多いという特徴を持ちます。</li><li>同じコアテクノロジーユニットのメンバーである<a href="https://github.com/ota-meshi" target="_blank" rel="noopener">太田さん</a>(Vue.jsのコミッターです！)がメンテしている<a href="https://github.com/vuejs/eslint-plugin-vue" target="_blank" rel="noopener">eslint-plugin-vue</a>では、ANTLRは使っていませんがASTに基づいた構文解析を行っています。</li></ul><p>この記事では、まずシンプルな例を通してANTLRの概要を説明します。その後、ANTLRを使って業務で生じた課題を解決した時の話について述べたいと思います。</p><h1 id="ANTLRの概要"><a href="#ANTLRの概要" class="headerlink" title="ANTLRの概要"></a>ANTLRの概要</h1><h2 id="lexerとparser"><a href="#lexerとparser" class="headerlink" title="lexerとparser"></a>lexerとparser</h2><p>ANTLRはgrammarを元にparserを自動生成できることを上で述べましたが、より正確には、解析対象のテキストをparserに渡すために必要なlexer(字句解析器)も生成します。ここでは、<code>123 + 456</code>のような2個の整数を足す式を構文解析する例を通してlexer, parserの役割について説明します。</p><p>まず、解析対象がlexerを経由してparserに渡るイメージを見てみましょう。</p><p><img src="/images/20200903/antlr_flow.png" alt=""></p><p>lexerの役割は、解析対象を読んでトークン(1つの意味を持つ最小単位)の列に分解することです。この例では、2個の整数を足す式<code>123 + 456</code>を3つのトークン<code>123</code>,<code>+</code>,<code>456</code>に分解しています。なお、<code>123 + 456</code>には空白が含まれていますが、grammarを上手く設定すると読み飛ばすことができます(後述)。</p><p>parserの役割は、トークンの列を読んでAST(抽象構文木)を構成することです。listenerやvisitor(後述)を実装してASTをトラバースすることで、目的に合った解析処理を行うことができます。</p><p>lexer, parserを生成するためにgrammarには何を記述すれば良いのでしょうか？<br>基本的には、<code>ルール名:ルール定義;</code>の形式でルールを列挙します。実際に例を見てみましょう。</p><figure class="highlight java"><figcaption><span>SampleLexer.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * lexer用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">lexer grammar SampleLexer;</span><br><span class="line"></span><br><span class="line">NUM</span><br><span class="line">: [<span class="number">0</span>-<span class="number">9</span>]+</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">PLUS</span><br><span class="line">: <span class="string">'+'</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 空白は読み飛ばす</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SPACE</span><br><span class="line">: <span class="string">' '</span> -&gt; skip</span><br><span class="line">;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>SampleParser.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * parser用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser grammar SampleParser;</span><br><span class="line"></span><br><span class="line">options &#123; tokenVocab=SampleLexer; &#125;</span><br><span class="line"></span><br><span class="line">sum</span><br><span class="line">: NUM PLUS NUM</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>VSCodeをお使いの場合は、<a href="https://marketplace.visualstudio.com/items?itemName=mike-lischke.vscode-antlr4" target="_blank" rel="noopener">ANTLR4 grammar syntax support</a>という拡張を導入するとシンタックスハイライトが使えて見やすくなります。また、この拡張はgrammarの構造を可視化する機能も備えており(<a href="https://github.com/mike-lischke/vscode-antlr4/blob/master/doc/grammar-debugging.md#live-graphical-parse-tree" target="_blank" rel="noopener">詳しくはこちら</a>)、非常に便利です。</p><p><img src="/images/20200903/image.png" alt=""></p><p>grammarの説明に戻りましょう。</p><p>lexer用とparser用のgrammarを分割して記載していますが、同一ファイルで記述することもできます。保守性を考慮する場合は、分割するのが良いでしょう。</p><p>lexerとparserのルールを区別するために、lexerの場合はルール名は大文字始まり、parserの場合はルール名は小文字始まりで記述する必要があります。</p><p>lexerのルール定義について見てみましょう。例えば、整数を表すトークンNUMの定義は、<code>[0-9]+</code>ですが、これは数字1個以上からなる文字列を最長一致でマッチさせてNUMというトークンに割り当てることを意味します。</p><p>parserのルール定義について見てみましょう。sumというルールは、<code>NUM</code>,<code>PLUS</code>,<code>NUM</code>という3つのトークンから構成される列(つまり、足し算の式)であるという定義です。sumのようなルール名はASTの節点に対応し、<code>NUM</code>, <code>PLUS</code>, <code>NUM</code>のようなルール定義を構成する要素はルール名に対応する節点の子に対応しています。</p><p>lexer用grammarのSPACEでは、skipコマンドを使うことで空白を読み飛ばしています。skipコマンドを使わないで空白をケアする場合は、parser用grammarのsumの定義が下記のように複雑になってしまいます。このように、lexerの定義次第でparserの定義が複雑になり得るので注意が必要です。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sum</span><br><span class="line">: SPACE* NUM SPACE* PLUS SPACE* NUM</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>grammarの詳細については、<a href="https://github.com/antlr/antlr4/blob/4.6/doc/index.md" target="_blank" rel="noopener">公式ドキュメント</a>を参照して下さい。</p><p>では、上に載せたgrammarを元に、mavenでparserを生成してみましょう。<br><a href="https://www.antlr.org/api/maven-plugin/latest/index.html" target="_blank" rel="noopener">ANTLR v4 Maven plugin</a>のデフォルトの動作の特徴は次の通りです。</p><ul><li><code>src/main/antlr4</code>以下に配置されたgrammarファイル(.g4ファイル)を参照してparser等を生成する</li><li>生成されるparser等のパッケージ構造は、<code>src/main/antlr4</code>から見た相対パスを元に自動で設定される</li></ul><p><code>jp.co.future.antlr.parser</code>パッケージにparser等を格納したい場合は下記のようにgrammarを配置すれば良いです(参照するgrammarや設定したいパッケージ名をpom.xml内で明示的に指定することもできます)。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├─main</span><br><span class="line">│  ├─antlr4</span><br><span class="line">│  │  └─jp</span><br><span class="line">│  │      └─co</span><br><span class="line">│  │          └─future</span><br><span class="line">│  │              └─antlr</span><br><span class="line">│  │                  └─parser</span><br><span class="line">│  │                          SampleLexer.g4</span><br><span class="line">│  │                          SampleParser.g4</span><br><span class="line">│  │</span><br><span class="line">(省略)</span><br></pre></td></tr></table></figure><p>また、pom.xmlに以下のように追記します。</p><figure class="highlight xml"><figcaption><span>pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- (省略) --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.antlr<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>antlr4-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;antlr.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- grammarの配置場所がsrc/main/antlr4/xxx/Grammar.g4の場合、src/main/java/xxx配下にparser等のファイルが生成される) --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- listenerを生成したい場合 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">listener</span>&gt;</span>true<span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- visitorを生成したい場合 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">visitor</span>&gt;</span>true<span class="tag">&lt;/<span class="name">visitor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>antlr-generate<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- mvn antlr4:antlr4 を実行するとparser等が生成される --&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>antlr4<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.antlr<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>antlr4-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;antlr.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用したいANTLRのバージョンを指定 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">antlr.version</span>&gt;</span>4.8-1<span class="tag">&lt;/<span class="name">antlr.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>mvn antlr4:antlr4</code>を実行すると、下記のようにparser等が生成されました。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├─main</span><br><span class="line">│  ├─antlr4</span><br><span class="line">│  │  └─jp</span><br><span class="line">│  │      └─co</span><br><span class="line">│  │          └─future</span><br><span class="line">│  │              └─antlr</span><br><span class="line">│  │                  └─parser</span><br><span class="line">│  │                          SampleLexer.g4</span><br><span class="line">│  │                          SampleParser.g4</span><br><span class="line">│  │</span><br><span class="line">│  └─java</span><br><span class="line">│      │  SampleLexer.tokens</span><br><span class="line">│      │  SampleParser.tokens</span><br><span class="line">│      │</span><br><span class="line">│      └─jp</span><br><span class="line">│          └─co</span><br><span class="line">│              └─future</span><br><span class="line">│                  └─antlr</span><br><span class="line">│                      │  App.java</span><br><span class="line">│                      │</span><br><span class="line">│                      └─parser</span><br><span class="line">│                              SampleLexer.interp</span><br><span class="line">│                              SampleLexer.java</span><br><span class="line">│                              SampleParser.interp</span><br><span class="line">│                              SampleParser.java</span><br><span class="line">│                              SampleParserBaseListener.java</span><br><span class="line">│                              SampleParserBaseVisitor.java</span><br><span class="line">│                              SampleParserListener.java</span><br><span class="line">│                              SampleParserVisitor.java</span><br><span class="line">(省略)</span><br></pre></td></tr></table></figure><h2 id="listenerとvisitor"><a href="#listenerとvisitor" class="headerlink" title="listenerとvisitor"></a>listenerとvisitor</h2><p>grammarを元にparserを生成できました。<br>ここからは、parserから得られるASTをトラバース(ASTのノードを深さ優先探索で順番に訪問)し、目的に合った解析を行う方法について見ていきましょう。</p><p>今回は、+の右側の整数を取得したいという目的があるとしましょう(例えば、<code>123 + 456</code>が入力の場合は<code>456</code>を出力)。<br>ASTをトラバースするためには、listenerもしくはvisitorを実装する必要があります。<br>まずは、listenerの実装例を見てみましょう。</p><figure class="highlight java"><figcaption><span>ExtractRhsNumListener.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr.parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtractRhsNumListener</span> <span class="keyword">extends</span> <span class="title">SampleParserBaseListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Integer rhsNum;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exitSum</span><span class="params">(SampleParser.SumContext ctx)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 2つ目のNUM、つまり+の右側の整数をセットする</span></span><br><span class="line">setRhsNum(<span class="keyword">new</span> Integer(ctx.NUM(<span class="number">1</span>).getText()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">getRhsNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> rhsNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRhsNum</span><span class="params">(Integer rhsNum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.rhsNum = rhsNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>App.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.ExtractRhsNumListener;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleLexer;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTreeWalker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">extractRhsNumByListener();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * listenerで"123 + 456"の+の右側の整数を抽出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">extractRhsNumByListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 文字列からCharStreamを生成</span></span><br><span class="line">CharStream cs = CharStreams.fromString(<span class="string">"123 + 456"</span>);</span><br><span class="line"><span class="comment">// CharStreamをlexerに渡す</span></span><br><span class="line">SampleLexer lexer = <span class="keyword">new</span> SampleLexer(cs);</span><br><span class="line"><span class="comment">// lexerでトークン列に分解</span></span><br><span class="line">CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);</span><br><span class="line"><span class="comment">// トークン列をparserに渡し、ASTを作る</span></span><br><span class="line">SampleParser parser = <span class="keyword">new</span> SampleParser(tokens);</span><br><span class="line"><span class="comment">// listenerでASTをトラバース</span></span><br><span class="line">ParseTreeWalker walker = ParseTreeWalker.DEFAULT;</span><br><span class="line">ExtractRhsNumListener listener = <span class="keyword">new</span> ExtractRhsNumListener();</span><br><span class="line">walker.walk(listener, parser.sum());</span><br><span class="line">System.out.println(listener.getRhsNum());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">456</span><br></pre></td></tr></table></figure><p>listenerの特徴は以下の通りです。</p><ul><li>ASTの全ノードを訪問する</li><li>ノードに入るタイミング(<code>enterXXX</code>メソッド)・ノードを抜けるタイミング(<code>exitXXX</code>メソッド)に行う処理を目的に合わせてOverrideする</li><li>Overrideするメソッドは返り値を持たないため、欲しい値はフィールドで保持する必要がある</li></ul><p>上の実装例の<code>ExtractRhsNumListener#enterSum</code>は、ASTでsumノードを最初に訪問した時に2番目のNUM(つまり、+の右側の整数)をセットする処理を行っています。<br><code>enterSum</code>ではなく<code>exitSum</code>でOverrideしても同様の実行結果が得られます。</p><p>続いて、visitorの実装例を見てみましょう。</p><figure class="highlight java"><figcaption><span>ExtractRhsNumVisitor.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr.parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtractRhsNumVisitor</span> <span class="keyword">extends</span> <span class="title">SampleParserBaseVisitor</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">visitSum</span><span class="params">(SampleParser.SumContext ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Integer(ctx.NUM(<span class="number">1</span>).getText());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>App.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.ExtractRhsNumVisitor;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleLexer;</span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SampleParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTree;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">extractRhsNumByVisitor();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * visitorで"123 + 456"の+の右側の整数を抽出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">extractRhsNumByVisitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 文字列からCharStreamを生成</span></span><br><span class="line">CharStream cs = CharStreams.fromString(<span class="string">"123 + 456"</span>);</span><br><span class="line"><span class="comment">// CharStreamをlexerに渡す</span></span><br><span class="line">SampleLexer lexer = <span class="keyword">new</span> SampleLexer(cs);</span><br><span class="line"><span class="comment">// lexerでトークン列に分解</span></span><br><span class="line">CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);</span><br><span class="line"><span class="comment">// トークン列をparserに渡し、ASTを作る</span></span><br><span class="line">SampleParser parser = <span class="keyword">new</span> SampleParser(tokens);</span><br><span class="line"><span class="comment">// visitorでASTをトラバース</span></span><br><span class="line">ParseTree tree = parser.sum();</span><br><span class="line">System.out.println(<span class="keyword">new</span> ExtractRhsNumVisitor().visit(tree));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">456</span><br></pre></td></tr></table></figure><p>visitorの特徴は以下の通りです。</p><ul><li>ASTの全ノードを訪問するとは限らない</li><li>ノードに入った時(<code>visitXXX</code>メソッド)に行う処理を目的に合わせてOverrideする</li><li>Overrideするメソッドは返り値を持つため、欲しい値をフィールドで保持しなくてよい</li></ul><p>上の実装例の<code>ExtractRhsNumVisitor#visitSum</code>は、ASTでsumノードを最初に訪問した時に2番目のNUM(つまり、+の右側の整数)を返す処理を行っています。</p><p>listenerでは自動的にASTの全ノードを訪問するのに対し、visitorの場合は今いるノードの部分木を訪問したい場合は明示的に実装する必要があるという大きな違いがあります。</p><h1 id="業務で生じた課題"><a href="#業務で生じた課題" class="headerlink" title="業務で生じた課題"></a>業務で生じた課題</h1><p>以降では、業務で生じた課題をANTLRで解決した話について述べたいと思います。課題の概要は以下の通りです。</p><p>以下のような<code>&lt;template&gt;</code>, <code>&lt;script&gt;</code>, <code>&lt;style&gt;</code>ブロックから構成されるvueファイルが与えられます。</p><figure class="highlight html"><figcaption><span>input.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; greeting &#125;&#125; World!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">  data () &#123;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">      greeting: <span class="string">'Hello'</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">p &#123;</span><br><span class="line">    font-size: 2em;</span><br><span class="line">    text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>このとき、以下のように<code>&lt;script&gt;</code>ブロックの中身を抽出する処理をJavaで実装して下さい。</p><figure class="highlight js"><figcaption><span>output.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      greeting: <span class="string">'Hello'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="解決策"><a href="#解決策" class="headerlink" title="解決策"></a>解決策</h1><ul><li>正規表現では難しい<ul><li><code>&lt;script&gt;(.*)&lt;/script&gt;</code>で良さそうに見えるが、以下のようなコメントがある場合に対応できない</li></ul></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;script&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// (省略)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>DOMやNekoHTMLなどのJavaで動作するXML用parserでは正しくparseできない場合があった</li><li>当時はANTLRについて調査するタスクも担当していたため、ANTLRで対応を試みた<ul><li>Vue.js用のgrammarは公式で用意されていなかったが、<code>&lt;script&gt;</code>ブロックの中身を取り出せれば十分なので、grammarを自作することにした </li></ul></li></ul><h1 id="コード"><a href="#コード" class="headerlink" title="コード"></a>コード</h1><details><summary>lexer用grammarを表示</summary><div><figure class="highlight java"><figcaption><span>SimpleVueLexer.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vueファイルから&lt;script&gt;ブロックの中身を抽出するためのlexer用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">lexer grammar SimpleVueLexer;</span><br><span class="line"></span><br><span class="line">HtmlComment</span><br><span class="line">    : <span class="string">'&lt;!--'</span> .*? <span class="string">'--&gt;'</span> -&gt; skip</span><br><span class="line">    ; </span><br><span class="line"></span><br><span class="line">WhiteSpaces</span><br><span class="line">    : [\t\u000B\u000C\u0020\u00A0]+ -&gt; skip</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">LineTerminator</span><br><span class="line">    : [\r\n\u2028\u2029] -&gt; skip</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// このトークンを検出した場合、TEMPLATEモードに遷移する</span></span><br><span class="line">TemplateOpen</span><br><span class="line">    : <span class="string">'&lt;template'</span> .*? <span class="string">'&gt;'</span> -&gt; pushMode(TEMPLATE)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// このトークンを検出した場合、SCRIPTモードに遷移する</span></span><br><span class="line">ScriptOpen</span><br><span class="line">    : <span class="string">'&lt;script'</span> .*? <span class="string">'&gt;'</span> -&gt; pushMode(SCRIPT)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// このトークンを検出した場合、STYLEモードに遷移する</span></span><br><span class="line">StyleOpen</span><br><span class="line">    : <span class="string">'&lt;style'</span> .*? <span class="string">'&gt;'</span> -&gt; pushMode(STYLE)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;template&gt;ブロックの中身を読んでいる時</span></span><br><span class="line">mode TEMPLATE;</span><br><span class="line"></span><br><span class="line">CommentInTemplate</span><br><span class="line">    : <span class="string">'&lt;!--'</span> .*? <span class="string">'--&gt;'</span> -&gt; skip</span><br><span class="line">    ; </span><br><span class="line"></span><br><span class="line">TemplateClose</span><br><span class="line">    : .* <span class="string">'&lt;/template&gt;'</span> -&gt; popMode</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;script&gt;ブロックの中身を読んでいる時</span></span><br><span class="line">mode SCRIPT;</span><br><span class="line"></span><br><span class="line">MultiLineComment</span><br><span class="line">    : <span class="string">'/*'</span> .*? <span class="string">'*/'</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">SingleLineComment</span><br><span class="line">    : <span class="string">'//'</span> ~[\r\n\u2028\u2029]*</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">ScriptClose</span><br><span class="line">    : <span class="string">'&lt;/script&gt;'</span> -&gt; popMode</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//「&lt;/」や「//」や「/*」で始まらない</span></span><br><span class="line">ScriptText</span><br><span class="line">    : (~[&lt;/] | '&lt;' ~'/' | '/' ~[*/])+</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;style&gt;ブロックの中身を読んでいる時</span></span><br><span class="line">mode STYLE;</span><br><span class="line"></span><br><span class="line">CommentInStyle</span><br><span class="line">    : <span class="string">'&lt;!--'</span> .*? <span class="string">'--&gt;'</span> -&gt; skip</span><br><span class="line">    ; </span><br><span class="line"></span><br><span class="line">StyleClose</span><br><span class="line">    : .* <span class="string">'&lt;/style&gt;'</span> -&gt; popMode</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure></div></details><details><summary>parser用grammarを表示</summary><div><figure class="highlight java"><figcaption><span>SimpleVueParser.g4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vueファイルから&lt;script&gt;ブロックの中身を抽出するためのparser用grammar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser grammar SimpleVueParser;</span><br><span class="line"></span><br><span class="line">options &#123; tokenVocab=SimpleVueLexer; &#125;</span><br><span class="line"></span><br><span class="line">parse</span><br><span class="line">: templateElement? scriptElement styleElement?</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">templateElement</span><br><span class="line">: TemplateOpen TemplateClose</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">scriptElement</span><br><span class="line">: ScriptOpen scriptBody ScriptClose</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 今回取得したい部分</span></span><br><span class="line">scriptBody</span><br><span class="line">: (SingleLineComment</span><br><span class="line">| MultiLineComment</span><br><span class="line">| ScriptText)+</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">styleElement</span><br><span class="line">: StyleOpen StyleClose</span><br><span class="line">;</span><br></pre></td></tr></table></figure></div></details><details><summary>抽出用listenerを表示</summary><div><figure class="highlight java"><figcaption><span>JavaScriptExtractorListener.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jp.co.future.antlr.parser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jp.co.future.antlr.parser.SimpleVueParser.ScriptElementContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTreeWalker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptExtractorListener</span> <span class="keyword">extends</span> <span class="title">SimpleVueParserBaseListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽出した文字列 */</span></span><br><span class="line"><span class="keyword">private</span> String scriptBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽出実行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exec</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">// 指定したファイルからCharStreamを生成</span></span><br><span class="line">CharStream cs = CharStreams.fromPath(Paths.get(filePath));</span><br><span class="line"><span class="comment">// CharStreamをlexerに渡す</span></span><br><span class="line">SimpleVueLexer lexer = <span class="keyword">new</span> SimpleVueLexer(cs);</span><br><span class="line"><span class="comment">// lexerでトークン列に分解</span></span><br><span class="line">CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);</span><br><span class="line"><span class="comment">// トークン列をparserに渡し、ASTを作る</span></span><br><span class="line">SimpleVueParser parser = <span class="keyword">new</span> SimpleVueParser(tokens);</span><br><span class="line"><span class="comment">// ASTをトラバースして文字列を抽出する</span></span><br><span class="line">ParseTreeWalker walker = ParseTreeWalker.DEFAULT;</span><br><span class="line">walker.walk(<span class="keyword">this</span>, parser.parse());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enterScriptElement</span><span class="params">(ScriptElementContext ctx)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 抽出する文字列をセット</span></span><br><span class="line">scriptBody = ctx.scriptBody().getText();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽出した文字列を取得する</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getScriptBody</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> scriptBody;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></details><p>この記事に掲載したコードをGitHub上でもご確認頂けます。<br><a href="https://github.com/f-t-hiraoka/antlr-sample" target="_blank" rel="noopener">https://github.com/f-t-hiraoka/antlr-sample</a></p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>正規表現や既存のparserでは対応が難しい課題をANTLRを利用して解決しました。文字列の処理で困ったときは、選択肢の1つとして検討してみてはいかがでしょうか。</p><p>コアテクノロジーユニットでは、現在チームメンバーを募集しています。<br>私たちと一緒にテクノロジーで設計、開発、テストの高品質・高生産性を実現する仕組みづくりをしませんか？</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.antlr.org/" target="_blank" rel="noopener">ANTLR公式</a></li><li><a href="https://tomassetti.me/antlr-mega-tutorial/" target="_blank" rel="noopener">The ANTLR Mega Tutorial</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、TIG コアテクノロジーユニットの平岡です。&lt;/p&gt;
&lt;p&gt;コアテクノロジーユニットはフューチャーグループ全体の
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Java" scheme="https://future-architect.github.io/tags/Java/"/>
    
      <category term="Vue.js" scheme="https://future-architect.github.io/tags/Vue-js/"/>
    
      <category term="ANTLR4" scheme="https://future-architect.github.io/tags/ANTLR4/"/>
    
      <category term="構文解析" scheme="https://future-architect.github.io/tags/%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>GCP Professional Cloud Network Engineer に合格しました</title>
    <link href="https://future-architect.github.io/articles/20200902/"/>
    <id>https://future-architect.github.io/articles/20200902/</id>
    <published>2020-09-01T15:00:00.000Z</published>
    <updated>2020-09-02T00:29:58.125Z</updated>
    
    <content type="html"><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>今回、GCP の <code>Professional Cloud Network Engineer</code> という資格に合格したので、その際の体験を記載しておきます。</p><img src="/images/20200902/1_zRKo4d8TLjscKiHqgk6u5w.png" class="img-small-size"><p>Cloud Architect の資格の体験記は<a href="https://future-architect.github.io/articles/20190530/">こちら</a></p><h1 id="Professional-Cloud-Network-Engineer-とは？"><a href="#Professional-Cloud-Network-Engineer-とは？" class="headerlink" title="Professional Cloud Network Engineer とは？"></a>Professional Cloud Network Engineer とは？</h1><p>そもそも何の資格なのか、簡単に特性を記載しておきます。<br>公式サイトは<a href="https://cloud.google.com/certification/cloud-network-engineer" target="_blank" rel="noopener">こちら</a>。</p><ul><li>GCP のネットワークの知識を問う資格</li><li>英語のみ</li><li>日本人の取得者は記事の数からそこまで多くないと想定されます。</li></ul><h1 id="筆者の前提知識"><a href="#筆者の前提知識" class="headerlink" title="筆者の前提知識"></a>筆者の前提知識</h1><p>おそらく自分はかなり前提知識がある状態でのスタートでした。簡単に書くと以下です。</p><ul><li>実務経験<ul><li>前職で5年ほど、オンプレのネットワーク構築や技術検証をしていました。<ul><li>パラメータは製品によってまちまちなので、そらでは言えないですが、設計は問題なくこなせるレベル</li></ul></li><li>現職では、GCP上でのアーキテクチャ設計などをネットワークの観点含めて実施しています。</li></ul></li><li>保有資格<ul><li>IPA ネットワークスペシャリスト</li><li>GCP <code>Professional Cloud Architect</code></li><li>AWS <code>Solutions Architect Associate</code></li></ul></li><li>語学<ul><li>海外旅行程度なら困らないくらい。</li></ul></li></ul><h1 id="出た問題"><a href="#出た問題" class="headerlink" title="出た問題"></a>出た問題</h1><p>多かった順に書いていきます。</p><h5 id="オンプレとの接続をどうするのが良いか？"><a href="#オンプレとの接続をどうするのが良いか？" class="headerlink" title="オンプレとの接続をどうするのが良いか？"></a>オンプレとの接続をどうするのが良いか？</h5><ul><li>Interconnect/VPN などの接続方法で適しているのはどれか？</li><li>Routing テーブルの交換<ul><li>特に BGP に対応していない場合ですね。<ul><li>ポリシーベースとルートベースが選択できますが、どういう時にどっちを使うのか？</li></ul></li></ul></li></ul><h5 id="GKE-Native-Cluster-を作る場合"><a href="#GKE-Native-Cluster-を作る場合" class="headerlink" title="GKE Native Cluster を作る場合"></a>GKE Native Cluster を作る場合</h5><ul><li>Native Cluster を作る際の CIDR 設計</li><li>Private Native Cluster の作成方法</li></ul><h5 id="GCP-のサービスをプライベートで接続する際のオプションは？"><a href="#GCP-のサービスをプライベートで接続する際のオプションは？" class="headerlink" title="GCP のサービスをプライベートで接続する際のオプションは？"></a>GCP のサービスをプライベートで接続する際のオプションは？</h5><ul><li>GCP 内の VPC から Bigquery, GCS にプライベートに接続したい場合は、どうすればよいか？<ul><li>要するに<a href="https://cloud.google.com/vpc/docs/configure-private-google-access" target="_blank" rel="noopener">こちら</a></li></ul></li><li>GCP 内の VPC から Cloud SQL にプライベートに接続したい場合は、どうすればよいのか？<ul><li>要するに<a href="https://cloud.google.com/vpc/docs/configure-private-services-access" target="_blank" rel="noopener">こちら</a></li></ul></li><li>オンプレミスのサーバから、BigQuery, GCS にイントラネット経由で通信するためには？<ul><li>要するに<a href="https://cloud.google.com/vpc/docs/configure-private-google-access-hybrid" target="_blank" rel="noopener">こちら</a></li></ul></li><li>これらを押さえておけば、大丈夫でしょう。実際の現場的には、最初の選択肢が主流とは思います。Cloud SQL のプライベート接続は、Firewallを書けないため、逆に脆弱だとすら思います。<ul><li><a href="https://future-architect.github.io/articles/20190820/">こちらの記事</a> の <code>2-2</code> で詳しく触れられています。</li></ul></li></ul><h5 id="セキュリティアプライアンスがある場合のルーティング"><a href="#セキュリティアプライアンスがある場合のルーティング" class="headerlink" title="セキュリティアプライアンスがある場合のルーティング"></a>セキュリティアプライアンスがある場合のルーティング</h5><ul><li>通常はセキュリティアプライアンスに向けて、特定の宛先だけをダイレクトに通信させたい場合はどうするか？</li><li>逆に、通常はDefault Internet Gateway に向けて、特定の通信だけをセキュリティアプライアンスに向けたい場合はどうするか？</li></ul><h5 id="CDN関連"><a href="#CDN関連" class="headerlink" title="CDN関連"></a>CDN関連</h5><ul><li>GCS Bucket を CDN で使いたい場合はどんな設定をすればよいか？</li></ul><h5 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a>Load Balancer</h5><ul><li>予想よりも Network Load Balancer が多かった気がします。<ul><li>インターネット経由で VOIP の通信を行うためには、どれが適切か？<ul><li>基本、音声系は NAT 超えが出来ないので（RTP内にもsrc IP/dst IP情報を持っているから、IP層だけ書き換えると通話が不可能になる）</li></ul></li></ul></li><li>GCEで提供されているサービスをカナリーリリースするためにはどうするか？</li></ul><h5 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h5><ul><li>deny のログを残したい場合はどうするか？</li></ul><h5 id="Cloud-Armor"><a href="#Cloud-Armor" class="headerlink" title="Cloud Armor"></a>Cloud Armor</h5><ul><li>Global LBで展開しているサービスがあり、特定の通信元からだけ入る様にする場合は、どう構成するか？</li></ul><h5 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h5><ul><li>通信が出来なくなった関連のトラシュー問題</li><li>TCP Connection は 3Gbps が上限だが、そこまで出すためにはTCPのフロー制御に関連するパラメータを設定する必要がある。</li></ul><h1 id="何を勉強したか？"><a href="#何を勉強したか？" class="headerlink" title="何を勉強したか？"></a>何を勉強したか？</h1><p>勉強した教材は以下です。</p><ul><li>qwiklabs<ul><li><a href="https://www.qwiklabs.com/quests/46" target="_blank" rel="noopener">https://www.qwiklabs.com/quests/46</a></li></ul></li><li>業務<ul><li>GKE Native Cluster</li><li>VPN 全般</li><li>SharedVPC</li><li>VPC Service Controls + Restricted API</li><li>HTTP(s) LB + (GKE)NEG</li></ul></li><li>模擬試験<ul><li><a href="https://googlecloud.4watcher365.dev/practice-exam/en-professional-cloud-network-engineer-exam-v20200227/" target="_blank" rel="noopener">https://googlecloud.4watcher365.dev/practice-exam/en-professional-cloud-network-engineer-exam-v20200227/</a></li><li><a href="https://www.testpreptraining.com/google-professional-cloud-network-engineer-gcp-free-practice-test" target="_blank" rel="noopener">https://www.testpreptraining.com/google-professional-cloud-network-engineer-gcp-free-practice-test</a></li><li>後は正規の模擬試験のみ</li></ul></li><li>参考にしたサイト<ul><li><a href="https://googlecloud.4watcher365.dev/google-cloud/professional-cloud-network-engineer_info/" target="_blank" rel="noopener">https://googlecloud.4watcher365.dev/google-cloud/professional-cloud-network-engineer_info/</a></li></ul></li></ul><h1 id="どれくらいの期間勉強したか？"><a href="#どれくらいの期間勉強したか？" class="headerlink" title="どれくらいの期間勉強したか？"></a>どれくらいの期間勉強したか？</h1><ul><li>6月<ul><li>6月頭に <code>Professional Cloud Architect</code> に合格</li><li>そのまま、<code>Network Engineer</code> の正規の模擬試験を受ける<ul><li>この段階で 7割程度</li></ul></li><li>6月は Qwiklabs を受講していた<ul><li><a href="https://www.qwiklabs.com/quests/46" target="_blank" rel="noopener">https://www.qwiklabs.com/quests/46</a></li></ul></li></ul></li><li>7月<ul><li>前半は上記の模擬試験を解く。</li><li>後半はさぼる。</li></ul></li><li>8月<ul><li>前半に復習。</li><li>8/19 に合格</li></ul></li></ul><h1 id="体感的な正答率"><a href="#体感的な正答率" class="headerlink" title="体感的な正答率"></a>体感的な正答率</h1><ul><li>おそらく、9割くらいは行けたと思います。<ul><li>確実に合ってると自信があったのが8割。</li><li>2択まで絞れているのが2割。（これも選択した理由を答えられるレベルには自信があります）</li><li>全くわからないのは 0 でした。</li></ul></li><li>個人的には、<code>Cloud Architect</code> の方が難しかったです。体感的な正答率も、<code>Cloud Architect</code> は『8割程度かな』くらいでした。</li></ul><h1 id="その他-1"><a href="#その他-1" class="headerlink" title="その他"></a>その他</h1><ul><li>でも英語は読むのはちょっと大変なので、実は15問/50問くらいのところでもうやめたくなりました。</li><li>時間配分的には、1:20 くらいで全部解いて、30分くらいで全部見直し、10分余る、くらいでした。<ul><li>この所要時間は、<code>Cloud Architect</code> と同じくらいでした。（言語による違いは実際はありませんでした）</li></ul></li></ul><h1 id="合格後の特典"><a href="#合格後の特典" class="headerlink" title="合格後の特典"></a>合格後の特典</h1><p>やはりありました。<code>Cloud Architect</code> とは別なんですね。<br><img src="/images/20200902/2020-08-22_220718.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;今回、GCP の &lt;code&gt;Professional Cloud Network Engineer&lt;/code&gt; という資
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Network" scheme="https://future-architect.github.io/tags/Network/"/>
    
      <category term="GCP" scheme="https://future-architect.github.io/tags/GCP/"/>
    
      <category term="合格記" scheme="https://future-architect.github.io/tags/%E5%90%88%E6%A0%BC%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>Vue.jsで最速に始めるCheetah Grid</title>
    <link href="https://future-architect.github.io/articles/20200901/"/>
    <id>https://future-architect.github.io/articles/20200901/</id>
    <published>2020-08-31T15:00:00.000Z</published>
    <updated>2020-09-02T00:21:38.974Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200901/top.png" class="img-middle-size"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>2019年入社、TIG所属の吉野貴大です。</p><p>今回、記事を投稿することになったキッカケは、フューチャー発のOSSであるCheetah Gridを使用した業務システム開発に携わったことです。</p><p>また、Cheetah Gridの<a href="https://future-architect.github.io/cheetah-grid/documents/">公式ドキュメント</a>は英語のみで、現時点では日本語の解説記事が少ないこともあり、業務システム開発で使いやすいと思われるCheetah Gridの機能を紹介していきます。</p><h1 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h1><p>Cheetah Gridの入門として、業務システム開発で利用する際のCheetah Gridについて、各コンポーネントの概要と簡単な使い方を実装付きで説明します。</p><ul><li>細かいコンポーネントの属性や高度なコンポーネント（c-grid-layout-rowとc-grid-header）については説明しません</li><li>Cheetah GridのAPIにはJavaScript版とVue.js版がありますが、Vue.jsのみについて説明します</li></ul><h1 id="Cheetah-Gridとは"><a href="#Cheetah-Gridとは" class="headerlink" title="Cheetah Gridとは"></a>Cheetah Gridとは</h1><p>Cheetah Gridは、扱うデータ件数が多くても高速にテーブル描画ができるJavaScriptのコンポーネントで、1,000,000件のデータを約0.1秒で描画することができます。対応言語はJavaScriptでVue.jsとしても利用することができます。</p><p><a href="https://future-architect.github.io/cheetah-grid/">デモページ</a>でその表示速度を体験することができます。</p><p>業務システムでCheetah Gridを使用するメリットを紹介します。</p><ol><li>大量データでも高速に描画することができる<ul><li>参考: （<a href="https://qiita.com/ota-meshi/items/a2b68e132fa7c5a32c3d" target="_blank" rel="noopener">【JavaScript】最速のOSS Data Table/Grid/SpreadSheetを探して、</a>）</li></ul></li><li>業務部品がコンポーネント化してあるため、同じような処理が多い業務処理を開発する際に、実装方法を統一することができる<ul><li>次の章で詳しく説明します</li></ul></li></ol><h1 id="Cheetah-Gridのコンポーネントについて"><a href="#Cheetah-Gridのコンポーネントについて" class="headerlink" title="Cheetah Gridのコンポーネントについて"></a>Cheetah Gridのコンポーネントについて</h1><p>Cheetah Gridが提供しているコンポーネントを利用することで、大量のデータの参照、登録、更新、削除の手助けをすることができます。</p><p>既存のグリッドを表現する方法としてHTMLのtableがあります。tableは、グリッドを表現する際に<code>tr</code>タグや<code>th</code>タグ、<code>td</code>タグを使用しなければならず階層が多くなり複雑な構成になってしまいます。また、業務システムで頻繁に要求される行のセルに入力項目を作る部品や、行データの中から1つ選択する部品を表現する際には、どちらも異なる処理なのにもかかわらず<code>input</code>タグを使用して表現します。加えて、<code>input</code>タグには最低限の入力やチェック機能しか備わっていません（他の処理はDOMを使用する）。</p><p>それに比べてCheetah Gridでは、業務システムに要求される部品を1つのコンポーネントで指定することができることで、可読性が良く、また、1つのコンポーネントで多くの属性が備わっているため、様々な処理を行うことができます。</p><p>本記事では、Vue.jsで利用できるCheetah Gridのコンポーネントについて紹介と、実装例を説明します。</p><h2 id="利用可能なVueコンポーネント"><a href="#利用可能なVueコンポーネント" class="headerlink" title="利用可能なVueコンポーネント"></a>利用可能なVueコンポーネント</h2><table><thead><tr><th align="left">コンポーネント名</th><th align="left">概要</th></tr></thead><tbody><tr><td align="left"><a href="#c-grid">c-grid</a></td><td align="left">Gridを定義する</td></tr><tr><td align="left"><a href="#c-grid-column">c-grid-column</a></td><td align="left">カラムの値を表示する</td></tr><tr><td align="left"><a href="#c-grid-column-group">c-grid-column-group</a></td><td align="left">定義したカラムをヘッダーをグループ化する</td></tr><tr><td align="left"><a href="#c-grid-button-column">c-grid-button-column</a></td><td align="left">ボタンを表示する</td></tr><tr><td align="left"><a href="#c-grid-check-column">c-grid-check-column</a></td><td align="left">チェックボックスを表示する</td></tr><tr><td align="left"><a href="#c-grid-input-column">c-grid-input-column</a></td><td align="left">入力項目を表示する</td></tr><tr><td align="left"><a href="#c-grid-menu-column">c-grid-menu-column</a></td><td align="left">プルダウンメニューを表示する</td></tr><tr><td align="left"><a href="#c-grid-link-column">c-grid-link-column</a></td><td align="left">リンクを表示する</td></tr><tr><td align="left"><a href="#c-grid-icon-column">c-grid-icon-column</a></td><td align="left">アイコンを表示する</td></tr><tr><td align="left"><a href="#c-grid-percent-complete-bar-column">c-grid-percent-complete-bar-column</a></td><td align="left">割合を色で表現して表示する</td></tr><tr><td align="left"><a href="#c-grid-radio-column">c-grid-radio-column</a></td><td align="left">ラジオボタンを表示する</td></tr><tr><td align="left">c-grid-layout-row</td><td align="left">複雑なレイアウトを作成する</td></tr><tr><td align="left">c-grid-header</td><td align="left">複雑なヘッダー構成などを作成する時に使用する</td></tr></tbody></table><p>コンポーネントを使用して実際に作成した画面がこちらです。<br><img src="/images/20200901/gamen.gif" alt=""><br>今回作成した一覧のカラム名は、「ID」、「選択」、「削除」、「データ（データ１、データ２）」「種別」、「詳細」、「割合」、「アイコン」としています。</p><h1 id="コード実装例"><a href="#コード実装例" class="headerlink" title="コード実装例"></a>コード実装例</h1><h3 id="開発環境"><a href="#開発環境" class="headerlink" title="開発環境"></a>開発環境</h3><ul><li>Node.js(v14.4.0)</li><li>npm(6.14.5)</li><li>Nuxt.js(v2.13.3)</li><li>Cheetah Grid(0.22.3)</li><li>npmでCheetah Gridを使用するには、下記のコマンドを実行してください。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -S cheetah-grid</span><br></pre></td></tr></table></figure><h3 id="全体のソースコード"><a href="#全体のソースコード" class="headerlink" title="全体のソースコード"></a>全体のソースコード</h3><p>はじめに全体のソースコードを記載します。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"height: 500px; border: solid 1px #ddd; margin: 50px"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">c-grid</span> <span class="attr">:data</span>=<span class="string">"records"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">:frozen-col-count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-column</span> <span class="attr">field</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">width</span>= <span class="string">"50"</span>&gt;</span></span><br><span class="line">          ID</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-radio-column</span> <span class="attr">field</span>=<span class="string">"selected"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">width</span>=<span class="string">"50"</span>&gt;</span></span><br><span class="line">          選択</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-radio-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-button-column</span> <span class="attr">caption</span>=<span class="string">"削除"</span></span></span><br><span class="line"><span class="tag">                              <span class="attr">width</span>=<span class="string">"50"</span></span></span><br><span class="line"><span class="tag">                              @<span class="attr">click</span>=<span class="string">"onDeleted"</span>&gt;</span></span><br><span class="line">          削除</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-button-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-check-column</span> <span class="attr">field</span>=<span class="string">"checked"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">width</span>=<span class="string">"70"</span>&gt;</span></span><br><span class="line">          フラグ</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-check-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-column-group</span> <span class="attr">caption</span>=<span class="string">"データ"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data1"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">width</span>=<span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">            データ1</span><br><span class="line">          <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data2"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">width</span>= <span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">            データ2</span><br><span class="line">          <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-column-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-menu-column</span> <span class="attr">field</span>=<span class="string">"type"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">:options</span>=<span class="string">"[&#123;label: '種別1', value: 1&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                                       &#123;label: '種別2', value: 2&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                                       &#123;label: '種別3', value: 3&#125;]"</span>&gt;</span></span><br><span class="line">                種別</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-menu-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-link-column</span> <span class="attr">href</span>=<span class="string">"link"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">:icon</span>=<span class="string">"getLinkIcon"</span>&gt;</span></span><br><span class="line">                詳細</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-link-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-percent-complete-bar-column</span> <span class="attr">field</span>=<span class="string">"percent"</span></span></span><br><span class="line"><span class="tag">                                            <span class="attr">:max</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">                                            <span class="attr">:min</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                割合</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-percent-complete-bar-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">c-grid-icon-column</span> <span class="attr">field</span>=<span class="string">"iconNum"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">icon-class-name</span>=<span class="string">"material-icons"</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">icon-content</span>=<span class="string">"grade"</span>&gt;</span></span><br><span class="line">                アイコン</span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-grid-icon-column</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">c-grid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"grid-sample"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> * <span class="keyword">as</span> cGridAll <span class="keyword">from</span> <span class="string">'vue-cheetah-grid'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">'service'</span>,</span></span><br><span class="line">    components: &#123;</span><br><span class="line">        ...cGridAll</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted() &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.setRecord()</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data () &#123;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line">            records: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        /**</span><br><span class="line">         * 削除ボタン押下イベント</span><br><span class="line">         *</span><br><span class="line">         * @param &#123;object&#125; rec 行データ</span><br><span class="line"><span class="actionscript">         * @<span class="keyword">return</span> &#123;<span class="keyword">void</span>&#125;</span></span><br><span class="line">         **/</span><br><span class="line">        onDeleted(rec) &#123; </span><br><span class="line"><span class="actionscript">            <span class="keyword">const</span> vm = <span class="keyword">this</span></span></span><br><span class="line">            vm.records.splice(vm.records.indexOf(rec), 1);</span><br><span class="line">        &#125;,</span><br><span class="line">        /**</span><br><span class="line">         * 一覧に表示するデータを作成する</span><br><span class="line">         *</span><br><span class="line"><span class="actionscript">         * @<span class="keyword">return</span> &#123;<span class="keyword">void</span>&#125;</span></span><br><span class="line">         **/</span><br><span class="line">        setRecord () &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">const</span> vm = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span></span><br><span class="line">                vm.records.push(&#123;</span><br><span class="line"><span class="actionscript">                    selected: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">                    checked: <span class="literal">false</span>,</span></span><br><span class="line">                    id: i+1,</span><br><span class="line"><span class="javascript">                    data1: <span class="string">`サンプル1-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span></span><br><span class="line"><span class="javascript">                    data2: <span class="string">`サンプル2-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span></span><br><span class="line"><span class="javascript">                    type: <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">3</span>) + <span class="number">1</span>,</span></span><br><span class="line"><span class="actionscript">                    link: <span class="string">"https://future-architect.github.io/cheetah-grid/documents/api/vue/components/CGridLinkColumn.html"</span>,</span></span><br><span class="line">                    iconNum: 1,</span><br><span class="line"><span class="javascript">                    percent: <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">100</span>)</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        /**</span><br><span class="line">         * c-grid-link-columnに表示するアイコンを取得する</span><br><span class="line">         *</span><br><span class="line"><span class="actionscript">         * @<span class="keyword">return</span> &#123;object&#125; アイコン情報</span></span><br><span class="line">         **/</span><br><span class="line">        getLinkIcon () &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">                className: <span class="string">'material-icons'</span>,</span></span><br><span class="line"><span class="actionscript">                content: <span class="string">'input'</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid"><a href="#c-grid" class="headerlink" title="c-grid"></a>c-grid</h3><p>c-gridは、Cheetah Gridを使用するための土台となるコンポーネントです。<br><code>data</code>属性に一覧に表示したいリストデータを指定し、リストの各要素は列に表示するデータを保持するオブジェクトです。<br><code>data</code>属性以外にも<code>frozen-col-count</code>、<code>disabled</code>や<code>readonly</code>など多くの属性があるので、グリッド全体の設定を定義することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid</span> <span class="attr">:data</span>=<span class="string">"records"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:frozen-col-count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ここでCheetah Gridの各Vueコンポーネントを使って列項目を定義する --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid</span>&gt;</span></span><br></pre></td></tr></table></figure><p>一覧に表示するデータは以下のように作成しています。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    records: []</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    setRecords () &#123;</span><br><span class="line">      <span class="keyword">const</span> vm = <span class="keyword">this</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        vm.records.push(&#123;</span><br><span class="line">          selected: <span class="literal">false</span>,</span><br><span class="line">          checked: <span class="literal">false</span>,</span><br><span class="line">          id: i+<span class="number">1</span>,</span><br><span class="line">          data1: <span class="string">`サンプル1-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span><br><span class="line">          data2: <span class="string">`サンプル2-<span class="subst">$&#123;i+<span class="number">1</span>&#125;</span>`</span>,</span><br><span class="line">          type: <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">3</span>) + <span class="number">1</span>,</span><br><span class="line">          link: <span class="string">"https://future-architect.github.io/cheetah-grid/documents/api/vue/components/CGridLinkColumn.html"</span>,</span><br><span class="line">          iconNum: <span class="number">1</span>,</span><br><span class="line">          percent: <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">100</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="c-grid-column"><a href="#c-grid-column" class="headerlink" title="c-grid-column"></a>c-grid-column</h3><p>c-grid-columnは、<code>field</code>属性にデータのプロパティ名を指定することで値を列に表示することができます。<br><code>width</code>属性で横幅の指定ができます。<br>列見出しはタグのテキスト部に書くことで表示できます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-column</span> <span class="attr">field</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">width</span>= <span class="string">"50"</span>&gt;</span></span><br><span class="line">  ID</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-column-group"><a href="#c-grid-column-group" class="headerlink" title="c-grid-column-group"></a>c-grid-column-group</h3><p>c-grid-column-groupは、カラムヘッダをまとめることができます。</p><p>「データ」というカラム内に、「データ１」と「データ２」を多段で表示しています。<code>caption</code>属性で全体のカラム名を決めます、また、今回は、c-grid-input-columnを使用していますが、それ以外のコンポーネントも配置することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-column-group</span> <span class="attr">caption</span>=<span class="string">"データ"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data1"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">width</span>=<span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ1</span><br><span class="line">  <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data2"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">width</span>= <span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ2</span><br><span class="line">  <span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-column-group</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-button-column"><a href="#c-grid-button-column" class="headerlink" title="c-grid-button-column"></a>c-grid-button-column</h3><p>c-grid-button-columnは、カラム内にボタンを配置することができます。<br>業務システムでは、ボタンによって処理を制御することが度々ありますが、今回は、c-grid-button-columnを使用して削除ボタンを作成しました。<br><code>@click</code>属性で押下後の処理を定義することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-button-column</span> <span class="attr">caption</span>=<span class="string">"削除"</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">width</span>=<span class="string">"50"</span></span></span><br><span class="line"><span class="tag">                      @<span class="attr">click</span>=<span class="string">"onDeleted"</span>&gt;</span></span><br><span class="line">削除</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-button-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-check-column"><a href="#c-grid-check-column" class="headerlink" title="c-grid-check-column"></a>c-grid-check-column</h3><p>c-grid-check-columnでは、1つのチェックボックスを実現することができます。</p><p><code>field</code>に指定したプロパティにチェック状態に対応した値が設定されます。チェック値は、プロパティの初期値に応じて、設定される値が異なります。（<a href="https://future-architect.github.io/cheetah-grid/documents/api/js/column_actions/CheckEditor.html#data-editing">設定値</a>）。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-check-column</span> <span class="attr">field</span>=<span class="string">"checked"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>=<span class="string">"70"</span>&gt;</span></span><br><span class="line">  フラグ</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-check-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-input-column"><a href="#c-grid-input-column" class="headerlink" title="c-grid-input-column"></a>c-grid-input-column</h3><p>c-grid-input-columnは、「表示」、「入力」のどちらも行うことができます。一覧内のデータを直接入力できることで一覧データの登録や更新を、一括で行う画面の開発ができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data1"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>=<span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ1</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c-grid-input-column</span> <span class="attr">field</span>=<span class="string">"data2"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>= <span class="string">"20%"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">min-width</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">    データ2</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-input-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-menu-column"><a href="#c-grid-menu-column" class="headerlink" title="c-grid-menu-column"></a>c-grid-menu-column</h3><p>c-grid-menu-columnは、<code>options</code>属性に与えられたリストから1つを選択することができます。</p><p>決まったデータ群から選択させたい場合などに使用することができ、設定するデータは<code>options</code>属性にオブジェクトのリストを指定し、<code>label</code>と<code>value</code>で表示させる文字列、データを定義することでプルダウンメニューを表示します。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-menu-column</span> <span class="attr">field</span>=<span class="string">"type"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">:options</span>=<span class="string">"[&#123;label: '種別1', value: 1&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                               &#123;label: '種別2', value: 2&#125;, </span></span></span><br><span class="line"><span class="tag"><span class="string">                               &#123;label: '種別3', value: 3&#125;]"</span>&gt;</span></span><br><span class="line">  種別</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-menu-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-link-column"><a href="#c-grid-link-column" class="headerlink" title="c-grid-link-column"></a>c-grid-link-column</h3><p>c-grid-link-columnは、列の値自体をリンクとすることができます。</p><p>今回は、リンクにアイコンを設定しました。<code>href</code>属性には、遷移先の情報（URL）などを設定したプロパティを指定します。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-link-column</span> <span class="attr">href</span>=<span class="string">"link"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">:icon</span>=<span class="string">"getLinkIcon"</span>&gt;</span></span><br><span class="line">  詳細</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-link-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-icon-column"><a href="#c-grid-icon-column" class="headerlink" title="c-grid-icon-column"></a>c-grid-icon-column</h3><p>c-grid-icon-columnでは、アイコンを表示することができる。</p><p>今回は、<a href="https://material.io/resources/icons/?icon=delete&style=baseline" target="_blank" rel="noopener">material-icons</a>を使用して<code>grade</code>を表示しています。<code>field</code>属性にアイコンの表示数を指定することで複数アイコンを表示することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-icon-column</span> <span class="attr">field</span>=<span class="string">"iconNum"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">icon-class-name</span>=<span class="string">"material-icons"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">icon-content</span>=<span class="string">"grade"</span>&gt;</span></span><br><span class="line">  アイコン</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-icon-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-percent-complete-bar-column"><a href="#c-grid-percent-complete-bar-column" class="headerlink" title="c-grid-percent-complete-bar-column"></a>c-grid-percent-complete-bar-column</h3><p>c-grid-percent-complete-bar-columnでは、割合を表示することができます。<code>field</code>属性に指定した数字が、<code>max</code>属性、<code>min</code>属性間でどのくらいの割合なのかを示すことができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-percent-complete-bar-column</span> <span class="attr">field</span>=<span class="string">"percent"</span></span></span><br><span class="line"><span class="tag">                                    <span class="attr">:max</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">                                    <span class="attr">:min</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">  割合</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-percent-complete-bar-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="c-grid-radio-column"><a href="#c-grid-radio-column" class="headerlink" title="c-grid-radio-column"></a>c-grid-radio-column</h3><p>c-grid-radio-columnでは、ラジオボタンを表示することができます。一覧データ中から、1つを対象に選ぶ場合などで使用することができます。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-grid-radio-column</span> <span class="attr">field</span>=<span class="string">"selected"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">width</span>=<span class="string">"50"</span>&gt;</span></span><br><span class="line">  選択</span><br><span class="line"><span class="tag">&lt;/<span class="name">c-grid-radio-column</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="実装してみて"><a href="#実装してみて" class="headerlink" title="実装してみて"></a>実装してみて</h1><p>Cheetah Gridで一覧情報の例を実装してみて、あらかじめ処理を行ってくれる属性多く用意されており、HTMLなどと比べて業務システム開発で使用する一覧情報を実装することが容易でした。</p><p>1,000,000件のデータを表示する際にもほぼストレスなく表示することができ、ユーザに対しても満足度が高いものが作成できると考えます。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>今回は、業務で使用したCheetah Gridについて、基本的な内容を説明しました。あらかじめ用意されているコンポーネントの属性を使用して、Web画面で利用するグリッドを表現できます。</p><p>また、本記事で触れてませんが業務で役に立つ機能に「Excel貼り付け」や「一括入力」の機能があります。Excel貼り付けは業務のデータをExcelでまとめていたものをシステムに移行する際に、手入力ではなくコピペで貼り付けることができます。一括入力は大量にあるデータ1つ1つチェックをつけるのではなく、一括でチェックできる機能を実現します。</p><p>今回は、Cheetah Gridが提供している単体コンポーネントの使用方法を説明しましたが、単体で使用するのではなくいくつかのコンポーネントを組み合わせることでより柔軟なグリッドを表示することが可能です。</p><p>ぜひ、皆さん利用してみてください！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200901/top.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="JavaScript" scheme="https://future-architect.github.io/tags/JavaScript/"/>
    
      <category term="Vue.js" scheme="https://future-architect.github.io/tags/Vue-js/"/>
    
      <category term="CheetahGrid" scheme="https://future-architect.github.io/tags/CheetahGrid/"/>
    
  </entry>
  
  <entry>
    <title>チームで推奨するVSCode拡張機能を共有するtips</title>
    <link href="https://future-architect.github.io/articles/20200828/"/>
    <id>https://future-architect.github.io/articles/20200828/</id>
    <published>2020-08-27T15:00:00.000Z</published>
    <updated>2020-09-01T00:58:54.677Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。<br>TIG DXユニットの市川です。</p><p>プロジェクトにアサインされて、まずやらなければならないのは環境構築だと思います。</p><p>私が新人としてプロジェクトに参画した頃は、リポジトリのクローンからローカルサーバーを起動させるまでの手順は詳細に記載されていたものの、開発で使用するエディタの説明は特になく、VSCodeに各々が好きな拡張機能をインストールしている状態でした。当時開発経験が浅かった私は開発中に必要となる拡張機能を都度入れていたり、作業を効率化できる拡張機能を入れられておらず、非常に困っていました。</p><p>そういった背景もあり、私のプロジェクトではプロジェクトで必要となる・開発を効率的に行うことができる拡張機能を選定し、それらをVSCodeに一括でインストールする環境を整えたことで、プロジェクトに参画をした新人やキャリア入社の方、インターンの方がスムーズにエディタの設定を行うことができました。</p><p>今回は、どのようにプロジェクト推奨の拡張機能を設定するのか、新規参画者がどのように拡張機能を導入するかについてご説明します。</p><h1 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h1><p>まず、どのようにプロジェクト推奨の拡張機能を設定するかについてご説明します。</p><h2 id="vscode-extensions-jsonの作成"><a href="#vscode-extensions-jsonの作成" class="headerlink" title=".vscode/extensions.jsonの作成"></a>.vscode/extensions.jsonの作成</h2><p>まず、VSCodeを起動してインストールを推奨したい拡張機能のページにアクセスします。（今回はESLintを例に説明します。）</p><p><img src="/images/20200828/image.png" alt=""></p><p>そのあと、下記画像のようにコマンドパレットを開き、<code>Extensions: Add to Recommended Extensions (Workspace Folder)</code> を選択します。</p><p><img src="/images/20200828/image_2.png" alt=""></p><p>すると、<code>.vscode/extensions.json</code> が新規作成され、ESLintの拡張機能が<code>recommendations</code> に追加されていることがわかります。<br>また、<code>unwantedRecommendations</code> の項目も作成されてしますが、こちらはプロジェクトで推奨しない拡張機能を指定することが可能です。</p><p><img src="/images/20200828/image_3.png" alt=""></p><p>この手順を繰り返し、プロジェクトに必要な拡張機能を<code>recommendations</code> に追加していきます。</p><h2 id="新規参画者の手順"><a href="#新規参画者の手順" class="headerlink" title="新規参画者の手順"></a>新規参画者の手順</h2><p>次に新規参画者が拡張機能をインストールする手順を記載します。</p><p>VSCode起動後、まず ctrl + O (Macの方は⌘ + O) を押下して、対象のアプリケーションを選択し、ディレクトリを開きます。<br>下記の順で操作することで、推奨する拡張機能の候補が表示されます。</p><p><img src="/images/20200828/recommended.png" alt=""></p><p>下記画像の④のマーククリックし、拡張機能をインストールしてください。<br>もしVSCodeの使用に慣れており、独自で拡張機能を導入している場合は、下記に記載している拡張機能の概要を確認し、必要なものは緑色のinstallをクリックすることで、個別にインストールすることも可能です。</p><img src="/images/20200828/extension_install.png" class="img-middle-size"><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>今回は拡張機能に絞って説明しましたが、VSCodeでは様々な設定をjson形式でチームに共有することが可能です。<br>チームで設定を共有し、開発効率を高めていきましょう！</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://code.visualstudio.com/docs/editor/extension-gallery#_workspace-recommended-extensions" target="_blank" rel="noopener">Extension Marketplace - Workspace recommended extensions</a></li><li><a href="https://future-architect.github.io/articles/20200707/">VSCode の Go extension でよく利用するコマンド 7選</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。&lt;br&gt;TIG DXユニットの市川です。&lt;/p&gt;
&lt;p&gt;プロジェクトにアサインされて、まずやらなければならないのは環境構築だと思います。&lt;/p&gt;
&lt;p&gt;私が新人としてプロジェクトに参画した頃は、リポジトリのクローンからローカルサーバーを起動させるまでの手順は詳細
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="チーム開発" scheme="https://future-architect.github.io/tags/%E3%83%81%E3%83%BC%E3%83%A0%E9%96%8B%E7%99%BA/"/>
    
      <category term="VSCode" scheme="https://future-architect.github.io/tags/VSCode/"/>
    
  </entry>
  
  <entry>
    <title>Airflow の SLA設定方法</title>
    <link href="https://future-architect.github.io/articles/20200827/"/>
    <id>https://future-architect.github.io/articles/20200827/</id>
    <published>2020-08-26T15:00:00.000Z</published>
    <updated>2020-08-27T01:14:14.203Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200827/feature-image.png" class="img-middle-size"><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>TIG DXチームの多賀です。Airflowの SLA 設定方法を紹介します。</p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>sla_miss_callback 関数は以下の引数が必要</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla_alert</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    dag: DAG,</span></span></span><br><span class="line"><span class="function"><span class="params">    task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    slas: List[SlaMiss],</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_tis: List[TaskInstance]</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br></pre></td></tr></table></figure><h2 id="SLA設定"><a href="#SLA設定" class="headerlink" title="SLA設定"></a>SLA設定</h2><p>SLA とは Service Level Agreement の略で、サービス提供者が保証する品質を明示する際に利用されます。当 Airflow の SLA は、各 Task が指定の時間内に終わることを保証する形で定義されます。</p><p>そのため、Airflow は 各 Task に対して SLA 値(時間) を設定できます。</p><p><a href="https://airflow.apache.org/docs/stable/concepts.html#slas" target="_blank" rel="noopener">Concepts-SLAs</a></p><p>SLA 値は以下のように Task に対して定義します。10秒以上 Task が実行されると SLA 違反となります。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t1 = PythonOperator(</span><br><span class="line">    task_id=<span class="string">'sla_test'</span>,</span><br><span class="line">    python_callable=example_call,</span><br><span class="line">    sla=timedelta(seconds=<span class="number">10</span>), <span class="comment"># SLA 設定</span></span><br><span class="line">    dag=dag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>SLA 違反をした Task が発生した場合、以下2パターンで通知をすることができます</p><ul><li>Email</li><li>sla_miss_callback (Function) の任意実装</li></ul><p>注意点として、SLA 違反のチェックタイミングは、対象タスクの実行完了後ではなく、対象タスクの次のタスクの実行前(別 run_id の可能性もあり) になります。</p><p>Task 実行時に、過去の SLA 違反の一覧 (sla_miss テーブル) を取得して通知する仕組みになっています。</p><p>また、Task が実行されているいないに関わらず、 start_time と schedule_interval と 現在時刻から 実行されているべき Task を洗い出してエラー通知します。過去分の再実行等を実施すると、現在時刻まで実行されているべき Task まとめて SLA 違反が出たりします。</p><h3 id="Email-設定方法"><a href="#Email-設定方法" class="headerlink" title="Email 設定方法"></a>Email 設定方法</h3><p>ドキュメントと実装を読む限り、Operator の引数に渡す必要がありそうでした。<br>email が設定されていない場合は、エラーになることなく Task の実行が完了します。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t1 = PythonOperator(</span><br><span class="line">    task_id=<span class="string">'sla_test'</span>,</span><br><span class="line">    python_callable=example_call,</span><br><span class="line">    sla=timedelta(seconds=<span class="number">10</span>),</span><br><span class="line">    email=<span class="string">"xxx.yyy@example.com"</span>,</span><br><span class="line">    dag=dag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="sla-miss-callback-設定方法"><a href="#sla-miss-callback-設定方法" class="headerlink" title="sla_miss_callback 設定方法"></a>sla_miss_callback 設定方法</h3><p>ドキュメント上は、関数を設定と記載されてますが、以下のように設定しても動きません。</p><p><a href="https://airflow.readthedocs.io/en/1.10.11/_api/airflow/models/dag/index.html#airflow.models.dag.DAG" target="_blank" rel="noopener">https://airflow.readthedocs.io/en/1.10.11/_api/airflow/models/dag/index.html#airflow.models.dag.DAG</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla_alert</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># alert 設定</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_call</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># task 処理</span></span><br><span class="line"></span><br><span class="line">dag = DAG(</span><br><span class="line">    dag_id,</span><br><span class="line">    start_date=datetime(<span class="number">2020</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">0</span>),</span><br><span class="line">    schedule_interval=timedelta(days=<span class="number">1</span>),</span><br><span class="line">    sla_miss_callback=sla_alert,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">t1 = PythonOperator(</span><br><span class="line">    task_id=<span class="string">'sla_test'</span>,</span><br><span class="line">    python_callable=example_call,</span><br><span class="line">    sla=timedelta(seconds=<span class="number">10</span>),</span><br><span class="line">    dag=dag</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Scheduelr のログを見ると以下がはかれています。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[2020-08-11 18:27:00,766] &#123;&#123;scheduler_job.py:541&#125;&#125; ERROR - Could not call sla_miss_callback <span class="keyword">for</span> DAG example_sla</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/Users/xxx/.venv/lib/python3.7/site-packages/airflow/jobs/scheduler_job.py"</span>, line 537, <span class="keyword">in</span> manage_slas</span><br><span class="line">    blocking_tis)</span><br><span class="line">TypeError: sla_alert() takes 0 positional arguments but 5 were given</span><br></pre></td></tr></table></figure><h4 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h4><p>ソースコードを grep してみると 以下の実装を見つけました。<br>引数が必要みたいですね。</p><p><a href="https://github.com/apache/airflow/blob/master/airflow/jobs/scheduler_job.py#L455" target="_blank" rel="noopener">https://github.com/apache/airflow/blob/master/airflow/jobs/scheduler_job.py#L455</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># schduler_job.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> dag.sla_miss_callback:</span><br><span class="line">    <span class="comment"># Execute the alert callback</span></span><br><span class="line">    self.log.info(<span class="string">' --------------&gt; ABOUT TO CALL SLA MISS CALL BACK '</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dag.sla_miss_callback(dag, task_list, blocking_task_list, slas,</span><br><span class="line">                                blocking_tis)</span><br><span class="line">        notification_sent = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception:  <span class="comment"># pylint: disable=broad-except</span></span><br><span class="line">        self.log.exception(<span class="string">"Could not call sla_miss_callback for DAG %s"</span>,</span><br><span class="line">                            dag.dag_id)</span><br></pre></td></tr></table></figure><p>DAG の設定を修正してみると、無事に動きました。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla_alert</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    dag: DAG,</span></span></span><br><span class="line"><span class="function"><span class="params">    task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_task_list: str,</span></span></span><br><span class="line"><span class="function"><span class="params">    slas: List[SlaMiss],</span></span></span><br><span class="line"><span class="function"><span class="params">    blocking_tis: List[TaskInstance]</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    dag_id = dag.dag_id</span><br><span class="line">    task_id = slas[<span class="number">0</span>].task_id</span><br><span class="line">    execution_date = <span class="string">"&#123;&#125;"</span>.format(slas[<span class="number">0</span>].execution_date) <span class="comment"># UtcDateTime 型のため</span></span><br></pre></td></tr></table></figure><h4 id="sla-miss-callback-の引数"><a href="#sla-miss-callback-の引数" class="headerlink" title="sla_miss_callback の引数"></a>sla_miss_callback の引数</h4><table><thead><tr><th align="left">引数</th><th align="left">型</th><th align="left">値</th></tr></thead><tbody><tr><td align="left">dag</td><td align="left">airflow.DAG</td><td align="left">DAG オブジェクト dag.dag_id で ID取得可能</td></tr><tr><td align="left">task_list</td><td align="left">str</td><td align="left">過去のSLA エラーの Task の List <br> 以下フォーマットの文字列リスト <br> <code>${task_id} on ${execution_date}</code></td></tr><tr><td align="left">blocking_task_list</td><td align="left">str</td><td align="left">過去の失敗した Task の List <br> 以下フォーマットの文字列リスト <br> <code>${task_id} on ${execution_date}</code></td></tr><tr><td align="left">slas</td><td align="left">List[airflow.models.SlaMiss]</td><td align="left">過去のSLA エラーオブジェクトの List</td></tr><tr><td align="left">blocking_tis</td><td align="left">List[airflow.models.TaskInstance]</td><td align="left">失敗した TaskInstance の List</td></tr></tbody></table><p>SlaMiss<br><a href="https://airflow.apache.org/docs/stable/_api/airflow/models/slamiss/index.html" target="_blank" rel="noopener">https://airflow.apache.org/docs/stable/_api/airflow/models/slamiss/index.html</a></p><p>TaskInstance<br><a href="https://airflow.apache.org/docs/stable/_api/airflow/models/taskinstance/index.html" target="_blank" rel="noopener">https://airflow.apache.org/docs/stable/_api/airflow/models/taskinstance/index.html</a></p><h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>ドキュメントに記載してほしいところでしたが、見つけられなかったため別途整理しました。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200827/feature-image.png&quot; class=&quot;img-middle-size&quot;&gt;

&lt;h2 id=&quot;概要&quot;&gt;&lt;a href=&quot;#概要&quot; class=&quot;headerlink&quot; title=&quot;概要&quot;&gt;&lt;/a&gt;概要&lt;/h2&gt;&lt;
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="Python" scheme="https://future-architect.github.io/tags/Python/"/>
    
      <category term="Airflow" scheme="https://future-architect.github.io/tags/Airflow/"/>
    
  </entry>
  
  <entry>
    <title>go-swaggerでhello world</title>
    <link href="https://future-architect.github.io/articles/20200824/"/>
    <id>https://future-architect.github.io/articles/20200824/</id>
    <published>2020-08-23T15:00:00.000Z</published>
    <updated>2020-08-24T00:19:19.445Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200824/top.png" class="img-small-size"><p>The Gopher character is based on the Go mascot designed by <a href="http://reneefrench.blogspot.com/" target="_blank" rel="noopener">Renée French</a>.</p><p>TIG DXチームの伊藤真彦です。<br>今回はgo-swaggerの具体的な実装方法を紹介します。</p><h1 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h1><ul><li>はじめに</li><li>go-swaggerのインストール</li><li>swagger.yamlを準備する</li><li>ソースコードをビルドする</li><li>試しにサーバーを立ち上げてみる</li><li>ハンドラを実装する</li><li>ついにhello world完了</li></ul><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>最近の私のメイン業務は<a href="https://github.com/go-swagger/go-swagger" target="_blank" rel="noopener">go-swagger</a>を用いたAPI開発です。<br>go-swaggerはOpenAPI(Swagger) からGoのコードを生成するライブラリです。<br>フューチャーでは複数案件での採用実績があり、この技術ブログでも<a href="https://future-architect.github.io/tags/go-swagger/">様々な記事</a>が書かれています。</p><p>しかし、技術選定としての参考情報やtips集はあるものの、どのように実装していけばAPIが動くのかを理解するドキュメントは少なく、いざ実装となると学習コストがかかってしまいます。<br>そこで、今回はストーリーベースでの実装手順を説明します。</p><h1 id="go-swaggerのインストール"><a href="#go-swaggerのインストール" class="headerlink" title="go-swaggerのインストール"></a>go-swaggerのインストール</h1><p>go-swaggerは開発環境にインストールして使用します。<br>下記コマンドでインストールできます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/go-swagger/go-swagger/cmd/swagger</span><br></pre></td></tr></table></figure><p>その他にも様々なインストール方法があります。</p><ul><li>brew、apt、wget等のコマンドを経由してインストール</li><li>ソースコード、バイナリファイルのダウンロード</li><li>go installコマンドを経由したインストール</li><li>dockerコンテナとしての実行</li></ul><p>Dockerコンテナ以外は概ね開発環境のOSによる入手経路の違い程度の認識で差し支えないと思います。詳しくは<a href="https://goswagger.io/install.html" target="_blank" rel="noopener">Installing</a>を確認してください。</p><p><a href="https://github.com/go-swagger/go-swagger/releases/tag/v0.25.0" target="_blank" rel="noopener">リリースページ</a>からお使いのOSに応じた実行ファイルをダウンロードしてインストールすることも可能です。</p><p>アプリケーションをコンテナイメージの上で実行する場合、公式のコンテナイメージを<a href="https://matsuand.github.io/docs.docker.jp.onthefly/develop/develop-images/multistage-build/" target="_blank" rel="noopener">マルチステージビルド</a>に用いる事も可能ですね、夢が広がります。<br>方法は様々ですが、インストール後にswaggerコマンドが利用可能になります。(コンテナ形式での導入を除く)</p><h1 id="swagger-yamlを準備する"><a href="#swagger-yamlを準備する" class="headerlink" title="swagger.yamlを準備する"></a>swagger.yamlを準備する</h1><p>OpenAPIの仕様に従ってアプリケーションが生成される以上、まずはAPIの仕様を定義するファイルが無いと始まりません。<br>まずは<code>swagger.yaml</code>を作成します。</p><p><code>swagger.yaml</code>の書き方は<a href="https://swagger.io/specification/" target="_blank" rel="noopener">OpenAPI Specification</a>などに記載があります。<br><a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a>もあわせてお読みください。<br><code>swagger.yaml</code>の書き方についての詳細な説明は今回は省略します。</p><p>hello worldのためのサンプルとなる<code>swagger.yaml</code>はgo-swaggerのリポジトリに用意されています。<br><a href="https://github.com/go-swagger/go-swagger/blob/master/examples/tutorials/custom-server/swagger/swagger.yml" target="_blank" rel="noopener">tutorials/custom-server</a>を例に説明します。</p><figure class="highlight yaml"><figcaption><span>swagger.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">swagger:</span> <span class="string">'2.0'</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Greeting</span> <span class="string">Server</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/hello:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">produces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">text/plain</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">name</span></span><br><span class="line">          <span class="attr">required:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">defaults</span> <span class="string">to</span> <span class="string">World</span> <span class="string">if</span> <span class="string">not</span> <span class="string">given</span></span><br><span class="line">      <span class="attr">operationId:</span> <span class="string">getGreeting</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">200:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">returns</span> <span class="string">a</span> <span class="string">greeting</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">contains</span> <span class="string">the</span> <span class="string">actual</span> <span class="string">greeting</span> <span class="string">as</span> <span class="string">plain</span> <span class="string">text</span></span><br></pre></td></tr></table></figure><p>サンプルの中では特にシンプルな構成です。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/hello:</span></span><br><span class="line">    <span class="attr">get:</span></span><br></pre></td></tr></table></figure><p>上記部分に記載の通り、<code>{host-name}/hello</code>にGETでアクセスする場合のリクエストパラメータ、レスポンスが定義されています。<br>レスポンスのフォーマットは<code>text/plain</code>。<br>URLのクエリパラメータに<code>name</code>を持たせることができる。<br>成功した場合のHTTPレスポンスステータスは<code>200 OK</code>。<br>レスポンスのbodyに単一の文字列が返ってくる。<br>…という事が<code>swagger.yaml</code>の内容から推測できます。</p><p>作成したファイルはOpenAPI Previewで確認することが可能です。<a href="https://chrome.google.com/webstore/detail/openapi-preview/ijjbiodnicjakhbfkffnlbekpgnmmggo?hl=en-GB" target="_blank" rel="noopener">Chorome拡張</a>、<a href="https://marketplace.visualstudio.com/items?itemName=zoellner.openapi-preview" target="_blank" rel="noopener">vscode向けのプラグイン</a>などで利用可能です。<a href="https://editor.swagger.io/" target="_blank" rel="noopener">editor.swagger.io</a>のようなウェブサイトとしても公開されています。<br><a href="https://github.com/xavierchow/vim-swagger-preview" target="_blank" rel="noopener">vimプラグイン</a>もありますね…素晴らしい。</p><p><img src="/images/20200824/open_api_preview.jpg" alt=""></p><p>この<code>swagger.yaml</code>を元に実際にソースコードをビルドしてみましょう。</p><h1 id="ソースコードをビルドする"><a href="#ソースコードをビルドする" class="headerlink" title="ソースコードをビルドする"></a>ソースコードをビルドする</h1><p>ディレクトリの構成は自由ですが、私のチームでは自動生成されたコードは<code>server/gen</code>に配置される構成をとっています。<br>下記のような構成でserver/genまでディレクトリを作成します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├──swagger</span><br><span class="line">| └─swagger.yaml</span><br><span class="line">└──server</span><br><span class="line">  └─gen</span><br></pre></td></tr></table></figure><p>serverディレクトリに移動し、下記コマンドでソースコードをビルドします。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swagger generate server -a factory -A factory -t gen f ./swagger/swagger.yaml</span><br></pre></td></tr></table></figure><p>オプションの詳細については<a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選</a>のTips2をご覧ください。</p><p>今回は<code>--exclude-main</code>を使用せずに<code>main.go</code>も生成してもらいます。コマンドの実行に成功すると、<code>server/gen</code>配下に各種ファイルが生成されます。</p><h1 id="試しにサーバーを立ち上げてみる"><a href="#試しにサーバーを立ち上げてみる" class="headerlink" title="試しにサーバーを立ち上げてみる"></a>試しにサーバーを立ち上げてみる</h1><p>main.goを実行することでサーバーが起動します。</p><p><code>server</code>ディレクトリ上で下記コマンドを実行します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run gen/cmd/factory-server/main.go --host 0.0.0.0 --port 3000</span><br></pre></td></tr></table></figure><p>コマンド実行後にブラウザで<code>localhost:3000/hello</code>にアクセスしてみましょう。</p><p><img src="/images/20200824/init.jpg" alt=""></p><p>エラーが出ます、hello worldまではあと一歩ですが、まだやることがあります。</p><h1 id="ハンドラを実装する"><a href="#ハンドラを実装する" class="headerlink" title="ハンドラを実装する"></a>ハンドラを実装する</h1><p>自動生成したコードだけではAPIサーバは完成しません。</p><p>なぜならAPIが表示したいデータをどこから用意し、どのような形式でレスポンスに返すかは<code>swagger.yaml</code>への記載だけではカバーしきれないからです。例えばリクエストを元にデータベースから情報を取得、返却するAPIを構築するとします。</p><p>データベース層はRDSでしょうか、NoSQLでしょうか、クラウド上のマネージドDBでしょうか、はたまたオンプレミスでしょうか。取りうる可能性は無限大です。そのためデータベースへのアクセスやレスポンスデータの加工は自前で実装する必要があるわけですね。</p><p>今回は下記のようなファイルを用意します。</p><figure class="highlight go"><figcaption><span>server/get_greeting_handler.go</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/go-openapi/runtime/middleware"</span></span><br><span class="line"><span class="string">"github.com/example-xxxxx/myapp-name/server/gen/restapi/factory"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetGreeting</span><span class="params">(p factory.GetGreetingParams)</span> <span class="title">middleware</span>.<span class="title">Responder</span></span> &#123;</span><br><span class="line">payload := *p.Name</span><br><span class="line"><span class="keyword">return</span> factory.NewGetGreetingOK().WithPayload(payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>※importするパスはご自身のgithubリポジトリになります。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├──swagger</span><br><span class="line">| └─swagger.yaml</span><br><span class="line">└──server</span><br><span class="line">  ├─gen</span><br><span class="line">  └─get_greeting_handler.go</span><br></pre></td></tr></table></figure><p>今回は上記のようなディレクトリ構成で配置しました。</p><p><code>GetGreetingParams</code>、<code>NewGetGreetingOK()</code>などが自動生成された関数、及び構造体です。<code>GetGreetingParams</code>はリクエストパラメータであり、<code>p.Name</code>でクエリパラメータの内容が取得できます。生成されたコードのお作法に則りハンドラを実装します。今回は受け取ったクエリパラメータをそのままレスポンスとして返してみます。このファイルの変数<code>payload</code>を任意の文字列にすると実際にレスポンスが変化します。</p><p>ファイルの用意ができたら実装したハンドラ関数をアプリケーションが実行するように設定します。実は自動生成したファイルの中には、手動での変更を認めないものと、認めるものが存在します。<code>server\gen\restapi\configure_factory.go</code>が手動での変更を許可するファイルです。書き換えても良いファイルは先頭行に<code>// This file is safe to edit. Once it exists it will not be overwritten</code>とコメントされています。</p><p>さてこのファイルの下記の部分を見てみましょう。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> api.GetGreetingHandler == <span class="literal">nil</span> &#123;</span><br><span class="line">        api.GetGreetingHandler = factory.GetGreetingHandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(params factory.GetGreetingParams)</span> <span class="title">middleware</span>.<span class="title">Responder</span></span> &#123;</span><br><span class="line">            <span class="keyword">return</span> middleware.NotImplemented(<span class="string">"operation factory.GetGreeting has not yet been implemented"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>api.GetGreetingHandlerがnilのままでは<code>not yet been implemented</code>と出力する設定になっています。<br>改めて先ほどのエラーを見てみましょう、細かい表示はともかく同じような内容のメッセージが出力されています。<br><img src="/images/20200824/init_2.jpg" alt=""></p><p>この部分を書き換えるか、ここより先に評価される行で下記のようにapi.GetGreetingHandlerを定義しましょう。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api.GetGreetingHandler = factory.GetGreetingHandlerFunc(server.GetGreeting)</span><br></pre></td></tr></table></figure><p><code>configure_factory.go</code>のimport文の更新も必要です。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"crypto/tls"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/go-openapi/errors"</span></span><br><span class="line"><span class="string">"github.com/go-openapi/runtime"</span></span><br><span class="line"></span><br><span class="line">+ <span class="string">"github.com/example-xxxxx/myapp-name/server"</span></span><br><span class="line"><span class="string">"github.com/example-xxxxx/myapp-name/server/gen/restapi/factory"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ここまで書けたら今度こそサーバーを起動して動かしてみましょう。</p><h1 id="ついにhello-world完了"><a href="#ついにhello-world完了" class="headerlink" title="ついにhello world完了"></a>ついにhello world完了</h1><p>先ほど書いた内容と同じ手順でサーバーを立ち上げます。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run gen&#x2F;cmd&#x2F;factory-server&#x2F;main.go --host 0.0.0.0 --port 3000</span><br></pre></td></tr></table></figure><p>ブラウザで<code>localhost:3000/hello?name=hello-go-swagger</code>にアクセスします。<br><img src="/images/20200824/hello_go_swagger.jpg" alt=""></p><p>期待したレスポンスが返ってきました。ちなみに記事の通りの<code>get_greeting_handler.go</code>では、nameが与えられていない場合のエラーハンドリングが実装されていないため、<code>?name=hello-go-swagger</code>をURLに含めないと500番台のエラーすら返せずに処理に失敗してしまいます。</p><p>実際には400番、500番のエラーも<code>swagger.yaml</code>に定義し、どのような場合にどのエラーを返すかをハンドラに実装していく必要があります。(どの程度不正なリクエストを許容するのかといった柔軟性も、ハンドラで要件に合わせ実装していく形になります。)</p><p>今回はhello world編ということでここまでになります、是非皆さんも実際に試してみてください。</p><h1 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事</h1><ul><li><a href="https://future-architect.github.io/articles/20200630/">go-swaggerを用いたWebアプリケーション開発Tips19選</a></li><li><a href="https://future-architect.github.io/articles/20200409/">スキーマファースト開発のためのOpenAPI（Swagger）設計規約</a></li><li><a href="https://future-architect.github.io/articles/20190814/">WAFとして go-swagger を選択してみた</a></li><li><a href="https://future-architect.github.io/articles/20191008/">本当に使ってよかったOpenAPI (Swagger) ツール</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200824/top.png&quot; class=&quot;img-small-size&quot;&gt;

&lt;p&gt;The Gopher character is based on the Go mascot designed by &lt;a href=&quot;http://r
      
    
    </summary>
    
    
      <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
      <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
      <category term="go-swagger" scheme="https://future-architect.github.io/tags/go-swagger/"/>
    
  </entry>
  
  <entry>
    <title>エンジニアが最低限理解しておくべきOSSライセンスの基礎知識</title>
    <link href="https://future-architect.github.io/articles/20200821/"/>
    <id>https://future-architect.github.io/articles/20200821/</id>
    <published>2020-08-20T15:00:00.000Z</published>
    <updated>2020-08-21T05:09:09.636Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20200821/top.jpg"><p><a href="https://pixabay.com/ja/users/Catkin-127770/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1728448" target="_blank" rel="noopener">Catkin</a>による<a href="https://pixabay.com/ja/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1728448" target="_blank" rel="noopener">Pixabay</a>からの画像</p><p><a href="https://future-architect.github.io/articles/20200726/">フューチャー夏休み自由研究連載</a>15本目の記事です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>システム開発にてオープンソースのライブラリやフレームワークを利用することは、もはや当たり前となっています。<br>みなさんはOSSのライセンスについてどの程度理解していますでしょうか。<br>OSSだから無条件に利用可能だと思っていませんか？<br>本記事では、OSSのライセンスについて最低限エンジニアとして理解しておくべき内容を整理します。</p><p>なお、筆者は法学の専門家ではないことを事前にご了承ください。<br>本記事の内容は筆者個人の調査によるものであり、正確であるよう可能な限り努力しておりますが、間違いが含まれている可能性があります。あくまで参考資料としてご活用いただければ幸いです。</p><h2 id="前提として"><a href="#前提として" class="headerlink" title="前提として"></a>前提として</h2><h3 id="OSSとは"><a href="#OSSとは" class="headerlink" title="OSSとは"></a>OSSとは</h3><p>オープンソースソフトウェア（OSS）とは、利用者の目的を問わずソースコードを使用、調査、再利用、修正、拡張、再配布が可能なソフトウェアの総称となります。</p><p>オープンソースの定義については、<a href="https://opensource.org/" target="_blank" rel="noopener">Open Source Initiative（OSI）</a>と呼ばれるオープンソースを促進することを目的とした組織によって<a href="https://opensource.org/osd-annotated" target="_blank" rel="noopener">OSD（Open Source Defition）</a>という形でまとめられています。<br>現在はこのOSDが「オープンソースの定義」としてデファクトスタンダードになっています。</p><h3 id="OSSライセンスとは"><a href="#OSSライセンスとは" class="headerlink" title="OSSライセンスとは"></a>OSSライセンスとは</h3><p>OSSライセンスとは、OSSの使用許諾条件のことであり、著作権に基づいてOSSの利用条件を定義するものとなります。逆に言えばOSSとは、OSSライセンスを遵守することを条件に使用が許諾されていると言うことができます。</p><p>OSSライセンスは、先に述べたOSSの定義に基づく限り、著作権者が独自に定めることができる（と筆者は認識しています）ものですが、OSIによって承認された代表的なライセンスが下記に一覧化されています。<br><a href="https://opensource.org/licenses/alphabetical" target="_blank" rel="noopener">https://opensource.org/licenses/alphabetical</a></p><p>実際にGitHubなどを覗いてみても、OSIによって承認されたライセンスで公開されているOSSがほとんどであることが確認できるでしょう。</p><h2 id="OSSライセンスを理解する上でのポイント"><a href="#OSSライセンスを理解する上でのポイント" class="headerlink" title="OSSライセンスを理解する上でのポイント"></a>OSSライセンスを理解する上でのポイント</h2><p>OSSライセンスの種類は数多くありますが、各ライセンスを理解する上での重要なポイントとして下記の3点を取りあげます。</p><h3 id="無保証"><a href="#無保証" class="headerlink" title="無保証"></a>無保証</h3><p>主要なOSSライセンスは「著作権者は、対象ソフトウェアの動作を保証せず、発生した結果について一切の責任を負わない」とする免責条項を持っています。<br>つまり、著作者は、そのソフトウェアについて、予期した動作をする/しないの保証をせず、また、その動作の結果何らかの損害をもたらしたとしても、それを保障しないと定めています。</p><h3 id="著作権表示"><a href="#著作権表示" class="headerlink" title="著作権表示"></a>著作権表示</h3><p>もう1つ主要なライセンスに共通する特徴として、派生ソフトウェアを頒布する際は、利用元OSSの「著作権」「ライセンス文」「免責事項」などを表示しなければならない点が挙げられます。<br>具体的に「何を」「どこに」「どのように」表示するかは<strong>各ライセンスによって異なる可能性がある</strong>ので、詳細は個別のライセンスを丁寧に確認する必要があります。</p><p>例えば <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT License</a> では下記の記述によって「著作権表示」および「ライセンス文」を、「ソフトウェアのすべての複製または重要な部分に記載する」よう定められています。</p><blockquote><p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p></blockquote><p>また、著作権やライセンスをどこに記載するかに関しては派生ソフトウェアの頒布形式によって解釈が異なる模様です。<br>参考: <a href="https://opensource.stackexchange.com/questions/4058/what-is-the-point-of-including-the-mit-copyright-text-if-you-use-someones-code" target="_blank" rel="noopener">https://opensource.stackexchange.com/questions/4058/what-is-the-point-of-including-the-mit-copyright-text-if-you-use-someones-code</a></p><ul><li><p><strong>ソースコード形式で頒布する場合</strong><br>利用元のソースコード中に「著作権」及び「ライセンス文」が含まれているため、意図的にこれらを除去するなどしなければ、特に何もする必要はない、と解釈できます。<br>実際にOSSとして公開されている一般的なソースコードを見ても、これらについて特別に個別のファイルなどで明記していないものを見かけることは少なくありません。</p></li><li><p><strong>バイナリ形式で頒布する場合</strong><br>バイナリを配布する場合はコンパイル時にライセンス文が消えてしまうため、バイナリとは別にライセンス表示用のファイルなどにまとめて記載し、頒布先に提供する必要があります。</p></li></ul><p>正直筆者としては、この辺りの正確な解釈に自信がない（原文からは判断できない）のですが、要は派生ソフトウェアの利用者が派生ソフトウェア内で利用しているOSSのライセンスを知ることができないケースはNGとみて間違い無いでしょう。</p><h4 id="補足-誰に対して表示するか"><a href="#補足-誰に対して表示するか" class="headerlink" title="補足: 誰に対して表示するか"></a>補足: 誰に対して表示するか</h4><p>著作権やライセンス文を「誰に」対して表示するかですが、これは派生ソフトウェアの頒布先となります。<br>例えば、あるアプリケーションがWEB APIを提供する場合などは、アプリケーション自体はエンドユーザに頒布されておらず、あくまでネットワークを介してアプリケーションの機能を利用しているだけ、と解釈できるので、このエンドユーザに対して著作権表示を行う必要がないケースがほとんどです。<br>※ 後述するAGPLライセンスのような<strong>ネットワーク経由の利用に対しても強い制限を持つライセンスなどは例外</strong>です。</p><p>A社がB社に、toC向けのWEBアプリケーションの開発を依頼した、というケースでは、どうなるでしょうか。<br>この場合は下記のような整理になります。</p><ul><li>B社はA社に対してアプリケーション自体を頒布しているため、B社はA社に対してアプリケーション内で利用しているOSSの著作権表示を行う義務が発生します。</li><li>A社はエンドユーザに対してアプリケーションの機能のみを提供しているため、エンドユーザ向けに著作権表示を行う必要はありません。</li></ul><p>エンドユーザに対してネットワークを介した機能提供ではなく、アプリケーション自体を頒布するケース（SPAやiOS, Androidアプリなど）では、エンドユーザに対して著作権表示を行う義務があります。<br>スマホアプリ等では、アプリ内から著作権表示を確認できるものがほとんどでしょう。</p><h3 id="コピーレフトと非コピーレフト"><a href="#コピーレフトと非コピーレフト" class="headerlink" title="コピーレフトと非コピーレフト"></a>コピーレフトと非コピーレフト</h3><p>OSSライセンスを理解するにあたってコピーレフトの理解は非常に重要です。<br>コピーレフトとは「著作物の自由な利用・改変・再配布を認め、また、そこから派生した著作物についてこれらの行為を制限してはならない」という考え方です。<br>詰まるところ<strong>「あるOSSから派生ソフトウェアを作成して配布するときに元のOSSと同じ条件でソースコードを公開しなさい」</strong>ということです。<br>なお、このコピーレフトの考え方ですが、OSSを個人で利用する場合や自社内のみで利用する場合は当てはまりません。</p><p>OSSライセンスは、<strong>OSSの利用形態</strong>と<strong>ライセンスの伝搬性の範囲</strong>に応じて下記のとおり分類することができます。</p><p><img src="/images/20200821/%E5%9B%B31.png" alt=""></p><h4 id="利用形態"><a href="#利用形態" class="headerlink" title="利用形態"></a>利用形態</h4><p>まずはOSSの利用形態について説明しましょう。</p><h5 id="ソースコードの再利用"><a href="#ソースコードの再利用" class="headerlink" title="ソースコードの再利用"></a>ソースコードの再利用</h5><p>OSSのソースコードを直接改変したり、コードを追加したりする利用形態となります。</p><h5 id="ライブラリとしての利用"><a href="#ライブラリとしての利用" class="headerlink" title="ライブラリとしての利用"></a>ライブラリとしての利用</h5><p>OSSのソースコード自体には手を加えずライブラリとして利用する形態となります。<br>ライブラリのリンク方法は「静的リンク」と呼ばれる方法と「動的リンク」と呼ばれる方法があります。</p><ul><li><p><strong>静的リンク</strong><br>実行可能形式のバイナリを作成する際に、ライブラリを含む必要なコードの実態を全てリンクしてモジュールに含める方式</p></li><li><p><strong>動的リンク</strong><br>実行可能形式のバイナリにライブラリの実体を含めず、プログラムの実行開始時にローダによってリンクする方式</p></li></ul><h5 id="ネットワーク経由での利用"><a href="#ネットワーク経由での利用" class="headerlink" title="ネットワーク経由での利用"></a>ネットワーク経由での利用</h5><p>OSSを利用して、ネットワークサービスを提供する形態となります。<br>例えばWeb APIを提供する場合などがこれにあたります。</p><h4 id="ライセンスの分類"><a href="#ライセンスの分類" class="headerlink" title="ライセンスの分類"></a>ライセンスの分類</h4><p>さてOSSの利用形態が理解できたところで、次にライセンスの分類について見ていきましょう。<br>OSSライセンスは「コピーレフト型」「準コピーレフト型」「非コピーレフト型」のいずれかに分類することができます。</p><h5 id="コピーレフト型"><a href="#コピーレフト型" class="headerlink" title="コピーレフト型"></a>コピーレフト型</h5><p>元となるOSSのソースコードを再利用またはライブラリとして利用した際に、元のOSSと同じ条件で配布する必要があるものをコピーレフト型のライセンスといいます。</p><p>主要なところではGPLライセンス（<a href="https://opensource.org/licenses/GPL-2.0" target="_blank" rel="noopener">GPL-2.0</a>, <a href="https://opensource.org/licenses/GPL-3.0" target="_blank" rel="noopener">GPL-3.0</a>）がこれに該当します。<br>GPLでライセンスされたOSSを組み込む場合、それがライブラリとしての利用であったとしても、派生したソフトウェアはGPLライセンスで公開しなければならないということです。（その特性からGPL汚染と言われたりもします。）</p><p>ただし、GPLライセンスのOSSを利用して、WEB APIなどのネットワークサービスを提供する場合はこの限りではありません（ソースコードの公開などのコピーレフトは発生しません）。<br>ネットワーク経由でサービスを利用するエンドユーザは、ソースコードへアクセスする権利を持つ利用者には該当しないからです。</p><p>一方でコピーレフト型のライセンスの中で最も強い伝播性を持つ<a href="https://opensource.org/licenses/AGPL-3.0" target="_blank" rel="noopener">AGPL（Affero General Public License）</a>と呼ばれるものもあります。これはネットワークサービスを提供する場合にもコピーレフトが必要とされるライセンスとなります。</p><h5 id="準コピーレフト型"><a href="#準コピーレフト型" class="headerlink" title="準コピーレフト型"></a>準コピーレフト型</h5><p>OSSのソースコードを再利用した場合のみ、元のOSSと同じ条件で配布する必要があり、ライブラリとしての利用やネットワーク経由での利用はコピーレフトの対象とならないものを準コピーレフト型のライセンスといいます。</p><p>主要なところではLGPLライセンス（<a href="https://opensource.org/licenses/LGPL-2.1" target="_blank" rel="noopener">LGPL-2.1</a>, <a href="https://opensource.org/licenses/LGPL-3.0" target="_blank" rel="noopener">LGPL-3.0</a>）がこれに該当します。<br>LGPLライセンスはライブラリを静的リンクするか、動的リンクするかに応じて、異なる要求がある点が注意です。<br>※いずれにしても派生ソフトウェアをLGPLライセンスで公開する必要はありません。</p><p>下記を参考にすると次のように解釈できます。<br><a href="https://www.gnu.org/licenses/gpl-faq.html#LGPLStaticVsDynamic" target="_blank" rel="noopener">https://www.gnu.org/licenses/gpl-faq.html#LGPLStaticVsDynamic</a></p><ul><li><p><strong>静的リンクする場合</strong><br>リバースエンジニアリングを禁止せず、アプリケーションのオブジェクトコードまたはソースコードの提供が必要となります。</p></li><li><p><strong>動的リンクする場合</strong><br>特に制約はありません。</p></li><li><p><strong>静的、動的にかかわらずアプリケーションと一緒にライブラリを配布する場合</strong><br>ライブラリのソースを配布またはリンクなどを公開する必要があります。</p></li></ul><p>ところで、この静的リンクと動的リンクは具体的にどのように判断すれば良いのでしょうか。<br>CやC++のような明確なリンク作業を必要とするコンパイル言語を対象とする場合はあまり判断に困らない気がしますが、Javaのようなリンクという明確な作業を必要としない言語や、はたまたPythonのようなインタプリタ言語におけるライブラリの利用はどうなるのでしょうか。</p><p>Javaについては公式のQ&amp;Aにて説明があるとおり、ライブラリの利用は「静的リンク」と解釈される模様です。<br><a href="https://www.gnu.org/licenses/lgpl-java.ja.html" target="_blank" rel="noopener">https://www.gnu.org/licenses/lgpl-java.ja.html</a></p><p>他の言語について正確なところは筆者も判断できません（し明文化もされていないと思われます）が、<br>import文などを利用してソース内にてライブラリを参照する記述を行っている場合は、静的リンクと解釈しておいた方が良さそうです。</p><h5 id="非コピーレフト型"><a href="#非コピーレフト型" class="headerlink" title="非コピーレフト型"></a>非コピーレフト型</h5><p>OSSを利用をした際に、元のOSSと同じ条件で配布する必要がないものです。<br>MIT License や Apache License 2.0, BSDライセンス（<a href="https://opensource.org/licenses/BSD-2-Clause" target="_blank" rel="noopener">BSD 2-clause License</a>, <a href="https://opensource.org/licenses/BSD-3-Clause" target="_blank" rel="noopener">BSD 3-clause License</a>）などがこれに該当します。</p><h2 id="主要なライセンス"><a href="#主要なライセンス" class="headerlink" title="主要なライセンス"></a>主要なライセンス</h2><p>上記を踏まえつつ、我々が普段目にすることの多い主要なライセンスについて一覧化してみます。</p><p>とある調査によると、近年は非コピーレフト型のライセンスが多く好まれる傾向があり、<br>その中でも MIT License や Apache License 2.0 が上位にきていることがわかります。<br><a href="https://resources.whitesourcesoftware.com/blog-whitesource/top-open-source-licenses-trends-and-predictions" target="_blank" rel="noopener">https://resources.whitesourcesoftware.com/blog-whitesource/top-open-source-licenses-trends-and-predictions</a></p><table><thead><tr><th align="left">ライセンス名</th><th align="center">商用利用</th><th align="center">著作者による保証</th><th align="center">著作権・ライセンス表示</th><th align="center">類型</th></tr></thead><tbody><tr><td align="left"><a href="https://choosealicense.com/licenses/mit/" target="_blank" rel="noopener">MIT License</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="">Apache License 2.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/bsd-3-clause/" target="_blank" rel="noopener">BSD 3-Clause License</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/bsd-2-clause/" target="_blank" rel="noopener">BSD 2-Clause License</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">非コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/lgpl-2.1/" target="_blank" rel="noopener">LGPL 2.1</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">準コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/lgpl-3.0/" target="_blank" rel="noopener">LGPL 3.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">準コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/gpl-2.0/" target="_blank" rel="noopener">GPL-2.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/gpl-3.0/" target="_blank" rel="noopener">GPL-3.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">コピーレフト</td></tr><tr><td align="left"><a href="https://choosealicense.com/licenses/agpl-3.0/" target="_blank" rel="noopener">AGPL-3.0</a></td><td align="center">可</td><td align="center">無</td><td align="center">要</td><td align="center">コピーレフト</td></tr></tbody></table><p>上記の表では一見同じに見えても細かい条件が異なりますので、必ず利用の際には詳細な確認をしてください。<br>GitHubが公開しているライセンスのガイドラインは、各ライセンスで何が認められていて何が制限されているかが非常にわかりやすく整理されているのでお勧めです。<br><a href="https://choosealicense.com/appendix/" target="_blank" rel="noopener">https://choosealicense.com/appendix/</a><br>表のリンク先もこのGitHub社のページへリンクするようにしています。</p><h2 id="ライセンス違反とならないために"><a href="#ライセンス違反とならないために" class="headerlink" title="ライセンス違反とならないために"></a>ライセンス違反とならないために</h2><p>ここまでOSSライセンスの基礎についてご説明しましたが、いかがでしょうか。<br>最後にライセンス違反とならないための心得を記載して本記事を終わりにしたいと思います。</p><h4 id="OSSライセンスをきちんと自分の目で読み理解する"><a href="#OSSライセンスをきちんと自分の目で読み理解する" class="headerlink" title="OSSライセンスをきちんと自分の目で読み理解する"></a>OSSライセンスをきちんと自分の目で読み理解する</h4><p>OSSライセンスの基礎を理解することはもちろんですが、実際に自分の目できちんとライセンス文自体を読んでみることが重要です。ブログを読んで、この記事に書かれていたから大丈夫と鵜呑みにするのは大変危険です。<br>原文を読むのはハードルが高いという方は、<a href="https://opensource.jp/osg/aboutus.html" target="_blank" rel="noopener">オープンソースグループ・ジャパン</a>などが公開している日本語訳と照らしながら読んでみるといいかもしれません。<br><a href="https://osdn.net/projects/opensource/wiki/licenses" target="_blank" rel="noopener">https://osdn.net/projects/opensource/wiki/licenses</a></p><p>またGNUライセンスについては、Q&amp;Aが公開されていたりするので、こういったものも参考になるでしょう。<br><a href="https://www.gnu.org/licenses/gpl-faq.html.en" target="_blank" rel="noopener">https://www.gnu.org/licenses/gpl-faq.html.en</a><br>（日本語訳は<a href="https://www.gnu.org/licenses/gpl-faq.ja.html" target="_blank" rel="noopener">こちら</a>）</p><h4 id="法務部門や弁護士など専門家のレビューを受ける"><a href="#法務部門や弁護士など専門家のレビューを受ける" class="headerlink" title="法務部門や弁護士など専門家のレビューを受ける"></a>法務部門や弁護士など専門家のレビューを受ける</h4><p>エンジニア個人のレベルで、ライセンスに違反していないかどうかを完全に判断することはまず不可能です。<br>必ず専門家に依頼して確認を実施するようにしましょう。</p><h4 id="補足-ツールを利用してOSSのライセンスを一覧化する"><a href="#補足-ツールを利用してOSSのライセンスを一覧化する" class="headerlink" title="補足: ツールを利用してOSSのライセンスを一覧化する"></a>補足: ツールを利用してOSSのライセンスを一覧化する</h4><p>GitHub謹製の licensed を利用することで、インストールしたOSSライブラリのライセンスを一覧化することができます。本ツールをCIに組み込むことで、ライブラリが追加される度にライセンスを一覧化し、チェックするという運用が実現できそうですね。<br><a href="https://github.com/github/licensed" target="_blank" rel="noopener">https://github.com/github/licensed</a></p><p>デフォルトでは下記のライブラリ管理ツールがサポートされています。</p><ul><li>Bower</li><li>Bundler</li><li>Cabal</li><li>Composer</li><li>Git Submodules (git_submodule)</li><li>Go</li><li>Go Dep (dep)</li><li>Gradle</li><li>Manifest lists (manifests)</li><li>Mix</li><li>NPM</li><li>NuGet</li><li>Pip</li><li>Pipenv</li><li>Yarn</li></ul><p>本ツールのREADMEに免責事項として記載されているとおり、これは完全なライセンスのチェックを保証ツールではないので、あくまで人間のレビューの補助ツールとして利用することをお勧めします。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><p>オープンソースライセンスの基礎と実務<br><a href="https://www.slideshare.net/YutakaKachi/ss-118947772" target="_blank" rel="noopener">https://www.slideshare.net/YutakaKachi/ss-118947772</a></p></li><li><p>OSSのライセンスを理解する（「使用」と「利用」の違い、知っていますか？）<br><a href="https://qiita.com/bremen/items/c5aa9446e73aa4bc1de0" target="_blank" rel="noopener">https://qiita.com/bremen/items/c5aa9446e73aa4bc1de0</a></p></li><li><p>OSSライブラリのライセンスをチェックしてくれるGitHub製ツール「licensed」<br><a href="https://matsnow.hatenablog.com/entry/library/licensed" target="_blank" rel="noopener">https://matsnow.hatenablog.com/entry/library/licensed</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/images/20200821/top.jpg&quot;&gt;

&lt;p&gt;&lt;a href=&quot;https://pixabay.com/ja/users/Catkin-127770/?utm_source=link-attribution&amp;amp;utm_medium=ref
      
    
    </summary>
    
    
      <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
      <category term="OSS" scheme="https://future-architect.github.io/tags/OSS/"/>
    
      <category term="夏休み自由研究" scheme="https://future-architect.github.io/tags/%E5%A4%8F%E4%BC%91%E3%81%BF%E8%87%AA%E7%94%B1%E7%A0%94%E7%A9%B6/"/>
    
      <category term="license" scheme="https://future-architect.github.io/tags/license/"/>
    
  </entry>
  
</feed>
